System.register([],function(P2){"use strict";return{execute:function(){function de(e){return(de="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function y(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function l(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}function s(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function p(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&i(e,t)}function g(e){return(g=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function i(e,t){return(i=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function u(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function x(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?u(e):t}function o(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=g(e)););return e}function _(e,t,i){return(_="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,i){var n=o(e,t);if(n){var r=Object.getOwnPropertyDescriptor(n,t);return r.get?r.get.call(i):r.value}})(e,t,i||e)}function a(e,t,i,n){return(a="undefined"!=typeof Reflect&&Reflect.set?Reflect.set:function(e,t,i,n){var r,a=o(e,t);if(a){if((r=Object.getOwnPropertyDescriptor(a,t)).set)return r.set.call(n,i),!0;if(!r.writable)return!1}if(r=Object.getOwnPropertyDescriptor(n,t)){if(!r.writable)return!1;r.value=i,Object.defineProperty(n,t,r)}else s(n,t,i);return!0})(e,t,i,n)}function r(e,t,i,n,r){if(!a(e,t,i,n||e)&&r)throw new Error("failed to set property");return i}function c(e){return function(e){if(Array.isArray(e)){for(var t=0,i=new Array(e.length);t<e.length;t++)i[t]=e[t];return i}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function v(e,t,i,n){i&&Object.defineProperty(e,t,{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(n):void 0})}function m(i,n,e,t,r){var a={};return Object.keys(t).forEach(function(e){a[e]=t[e]}),a.enumerable=!!a.enumerable,a.configurable=!!a.configurable,("value"in a||a.initializer)&&(a.writable=!0),a=e.slice().reverse().reduce(function(e,t){return t(i,n,e)||e},a),r&&void 0!==a.initializer&&(a.value=a.initializer?a.initializer.call(r):void 0,a.initializer=void 0),void 0===a.initializer&&(Object.defineProperty(i,n,a),a=null),a}P2({BitMask:_t,Enum:vt,EventType:void 0,GFXAddress:void 0,GFXAttributeName:void 0,GFXBindingType:void 0,GFXBlendFactor:void 0,GFXBlendOp:void 0,GFXBufferAccessBit:void 0,GFXBufferFlagBit:void 0,GFXBufferUsageBit:void 0,GFXClearFlag:void 0,GFXColorMask:void 0,GFXCommandBufferType:void 0,GFXComparisonFunc:void 0,GFXCullMode:void 0,GFXDynamicState:void 0,GFXFilter:void 0,GFXFormat:void 0,GFXFormatSize:Kc,GFXFormatSurfaceSize:Zc,GFXFormatType:void 0,GFXGetTypeSize:$c,GFXLoadOp:void 0,GFXMemoryUsageBit:void 0,GFXObjectType:void 0,GFXPipelineBindPoint:void 0,GFXPolygonMode:void 0,GFXPrimitiveMode:void 0,GFXQueueType:void 0,GFXSampleCount:void 0,GFXShadeModel:void 0,GFXShaderType:void 0,GFXStatus:void 0,GFXStencilFace:void 0,GFXStencilOp:void 0,GFXStoreOp:void 0,GFXTextureFlagBit:void 0,GFXTextureLayout:void 0,GFXTextureType:void 0,GFXTextureUsageBit:void 0,GFXTextureViewType:void 0,GFXType:void 0,HorizontalTextAlignment:void 0,InstanceMaterialType:void 0,Overflow:void 0,RenderPassStage:void 0,SystemEventType:void 0,VerticalTextAlignment:void 0,WorldNode3DToLocalNodeUI:Bo,WorldNode3DToWorldNodeUI:Po,approx:di,assert:k,assertID:V,bezier:Tk,bezierByTime:Mk,clamp:pi,clamp01:_i,color:ar,computeRatioByType:qk,equals:fi,error:A,errorID:D,find:Mh,fragmentText:Ks,getPathFromRoot:vO,getWorldTransformUntilRoot:mO,inverseLerp:ki,isCustomTargetModifier:iR,isDisplayStats:H,isElementModifier:tR,isPropertyModifier:eR,isUnicodeCJK:Xs,isUnicodeSpace:Ys,lerp:vi,log:E,logID:L,markAsWarning:void 0,mat4:Dn,nextPow2:Ei,pingPong:Ai,pseudoRandom:Si,pseudoRandomRange:wi,pseudoRandomRangeInt:Ti,quat:mn,randomRange:bi,randomRangeInt:xi,rect:Jn,removeProperty:void 0,repeat:Ci,replaceProperty:void 0,safeMeasureText:Qs,sampleAnimationCurve:Hk,setDefaultLogTimes:function(e){0<e&&(hr=e)},setDisplayStats:q,size:Wn,toDegree:yi,toRadian:mi,tween:$1,tweenUtil:Z1,v2:zi,v3:Vi,v4:Xi,warn:C,warnID:B});var h="undefined"==typeof window?global:window,e=h.cc=h.cc||{};function t(e,t){void 0===h[e]&&(h[e]=t)}e.internal=e.internal||{},e._global=h,t("CC_BUILD",!1),h.CC_BUILD=!0,h.CC_TEST=!1,h.CC_EDITOR=!1,h.CC_PREVIEW=!1,h.CC_DEV=!1,h.CC_DEBUG=!1,h.CC_JSB=!1,h.CC_WECHATGAME=!0,h.CC_QQPLAY=!1,h.CC_RUNTIME=!1,h.CC_SUPPORT_JIT=!1,h.CC_PHYSICS_BUILTIN=!1,h.CC_PHYSICS_CANNON=!0,h.CC_PHYSICS_AMMO=!1;h.CocosEngine=e.ENGINE_VERSION="1.0.0 beta",Object.defineProperty(h,"CC_PHYSICS_BUILT_IN",{get:function(){return console.warn("CC_PHYSICS_BUILT_IN is deprecated, please using CC_PHYSICS_BUILTIN instead."),h.CC_PHYSICS_BUILTIN}});var f=null,d=console.log,b=console.log,S=console.log,w=function(e,t){if(!e){for(var i=arguments.length,n=new Array(2<i?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];console.log("ASSERT: "+T.apply(void 0,[t].concat(n)))}};function T(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return cc.js.formatStr.apply(null,[e].concat(i))}function E(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return d.apply(void 0,[e].concat(i))}function C(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return b.apply(void 0,[e].concat(i))}function A(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return S.apply(void 0,[e].concat(i))}function k(e,t){for(var i=arguments.length,n=new Array(2<i?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];return w.apply(void 0,[e,t].concat(n))}function R(e){if(d=b=S=w=function(){},e!==F.NONE){if(e>F.ERROR){var a=function(e){if(cc.game.canvas){if(!f){var t=document.createElement("Div");t.setAttribute("id","logInfoDiv"),t.setAttribute("width","200"),t.setAttribute("height",cc.game.canvas.height);var i=t.style;i.zIndex="99999",i.position="absolute",i.top=i.left="0",(f=document.createElement("textarea")).setAttribute("rows","20"),f.setAttribute("cols","30"),f.setAttribute("disabled","true");var n=f.style;n.backgroundColor="transparent",n.borderBottom="1px solid #cccccc",n.borderTopWidth=n.borderLeftWidth=n.borderRightWidth="0px",n.borderTopStyle=n.borderLeftStyle=n.borderRightStyle="none",n.padding="0px",n.margin="0px",t.appendChild(f),cc.game.canvas.parentNode.appendChild(t)}f.value=f.value+e+"\r\n",f.scrollTop=f.scrollHeight}};S=function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];a("ERROR :  "+T.apply(void 0,[e].concat(i)))},w=function(e,t){if(!e){for(var i=arguments.length,n=new Array(2<i?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];a("ASSERT: "+T.apply(void 0,[t].concat(n)))}},e!==F.ERROR_FOR_WEB_PAGE&&(b=function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];a("WARN :  "+T.apply(void 0,[e].concat(i)))}),e===F.INFO_FOR_WEB_PAGE&&(d=function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];a(T.apply(void 0,[e].concat(i)))})}else console&&console.log.apply&&(console.error||(console.error=console.log),console.warn||(console.warn=console.log),S=console.error.bind?console.error.bind(console):function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return console.error.apply(console,[e].concat(i))},w=function(e,t){if(!e){for(var i=arguments.length,n=new Array(2<i?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];var a=T.apply(void 0,[t].concat(n));throw new Error(a)}});e!==F.ERROR&&(b=console.warn.bind?console.warn.bind(console):function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return console.warn.apply(console,[e].concat(i))}),e===F.INFO&&(d=console.log.bind?console.log.bind(console):function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return console.log.apply(console,[e].concat(i))})}}function O(e){var t=e.stack;A(t||e)}function M(a){return function(e){for(var t="".concat(a," ").concat(e,", please go to ").concat("https://github.com/cocos-creator/engine/blob/master/EngineErrorMap.md","#").concat(e," to see details."),i=arguments.length,n=new Array(1<i?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];return 0===n.length?t:t+" Arguments: "+n.join(", ")}}var I=M("Log");function L(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];E(I.apply(void 0,[e].concat(i)))}var z=M("Warning");function B(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];C(z.apply(void 0,[e].concat(i)))}var P=M("Error");function D(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];A(P.apply(void 0,[e].concat(i)))}var F,N,U=M("Assert");function V(e,t){if(!e){for(var i=arguments.length,n=new Array(2<i?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];k(!1,U.apply(void 0,[t].concat(n)))}}function G(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return P.apply(void 0,[e].concat(i))}function H(){return!!cc.profiler&&cc.profiler.isShowingStats()}function q(e){cc.profiler&&(e?cc.profiler.showStats():cc.profiler.hideStats(),cc.game.config.showFPS=!!e)}(N=F=F||{})[N.NONE=0]="NONE",N[N.INFO=1]="INFO",N[N.WARN=2]="WARN",N[N.ERROR=3]="ERROR",N[N.INFO_FOR_WEB_PAGE=4]="INFO_FOR_WEB_PAGE",N[N.WARN_FOR_WEB_PAGE=5]="WARN_FOR_WEB_PAGE",N[N.ERROR_FOR_WEB_PAGE=6]="ERROR_FOR_WEB_PAGE";var j=Object.freeze({log:E,warn:C,error:A,assert:k,_resetDebugSetting:R,_throw:O,logID:L,warnID:B,errorID:D,assertID:V,get DebugMode(){return F},getError:G,isDisplayStats:H,setDisplayStats:q}),W=/(\.[^\.\/\?\\]*)(\?.*)?$/,X=/((.*)(\/|\\|\\\\))?(.*?\..*$)?/,Y=/[^\.\/]+\/\.\.\//;function Q(){for(var e="",t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];for(var r=0,a=i;r<a.length;r++){e=(e+(""===e?"":"/")+a[r]).replace(/(\/|\\\\)$/,"")}return e}function K(e){var t=W.exec(e);return t?t[1]:""}function Z(e){if(e){var t=e.lastIndexOf(".");if(-1!==t)return e.substring(0,t)}return e}function J(e,t){var i=e.indexOf("?");0<i&&(e=e.substring(0,i));var n=/(\/|\\)([^\/\\]+)$/g.exec(e.replace(/(\/|\\)$/,""));if(!n)return"";var r=n[2];return t&&e.substring(e.length-t.length).toLowerCase()===t.toLowerCase()?r.substring(0,r.length-t.length):r}function $(e){var t=X.exec(e);return t?t[2]:""}function ee(e,t){t=t||"";var i=e.indexOf("?"),n="";return 0<i&&(n=e.substring(i),e=e.substring(0,i)),(i=e.lastIndexOf("."))<0?e+t+n:e.substring(0,i)+t+n}function te(e,t,i){if(0===t.indexOf("."))return ee(e,t);var n=e.indexOf("?"),r="",a=i?K(e):"";return 0<n&&(r=e.substring(n),e=e.substring(0,n)),n=(n=e.lastIndexOf("/"))<=0?0:n+1,e.substring(0,n)+t+a+r}function ie(e){for(var t=e=String(e);e=(t=e).replace(Y,""),t.length!==e.length;);return e}function ne(e){return e.replace(/[\/\\]$/,"")}function re(){return cc.sys.os===cc.sys.OS_WINDOWS?"\\":"/"}P2("path",Object.freeze({join:Q,extname:K,mainFileName:Z,basename:J,dirname:$,changeExtname:ee,changeBasename:te,_normalize:ie,stripSep:ne,getSeperator:re})),cc.log=E,cc.warn=C,cc.error=A,cc.assert=k,cc._throw=O,cc.logID=L,cc.warnID=B,cc.errorID=D,cc.assertID=V,cc.debug=j,cc.path={join:Q,extname:K,mainFileName:Z,basename:J,dirname:$,changeExtname:ee,changeBasename:te,_normalize:ie,stripSep:ne,get sep(){return re()}};var ae=2147483647;function se(e){return(0<e)-(e<0)}function oe(e){var t=32;return(e&=-e)&&t--,65535&e&&(t-=16),16711935&e&&(t-=8),252645135&e&&(t-=4),858993459&e&&(t-=2),1431655765&e&&(t-=1),t}var le=new Array(256);!function(e){for(var t=0;t<256;++t){var i=t,n=t,r=7;for(i>>>=1;i;i>>>=1)n<<=1,n|=1&i,--r;e[t]=n<<r&255}}(le);var ce=Object.freeze({INT_BITS:32,INT_MAX:ae,INT_MIN:-1<<31,sign:se,abs:function(e){var t=e>>31;return(e^t)-t},min:function(e,t){return t^(e^t)&-(e<t)},max:function(e,t){return e^(e^t)&-(e<t)},isPow2:function(e){return!(e&e-1||!e)},log2:function(e){var t,i;return t=(65535<e)<<4,t|=i=(255<(e>>>=t))<<3,t|=i=(15<(e>>>=i))<<2,(t|=i=(3<(e>>>=i))<<1)|(e>>>=i)>>1},log10:function(e){return 1e9<=e?9:1e8<=e?8:1e7<=e?7:1e6<=e?6:1e5<=e?5:1e4<=e?4:1e3<=e?3:100<=e?2:10<=e?1:0},popCount:function(e){return 16843009*((e=(858993459&(e-=e>>>1&1431655765))+(e>>>2&858993459))+(e>>>4)&252645135)>>>24},countTrailingZeros:oe,nextPow2:function(e){return e+=0===e,--e,e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,(e|=e>>>16)+1},prevPow2:function(e){return e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,(e|=e>>>16)-(e>>>1)},parity:function(e){return e^=e>>>16,e^=e>>>8,e^=e>>>4,27030>>>(e&=15)&1},reverse:function(e){return le[255&e]<<24|le[e>>>8&255]<<16|le[e>>>16&255]<<8|le[e>>>24&255]},interleave2:function(e,t){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e&=65535)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t&=65535)|t<<8))|t<<4))|t<<2))|t<<1))<<1},deinterleave2:function(e,t){return(e=65535&((e=16711935&((e=252645135&((e=858993459&((e=e>>>t&1431655765)|e>>>1))|e>>>2))|e>>>4))|e>>>16))<<16>>16},interleave3:function(e,t,i){return e=1227133513&((e=3272356035&((e=251719695&((e=4278190335&((e&=1023)|e<<16))|e<<8))|e<<4))|e<<2),(e|=(t=1227133513&((t=3272356035&((t=251719695&((t=4278190335&((t&=1023)|t<<16))|t<<8))|t<<4))|t<<2))<<1)|(i=1227133513&((i=3272356035&((i=251719695&((i=4278190335&((i&=1023)|i<<16))|i<<8))|i<<4))|i<<2))<<2},deinterleave3:function(e,t){return(e=1023&((e=4278190335&((e=251719695&((e=3272356035&((e=e>>>t&1227133513)|e>>>2))|e>>>4))|e>>>8))|e>>>16))<<22>>22},nextCombination:function(e){var t=e|e-1;return 1+t|(~t&-~t)-1>>>oe(e)+1}});P2("bits",ce);var ue=function(){function t(e){y(this,t),this.array=e,this.i=0}return l(t,[{key:"remove",value:function(e){var t=this.array.indexOf(e);0<=t&&this.removeAt(t)}},{key:"removeAt",value:function(e){this.array.splice(e,1),e<=this.i&&--this.i}},{key:"fastRemove",value:function(e){var t=this.array.indexOf(e);0<=t&&this.fastRemoveAt(t)}},{key:"fastRemoveAt",value:function(e){var t=this.array;t[e]=t[t.length-1],--t.length,e<=this.i&&--this.i}},{key:"push",value:function(e){this.array.push(e)}},{key:"length",get:function(){return this.array.length},set:function(e){this.array.length=e,this.i>=e&&(this.i=e-1)}}]),t}();function he(e,t){e.splice(t,1)}function fe(e,t){var i=e.indexOf(t);return 0<=i&&(he(e,i),!0)}function pe(e,t){return 0<=e.indexOf(t)}var _e=Object.freeze({removeAt:he,fastRemoveAt:function(e,t){var i=e.length;t<0||i<=t||(e[t]=e[i-1],e.length=i-1)},remove:fe,fastRemove:function(e,t){var i=e.indexOf(t);0<=i&&(e[i]=e[e.length-1],--e.length)},removeIf:function(e,t){var i=e.findIndex(t);if(0<=i){var n=e[i];return he(e,i),n}},verifyType:function(e,t){if(e&&0<e.length){var i=e,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}if(!(a instanceof t))return cc.logID(1300),!1}}return!0},removeArray:function(e,t){for(var i=0,n=t.length;i<n;i++)fe(e,t[i])},appendObjectsAt:function(e,t,i){return e.splice.apply(e,[i,0].concat(c(t))),e},indexOf:function(e,t,i){return Array.prototype.indexOf.call(e,[t,i])},contains:pe,copy:function(e){for(var t=e.length,i=new Array(t),n=0;n<t;n+=1)i[n]=e[n];return i},MutableForwardIterator:ue}),ve=function(){function t(e){y(this,t),this.id=void 0,this.prefix=void 0,this.id=0|998*Math.random(),this.prefix=e?e+".":""}return l(t,[{key:"getNewId",value:function(){return this.prefix+ ++this.id}}]),t}();ve.global=new ve("global");var me=new ve("TmpCId.");function ye(e){return"number"==typeof e||e instanceof Number}function ge(e){return"string"==typeof e||e instanceof String}var be,xe,Se,we,Te=(be={value:void 0,enumerable:!1,writable:!1,configurable:!0},function(e,t,i,n,r){be.value=i,be.writable=n,be.enumerable=r,Object.defineProperty(e,t,be),be.value=void 0}),Ee=(xe={get:void 0,set:void 0,enumerable:!1},function(e,t,i,n){var r=4<arguments.length&&void 0!==arguments[4]&&arguments[4],a=5<arguments.length&&void 0!==arguments[5]&&arguments[5];"boolean"==typeof n&&(r=n,n=void 0),xe.get=i,xe.set=n,xe.enumerable=r,xe.configurable=a,Object.defineProperty(e,t,xe),xe.get=void 0,xe.set=void 0}),Ce=(Se={get:void 0,enumerable:!1,configurable:!1},function(e,t,i,n,r){Se.get=i,Se.enumerable=n,Se.configurable=r,Object.defineProperty(e,t,Se),Se.get=void 0}),Ae=(we={set:void 0,enumerable:!1,configurable:!1},function(e,t,i,n,r){we.set=i,we.enumerable=n,we.configurable=r,Object.defineProperty(e,t,we),we.set=void 0});function ke(e){var t=Object.create(null);if(e){t["."]=!0,t["/"]=!0,delete t["."],delete t["/"]}return t}function Re(e){if("function"!=typeof e)return e&&e.constructor?Re(e.constructor):"";var t=e.prototype;if(t&&t.hasOwnProperty("__classname__")&&t.__classname__)return t.__classname__;var i="";if(e.name&&(i=e.name),e.toString){var n,r=e.toString();(n="["===r.charAt(0)?r.match(/\[\w+\s*(\w+)\]/):r.match(/function\s*(\w+)/))&&2===n.length&&(i=n[1])}return"Object"!==i?i:""}function Oe(e,t,i,n){var r=/([^.]+)$/,a=r.exec(t)[0],s=r.exec(i)[0];function o(){return this[s]}n?Ee(e,a,o,function(e){this[s]=e}):Ce(e,a,o)}function Me(e,t,i,n){for(var r in i){Oe(e,t+"."+r,i[r],n)}}var Ie=/(%d)|(%s)/,Le=/%s/;function ze(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];if(0===arguments.length)return"";if(0===i.length)return""+e;if("string"==typeof e&&Ie.test(e))for(var r=0,a=i;r<a.length;r++){var s=a[r],o="number"==typeof s?Ie:Le;o.test(e)?e=e.replace(o,s):e+=" "+s}else for(var l=0,c=i;l<c.length;l++){e+=" "+c[l]}return e}function Be(){for(var e=arguments.length-1,t=new Array(e),i=0;i<e;++i)t[i]=arguments[i+1];return t}function Pe(e,t){for(;e;){var i=Object.getOwnPropertyDescriptor(e,t);if(i)return i;e=Object.getPrototypeOf(e)}return null}function De(e,t,i){var n=Pe(t,e);n&&Object.defineProperty(i,e,n)}function Fe(e){e=e||{};for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];for(var r=0,a=i;r<a.length;r++){var s=a[r];if(s){if("object"!==de(s)){cc.errorID(5402,s);continue}for(var o in s)o in e||De(o,s,e)}}return e}function Ne(e){e=e||{};for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];for(var r=0,a=i;r<a.length;r++){var s=a[r];if(s){if("object"!==de(s)){cc.errorID(5403,s);continue}for(var o in s)De(o,s,e)}}return e}function Ue(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);return e.prototype=Object.create(t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),e}function Ve(e){var t=e.prototype,i=t&&Object.getPrototypeOf(t);return i&&i.constructor}function Ge(e,t){if(e&&t){if("function"!=typeof e)return!1;if("function"!=typeof t)return!1;if(e===t)return!0;for(;;){if(!(e=Ve(e)))return!1;if(e===t)return!0}}return!1}function He(e){for(var t=0,i=Object.keys(e);t<i.length;t++){delete e[i[t]]}}var qe={},je={};function We(e,t){var i="__cid__",n=qe;if(t.prototype.hasOwnProperty(i)&&delete n[t.prototype[i]],Te(t.prototype,i,e),e){var r=n[e];if(r&&r!==t){var a='A Class already exists with the same __cid__ : "'+e+'".';0,cc.error(a)}else n[e]=t}}function Xe(e,t){if(function(e,t){var i="__classname__",n=je;if(t.prototype.hasOwnProperty(i)&&delete n[t.prototype[i]],Te(t.prototype,i,e),e){var r=n[e];if(r&&r!==t){var a="A Class already exists with the same "+i+' : "'+e+'".';0,cc.error(a)}else n[e]=t}}(e,t),!t.prototype.hasOwnProperty("__cid__")){var i=e||me.getNewId();i&&We(i,t)}}function Ye(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];for(var n=0,r=t;n<r.length;n++){var a=r[n].prototype,s=a.__cid__;s&&delete qe[s];var o=a.__classname__;o&&delete je[o]}}function Qe(e){return qe[e]}function Ke(e){return je[e]}function Ze(e,t){if(t=void 0===t||t,"function"==typeof e&&e.prototype.hasOwnProperty("__cid__"))return e.prototype.__cid__;if(e&&e.constructor){var i=e.constructor.prototype;if(i&&i.hasOwnProperty("__cid__"))return e.__cid__}return""}var Je=function(){function r(e,t){y(this,r),this.count=void 0,this._pool=void 0;var i=(this._cleanup=void 0)===t?e:t,n=void 0===t?null:e;this.count=0,this._pool=new Array(i),this._cleanup=n}return l(r,[{key:"get",value:function(){return this._get()}}]),l(r,[{key:"_get",value:function(){if(0<this.count){--this.count;var e=this._pool[this.count];return this._pool[this.count]=null,e}return null}},{key:"put",value:function(e){var t=this._pool;if(this.count<t.length){if(this._cleanup&&!1===this._cleanup(e))return;t[this.count]=e,++this.count}}},{key:"resize",value:function(e){0<=e&&(this._pool.length=e,this.count>e&&(this.count=e))}}]),r}(),$e=_e,et={IDGenerator:ve,Pool:Je,array:_e,isNumber:ye,isString:ge,getPropertyDescriptor:Pe,addon:Fe,mixin:Ne,extend:Ue,getSuper:Ve,isChildClassOf:Ge,clear:He,value:Te,getset:Ee,get:Ce,set:Ae,unregisterClass:Ye,getClassName:Re,setClassName:Xe,getClassByName:Ke,_getClassId:Ze,_setClassId:We,_getClassById:Qe,obsolete:Oe,obsoletes:Me,formatStr:ze,shiftArguments:Be,createMap:ke};cc.js=et,P2("js",Object.freeze({array:$e,js:et,IDGenerator:ve,Pool:Je,isNumber:ye,isString:ge,value:Te,getset:Ee,get:Ce,set:Ae,createMap:ke,getClassName:Re,obsolete:Oe,obsoletes:Me,formatStr:ze,shiftArguments:Be,getPropertyDescriptor:Pe,addon:Fe,mixin:Ne,extend:Ue,getSuper:Ve,isChildClassOf:Ge,clear:He,_idToClass:qe,_nameToClass:je,_setClassId:We,setClassName:Xe,unregisterClass:Ye,_getClassById:Qe,getClassByName:Ke,_getClassId:Ze}));for(var tt=/^(?:cc|dragonBones|sp|ccsg)\..+/,it=new Array(123),nt=0;nt<123;++nt)it[nt]=64;for(var rt=0;rt<64;++rt)it["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charCodeAt(rt)]=rt;var at=it;function st(e,t,i){function n(e,t,i,n){var r=Object.getOwnPropertyDescriptor(e,t);if(r)r.get&&(e[i]=r.get),r.set&&n&&(e[n]=r.set);else{var a=e[i];Ee(e,t,a,e[n])}}for(var r,a=e.prototype,s=0;s<t.length;s++){var o=(r=t[s])[0].toUpperCase()+r.slice(1);n(a,r,"get"+o,"set"+o)}for(r in i){var l=i[r];n(a,r,l[0],l[1])}}function ot(e){return e-=1,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,(e|=e>>16)+1}function lt(e,t,i,n){var r=e[t];r?Array.isArray(r)?n?(r.push(r[0]),r[0]=i):r.push(i):e[t]=n?[i,r]:[r,i]:e[t]=i}function ct(e,t){if("function"==typeof e.contains)return e.contains(t);if("function"==typeof e.compareDocumentPosition)return!!(16&e.compareDocumentPosition(t));var i=t.parentNode;if(i)do{if(i===e)return!0;i=i.parentNode}while(null!==i);return!1}function ut(e){return"object"===("undefined"==typeof window?"undefined":de(window))&&"function"==typeof Node?e instanceof Node:e&&"object"===de(e)&&"number"==typeof e.nodeType&&"string"==typeof e.nodeName}function ht(e,t,i){e&&setTimeout(function(){e(t,i)},0)}function ft(e,t,i,n){return Function("arg","return "+function(e){try{target._FUNC_(_U_ARGS_)}catch(e){cc._throw(e)}}.toString().replace(/_FUNC_/g,e).replace("_R_ARGS_","target"+(t?", "+t:"")).replace("_U_ARGS_",t||"").replace("_AFTER_CALL_",i||""))(n)}function dt(e){if(!e||e.constructor!==Object)return!1;for(var t in e)return!1;return!0}function pt(e){return e&&"function"==typeof e.clone&&(e.constructor&&e.constructor.prototype.hasOwnProperty("clone")||e.hasOwnProperty("clone"))}function _t(e){if("__bitmask__"in e)return e;Te(e,"__bitmask__",null,!0);for(var t=-1,i=Object.keys(e),n=0;n<i.length;n++){var r=i[n],a=e[r];if(-1===a)a=++t,e[r]=a;else if("number"==typeof a)t=a;else if("string"==typeof a&&Number.isInteger(parseFloat(r)))continue;var s=""+a;r!==s&&Te(e,s,r)}return e}function vt(e){if("__enums__"in e)return e;Te(e,"__enums__",null,!0);for(var t=-1,i=Object.keys(e),n=0;n<i.length;n++){var r=i[n],a=e[r];if(-1===a)a=++t,e[r]=a;else if("number"==typeof a)t=a;else if("string"==typeof a&&Number.isInteger(parseFloat(r)))continue;var s=""+a;r!==s&&Te(e,s,r)}return e}function mt(e){"__enums__"in e||Te(e,"__enums__",null,!0)}cc.misc={BUILTIN_CLASSID_RE:tt,BASE64_VALUES:at,propertyDefine:st,nextPOT:ot,pushToMap:lt,contains:ct,isDomNode:ut,callInNextTick:ht,tryCatchFunctor_EDITOR:ft,isPlainEmptyObj_DEV:dt,cloneable_DEV:pt},P2("misc",Object.freeze({BUILTIN_CLASSID_RE:tt,BASE64_VALUES:at,propertyDefine:st,nextPOT:ot,pushToMap:lt,contains:ct,isDomNode:ut,callInNextTick:ht,tryCatchFunctor_EDITOR:ft,isPlainEmptyObj_DEV:dt,cloneable_DEV:pt})),_t.isBitMask=function(e){return e&&e.hasOwnProperty("__bitmask__")},_t.getList=function(e){if(e.__bitmask__)return e.__bitmask__;var t=e.__bitmask__=[];for(var i in e){var n=e[i];Number.isInteger(n)&&t.push({name:i,value:n})}return t.sort(function(e,t){return e.value-t.value}),t},cc.BitMask=_t,vt.isEnum=function(e){return e&&e.hasOwnProperty("__enums__")},vt.getList=function(e){if(e.__enums__)return e.__enums__;var t=e.__enums__=[];for(var i in e){var n=e[i];Number.isInteger(n)&&t.push({name:i,value:n})}return t.sort(function(e,t){return e.value-t.value}),t},cc.Enum=vt;var yt=P2("ValueType",function(){function e(){y(this,e)}return l(e,[{key:"clone",value:function(){return D(100,Re(this)+".clone"),this}},{key:"equals",value:function(e){return!1}},{key:"set",value:function(e){D(100,Re(this)+".set")}},{key:"toString",value:function(){return""+{}}}]),e}());Xe("cc.ValueType",yt),cc.ValueType=yt;var gt="$_$";function bt(e,t,i){var n;n=function(){},i&&Ue(n,i.constructor);var r=new n;return Te(e,"__attrs__",r),r}function xt(e){for(var t,i=cc.Class.getInheritanceChain(e),n=i.length-1;0<=n;n--){var r=i[n];r.hasOwnProperty("__attrs__")&&r.__attrs__||bt(r,0,(t=i[n+1])&&t.__attrs__)}return bt(e,0,(t=i[0])&&t.__attrs__),e.__attrs__}function St(e,t,i){var n,r;if("function"==typeof e)r=(n=wt(e)).constructor.prototype;else{var a=e;if(!(n=a.__attrs__))n=bt(a,0,wt(e=a.constructor));r=n}if(void 0===i){var s=t+gt,o={};for(var l in n)l.startsWith(s)&&(o[l.slice(s.length)]=n[l]);return o}if("object"===de(i))for(var c in i)95!==c.charCodeAt(0)&&(r[t+gt+c]=i[c]);else 0}function wt(e){return e.hasOwnProperty("__attrs__")&&e.__attrs__||xt(e)}function Tt(e){return wt(e).constructor.prototype}function Et(e,t,i,n){Tt(e)[t+gt+i]=n}var Ct=function(){function i(e,t){y(this,i),this.name=void 0,this.default=void 0,this.name=e,this.default=t}return l(i,[{key:"toString",value:function(){return this.name}}]),i}(),At=P2("CCInteger",new Ct("Integer",0));cc.Integer=At,cc.CCInteger=At;var kt=P2("CCFloat",new Ct("Float",0));cc.Float=kt,cc.CCFloat=kt;var Rt=P2("CCBoolean",new Ct("Boolean",!1));cc.Boolean=Rt,cc.CCBoolean=Rt;var Ot=P2("CCString",new Ct("String",""));function Mt(l,c){return function(e,t){var i='"'+Re(e)+"."+t+'"',n=St(e,t);if(!n.saveUrlAsAsset){var r=n.type;if(r===At||r===kt?r="Number":r!==Ot&&r!==Rt||(r=r.toString()),r!==l)return void B(3604,i)}if(n.hasOwnProperty("default")){var a=n.default;if(void 0!==a)if(!(Array.isArray(a)||dt(a))){var s=de(a),o=l.toLowerCase();if(s===o){if(!n.saveUrlAsAsset)if("object"===o){if(!a||a instanceof n.ctor)return;B(3605,i,Re(n.ctor))}else"Number"!==l&&B(3606,c,i,l)}else{if("function"===s)return;l===Ot.default&&null==a?Ge(n.ctor,cc.RawAsset)||B(3607,i):B(3611,c,i,s)}delete n.type}}}}function It(s){return function(e,t){Mt("Object","type")(e,t);var i=wt(e)[t+gt+"default"],n=cc.Class.getDefault(i);if(!Array.isArray(n)&&Ge(s,cc.ValueType)){var r=Re(s),a=ze('No need to specify the "type" of "%s.%s" because %s is a child class of ValueType.',Re(e),t,r);i?E(a):B(3612,a,r,Re(e),t,r)}}}cc.String=Ot,cc.CCString=Ot;var Lt=Object.freeze({DELIMETER:gt,createAttrsSingle:bt,createAttrs:xt,attr:St,getClassAttrs:wt,getClassAttrsProto:Tt,setClassAttr:Et,PrimitiveType:Ct,CCInteger:At,CCFloat:kt,CCBoolean:Rt,CCString:Ot,getTypeChecker:Mt,getObjTypeChecker:It}),zt={url:{canUsedInGet:!0},default:{},serializable:{},editorOnly:{},formerlySerializedAs:{}};function Bt(e,t,i,n){if(!e.get&&!e.set)if(e.hasOwnProperty("default")){var r="_N$"+t;e.get=function(){return this[r]},e.set=function(e){var t=this[r];this[r]=e,i.call(this,t)};var a={};for(var s in n[r]=a,zt){var o=zt[s];e.hasOwnProperty(s)&&(a[s]=e[s],o.canUsedInGet||delete e[s])}}else 0}function Pt(e,t,i,n){if(Array.isArray(t)){if(!(0<t.length))return D(5508,i,n);if(cc.RawAsset.isRawAssetType(t[0]))return e.url=t[0],void delete e.type;e.type=t=t[0]}}function Dt(e){if(e&&e.constructor===Object)return null;if(Array.isArray(e)&&0<e.length){e[0];return{default:[],type:e,_short:!0}}if("function"!=typeof e)return e instanceof Ct?{default:e.default,_short:!0}:{default:e,_short:!0};var t=e;return cc.RawAsset.isRawAssetType(t)?{default:"",url:t,_short:!0}:{default:Ge(t,cc.ValueType)?new t:null,type:t,_short:!0}}var Ft=[];function Nt(){return Ft[Ft.length-1]}cc._RF={push:function(e,t,i){void 0===i&&(i=t,t=""),Ft.push({uuid:t,script:i,module:e,exports:e.exports,beh:null})},pop:function(){var e=Ft.pop(),t=e.module,i=t.exports;if(i===e.exports){for(var n in i)return;t.exports=i=e.cls}},peek:Nt};var Ut=gt,Vt=["name","extends","mixins","ctor","__ctor__","properties","statics","editor","__ES6__"];function Gt(e,t){e.indexOf(t)<0&&e.push(t)}var Ht={datas:null,push:function(e){if(this.datas)this.datas.push(e);else{this.datas=[e];var t=this;setTimeout(function(){t.init()},0)}},init:function(){var e=this.datas;if(e){for(var t=0;t<e.length;++t){var i=e[t],n=i.cls,r=i.props;"function"==typeof r&&(r=r());var a=Re(n);r?ri(n,a,r,n.$super,i.mixins):D(3633,a)}this.datas=null}}};function qt(e,t){Gt(e.__props__,t)}var jt=[];function Wt(e,t,i,n){var r=n.default;Et(e,i,"default",r),qt(e,i);var a=li(e,n,t,i,!1);if(a){for(var s=jt,o=0;o<a.length;o++){var l=a[o];St(e,i,l),!1===l.serializable&&Gt(e.__values__,i),l._onAfterProp&&s.push(l._onAfterProp)}for(var c=0;c<s.length;c++)s[c](e,i);jt.length=0,a.length=0}}function Xt(e,t,i,n,r){var a=n.get,s=n.set,o=e.prototype,l=Object.getOwnPropertyDescriptor(o,i),c=!l;if(a){0;for(var u=li(e,n,t,i,!0),h=0;h<u.length;h++)St(e,i,u[h]);u.length=0,Et(e,i,"serializable",!1),r||Ce(o,i,a,c,c)}s&&(r||Ae(o,i,s,c,c))}function Yt(e){return"function"==typeof e?e():e}function Qt(e,t,i){for(var n in t)e.hasOwnProperty(n)||i&&!i(n)||Object.defineProperty(e,n,Pe(t,n))}function Kt(e,t,i,n){var r,a,s=n.__ctor__,o=n.ctor,l=n.__ES6__;l?(r=[o],a=o):(r=s?[s]:function(e,t,i){for(var n=[],r=[e].concat(t),a=0;a<r.length;a++){var s=r[a];if(s)for(var o=ai._isCCClass(c=s)?c.__ctors__||[]:[c],l=0;l<o.length;l++)Gt(n,o[l])}var c;var u=i.ctor;u&&n.push(u);return n}(t,i,n),a=ei(r,t,e,n),Te(a,"extend",function(e){return e.extends=this,ai(e)},!0)),Te(a,"__ctors__",0<r.length?r:null,!0);var c=a.prototype;if(t&&(l||(Ue(a,t),c=a.prototype),a.$super=t),i){for(var u=function(e){var t=i[e];Qt(c,t.prototype),Qt(a,t,function(e){return t.hasOwnProperty(e)&&!0}),ai._isCCClass(t)&&Qt(wt(a).constructor.prototype,wt(t).constructor.prototype)},h=i.length-1;0<=h;h--)u(h);c.constructor=a}return l||(c.__initProps__=$t),Xe(e,a),a}function Zt(e){return JSON.stringify(e).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")}var Jt=/^[A-Za-z_$][0-9A-Za-z_$]*$/;function $t(e){var t=wt(e),i=e.__props__;null===i&&(Ht.init(),i=e.__props__);var n=function(e,t){for(var a=[],s=[],o=[],l=[],i=0;i<t.length;++i){var n=t[i],r=n+Ut+"default";if(r in e){var c=e[r];"object"===de(c)&&c||"function"==typeof c?(a.push(n),s.push(c)):(o.push(n),l.push(c))}}return function(){for(var e=0;e<o.length;++e)this[o[e]]=l[e];for(var t=0;t<a.length;t++){var i=a[t],n=void 0,r=s[t];n="object"===de(r)?r instanceof cc.ValueType?r.clone():Array.isArray(r)?[]:{}:r(),this[i]=n}}}(t,i);(e.prototype.__initProps__=n).call(this)}var ei=function(t,e,i,n){var r,a=e&&ni(e,n,i),s=t.length;return r=0<s?a?2===s?function(){this._super=null,this.__initProps__(r),t[0].apply(this,arguments),t[1].apply(this,arguments)}:function(){this._super=null,this.__initProps__(r);for(var e=0;e<t.length;++e)t[e].apply(this,arguments)}:3===s?function(){this.__initProps__(r),t[0].apply(this,arguments),t[1].apply(this,arguments),t[2].apply(this,arguments)}:function(){this.__initProps__(r);for(var e=r.__ctors__,t=0;t<e.length;++t)e[t].apply(this,arguments)}:function(){a&&(this._super=null),this.__initProps__(r)}};var ti=/xyz/.test(function(){}.toString()),ii=ti?/\b\._super\b/:/.*/;function ni(e,t){var i=!1;for(var n in t)if(!(0<=Vt.indexOf(n))){var r=t[n];if("function"==typeof r){var a=Pe(e.prototype,n);if(a){var s=a.value;if("function"==typeof s){ii.test(r)&&(i=!0,t[n]=function(i,n){return function(){var e=this._super;this._super=i;var t=n.apply(this,arguments);return this._super=e,t}}(s,r));continue}}0}}return i}function ri(t,e,i,n,r,a){if(t.__props__=[],n&&n.__props__&&(t.__props__=n.__props__.slice()),r)for(var s=0;s<r.length;++s){var o=r[s];o.__props__&&(t.__props__=t.__props__.concat(o.__props__.filter(function(e){return t.__props__.indexOf(e)<0})))}if(i)for(var l in function(e,t){for(var i in e){var n=e[i],r=Dt(n);if(r&&(n=e[i]=r),n){var a=n.notify;a&&Bt(n,i,a,e),"type"in n&&Pt(n,n.type,t,i),"url"in n&&(o=(s=n).url,Array.isArray(o)&&0<o.length&&(o=o[0]),s.type=o),"type"in n&&n.type}}var s,o}(i,e),i){var c=i[l];"default"in c?Wt(t,e,l,c):Xt(t,e,l,c,a)}var u=wt(t);t.__values__=t.__props__.filter(function(e){return!1!==u[e+Ut+"serializable"]})}function ai(e){var t=(e=e||{}).name,i=e.extends,n=e.mixins,r=function(e,t,i,n){var r=cc.Component,a=Nt();if(a&&Ge(t,r)){if(Ge(a.cls,r))return D(3615),null;0,e=e||a.script}var s=Kt(e,t,i,n);if(a)if(Ge(t,r)){var o=a.uuid;o&&We(o,s),a.cls=s}else Ge(a.cls,r)||(a.cls=s);return s}(t,i,n,e);t=t||cc.js.getClassName(r),r._sealed=!0,i&&(i._sealed=!1);var a=e.properties;"function"==typeof a||i&&null===i.__props__||n&&n.some(function(e){return null===e.__props__})?(Ht.push({cls:r,props:a,mixins:n}),r.__props__=r.__values__=null):ri(r,t,a,i,e.mixins,e.__ES6__);var s,o,l=e.statics;if(l)for(s in l)r[s]=l[s];for(var c in e)if(!(0<=Vt.indexOf(c))){var u=e[c];"function"!=typeof(o=u)&&null!==o||Te(r.prototype,c,u,!0,!0)}var h=e.editor;return h&&Ge(i,cc.Component)&&cc.Component._registerEditorProps(r,h),r}ai._isCCClass=function(e){return e&&e.hasOwnProperty&&e.hasOwnProperty("__ctors__")},ai.fastDefine=function(e,t,i){Xe(e,t);for(var n=t.__props__=t.__values__=Object.keys(i),r=Tt(t),a=0;a<n.length;a++){var s=n[a];r[s+Ut+"visible"]=!1,r[s+Ut+"default"]=i[s]}},ai.Attr=Lt,ai.attr=St,ai.getInheritanceChain=function(e){for(var t=[];e=Ve(e);)e!==Object&&t.push(e);return t};var si={Integer:"Number",Float:"Number",Boolean:"Boolean",String:"String"},oi=[];function li(e,n,t,i){var r=null,a="";function s(){return a=i+Ut,r=Tt(e)}oi.length=0;var o=oi,l=n.type;if(l){var c=si[l];if(c)o.push({type:l,_onAfterProp:void 0});else if("Object"===l)0;else if("object"===de(l))vt.isEnum(l)?o.push({type:"Enum",enumList:vt.getList(l)}):_t.isBitMask(l)&&o.push({type:"BitMask",bitmaskList:_t.getList(l)});else if("function"==typeof l){var u;0,o.push({type:"Object",ctor:l,_onAfterProp:u})}else 0}function h(e,t){if(e in n){var i=n[e];de(i)===t&&((r||s())[a+e]=i)}}n.editorOnly&&((r||s())[a+"editorOnly"]=!0),n.url&&((r||s())[a+"saveUrlAsAsset"]=!0),!1===n.serializable&&((r||s())[a+"serializable"]=!1),h("formerlySerializedAs","string");var f=n.range;return f&&Array.isArray(f)&&2<=f.length&&((r||s())[a+"min"]=f[0],(r||s())[a+"max"]=f[1],2<f.length&&((r||s())[a+"step"]=f[2])),h("min","number"),h("max","number"),h("step","number"),o}ai.isArray=function(e){return e=Yt(e),Array.isArray(e)},ai.getDefault=Yt,ai.escapeForJS=Zt,ai.IDENTIFIER_RE=Jt,ai.getNewValueTypeCode=!1,P2("CCClass",ai),cc.Class=ai;var ci=Math.PI/180,ui=180/Math.PI,hi=P2("EPSILON",1e-6);function fi(e,t){return Math.abs(e-t)<=hi*Math.max(1,Math.abs(e),Math.abs(t))}function di(e,t,i){return i=i||hi,Math.abs(e-t)<=i}function pi(e,t,i){if(i<t){var n=t;t=i,i=n}return e<t?t:i<e?i:e}function _i(e){return e<0?0:1<e?1:e}function vi(e,t,i){return e+(t-e)*i}function mi(e){return e*ci}function yi(e){return e*ui}var gi=P2("random",Math.random);function bi(e,t){return Math.random()*(t-e)+e}function xi(e,t){return Math.floor(bi(e,t))}function Si(e){return(e=(9301*e+49297)%233280)/233280}function wi(e,t,i){return Si(e)*(i-t)+t}function Ti(e,t,i){return Math.floor(wi(e,t,i))}function Ei(e){return--e,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e}function Ci(e,t){return e-Math.floor(e/t)*t}function Ai(e,t){return e=Ci(e,2*t),e=t-Math.abs(e-t)}function ki(e,t,i){return(i-e)/(t-e)}var Ri=0,Oi=0,Mi=P2("Vec2",function(){function n(e,t){var i;return y(this,n),(i=x(this,g(n).call(this))).x=void 0,i.y=void 0,e&&"object"===de(e)?(i.x=e.x,i.y=e.y):(i.x=e||0,i.y=t||0),i}return p(n,yt),l(n,null,[{key:"clone",value:function(e){return new n(e.x,e.y)}},{key:"copy",value:function(e,t){return e.x=t.x,e.y=t.y,e}},{key:"set",value:function(e,t,i){return e.x=t,e.y=i,e}},{key:"add",value:function(e,t,i){return e.x=t.x+i.x,e.y=t.y+i.y,e}},{key:"subtract",value:function(e,t,i){return e.x=t.x-i.x,e.y=t.y-i.y,e}},{key:"multiply",value:function(e,t,i){return e.x=t.x*i.x,e.y=t.y*i.y,e}},{key:"divide",value:function(e,t,i){return e.x=t.x/i.x,e.y=t.y/i.y,e}},{key:"ceil",value:function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e}},{key:"floor",value:function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e}},{key:"min",value:function(e,t,i){return e.x=Math.min(t.x,i.x),e.y=Math.min(t.y,i.y),e}},{key:"max",value:function(e,t,i){return e.x=Math.max(t.x,i.x),e.y=Math.max(t.y,i.y),e}},{key:"round",value:function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e}},{key:"multiplyScalar",value:function(e,t,i){return e.x=t.x*i,e.y=t.y*i,e}},{key:"scaleAndAdd",value:function(e,t,i,n){return e.x=t.x+i.x*n,e.y=t.y+i.y*n,e}},{key:"distance",value:function(e,t){return Ri=t.x-e.x,Oi=t.y-e.y,Math.sqrt(Ri*Ri+Oi*Oi)}},{key:"squaredDistance",value:function(e,t){return Ri=t.x-e.x,Oi=t.y-e.y,Ri*Ri+Oi*Oi}},{key:"len",value:function(e){return Ri=e.x,Oi=e.y,Math.sqrt(Ri*Ri+Oi*Oi)}},{key:"lengthSqr",value:function(e){return Ri=e.x,Oi=e.y,Ri*Ri+Oi*Oi}},{key:"negate",value:function(e,t){return e.x=-t.x,e.y=-t.y,e}},{key:"inverse",value:function(e,t){return e.x=1/t.x,e.y=1/t.y,e}},{key:"inverseSafe",value:function(e,t){return Ri=t.x,Oi=t.y,Math.abs(Ri)<hi?e.x=0:e.x=1/Ri,Math.abs(Oi)<hi?e.y=0:e.y=1/Oi,e}},{key:"normalize",value:function(e,t){Ri=t.x,Oi=t.y;var i=Ri*Ri+Oi*Oi;return 0<i&&(i=1/Math.sqrt(i),e.x=Ri*i,e.y=Oi*i),e}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y}},{key:"cross",value:function(e,t,i){return e.x=e.y=0,e.z=t.x*i.y-t.y*i.x,e}},{key:"lerp",value:function(e,t,i,n){return Ri=t.x,Oi=t.y,e.x=Ri+n*(i.x-Ri),e.y=Oi+n*(i.y-Oi),e}},{key:"random",value:function(e,t){t=t||1;var i=2*gi()*Math.PI;return e.x=Math.cos(i)*t,e.y=Math.sin(i)*t,e}},{key:"transformMat3",value:function(e,t,i){return Ri=t.x,Oi=t.y,e.x=i.m00*Ri+i.m03*Oi+i.m06,e.y=i.m01*Ri+i.m04*Oi+i.m07,e}},{key:"transformMat4",value:function(e,t,i){return Ri=t.x,Oi=t.y,e.x=i.m00*Ri+i.m04*Oi+i.m12,e.y=i.m01*Ri+i.m05*Oi+i.m13,e}},{key:"str",value:function(e){return"Vec2(".concat(e.x,", ").concat(e.y,")")}},{key:"toArray",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:0;return e[n+0]=t.x,e[n+1]=t.y,e}},{key:"fromArray",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:0;return e.x=t[n+0],e.y=t[n+1],e}},{key:"strictEquals",value:function(e,t){return e.x===t.x&&e.y===t.y}},{key:"equals",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:hi;return Math.abs(e.x-t.x)<=n*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=n*Math.max(1,Math.abs(e.y),Math.abs(t.y))}},{key:"angle",value:function(e,t){n.normalize(Ii,e),n.normalize(Li,t);var i=n.dot(Ii,Li);return 1<i?0:i<-1?Math.PI:Math.acos(i)}}]),l(n,[{key:"clone",value:function(){return new n(this.x,this.y)}},{key:"set",value:function(e,t){return e&&"object"===de(e)?(this.x=e.x,this.y=e.y):(this.x=e||0,this.y=t||0),this}},{key:"equals",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:hi;return Math.abs(this.x-e.x)<=i*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=i*Math.max(1,Math.abs(this.y),Math.abs(e.y))}},{key:"equals2f",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:hi;return Math.abs(this.x-e)<=n*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=n*Math.max(1,Math.abs(this.y),Math.abs(t))}},{key:"strictEquals",value:function(e){return e&&this.x===e.x&&this.y===e.y}},{key:"strictEquals2f",value:function(e,t){return this.x===e&&this.y===t}},{key:"toString",value:function(){return"(".concat(this.x.toFixed(2),", ").concat(this.y.toFixed(2),")")}},{key:"lerp",value:function(e,t){return Ri=this.x,Oi=this.y,this.x=Ri+t*(e.x-Ri),this.y=Oi+t*(e.y-Oi),this}},{key:"clampf",value:function(e,t){return this.x=pi(this.x,e.x,t.x),this.y=pi(this.y,e.y,t.y),this}},{key:"add",value:function(e){return this.x=this.x+e.x,this.y=this.y+e.y,this}},{key:"add2f",value:function(e,t){return this.x=this.x+e,this.y=this.y+t,this}},{key:"subtract",value:function(e){return this.x=this.x-e.x,this.y=this.y-e.y,this}},{key:"subtract2f",value:function(e,t){return this.x=this.x-e,this.y=this.y-t,this}},{key:"multiplyScalar",value:function(e){return"object"===de(e)&&console.warn("should use Vec2.multiply for vector * vector operation"),this.x=this.x*e,this.y=this.y*e,this}},{key:"multiply",value:function(e){return"object"!==de(e)&&console.warn("should use Vec2.scale for vector * scalar operation"),this.x=this.x*e.x,this.y=this.y*e.y,this}},{key:"multiply2f",value:function(e,t){return this.x=this.x*e,this.y=this.y*t,this}},{key:"divide",value:function(e){return this.x=this.x/e.x,this.y=this.y/e.y,this}},{key:"divide2f",value:function(e,t){return this.x=this.x/e,this.y=this.y/t,this}},{key:"negative",value:function(){return this.x=-this.x,this.y=-this.y,this}},{key:"dot",value:function(e){return this.x*e.x+this.y*e.y}},{key:"cross",value:function(e){return this.x*e.y-this.y*e.x}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y)}},{key:"lengthSqr",value:function(){return this.x*this.x+this.y*this.y}},{key:"normalize",value:function(){Ri=this.x,Oi=this.y;var e=Ri*Ri+Oi*Oi;return 0<e&&(e=1/Math.sqrt(e),this.x=this.x*e,this.y=this.y*e),this}},{key:"angle",value:function(e){var t=this.lengthSqr(),i=e.lengthSqr();if(0===t||0===i)return console.warn("Can't get angle between zero vector"),0;var n=this.dot(e)/Math.sqrt(t*i);return n=pi(n,-1,1),Math.acos(n)}},{key:"signAngle",value:function(e){var t=this.angle(e);return this.cross(e)<0?-t:t}},{key:"rotate",value:function(e){Ri=this.x,Oi=this.y;var t=Math.sin(e),i=Math.cos(e);return this.x=i*Ri-t*Oi,this.y=t*Ri+i*Oi,this}},{key:"project",value:function(e){var t=this.dot(e)/e.dot(e);return this.x=e.x*t,this.y=e.y*t,this}},{key:"transformMat4",value:function(e){return Ri=this.x,Oi=this.y,this.x=e.m00*Ri+e.m04*Oi+e.m12,this.y=e.m01*Ri+e.m05*Oi+e.m13,this}}]),n}());Mi.ZERO=Object.freeze(new Mi(0,0)),Mi.ONE=Object.freeze(new Mi(1,1)),Mi.NEG_ONE=Object.freeze(new Mi(-1,-1)),Mi.UNIT_X=Object.freeze(new Mi(1,0)),Mi.UNIT_Y=Object.freeze(new Mi(0,1));var Ii=new Mi,Li=new Mi;function zi(e,t){return new Mi(e,t)}ai.fastDefine("cc.Vec2",Mi,{x:0,y:0}),cc.Vec2=Mi,cc.v2=zi;var Bi=0,Pi=0,Di=0,Fi=P2("Vec3",function(){function r(e,t,i){var n;return y(this,r),(n=x(this,g(r).call(this))).x=void 0,n.y=void 0,n.z=void 0,e&&"object"===de(e)?(n.x=e.x,n.y=e.y,n.z=e.z):(n.x=e||0,n.y=t||0,n.z=i||0),n}return p(r,yt),l(r,null,[{key:"zero",value:function(e){return e.x=0,e.y=0,e.z=0,e}},{key:"clone",value:function(e){return new r(e.x,e.y,e.z)}},{key:"copy",value:function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e}},{key:"set",value:function(e,t,i,n){return e.x=t,e.y=i,e.z=n,e}},{key:"add",value:function(e,t,i){return e.x=t.x+i.x,e.y=t.y+i.y,e.z=t.z+i.z,e}},{key:"subtract",value:function(e,t,i){return e.x=t.x-i.x,e.y=t.y-i.y,e.z=t.z-i.z,e}},{key:"multiply",value:function(e,t,i){return e.x=t.x*i.x,e.y=t.y*i.y,e.z=t.z*i.z,e}},{key:"divide",value:function(e,t,i){return e.x=t.x/i.x,e.y=t.y/i.y,e.z=t.z/i.z,e}},{key:"ceil",value:function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e}},{key:"floor",value:function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e}},{key:"min",value:function(e,t,i){return e.x=Math.min(t.x,i.x),e.y=Math.min(t.y,i.y),e.z=Math.min(t.z,i.z),e}},{key:"max",value:function(e,t,i){return e.x=Math.max(t.x,i.x),e.y=Math.max(t.y,i.y),e.z=Math.max(t.z,i.z),e}},{key:"round",value:function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e}},{key:"multiplyScalar",value:function(e,t,i){return e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e}},{key:"scaleAndAdd",value:function(e,t,i,n){return e.x=t.x+i.x*n,e.y=t.y+i.y*n,e.z=t.z+i.z*n,e}},{key:"distance",value:function(e,t){return Bi=t.x-e.x,Pi=t.y-e.y,Di=t.z-e.z,Math.sqrt(Bi*Bi+Pi*Pi+Di*Di)}},{key:"squaredDistance",value:function(e,t){return Bi=t.x-e.x,Pi=t.y-e.y,Di=t.z-e.z,Bi*Bi+Pi*Pi+Di*Di}},{key:"len",value:function(e){return Bi=e.x,Pi=e.y,Di=e.z,Math.sqrt(Bi*Bi+Pi*Pi+Di*Di)}},{key:"lengthSqr",value:function(e){return Bi=e.x,Pi=e.y,Di=e.z,Bi*Bi+Pi*Pi+Di*Di}},{key:"negate",value:function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e}},{key:"invert",value:function(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e}},{key:"invertSafe",value:function(e,t){return Bi=t.x,Pi=t.y,Di=t.z,Math.abs(Bi)<hi?e.x=0:e.x=1/Bi,Math.abs(Pi)<hi?e.y=0:e.y=1/Pi,Math.abs(Di)<hi?e.z=0:e.z=1/Di,e}},{key:"normalize",value:function(e,t){Bi=t.x,Pi=t.y,Di=t.z;var i=Bi*Bi+Pi*Pi+Di*Di;return 0<i&&(i=1/Math.sqrt(i),e.x=Bi*i,e.y=Pi*i,e.z=Di*i),e}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z}},{key:"cross",value:function(e,t,i){var n=t.x,r=t.y,a=t.z,s=i.x,o=i.y,l=i.z;return e.x=r*l-a*o,e.y=a*s-n*l,e.z=n*o-r*s,e}},{key:"lerp",value:function(e,t,i,n){return e.x=t.x+n*(i.x-t.x),e.y=t.y+n*(i.y-t.y),e.z=t.z+n*(i.z-t.z),e}},{key:"random",value:function(e,t){t=t||1;var i=2*gi()*Math.PI,n=2*gi()-1,r=Math.sqrt(1-n*n);return e.x=r*Math.cos(i)*t,e.y=r*Math.sin(i)*t,e.z=n*t,e}},{key:"transformMat4",value:function(e,t,i){Bi=t.x,Pi=t.y,Di=t.z;var n=i.m03*Bi+i.m07*Pi+i.m11*Di+i.m15;return n=n?1/n:1,e.x=(i.m00*Bi+i.m04*Pi+i.m08*Di+i.m12)*n,e.y=(i.m01*Bi+i.m05*Pi+i.m09*Di+i.m13)*n,e.z=(i.m02*Bi+i.m06*Pi+i.m10*Di+i.m14)*n,e}},{key:"transformMat4Normal",value:function(e,t,i){Bi=t.x,Pi=t.y,Di=t.z;var n=i.m03*Bi+i.m07*Pi+i.m11*Di;return n=n?1/n:1,e.x=(i.m00*Bi+i.m04*Pi+i.m08*Di)*n,e.y=(i.m01*Bi+i.m05*Pi+i.m09*Di)*n,e.z=(i.m02*Bi+i.m06*Pi+i.m10*Di)*n,e}},{key:"transformMat3",value:function(e,t,i){return Bi=t.x,Pi=t.y,Di=t.z,e.x=Bi*i.m00+Pi*i.m03+Di*i.m06,e.y=Bi*i.m01+Pi*i.m04+Di*i.m07,e.z=Bi*i.m02+Pi*i.m05+Di*i.m08,e}},{key:"transformAffine",value:function(e,t,i){return Bi=t.x,Pi=t.y,Di=t.z,e.x=i.m00*Bi+i.m01*Pi+i.m02*Di+i.m03,e.y=i.m04*Bi+i.m05*Pi+i.m06*Di+i.m07,e.x=i.m08*Bi+i.m09*Pi+i.m10*Di+i.m11,e}},{key:"transformQuat",value:function(e,t,i){var n=i.w*t.x+i.y*t.z-i.z*t.y,r=i.w*t.y+i.z*t.x-i.x*t.z,a=i.w*t.z+i.x*t.y-i.y*t.x,s=-i.x*t.x-i.y*t.y-i.z*t.z;return e.x=n*i.w+s*-i.x+r*-i.z-a*-i.y,e.y=r*i.w+s*-i.y+a*-i.x-n*-i.z,e.z=a*i.w+s*-i.z+n*-i.y-r*-i.x,e}},{key:"transformRTS",value:function(e,t,i,n,r){var a=t.x*r.x,s=t.y*r.y,o=t.z*r.z,l=i.w*a+i.y*o-i.z*s,c=i.w*s+i.z*a-i.x*o,u=i.w*o+i.x*s-i.y*a,h=-i.x*a-i.y*s-i.z*o;return e.x=l*i.w+h*-i.x+c*-i.z-u*-i.y+n.x,e.y=c*i.w+h*-i.y+u*-i.x-l*-i.z+n.y,e.z=u*i.w+h*-i.z+l*-i.y-c*-i.x+n.z,e}},{key:"transformInverseRTS",value:function(e,t,i,n,r){var a=t.x-n.x,s=t.y-n.y,o=t.z-n.z,l=i.w*a-i.y*o+i.z*s,c=i.w*s-i.z*a+i.x*o,u=i.w*o-i.x*s+i.y*a,h=i.x*a+i.y*s+i.z*o;return e.x=(l*i.w+h*i.x+c*i.z-u*i.y)/r.x,e.y=(c*i.w+h*i.y+u*i.x-l*i.z)/r.y,e.z=(u*i.w+h*i.z+l*i.y-c*i.x)/r.z,e}},{key:"rotateX",value:function(e,t,i,n){Bi=t.x-i.x,Pi=t.y-i.y,Di=t.z-i.z;var r=Math.cos(n),a=Math.sin(n),s=Bi,o=Pi*r-Di*a,l=Pi*a+Di*r;return e.x=s+i.x,e.y=o+i.y,e.z=l+i.z,e}},{key:"rotateY",value:function(e,t,i,n){Bi=t.x-i.x,Pi=t.y-i.y,Di=t.z-i.z;var r=Math.cos(n),a=Math.sin(n),s=Di*a+Bi*r,o=Pi,l=Di*r-Bi*a;return e.x=s+i.x,e.y=o+i.y,e.z=l+i.z,e}},{key:"rotateZ",value:function(e,t,i,n){Bi=t.x-i.x,Pi=t.y-i.y,Di=t.z-i.z;var r=Math.cos(n),a=Math.sin(n),s=Bi*r-Pi*a,o=Bi*a+Pi*r,l=Di;return e.x=s+i.x,e.y=o+i.y,e.z=l+i.z,e}},{key:"toArray",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:0;return e[n+0]=t.x,e[n+1]=t.y,e[n+2]=t.z,e}},{key:"fromArray",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:0;return e.x=t[n+0],e.y=t[n+1],e.z=t[n+2],e}},{key:"strictEquals",value:function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z}},{key:"equals",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:hi,r=e.x,a=e.y,s=e.z,o=t.x,l=t.y,c=t.z;return Math.abs(r-o)<=n*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(a-l)<=n*Math.max(1,Math.abs(a),Math.abs(l))&&Math.abs(s-c)<=n*Math.max(1,Math.abs(s),Math.abs(c))}},{key:"angle",value:function(e,t){r.normalize(Ni,e),r.normalize(Ui,t);var i=r.dot(Ni,Ui);return 1<i?0:i<-1?Math.PI:Math.acos(i)}},{key:"projectOnPlane",value:function(e,t,i){return r.subtract(e,t,r.project(e,t,i))}},{key:"project",value:function(e,t,i){var n=r.lengthSqr(i);return n<1e-6?r.set(e,0,0,0):r.multiplyScalar(e,i,r.dot(t,i)/n)}}]),l(r,[{key:"clone",value:function(){return new r(this.x,this.y,this.z)}},{key:"set",value:function(e,t,i){return e&&"object"===de(e)?(this.x=e.x,this.y=e.y,this.z=e.z):(this.x=e||0,this.y=t||0,this.z=i||0),this}},{key:"equals",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:hi;return Math.abs(this.x-e.x)<=i*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=i*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=i*Math.max(1,Math.abs(this.z),Math.abs(e.z))}},{key:"equals3f",value:function(e,t,i,n){var r=3<arguments.length&&void 0!==n?n:hi;return Math.abs(this.x-e)<=r*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=r*Math.max(1,Math.abs(this.y),Math.abs(t))&&Math.abs(this.z-i)<=r*Math.max(1,Math.abs(this.z),Math.abs(i))}},{key:"strictEquals",value:function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z}},{key:"strictEquals3f",value:function(e,t,i){return this.x===e&&this.y===t&&this.z===i}},{key:"toString",value:function(){return"(".concat(this.x.toFixed(2),", ").concat(this.y.toFixed(2),", ").concat(this.z.toFixed(2),")")}},{key:"lerp",value:function(e,t){return this.x=this.x+t*(e.x-this.x),this.y=this.y+t*(e.y-this.y),this.z=this.z+t*(e.z-this.z),this}},{key:"add",value:function(e){return this.x=this.x+e.x,this.y=this.y+e.y,this.z=this.z+e.z,this}},{key:"add3f",value:function(e,t,i){return this.x=this.x+e,this.y=this.y+t,this.z=this.z+i,this}},{key:"subtract",value:function(e){return this.x=this.x-e.x,this.y=this.y-e.y,this.z=this.z-e.z,this}},{key:"subtract3f",value:function(e,t,i){return this.x=this.x-e,this.y=this.y-t,this.z=this.z-i,this}},{key:"multiplyScalar",value:function(e){return"object"===de(e)&&console.warn("should use Vec3.multiply for vector * vector operation"),this.x=this.x*e,this.y=this.y*e,this.z=this.z*e,this}},{key:"multiply",value:function(e){return"object"!==de(e)&&console.warn("should use Vec3.scale for vector * scalar operation"),this.x=this.x*e.x,this.y=this.y*e.y,this.z=this.z*e.z,this}},{key:"multiply3f",value:function(e,t,i){return this.x=this.x*e,this.y=this.y*t,this.z=this.z*i,this}},{key:"divide",value:function(e){return this.x=this.x/e.x,this.y=this.y/e.y,this.z=this.z/e.z,this}},{key:"divide3f",value:function(e,t,i){return this.x=this.x/e,this.y=this.y/t,this.z=this.z/i,this}},{key:"negative",value:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}},{key:"clampf",value:function(e,t){return this.x=pi(this.x,e.x,t.x),this.y=pi(this.y,e.y,t.y),this.z=pi(this.z,e.z,t.z),this}},{key:"dot",value:function(e){return this.x*e.x+this.y*e.y+this.z*e.z}},{key:"cross",value:function(e){var t=this.x,i=this.y,n=this.z,r=e.x,a=e.y,s=e.z;return this.x=i*s-n*a,this.y=n*r-t*s,this.z=t*a-i*r,this}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}},{key:"lengthSqr",value:function(){return this.x*this.x+this.y*this.y+this.z*this.z}},{key:"normalize",value:function(){Bi=this.x,Pi=this.y,Di=this.z;var e=Bi*Bi+Pi*Pi+Di*Di;return 0<e&&(e=1/Math.sqrt(e),this.x=Bi*e,this.y=Pi*e,this.z=Di*e),this}},{key:"transformMat4",value:function(e){Bi=this.x,Pi=this.y,Di=this.z;var t=e.m03*Bi+e.m07*Pi+e.m11*Di+e.m15;return t=t?1/t:1,this.x=(e.m00*Bi+e.m04*Pi+e.m08*Di+e.m12)*t,this.y=(e.m01*Bi+e.m05*Pi+e.m09*Di+e.m13)*t,this.z=(e.m02*Bi+e.m06*Pi+e.m10*Di+e.m14)*t,this}}]),r}());Fi.UNIT_X=Object.freeze(new Fi(1,0,0)),Fi.UNIT_Y=Object.freeze(new Fi(0,1,0)),Fi.UNIT_Z=Object.freeze(new Fi(0,0,1)),Fi.ZERO=Object.freeze(new Fi(0,0,0)),Fi.ONE=Object.freeze(new Fi(1,1,1)),Fi.NEG_ONE=Object.freeze(new Fi(-1,-1,-1));var Ni=new Fi,Ui=new Fi;function Vi(e,t,i){return new Fi(e,t,i)}ai.fastDefine("cc.Vec3",Fi,{x:0,y:0,z:0}),cc.Vec3=Fi,cc.v3=Vi;var Gi=0,Hi=0,qi=0,ji=0,Wi=P2("Vec4",function(){function a(e,t,i,n){var r;return y(this,a),(r=x(this,g(a).call(this))).x=void 0,r.y=void 0,r.z=void 0,r.w=void 0,e&&"object"===de(e)?(r.x=e.x,r.y=e.y,r.z=e.z,r.w=e.w):(r.x=e||0,r.y=t||0,r.z=i||0,r.w=n||0),r}return p(a,yt),l(a,null,[{key:"clone",value:function(e){return new a(e.x,e.y,e.z,e.w)}},{key:"copy",value:function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e}},{key:"set",value:function(e,t,i,n,r){return e.x=t,e.y=i,e.z=n,e.w=r,e}},{key:"add",value:function(e,t,i){return e.x=t.x+i.x,e.y=t.y+i.y,e.z=t.z+i.z,e.w=t.w+i.w,e}},{key:"subtract",value:function(e,t,i){return e.x=t.x-i.x,e.y=t.y-i.y,e.z=t.z-i.z,e.w=t.w-i.w,e}},{key:"multiply",value:function(e,t,i){return e.x=t.x*i.x,e.y=t.y*i.y,e.z=t.z*i.z,e.w=t.w*i.w,e}},{key:"divide",value:function(e,t,i){return e.x=t.x/i.x,e.y=t.y/i.y,e.z=t.z/i.z,e.w=t.w/i.w,e}},{key:"ceil",value:function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e.w=Math.ceil(t.w),e}},{key:"floor",value:function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e.w=Math.floor(t.w),e}},{key:"min",value:function(e,t,i){return e.x=Math.min(t.x,i.x),e.y=Math.min(t.y,i.y),e.z=Math.min(t.z,i.z),e.w=Math.min(t.w,i.w),e}},{key:"max",value:function(e,t,i){return e.x=Math.max(t.x,i.x),e.y=Math.max(t.y,i.y),e.z=Math.max(t.z,i.z),e.w=Math.max(t.w,i.w),e}},{key:"round",value:function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e.w=Math.round(t.w),e}},{key:"multiplyScalar",value:function(e,t,i){return e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e.w=t.w*i,e}},{key:"scaleAndAdd",value:function(e,t,i,n){return e.x=t.x+i.x*n,e.y=t.y+i.y*n,e.z=t.z+i.z*n,e.w=t.w+i.w*n,e}},{key:"distance",value:function(e,t){var i=t.x-e.x,n=t.y-e.y,r=t.z-e.z,a=t.w-e.w;return Math.sqrt(i*i+n*n+r*r+a*a)}},{key:"squaredDistance",value:function(e,t){var i=t.x-e.x,n=t.y-e.y,r=t.z-e.z,a=t.w-e.w;return i*i+n*n+r*r+a*a}},{key:"len",value:function(e){return Gi=e.x,Hi=e.y,qi=e.z,ji=e.w,Math.sqrt(Gi*Gi+Hi*Hi+qi*qi+ji*ji)}},{key:"lengthSqr",value:function(e){return Gi=e.x,Hi=e.y,qi=e.z,ji=e.w,Gi*Gi+Hi*Hi+qi*qi+ji*ji}},{key:"negate",value:function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=-t.w,e}},{key:"inverse",value:function(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e.w=1/t.w,e}},{key:"inverseSafe",value:function(e,t){return Gi=t.x,Hi=t.y,qi=t.z,ji=t.w,Math.abs(Gi)<hi?e.x=0:e.x=1/Gi,Math.abs(Hi)<hi?e.y=0:e.y=1/Hi,Math.abs(qi)<hi?e.z=0:e.z=1/qi,Math.abs(ji)<hi?e.w=0:e.w=1/ji,e}},{key:"normalize",value:function(e,t){Gi=t.x,Hi=t.y,qi=t.z,ji=t.w;var i=Gi*Gi+Hi*Hi+qi*qi+ji*ji;return 0<i&&(i=1/Math.sqrt(i),e.x=Gi*i,e.y=Hi*i,e.z=qi*i,e.w=ji*i),e}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}},{key:"lerp",value:function(e,t,i,n){return e.x=t.x+n*(i.x-t.x),e.y=t.y+n*(i.y-t.y),e.z=t.z+n*(i.z-t.z),e.w=t.w+n*(i.w-t.w),e}},{key:"random",value:function(e,t){t=t||1;var i=2*gi()*Math.PI,n=2*gi()-1,r=Math.sqrt(1-n*n);return e.x=r*Math.cos(i)*t,e.y=r*Math.sin(i)*t,e.z=n*t,e.w=0,e}},{key:"transformMat4",value:function(e,t,i){return Gi=t.x,Hi=t.y,qi=t.z,ji=t.w,e.x=i.m00*Gi+i.m04*Hi+i.m08*qi+i.m12*ji,e.y=i.m01*Gi+i.m05*Hi+i.m09*qi+i.m13*ji,e.z=i.m02*Gi+i.m06*Hi+i.m10*qi+i.m14*ji,e.w=i.m03*Gi+i.m07*Hi+i.m11*qi+i.m15*ji,e}},{key:"transformAffine",value:function(e,t,i){return Gi=t.x,Hi=t.y,qi=t.z,ji=t.w,e.x=i.m00*Gi+i.m01*Hi+i.m02*qi+i.m03*ji,e.y=i.m04*Gi+i.m05*Hi+i.m06*qi+i.m07*ji,e.x=i.m08*Gi+i.m09*Hi+i.m10*qi+i.m11*ji,e.w=t.w,e}},{key:"transformQuat",value:function(e,t,i){var n=t.x,r=t.y,a=t.z;Gi=i.x,Hi=i.y,qi=i.z;var s=(ji=i.w)*n+Hi*a-qi*r,o=ji*r+qi*n-Gi*a,l=ji*a+Gi*r-Hi*n,c=-Gi*n-Hi*r-qi*a;return e.x=s*ji+c*-Gi+o*-qi-l*-Hi,e.y=o*ji+c*-Hi+l*-Gi-s*-qi,e.z=l*ji+c*-qi+s*-Hi-o*-Gi,e.w=t.w,e}},{key:"toArray",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:0;return e[n+0]=t.x,e[n+1]=t.y,e[n+2]=t.z,e[n+3]=t.w,e}},{key:"fromArray",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:0;return e.x=t[n+0],e.y=t[n+1],e.z=t[n+2],e.w=t[n+3],e}},{key:"strictEquals",value:function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w}},{key:"equals",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:hi;return Math.abs(e.x-t.x)<=n*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=n*Math.max(1,Math.abs(e.y),Math.abs(t.y))&&Math.abs(e.z-t.z)<=n*Math.max(1,Math.abs(e.z),Math.abs(t.z))&&Math.abs(e.w-t.w)<=n*Math.max(1,Math.abs(e.w),Math.abs(t.w))}}]),l(a,[{key:"clone",value:function(){return new a(this.x,this.y,this.z,this.w)}},{key:"set",value:function(e,t,i,n){return e&&"object"===de(e)?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=t||0,this.z=i||0,this.w=n||0),this}},{key:"equals",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:hi;return Math.abs(this.x-e.x)<=i*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=i*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=i*Math.max(1,Math.abs(this.z),Math.abs(e.z))&&Math.abs(this.w-e.w)<=i*Math.max(1,Math.abs(this.w),Math.abs(e.w))}},{key:"equals4f",value:function(e,t,i,n,r){var a=4<arguments.length&&void 0!==r?r:hi;return Math.abs(this.x-e)<=a*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=a*Math.max(1,Math.abs(this.y),Math.abs(t))&&Math.abs(this.z-i)<=a*Math.max(1,Math.abs(this.z),Math.abs(i))&&Math.abs(this.w-n)<=a*Math.max(1,Math.abs(this.w),Math.abs(n))}},{key:"strictEquals",value:function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}},{key:"strictEquals4f",value:function(e,t,i,n){return this.x===e&&this.y===t&&this.z===i&&this.w===n}},{key:"lerp",value:function(e,t){return Gi=this.x,Hi=this.y,qi=this.z,ji=this.w,this.x=Gi+t*(e.x-Gi),this.y=Hi+t*(e.y-Hi),this.z=qi+t*(e.z-qi),this.w=ji+t*(e.w-ji),this}},{key:"toString",value:function(){return"(".concat(this.x.toFixed(2),", ").concat(this.y.toFixed(2),", ").concat(this.z.toFixed(2),", ").concat(this.w.toFixed(2),")")}},{key:"clampf",value:function(e,t){return this.x=pi(this.x,e.x,t.x),this.y=pi(this.y,e.y,t.y),this.z=pi(this.z,e.z,t.z),this.w=pi(this.w,e.w,t.w),this}},{key:"add",value:function(e){return this.x=this.x+e.x,this.y=this.y+e.y,this.z=this.z+e.z,this.w=this.w+e.w,this}},{key:"add4f",value:function(e,t,i,n){return this.x=this.x+e,this.y=this.y+t,this.z=this.z+i,this.w=this.w+n,this}},{key:"subtract",value:function(e){return this.x=this.x-e.x,this.y=this.y-e.y,this.z=this.z-e.z,this.w=this.w-e.w,this}},{key:"subtract4f",value:function(e,t,i,n){return this.x=this.x-e,this.y=this.y-t,this.z=this.z-i,this.w=this.w-n,this}},{key:"multiplyScalar",value:function(e){return"object"===de(e)&&console.warn("should use Vec4.multiply for vector * vector operation"),this.x=this.x*e,this.y=this.y*e,this.z=this.z*e,this.w=this.w*e,this}},{key:"multiply",value:function(e){return"object"!==de(e)&&console.warn("should use Vec4.scale for vector * scalar operation"),this.x=this.x*e.x,this.y=this.y*e.y,this.z=this.z*e.z,this.w=this.w*e.w,this}},{key:"multiply4f",value:function(e,t,i,n){return this.x=this.x*e,this.y=this.y*t,this.z=this.z*i,this.w=this.w*n,this}},{key:"divide",value:function(e){return this.x=this.x/e.x,this.y=this.y/e.y,this.z=this.z/e.z,this.w=this.w/e.w,this}},{key:"divide4f",value:function(e,t,i,n){return this.x=this.x/e,this.y=this.y/t,this.z=this.z/i,this.w=this.w/n,this}},{key:"negative",value:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}},{key:"dot",value:function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}},{key:"cross",value:function(e){var t=this.x,i=this.y,n=this.z,r=e.x,a=e.y,s=e.z;return this.x=i*s-n*a,this.y=n*r-t*s,this.z=t*a-i*r,this}},{key:"length",value:function(){return Gi=this.x,Hi=this.y,qi=this.z,ji=this.w,Math.sqrt(Gi*Gi+Hi*Hi+qi*qi+ji*ji)}},{key:"lengthSqr",value:function(){return Gi=this.x,Hi=this.y,qi=this.z,ji=this.w,Gi*Gi+Hi*Hi+qi*qi+ji*ji}},{key:"normalize",value:function(){Gi=this.x,Hi=this.y,qi=this.z,ji=this.w;var e=Gi*Gi+Hi*Hi+qi*qi+ji*ji;return 0<e&&(e=1/Math.sqrt(e),this.x=Gi*e,this.y=Hi*e,this.z=qi*e,this.w=ji*e),this}},{key:"transformMat4",value:function(e){return Gi=this.x,Hi=this.y,qi=this.z,ji=this.w,this.x=e.m00*Gi+e.m04*Hi+e.m08*qi+e.m12*ji,this.y=e.m01*Gi+e.m05*Hi+e.m09*qi+e.m13*ji,this.z=e.m02*Gi+e.m06*Hi+e.m10*qi+e.m14*ji,this.w=e.m03*Gi+e.m07*Hi+e.m11*qi+e.m15*ji,this}}]),a}());function Xi(e,t,i,n){return new Wi(e,t,i,n)}Wi.ZERO=Object.freeze(new Wi(0,0,0,0)),Wi.ONE=Object.freeze(new Wi(1,1,1,1)),Wi.NEG_ONE=Object.freeze(new Wi(-1,-1,-1,-1)),ai.fastDefine("cc.Vec4",Wi,{x:0,y:0,z:0,w:0}),cc.Vec4=Wi,cc.v4=Xi;var Yi=0,Qi=0,Ki=0,Zi=0,Ji=0,$i=0,en=0,tn=0,nn=0,rn=P2("Mat3",function(){function u(){var e,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:1,i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,a=4<arguments.length&&void 0!==arguments[4]?arguments[4]:1,s=5<arguments.length&&void 0!==arguments[5]?arguments[5]:0,o=6<arguments.length&&void 0!==arguments[6]?arguments[6]:0,l=7<arguments.length&&void 0!==arguments[7]?arguments[7]:0,c=8<arguments.length&&void 0!==arguments[8]?arguments[8]:1;return y(this,u),(e=x(this,g(u).call(this))).m00=void 0,e.m01=void 0,e.m02=void 0,e.m03=void 0,e.m04=void 0,e.m05=void 0,e.m06=void 0,e.m07=void 0,e.m08=void 0,"object"===de(t)?(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08):(e.m00=t,e.m01=i,e.m02=n,e.m03=r,e.m04=a,e.m05=s,e.m06=o,e.m07=l,e.m08=c),e}return p(u,yt),l(u,null,[{key:"clone",value:function(e){return new u(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08)}},{key:"copy",value:function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e}},{key:"set",value:function(e,t,i,n,r,a,s,o,l,c){return e.m00=t,e.m01=i,e.m02=n,e.m03=r,e.m04=a,e.m05=s,e.m06=o,e.m07=l,e.m08=c,e}},{key:"identity",value:function(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e}},{key:"transpose",value:function(e,t){return e===t?(Qi=t.m01,Ki=t.m02,$i=t.m05,e.m01=t.m03,e.m02=t.m06,e.m03=Qi,e.m05=t.m07,e.m06=Ki,e.m07=$i):(e.m00=t.m00,e.m01=t.m03,e.m02=t.m06,e.m03=t.m01,e.m04=t.m04,e.m05=t.m07,e.m06=t.m02,e.m07=t.m05,e.m08=t.m08),e}},{key:"invert",value:function(e,t){Yi=t.m00,Qi=t.m01,Ki=t.m02,Zi=t.m03,Ji=t.m04,$i=t.m05,en=t.m06,tn=t.m07;var i=(nn=t.m08)*Ji-$i*tn,n=-nn*Zi+$i*en,r=tn*Zi-Ji*en,a=Yi*i+Qi*n+Ki*r;return a&&(a=1/a,e.m00=i*a,e.m01=(-nn*Qi+Ki*tn)*a,e.m02=($i*Qi-Ki*Ji)*a,e.m03=n*a,e.m04=(nn*Yi-Ki*en)*a,e.m05=(-$i*Yi+Ki*Zi)*a,e.m06=r*a,e.m07=(-tn*Yi+Qi*en)*a,e.m08=(Ji*Yi-Qi*Zi)*a),e}},{key:"determinant",value:function(e){return Yi=e.m00,Qi=e.m01,Ki=e.m02,Zi=e.m03,Ji=e.m04,$i=e.m05,en=e.m06,tn=e.m07,nn=e.m08,Yi*(nn*Ji-$i*tn)+Qi*(-nn*Zi+$i*en)+Ki*(tn*Zi-Ji*en)}},{key:"multiply",value:function(e,t,i){Yi=t.m00,Qi=t.m01,Ki=t.m02,Zi=t.m03,Ji=t.m04,$i=t.m05,en=t.m06,tn=t.m07,nn=t.m08;var n=i.m00,r=i.m01,a=i.m02,s=i.m03,o=i.m04,l=i.m05,c=i.m06,u=i.m07,h=i.m08;return e.m00=n*Yi+r*Zi+a*en,e.m01=n*Qi+r*Ji+a*tn,e.m02=n*Ki+r*$i+a*nn,e.m03=s*Yi+o*Zi+l*en,e.m04=s*Qi+o*Ji+l*tn,e.m05=s*Ki+o*$i+l*nn,e.m06=c*Yi+u*Zi+h*en,e.m07=c*Qi+u*Ji+h*tn,e.m08=c*Ki+u*$i+h*nn,e}},{key:"multiplyMat4",value:function(e,t,i){Yi=t.m00,Qi=t.m01,Ki=t.m02,Zi=t.m03,Ji=t.m04,$i=t.m05,en=t.m06,tn=t.m07,nn=t.m08;var n=i.m00,r=i.m01,a=i.m02,s=i.m04,o=i.m05,l=i.m06,c=i.m08,u=i.m09,h=i.m10;return e.m00=n*Yi+r*Zi+a*en,e.m01=n*Qi+r*Ji+a*tn,e.m02=n*Ki+r*$i+a*nn,e.m03=s*Yi+o*Zi+l*en,e.m04=s*Qi+o*Ji+l*tn,e.m05=s*Ki+o*$i+l*nn,e.m06=c*Yi+u*Zi+h*en,e.m07=c*Qi+u*Ji+h*tn,e.m08=c*Ki+u*$i+h*nn,e}},{key:"transfrom",value:function(e,t,i){Yi=t.m00,Qi=t.m01,Ki=t.m02,Zi=t.m03,Ji=t.m04,$i=t.m05,en=t.m06,tn=t.m07,nn=t.m08;var n=i.x,r=i.y;return e.m00=Yi,e.m01=Qi,e.m02=Ki,e.m03=Zi,e.m04=Ji,e.m05=$i,e.m06=n*Yi+r*Zi+en,e.m07=n*Qi+r*Ji+tn,e.m08=n*Ki+r*$i+nn,e}},{key:"scale",value:function(e,t,i){var n=i.x,r=i.y;return e.m00=n*t.m00,e.m01=n*t.m01,e.m02=n*t.m02,e.m03=r*t.m03,e.m04=r*t.m04,e.m05=r*t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e}},{key:"rotate",value:function(e,t,i){Yi=t.m00,Qi=t.m01,Ki=t.m02,Zi=t.m03,Ji=t.m04,$i=t.m05,en=t.m06,tn=t.m07,nn=t.m08;var n=Math.sin(i),r=Math.cos(i);return e.m00=r*Yi+n*Zi,e.m01=r*Qi+n*Ji,e.m02=r*Ki+n*$i,e.m03=r*Zi-n*Yi,e.m04=r*Ji-n*Qi,e.m05=r*$i-n*Ki,e.m06=en,e.m07=tn,e.m08=nn,e}},{key:"fromMat4",value:function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m04,e.m04=t.m05,e.m05=t.m06,e.m06=t.m08,e.m07=t.m09,e.m08=t.m10,e}},{key:"fromViewUp",value:function(e,t,i){return Fi.lengthSqr(t)<hi*hi?(u.identity(e),e):(i=i||Fi.UNIT_Y,Fi.normalize(an,Fi.cross(an,i,t)),Fi.lengthSqr(an)<hi*hi?u.identity(e):(Fi.cross(sn,t,an),u.set(e,an.x,an.y,an.z,sn.x,sn.y,sn.z,t.x,t.y,t.z)),e)}},{key:"fromTranslation",value:function(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=t.x,e.m07=t.y,e.m08=1,e}},{key:"fromScaling",value:function(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=t.y,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e}},{key:"fromRotation",value:function(e,t){var i=Math.sin(t),n=Math.cos(t);return e.m00=n,e.m01=i,e.m02=0,e.m03=-i,e.m04=n,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e}},{key:"fromQuat",value:function(e,t){var i=t.x,n=t.y,r=t.z,a=t.w,s=i+i,o=n+n,l=r+r,c=i*s,u=n*s,h=n*o,f=r*s,d=r*o,p=r*l,_=a*s,v=a*o,m=a*l;return e.m00=1-h-p,e.m03=u-m,e.m06=f+v,e.m01=u+m,e.m04=1-c-p,e.m07=d-_,e.m02=f-v,e.m05=d+_,e.m08=1-c-h,e}},{key:"inverseTransposeMat4",value:function(e,t){var i=t.m00,n=t.m01,r=t.m02,a=t.m03,s=t.m04,o=t.m05,l=t.m06,c=t.m07,u=t.m08,h=t.m09,f=t.m10,d=t.m11,p=t.m12,_=t.m13,v=t.m14,m=t.m15,y=i*o-n*s,g=i*l-r*s,b=i*c-a*s,x=n*l-r*o,S=n*c-a*o,w=r*c-a*l,T=u*_-h*p,E=u*v-f*p,C=u*m-d*p,A=h*v-f*_,k=h*m-d*_,R=f*m-d*v,O=y*R-g*k+b*A+x*C-S*E+w*T;return O?(O=1/O,e.m00=(o*R-l*k+c*A)*O,e.m01=(l*C-s*R-c*E)*O,e.m02=(s*k-o*C+c*T)*O,e.m03=(r*k-n*R-a*A)*O,e.m04=(i*R-r*C+a*E)*O,e.m05=(n*C-i*k-a*T)*O,e.m06=(_*w-v*S+m*x)*O,e.m07=(v*b-p*w-m*g)*O,e.m08=(p*S-_*b+m*y)*O,e):null}},{key:"toArray",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:0;return e[n+0]=t.m00,e[n+1]=t.m01,e[n+2]=t.m02,e[n+3]=t.m03,e[n+4]=t.m04,e[n+5]=t.m05,e[n+6]=t.m06,e[n+7]=t.m07,e[n+8]=t.m08,e}},{key:"fromArray",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:0;return e.m00=t[n+0],e.m01=t[n+1],e.m02=t[n+2],e.m03=t[n+3],e.m04=t[n+4],e.m05=t[n+5],e.m06=t[n+6],e.m07=t[n+7],e.m08=t[n+8],e}},{key:"add",value:function(e,t,i){return e.m00=t.m00+i.m00,e.m01=t.m01+i.m01,e.m02=t.m02+i.m02,e.m03=t.m03+i.m03,e.m04=t.m04+i.m04,e.m05=t.m05+i.m05,e.m06=t.m06+i.m06,e.m07=t.m07+i.m07,e.m08=t.m08+i.m08,e}},{key:"subtract",value:function(e,t,i){return e.m00=t.m00-i.m00,e.m01=t.m01-i.m01,e.m02=t.m02-i.m02,e.m03=t.m03-i.m03,e.m04=t.m04-i.m04,e.m05=t.m05-i.m05,e.m06=t.m06-i.m06,e.m07=t.m07-i.m07,e.m08=t.m08-i.m08,e}},{key:"multiplyScalar",value:function(e,t,i){return e.m00=t.m00*i,e.m01=t.m01*i,e.m02=t.m02*i,e.m03=t.m03*i,e.m04=t.m04*i,e.m05=t.m05*i,e.m06=t.m06*i,e.m07=t.m07*i,e.m08=t.m08*i,e}},{key:"multiplyScalarAndAdd",value:function(e,t,i,n){return e.m00=i.m00*n+t.m00,e.m01=i.m01*n+t.m01,e.m02=i.m02*n+t.m02,e.m03=i.m03*n+t.m03,e.m04=i.m04*n+t.m04,e.m05=i.m05*n+t.m05,e.m06=i.m06*n+t.m06,e.m07=i.m07*n+t.m07,e.m08=i.m08*n+t.m08,e}},{key:"strictEquals",value:function(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08}},{key:"equals",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:hi;return Math.abs(e.m00-t.m00)<=n*Math.max(1,Math.abs(e.m00),Math.abs(t.m00))&&Math.abs(e.m01-t.m01)<=n*Math.max(1,Math.abs(e.m01),Math.abs(t.m01))&&Math.abs(e.m02-t.m02)<=n*Math.max(1,Math.abs(e.m02),Math.abs(t.m02))&&Math.abs(e.m03-t.m03)<=n*Math.max(1,Math.abs(e.m03),Math.abs(t.m03))&&Math.abs(e.m04-t.m04)<=n*Math.max(1,Math.abs(e.m04),Math.abs(t.m04))&&Math.abs(e.m05-t.m05)<=n*Math.max(1,Math.abs(e.m05),Math.abs(t.m05))&&Math.abs(e.m06-t.m06)<=n*Math.max(1,Math.abs(e.m06),Math.abs(t.m06))&&Math.abs(e.m07-t.m07)<=n*Math.max(1,Math.abs(e.m07),Math.abs(t.m07))&&Math.abs(e.m08-t.m08)<=n*Math.max(1,Math.abs(e.m08),Math.abs(t.m08))}}]),l(u,[{key:"clone",value:function(){return new u(this.m00,this.m01,this.m02,this.m03,this.m04,this.m05,this.m06,this.m07,this.m08)}},{key:"set",value:function(e,t,i,n,r,a,s,o,l){var c=0<arguments.length&&void 0!==e?e:1,u=1<arguments.length&&void 0!==t?t:0,h=2<arguments.length&&void 0!==i?i:0,f=3<arguments.length&&void 0!==n?n:0,d=4<arguments.length&&void 0!==r?r:1,p=5<arguments.length&&void 0!==a?a:0,_=6<arguments.length&&void 0!==s?s:0,v=7<arguments.length&&void 0!==o?o:0,m=8<arguments.length&&void 0!==l?l:1;return"object"===de(c)?(this.m00=c.m00,this.m01=c.m01,this.m02=c.m02,this.m03=c.m03,this.m04=c.m04,this.m05=c.m05,this.m06=c.m06,this.m07=c.m07,this.m08=c.m08):(this.m00=c,this.m01=u,this.m02=h,this.m03=f,this.m04=d,this.m05=p,this.m06=_,this.m07=v,this.m08=m),this}},{key:"equals",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:hi;return Math.abs(this.m00-e.m00)<=i*Math.max(1,Math.abs(this.m00),Math.abs(e.m00))&&Math.abs(this.m01-e.m01)<=i*Math.max(1,Math.abs(this.m01),Math.abs(e.m01))&&Math.abs(this.m02-e.m02)<=i*Math.max(1,Math.abs(this.m02),Math.abs(e.m02))&&Math.abs(this.m03-e.m03)<=i*Math.max(1,Math.abs(this.m03),Math.abs(e.m03))&&Math.abs(this.m04-e.m04)<=i*Math.max(1,Math.abs(this.m04),Math.abs(e.m04))&&Math.abs(this.m05-e.m05)<=i*Math.max(1,Math.abs(this.m05),Math.abs(e.m05))&&Math.abs(this.m06-e.m06)<=i*Math.max(1,Math.abs(this.m06),Math.abs(e.m06))&&Math.abs(this.m07-e.m07)<=i*Math.max(1,Math.abs(this.m07),Math.abs(e.m07))&&Math.abs(this.m08-e.m08)<=i*Math.max(1,Math.abs(this.m08),Math.abs(e.m08))}},{key:"strictEquals",value:function(e){return this.m00===e.m00&&this.m01===e.m01&&this.m02===e.m02&&this.m03===e.m03&&this.m04===e.m04&&this.m05===e.m05&&this.m06===e.m06&&this.m07===e.m07&&this.m08===e.m08}},{key:"toString",value:function(){return"[\n"+this.m00+", "+this.m01+", "+this.m02+",\n"+this.m03+",\n"+this.m04+", "+this.m05+",\n"+this.m06+", "+this.m07+",\n"+this.m08+"\n]"}},{key:"identity",value:function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=1,this.m05=0,this.m06=0,this.m07=0,this.m08=1,this}},{key:"transpose",value:function(){var e=this.m01,t=this.m02,i=this.m05;return this.m01=this.m03,this.m02=this.m06,this.m03=e,this.m05=this.m07,this.m06=t,this.m07=i,this}},{key:"invert",value:function(){Yi=this.m00,Qi=this.m01,Ki=this.m02,Zi=this.m03,Ji=this.m04,$i=this.m05,en=this.m06,tn=this.m07;var e=(nn=this.m08)*Ji-$i*tn,t=-nn*Zi+$i*en,i=tn*Zi-Ji*en,n=Yi*e+Qi*t+Ki*i;return n?(n=1/n,this.m00=e*n,this.m01=(-nn*Qi+Ki*tn)*n,this.m02=($i*Qi-Ki*Ji)*n,this.m03=t*n,this.m04=(nn*Yi-Ki*en)*n,this.m05=(-$i*Yi+Ki*Zi)*n,this.m06=i*n,this.m07=(-tn*Yi+Qi*en)*n,this.m08=(Ji*Yi-Qi*Zi)*n,this):null}},{key:"determinant",value:function(){return Yi=this.m00,Qi=this.m01,Ki=this.m02,Zi=this.m03,Ji=this.m04,$i=this.m05,en=this.m06,tn=this.m07,nn=this.m08,Yi*(nn*Ji-$i*tn)+Qi*(-nn*Zi+$i*en)+Ki*(tn*Zi-Ji*en)}},{key:"add",value:function(e){return this.m00=this.m00+e.m00,this.m01=this.m01+e.m01,this.m02=this.m02+e.m02,this.m03=this.m03+e.m03,this.m04=this.m04+e.m04,this.m05=this.m05+e.m05,this.m06=this.m06+e.m06,this.m07=this.m07+e.m07,this.m08=this.m08+e.m08,this}},{key:"subtract",value:function(e){return this.m00=this.m00-e.m00,this.m01=this.m01-e.m01,this.m02=this.m02-e.m02,this.m03=this.m03-e.m03,this.m04=this.m04-e.m04,this.m05=this.m05-e.m05,this.m06=this.m06-e.m06,this.m07=this.m07-e.m07,this.m08=this.m08-e.m08,this}},{key:"multiply",value:function(e){var t=this.m00,i=this.m01,n=this.m02,r=this.m03,a=this.m04,s=this.m05,o=this.m06,l=this.m07,c=this.m08,u=e.m00,h=e.m01,f=e.m02,d=e.m03,p=e.m04,_=e.m05,v=e.m06,m=e.m07,y=e.m08;return this.m00=u*t+h*r+f*o,this.m01=u*i+h*a+f*l,this.m02=u*n+h*s+f*c,this.m03=d*t+p*r+_*o,this.m04=d*i+p*a+_*l,this.m05=d*n+p*s+_*c,this.m06=v*t+m*r+y*o,this.m07=v*i+m*a+y*l,this.m08=v*n+m*s+y*c,this}},{key:"multiplyScalar",value:function(e){return this.m00=this.m00*e,this.m01=this.m01*e,this.m02=this.m02*e,this.m03=this.m03*e,this.m04=this.m04*e,this.m05=this.m05*e,this.m06=this.m06*e,this.m07=this.m07*e,this.m08=this.m08*e,this}},{key:"scale",value:function(e){var t=e.x,i=e.y;return this.m00=t*this.m00,this.m01=t*this.m01,this.m02=t*this.m02,this.m03=i*this.m03,this.m04=i*this.m04,this.m05=i*this.m05,this.m06=this.m06,this.m07=this.m07,this.m08=this.m08,this}},{key:"rotate",value:function(e){Yi=this.m00,Qi=this.m01,Ki=this.m02,Zi=this.m03,Ji=this.m04,$i=this.m05,en=this.m06,tn=this.m07,nn=this.m08;var t=Math.sin(e),i=Math.cos(e);return this.m00=i*Yi+t*Zi,this.m01=i*Qi+t*Ji,this.m02=i*Ki+t*$i,this.m03=i*Zi-t*Yi,this.m04=i*Ji-t*Qi,this.m05=i*$i-t*Ki,this.m06=en,this.m07=tn,this.m08=nn,this}},{key:"fromQuat",value:function(e){var t=e.x,i=e.y,n=e.z,r=e.w,a=t+t,s=i+i,o=n+n,l=t*a,c=i*a,u=i*s,h=n*a,f=n*s,d=n*o,p=r*a,_=r*s,v=r*o;return this.m00=1-u-d,this.m03=c-v,this.m06=h+_,this.m01=c+v,this.m04=1-l-d,this.m07=f-p,this.m02=h-_,this.m05=f+p,this.m08=1-l-u,this}}]),u}());rn.IDENTITY=Object.freeze(new rn);var an=new Fi,sn=new Fi;ai.fastDefine("cc.Mat3",rn,{m00:1,m01:0,m02:0,m03:0,m04:1,m05:0,m06:0,m07:0,m08:1}),cc.Mat3=rn;var on=0,ln=0,cn=0,un=0,hn=P2("Quat",function(){function s(e,t,i,n){var r;return y(this,s),(r=x(this,g(s).call(this))).x=void 0,r.y=void 0,r.z=void 0,r.w=void 0,e&&"object"===de(e)?(r.x=e.x,r.y=e.y,r.z=e.z,r.w=e.w):(r.x=e||0,r.y=t||0,r.z=i||0,r.w=n||1),r}return p(s,yt),l(s,null,[{key:"clone",value:function(e){return new s(e.x,e.y,e.z,e.w)}},{key:"copy",value:function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e}},{key:"set",value:function(e,t,i,n,r){return e.x=t,e.y=i,e.z=n,e.w=r,e}},{key:"identity",value:function(e){return e.x=0,e.y=0,e.z=0,e.w=1,e}},{key:"rotationTo",value:function(e,t,i){var n=Fi.dot(t,i);return n<-.999999?(Fi.cross(pn,Fi.UNIT_X,t),pn.length()<1e-6&&Fi.cross(pn,Fi.UNIT_Y,t),Fi.normalize(pn,pn),s.fromAxisAngle(e,pn,Math.PI),e):.999999<n?(e.x=0,e.y=0,e.z=0,e.w=1,e):(Fi.cross(pn,t,i),e.x=pn.x,e.y=pn.y,e.z=pn.z,e.w=1+n,s.normalize(e,e))}},{key:"getAxisAngle",value:function(e,t){var i=2*Math.acos(t.w),n=Math.sin(i/2);return 0!==n?(e.x=t.x/n,e.y=t.y/n,e.z=t.z/n):(e.x=1,e.y=0,e.z=0),i}},{key:"multiply",value:function(e,t,i){return on=t.x*i.w+t.w*i.x+t.y*i.z-t.z*i.y,ln=t.y*i.w+t.w*i.y+t.z*i.x-t.x*i.z,cn=t.z*i.w+t.w*i.z+t.x*i.y-t.y*i.x,un=t.w*i.w-t.x*i.x-t.y*i.y-t.z*i.z,e.x=on,e.y=ln,e.z=cn,e.w=un,e}},{key:"multiplyScalar",value:function(e,t,i){return e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e.w=t.w*i,e}},{key:"scaleAndAdd",value:function(e,t,i,n){return e.x=t.x+i.x*n,e.y=t.y+i.y*n,e.z=t.z+i.z*n,e.w=t.w+i.w*n,e}},{key:"rotateX",value:function(e,t,i){i*=.5;var n=Math.sin(i),r=Math.cos(i);return e.x=t.x*r+t.w*n,e.y=t.y*r+t.z*n,e.z=t.z*r-t.y*n,e.w=t.w*r-t.x*n,e}},{key:"rotateY",value:function(e,t,i){i*=.5;var n=Math.sin(i),r=Math.cos(i);return e.x=t.x*r-t.z*n,e.y=t.y*r+t.w*n,e.z=t.z*r+t.x*n,e.w=t.w*r-t.y*n,e}},{key:"rotateZ",value:function(e,t,i){i*=.5;var n=Math.sin(i),r=Math.cos(i);return e.x=t.x*r+t.y*n,e.y=t.y*r-t.x*n,e.z=t.z*r+t.w*n,e.w=t.w*r-t.z*n,e}},{key:"rotateAround",value:function(e,t,i,n){return s.invert(fn,t),Fi.transformQuat(pn,i,fn),s.fromAxisAngle(fn,pn,n),s.multiply(e,t,fn),e}},{key:"rotateAroundLocal",value:function(e,t,i,n){return s.fromAxisAngle(fn,i,n),s.multiply(e,t,fn),e}},{key:"calculateW",value:function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=Math.sqrt(Math.abs(1-t.x*t.x-t.y*t.y-t.z*t.z)),e}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}},{key:"lerp",value:function(e,t,i,n){return e.x=t.x+n*(i.x-t.x),e.y=t.y+n*(i.y-t.y),e.z=t.z+n*(i.z-t.z),e.w=t.w+n*(i.w-t.w),e}},{key:"slerp",value:function(e,t,i,n){var r=0,a=0,s=t.x*i.x+t.y*i.y+t.z*i.z+t.w*i.w;if(s<0&&(s=-s,i.x=-i.x,i.y=-i.y,i.z=-i.z,i.w=-i.w),1e-6<1-s){var o=Math.acos(s),l=Math.sin(o);r=Math.sin((1-n)*o)/l,a=Math.sin(n*o)/l}else r=1-n,a=n;return e.x=r*t.x+a*i.x,e.y=r*t.y+a*i.y,e.z=r*t.z+a*i.z,e.w=r*t.w+a*i.w,e}},{key:"sqlerp",value:function(e,t,i,n,r,a){return s.slerp(fn,t,r,a),s.slerp(dn,i,n,a),s.slerp(e,fn,dn,2*a*(1-a)),e}},{key:"invert",value:function(e,t){var i=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w,n=i?1/i:0;return e.x=-t.x*n,e.y=-t.y*n,e.z=-t.z*n,e.w=t.w*n,e}},{key:"conjugate",value:function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=t.w,e}},{key:"len",value:function(e){return Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w)}},{key:"lengthSqr",value:function(e){return e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w}},{key:"normalize",value:function(e,t){var i=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w;return 0<i&&(i=1/Math.sqrt(i),e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e.w=t.w*i),e}},{key:"fromAxes",value:function(e,t,i,n){return rn.set(_n,t.x,t.y,t.z,i.x,i.y,i.z,n.x,n.y,n.z),s.normalize(e,s.fromMat3(e,_n))}},{key:"fromViewUp",value:function(e,t,i){return rn.fromViewUp(_n,t,i),s.normalize(e,s.fromMat3(e,_n))}},{key:"fromAxisAngle",value:function(e,t,i){i*=.5;var n=Math.sin(i);return e.x=n*t.x,e.y=n*t.y,e.z=n*t.z,e.w=Math.cos(i),e}},{key:"fromMat3",value:function(e,t){var i=t.m00,n=t.m03,r=t.m06,a=t.m01,s=t.m04,o=t.m07,l=t.m02,c=t.m05,u=t.m08,h=i+s+u;if(0<h){var f=.5/Math.sqrt(h+1);e.w=.25/f,e.x=(c-o)*f,e.y=(r-l)*f,e.z=(a-n)*f}else if(s<i&&u<i){var d=2*Math.sqrt(1+i-s-u);e.w=(c-o)/d,e.x=.25*d,e.y=(n+a)/d,e.z=(r+l)/d}else if(u<s){var p=2*Math.sqrt(1+s-i-u);e.w=(r-l)/p,e.x=(n+a)/p,e.y=.25*p,e.z=(o+c)/p}else{var _=2*Math.sqrt(1+u-i-s);e.w=(a-n)/_,e.x=(r+l)/_,e.y=(o+c)/_,e.z=.25*_}return e}},{key:"fromEuler",value:function(e,t,i,n){t*=vn,i*=vn,n*=vn;var r=Math.sin(t),a=Math.cos(t),s=Math.sin(i),o=Math.cos(i),l=Math.sin(n),c=Math.cos(n);return e.x=r*o*c+a*s*l,e.y=a*s*c+r*o*l,e.z=a*o*l-r*s*c,e.w=a*o*c-r*s*l,e}},{key:"toAxisX",value:function(e,t){var i=2*t.y,n=2*t.z;return e.x=1-i*t.y-n*t.z,e.y=i*t.x+n*t.w,e.z=n*t.x+i*t.w,e}},{key:"toAxisY",value:function(e,t){var i=2*t.x,n=2*t.y,r=2*t.z;return e.x=n*t.x-r*t.w,e.y=1-i*t.x-r*t.z,e.z=r*t.y+i*t.w,e}},{key:"toAxisZ",value:function(e,t){var i=2*t.x,n=2*t.y,r=2*t.z;return e.x=r*t.x-n*t.w,e.y=r*t.y-i*t.w,e.z=1-i*t.x-n*t.y,e}},{key:"toEuler",value:function(e,t,i){var n=t.x,r=t.y,a=t.z,s=t.w,o=0,l=0,c=0,u=n*r+a*s;if(.499999<u)o=0,l=yi(2*Math.atan2(n,s)),c=90;else if(u<-.499999)o=0,l=-yi(2*Math.atan2(n,s)),c=-90;else{var h=n*n,f=r*r,d=a*a;o=yi(Math.atan2(2*n*s-2*r*a,1-2*h-2*d)),l=yi(Math.atan2(2*r*s-2*n*a,1-2*f-2*d)),c=yi(Math.asin(2*u)),i&&(o=-180*Math.sign(o+1e-6)+o,l=-180*Math.sign(l+1e-6)+l,c=180*Math.sign(c+1e-6)-c)}return e.x=o,e.y=l,e.z=c,e}},{key:"toArray",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:0;return e[n+0]=t.x,e[n+1]=t.y,e[n+2]=t.z,e[n+3]=t.w,e}},{key:"fromArray",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:0;return e.x=t[n+0],e.y=t[n+1],e.z=t[n+2],e.w=t[n+3],e}},{key:"strictEquals",value:function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w}},{key:"equals",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:hi;return Math.abs(e.x-t.x)<=n*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=n*Math.max(1,Math.abs(e.y),Math.abs(t.y))&&Math.abs(e.z-t.z)<=n*Math.max(1,Math.abs(e.z),Math.abs(t.z))&&Math.abs(e.w-t.w)<=n*Math.max(1,Math.abs(e.w),Math.abs(t.w))}}]),l(s,[{key:"clone",value:function(){return new s(this.x,this.y,this.z,this.w)}},{key:"set",value:function(e,t,i,n){return e&&"object"===de(e)?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=t||0,this.z=i||0,this.w=n||1),this}},{key:"equals",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:hi;return Math.abs(this.x-e.x)<=i*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=i*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=i*Math.max(1,Math.abs(this.z),Math.abs(e.z))&&Math.abs(this.w-e.w)<=i*Math.max(1,Math.abs(this.w),Math.abs(e.w))}},{key:"strictEquals",value:function(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}},{key:"getEulerAngles",value:function(e){return s.toEuler(e,this)}},{key:"lerp",value:function(e,t){var i=0,n=0,r=this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w;if(r<0&&(r=-r,e.x=-e.x,e.y=-e.y,e.z=-e.z,e.w=-e.w),1e-6<1-r){var a=Math.acos(r),s=Math.sin(a);i=Math.sin((1-t)*a)/s,n=Math.sin(t*a)/s}else i=1-t,n=t;return this.x=i*this.x+n*e.x,this.y=i*this.y+n*e.y,this.z=i*this.z+n*e.z,this.w=i*this.w+n*e.w,this}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}},{key:"lengthSqr",value:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}}]),s}());hn.IDENTITY=Object.freeze(new hn);var fn=new hn,dn=new hn,pn=new Fi,_n=new rn,vn=.5*Math.PI/180;function mn(){return new hn(0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,3<arguments.length&&void 0!==arguments[3]?arguments[3]:1)}ai.fastDefine("cc.Quat",hn,{x:0,y:0,z:0,w:1}),cc.Quat=hn,cc.quat=mn;var yn=0,gn=0,bn=0,xn=0,Sn=0,wn=0,Tn=0,En=0,Cn=0,An=0,kn=0,Rn=0,On=0,Mn=0,In=0,Ln=0,zn=P2("Mat4",function(){function m(){var e,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:1,i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,a=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,s=5<arguments.length&&void 0!==arguments[5]?arguments[5]:1,o=6<arguments.length&&void 0!==arguments[6]?arguments[6]:0,l=7<arguments.length&&void 0!==arguments[7]?arguments[7]:0,c=8<arguments.length&&void 0!==arguments[8]?arguments[8]:0,u=9<arguments.length&&void 0!==arguments[9]?arguments[9]:0,h=10<arguments.length&&void 0!==arguments[10]?arguments[10]:1,f=11<arguments.length&&void 0!==arguments[11]?arguments[11]:0,d=12<arguments.length&&void 0!==arguments[12]?arguments[12]:0,p=13<arguments.length&&void 0!==arguments[13]?arguments[13]:0,_=14<arguments.length&&void 0!==arguments[14]?arguments[14]:0,v=15<arguments.length&&void 0!==arguments[15]?arguments[15]:1;return y(this,m),(e=x(this,g(m).call(this))).m00=void 0,e.m01=void 0,e.m02=void 0,e.m03=void 0,e.m04=void 0,e.m05=void 0,e.m06=void 0,e.m07=void 0,e.m08=void 0,e.m09=void 0,e.m10=void 0,e.m11=void 0,e.m12=void 0,e.m13=void 0,e.m14=void 0,e.m15=void 0,"object"===de(t)?(e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e.m00=t.m00):(e.m01=i,e.m02=n,e.m03=r,e.m04=a,e.m05=s,e.m06=o,e.m07=l,e.m08=c,e.m09=u,e.m10=h,e.m11=f,e.m12=d,e.m13=p,e.m14=_,e.m15=v,e.m00=t),e}return p(m,yt),l(m,null,[{key:"clone",value:function(e){return new m(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08,e.m09,e.m10,e.m11,e.m12,e.m13,e.m14,e.m15)}},{key:"copy",value:function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e}},{key:"set",value:function(e,t,i,n,r,a,s,o,l,c,u,h,f,d,p,_,v){return e.m00=t,e.m01=i,e.m02=n,e.m03=r,e.m04=a,e.m05=s,e.m06=o,e.m07=l,e.m08=c,e.m09=u,e.m10=h,e.m11=f,e.m12=d,e.m13=p,e.m14=_,e.m15=v,e}},{key:"identity",value:function(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"transpose",value:function(e,t){if(e===t){var i=t.m01,n=t.m02,r=t.m03,a=t.m06,s=t.m07,o=t.m11;e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=i,e.m06=t.m09,e.m07=t.m13,e.m08=n,e.m09=a,e.m11=t.m14,e.m12=r,e.m13=s,e.m14=o}else e.m00=t.m00,e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=t.m01,e.m05=t.m05,e.m06=t.m09,e.m07=t.m13,e.m08=t.m02,e.m09=t.m06,e.m10=t.m10,e.m11=t.m14,e.m12=t.m03,e.m13=t.m07,e.m14=t.m11,e.m15=t.m15;return e}},{key:"invert",value:function(e,t){yn=t.m00,gn=t.m01,bn=t.m02,xn=t.m03,Sn=t.m04,wn=t.m05,Tn=t.m06,En=t.m07,Cn=t.m08,An=t.m09,kn=t.m10,Rn=t.m11,On=t.m12,Mn=t.m13,In=t.m14,Ln=t.m15;var i=yn*wn-gn*Sn,n=yn*Tn-bn*Sn,r=yn*En-xn*Sn,a=gn*Tn-bn*wn,s=gn*En-xn*wn,o=bn*En-xn*Tn,l=Cn*Mn-An*On,c=Cn*In-kn*On,u=Cn*Ln-Rn*On,h=An*In-kn*Mn,f=An*Ln-Rn*Mn,d=kn*Ln-Rn*In,p=i*d-n*f+r*h+a*u-s*c+o*l;return 0===p||(p=1/p,e.m00=(wn*d-Tn*f+En*h)*p,e.m01=(bn*f-gn*d-xn*h)*p,e.m02=(Mn*o-In*s+Ln*a)*p,e.m03=(kn*s-An*o-Rn*a)*p,e.m04=(Tn*u-Sn*d-En*c)*p,e.m05=(yn*d-bn*u+xn*c)*p,e.m06=(In*r-On*o-Ln*n)*p,e.m07=(Cn*o-kn*r+Rn*n)*p,e.m08=(Sn*f-wn*u+En*l)*p,e.m09=(gn*u-yn*f-xn*l)*p,e.m10=(On*s-Mn*r+Ln*i)*p,e.m11=(An*r-Cn*s-Rn*i)*p,e.m12=(wn*c-Sn*h-Tn*l)*p,e.m13=(yn*h-gn*c+bn*l)*p,e.m14=(Mn*n-On*a-In*i)*p,e.m15=(Cn*a-An*n+kn*i)*p),e}},{key:"determinant",value:function(e){return yn=e.m00,gn=e.m01,bn=e.m02,xn=e.m03,Sn=e.m04,wn=e.m05,Tn=e.m06,En=e.m07,Cn=e.m08,An=e.m09,kn=e.m10,Rn=e.m11,On=e.m12,Mn=e.m13,In=e.m14,Ln=e.m15,(yn*wn-gn*Sn)*(kn*Ln-Rn*In)-(yn*Tn-bn*Sn)*(An*Ln-Rn*Mn)+(yn*En-xn*Sn)*(An*In-kn*Mn)+(gn*Tn-bn*wn)*(Cn*Ln-Rn*On)-(gn*En-xn*wn)*(Cn*In-kn*On)+(bn*En-xn*Tn)*(Cn*Mn-An*On)}},{key:"multiply",value:function(e,t,i){yn=t.m00,gn=t.m01,bn=t.m02,xn=t.m03,Sn=t.m04,wn=t.m05,Tn=t.m06,En=t.m07,Cn=t.m08,An=t.m09,kn=t.m10,Rn=t.m11,On=t.m12,Mn=t.m13,In=t.m14,Ln=t.m15;var n=i.m00,r=i.m01,a=i.m02,s=i.m03;return e.m00=n*yn+r*Sn+a*Cn+s*On,e.m01=n*gn+r*wn+a*An+s*Mn,e.m02=n*bn+r*Tn+a*kn+s*In,e.m03=n*xn+r*En+a*Rn+s*Ln,n=i.m04,r=i.m05,a=i.m06,s=i.m07,e.m04=n*yn+r*Sn+a*Cn+s*On,e.m05=n*gn+r*wn+a*An+s*Mn,e.m06=n*bn+r*Tn+a*kn+s*In,e.m07=n*xn+r*En+a*Rn+s*Ln,n=i.m08,r=i.m09,a=i.m10,s=i.m11,e.m08=n*yn+r*Sn+a*Cn+s*On,e.m09=n*gn+r*wn+a*An+s*Mn,e.m10=n*bn+r*Tn+a*kn+s*In,e.m11=n*xn+r*En+a*Rn+s*Ln,n=i.m12,r=i.m13,a=i.m14,s=i.m15,e.m12=n*yn+r*Sn+a*Cn+s*On,e.m13=n*gn+r*wn+a*An+s*Mn,e.m14=n*bn+r*Tn+a*kn+s*In,e.m15=n*xn+r*En+a*Rn+s*Ln,e}},{key:"transform",value:function(e,t,i){var n=i.x,r=i.y,a=i.z;return t===e?(e.m12=t.m00*n+t.m04*r+t.m08*a+t.m12,e.m13=t.m01*n+t.m05*r+t.m09*a+t.m13,e.m14=t.m02*n+t.m06*r+t.m10*a+t.m14,e.m15=t.m03*n+t.m07*r+t.m11*a+t.m15):(yn=t.m00,gn=t.m01,bn=t.m02,xn=t.m03,Sn=t.m04,wn=t.m05,Tn=t.m06,En=t.m07,Cn=t.m08,An=t.m09,kn=t.m10,Rn=t.m11,On=t.m12,Mn=t.m13,In=t.m14,Ln=t.m15,e.m00=yn,e.m01=gn,e.m02=bn,e.m03=xn,e.m04=Sn,e.m05=wn,e.m06=Tn,e.m07=En,e.m08=Cn,e.m09=An,e.m10=kn,e.m11=Rn,e.m12=yn*n+Sn*r+Cn*a+t.m12,e.m13=gn*n+wn*r+An*a+t.m13,e.m14=bn*n+Tn*r+kn*a+t.m14,e.m15=xn*n+En*r+Rn*a+t.m15),e}},{key:"translate",value:function(e,t,i){return console.warn("function changed"),t===e?(e.m12+=i.x,e.m13+=i.y,e.m14+=i.y):(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12+=i.x,e.m13+=i.y,e.m14+=i.z,e.m15=t.m15),e}},{key:"scale",value:function(e,t,i){var n=i.x,r=i.y,a=i.z;return e.m00=t.m00*n,e.m01=t.m01*n,e.m02=t.m02*n,e.m03=t.m03*n,e.m04=t.m04*r,e.m05=t.m05*r,e.m06=t.m06*r,e.m07=t.m07*r,e.m08=t.m08*a,e.m09=t.m09*a,e.m10=t.m10*a,e.m11=t.m11*a,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e}},{key:"rotate",value:function(e,t,i,n){var r=n.x,a=n.y,s=n.z,o=Math.sqrt(r*r+a*a+s*s);if(Math.abs(o)<hi)return null;r*=o=1/o,a*=o,s*=o;var l=Math.sin(i),c=Math.cos(i),u=1-c;yn=t.m00,gn=t.m01,bn=t.m02,xn=t.m03,Sn=t.m04,wn=t.m05,Tn=t.m06,En=t.m07,Cn=t.m08,An=t.m09,kn=t.m10,Rn=t.m11;var h=r*r*u+c,f=a*r*u+s*l,d=s*r*u-a*l,p=r*a*u-s*l,_=a*a*u+c,v=s*a*u+r*l,m=r*s*u+a*l,y=a*s*u-r*l,g=s*s*u+c;return e.m00=yn*h+Sn*f+Cn*d,e.m01=gn*h+wn*f+An*d,e.m02=bn*h+Tn*f+kn*d,e.m03=xn*h+En*f+Rn*d,e.m04=yn*p+Sn*_+Cn*v,e.m05=gn*p+wn*_+An*v,e.m06=bn*p+Tn*_+kn*v,e.m07=xn*p+En*_+Rn*v,e.m08=yn*m+Sn*y+Cn*g,e.m09=gn*m+wn*y+An*g,e.m10=bn*m+Tn*y+kn*g,e.m11=xn*m+En*y+Rn*g,t!==e&&(e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e}},{key:"rotateX",value:function(e,t,i){var n=Math.sin(i),r=Math.cos(i),a=t.m04,s=t.m05,o=t.m06,l=t.m07,c=t.m08,u=t.m09,h=t.m10,f=t.m11;return t!==e&&(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m04=a*r+c*n,e.m05=s*r+u*n,e.m06=o*r+h*n,e.m07=l*r+f*n,e.m08=c*r-a*n,e.m09=u*r-s*n,e.m10=h*r-o*n,e.m11=f*r-l*n,e}},{key:"rotateY",value:function(e,t,i){var n=Math.sin(i),r=Math.cos(i),a=t.m00,s=t.m01,o=t.m02,l=t.m03,c=t.m08,u=t.m09,h=t.m10,f=t.m11;return t!==e&&(e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=a*r-c*n,e.m01=s*r-u*n,e.m02=o*r-h*n,e.m03=l*r-f*n,e.m08=a*n+c*r,e.m09=s*n+u*r,e.m10=o*n+h*r,e.m11=l*n+f*r,e}},{key:"rotateZ",value:function(e,t,i){var n=Math.sin(i),r=Math.cos(i),a=t.m00,s=t.m01,o=t.m02,l=t.m03,c=t.m04,u=t.m05,h=t.m06,f=t.m07;return t!==e&&(e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=a*r+c*n,e.m01=s*r+u*n,e.m02=o*r+h*n,e.m03=l*r+f*n,e.m04=c*r-a*n,e.m05=u*r-s*n,e.m06=h*r-o*n,e.m07=f*r-l*n,e}},{key:"fromTranslation",value:function(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=t.x,e.m13=t.y,e.m14=t.z,e.m15=1,e}},{key:"fromScaling",value:function(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=t.y,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=t.z,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromRotation",value:function(e,t,i){var n=i.x,r=i.y,a=i.z,s=Math.sqrt(n*n+r*r+a*a);if(Math.abs(s)<hi)return null;n*=s=1/s,r*=s,a*=s;var o=Math.sin(t),l=Math.cos(t),c=1-l;return e.m00=n*n*c+l,e.m01=r*n*c+a*o,e.m02=a*n*c-r*o,e.m03=0,e.m04=n*r*c-a*o,e.m05=r*r*c+l,e.m06=a*r*c+n*o,e.m07=0,e.m08=n*a*c+r*o,e.m09=r*a*c-n*o,e.m10=a*a*c+l,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromXRotation",value:function(e,t){var i=Math.sin(t),n=Math.cos(t);return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=n,e.m06=i,e.m07=0,e.m08=0,e.m09=-i,e.m10=n,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromYRotation",value:function(e,t){var i=Math.sin(t),n=Math.cos(t);return e.m00=n,e.m01=0,e.m02=-i,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=i,e.m09=0,e.m10=n,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromZRotation",value:function(e,t){var i=Math.sin(t),n=Math.cos(t);return e.m00=n,e.m01=i,e.m02=0,e.m03=0,e.m04=-i,e.m05=n,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromRT",value:function(e,t,i){var n=t.x,r=t.y,a=t.z,s=t.w,o=n+n,l=r+r,c=a+a,u=n*o,h=n*l,f=n*c,d=r*l,p=r*c,_=a*c,v=s*o,m=s*l,y=s*c;return e.m00=1-(d+_),e.m01=h+y,e.m02=f-m,e.m03=0,e.m04=h-y,e.m05=1-(u+_),e.m06=p+v,e.m07=0,e.m08=f+m,e.m09=p-v,e.m10=1-(u+d),e.m11=0,e.m12=i.x,e.m13=i.y,e.m14=i.z,e.m15=1,e}},{key:"getTranslation",value:function(e,t){return e.x=t.m12,e.y=t.m13,e.z=t.m14,e}},{key:"getScaling",value:function(e,t){var i=Pn.m00=t.m00,n=Pn.m01=t.m01,r=Pn.m02=t.m02,a=Pn.m03=t.m04,s=Pn.m04=t.m05,o=Pn.m05=t.m06,l=Pn.m06=t.m08,c=Pn.m07=t.m09,u=Pn.m08=t.m10;return e.x=Math.sqrt(i*i+n*n+r*r),e.y=Math.sqrt(a*a+s*s+o*o),e.z=Math.sqrt(l*l+c*c+u*u),rn.determinant(Pn)<0&&(e.x*=-1),e}},{key:"getRotation",value:function(e,t){var i=t.m00+t.m05+t.m10,n=0;return 0<i?(n=2*Math.sqrt(i+1),e.w=.25*n,e.x=(t.m06-t.m09)/n,e.y=(t.m08-t.m02)/n,e.z=(t.m01-t.m04)/n):t.m00>t.m05&&t.m00>t.m10?(n=2*Math.sqrt(1+t.m00-t.m05-t.m10),e.w=(t.m06-t.m09)/n,e.x=.25*n,e.y=(t.m01+t.m04)/n,e.z=(t.m08+t.m02)/n):t.m05>t.m10?(n=2*Math.sqrt(1+t.m05-t.m00-t.m10),e.w=(t.m08-t.m02)/n,e.x=(t.m01+t.m04)/n,e.y=.25*n,e.z=(t.m06+t.m09)/n):(n=2*Math.sqrt(1+t.m10-t.m00-t.m05),e.w=(t.m01-t.m04)/n,e.x=(t.m08+t.m02)/n,e.y=(t.m06+t.m09)/n,e.z=.25*n),e}},{key:"toRTS",value:function(e,t,i,n){n.x=Fi.set(Bn,e.m00,e.m01,e.m02).length(),Pn.m00=e.m00/n.x,Pn.m01=e.m01/n.x,Pn.m02=e.m02/n.x,n.y=Fi.set(Bn,e.m04,e.m05,e.m06).length(),Pn.m03=e.m04/n.y,Pn.m04=e.m05/n.y,Pn.m05=e.m06/n.y,n.z=Fi.set(Bn,e.m08,e.m09,e.m10).length(),Pn.m06=e.m08/n.z,Pn.m07=e.m09/n.z,Pn.m08=e.m10/n.z,rn.determinant(Pn)<0&&(n.x*=-1,Pn.m00*=-1,Pn.m01*=-1,Pn.m02*=-1),hn.fromMat3(t,Pn),Fi.set(i,e.m12,e.m13,e.m14)}},{key:"fromRTS",value:function(e,t,i,n){var r=t.x,a=t.y,s=t.z,o=t.w,l=r+r,c=a+a,u=s+s,h=r*l,f=r*c,d=r*u,p=a*c,_=a*u,v=s*u,m=o*l,y=o*c,g=o*u,b=n.x,x=n.y,S=n.z;return e.m00=(1-(p+v))*b,e.m01=(f+g)*b,e.m02=(d-y)*b,e.m03=0,e.m04=(f-g)*x,e.m05=(1-(h+v))*x,e.m06=(_+m)*x,e.m07=0,e.m08=(d+y)*S,e.m09=(_-m)*S,e.m10=(1-(h+p))*S,e.m11=0,e.m12=i.x,e.m13=i.y,e.m14=i.z,e.m15=1,e}},{key:"fromRTSOrigin",value:function(e,t,i,n,r){var a=t.x,s=t.y,o=t.z,l=t.w,c=a+a,u=s+s,h=o+o,f=a*c,d=a*u,p=a*h,_=s*u,v=s*h,m=o*h,y=l*c,g=l*u,b=l*h,x=n.x,S=n.y,w=n.z,T=r.x,E=r.y,C=r.z;return e.m00=(1-(_+m))*x,e.m01=(d+b)*x,e.m02=(p-g)*x,e.m03=0,e.m04=(d-b)*S,e.m05=(1-(f+m))*S,e.m06=(v+y)*S,e.m07=0,e.m08=(p+g)*w,e.m09=(v-y)*w,e.m10=(1-(f+_))*w,e.m11=0,e.m12=i.x+T-(e.m00*T+e.m04*E+e.m08*C),e.m13=i.y+E-(e.m01*T+e.m05*E+e.m09*C),e.m14=i.z+C-(e.m02*T+e.m06*E+e.m10*C),e.m15=1,e}},{key:"fromQuat",value:function(e,t){var i=t.x,n=t.y,r=t.z,a=t.w,s=i+i,o=n+n,l=r+r,c=i*s,u=n*s,h=n*o,f=r*s,d=r*o,p=r*l,_=a*s,v=a*o,m=a*l;return e.m00=1-h-p,e.m01=u+m,e.m02=f-v,e.m03=0,e.m04=u-m,e.m05=1-c-p,e.m06=d+_,e.m07=0,e.m08=f+v,e.m09=d-_,e.m10=1-c-h,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"frustum",value:function(e,t,i,n,r,a,s){var o=1/(i-t),l=1/(r-n),c=1/(a-s);return e.m00=2*a*o,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=2*a*l,e.m06=0,e.m07=0,e.m08=(i+t)*o,e.m09=(r+n)*l,e.m10=(s+a)*c,e.m11=-1,e.m12=0,e.m13=0,e.m14=s*a*2*c,e.m15=0,e}},{key:"perspective",value:function(e,t,i,n,r){var a=1/Math.tan(t/2),s=1/(n-r);return e.m00=a/i,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=a,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=(r+n)*s,e.m11=-1,e.m12=0,e.m13=0,e.m14=2*r*n*s,e.m15=0,e}},{key:"ortho",value:function(e,t,i,n,r,a,s){var o=1/(t-i),l=1/(n-r),c=1/(a-s);return e.m00=-2*o,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=-2*l,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=2*c,e.m11=0,e.m12=(t+i)*o,e.m13=(r+n)*l,e.m14=(s+a)*c,e.m15=1,e}},{key:"lookAt",value:function(e,t,i,n){var r=t.x,a=t.y,s=t.z,o=n.x,l=n.y,c=n.z,u=r-i.x,h=a-i.y,f=s-i.z,d=1/Math.sqrt(u*u+h*h+f*f),p=l*(f*=d)-c*(h*=d),_=c*(u*=d)-o*f,v=o*h-l*u,m=h*(v*=d=1/Math.sqrt(p*p+_*_+v*v))-f*(_*=d),y=f*(p*=d)-u*v,g=u*_-h*p;return e.m00=p,e.m01=m,e.m02=u,e.m03=0,e.m04=_,e.m05=y,e.m06=h,e.m07=0,e.m08=v,e.m09=g,e.m10=f,e.m11=0,e.m12=-(p*r+_*a+v*s),e.m13=-(m*r+y*a+g*s),e.m14=-(u*r+h*a+f*s),e.m15=1,e}},{key:"inverseTranspose",value:function(e,t){yn=t.m00,gn=t.m01,bn=t.m02,xn=t.m03,Sn=t.m04,wn=t.m05,Tn=t.m06,En=t.m07,Cn=t.m08,An=t.m09,kn=t.m10,Rn=t.m11,On=t.m12,Mn=t.m13,In=t.m14,Ln=t.m15;var i=yn*wn-gn*Sn,n=yn*Tn-bn*Sn,r=yn*En-xn*Sn,a=gn*Tn-bn*wn,s=gn*En-xn*wn,o=bn*En-xn*Tn,l=Cn*Mn-An*On,c=Cn*In-kn*On,u=Cn*Ln-Rn*On,h=An*In-kn*Mn,f=An*Ln-Rn*Mn,d=kn*Ln-Rn*In,p=i*d-n*f+r*h+a*u-s*c+o*l;return p?(p=1/p,e.m00=(wn*d-Tn*f+En*h)*p,e.m01=(Tn*u-Sn*d-En*c)*p,e.m02=(Sn*f-wn*u+En*l)*p,e.m03=0,e.m04=(bn*f-gn*d-xn*h)*p,e.m05=(yn*d-bn*u+xn*c)*p,e.m06=(gn*u-yn*f-xn*l)*p,e.m07=0,e.m08=(Mn*o-In*s+Ln*a)*p,e.m09=(In*r-On*o-Ln*n)*p,e.m10=(On*s-Mn*r+Ln*i)*p,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e):null}},{key:"toArray",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:0;return e[n+0]=t.m00,e[n+1]=t.m01,e[n+2]=t.m02,e[n+3]=t.m03,e[n+4]=t.m04,e[n+5]=t.m05,e[n+6]=t.m06,e[n+7]=t.m07,e[n+8]=t.m08,e[n+9]=t.m09,e[n+10]=t.m10,e[n+11]=t.m11,e[n+12]=t.m12,e[n+13]=t.m13,e[n+14]=t.m14,e[n+15]=t.m15,e}},{key:"fromArray",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:0;return e.m00=t[n+0],e.m01=t[n+1],e.m02=t[n+2],e.m03=t[n+3],e.m04=t[n+4],e.m05=t[n+5],e.m06=t[n+6],e.m07=t[n+7],e.m08=t[n+8],e.m09=t[n+9],e.m10=t[n+10],e.m11=t[n+11],e.m12=t[n+12],e.m13=t[n+13],e.m14=t[n+14],e.m15=t[n+15],e}},{key:"add",value:function(e,t,i){return e.m00=t.m00+i.m00,e.m01=t.m01+i.m01,e.m02=t.m02+i.m02,e.m03=t.m03+i.m03,e.m04=t.m04+i.m04,e.m05=t.m05+i.m05,e.m06=t.m06+i.m06,e.m07=t.m07+i.m07,e.m08=t.m08+i.m08,e.m09=t.m09+i.m09,e.m10=t.m10+i.m10,e.m11=t.m11+i.m11,e.m12=t.m12+i.m12,e.m13=t.m13+i.m13,e.m14=t.m14+i.m14,e.m15=t.m15+i.m15,e}},{key:"subtract",value:function(e,t,i){return e.m00=t.m00-i.m00,e.m01=t.m01-i.m01,e.m02=t.m02-i.m02,e.m03=t.m03-i.m03,e.m04=t.m04-i.m04,e.m05=t.m05-i.m05,e.m06=t.m06-i.m06,e.m07=t.m07-i.m07,e.m08=t.m08-i.m08,e.m09=t.m09-i.m09,e.m10=t.m10-i.m10,e.m11=t.m11-i.m11,e.m12=t.m12-i.m12,e.m13=t.m13-i.m13,e.m14=t.m14-i.m14,e.m15=t.m15-i.m15,e}},{key:"multiplyScalar",value:function(e,t,i){return e.m00=t.m00*i,e.m01=t.m01*i,e.m02=t.m02*i,e.m03=t.m03*i,e.m04=t.m04*i,e.m05=t.m05*i,e.m06=t.m06*i,e.m07=t.m07*i,e.m08=t.m08*i,e.m09=t.m09*i,e.m10=t.m10*i,e.m11=t.m11*i,e.m12=t.m12*i,e.m13=t.m13*i,e.m14=t.m14*i,e.m15=t.m15*i,e}},{key:"multiplyScalarAndAdd",value:function(e,t,i,n){return e.m00=t.m00+i.m00*n,e.m01=t.m01+i.m01*n,e.m02=t.m02+i.m02*n,e.m03=t.m03+i.m03*n,e.m04=t.m04+i.m04*n,e.m05=t.m05+i.m05*n,e.m06=t.m06+i.m06*n,e.m07=t.m07+i.m07*n,e.m08=t.m08+i.m08*n,e.m09=t.m09+i.m09*n,e.m10=t.m10+i.m10*n,e.m11=t.m11+i.m11*n,e.m12=t.m12+i.m12*n,e.m13=t.m13+i.m13*n,e.m14=t.m14+i.m14*n,e.m15=t.m15+i.m15*n,e}},{key:"strictEquals",value:function(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08&&e.m09===t.m09&&e.m10===t.m10&&e.m11===t.m11&&e.m12===t.m12&&e.m13===t.m13&&e.m14===t.m14&&e.m15===t.m15}},{key:"equals",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:hi;return Math.abs(e.m00-t.m00)<=n*Math.max(1,Math.abs(e.m00),Math.abs(t.m00))&&Math.abs(e.m01-t.m01)<=n*Math.max(1,Math.abs(e.m01),Math.abs(t.m01))&&Math.abs(e.m02-t.m02)<=n*Math.max(1,Math.abs(e.m02),Math.abs(t.m02))&&Math.abs(e.m03-t.m03)<=n*Math.max(1,Math.abs(e.m03),Math.abs(t.m03))&&Math.abs(e.m04-t.m04)<=n*Math.max(1,Math.abs(e.m04),Math.abs(t.m04))&&Math.abs(e.m05-t.m05)<=n*Math.max(1,Math.abs(e.m05),Math.abs(t.m05))&&Math.abs(e.m06-t.m06)<=n*Math.max(1,Math.abs(e.m06),Math.abs(t.m06))&&Math.abs(e.m07-t.m07)<=n*Math.max(1,Math.abs(e.m07),Math.abs(t.m07))&&Math.abs(e.m08-t.m08)<=n*Math.max(1,Math.abs(e.m08),Math.abs(t.m08))&&Math.abs(e.m09-t.m09)<=n*Math.max(1,Math.abs(e.m09),Math.abs(t.m09))&&Math.abs(e.m10-t.m10)<=n*Math.max(1,Math.abs(e.m10),Math.abs(t.m10))&&Math.abs(e.m11-t.m11)<=n*Math.max(1,Math.abs(e.m11),Math.abs(t.m11))&&Math.abs(e.m12-t.m12)<=n*Math.max(1,Math.abs(e.m12),Math.abs(t.m12))&&Math.abs(e.m13-t.m13)<=n*Math.max(1,Math.abs(e.m13),Math.abs(t.m13))&&Math.abs(e.m14-t.m14)<=n*Math.max(1,Math.abs(e.m14),Math.abs(t.m14))&&Math.abs(e.m15-t.m15)<=n*Math.max(1,Math.abs(e.m15),Math.abs(t.m15))}}]),l(m,[{key:"clone",value:function(){var e=this;return new m(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08,e.m09,e.m10,e.m11,e.m12,e.m13,e.m14,e.m15)}},{key:"set",value:function(e,t,i,n,r,a,s,o,l,c,u,h,f,d,p,_){var v=0<arguments.length&&void 0!==e?e:1,m=1<arguments.length&&void 0!==t?t:0,y=2<arguments.length&&void 0!==i?i:0,g=3<arguments.length&&void 0!==n?n:0,b=4<arguments.length&&void 0!==r?r:0,x=5<arguments.length&&void 0!==a?a:1,S=6<arguments.length&&void 0!==s?s:0,w=7<arguments.length&&void 0!==o?o:0,T=8<arguments.length&&void 0!==l?l:0,E=9<arguments.length&&void 0!==c?c:0,C=10<arguments.length&&void 0!==u?u:1,A=11<arguments.length&&void 0!==h?h:0,k=12<arguments.length&&void 0!==f?f:0,R=13<arguments.length&&void 0!==d?d:0,O=14<arguments.length&&void 0!==p?p:0,M=15<arguments.length&&void 0!==_?_:1;return"object"===de(v)?(this.m01=v.m01,this.m02=v.m02,this.m03=v.m03,this.m04=v.m04,this.m05=v.m05,this.m06=v.m06,this.m07=v.m07,this.m08=v.m08,this.m09=v.m09,this.m10=v.m10,this.m11=v.m11,this.m12=v.m12,this.m13=v.m13,this.m14=v.m14,this.m15=v.m15,this.m00=v.m00):(this.m01=m,this.m02=y,this.m03=g,this.m04=b,this.m05=x,this.m06=S,this.m07=w,this.m08=T,this.m09=E,this.m10=C,this.m11=A,this.m12=k,this.m13=R,this.m14=O,this.m15=M,this.m00=v),this}},{key:"equals",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:hi;return Math.abs(this.m00-e.m00)<=i*Math.max(1,Math.abs(this.m00),Math.abs(e.m00))&&Math.abs(this.m01-e.m01)<=i*Math.max(1,Math.abs(this.m01),Math.abs(e.m01))&&Math.abs(this.m02-e.m02)<=i*Math.max(1,Math.abs(this.m02),Math.abs(e.m02))&&Math.abs(this.m03-e.m03)<=i*Math.max(1,Math.abs(this.m03),Math.abs(e.m03))&&Math.abs(this.m04-e.m04)<=i*Math.max(1,Math.abs(this.m04),Math.abs(e.m04))&&Math.abs(this.m05-e.m05)<=i*Math.max(1,Math.abs(this.m05),Math.abs(e.m05))&&Math.abs(this.m06-e.m06)<=i*Math.max(1,Math.abs(this.m06),Math.abs(e.m06))&&Math.abs(this.m07-e.m07)<=i*Math.max(1,Math.abs(this.m07),Math.abs(e.m07))&&Math.abs(this.m08-e.m08)<=i*Math.max(1,Math.abs(this.m08),Math.abs(e.m08))&&Math.abs(this.m09-e.m09)<=i*Math.max(1,Math.abs(this.m09),Math.abs(e.m09))&&Math.abs(this.m10-e.m10)<=i*Math.max(1,Math.abs(this.m10),Math.abs(e.m10))&&Math.abs(this.m11-e.m11)<=i*Math.max(1,Math.abs(this.m11),Math.abs(e.m11))&&Math.abs(this.m12-e.m12)<=i*Math.max(1,Math.abs(this.m12),Math.abs(e.m12))&&Math.abs(this.m13-e.m13)<=i*Math.max(1,Math.abs(this.m13),Math.abs(e.m13))&&Math.abs(this.m14-e.m14)<=i*Math.max(1,Math.abs(this.m14),Math.abs(e.m14))&&Math.abs(this.m15-e.m15)<=i*Math.max(1,Math.abs(this.m15),Math.abs(e.m15))}},{key:"strictEquals",value:function(e){return this.m00===e.m00&&this.m01===e.m01&&this.m02===e.m02&&this.m03===e.m03&&this.m04===e.m04&&this.m05===e.m05&&this.m06===e.m06&&this.m07===e.m07&&this.m08===e.m08&&this.m09===e.m09&&this.m10===e.m10&&this.m11===e.m11&&this.m12===e.m12&&this.m13===e.m13&&this.m14===e.m14&&this.m15===e.m15}},{key:"toString",value:function(){return"[\n"+this.m00+", "+this.m01+", "+this.m02+", "+this.m03+",\n"+this.m04+", "+this.m05+", "+this.m06+", "+this.m07+",\n"+this.m08+", "+this.m09+", "+this.m10+", "+this.m11+",\n"+this.m12+", "+this.m13+", "+this.m14+", "+this.m15+"\n]"}},{key:"identity",value:function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=1,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=1,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this}},{key:"transpose",value:function(){var e=this.m01,t=this.m02,i=this.m03,n=this.m06,r=this.m07,a=this.m11;return this.m01=this.m04,this.m02=this.m08,this.m03=this.m12,this.m04=e,this.m06=this.m09,this.m07=this.m13,this.m08=t,this.m09=n,this.m11=this.m14,this.m12=i,this.m13=r,this.m14=a,this}},{key:"invert",value:function(){yn=this.m00,gn=this.m01,bn=this.m02,xn=this.m03,Sn=this.m04,wn=this.m05,Tn=this.m06,En=this.m07,Cn=this.m08,An=this.m09,kn=this.m10,Rn=this.m11,On=this.m12,Mn=this.m13,In=this.m14,Ln=this.m15;var e=yn*wn-gn*Sn,t=yn*Tn-bn*Sn,i=yn*En-xn*Sn,n=gn*Tn-bn*wn,r=gn*En-xn*wn,a=bn*En-xn*Tn,s=Cn*Mn-An*On,o=Cn*In-kn*On,l=Cn*Ln-Rn*On,c=An*In-kn*Mn,u=An*Ln-Rn*Mn,h=kn*Ln-Rn*In,f=e*h-t*u+i*c+n*l-r*o+a*s;return 0===f?null:(f=1/f,this.m00=(wn*h-Tn*u+En*c)*f,this.m01=(bn*u-gn*h-xn*c)*f,this.m02=(Mn*a-In*r+Ln*n)*f,this.m03=(kn*r-An*a-Rn*n)*f,this.m04=(Tn*l-Sn*h-En*o)*f,this.m05=(yn*h-bn*l+xn*o)*f,this.m06=(In*i-On*a-Ln*t)*f,this.m07=(Cn*a-kn*i+Rn*t)*f,this.m08=(Sn*u-wn*l+En*s)*f,this.m09=(gn*l-yn*u-xn*s)*f,this.m10=(On*r-Mn*i+Ln*e)*f,this.m11=(An*i-Cn*r-Rn*e)*f,this.m12=(wn*o-Sn*c-Tn*s)*f,this.m13=(yn*c-gn*o+bn*s)*f,this.m14=(Mn*t-On*n-In*e)*f,this.m15=(Cn*n-An*t+kn*e)*f,this)}},{key:"determinant",value:function(){return yn=this.m00,gn=this.m01,bn=this.m02,xn=this.m03,Sn=this.m04,wn=this.m05,Tn=this.m06,En=this.m07,Cn=this.m08,An=this.m09,kn=this.m10,Rn=this.m11,On=this.m12,Mn=this.m13,In=this.m14,Ln=this.m15,(yn*wn-gn*Sn)*(kn*Ln-Rn*In)-(yn*Tn-bn*Sn)*(An*Ln-Rn*Mn)+(yn*En-xn*Sn)*(An*In-kn*Mn)+(gn*Tn-bn*wn)*(Cn*Ln-Rn*On)-(gn*En-xn*wn)*(Cn*In-kn*On)+(bn*En-xn*Tn)*(Cn*Mn-An*On)}},{key:"add",value:function(e){return this.m00=this.m00+e.m00,this.m01=this.m01+e.m01,this.m02=this.m02+e.m02,this.m03=this.m03+e.m03,this.m04=this.m04+e.m04,this.m05=this.m05+e.m05,this.m06=this.m06+e.m06,this.m07=this.m07+e.m07,this.m08=this.m08+e.m08,this.m09=this.m09+e.m09,this.m10=this.m10+e.m10,this.m11=this.m11+e.m11,this.m12=this.m12+e.m12,this.m13=this.m13+e.m13,this.m14=this.m14+e.m14,this.m15=this.m15+e.m15,this}},{key:"subtract",value:function(e){return this.m00=this.m00-e.m00,this.m01=this.m01-e.m01,this.m02=this.m02-e.m02,this.m03=this.m03-e.m03,this.m04=this.m04-e.m04,this.m05=this.m05-e.m05,this.m06=this.m06-e.m06,this.m07=this.m07-e.m07,this.m08=this.m08-e.m08,this.m09=this.m09-e.m09,this.m10=this.m10-e.m10,this.m11=this.m11-e.m11,this.m12=this.m12-e.m12,this.m13=this.m13-e.m13,this.m14=this.m14-e.m14,this.m15=this.m15-e.m15,this}},{key:"multiply",value:function(e){yn=this.m00,gn=this.m01,bn=this.m02,xn=this.m03,Sn=this.m04,wn=this.m05,Tn=this.m06,En=this.m07,Cn=this.m08,An=this.m09,kn=this.m10,Rn=this.m11,On=this.m12,Mn=this.m13,In=this.m14,Ln=this.m15;var t=e.m00,i=e.m01,n=e.m02,r=e.m03;return this.m00=t*yn+i*Sn+n*Cn+r*On,this.m01=t*gn+i*wn+n*An+r*Mn,this.m02=t*bn+i*Tn+n*kn+r*In,this.m03=t*xn+i*En+n*Rn+r*Ln,t=e.m04,i=e.m05,n=e.m06,r=e.m07,this.m04=t*yn+i*Sn+n*Cn+r*On,this.m05=t*gn+i*wn+n*An+r*Mn,this.m06=t*bn+i*Tn+n*kn+r*In,this.m07=t*xn+i*En+n*Rn+r*Ln,t=e.m08,i=e.m09,n=e.m10,r=e.m11,this.m08=t*yn+i*Sn+n*Cn+r*On,this.m09=t*gn+i*wn+n*An+r*Mn,this.m10=t*bn+i*Tn+n*kn+r*In,this.m11=t*xn+i*En+n*Rn+r*Ln,t=e.m12,i=e.m13,n=e.m14,r=e.m15,this.m12=t*yn+i*Sn+n*Cn+r*On,this.m13=t*gn+i*wn+n*An+r*Mn,this.m14=t*bn+i*Tn+n*kn+r*In,this.m15=t*xn+i*En+n*Rn+r*Ln,this}},{key:"multiplyScalar",value:function(e){return this.m00=this.m00*e,this.m01=this.m01*e,this.m02=this.m02*e,this.m03=this.m03*e,this.m04=this.m04*e,this.m05=this.m05*e,this.m06=this.m06*e,this.m07=this.m07*e,this.m08=this.m08*e,this.m09=this.m09*e,this.m10=this.m10*e,this.m11=this.m11*e,this.m12=this.m12*e,this.m13=this.m13*e,this.m14=this.m14*e,this.m15=this.m15*e,this}},{key:"translate",value:function(e){return console.warn("function changed"),this.m12+=e.x,this.m13+=e.y,this.m14+=e.y,this}},{key:"scale",value:function(e){var t=e.x,i=e.y,n=e.z;return this.m00=this.m00*t,this.m01=this.m01*t,this.m02=this.m02*t,this.m03=this.m03*t,this.m04=this.m04*i,this.m05=this.m05*i,this.m06=this.m06*i,this.m07=this.m07*i,this.m08=this.m08*n,this.m09=this.m09*n,this.m10=this.m10*n,this.m11=this.m11*n,this.m12=this.m12,this.m13=this.m13,this.m14=this.m14,this.m15=this.m15,this}},{key:"rotate",value:function(e,t){var i=t.x,n=t.y,r=t.z,a=Math.sqrt(i*i+n*n+r*r);if(Math.abs(a)<hi)return null;i*=a=1/a,n*=a,r*=a;var s=Math.sin(e),o=Math.cos(e),l=1-o;yn=this.m00,gn=this.m01,bn=this.m02,xn=this.m03,Sn=this.m04,wn=this.m05,Tn=this.m06,En=this.m07,Cn=this.m08,An=this.m09,kn=this.m10,Rn=this.m11;var c=i*i*l+o,u=n*i*l+r*s,h=r*i*l-n*s,f=i*n*l-r*s,d=n*n*l+o,p=r*n*l+i*s,_=i*r*l+n*s,v=n*r*l-i*s,m=r*r*l+o;return this.m00=yn*c+Sn*u+Cn*h,this.m01=gn*c+wn*u+An*h,this.m02=bn*c+Tn*u+kn*h,this.m03=xn*c+En*u+Rn*h,this.m04=yn*f+Sn*d+Cn*p,this.m05=gn*f+wn*d+An*p,this.m06=bn*f+Tn*d+kn*p,this.m07=xn*f+En*d+Rn*p,this.m08=yn*_+Sn*v+Cn*m,this.m09=gn*_+wn*v+An*m,this.m10=bn*_+Tn*v+kn*m,this.m11=xn*_+En*v+Rn*m,this}},{key:"getTranslation",value:function(e){return e.x=this.m12,e.y=this.m13,e.z=this.m14,e}},{key:"getScale",value:function(e){var t=Pn.m00=this.m00,i=Pn.m01=this.m01,n=Pn.m02=this.m02,r=Pn.m03=this.m04,a=Pn.m04=this.m05,s=Pn.m05=this.m06,o=Pn.m06=this.m08,l=Pn.m07=this.m09,c=Pn.m08=this.m10;return e.x=Math.sqrt(t*t+i*i+n*n),e.y=Math.sqrt(r*r+a*a+s*s),e.z=Math.sqrt(o*o+l*l+c*c),rn.determinant(Pn)<0&&(e.x*=-1),e}},{key:"getRotation",value:function(e){var t=this.m00+this.m05+this.m10,i=0;return 0<t?(i=2*Math.sqrt(t+1),e.w=.25*i,e.x=(this.m06-this.m09)/i,e.y=(this.m08-this.m02)/i,e.z=(this.m01-this.m04)/i):this.m00>this.m05&&this.m00>this.m10?(i=2*Math.sqrt(1+this.m00-this.m05-this.m10),e.w=(this.m06-this.m09)/i,e.x=.25*i,e.y=(this.m01+this.m04)/i,e.z=(this.m08+this.m02)/i):this.m05>this.m10?(i=2*Math.sqrt(1+this.m05-this.m00-this.m10),e.w=(this.m08-this.m02)/i,e.x=(this.m01+this.m04)/i,e.y=.25*i,e.z=(this.m06+this.m09)/i):(i=2*Math.sqrt(1+this.m10-this.m00-this.m05),e.w=(this.m01-this.m04)/i,e.x=(this.m08+this.m02)/i,e.y=(this.m06+this.m09)/i,e.z=.25*i),e}},{key:"fromRTS",value:function(e,t,i){var n=e.x,r=e.y,a=e.z,s=e.w,o=n+n,l=r+r,c=a+a,u=n*o,h=n*l,f=n*c,d=r*l,p=r*c,_=a*c,v=s*o,m=s*l,y=s*c,g=i.x,b=i.y,x=i.z;return this.m00=(1-(d+_))*g,this.m01=(h+y)*g,this.m02=(f-m)*g,this.m03=0,this.m04=(h-y)*b,this.m05=(1-(u+_))*b,this.m06=(p+v)*b,this.m07=0,this.m08=(f+m)*x,this.m09=(p-v)*x,this.m10=(1-(u+d))*x,this.m11=0,this.m12=t.x,this.m13=t.y,this.m14=t.z,this.m15=1,this}},{key:"fromQuat",value:function(e){var t=e.x,i=e.y,n=e.z,r=e.w,a=t+t,s=i+i,o=n+n,l=t*a,c=i*a,u=i*s,h=n*a,f=n*s,d=n*o,p=r*a,_=r*s,v=r*o;return this.m00=1-u-d,this.m01=c+v,this.m02=h-_,this.m03=0,this.m04=c-v,this.m05=1-l-d,this.m06=f+p,this.m07=0,this.m08=h+_,this.m09=f-p,this.m10=1-l-u,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this}}]),m}());zn.IDENTITY=Object.freeze(new zn);var Bn=new Fi,Pn=new rn;function Dn(e,t,i,n,r,a,s,o,l,c,u,h,f,d,p,_){return new zn(e,t,i,n,r,a,s,o,l,c,u,h,f,d,p,_)}ai.fastDefine("cc.Mat4",zn,{m00:1,m01:0,m02:0,m03:0,m04:0,m05:1,m06:0,m07:0,m08:0,m09:0,m10:1,m11:0,m12:0,m13:0,m14:0,m15:1}),cc.Mat4=zn,cc.mat4=Dn;var Fn=0,Nn=0,Un=0,Vn=0,Gn=0,Hn=0,qn=P2("AffineTransform",function(){function s(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:1,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:1,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:0;y(this,s),this.a=void 0,this.b=void 0,this.c=void 0,this.d=void 0,this.tx=void 0,this.ty=void 0,this.a=e,this.b=t,this.c=i,this.d=n,this.tx=r,this.ty=a}return l(s,null,[{key:"identity",value:function(){return new s}},{key:"clone",value:function(e){return new s(e.a,e.b,e.c,e.d,e.tx,e.ty)}},{key:"concat",value:function(e,t,i){Fn=t.a,Nn=t.b,Un=t.c,Vn=t.d,Gn=t.tx,Hn=t.ty,e.a=Fn*i.a+Nn*i.c,e.b=Fn*i.b+Nn*i.d,e.c=Un*i.a+Vn*i.c,e.d=Un*i.b+Vn*i.d,e.tx=Gn*i.a+Hn*i.c+i.tx,e.ty=Gn*i.b+Hn*i.d+i.ty}},{key:"invert",value:function(e,t){var i=1/(t.a*t.d-t.b*t.c);e.a=i*t.d,e.b=-i*t.b,e.c=-i*t.c,e.d=i*t.a,e.tx=i*(t.c*t.ty-t.d*t.tx),e.ty=i*(t.b*t.tx-t.a*t.ty)}},{key:"fromMat4",value:function(e,t){e.a=t.m00,e.b=t.m01,e.c=t.m04,e.d=t.m05,e.tx=t.m12,e.ty=t.m13}},{key:"transformVec2",value:function(e,t,i,n){var r,a;a=void 0===n?(n=i,r=t.x,t.y):(r=t,i),e.x=n.a*r+n.c*a+n.tx,e.y=n.b*r+n.d*a+n.ty}},{key:"transformSize",value:function(e,t,i){e.width=i.a*t.width+i.c*t.height,e.height=i.b*t.width+i.d*t.height}},{key:"transformRect",value:function(e,t,i){var n=t.x+t.width,r=t.y+t.height,a=i.a*t.x+i.c*t.y+i.tx,s=i.b*t.x+i.d*t.y+i.ty,o=i.a*n+i.c*t.y+i.tx,l=i.b*n+i.d*t.y+i.ty,c=i.a*t.x+i.c*r+i.tx,u=i.b*t.x+i.d*r+i.ty,h=i.a*n+i.c*r+i.tx,f=i.b*n+i.d*r+i.ty,d=Math.min(a,o,c,h),p=Math.max(a,o,c,h),_=Math.min(s,l,u,f),v=Math.max(s,l,u,f);e.x=d,e.y=_,e.width=p-d,e.height=v-_}},{key:"transformObb",value:function(e,t,i,n,r,a){var s=a.a*r.x+a.c*r.y+a.tx,o=a.b*r.x+a.d*r.y+a.ty,l=a.a*r.width,c=a.b*r.width,u=a.c*r.height,h=a.d*r.height;t.x=s,t.y=o,i.x=l+s,i.y=c+o,e.x=u+s,e.y=h+o,n.x=l+u+s,n.y=c+h+o}}]),s}());cc.AffineTransform=qn;var jn=P2("Size",function(){function n(e,t){var i;return y(this,n),(i=x(this,g(n).call(this))).width=void 0,i.height=void 0,e&&"object"===de(e)?(i.height=e.height,i.width=e.width):(i.width=e||0,i.height=t||0),i}return p(n,yt),l(n,[{key:"x",set:function(e){this.width=e},get:function(){return this.width}},{key:"y",set:function(e){this.height=e},get:function(){return this.height}}],[{key:"lerp",value:function(e,t,i,n){return e.width=t.width+(i.width-t.width)*n,e.height=t.height+(i.height-t.height)*n,e}},{key:"ZERO",get:function(){return new n(0,0)}}]),l(n,[{key:"clone",value:function(){return new n(this.width,this.height)}},{key:"set",value:function(e,t){return e&&"object"===de(e)?(this.height=e.height,this.width=e.width):(this.width=e||0,this.height=t||0),this}},{key:"equals",value:function(e){return this.width===e.width&&this.height===e.height}},{key:"lerp",value:function(e,t){return this.width=this.width+(e.width-this.width)*t,this.height=this.height+(e.height-this.height)*t,this}},{key:"toString",value:function(){return"(".concat(this.width.toFixed(2),", ").concat(this.height.toFixed(2),")")}}]),n}());function Wn(){return new jn(0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,1<arguments.length&&void 0!==arguments[1]?arguments[1]:0)}ai.fastDefine("cc.Size",jn,{width:0,height:0}),cc.size=Wn,cc.Size=jn;var Xn=0,Yn=0,Qn=0,Kn=0,Zn=P2("Rect",function(){function a(e,t,i,n){var r;return y(this,a),(r=x(this,g(a).call(this))).x=void 0,r.y=void 0,r.width=void 0,r.height=void 0,e&&"object"===de(e)?(r.y=e.y,r.width=e.width,r.height=e.height,r.x=e.x):(r.x=e||0,r.y=t||0,r.width=i||0,r.height=n||0),r}return p(a,yt),l(a,[{key:"xMin",get:function(){return this.x},set:function(e){this.width+=this.x-e,this.x=e}},{key:"yMin",get:function(){return this.y},set:function(e){this.height+=this.y-e,this.y=e}},{key:"xMax",get:function(){return this.x+this.width},set:function(e){this.width=e-this.x}},{key:"yMax",get:function(){return this.y+this.height},set:function(e){this.height=e-this.y}},{key:"center",get:function(){return new Mi(this.x+.5*this.width,this.y+.5*this.height)},set:function(e){this.x=e.x-.5*this.width,this.y=e.y-.5*this.height}},{key:"origin",get:function(){return new cc.Vec2(this.x,this.y)},set:function(e){this.x=e.x,this.y=e.y}},{key:"size",get:function(){return new jn(this.width,this.height)},set:function(e){this.width=e.width,this.height=e.height}},{key:"z",set:function(e){this.width=e},get:function(){return this.width}},{key:"w",set:function(e){this.height=e},get:function(){return this.height}}],[{key:"fromMinMax",value:function(e,t,i){var n=Math.min(t.x,i.x),r=Math.min(t.y,i.y),a=Math.max(t.x,i.x),s=Math.max(t.y,i.y);return e.x=n,e.y=r,e.width=a-n,e.height=s-r,e}},{key:"lerp",value:function(e,t,i,n){return Xn=t.x,Yn=t.y,Qn=t.width,Kn=t.height,e.x=Xn+(i.x-Xn)*n,e.y=Yn+(i.y-Yn)*n,e.width=Qn+(i.width-Qn)*n,e.height=Kn+(i.height-Kn)*n,e}},{key:"intersection",value:function(e,t,i){var n=t.x,r=t.y,a=t.x+t.width,s=t.y+t.height,o=i.x,l=i.y,c=i.x+i.width,u=i.y+i.height;return e.x=Math.max(n,o),e.y=Math.max(r,l),e.width=Math.min(a,c)-e.x,e.height=Math.min(s,u)-e.y,e}},{key:"union",value:function(e,t,i){Xn=t.x,Yn=t.y,Qn=t.width,Kn=t.height;var n=i.x,r=i.y,a=i.width,s=i.height;return e.x=Math.min(Xn,n),e.y=Math.min(Yn,r),e.width=Math.max(Xn+Qn,n+a)-e.x,e.height=Math.max(Yn+Kn,r+s)-e.y,e}}]),l(a,[{key:"clone",value:function(){return new a(this.x,this.y,this.width,this.height)}},{key:"set",value:function(e,t,i,n){return e&&"object"===de(e)?(this.y=e.y,this.width=e.width,this.height=e.height,this.x=e.x):(this.x=e||0,this.y=t||0,this.width=i||0,this.height=n||0),this}},{key:"equals",value:function(e){return this.x===e.x&&this.y===e.y&&this.width===e.width&&this.height===e.height}},{key:"lerp",value:function(e,t){return Xn=this.x,Yn=this.y,Qn=this.width,Kn=this.height,this.x=Xn+(e.x-Xn)*t,this.y=Yn+(e.y-Yn)*t,this.width=Qn+(e.width-Qn)*t,this.height=Kn+(e.height-Kn)*t,this}},{key:"toString",value:function(){return"(".concat(this.x.toFixed(2),", ").concat(this.y.toFixed(2),", ").concat(this.width.toFixed(2),", ").concat(this.height.toFixed(2),")")}},{key:"intersects",value:function(e){var t=this.x+this.width,i=this.y+this.height,n=e.x+e.width,r=e.y+e.height;return!(t<e.x||n<this.x||i<e.y||r<this.y)}},{key:"contains",value:function(e){return this.x<=e.x&&this.x+this.width>=e.x&&this.y<=e.y&&this.y+this.height>=e.y}},{key:"containsRect",value:function(e){return this.x<=e.x&&this.x+this.width>=e.x+e.width&&this.y<=e.y&&this.y+this.height>=e.y+e.height}},{key:"transformMat4",value:function(e){var t=this.x,i=this.y,n=t+this.width,r=i+this.height,a=e.m00*t+e.m04*i+e.m12,s=e.m01*t+e.m05*i+e.m13,o=e.m00*n+e.m04*i+e.m12,l=e.m01*n+e.m05*i+e.m13,c=e.m00*t+e.m04*r+e.m12,u=e.m01*t+e.m05*r+e.m13,h=e.m00*n+e.m04*r+e.m12,f=e.m01*n+e.m05*r+e.m13,d=Math.min(a,o,c,h),p=Math.max(a,o,c,h),_=Math.min(s,l,u,f),v=Math.max(s,l,u,f);return this.x=d,this.y=_,this.width=p-d,this.height=v-_,this}}]),a}());function Jn(){return new Zn(0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,3<arguments.length&&void 0!==arguments[3]?arguments[3]:0)}ai.fastDefine("cc.Rect",Zn,{x:0,y:0,width:0,height:0}),cc.Rect=Zn,cc.rect=Jn;var $n=1/255,er=0,tr=0,ir=0,nr=0,rr=P2("Color",function(){function a(e,t,i,n){var r;return y(this,a),(r=x(this,g(a).call(this)))._val=0,"string"==typeof e?r.fromHEX(e):("object"===de(e)&&(t=e.g,i=e.b,n=e.a,e=e.r),e=e||0,t=t||0,i=i||0,n="number"==typeof n?n:255,r._val=(n<<24>>>0)+(i<<16)+(t<<8)+e),r}return p(a,yt),l(a,[{key:"r",get:function(){return 255&this._val},set:function(e){e=~~pi(e,0,255),this._val=(4294967040&this._val|e)>>>0}},{key:"g",get:function(){return(65280&this._val)>>8},set:function(e){e=~~pi(e,0,255),this._val=(4294902015&this._val|e<<8)>>>0}},{key:"b",get:function(){return(16711680&this._val)>>16},set:function(e){e=~~pi(e,0,255),this._val=(4278255615&this._val|e<<16)>>>0}},{key:"a",get:function(){return(4278190080&this._val)>>>24},set:function(e){e=~~pi(e,0,255),this._val=(16777215&this._val|e<<24>>>0)>>>0}},{key:"x",get:function(){return this.r*$n},set:function(e){this.r=255*e}},{key:"y",get:function(){return this.g*$n},set:function(e){this.g=255*e}},{key:"z",get:function(){return this.b*$n},set:function(e){this.b=255*e}},{key:"w",get:function(){return this.a*$n},set:function(e){this.a=255*e}}],[{key:"clone",value:function(e){var t=new a;return e._val?t._val=e._val:t._val=(e.a<<24>>>0)+(e.b<<16)+(e.g<<8)+e.r,t}},{key:"copy",value:function(e,t){return e.r=t.r,e.g=t.g,e.b=t.b,e.a=t.a,e}},{key:"set",value:function(e,t,i,n,r){return e.r=t,e.g=i,e.b=n,e.a=r,e}},{key:"fromHex",value:function(e,t){return e.r=(t>>24)/255,e.g=(t>>16&255)/255,e.b=(t>>8&255)/255,e.a=(255&t)/255,e}},{key:"add",value:function(e,t,i){return e.r=t.r+i.r,e.g=t.g+i.g,e.b=t.b+i.b,e.a=t.a+i.a,e}},{key:"subtract",value:function(e,t,i){return e.r=t.r-i.r,e.g=t.g-i.g,e.b=t.b-i.b,e.a=t.a-i.a,e}},{key:"multiply",value:function(e,t,i){return e.r=t.r*i.r,e.g=t.g*i.g,e.b=t.b*i.b,e.a=t.a*i.a,e}},{key:"divide",value:function(e,t,i){return e.r=t.r/i.r,e.g=t.g/i.g,e.b=t.b/i.b,e.a=t.a/i.a,e}},{key:"scale",value:function(e,t,i){return e.r=t.r*i,e.g=t.g*i,e.b=t.b*i,e.a=t.a*i,e}},{key:"lerp",value:function(e,t,i,n){return er=t.r,tr=t.g,ir=t.b,nr=t.a,er+=(i.r-er)*n,tr+=(i.g-tr)*n,ir+=(i.b-ir)*n,nr+=(i.a-nr)*n,e._val=Math.floor((nr<<24>>>0)+(ir<<16)+(tr<<8)+er),e}},{key:"toArray",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:0,r=t instanceof a||1<t.a?1/255:1;return e[n+0]=t.r*r,e[n+1]=t.g*r,e[n+2]=t.b*r,e[n+3]=t.a*r,e}},{key:"fromArray",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:0;return t.r=255*e[n+0],t.g=255*e[n+1],t.b=255*e[n+2],t.a=255*e[n+3],t}},{key:"strictEquals",value:function(e,t){return e.r===t.r&&e.g===t.g&&e.b===t.b&&e.a===t.a}},{key:"equals",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:hi;return Math.abs(e.r-t.r)<=n*Math.max(1,Math.abs(e.r),Math.abs(t.r))&&Math.abs(e.g-t.g)<=n*Math.max(1,Math.abs(e.g),Math.abs(t.g))&&Math.abs(e.b-t.b)<=n*Math.max(1,Math.abs(e.b),Math.abs(t.b))&&Math.abs(e.a-t.a)<=n*Math.max(1,Math.abs(e.a),Math.abs(t.a))}},{key:"hex",value:function(e){return(255*e.r<<24|255*e.g<<16|255*e.b<<8|255*e.a)>>>0}}]),l(a,[{key:"clone",value:function(){var e=new a;return e._val=this._val,e}},{key:"equals",value:function(e){return e&&this._val===e._val}},{key:"lerp",value:function(e,t){return er=this.r,tr=this.g,ir=this.b,nr=this.a,er+=(e.r-er)*t,tr+=(e.g-tr)*t,ir+=(e.b-ir)*t,nr+=(e.a-nr)*t,this._val=Math.floor((nr<<24>>>0)+(ir<<16)+(tr<<8)+er),this}},{key:"toString",value:function(){return"rgba("+this.r.toFixed()+", "+this.g.toFixed()+", "+this.b.toFixed()+", "+this.a.toFixed()+")"}},{key:"toCSS",value:function(e){return"rgba"===e?"rgba("+(0|this.r)+","+(0|this.g)+","+(0|this.b)+","+(this.a*$n).toFixed(2)+")":"rgb"===e?"rgb("+(0|this.r)+","+(0|this.g)+","+(0|this.b)+")":"#"+this.toHEX(e)}},{key:"fromHEX",value:function(e){return e=0===e.indexOf("#")?e.substring(1):e,er=parseInt(e.substr(0,2),16)||0,tr=parseInt(e.substr(2,2),16)||0,ir=parseInt(e.substr(4,2),16)||0,nr=parseInt(e.substr(6,2),16)||255,this._val=(nr<<24>>>0)+(ir<<16)+(tr<<8)+er,this}},{key:"toHEX",value:function(e){var t=[(0|this.r).toString(16),(0|this.g).toString(16),(0|this.b).toString(16)],i=-1;if("#rrggbb"===e)for(i=0;i<t.length;++i)1===t[i].length&&(t[i]="0"+t[i]);else if("#rrggbbaa"===e)for(t.push((0|this.a).toString(16)),i=0;i<t.length;++i)1===t[i].length&&(t[i]="0"+t[i]);return t.join("")}},{key:"toRGBValue",value:function(){return 16777215&this._val}},{key:"fromHSV",value:function(e,t,i){if((ir=tr=er=0)===t)er=tr=ir=i;else if(0===i)er=tr=ir=0;else{1===e&&(e=0),e*=6,t=t,i=i;var n=Math.floor(e),r=e-n,a=i*(1-t),s=i*(1-t*r),o=i*(1-t*(1-r));switch(n){case 0:er=i,tr=o,ir=a;break;case 1:er=s,tr=i,ir=a;break;case 2:er=a,tr=i,ir=o;break;case 3:er=a,tr=s,ir=i;break;case 4:er=o,tr=a,ir=i;break;case 5:er=i,tr=a,ir=s}}return er*=255,tr*=255,ir*=255,this._val=(this.a<<24>>>0)+(ir<<16)+(tr<<8)+er,this}},{key:"toHSV",value:function(){er=this.r*$n,tr=this.g*$n,ir=this.b*$n;var e={h:0,s:0,v:0},t=Math.max(er,tr,ir),i=Math.min(er,tr,ir),n=0;return e.v=t,e.s=t?(t-i)/t:0,e.s?(n=t-i,e.h=er===t?(tr-ir)/n:tr===t?2+(ir-er)/n:4+(er-tr)/n,e.h/=6,e.h<0&&(e.h+=1)):e.h=0,e}},{key:"set",value:function(e,t,i,n){return"object"===de(e)&&(t=e.g,i=e.b,n=e.a,e=e.r),e=e||0,t=t||0,i=i||0,n="number"==typeof n?n:255,this._val=(n<<24>>>0)+(i<<16)+(t<<8)+e,this}},{key:"multiply",value:function(e){return er=(255&this._val)*e.r>>8,tr=(65280&this._val)*e.g>>8,ir=(16711680&this._val)*e.b>>8,nr=((4278190080&this._val)>>>8)*e.a,this._val=4278190080&nr|16711680&ir|65280&tr|255&er,this}},{key:"_set_r_unsafe",value:function(e){return this._val=(4294967040&this._val|e)>>>0,this}},{key:"_set_g_unsafe",value:function(e){return this._val=(4294902015&this._val|e<<8)>>>0,this}},{key:"_set_b_unsafe",value:function(e){return this._val=(4278255615&this._val|e<<16)>>>0,this}},{key:"_set_a_unsafe",value:function(e){return this._val=(16777215&this._val|e<<24>>>0)>>>0,this}}]),a}());function ar(e,t,i,n){return new rr(e,t,i,n)}rr.WHITE=Object.freeze(new rr(255,255,255,255)),rr.GRAY=Object.freeze(new rr(127,127,127,255)),rr.BLACK=Object.freeze(new rr(0,0,0,255)),rr.TRANSPARENT=Object.freeze(new rr(0,0,0,0)),rr.RED=Object.freeze(new rr(255,0,0,255)),rr.GREEN=Object.freeze(new rr(0,255,0,255)),rr.BLUE=Object.freeze(new rr(0,0,255,255)),rr.CYAN=Object.freeze(new rr(0,255,255,255)),rr.MAGENTA=Object.freeze(new rr(255,0,255,255)),rr.YELLOW=Object.freeze(new rr(255,255,0,255)),ai.fastDefine("cc.Color",rr,{r:0,g:0,b:0,a:255}),cc.Color=rr,cc.color=ar;var sr,or,lr,cr,ur,hr=10;var fr=0,dr=new Map;lr=function(e,t,i,n,r,a){var s=dr.get(a);s&&s.logTimes>s.count&&(r("'%s' is deprecated, please use '%s' instead.","".concat(e,".").concat(t),"".concat(i,".").concat(n)),s.count++)},sr=P2("replaceProperty",function(o,l,e){null!=o&&e.forEach(function(t){var i=fr++;dr.set(i,{id:i,count:0,logTimes:void 0!==t.logTimes?t.logTimes:hr});var n=null!=t.target?t.target:o,r=null!=t.newName?t.newName:t.name,a=null!=t.targetName?t.targetName:l;if(null!=t.customFunction)o[t.name]=function(){return lr(l,t.name,a,r,C,i),t.customFunction.call(this,arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1],arguments.length<=2?void 0:arguments[2],arguments.length<=3?void 0:arguments[3],arguments.length<=4?void 0:arguments[4],arguments.length<=5?void 0:arguments[5],arguments.length<=6?void 0:arguments[6],arguments.length<=7?void 0:arguments[7],arguments.length<=8?void 0:arguments[8],arguments.length<=9?void 0:arguments[9],arguments.length<=10?void 0:arguments[10],arguments.length<=11?void 0:arguments[11])};else if(null!=t.customSetter||null!=t.customGetter){var e=null!=t.customSetter,s=null!=t.customGetter;e&&s?Object.defineProperty(o,t.name,{get:function(){return lr(l,t.name,a,r,C,i),t.customGetter.call(this)},set:function(e){lr(l,t.name,a,r,C,i),t.customSetter.call(this,e)}}):e?Object.defineProperty(o,t.name,{set:function(e){lr(l,t.name,a,r,C,i),t.customSetter.call(this,e)}}):s&&Object.defineProperty(o,t.name,{get:function(){return lr(l,t.name,a,r,C,i),t.customGetter.call(this)}})}else Object.defineProperty(o,t.name,{get:function(){return lr(l,t.name,a,r,C,i),n[r]},set:function(e){lr(l,t.name,a,r,C,i),n[r]=e}})})}),ur=function(e,t,i,n){var r=dr.get(n);r&&r.logTimes>r.count&&(i("'%s' has been removed.","".concat(e,".").concat(t)),r.count++)},or=P2("removeProperty",function(i,n,e){null!=i&&e.forEach(function(e){var t=fr++;dr.set(t,{id:t,count:0,logTimes:void 0!==e.logTimes?e.logTimes:hr}),Object.defineProperty(i,e.name,{get:function(){return ur(n,e.name,A,t)},set:function(){ur(n,e.name,A,t)}})})}),cr=function(e,t,i,n){var r=dr.get(n);r&&r.logTimes>r.count&&(i("'%s' is deprecated.","".concat(e,".").concat(t)),r.count++)},P2("markAsWarning",function(a,s,e){if(null!=a){var o=function(e,t,i,n,r,a,s){if(i.get){var o=i.get();i.get=function(){return cr(n,r,a,s),o.call(this)}}if(i.set){var l=Object.create(i.set);i.set=function(e){cr(n,r,a,s),l.call(this,e)}}};e.forEach(function(e){var t=e.name,i=Object.getOwnPropertyDescriptor(a,t);if(i){var n=fr++;if(dr.set(n,{id:n,count:0,logTimes:void 0!==e.logTimes?e.logTimes:hr}),null!=i.value)if("function"==typeof i.value){var r=i.value;a[t]=function(){return cr(s,t,C,n),r.call(this)}}else o(0,0,i,s,t,C,n);else o(0,0,i,s,t,C,n)}})}}),sr(Mi,"Vec2",[{name:"sub",newName:"subtract",target:Mi,targetName:"Vec2"},{name:"mul",newName:"multiply",target:Mi,targetName:"Vec2"},{name:"div",newName:"divide",target:Mi,targetName:"Vec2"},{name:"dist",newName:"distance",target:Mi,targetName:"Vec2"},{name:"sqrDist",newName:"squaredDistance",target:Mi,targetName:"Vec2"},{name:"mag",newName:"len",target:Mi,targetName:"Vec2"},{name:"sqrMag",newName:"lengthSqr",target:Mi,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:Mi,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:Mi,targetName:"Vec2"}]),sr(Mi.prototype,"Vec2",[{name:"mag",newName:"length",target:Mi.prototype,targetName:"Vec2"},{name:"magSqr",newName:"lengthSqr",target:Mi.prototype,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:Mi.prototype,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:Mi.prototype,targetName:"Vec2"}]),or(Mi.prototype,"vmath",[{name:"divide"}]),sr(Fi,"Vec3",[{name:"sub",newName:"subtract",target:Fi,targetName:"Vec3"},{name:"mul",newName:"multiply",target:Fi,targetName:"Vec3"},{name:"div",newName:"divide",target:Fi,targetName:"Vec3"},{name:"dist",newName:"distance",target:Fi,targetName:"Vec3"},{name:"sqrDist",newName:"squaredDistance",target:Fi,targetName:"Vec3"},{name:"mag",newName:"len",target:Fi,targetName:"Vec3"},{name:"sqrMag",newName:"lengthSqr",target:Fi,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:Fi,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:Fi,targetName:"Vec3"}]),sr(Fi.prototype,"Vec3",[{name:"mag",newName:"length",target:Fi.prototype,targetName:"Vec3"},{name:"magSqr",newName:"lengthSqr",target:Fi.prototype,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:Fi.prototype,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:Fi.prototype,targetName:"Vec3"}]),or(Fi.prototype,"vmath",[{name:"divide"}]),sr(Wi,"Vec4",[{name:"sub",newName:"subtract",target:Wi,targetName:"Vec4"},{name:"mul",newName:"multiply",target:Wi,targetName:"Vec4"},{name:"div",newName:"divide",target:Wi,targetName:"Vec4"},{name:"dist",newName:"distance",target:Wi,targetName:"Vec4"},{name:"sqrDist",newName:"squaredDistance",target:Wi,targetName:"Vec4"},{name:"mag",newName:"len",target:Wi,targetName:"Vec4"},{name:"sqrMag",newName:"lengthSqr",target:Wi,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:Wi,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:Wi,targetName:"Vec4"}]),sr(Wi.prototype,"Vec4",[{name:"mag",newName:"length",target:Wi.prototype,targetName:"Vec4"},{name:"magSqr",newName:"lengthSqr",target:Wi.prototype,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:Wi.prototype,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:Wi.prototype,targetName:"Vec4"}]),or(Wi.prototype,"vmath",[{name:"divide"}]),sr(hn,"Quat",[{name:"mag",newName:"len",target:hn,targetName:"Quat"},{name:"mul",newName:"multiply",target:hn,targetName:"Quat"},{name:"sqrMag",newName:"lengthSqr",target:hn,targetName:"Quat"},{name:"scale",newName:"multiplyScalar",target:hn,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:hn,targetName:"Quat"}]),sr(hn.prototype,"Quat",[{name:"scale",newName:"multiplyScalar",target:hn.prototype,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:hn.prototype,targetName:"Quat"}]),sr(rr,"Color",[{name:"sub",newName:"subtract",target:rr,targetName:"Color"},{name:"mul",newName:"multiply",target:rr,targetName:"Color"},{name:"div",newName:"divide",target:rr,targetName:"Color"},{name:"exactEquals",newName:"strictEquals",target:rr,targetName:"Color"}]),sr(rn,"Mat3",[{name:"sub",newName:"subtract",target:rn,targetName:"Mat3"},{name:"mul",newName:"multiply",target:rn,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:rn,targetName:"Mat3"}]),sr(rn.prototype,"Mat3",[{name:"sub",newName:"subtract",target:rn.prototype,targetName:"Mat3"},{name:"mul",newName:"multiply",target:rn.prototype,targetName:"Mat3"},{name:"mulScalar",newName:"multiplyScalar",target:rn.prototype,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:rn.prototype,targetName:"Mat3"}]),sr(zn,"Mat4",[{name:"sub",newName:"subtract",target:zn,targetName:"Mat4"},{name:"mul",newName:"multiply",target:zn,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:zn,targetName:"Mat4"}]),sr(zn.prototype,"Mat4",[{name:"sub",newName:"subtract",target:zn.prototype,targetName:"Mat4"},{name:"mul",newName:"multiply",target:zn.prototype,targetName:"Mat4"},{name:"mulScalar",newName:"multiplyScalar",target:zn.prototype,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:zn.prototype,targetName:"Mat4"}]);var pr=Object.freeze({bits:ce,Vec2:Mi,v2:zi,Vec3:Fi,v3:Vi,Vec4:Wi,v4:Xi,Quat:hn,quat:mn,Mat3:rn,Mat4:zn,mat4:Dn,AffineTransform:qn,Size:jn,size:Wn,Rect:Zn,rect:Jn,Color:rr,color:ar,EPSILON:hi,equals:fi,approx:di,clamp:pi,clamp01:_i,lerp:vi,toRadian:mi,toDegree:yi,random:gi,randomRange:bi,randomRangeInt:xi,pseudoRandom:Si,pseudoRandomRange:wi,pseudoRandomRangeInt:Ti,nextPow2:Ei,repeat:Ci,pingPong:Ai,inverseLerp:ki});P2("math",pr);var _r={SHAPE_RAY:1,SHAPE_LINE:2,SHAPE_SPHERE:4,SHAPE_AABB:8,SHAPE_OBB:16,SHAPE_PLANE:32,SHAPE_TRIANGLE:64,SHAPE_FRUSTUM:128,SHAPE_FRUSTUM_ACCURATE:256},vr=new Fi,mr=new Fi,yr=new Fi,gr=new Fi,br=new Fi,xr=new Fi,Sr=new Array(3),wr=new Array(3);function Tr(e,t){return Fi.dot(t.n,e)-t.d}function Er(e,t,i){return Fi.copy(e,t),Fi.subtract(br,i.center,i.halfExtents),Fi.add(xr,i.center,i.halfExtents),e.x=e.x<br.x?br.x:e.x,e.y=e.y<br.x?br.y:e.y,e.z=e.z<br.x?br.z:e.z,e.x=e.x>xr.x?xr.x:e.x,e.y=e.y>xr.x?xr.y:e.y,e.z=e.z>xr.x?xr.z:e.z,e}function Cr(e,t,i){Fi.set(vr,i.orientation.m00,i.orientation.m01,i.orientation.m02),Fi.set(mr,i.orientation.m03,i.orientation.m04,i.orientation.m05),Fi.set(yr,i.orientation.m06,i.orientation.m07,i.orientation.m08),Sr[0]=vr,Sr[1]=mr,Sr[2]=yr,wr[0]=i.halfExtents.x,wr[1]=i.halfExtents.y,wr[2]=i.halfExtents.z,Fi.subtract(gr,t,i.center),Fi.set(e,i.center.x,i.center.y,i.center.z);for(var n=0;n<3;n++){var r=Fi.dot(gr,Sr[n]);r>wr[n]&&(r=wr[n]),r<-wr[n]&&(r=-wr[n]),e.x+=r*Sr[n].x,e.y+=r*Sr[n].y,e.z+=r*Sr[n].z}return e}var Ar,kr,Rr,Or,Mr,Ir,Lr,zr,Br,Pr,Dr,Fr,Nr,Ur,Vr,Gr,Hr,qr,jr,Wr,Xr,Yr,Qr,Kr,Zr,Jr,$r,ea,ta,ia,na,ra,aa,sa,oa,la,ca,ua,ha=Object.freeze({point_plane:Tr,pt_point_plane:function(e,t,i){var n=Tr(t,i);return Fi.subtract(e,t,Fi.multiplyScalar(e,i.n,n))},pt_point_aabb:Er,pt_point_obb:Cr}),fa=(Ar=new Fi(0,0,0),function(e,t){var i=Fi.dot(e.d,t.n);if(Math.abs(i)<Number.EPSILON)return 0;Fi.multiplyScalar(Ar,t.n,t.d);var n=Fi.dot(Fi.subtract(Ar,Ar,e.o),t.n)/i;return n<0?0:n}),da=(kr=new Fi(0,0,0),function(e,t){Fi.subtract(kr,e.e,e.s);var i=(t.d-Fi.dot(e.s,t.n))/Fi.dot(kr,t.n);return i<0||1<i?0:i}),pa=(Rr=new Fi(0,0,0),Or=new Fi(0,0,0),Mr=new Fi(0,0,0),Ir=new Fi(0,0,0),Lr=new Fi(0,0,0),function(e,t,i){Fi.subtract(Rr,t.b,t.a),Fi.subtract(Or,t.c,t.a),Fi.cross(Mr,e.d,Or);var n=Fi.dot(Rr,Mr);if(n<Number.EPSILON&&(!i||n>-Number.EPSILON))return 0;var r=1/n;Fi.subtract(Ir,e.o,t.a);var a=Fi.dot(Ir,Mr)*r;if(a<0||1<a)return 0;Fi.cross(Lr,Ir,Rr);var s=Fi.dot(e.d,Lr)*r;if(s<0||1<a+s)return 0;var o=Fi.dot(Or,Lr)*r;return o<0?0:o}),_a=(zr=new Fi(0,0,0),Br=new Fi(0,0,0),Pr=new Fi(0,0,0),Dr=new Fi(0,0,0),Fr=new Fi(0,0,0),Nr=new Fi(0,0,0),function(e,t,i){Fi.subtract(zr,t.b,t.a),Fi.subtract(Br,t.c,t.a),Fi.subtract(Pr,e.s,e.e),Fi.cross(Fr,zr,Br);var n=Fi.dot(Pr,Fr);if(n<=0)return 0;Fi.subtract(Dr,e.s,t.a);var r=Fi.dot(Dr,Fr);if(r<0||n<r)return 0;Fi.cross(Nr,Pr,Dr);var a=Fi.dot(Br,Nr);if(a<0||n<a)return 0;var s=-Fi.dot(zr,Nr);if(s<0||n<a+s)return 0;if(i){var o=1/n,l=1-(a*=o)-(s*=o);Fi.set(i,t.a.x*l+t.b.x*a+t.c.x*s,t.a.y*l+t.b.y*a+t.c.y*s,t.a.z*l+t.b.z*a+t.c.z*s)}return 1}),va=(Ur=new Fi(0,0,0),Vr=new Fi(0,0,0),Gr=new Fi(0,0,0),Hr=new Fi(0,0,0),qr=new Fi(0,0,0),jr=new Fi(0,0,0),Wr=new Fi(0,0,0),function(e,t,i,n,r,a,s){Fi.subtract(Ur,t,e),Fi.subtract(Vr,i,e),Fi.subtract(Gr,n,e),Fi.subtract(Hr,r,e),Fi.cross(jr,Hr,Ur);var o=Fi.dot(Vr,jr);if(0<=o){var l=-Fi.dot(Gr,jr);if(l<0)return 0;var c=Fi.dot(Fi.cross(Wr,Ur,Gr),Vr);if(c<0)return 0;if(s){var u=1/(l+o+c);l*=u,o*=u,c*=u,Fi.set(s,i.x*l+n.x*o+r.x*c,i.y*l+n.y*o+r.y*c,i.z*l+n.z*o+r.z*c)}}else{Fi.subtract(qr,a,e);var h=Fi.dot(qr,jr);if(h<0)return 0;var f=Fi.dot(Fi.cross(Wr,Ur,Vr),qr);if(f<0)return 0;if(s){var d=1/(h+(o=-o)+f);h*=d,o*=d,f*=d,Fi.set(s,i.x*h+a.x*o+r.x*f,i.y*h+a.y*o+r.y*f,i.z*h+a.z*o+r.z*f)}}return 1}),ma=(Xr=new Fi(0,0,0),function(e,t){var i=t.radius,n=t.center,r=e.o,a=e.d,s=i*i;Fi.subtract(Xr,n,r);var o=Xr.lengthSqr(),l=Fi.dot(Xr,a),c=s-(o-l*l);if(c<0)return 0;var u=Math.sqrt(c),h=o<s?l+u:l-u;return h<0?0:h}),ya=(Yr=new Fi,Qr=new Fi,function(e,t){var i=e.o,n=e.d,r=1/n.x,a=1/n.y,s=1/n.z;Fi.subtract(Yr,t.center,t.halfExtents),Fi.add(Qr,t.center,t.halfExtents);var o=(Yr.x-i.x)*r,l=(Qr.x-i.x)*r,c=(Yr.y-i.y)*a,u=(Qr.y-i.y)*a,h=(Yr.z-i.z)*s,f=(Qr.z-i.z)*s,d=Math.max(Math.max(Math.min(o,l),Math.min(c,u)),Math.min(h,f)),p=Math.min(Math.min(Math.max(o,l),Math.max(c,u)),Math.max(h,f));return p<0||p<d?0:d}),ga=(Kr=new Fi,Zr=new Fi,Jr=new Fi,$r=new Fi,ea=new Fi,ta=new Fi,ia=new Fi,na=new Array(3),ra=new Array(3),aa=new Array(3),sa=new Array(6),function(e,t){na[0]=t.halfExtents.x,na[1]=t.halfExtents.y,na[2]=t.halfExtents.z,Kr=t.center,Zr=e.o,Jr=e.d,Fi.set($r,t.orientation.m00,t.orientation.m01,t.orientation.m02),Fi.set(ea,t.orientation.m03,t.orientation.m04,t.orientation.m05),Fi.set(ta,t.orientation.m06,t.orientation.m07,t.orientation.m08),Fi.subtract(ia,Kr,Zr),ra[0]=Fi.dot($r,Jr),ra[1]=Fi.dot(ea,Jr),ra[2]=Fi.dot(ta,Jr),aa[0]=Fi.dot($r,ia),aa[1]=Fi.dot(ea,ia),aa[2]=Fi.dot(ta,ia);for(var i=0;i<3;++i){if(0===ra[i]){if(0<-aa[i]-na[i]||-aa[i]+na[i]<0)return 0;ra[i]=1e-7}sa[2*i+0]=(aa[i]+na[i])/ra[i],sa[2*i+1]=(aa[i]-na[i])/ra[i]}var n=Math.max(Math.max(Math.min(sa[0],sa[1]),Math.min(sa[2],sa[3])),Math.min(sa[4],sa[5])),r=Math.min(Math.min(Math.max(sa[0],sa[1]),Math.max(sa[2],sa[3])),Math.max(sa[4],sa[5]));return r<0||r<n||n<0?0:n}),ba=(oa=new Fi,la=new Fi,ca=new Fi,ua=new Fi,function(e,t){return Fi.subtract(oa,e.center,e.halfExtents),Fi.add(la,e.center,e.halfExtents),Fi.subtract(ca,t.center,t.halfExtents),Fi.add(ua,t.center,t.halfExtents),oa.x<=ua.x&&la.x>=ca.x&&oa.y<=ua.y&&la.y>=ca.y&&oa.z<=ua.z&&la.z>=ca.z});function xa(e,t,i,n,r,a){Fi.set(a[0],e.x+i.x*t.x+n.x*t.y+r.x*t.z,e.y+i.y*t.x+n.y*t.y+r.y*t.z,e.z+i.z*t.x+n.z*t.y+r.z*t.z),Fi.set(a[1],e.x-i.x*t.x+n.x*t.y+r.x*t.z,e.y-i.y*t.x+n.y*t.y+r.y*t.z,e.z-i.z*t.x+n.z*t.y+r.z*t.z),Fi.set(a[2],e.x+i.x*t.x-n.x*t.y+r.x*t.z,e.y+i.y*t.x-n.y*t.y+r.y*t.z,e.z+i.z*t.x-n.z*t.y+r.z*t.z),Fi.set(a[3],e.x+i.x*t.x+n.x*t.y-r.x*t.z,e.y+i.y*t.x+n.y*t.y-r.y*t.z,e.z+i.z*t.x+n.z*t.y-r.z*t.z),Fi.set(a[4],e.x-i.x*t.x-n.x*t.y-r.x*t.z,e.y-i.y*t.x-n.y*t.y-r.y*t.z,e.z-i.z*t.x-n.z*t.y-r.z*t.z),Fi.set(a[5],e.x+i.x*t.x-n.x*t.y-r.x*t.z,e.y+i.y*t.x-n.y*t.y-r.y*t.z,e.z+i.z*t.x-n.z*t.y-r.z*t.z),Fi.set(a[6],e.x-i.x*t.x+n.x*t.y-r.x*t.z,e.y-i.y*t.x+n.y*t.y-r.y*t.z,e.z-i.z*t.x+n.z*t.y-r.z*t.z),Fi.set(a[7],e.x-i.x*t.x-n.x*t.y+r.x*t.z,e.y-i.y*t.x-n.y*t.y+r.y*t.z,e.z-i.z*t.x-n.z*t.y+r.z*t.z)}function Sa(e,t){for(var i=Fi.dot(t,e[0]),n=i,r=1;r<8;++r){var a=Fi.dot(t,e[r]);i=a<i?a:i,n=n<a?a:n}return[i,n]}function wa(e,t){var i=e.halfExtents.x*Math.abs(t.n.x)+e.halfExtents.y*Math.abs(t.n.y)+e.halfExtents.z*Math.abs(t.n.z),n=Fi.dot(t.n,e.center);return n+i<t.d?-1:n-i>t.d?0:1}function Ta(e,t){for(var i=0;i<t.planes.length;i++)if(-1===wa(e,t.planes[i]))return 0;return 1}var Ea,Ca,Aa=function(){for(var s=new Array(15),e=0;e<15;e++)s[e]=new Fi(0,0,0);for(var o=new Array(8),l=new Array(8),t=0;t<8;t++)o[t]=new Fi(0,0,0),l[t]=new Fi(0,0,0);var c=new Fi,u=new Fi;return function(e,t){Fi.set(s[0],1,0,0),Fi.set(s[1],0,1,0),Fi.set(s[2],0,0,1),Fi.set(s[3],t.orientation.m00,t.orientation.m01,t.orientation.m02),Fi.set(s[4],t.orientation.m03,t.orientation.m04,t.orientation.m05),Fi.set(s[5],t.orientation.m06,t.orientation.m07,t.orientation.m08);for(var i=0;i<3;++i)Fi.cross(s[6+3*i+0],s[i],s[0]),Fi.cross(s[6+3*i+1],s[i],s[1]),Fi.cross(s[6+3*i+1],s[i],s[2]);Fi.subtract(c,e.center,e.halfExtents),Fi.add(u,e.center,e.halfExtents),function(e,t,i){Fi.set(i[0],e.x,t.y,t.z),Fi.set(i[1],e.x,t.y,e.z),Fi.set(i[2],e.x,e.y,t.z),Fi.set(i[3],e.x,e.y,e.z),Fi.set(i[4],t.x,t.y,t.z),Fi.set(i[5],t.x,t.y,e.z),Fi.set(i[6],t.x,e.y,t.z),Fi.set(i[7],t.x,e.y,e.z)}(c,u,o),xa(t.center,t.halfExtents,s[3],s[4],s[5],l);for(var n=0;n<15;++n){var r=Sa(o,s[n]),a=Sa(l,s[n]);if(a[0]>r[1]||r[0]>a[1])return 0}return 1}}(),ka=function(){for(var c=new Array(8),u=0,h=0,e=0;e<c.length;e++)c[e]=new Fi(0,0,0);return function(e,t){for(var i=0,n=!1,r=0;r<t.planes.length;r++){if(-1===(i=wa(e,t.planes[r])))return 0;1===i&&(n=!0)}if(!n)return 1;for(var a=0;a<t.vertices.length;a++)Fi.subtract(c[a],t.vertices[a],e.center);for(var s=h=u=0;s<t.vertices.length;s++)c[s].x>e.halfExtents.x?u++:c[s].x<-e.halfExtents.x&&h++;if(u===t.vertices.length||h===t.vertices.length)return 0;for(var o=h=u=0;o<t.vertices.length;o++)c[o].y>e.halfExtents.y?u++:c[o].y<-e.halfExtents.y&&h++;if(u===t.vertices.length||h===t.vertices.length)return 0;for(var l=h=u=0;l<t.vertices.length;l++)c[l].z>e.halfExtents.z?u++:c[l].z<-e.halfExtents.z&&h++;return u===t.vertices.length||h===t.vertices.length?0:1}}(),Ra=(Ea=new Fi(0,0,0),Ca=new rn,function(e,t){return Fi.subtract(Ea,t,e.center),Fi.transformMat3(Ea,Ea,rn.transpose(Ca,e.orientation)),function(e,t){return Math.abs(e.x)<t.x&&Math.abs(e.y)<t.y&&Math.abs(e.z)<t.z}(Ea,e.halfExtents)}),Oa=function(e,t){var i=e.halfExtents.x*Ma(t.n,e.orientation.m00,e.orientation.m01,e.orientation.m02)+e.halfExtents.y*Ma(t.n,e.orientation.m03,e.orientation.m04,e.orientation.m05)+e.halfExtents.z*Ma(t.n,e.orientation.m06,e.orientation.m07,e.orientation.m08),n=Fi.dot(t.n,e.center);return n+i<t.d?-1:n-i>t.d?0:1};function Ma(e,t,i,n){return Math.abs(e.x*t+e.y*i+e.z*n)}function Ia(e,t){for(var i=0;i<t.planes.length;i++)if(-1===Oa(e,t.planes[i]))return 0;return 1}function La(e,t){var i=Fi.dot(t.n,e.center),n=e.radius*t.n.length();return i+n<t.d?-1:i-n>t.d?0:1}function za(e,t){for(var i=0;i<t.planes.length;i++)if(-1===La(e,t.planes[i]))return 0;return 1}function Ba(e,t){var i=e.radius+t.radius;return Fi.squaredDistance(e.center,t.center)<i*i}var Pa,Da,Fa,Na,Ua=function(){for(var c=new Array(8),u=0,h=0,f=0,e=0;e<c.length;e++)c[e]=new Fi(0,0,0);function d(e,t,i,n){return e.x*t+e.y*i+e.z*n}return function(e,t){for(var i=0,n=!1,r=0;r<t.planes.length;r++){if(-1===(i=Oa(e,t.planes[r])))return 0;1===i&&(n=!0)}if(!n)return 1;for(var a=0;a<t.vertices.length;a++)Fi.subtract(c[a],t.vertices[a],e.center);for(var s=f=h=0;s<t.vertices.length;s++)(u=d(c[s],e.orientation.m00,e.orientation.m01,e.orientation.m02))>e.halfExtents.x?h++:u<-e.halfExtents.x&&f++;if(h===t.vertices.length||f===t.vertices.length)return 0;for(var o=f=h=0;o<t.vertices.length;o++)(u=d(c[o],e.orientation.m03,e.orientation.m04,e.orientation.m05))>e.halfExtents.y?h++:u<-e.halfExtents.y&&f++;if(h===t.vertices.length||f===t.vertices.length)return 0;for(var l=f=h=0;l<t.vertices.length;l++)(u=d(c[l],e.orientation.m06,e.orientation.m07,e.orientation.m08))>e.halfExtents.z?h++:u<-e.halfExtents.z&&f++;return h===t.vertices.length||f===t.vertices.length?0:1}}(),Va=function(){for(var s=new Array(15),e=0;e<15;e++)s[e]=new Fi(0,0,0);for(var o=new Array(8),l=new Array(8),t=0;t<8;t++)o[t]=new Fi(0,0,0),l[t]=new Fi(0,0,0);return function(e,t){Fi.set(s[0],e.orientation.m00,e.orientation.m01,e.orientation.m02),Fi.set(s[1],e.orientation.m03,e.orientation.m04,e.orientation.m05),Fi.set(s[2],e.orientation.m06,e.orientation.m07,e.orientation.m08),Fi.set(s[3],t.orientation.m00,t.orientation.m01,t.orientation.m02),Fi.set(s[4],t.orientation.m03,t.orientation.m04,t.orientation.m05),Fi.set(s[5],t.orientation.m06,t.orientation.m07,t.orientation.m08);for(var i=0;i<3;++i)Fi.cross(s[6+3*i+0],s[i],s[0]),Fi.cross(s[6+3*i+1],s[i],s[1]),Fi.cross(s[6+3*i+1],s[i],s[2]);xa(e.center,e.halfExtents,s[0],s[1],s[2],o),xa(t.center,t.halfExtents,s[3],s[4],s[5],l);for(var n=0;n<15;++n){var r=Sa(o,s[n]),a=Sa(l,s[n]);if(a[0]>r[1]||r[0]>a[1])return 0}return 1}}(),Ga=(Pa=new Fi(0,0,0),Da=[1,-1,1,-1,1,-1],function(e,t){for(var i=0;i<6;i++){var n=t.planes[i],r=e.radius,a=e.center,s=n.n,o=n.d,l=Fi.dot(s,a);if(l+r<o)return 0;if(!(o<l-r)){Fi.add(Pa,a,Fi.multiplyScalar(Pa,s,r));for(var c=0;c<6;c++)if(c!==i&&c!==i+Da[i]){var u=t.planes[c];if(Fi.dot(u.n,Pa)<u.d)return 0}}}return 1}),Ha=(Fa=new Fi,function(e,t){return Er(Fa,e.center,t),Fi.squaredDistance(e.center,Fa)<e.radius*e.radius}),qa=(Na=new Fi,function(e,t){return Cr(Na,e.center,t),Fi.squaredDistance(e.center,Na)<e.radius*e.radius}),ja={ray_sphere:ma,ray_aabb:ya,ray_obb:ga,ray_plane:fa,ray_triangle:pa,line_plane:da,line_triangle:_a,line_quad:va,sphere_sphere:Ba,sphere_aabb:Ha,sphere_obb:qa,sphere_plane:La,sphere_frustum:za,sphere_frustum_accurate:Ga,aabb_aabb:ba,aabb_obb:Aa,aabb_plane:wa,aabb_frustum:Ta,aabb_frustum_accurate:ka,obb_obb:Va,obb_plane:Oa,obb_frustum:Ia,obb_frustum_accurate:Ua,obb_point:Ra,resolve:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:null,r=e._type,a=t._type,s=this[r|a];return r<a?s(e,t,n):s(t,e,n)}};ja[_r.SHAPE_RAY|_r.SHAPE_SPHERE]=ma,ja[_r.SHAPE_RAY|_r.SHAPE_AABB]=ya,ja[_r.SHAPE_RAY|_r.SHAPE_OBB]=ga,ja[_r.SHAPE_RAY|_r.SHAPE_PLANE]=fa,ja[_r.SHAPE_RAY|_r.SHAPE_TRIANGLE]=pa,ja[_r.SHAPE_LINE|_r.SHAPE_PLANE]=da,ja[_r.SHAPE_LINE|_r.SHAPE_TRIANGLE]=_a,ja[_r.SHAPE_SPHERE]=Ba,ja[_r.SHAPE_SPHERE|_r.SHAPE_AABB]=Ha,ja[_r.SHAPE_SPHERE|_r.SHAPE_OBB]=qa,ja[_r.SHAPE_SPHERE|_r.SHAPE_PLANE]=La,ja[_r.SHAPE_SPHERE|_r.SHAPE_FRUSTUM]=za,ja[_r.SHAPE_SPHERE|_r.SHAPE_FRUSTUM_ACCURATE]=Ga,ja[_r.SHAPE_AABB]=ba,ja[_r.SHAPE_AABB|_r.SHAPE_OBB]=Aa,ja[_r.SHAPE_AABB|_r.SHAPE_PLANE]=wa,ja[_r.SHAPE_AABB|_r.SHAPE_FRUSTUM]=Ta,ja[_r.SHAPE_AABB|_r.SHAPE_FRUSTUM_ACCURATE]=ka,ja[_r.SHAPE_OBB]=Va,ja[_r.SHAPE_OBB|_r.SHAPE_PLANE]=Oa,ja[_r.SHAPE_OBB|_r.SHAPE_FRUSTUM]=Ia,ja[_r.SHAPE_OBB|_r.SHAPE_FRUSTUM_ACCURATE]=Ua;var Wa=function(){function s(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:-1;y(this,s),this.s=void 0,this.e=void 0,this._type=void 0,this._type=_r.SHAPE_LINE,this.s=new Fi(e,t,i),this.e=new Fi(n,r,a)}return l(s,null,[{key:"create",value:function(e,t,i,n,r,a){return new s(e,t,i,n,r,a)}},{key:"clone",value:function(e){return new s(e.s.x,e.s.y,e.s.z,e.e.x,e.e.y,e.e.z)}},{key:"copy",value:function(e,t){return Fi.copy(e.s,t.s),Fi.copy(e.e,t.e),e}},{key:"fromPoints",value:function(e,t,i){return Fi.copy(e.s,t),Fi.copy(e.e,i),e}},{key:"set",value:function(e,t,i,n,r,a,s){return e.s.x=t,e.s.y=i,e.s.z=n,e.e.x=r,e.e.y=a,e.e.z=s,e}},{key:"len",value:function(e){return Fi.distance(e.s,e.e)}}]),l(s,[{key:"length",value:function(){return Fi.distance(this.s,this.e)}}]),s}(),Xa=new Fi(0,0,0),Ya=new Fi(0,0,0),Qa=cc.mat4(),Ka=cc.v4(),Za=function(){function r(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:1,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0;y(this,r),this.n=void 0,this.d=void 0,this._type=void 0,this._type=_r.SHAPE_PLANE,this.n=new Fi(e,t,i),this.d=n}return l(r,null,[{key:"create",value:function(e,t,i,n){return new r(e,t,i,n)}},{key:"clone",value:function(e){return new r(e.n.x,e.n.y,e.n.z,e.d)}},{key:"copy",value:function(e,t){return Fi.copy(e.n,t.n),e.d=t.d,e}},{key:"fromPoints",value:function(e,t,i,n){return Fi.subtract(Xa,i,t),Fi.subtract(Ya,n,t),Fi.normalize(e.n,Fi.cross(e.n,Xa,Ya)),e.d=Fi.dot(e.n,t),e}},{key:"set",value:function(e,t,i,n,r){return e.n.x=t,e.n.y=i,e.n.z=n,e.d=r,e}},{key:"fromNormalAndPoint",value:function(e,t,i){return Fi.copy(e.n,t),e.d=Fi.dot(t,i),e}},{key:"normalize",value:function(e,t){var i=t.n.length();return Fi.normalize(e.n,t.n),0<i&&(e.d=t.d/i),e}}]),l(r,[{key:"transform",value:function(e){zn.invert(Qa,e),zn.transpose(Qa,Qa),Wi.set(Ka,this.n.x,this.n.y,this.n.z,this.d),Wi.transformMat4(Ka,Ka,Qa),Fi.set(this.n,Ka.x,Ka.y,Ka.z),this.d=Ka.w}}]),r}(),Ja=function(){function s(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:-1;y(this,s),this.o=void 0,this.d=void 0,this._type=void 0,this._type=_r.SHAPE_RAY,this.o=new Fi(e,t,i),this.d=new Fi(n,r,a)}return l(s,null,[{key:"create",value:function(e,t,i,n,r,a){return new s(0<arguments.length&&void 0!==e?e:0,1<arguments.length&&void 0!==t?t:0,2<arguments.length&&void 0!==i?i:0,3<arguments.length&&void 0!==n?n:0,4<arguments.length&&void 0!==r?r:0,5<arguments.length&&void 0!==a?a:1)}},{key:"clone",value:function(e){return new s(e.o.x,e.o.y,e.o.z,e.d.x,e.d.y,e.d.z)}},{key:"copy",value:function(e,t){return Fi.copy(e.o,t.o),Fi.copy(e.d,t.d),e}},{key:"fromPoints",value:function(e,t,i){return Fi.copy(e.o,t),Fi.normalize(e.d,Fi.subtract(e.d,i,t)),e}},{key:"set",value:function(e,t,i,n,r,a,s){return e.o.x=t,e.o.y=i,e.o.z=n,e.d.x=r,e.d.y=a,e.d.z=s,e}}]),s}(),$a=function(){function c(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:1,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:0,s=6<arguments.length&&void 0!==arguments[6]?arguments[6]:0,o=7<arguments.length&&void 0!==arguments[7]?arguments[7]:1,l=8<arguments.length&&void 0!==arguments[8]?arguments[8]:0;y(this,c),this.a=void 0,this.b=void 0,this.c=void 0,this._type=void 0,this._type=_r.SHAPE_TRIANGLE,this.a=new Fi(e,t,i),this.b=new Fi(n,r,a),this.c=new Fi(s,o,l)}return l(c,null,[{key:"create",value:function(e,t,i,n,r,a,s,o,l){return new c(0<arguments.length&&void 0!==e?e:1,1<arguments.length&&void 0!==t?t:0,2<arguments.length&&void 0!==i?i:0,3<arguments.length&&void 0!==n?n:0,4<arguments.length&&void 0!==r?r:0,5<arguments.length&&void 0!==a?a:0,6<arguments.length&&void 0!==s?s:0,7<arguments.length&&void 0!==o?o:0,8<arguments.length&&void 0!==l?l:1)}},{key:"clone",value:function(e){return new c(e.a.x,e.a.y,e.a.z,e.b.x,e.b.y,e.b.z,e.c.x,e.c.y,e.c.z)}},{key:"copy",value:function(e,t){return Fi.copy(e.a,t.a),Fi.copy(e.b,t.b),Fi.copy(e.c,t.c),e}},{key:"fromPoints",value:function(e,t,i,n){return Fi.copy(e.a,t),Fi.copy(e.b,i),Fi.copy(e.c,n),e}},{key:"set",value:function(e,t,i,n,r,a,s,o,l,c){return e.a.x=t,e.a.y=i,e.a.z=n,e.b.x=r,e.b.y=a,e.b.z=s,e.c.x=o,e.c.y=l,e.c.z=c,e}}]),c}(),es=new Fi;function ts(e){return Math.max(Math.max(e.x,e.y),e.z)}function is(e,t,i){ls.m00=Math.abs(i.m00),ls.m01=Math.abs(i.m01),ls.m02=Math.abs(i.m02),ls.m03=Math.abs(i.m04),ls.m04=Math.abs(i.m05),ls.m05=Math.abs(i.m06),ls.m06=Math.abs(i.m08),ls.m07=Math.abs(i.m09),ls.m08=Math.abs(i.m10),Fi.transformMat3(e,t,ls)}var ns=function(){function r(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:1;y(this,r),this.center=void 0,this.radius=void 0,this._type=void 0,this._type=_r.SHAPE_SPHERE,this.center=new Fi(e,t,i),this.radius=n}return l(r,null,[{key:"create",value:function(e,t,i,n){return new r(e,t,i,n)}},{key:"clone",value:function(e){return new r(e.center.x,e.center.y,e.center.z,e.radius)}},{key:"copy",value:function(e,t){return Fi.copy(e.center,t.center),e.radius=t.radius,e}},{key:"fromPoints",value:function(e,t,i){return Fi.multiplyScalar(e.center,Fi.add(es,t,i),.5),e.radius=.5*Fi.subtract(es,i,t).length(),e}},{key:"set",value:function(e,t,i,n,r){return e.center.x=t,e.center.y=i,e.center.z=n,e.radius=r,e}}]),l(r,[{key:"clone",value:function(){return r.clone(this)}},{key:"copy",value:function(e){return r.copy(this,e)}},{key:"getBoundary",value:function(e,t){Fi.set(e,this.center.x-this.radius,this.center.y-this.radius,this.center.z-this.radius),Fi.set(t,this.center.x+this.radius,this.center.y+this.radius,this.center.z+this.radius)}},{key:"transform",value:function(e,t,i,n,r){Fi.transformMat4(r.center,this.center,e),r.radius=this.radius*ts(n)}},{key:"translateAndRotate",value:function(e,t,i){Fi.transformMat4(i.center,this.center,e)}},{key:"setScale",value:function(e,t){t.radius=this.radius*ts(e)}}]),r}(),rs=new Fi,as=new Fi,ss=new Fi,os=new Fi,ls=new rn,cs=function(){function s(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:1,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:1,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:1;y(this,s),this.center=void 0,this.halfExtents=void 0,this._type=_r.SHAPE_AABB,this.center=new Fi(e,t,i),this.halfExtents=new Fi(n,r,a)}return l(s,[{key:"type",get:function(){return this._type}}],[{key:"create",value:function(e,t,i,n,r,a){return new s(e,t,i,n,r,a)}},{key:"clone",value:function(e){return new s(e.center.x,e.center.y,e.center.z,e.halfExtents.x,e.halfExtents.y,e.halfExtents.z)}},{key:"copy",value:function(e,t){return Fi.copy(e.center,t.center),Fi.copy(e.halfExtents,t.halfExtents),e}},{key:"fromPoints",value:function(e,t,i){return Fi.multiplyScalar(e.center,Fi.add(rs,t,i),.5),Fi.multiplyScalar(e.halfExtents,Fi.subtract(as,i,t),.5),e}},{key:"set",value:function(e,t,i,n,r,a,s){return Fi.set(e.center,t,i,n),Fi.set(e.halfExtents,r,a,s),e}},{key:"merge",value:function(e,t,i){return Fi.subtract(rs,t.center,t.halfExtents),Fi.subtract(as,i.center,i.halfExtents),Fi.add(ss,t.center,t.halfExtents),Fi.add(os,i.center,i.halfExtents),Fi.max(os,ss,os),Fi.min(ss,rs,as),s.fromPoints(e,ss,os)}},{key:"transform",value:function(e,t,i){return Fi.transformMat4(e.center,t.center,i),is(e.halfExtents,t.halfExtents,i),e}}]),l(s,[{key:"getBoundary",value:function(e,t){Fi.subtract(e,this.center,this.halfExtents),Fi.add(t,this.center,this.halfExtents)}},{key:"transform",value:function(e,t,i,n,r){Fi.transformMat4(r.center,this.center,e),is(r.halfExtents,this.halfExtents,e)}},{key:"clone",value:function(){return s.clone(this)}},{key:"copy",value:function(e){return s.copy(this,e)}}]),s}(),us=new Fi,hs=new Fi,fs=new rn,ds=function(){function _(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:1,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:1,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:1,s=6<arguments.length&&void 0!==arguments[6]?arguments[6]:1,o=7<arguments.length&&void 0!==arguments[7]?arguments[7]:0,l=8<arguments.length&&void 0!==arguments[8]?arguments[8]:0,c=9<arguments.length&&void 0!==arguments[9]?arguments[9]:0,u=10<arguments.length&&void 0!==arguments[10]?arguments[10]:1,h=11<arguments.length&&void 0!==arguments[11]?arguments[11]:0,f=12<arguments.length&&void 0!==arguments[12]?arguments[12]:0,d=13<arguments.length&&void 0!==arguments[13]?arguments[13]:0,p=14<arguments.length&&void 0!==arguments[14]?arguments[14]:1;y(this,_),this.center=void 0,this.halfExtents=void 0,this.orientation=void 0,this._type=void 0,this._type=_r.SHAPE_OBB,this.center=new Fi(e,t,i),this.halfExtents=new Fi(n,r,a),this.orientation=new rn(s,o,l,c,u,h,f,d,p)}return l(_,[{key:"type",get:function(){return this._type}}],[{key:"create",value:function(e,t,i,n,r,a,s,o,l,c,u,h,f,d,p){return new _(e,t,i,n,r,a,s,o,l,c,u,h,f,d,p)}},{key:"clone",value:function(e){return new _(e.center.x,e.center.y,e.center.z,e.halfExtents.x,e.halfExtents.y,e.halfExtents.z,e.orientation.m00,e.orientation.m01,e.orientation.m02,e.orientation.m03,e.orientation.m04,e.orientation.m05,e.orientation.m06,e.orientation.m07,e.orientation.m08)}},{key:"copy",value:function(e,t){return Fi.copy(e.center,t.center),Fi.copy(e.halfExtents,t.halfExtents),rn.copy(e.orientation,t.orientation),e}},{key:"fromPoints",value:function(e,t,i){return Fi.multiplyScalar(e.center,Fi.add(us,t,i),.5),Fi.multiplyScalar(e.halfExtents,Fi.subtract(hs,i,t),.5),rn.identity(e.orientation),e}},{key:"set",value:function(e,t,i,n,r,a,s,o,l,c,u,h,f,d,p,_){return Fi.set(e.center,t,i,n),Fi.set(e.halfExtents,r,a,s),rn.set(e.orientation,o,l,c,u,h,f,d,p,_),e}}]),l(_,[{key:"getBoundary",value:function(e,t){!function(e,t,i){fs.m00=Math.abs(i.m00),fs.m01=Math.abs(i.m01),fs.m02=Math.abs(i.m02),fs.m03=Math.abs(i.m03),fs.m04=Math.abs(i.m04),fs.m05=Math.abs(i.m05),fs.m06=Math.abs(i.m06),fs.m07=Math.abs(i.m07),fs.m08=Math.abs(i.m08),Fi.transformMat3(e,t,fs)}(us,this.halfExtents,this.orientation),Fi.subtract(e,this.center,us),Fi.add(t,this.center,us)}},{key:"transform",value:function(e,t,i,n,r){Fi.transformMat4(r.center,this.center,e),rn.fromQuat(r.orientation,i),Fi.multiply(r.halfExtents,this.halfExtents,n)}},{key:"translateAndRotate",value:function(e,t,i){Fi.transformMat4(i.center,this.center,e),rn.fromQuat(i.orientation,t)}},{key:"setScale",value:function(e,t){Fi.multiply(t.halfExtents,this.halfExtents,e)}}]),_}(),ps=new Array(8);ps[0]=new Fi(1,1,1),ps[1]=new Fi(-1,1,1),ps[2]=new Fi(-1,-1,1),ps[3]=new Fi(1,-1,1),ps[4]=new Fi(1,1,-1),ps[5]=new Fi(-1,1,-1),ps[6]=new Fi(-1,-1,-1),ps[7]=new Fi(1,-1,-1);var _s,vs=function(){function i(){y(this,i),this.planes=void 0,this.vertices=void 0,this._type=void 0,this._type=_r.SHAPE_FRUSTUM,this.planes=new Array(6);for(var e=0;e<6;++e)this.planes[e]=Za.create(0,0,0,0);this.vertices=new Array(8);for(var t=0;t<8;++t)this.vertices[t]=new Fi}return l(i,[{key:"accurate",set:function(e){this._type=e?_r.SHAPE_FRUSTUM_ACCURATE:_r.SHAPE_FRUSTUM}}],[{key:"create",value:function(){return new i}},{key:"clone",value:function(e){return i.copy(new i,e)}},{key:"copy",value:function(e,t){e._type=t._type;for(var i=0;i<6;++i)Za.copy(e.planes[i],t.planes[i]);for(var n=0;n<8;++n)Fi.copy(e.vertices[n],t.vertices[n]);return e}}]),l(i,[{key:"update",value:function(e,t){if(Fi.set(this.planes[0].n,e.m03+e.m00,e.m07+e.m04,e.m11+e.m08),this.planes[0].d=-(e.m15+e.m12),Fi.set(this.planes[1].n,e.m03-e.m00,e.m07-e.m04,e.m11-e.m08),this.planes[1].d=-(e.m15-e.m12),Fi.set(this.planes[2].n,e.m03+e.m01,e.m07+e.m05,e.m11+e.m09),this.planes[2].d=-(e.m15+e.m13),Fi.set(this.planes[3].n,e.m03-e.m01,e.m07-e.m05,e.m11-e.m09),this.planes[3].d=-(e.m15-e.m13),Fi.set(this.planes[4].n,e.m03+e.m02,e.m07+e.m06,e.m11+e.m10),this.planes[4].d=-(e.m15+e.m14),Fi.set(this.planes[5].n,e.m03-e.m02,e.m07-e.m06,e.m11-e.m10),this.planes[5].d=-(e.m15-e.m14),this._type===_r.SHAPE_FRUSTUM_ACCURATE){for(var i=0;i<6;i++){var n=this.planes[i],r=1/n.n.length();Fi.multiplyScalar(n.n,n.n,r),n.d*=r}for(var a=0;a<8;a++)Fi.transformMat4(this.vertices[a],ps[a],t)}}},{key:"transform",value:function(e){if(this._type===_r.SHAPE_FRUSTUM_ACCURATE){for(var t=0;t<8;t++)Fi.transformMat4(this.vertices[t],this.vertices[t],e);Za.fromPoints(this.planes[0],this.vertices[1],this.vertices[5],this.vertices[6]),Za.fromPoints(this.planes[1],this.vertices[3],this.vertices[7],this.vertices[4]),Za.fromPoints(this.planes[2],this.vertices[6],this.vertices[7],this.vertices[3]),Za.fromPoints(this.planes[3],this.vertices[0],this.vertices[4],this.vertices[5]),Za.fromPoints(this.planes[4],this.vertices[2],this.vertices[3],this.vertices[0]),Za.fromPoints(this.planes[0],this.vertices[7],this.vertices[6],this.vertices[5])}}}]),i}();vs.createOrtho=(_s=new Fi,function(e,t,i,n,r,a){var s=t/2,o=i/2;Fi.set(_s,s,o,n),Fi.transformMat4(e.vertices[0],_s,a),Fi.set(_s,-s,o,n),Fi.transformMat4(e.vertices[1],_s,a),Fi.set(_s,-s,-o,n),Fi.transformMat4(e.vertices[2],_s,a),Fi.set(_s,s,-o,n),Fi.transformMat4(e.vertices[3],_s,a),Fi.set(_s,s,o,r),Fi.transformMat4(e.vertices[4],_s,a),Fi.set(_s,-s,o,r),Fi.transformMat4(e.vertices[5],_s,a),Fi.set(_s,-s,-o,r),Fi.transformMat4(e.vertices[6],_s,a),Fi.set(_s,s,-o,r),Fi.transformMat4(e.vertices[7],_s,a),Za.fromPoints(e.planes[0],e.vertices[1],e.vertices[6],e.vertices[5]),Za.fromPoints(e.planes[1],e.vertices[3],e.vertices[4],e.vertices[7]),Za.fromPoints(e.planes[2],e.vertices[6],e.vertices[3],e.vertices[7]),Za.fromPoints(e.planes[3],e.vertices[0],e.vertices[5],e.vertices[4]),Za.fromPoints(e.planes[4],e.vertices[2],e.vertices[0],e.vertices[3]),Za.fromPoints(e.planes[0],e.vertices[7],e.vertices[5],e.vertices[6])});P2("CircularPool",function(){function n(e,t){y(this,n),this._cursor=void 0,this._data=void 0,this._cursor=0,this._data=new Array(t);for(var i=0;i<t;++i)this._data[i]=e()}return l(n,[{key:"request",value:function(){var e=this._data[this._cursor];return this._cursor=(this._cursor+1)%this._data.length,e}}]),n}());var ms=32,ys=[1,10,100,1e3,1e4,1e5,1e6,1e7,1e8,1e9];function gs(e){return e<1e5?e<100?e<10?0:1:e<1e4?e<1e3?2:3:4:e<1e7?e<1e6?5:6:e<1e9?e<1e8?7:8:9}function bs(e,t){if(e===t)return 0;if(~~e===e&&~~t===t){if(0===e||0===t)return e<t?-1:1;if(e<0||t<0){if(0<=t)return-1;if(0<=e)return 1;e=-e,t=-t}var i=gs(e),n=gs(t),r=0;return i<n?(e*=ys[n-i-1],t/=10,r=-1):n<i&&(t*=ys[i-n-1],e/=10,r=1),e===t?r:e<t?-1:1}var a=String(e),s=String(t);return a===s?0:a<s?-1:1}function xs(e,t,i,n){var r=t+1;if(r===i)return 1;if(n(e[r++],e[t])<0){for(;r<i&&n(e[r],e[r-1])<0;)r++;!function(e,t,i){i--;for(;t<i;){var n=e[t];e[t++]=e[i],e[i--]=n}}(e,t,r)}else for(;r<i&&0<=n(e[r],e[r-1]);)r++;return r-t}function Ss(e,t,i,n,r){for(n===t&&n++;n<i;n++){for(var a=e[n],s=t,o=n;s<o;){var l=s+o>>>1;r(a,e[l])<0?o=l:s=1+l}var c=n-s;switch(c){case 3:e[s+3]=e[s+2];case 2:e[s+2]=e[s+1];case 1:e[s+1]=e[s];break;default:for(;0<c;)e[s+c]=e[s+c-1],c--}e[s]=a}}function ws(e,t,i,n,r,a){var s=0,o=0,l=1;if(0<a(e,t[i+r])){for(o=n-r;l<o&&0<a(e,t[i+r+l]);)(l=1+((s=l)<<1))<=0&&(l=o);o<l&&(l=o),s+=r,l+=r}else{for(o=r+1;l<o&&a(e,t[i+r-l])<=0;)(l=1+((s=l)<<1))<=0&&(l=o);o<l&&(l=o);var c=s;s=r-l,l=r-c}for(s++;s<l;){var u=s+(l-s>>>1);0<a(e,t[i+u])?s=u+1:l=u}return l}function Ts(e,t,i,n,r,a){var s=0,o=0,l=1;if(a(e,t[i+r])<0){for(o=r+1;l<o&&a(e,t[i+r-l])<0;)(l=1+((s=l)<<1))<=0&&(l=o);o<l&&(l=o);var c=s;s=r-l,l=r-c}else{for(o=n-r;l<o&&0<=a(e,t[i+r+l]);)(l=1+((s=l)<<1))<=0&&(l=o);o<l&&(l=o),s+=r,l+=r}for(s++;s<l;){var u=s+(l-s>>>1);a(e,t[i+u])<0?l=u:s=u+1}return l}var Es=function(){function i(e,t){y(this,i),this.array=void 0,this.compare=void 0,this.minGallop=void 0,this.length=void 0,this.tmpStorageLength=void 0,this.tmp=void 0,this.stackLength=void 0,this.runStart=void 0,this.runLength=void 0,this.stackSize=void 0,this.array=e,this.compare=t,this.minGallop=7,this.length=e.length,this.tmpStorageLength=256,this.length<512&&(this.tmpStorageLength=this.length>>>1),this.tmp=new Array(this.tmpStorageLength),this.stackLength=this.length<120?5:this.length<1542?10:this.length<119151?19:40,this.runStart=new Array(this.stackLength),this.runLength=new Array(this.stackLength),this.stackSize=0}return l(i,[{key:"pushRun",value:function(e,t){this.runStart[this.stackSize]=e,this.runLength[this.stackSize]=t,this.stackSize+=1}},{key:"mergeRuns",value:function(){for(;1<this.stackSize;){var e=this.stackSize-2;if(1<=e&&this.runLength[e-1]<=this.runLength[e]+this.runLength[e+1]||2<=e&&this.runLength[e-2]<=this.runLength[e]+this.runLength[e-1])this.runLength[e-1]<this.runLength[e+1]&&e--;else if(this.runLength[e]>this.runLength[e+1])break;this.mergeAt(e)}}},{key:"forceMergeRuns",value:function(){for(;1<this.stackSize;){var e=this.stackSize-2;0<e&&this.runLength[e-1]<this.runLength[e+1]&&e--,this.mergeAt(e)}}},{key:"mergeAt",value:function(e){var t=this.compare,i=this.array,n=this.runStart[e],r=this.runLength[e],a=this.runStart[e+1],s=this.runLength[e+1];this.runLength[e]=r+s,e===this.stackSize-3&&(this.runStart[e+1]=this.runStart[e+2],this.runLength[e+1]=this.runLength[e+2]),this.stackSize--;var o=Ts(i[a],i,n,r,0,t);n+=o,0!==(r-=o)&&0!==(s=ws(i[n+r-1],i,a,s,s-1,t))&&(r<=s?this.mergeLow(n,r,a,s):this.mergeHigh(n,r,a,s))}},{key:"mergeLow",value:function(e,t,i,n){var r=this.compare,a=this.array,s=this.tmp,o=0;for(o=0;o<t;o++)s[o]=a[e+o];var l=0,c=i,u=e;if(a[u++]=a[c++],0!=--n)if(1!==t){for(var h=this.minGallop;;){var f=0,d=0,p=!1;do{if(r(a[c],s[l])<0){if(a[u++]=a[c++],d++,(f=0)==--n){p=!0;break}}else if(a[u++]=s[l++],f++,d=0,1==--t){p=!0;break}}while((f|d)<h);if(p)break;do{if(0!==(f=Ts(a[c],s,l,t,0,r))){for(o=0;o<f;o++)a[u+o]=s[l+o];if(u+=f,l+=f,(t-=f)<=1){p=!0;break}}if(a[u++]=a[c++],0==--n){p=!0;break}if(0!==(d=ws(s[l],a,c,n,0,r))){for(o=0;o<d;o++)a[u+o]=a[c+o];if(u+=d,c+=d,0===(n-=d)){p=!0;break}}if(a[u++]=s[l++],1==--t){p=!0;break}h--}while(7<=f||7<=d);if(p)break;h<0&&(h=0),h+=2}if((this.minGallop=h)<1&&(this.minGallop=1),1===t){for(o=0;o<n;o++)a[u+o]=a[c+o];a[u+n]=s[l]}else{if(0===t)throw new Error("mergeLow preconditions were not respected");for(o=0;o<t;o++)a[u+o]=s[l+o]}}else{for(o=0;o<n;o++)a[u+o]=a[c+o];a[u+n]=s[l]}else for(o=0;o<t;o++)a[u+o]=s[l+o]}},{key:"mergeHigh",value:function(e,t,i,n){var r=this.compare,a=this.array,s=this.tmp,o=0;for(o=0;o<n;o++)s[o]=a[i+o];var l=e+t-1,c=n-1,u=i+n-1,h=0,f=0;if(a[u--]=a[l--],0!=--t)if(1!==n){for(var d=this.minGallop;;){var p=0,_=0,v=!1;do{if(r(s[c],a[l])<0){if(a[u--]=a[l--],p++,(_=0)==--t){v=!0;break}}else if(a[u--]=s[c--],_++,p=0,1==--n){v=!0;break}}while((p|_)<d);if(v)break;do{if(0!==(p=t-Ts(s[c],a,e,t,t-1,r))){for(t-=p,f=(u-=p)+1,h=(l-=p)+1,o=p-1;0<=o;o--)a[f+o]=a[h+o];if(0===t){v=!0;break}}if(a[u--]=s[c--],1==--n){v=!0;break}if(0!==(_=n-ws(a[l],s,0,n,n-1,r))){for(n-=_,f=(u-=_)+1,h=(c-=_)+1,o=0;o<_;o++)a[f+o]=s[h+o];if(n<=1){v=!0;break}}if(a[u--]=a[l--],0==--t){v=!0;break}d--}while(7<=p||7<=_);if(v)break;d<0&&(d=0),d+=2}if((this.minGallop=d)<1&&(this.minGallop=1),1===n){for(f=(u-=t)+1,h=(l-=t)+1,o=t-1;0<=o;o--)a[f+o]=a[h+o];a[u]=s[c]}else{if(0===n)throw new Error("mergeHigh preconditions were not respected");for(h=u-(n-1),o=0;o<n;o++)a[h+o]=s[o]}}else{for(f=(u-=t)+1,h=(l-=t)+1,o=t-1;0<=o;o--)a[f+o]=a[h+o];a[u]=s[c]}else for(h=u-(n-1),o=0;o<n;o++)a[h+o]=s[o]}}]),i}();function Cs(e,t,i,n){if(!Array.isArray(e))throw new TypeError("Can only sort arrays");void 0===t&&(t=0),void 0===i&&(i=e.length),void 0===n&&(n=bs);var r=i-t;if(!(r<2)){var a=0;if(r<ms)Ss(e,t,i,t+(a=xs(e,t,i,n)),n);else{var s=new Es(e,n),o=function(e){for(var t=0;ms<=e;)t|=1&e,e>>=1;return e+t}(r);do{if((a=xs(e,t,i,n))<o){var l=r;o<l&&(l=o),Ss(e,t,t+l,t+a,n),a=l}s.pushRun(t,a),s.mergeRuns(),r-=a,t+=a}while(0!==r);s.forceMergeRuns()}}}for(var As=P2("FixedArray",function(){function t(e){y(this,t),this._count=void 0,this._data=void 0,this._count=0,this._data=new Array(e)}return l(t,[{key:"_resize",value:function(e){if(e>this._data.length)for(var t=this._data.length;t<e;++t)this._data[t]=void 0}},{key:"reset",value:function(){for(var e=0;e<this._count;++e)this._data[e]=void 0;this._count=0}},{key:"push",value:function(e){this._count>=this._data.length&&this._resize(2*this._data.length),this._data[this._count]=e,++this._count}},{key:"pop",value:function(){--this._count,this._count<0&&(this._count=0);var e=this._data[this._count];return this._data[this._count]=void 0,e}},{key:"fastRemove",value:function(e){if(!(e>=this._count||e<0)){var t=this._count-1;this._data[e]=this._data[t],this._data[t]=void 0,this._count-=1}}},{key:"indexOf",value:function(e){return this._data.indexOf(e)}},{key:"sort",value:function(e){return Cs(this._data,0,this._count,e)}},{key:"length",get:function(){return this._count}},{key:"data",get:function(){return this._data}}]),t}()),ks=P2("Pool",function(){function n(e,t){y(this,n),this._fn=void 0,this._idx=void 0,this._frees=void 0,this._fn=e,this._idx=t-1,this._frees=new Array(t);for(var i=0;i<t;++i)this._frees[i]=e()}return l(n,[{key:"alloc",value:function(){this._idx<0&&this._expand(Math.round(1.2*this._frees.length)+1);var e=this._frees[this._idx];return this._frees.splice(this._idx),--this._idx,e}},{key:"free",value:function(e){++this._idx,this._frees[this._idx]=e}},{key:"clear",value:function(e){for(var t=0;t<=this._idx;t++)e&&e(this._frees[t]);this._frees.splice(0),this._idx=-1}},{key:"_expand",value:function(e){var t=this._frees;this._frees=new Array(e);for(var i=e-t.length,n=0;n<i;++n)this._frees[n]=this._fn();for(var r=i,a=0;r<e;++r,++a)this._frees[r]=t[a];this._idx+=i}}]),n}()),Rs=(P2("LinkedArray",function(){function i(e,t){y(this,i),this._fn=void 0,this._count=void 0,this._head=void 0,this._tail=void 0,this._pool=void 0,this._fn=e,this._count=0,this._head=null,this._tail=null,this._pool=new ks(e,t)}return l(i,[{key:"add",value:function(){var e=this._pool.alloc();return this._tail?(this._tail._next=e)._prev=this._tail:this._head=e,this._tail=e,this._count+=1,e}},{key:"remove",value:function(e){e._prev?e._prev._next=e._next:this._head=e._next,e._next?e._next._prev=e._prev:this._tail=e._prev,e._next=null,e._prev=null,this._pool.free(e),this._count-=1}},{key:"forEach",value:function(e,t){var i=this._head;if(i){t&&(e=e.bind(t));for(var n=0,r=i;i;)r=i._next,e(i,n,this),i=r,++n}}},{key:"head",get:function(){return this._head}},{key:"tail",get:function(){return this._tail}},{key:"length",get:function(){return this._count}}]),i}()),P2("RecyclePool",function(){function n(e,t){y(this,n),this._fn=void 0,this._count=0,this._data=void 0,this._fn=e,this._data=new Array(t);for(var i=0;i<t;++i)this._data[i]=e()}return l(n,[{key:"reset",value:function(){this._count=0}},{key:"resize",value:function(e){if(e>this._data.length)for(var t=this._data.length;t<e;++t)this._data[t]=this._fn()}},{key:"add",value:function(){return this._count>=this._data.length&&this.resize(2*this._data.length),this._data[this._count++]}},{key:"removeAt",value:function(e){if(!(e>=this._count)){var t=this._count-1,i=this._data[e];this._data[e]=this._data[t],this._data[t]=i,this._count-=1}}},{key:"sort",value:function(e){return Cs(this._data,0,this._count,e)}},{key:"length",get:function(){return this._count}},{key:"data",get:function(){return this._data}}]),n}())),Os=Array(8),Ms=0;Ms<8;++Ms)Os[Ms]=[];function Is(e){var t=(65535<e)<<4,i=(255<(e>>>=t))<<3;return t|=i,t|=i=(15<(e>>>=i))<<2,(t|=i=(3<(e>>>=i))<<1)|(e>>>=i)>>1}function Ls(e){var t=function(e){for(var t=16;t<=1<<28;t*=16)if(e<=t)return t;return 0}(e),i=Os[Is(t)>>2];return 0<i.length?i.pop():new ArrayBuffer(t)}function zs(e,t,i,n,r){return Fi.set(e,t.x*i,t.y*n,t.z*r)}P2("TypedArrayPool",{alloc_int8:function(e){var t=new Int8Array(Ls(e),0,e);return t.length!==e?t.subarray(0,e):t},alloc_uint8:function(e){var t=new Uint8Array(Ls(e),0,e);return t.length!==e?t.subarray(0,e):t},alloc_int16:function(e){var t=new Int16Array(Ls(2*e),0,e);return t.length!==e?t.subarray(0,e):t},alloc_uint16:function(e){var t=new Uint16Array(Ls(2*e),0,e);return t.length!==e?t.subarray(0,e):t},alloc_int32:function(e){var t=new Int32Array(Ls(4*e),0,e);return t.length!==e?t.subarray(0,e):t},alloc_uint32:function(e){var t=new Uint32Array(Ls(4*e),0,e);return t.length!==e?t.subarray(0,e):t},alloc_float32:function(e){var t=new Float32Array(Ls(4*e),0,e);return t.length!==e?t.subarray(0,e):t},alloc_float64:function(e){var t=new Float64Array(Ls(8*e),0,e);return t.length!==e?t.subarray(0,e):t},free:function(e){!function(e){Os[Is(e.byteLength)>>2].push(e)}(e.buffer)},reset:function(){Os=Array(8);for(var e=0;e<8;++e)Os[e]=[]}});function Bs(){y(this,Bs),this.time=0,this.value=0,this.inTangent=0,this.outTangent=0}var Ps=function(){function s(e,t,i,n,r,a){y(this,s),this.minPos=void 0,this.maxPos=void 0,this.boundingBox=void 0,this.capacity=void 0,this.depth=void 0,this.maxDepth=void 0,this.blocks=void 0,this.entries=void 0,this._getBoundingShape=void 0,this.minPos=e,this.maxPos=t,this.boundingBox=cs.fromPoints(cs.create(),e,t),this.capacity=i,this.depth=n,this.maxDepth=r,this._getBoundingShape=a,this.blocks=null,this.entries=new As(this.capacity)}return l(s,[{key:"addEntry",value:function(e){if(this.blocks){var t=this.blocks,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.addEntry(e)}}else{var a=this._getBoundingShape(e);if(!ja.resolve(this.boundingBox,a))return;this.entries.push(e),this.entries.length>=this.capacity&&this.depth<this.maxDepth&&(this.blocks=Ds.createBlocks(this.minPos,this.maxPos,this.entries,this.capacity,this.depth,this.maxDepth,this._getBoundingShape),this.entries.reset())}}},{key:"removeEntry",value:function(e){if(this.blocks){var t=this.blocks,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.removeEntry(e)}}else this.entries.fastRemove(this.entries.indexOf(e))}},{key:"select",value:function(e,t){if(ja.resolve(this.boundingBox,t))if(this.blocks){var i=this.blocks,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}a.select(e,t)}}else for(var s=0;s<this.entries.length;s++)e.add(this.entries.data[s])}},{key:"frustumSelect",value:function(e,t){if(ja.aabb_frustum(this.boundingBox,t))if(this.blocks){var i=this.blocks,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}a.frustumSelect(e,t)}}else for(var s=0;s<this.entries.length;s++)e.add(this.entries.data[s])}}]),s}(),Ds=function(){function u(){var e=this,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:32,i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:5;y(this,u),this.blockCapacity=void 0,this.maxDepth=void 0,this.blocks=void 0,this.dynamics=void 0,this._selection=void 0,this._getBoundingShape=void 0,this.blockCapacity=t,this.maxDepth=i,this.blocks=[],this.dynamics=[],this._selection=new Set,this._getBoundingShape=function(){return e._getBoundingShape}}return l(u,null,[{key:"createBlocks",value:function(e,t,i,n,r,a,s){var o=[],l=new Fi;Fi.multiplyScalar(l,Fi.subtract(l,t,e),.5);for(var c=0;c<2;c++)for(var u=0;u<2;u++)for(var h=0;h<2;h++){var f=new Fi,d=new Fi;Fi.add(f,e,zs(f,l,c,u,h)),Fi.add(d,e,zs(d,l,c+1,u+1,h+1));for(var p=new Ps(f,d,n,r+1,a,s),_=0;_<i.length;_++){var v=(i.data||i)[_];p.addEntry(v)}o.push(p)}return o}}]),l(u,[{key:"build",value:function(e,t){var i=new Fi(1/0,1/0,1/0),n=new Fi(-1/0,-1/0,-1/0),r=new Fi,a=new Fi,s=[];this.dynamics=[];for(var o=0;o<e.length;o++){var l=(e.data||e)[o],c=t(l);c?(c.getBoundary(r,a),Fi.min(i,i,r),Fi.max(n,n,a),s.push(l)):this.dynamics.push(l)}this.blocks=u.createBlocks(i,n,s,this.blockCapacity,0,this.maxDepth,t),this._getBoundingShape=t}},{key:"addEntry",value:function(e){if(this._getBoundingShape(e).shape){var t=this.blocks,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.addEntry(e)}}else this.dynamics.push(e)}},{key:"removeEntry",value:function(e){if(this._getBoundingShape(e).shape){var t=this.blocks,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.removeEntry(e)}}else this.dynamics.splice(this.dynamics.indexOf(e),1)}},{key:"select",value:function(e){this._selection.clear();var t=this.blocks,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.select(this._selection,e)}var a=this.dynamics,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}var c=l;this._selection.add(c)}return this._selection}},{key:"frustumSelect",value:function(e){this._selection.clear();var t=this.blocks,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.frustumSelect(this._selection,e)}var a=this.dynamics,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}var c=l;this._selection.add(c)}return this._selection}}]),u}(),Fs=vt({Default:0,Once:1,Loop:2,PingPong:3,ClampForever:4});ai.fastDefine("cc.Keyframe",Bs,{time:0,value:0,inTangent:0,outTangent:0});var Ns=function(){function e(){y(this,e),this.index=void 0,this.time=void 0,this.endTime=void 0,this.coefficient=void 0,this.index=-1,this.time=0,this.endTime=0,this.coefficient=new Float32Array(4)}return l(e,[{key:"evaluate",value:function(e){return function(e,t){return e*(e*(e*t[0]+t[1])+t[2])+t[3]}(e-this.time,this.coefficient)}}]),e}();var Us=function(){function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null;y(this,t),this.keyFrames=void 0,this.preWrapMode=Fs.Loop,this.postWrapMode=Fs.Loop,this.cachedKey=void 0,this.keyFrames=e||[].concat(t.defaultKF),this.cachedKey=new Ns}return l(t,[{key:"addKey",value:function(e){null==this.keyFrames&&(this.keyFrames=[]),this.keyFrames.push(e)}},{key:"evaluate_slow",value:function(e){var t=e,i=e<0?this.preWrapMode:this.postWrapMode,n=this.keyFrames[0].time,r=this.keyFrames[this.keyFrames.length-1].time;switch(i){case Fs.Loop:t=Ci(e-n,r-n)+n;break;case Fs.PingPong:t=Ai(e-n,r-n)+n;break;case Fs.ClampForever:t=pi(e,n,r)}var a=0;if(t>this.keyFrames[0].time)if(t>=this.keyFrames[this.keyFrames.length-1].time)a=this.keyFrames.length-2;else for(var s=0;s<this.keyFrames.length-1;s++)if(t>=this.keyFrames[0].time&&t<=this.keyFrames[s+1].time){a=s;break}var o=this.keyFrames[a],l=this.keyFrames[a+1],c=ki(o.time,l.time,t),u=l.time-o.time,h=o.outTangent*u,f=l.inTangent*u,d=c*c,p=d*c,_=p-2*d+c,v=p-d,m=-2*p+3*d;return(2*p-3*d+1)*o.value+_*h+v*f+m*l.value}},{key:"evaluate",value:function(e){var t=e,i=e<0?this.preWrapMode:this.postWrapMode,n=this.keyFrames[0].time,r=this.keyFrames[this.keyFrames.length-1].time;switch(i){case Fs.Loop:t=Ci(e-n,r-n)+n;break;case Fs.PingPong:t=Ai(e-n,r-n)+n;break;case Fs.ClampForever:t=pi(e,n,r)}if(t>=this.cachedKey.time&&t<this.cachedKey.endTime)return this.cachedKey.evaluate(t);var a=this.findIndex(this.cachedKey,t),s=a+1;return s===this.keyFrames.length&&(s-=1),this.calcOptimizedKey(this.cachedKey,a,s),this.cachedKey.evaluate(t)}},{key:"calcOptimizedKey",value:function(e,t,i){var n=this.keyFrames[t],r=this.keyFrames[i];e.index=t,e.time=n.time,e.endTime=r.time;var a=r.time-n.time,s=r.value-n.value,o=1/(a*a),l=n.outTangent*a,c=r.inTangent*a;e.coefficient[0]=(l+c-s-s)*o/a,e.coefficient[1]=(s+s+s-l-l-c)*o,e.coefficient[2]=n.outTangent,e.coefficient[3]=n.value}},{key:"findIndex",value:function(e,t){var i=e.index;if(-1!==i)if(this.keyFrames[i].time<t)for(var n=0;n<3;n++){var r=i+n;if(r+1<this.keyFrames.length&&this.keyFrames[r+1].time>t)return r}else for(var a=0;a<3;a++){var s=i-a;if(0<=s&&this.keyFrames[s-1].time<=t)return s-1}for(var o=0,l=this.keyFrames.length,c=Math.floor((o+l)/2);1<l-o;)this.keyFrames[c].time>=t?l=c:o=c+1,c=Math.floor((o+l)/2);return o}}]),t}();Us.defaultKF=[{time:0,value:1,inTangent:0,outTangent:0},{time:1,value:1,inTangent:0,outTangent:0}],ai.fastDefine("cc.AnimationCurve",Us,{preWrapMode:Fs.Default,postWrapMode:Fs.Default,keyFrames:[]}),sr(Wa.prototype,"line",[{name:"mag",newName:"len"},{name:"magnitude",newName:"len"}]);var Vs=Object.freeze({distance:ha,enums:_r,intersect:ja,line:Wa,plane:Za,ray:Ja,triangle:$a,sphere:ns,aabb:cs,obb:ds,frustum:vs,Octree:Ds,Keyframe:Bs,AnimationCurve:Us});P2("geometry",Vs);var Gs=/([a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûа-яА-ЯЁё]+|\S)/,Hs=/^[!,.:;'}\]%\?>、‘“》？。，！]/,qs=/([a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]+|\S)$/,js=/[a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]+$/,Ws=/^[a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]/;function Xs(e){return/^[\u4E00-\u9FFF\u3400-\u4DFF]+$/.test(e)||/[\u3000-\u303F]|[\u3040-\u309F]|[\u30A0-\u30FF]|[\uFF00-\uFFEF]|[\u4E00-\u9FAF]|[\u2605-\u2606]|[\u2190-\u2195]|\u203B/g.test(e)||/^[\u1100-\u11FF]|[\u3130-\u318F]|[\uA960-\uA97F]|[\uAC00-\uD7AF]|[\uD7B0-\uD7FF]+$/.test(e)}function Ys(e){var t=e.charCodeAt(0);return 9<=t&&t<=13||32===t||133===t||160===t||5760===t||8192<=t&&t<=8202||8232===t||8233===t||8239===t||8287===t||12288===t}function Qs(e,t){var i=e.measureText(t);return i&&i.width||0}function Ks(e,t,i,n){var r=[];if(0===e.length||i<0)return r.push(""),r;for(var a=e;i<t&&1<a.length;){for(var s=a.length*(i/t)|0,o=a.substr(s),l=t-n(o),c=o,u=0,h=0;i<l&&h++<10;)s*=i/l,s|=0,l=t-n(o=a.substr(s));for(h=0;l<=i&&h++<10;){if(o){var f=Gs.exec(o);u=f?f[0].length:1,c=o}s+=u,l=t-n(o=a.substr(s))}0===(s-=u)&&(s=1,c=c.substr(1));var d=a.substr(0,s),p=void 0;Hs.test(c||o)&&(0===(s-=(p=qs.exec(d))?p[0].length:0)&&(s=1),c=a.substr(s),d=a.substr(0,s)),Ws.test(c)&&(p=js.exec(d))&&d!==p[0]&&(s-=p[0].length,c=a.substr(s),d=a.substr(0,s)),0===r.length?r.push(d):0<(d=d.trim()).length&&r.push(d),t=n(a=c||o)}return 0===r.length?r.push(a):0<(a=a.trim()).length&&r.push(a),r}var Zs=/^(click)(\s)*=|(param)(\s)*=/,Js=/(\s)*src(\s)*=|(\s)*height(\s)*=|(\s)*width(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/,$s=P2("HtmlTextParser",function(){function e(){y(this,e),this._specialSymbolArray=[],this._stack=[],this._resultObjectArray=[],this._specialSymbolArray.push([/&lt;/g,"<"]),this._specialSymbolArray.push([/&gt;/g,">"]),this._specialSymbolArray.push([/&amp;/g,"&"]),this._specialSymbolArray.push([/&quot;/g,'"']),this._specialSymbolArray.push([/&apos;/g,"'"])}return l(e,[{key:"parse",value:function(e){this._resultObjectArray.length=0;for(var t=this._stack.length=0,i=e.length;t<i;){var n=e.indexOf("<",t);if(n<0)this._stack.pop(),this._processResult(e.substring(t)),t=i;else{this._processResult(e.substring(t,n));var r=e.indexOf(">",t);-1===r?r=n:"/"===e.charAt(n+1)?this._stack.pop():this._addToStack(e.substring(n+1,r)),t=r+1}}return this._resultObjectArray}},{key:"_attributeToObject",value:function(e){var t={},i=(e=e.trim()).match(/^(color|size)(\s)*=/),n="",r=0,a="";if(i){if(n=i[0],""===(e=e.substring(n.length).trim()))return t;switch(r=e.indexOf(" "),n[0]){case"c":t.color=-1<r?e.substring(0,r).trim():e;break;case"s":t.size=parseInt(e)}return-1<r&&(a=e.substring(r+1).trim(),t.event=this._processEventHandler(a)),t}if((i=e.match(/^(br(\s)*\/)/))&&0<i[0].length&&(n=i[0].trim()).startsWith("br")&&"/"===n[n.length-1])return t.isNewLine=!0,this._resultObjectArray.push({text:"",style:{newline:!0}}),t;var s="";if((i=e.match(/^(img(\s)*src(\s)*=[^>]+\/)/))&&0<i[0].length&&(n=i[0].trim()).startsWith("img")&&"/"===n[n.length-1]){var o;i=e.match(Js);for(var l=!1;i;)n=(e=e.substring(e.indexOf(i[0]))).substr(0,i[0].length),o=-1<(r=(s=e.substring(n.length).trim()).indexOf(" "))?s.substr(0,r):s,n=(n=n.replace(/[^a-zA-Z]/g,"").trim()).toLocaleLowerCase(),e=s.substring(r).trim(),"src"===n?(t.isImage=!0,o.endsWith("/")&&(o=o.substring(0,o.length-1)),0===o.indexOf("'")?(l=!0,o=o.substring(1,o.length-1)):0===o.indexOf('"')&&(l=!0,o=o.substring(1,o.length-1)),t.src=o):"height"===n?t.imageHeight=parseInt(o):"width"===n?t.imageWidth=parseInt(o):"click"===n&&(t.event=this._processEventHandler(n+"="+o)),t.event&&"param"===n&&(t.event[n]=o.replace(/^\"|\"$/g,"")),i=e.match(Js);return l&&t.isImage&&this._resultObjectArray.push({text:"",style:t}),{}}if(i=e.match(/^(outline(\s)*[^>]*)/)){var c={color:"#ffffff",width:1};if(e=i[0].substring("outline".length).trim()){var u,h=/(\s)*color(\s)*=|(\s)*width(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/;for(i=e.match(h);i;)n=(e=e.substring(e.indexOf(i[0]))).substr(0,i[0].length),u=-1<(r=(s=e.substring(n.length).trim()).indexOf(" "))?s.substr(0,r):s,n=(n=n.replace(/[^a-zA-Z]/g,"").trim()).toLocaleLowerCase(),e=s.substring(r).trim(),"click"===n?t.event=this._processEventHandler(n+"="+u):"color"===n?c.color=u:"width"===n&&(c.width=parseInt(u)),t.event&&"param"===n&&(t.event[n]=u.replace(/^\"|\"$/g,"")),i=e.match(h)}t.outline=c}if((i=e.match(/^(on|u|b|i)(\s)*/))&&0<i[0].length){switch(n=i[0],e=e.substring(n.length).trim(),n[0]){case"u":t.underline=!0;break;case"i":t.italic=!0;break;case"b":t.bold=!0}if(""===e)return t;t.event=this._processEventHandler(e)}return t}},{key:"_processEventHandler",value:function(e){for(var t=0,i=new Map,n=e.match(Zs),r=!1;n;){var a=n[0],s="";if(r=!1,'"'===(e=e.substring(a.length).trim()).charAt(0))-1<(t=e.indexOf('"',1))&&(s=e.substring(1,t).trim(),r=!0),t++;else if("'"===e.charAt(0))-1<(t=e.indexOf("'",1))&&(s=e.substring(1,t).trim(),r=!0),t++;else{var o=e.match(/(\S)+/);t=(s=o?o[0]:"").length}r&&(i[a=a.substring(0,a.length-1).trim()]=s),n=(e=e.substring(t).trim()).match(Zs)}return i}},{key:"_addToStack",value:function(e){var t=this._attributeToObject(e);if(0===this._stack.length)this._stack.push(t);else{if(t.isNewLine||t.isImage)return;var i=this._stack[this._stack.length-1];for(var n in i)t[n]||(t[n]=i[n]);this._stack.push(t)}}},{key:"_processResult",value:function(e){0!==e.length&&(e=this._escapeSpecialSymbol(e),0<this._stack.length?this._resultObjectArray.push({text:e,style:this._stack[this._stack.length-1]}):this._resultObjectArray.push({text:e}))}},{key:"_escapeSpecialSymbol",value:function(e){var t=this._specialSymbolArray,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r,s=a[0],o=a[1];e=e.replace(s,o)}return e}}]),e}());var eo="__ccclassCache__";function to(e){return e}function io(e,t){return e[t]||(e[t]={})}function no(i){return function(t){return"function"==typeof t?i(t):function(e){return i(e,t)}}}function ro(e,i,t){return function(t){return function(e){return i(e,t)}}}var ao=ro.bind(null,!1);function so(){return ro.bind(null,!1)}var oo=so(),lo=so();function co(e){return io(e,eo)}function uo(e,t,i,n,r,a){var s;n&&(s=(s=Dt(n))||n);var o=Ne(t[i]||{},s||{});if(r&&(r.get||r.set)){r.get&&(o.get=r.get),r.set&&(o.set=r.set)}else{var l;0;if(r)r.initializer&&(l=function(t){var e;try{e=t()}catch(e){return t}return"object"!==de(e)||null===e?e:t}(r.initializer),!0);else{var c=a.default||(a.default=function(e){var t;try{t=new e}catch(e){return{}}return t}(e));c.hasOwnProperty(i)&&(l=c[i],!0)}0,o.default=l}t[i]=o}var ho=no(function(e,t){var i=Ve(e);i===Object&&(i=null);var n={name:t,extends:i,ctor:e,__ES6__:!0},r=e[eo];if(r){var a=r.proto;a&&Ne(n,a),e[eo]=void 0}return cc.Class(n)});function fo(e,t,i){var a=null;function n(e,t,i){var n=co(e.constructor);if(n){var r=io(io(n,"proto"),"properties");uo(e.constructor,r,t,a,i,n)}}if(void 0===t)return a=e,n;n(e,t,i)}function po(e,r,a){return e(function(e,t){var i=co(e);if(i){var n=void 0!==a?a:t;io(io(i,"proto"),"editor")[r]=n}},r)}function _o(e){return e(to)}var vo=_o(no),mo=po(ao,"requireComponent"),yo=_o(oo),go=po(lo,"executionOrder"),bo=_o(no),xo=_o(no),So=_o(oo),wo=_o(oo),To=_o(oo);var Eo,Co,Ao,ko,Ro,Oo,Mo,Io=Object.freeze({ccclass:ho,property:fo,executeInEditMode:vo,requireComponent:mo,menu:yo,executionOrder:go,disallowMultiple:bo,playOnFocus:xo,inspector:So,icon:wo,help:To,mixins:function(){for(var i=[],e=0;e<arguments.length;e++)i[e]=e<0||arguments.length<=e?void 0:arguments[e];return function(e){var t=co(e);t&&(io(t,"proto").mixins=i)}}});P2("_decorator",Io);var Lo=P2("PrefabInfo",ho("cc.PrefabInfo")((Ao=m((Co=function e(){y(this,e),v(this,"root",Ao,this),v(this,"asset",ko,this),v(this,"fileId",Ro,this),v(this,"sync",Oo,this),v(this,"_synced",Mo,this)}).prototype,"root",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ko=m(Co.prototype,"asset",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ro=m(Co.prototype,"fileId",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Oo=m(Co.prototype,"sync",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Mo=m(Co.prototype,"_synced",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{default:!1,serializable:!1}}}),Eo=Co))||Eo);cc._PrefabInfo=Lo;var zo=new Fi;function Bo(e,t,i,n){n=n||new Fi,e.worldToScreen(t,zo),zo.x=zo.x/cc.view.getScaleX(),zo.y=zo.y/cc.view.getScaleY();var r=i.getComponent("cc.UITransformComponent");if(!r)return n;r.convertToNodeSpaceAR(zo,n);var a=i.getPosition();return n.add(a),n}function Po(e,t,i){return i=i||new Fi,e.worldToScreen(t,i),i.x=i.x/cc.view.getScaleX(),i.y=i.y/cc.view.getScaleY(),i}var Do=P2("convertUtils",{WorldNode3DToLocalNodeUI:Bo,WorldNode3DToWorldNodeUI:Po});cc.pipelineUtils=Do;var Fo=[];var No=P2("CCObject",function(){function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"";y(this,t),this._objFlags=void 0,this._name=void 0,this._name=e,this._objFlags=0}return l(t,null,[{key:"_deferredDestroy",value:function(){for(var e=Fo.length,t=0;t<e;++t){var i=Fo[t];1&i._objFlags||i._destroyImmediate()}e===Fo.length?Fo.length=0:Fo.splice(0,e)}}]),l(t,[{key:"destroy",value:function(){return 1&this._objFlags?(cc.warnID(5e3),!1):!(4&this._objFlags)&&(this._objFlags|=4,Fo.push(this),!0)}},{key:"_destruct",value:function(){var e=this.constructor,t=e.__destruct__;t||(t=function(e,t){var i,n=e instanceof cc._BaseNode||e instanceof cc.Component,r=n?"_id":null,a={};for(i in e)if(e.hasOwnProperty(i)){if(i===r)continue;switch(de(e[i])){case"string":a[i]="";break;case"object":case"function":a[i]=null}}if(ai._isCCClass(t))for(var s=cc.Class.Attr.getClassAttrs(t),o=t.__props__,l=0;l<o.length;l++){var c=(i=o[l])+cc.Class.Attr.DELIMETER+"default";if(c in s){if(n&&"_id"===i)continue;switch(de(s[c])){case"string":a[i]="";break;case"object":case"function":a[i]=null;break;case"undefined":a[i]=void 0}}}return function(e){for(var t in a)e[t]=a[t]}}(this,e),Te(e,"__destruct__",t,!0)),t(this)}},{key:"_destroyImmediate",value:function(){1&this._objFlags?cc.errorID(5e3):(this._onPreDestroy&&this._onPreDestroy(),this._destruct(),this._objFlags|=1)}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"isValid",get:function(){return!(1&this._objFlags)}}]),t}()),Uo=No.prototype;Uo._deserialize=null,Uo._onPreDestroy=null,ai.fastDefine("cc.Object",No,{_name:"",_objFlags:0}),Te(No,"Flags",{Destroyed:1,DontSave:8,EditorOnly:16,Dirty:32,DontDestroy:64,PersistentMask:-4192741,Destroying:128,Deactivating:256,LockedInEditor:512,HideInHierarchy:1024,IsPreloadStarted:8192,IsOnLoadStarted:32768,IsOnLoadCalled:16384,IsOnEnableCalled:2048,IsStartCalled:65536,IsEditorOnEnableCalled:4096,IsPositionLocked:1<<21,IsRotationLocked:1<<17,IsScaleLocked:1<<18,IsAnchorLocked:1<<19,IsSizeLocked:1<<20}),cc.isValid=function(e,t){return"object"===de(e)?!(!e||e._objFlags&(t?5:1)):void 0!==e},cc.Object=No;var Vo=function(){function e(){y(this,e),this.assignAssetsBy=void 0,this.uuidList=void 0,this.uuidObjList=void 0,this.uuidPropList=void 0,this._stillUseUrl=void 0,this.uuidList=[],this.uuidObjList=[],this.uuidPropList=[],this._stillUseUrl=ke(!0)}return l(e,[{key:"reset",value:function(){this.uuidList.length=0,this.uuidObjList.length=0,this.uuidPropList.length=0,He(this._stillUseUrl)}},{key:"push",value:function(e,t,i,n){n&&(this._stillUseUrl[this.uuidList.length]=!0),this.uuidList.push(i),this.uuidObjList.push(e),this.uuidPropList.push(t)}}]),e}();Vo.pool=void 0,Vo.pool=new Je(function(e){e.reset()},10),Vo.pool.get=function(){return this._get()||new Vo};var Go=function(e,p){var _,v=tt.test(Ze(p)),h=cc.js.isChildClassOf(p,cc._BaseNode)||cc.js.isChildClassOf(p,cc.Component),m=[],y=m,g=[],b=g,x=[],S=[];return function(){var e=p.__values__;_="_$erialized"===e[e.length-1];for(var t=wt(p),i=gt+"type",n=gt+"default",r=gt+"saveUrlAsAsset",a=gt+"formerlySerializedAs",s=0;s<e.length;s++){var o=e[s],l=o;t[o+a]&&(l=t[o+a]);var c=t[o+r],u=ai.getDefault(t[o+n]),h=!1;if(v){var f=t[o+i];if(void 0===u&&f)h=f===cc.String||f===cc.Integer||f===cc.Float||f===cc.Boolean;else{var d=de(u);h="string"===d&&!c||"number"===d||"boolean"===d}}v&&h?(l!==o&&y===m&&(y=m.slice()),m.push(o),y!==m&&y.push(l)):(l!==o&&b===g&&(b=g.slice()),g.push(o),b!==g&&b.push(l),x.push(c),S.push(u instanceof cc.ValueType&&u.constructor))}}(),function(e,t,i,n,r){for(var a=0;a<m.length;++a){var s=i[y[a]];void 0!==s&&(t[m[a]]=s)}for(var o=0;o<g.length;++o){var l=g[o],c=i[b[o]];if(void 0!==c)if(v||"object"===de(c)){var u=S[o];u?v||c?e._deserializeTypedObject(t[l],c,u):t[l]=null:c?e._deserializeObjField(t,c,l,null,x[o]):t[l]=null}else t[l]=c}h&&i._id&&(t._id=i._id),_&&(t._$erialized=JSON.parse(JSON.stringify(i)),e._deserializePrimitiveObject(t._$erialized,i))}};function Ho(e,t,i,n,r){var a;n.hasOwnProperty("__deserialize__")?a=n.__deserialize__:(a=Go(e,n),Te(n,"__deserialize__",a,!0)),a(e,t,i,n,r),t.__postDeserialize&&t.__postDeserialize()}var qo=function(){function a(e,t,i,n,r){y(this,a),this.result=void 0,this.customEnv=void 0,this.deserializedList=void 0,this.deserializedData=void 0,this._classFinder=void 0,this._target=void 0,this._ignoreEditorOnly=void 0,this._idList=void 0,this._idObjList=void 0,this._idPropList=void 0,this.result=e,this.customEnv=n,this.deserializedList=[],this.deserializedData=null,this._classFinder=i,this._idList=[],this._idObjList=[],this._idPropList=[]}return l(a,[{key:"deserialize",value:function(e){if(Array.isArray(e)){var t=e,i=t.length;this.deserializedList.length=i;for(var n=0;n<i;n++){if(t[n])this.deserializedList[n]=this._deserializeObject(t[n],!1)}this.deserializedData=0<i?this.deserializedList[0]:[]}else this.deserializedList.length=1,this.deserializedData=e?this._deserializeObject(e,!1):null,this.deserializedList[0]=this.deserializedData;return function(e){var t,i,n,r=e.deserializedList,a=e._idPropList,s=e._idList,o=e._idObjList;for(e._classFinder&&e._classFinder.onDereferenced,t=0;t<s.length;t++)i=a[t],n=s[t],o[t][i]=r[n]}(this),this.deserializedData}},{key:"_deserializeObject",value:function(e,t,i,n,r){var a,s=null,o=null,l=e.__type__;if("TypedArray"===l){var c=e.array;s=new window[e.ctor](c.length);for(var u=0;u<c.length;++u)s[u]=c[u];return s}if(l){var h=function(){(s=new o)._deserialize?s._deserialize(e.content,f):cc.Class._isCCClass(o)?Ho(f,s,e,o,i):f._deserializeTypedObject(s,e,o)};if(!(o=this._classFinder(l,e,n,r)))return this._classFinder===Qe&&cc.deserialize.reportMissingClass(l),null;var f=this;h()}else if(Array.isArray(e)){s=new Array(e.length);for(var d=0;d<e.length;d++)"object"===de(a=e[d])&&a?this._deserializeObjField(s,a,""+d,null,t):s[d]=a}else s={},this._deserializePrimitiveObject(s,e);return s}},{key:"_deserializeObjField",value:function(e,t,i,n,r){var a=t.__id__;if(void 0===a){var s=t.__uuid__;s?this.result.push(e,i,s,r):e[i]=this._deserializeObject(t,r)}else{var o=this.deserializedList[a];o?e[i]=o:(this._idList.push(a),this._idObjList.push(e),this._idPropList.push(i))}}},{key:"_deserializePrimitiveObject",value:function(e,t){for(var i in t)if(t.hasOwnProperty(i)){var n=t[i];"object"!==de(n)?"__type__"!==i&&(e[i]=n):n?this._deserializeObjField(e,n,i):e[i]=null}}},{key:"_deserializeTypedObject",value:function(e,t,i){if(i===cc.Vec2)return e.x=t.x||0,void(e.y=t.y||0);if(i===cc.Vec3)return e.x=t.x||0,e.y=t.y||0,void(e.z=t.z||0);if(i!==cc.Color){if(i===cc.Size)return e.width=t.width||0,void(e.height=t.height||0);for(var n=gt+"default",r=wt(i),a=i.__props__||Object.keys(e),s=0;s<a.length;s++){var o=a[s],l=t[o];void 0!==l&&t.hasOwnProperty(o)||(l=ai.getDefault(r[o+n])),"object"!==de(l)?e[o]=l:l?this._deserializeObjField(e,l,o):e[o]=null}}else{e.r=t.r||0,e.g=t.g||0,e.b=t.b||0;var c=t.a;e.a=void 0===c?255:c}}}]),a}();function jo(e,t,i){var n=(i=i||{}).classFinder||Qe,r=i.createAssetRefs||cc.sys.platform===cc.sys.EDITOR_CORE,a=i.customEnv,s=i.ignoreEditorOnly;"string"==typeof e&&(e=JSON.parse(e));var o=!t;t=t||Vo.pool.get();var l=qo.pool.get(t,!1,n,a,s);cc.game._isCloning=!0;var c=l.deserialize(e);return cc.game._isCloning=!1,qo.pool.put(l),r&&t.assignAssetsBy(Editor.serialize.asAsset),o&&Vo.pool.put(t),c}qo.pool=void 0,qo.pool=new Je(function(e){e.result=null,e.customEnv=null,e.deserializedList.length=0,e.deserializedData=null,e._classFinder=null,e._idList.length=0,e._idObjList.length=0,e._idPropList.length=0},1),qo.pool.get=function(e,t,i,n,r){var a=this._get();return a?(a.result=e,a.customEnv=n,a._classFinder=i,a):new qo(e,t,i,n,r)},jo.Details=Vo,jo.reportMissingClass=function(e){cc.warnID(5302,e)},cc.deserialize=jo,P2("deserialize",jo);var Wo=No.Flags.Destroyed,Xo=No.Flags.PersistentMask,Yo=[];function Qo(e,t){if(!t){if("object"!==de(e)||Array.isArray(e))return null;if(!e)return null;if(!cc.isValid(e))return null;0}var i;if(e instanceof No){if((e=e)._instantiate)return cc.game._isCloning=!0,i=e._instantiate(),cc.game._isCloning=!1,i;if(e instanceof cc.Asset)return null}return cc.game._isCloning=!0,i=Ko(e),cc.game._isCloning=!1,i}function Ko(e,t){if(Array.isArray(e))return null;if(ut(e))return null;var i;if(e._iN$t)i=e._iN$t;else if(e.constructor){i=new e.constructor}else i=Object.create(null);Zo(e,i,t);for(var n=0,r=Yo.length;n<r;++n)Yo[n]._iN$t=null;return Yo.length=0,i}function Zo(e,t,i){Te(e,"_iN$t",t,!0),Yo.push(e);var n=e.constructor;if(cc.Class._isCCClass(n))!function(e,t,i,n){for(var r=e.__values__,a=0;a<r.length;a++){var s=r[a],o=t[s];if("object"===de(o)&&o){var l=i[s];l instanceof yt&&l.constructor===o.constructor?l.set(o):i[s]=o._iN$t||Jo(o,n)}else i[s]=o}}(n,e,t,i);else for(var r in e)if(e.hasOwnProperty(r)&&(95!==r.charCodeAt(0)||95!==r.charCodeAt(1)||"__type__"===r)){var a=e[r];if("object"===de(a)&&a){if(a===t)continue;t[r]=a._iN$t||Jo(a,i)}else t[r]=a}e instanceof No&&(t._objFlags&=Xo)}function Jo(e,t){if(e instanceof yt)return e.clone();if(e instanceof cc.Asset)return e;var i;if(Array.isArray(e)){var n=e.length;i=new Array(n),e._iN$t=i;for(var r=0;r<n;++r){var a=e[r];"object"===de(a)&&a?i[r]=a._iN$t||Jo(a,t):i[r]=a}return Yo.push(e),i}if(e._objFlags&Wo)return null;var s=e.constructor;if(cc.Class._isCCClass(s)){if(t)if(t instanceof cc.Component){if(e instanceof cc._BaseNode||e instanceof cc.Component)return e}else if(t instanceof cc._BaseNode)if(e instanceof cc._BaseNode){if(!e.isChildOf(t))return e}else if(e instanceof cc.Component&&!e.node.isChildOf(t))return e;i=new s}else if(s===Object)i={};else{if(s)return e;i=Object.create(null)}return Zo(e,i,t),i}Qo._clone=Ko,cc.instantiate=Qo,P2("instantiate",Qo),cc._decorator=Io;var $o=P2("Event",function(){function i(e,t){y(this,i),this.type=void 0,this.bubbles=void 0,this.target=null,this.currentTarget=null,this.eventPhase=0,this.propagationStopped=!1,this.propagationImmediateStopped=!1,this.type=e,this.bubbles=!!t}return l(i,[{key:"unuse",value:function(){this.type=i.NO_TYPE,this.target=null,this.currentTarget=null,this.eventPhase=i.NONE,this.propagationStopped=!1,this.propagationImmediateStopped=!1}},{key:"reuse",value:function(e,t){this.type=e,this.bubbles=t||!1}},{key:"isStopped",value:function(){return this.propagationStopped||this.propagationImmediateStopped}},{key:"getCurrentTarget",value:function(){return this.currentTarget}},{key:"getType",value:function(){return this.type}}]),i}());$o.NO_TYPE="no_type",$o.TOUCH="touch",$o.MOUSE="mouse",$o.KEYBOARD="keyboard",$o.ACCELERATION="acceleration",$o.NONE=0,$o.CAPTURING_PHASE=1,$o.AT_TARGET=2,$o.BUBBLING_PHASE=3,cc.Event=$o;var el=$e.fastRemoveAt;function tl(){}var il=function(){function e(){y(this,e),this.callback=tl,this.target=void 0,this.once=!1}return l(e,[{key:"set",value:function(e,t,i){this.callback=e,this.target=t,this.once=!!i}}]),e}(),nl=new ks(function(){return new il},32),rl=function(){function e(){y(this,e),this.callbackInfos=[],this.isInvoking=!1,this.containCanceled=!1}return l(e,[{key:"removeByCallback",value:function(e){for(var t=0;t<this.callbackInfos.length;++t){var i=this.callbackInfos[t];i&&i.callback===e&&(nl.free(i),el(this.callbackInfos,t),--t)}}},{key:"removeByTarget",value:function(e){for(var t=0;t<this.callbackInfos.length;++t){var i=this.callbackInfos[t];i&&i.target===e&&(nl.free(i),el(this.callbackInfos,t),--t)}}},{key:"cancel",value:function(e){var t=this.callbackInfos[e];t&&(nl.free(t),this.callbackInfos[e]=null),this.containCanceled=!0}},{key:"cancelAll",value:function(){for(var e=0;e<this.callbackInfos.length;e++){var t=this.callbackInfos[e];t&&(nl.free(t),this.callbackInfos[e]=null)}this.containCanceled=!0}},{key:"purgeCanceled",value:function(){for(var e=this.callbackInfos.length-1;0<=e;--e){this.callbackInfos[e]||el(this.callbackInfos,e)}this.containCanceled=!1}},{key:"clear",value:function(){this.cancelAll(),this.callbackInfos.length=0,this.isInvoking=!1,this.containCanceled=!1}}]),e}(),al=new ks(function(){return new rl},16),sl=function(){function e(){y(this,e),this._callbackTable=ke(!0)}return l(e,[{key:"on",value:function(e,t,i,n){var r=this._callbackTable[e];r=r||(this._callbackTable[e]=al.alloc());var a=nl.alloc();a.set(t,i,n),r.callbackInfos.push(a)}},{key:"hasEventListener",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:null,r=this._callbackTable[e];if(!r)return!1;var a=r.callbackInfos;if(!t){if(r.isInvoking){var s=a,o=Array.isArray(s),l=0;for(s=o?s:s[Symbol.iterator]();;){var c;if(o){if(l>=s.length)break;c=s[l++]}else{if((l=s.next()).done)break;c=l.value}if(c)return!0}return!1}return 0<a.length}var u=a,h=Array.isArray(u),f=0;for(u=h?u:u[Symbol.iterator]();;){var d;if(h){if(f>=u.length)break;d=u[f++]}else{if((f=u.next()).done)break;d=f.value}var p=d;if(p&&p.callback===t&&p.target===n)return!0}return!1}},{key:"removeAll",value:function(e){if("string"==typeof e){var t=this._callbackTable[e];t&&(t.isInvoking?t.cancelAll():(t.clear(),al.free(t),delete this._callbackTable[e]))}else if(e)for(var i in this._callbackTable){var n=this._callbackTable[i];if(n.isInvoking)for(var r=n.callbackInfos,a=0;a<r.length;++a){var s=r[a];s&&s.target===e&&n.cancel(a)}else n.removeByTarget(e)}}},{key:"off",value:function(e,t,i){var n=this._callbackTable[e];if(n){var r=n.callbackInfos;if(t)for(var a=0;a<r.length;++a){var s=r[a];if(s&&s.callback===t&&s.target===i){n.isInvoking?n.cancel(a):(el(r,a),nl.free(s));break}}else this.removeAll(e)}}},{key:"emit",value:function(e){var t=this._callbackTable[e];if(t){var i=!t.isInvoking;t.isInvoking=!0;for(var n=t.callbackInfos,r=arguments.length,a=new Array(1<r?r-1:0),s=1;s<r;s++)a[s-1]=arguments[s];for(var o=0,l=n.length;o<l;++o){var c=n[o];if(c){var u=c.callback,h=c.target;c.once&&this.off(e,u,h),h?u.call.apply(u,[h].concat(a)):u.apply(void 0,a)}}i&&(t.isInvoking=!1,t.containCanceled&&t.purgeCanceled())}}}]),e}();var ol=$e.fastRemove,ll=P2("EventTarget",function(){function r(){return y(this,r),x(this,g(r).apply(this,arguments))}return p(r,sl),l(r,[{key:"on",value:function(e,t,i){if(t){if(!this.hasEventListener(e,t,i)){_(g(r.prototype),"on",this).call(this,e,t,i);var n=i;i&&(n.__eventTargets?n.__eventTargets.push(this):n.node&&n.node.__eventTargets&&n.node.__eventTargets.push(this))}return t}cc.errorID(6800)}},{key:"off",value:function(e,t,i){if(t){_(g(r.prototype),"off",this).call(this,e,t,i);var n=i;i&&(n.__eventTargets?ol(n.__eventTargets,this):n.node&&n.node.__eventTargets&&ol(n.node.__eventTargets,this))}else this.removeAll(e)}},{key:"targetOff",value:function(e){this.removeAll(e)}},{key:"once",value:function(e,t,i){if(t){if(!this.hasEventListener(e,t,i)){_(g(r.prototype),"on",this).call(this,e,t,i,!0);var n=i;i&&(n.__eventTargets?n.__eventTargets.push(this):n.node&&n.node.__eventTargets&&n.node.__eventTargets.push(this))}return t}cc.errorID(6800)}}]),r}());cc.EventTarget=ll;var cl,ul={};ul.LANGUAGE_ENGLISH="en",ul.LANGUAGE_CHINESE="zh",ul.LANGUAGE_FRENCH="fr",ul.LANGUAGE_ITALIAN="it",ul.LANGUAGE_GERMAN="de",ul.LANGUAGE_SPANISH="es",ul.LANGUAGE_DUTCH="du",ul.LANGUAGE_RUSSIAN="ru",ul.LANGUAGE_KOREAN="ko",ul.LANGUAGE_JAPANESE="ja",ul.LANGUAGE_HUNGARIAN="hu",ul.LANGUAGE_PORTUGUESE="pt",ul.LANGUAGE_ARABIC="ar",ul.LANGUAGE_NORWEGIAN="no",ul.LANGUAGE_POLISH="pl",ul.LANGUAGE_TURKISH="tr",ul.LANGUAGE_UKRAINIAN="uk",ul.LANGUAGE_ROMANIAN="ro",ul.LANGUAGE_BULGARIAN="bg",ul.LANGUAGE_UNKNOWN="unknown",ul.OS_IOS="iOS",ul.OS_ANDROID="Android",ul.OS_WINDOWS="Windows",ul.OS_MARMALADE="Marmalade",ul.OS_LINUX="Linux",ul.OS_BADA="Bada",ul.OS_BLACKBERRY="Blackberry",ul.OS_OSX="OS X",ul.OS_WP8="WP8",ul.OS_WINRT="WINRT",ul.OS_UNKNOWN="Unknown",ul.UNKNOWN=-1,ul.WIN32=0,ul.LINUX=1,ul.MACOS=2,ul.ANDROID=3,ul.IPHONE=4,ul.IPAD=5,ul.BLACKBERRY=6,ul.NACL=7,ul.EMSCRIPTEN=8,ul.TIZEN=9,ul.WINRT=10,ul.WP8=11,ul.MOBILE_BROWSER=100,ul.DESKTOP_BROWSER=101,ul.EDITOR_PAGE=102,ul.EDITOR_CORE=103,ul.WECHAT_GAME=104,ul.QQ_PLAY=105,ul.BROWSER_TYPE_WECHAT="wechat",ul.BROWSER_TYPE_WECHAT_GAME="wechatgame",ul.BROWSER_TYPE_WECHAT_GAME_SUB="wechatgamesub",ul.BROWSER_TYPE_QQ_PLAY="qqplay",ul.BROWSER_TYPE_ANDROID="androidbrowser",ul.BROWSER_TYPE_IE="ie",ul.BROWSER_TYPE_QQ="qqbrowser",ul.BROWSER_TYPE_MOBILE_QQ="mqqbrowser",ul.BROWSER_TYPE_UC="ucbrowser",ul.BROWSER_TYPE_UCBS="ucbs",ul.BROWSER_TYPE_360="360browser",ul.BROWSER_TYPE_BAIDU_APP="baiduboxapp",ul.BROWSER_TYPE_BAIDU="baidubrowser",ul.BROWSER_TYPE_MAXTHON="maxthon",ul.BROWSER_TYPE_OPERA="opera",ul.BROWSER_TYPE_OUPENG="oupeng",ul.BROWSER_TYPE_MIUI="miuibrowser",ul.BROWSER_TYPE_FIREFOX="firefox",ul.BROWSER_TYPE_SAFARI="safari",ul.BROWSER_TYPE_CHROME="chrome",ul.BROWSER_TYPE_LIEBAO="liebao",ul.BROWSER_TYPE_QZONE="qzone",ul.BROWSER_TYPE_SOUGOU="sogou",ul.BROWSER_TYPE_UNKNOWN="unknown",ul.isNative=!1,ul.isBrowser="object"===("undefined"==typeof window?"undefined":de(window))&&"object"===("undefined"==typeof document?"undefined":de(document))&&!1,ul.isLittleEndian=(cl=new ArrayBuffer(2),new DataView(cl).setInt16(0,256,!0),256===new Int16Array(cl)[0]);var hl=wx.getSystemInfoSync();ul.isMobile=!0,ul.platform=ul.WECHAT_GAME,ul.language=hl.language.substr(0,2);var fl=hl.system.toLowerCase();"android"===hl.platform?ul.os=ul.OS_ANDROID:"ios"===hl.platform?ul.os=ul.OS_IOS:"devtools"===hl.platform&&(ul.isMobile=!1,-1<fl.indexOf("android")?ul.os=ul.OS_ANDROID:-1<fl.indexOf("ios")&&(ul.os=ul.OS_IOS)),"android p"===fl&&(fl="android p 9.0");var dl=/[\d\.]+/.exec(fl);ul.osVersion=dl?dl[0]:fl,ul.osMainVersion=parseInt(ul.osVersion),wx.getFileSystemManager?ul.browserType=ul.BROWSER_TYPE_WECHAT_GAME:ul.browserType=ul.BROWSER_TYPE_WECHAT_GAME_SUB,ul.browserVersion=hl.version;var pl=hl.windowWidth,_l=hl.windowHeight,vl=hl.pixelRatio||1;ul.windowPixelResolution={width:vl*pl,height:vl*_l},ul.localStorage=window.localStorage,ul.capabilities={canvas:!0,opengl:ul.browserType!==ul.BROWSER_TYPE_WECHAT_GAME_SUB,webp:!1},ul.__audioSupport={ONLY_ONE:!1,WEB_AUDIO:!1,DELAY_CREATE_CTX:!1,format:[".mp3"]},ul.NetworkType={NONE:0,LAN:1,WWAN:2},ul.getNetworkType=function(){return ul.NetworkType.LAN},ul.getBatteryLevel=function(){return 1},ul.garbageCollect=function(){},ul.dumpRoot=function(){},ul.restartVM=function(){},ul.cleanScript=function(e){},ul.isObjectValid=function(e){return!!e},ul.dump=function(){var e="";e+="isMobile : "+this.isMobile+"\r\n",e+="language : "+this.language+"\r\n",e+="browserType : "+this.browserType+"\r\n",e+="browserVersion : "+this.browserVersion+"\r\n",e+="capabilities : "+JSON.stringify(this.capabilities)+"\r\n",e+="os : "+this.os+"\r\n",e+="osVersion : "+this.osVersion+"\r\n",e+="platform : "+this.platform+"\r\n",e+="Using "+(cc.game.renderType===cc.game.RENDER_TYPE_WEBGL?"WEBGL":"CANVAS")+" renderer.\r\n",cc.log(e)},ul.openURL=function(e){window.open(e)},ul.now=function(){return Date.now?Date.now():+new Date},cc.sys=ul;var ml=cc.Enum({JPG:0,PNG:1,TIFF:2,WEBP:3,PVR:4,ETC:5,S3TC:6,ATITC:7,TGA:8,RAWDATA:9,UNKNOWN:10}),yl=P2("macro",{SUPPORT_TEXTURE_FORMATS:[".pkm",".pvr",".webp",".jpg",".jpeg",".bmp",".png"],KEY:{none:0,back:6,menu:18,backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,select:41,insert:45,Delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,"*":106,"+":107,"-":109,numdel:110,"/":111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numlock:144,scrolllock:145,";":186,semicolon:186,equal:187,"=":187,",":188,comma:188,dash:189,".":190,period:190,forwardslash:191,grave:192,"[":219,openbracket:219,backslash:220,"]":221,closebracket:221,quote:222,dpadLeft:1e3,dpadRight:1001,dpadUp:1003,dpadDown:1004,dpadCenter:1005},ImageFormat:ml,RAD:Math.PI/180,DEG:180/Math.PI,REPEAT_FOREVER:Number.MAX_VALUE-1,FLT_EPSILON:1.192092896e-7,MIN_ZINDEX:-Math.pow(2,15),MAX_ZINDEX:Math.pow(2,15)-1,ORIENTATION_PORTRAIT:1,ORIENTATION_LANDSCAPE:2,ORIENTATION_AUTO:3,DENSITYDPI_DEVICE:"device-dpi",DENSITYDPI_HIGH:"high-dpi",DENSITYDPI_MEDIUM:"medium-dpi",DENSITYDPI_LOW:"low-dpi",FIX_ARTIFACTS_BY_STRECHING_TEXEL_TMX:!0,DIRECTOR_STATS_POSITION:new Mi(0,0),ENABLE_STACKABLE_ACTIONS:!0,TOUCH_TIMEOUT:5e3,BATCH_VERTEX_COUNT:2e4,ENABLE_TILEDMAP_CULLING:!0,DOWNLOAD_MAX_CONCURRENT:64,ENABLE_TRANSPARENT_CANVAS:!1,ENABLE_WEBGL_ANTIALIAS:!1,ENABLE_CULLING:!1,CLEANUP_IMAGE_CACHE:!1,SHOW_MESH_WIREFRAME:!1});cc.macro=yl;var gl={topLeft:cc.v2(0,0),topRight:cc.v2(0,0),top:cc.v2(0,0),bottomLeft:cc.v2(0,0),bottomRight:cc.v2(0,0),bottom:cc.v2(0,0),center:cc.v2(0,0),left:cc.v2(0,0),right:cc.v2(0,0),width:0,height:0,init:function(e){var t=this.width=e.width,i=this.height=e.height,n=e.x,r=e.y,a=r+i,s=n+t;this.topLeft.x=n,this.topLeft.y=a,this.topRight.x=s,this.topRight.y=a,this.top.x=n+t/2,this.top.y=a,this.bottomLeft.x=n,this.bottomLeft.y=r,this.bottomRight.x=s,this.bottomRight.y=r,this.bottom.x=n+t/2,this.bottom.y=r,this.center.x=n+t/2,this.center.y=r+i/2,this.left.x=n,this.left.y=r+i/2,this.right.x=s,this.right.y=r+i/2}};cc.visibleRect=gl;var bl,xl,Sl,wl,Tl=P2("GFX_MAX_VERTEX_ATTRIBUTES",16),El=P2("GFX_MAX_TEXTURE_UNITS",16),Cl=P2("GFX_MAX_ATTACHMENTS",4),Al=P2("GFX_MAX_BUFFER_BINDINGS",24);(xl=bl=bl||P2("GFXObjectType",{}))[xl.UNKNOWN=0]="UNKNOWN",xl[xl.BUFFER=1]="BUFFER",xl[xl.TEXTURE=2]="TEXTURE",xl[xl.TEXTURE_VIEW=3]="TEXTURE_VIEW",xl[xl.RENDER_PASS=4]="RENDER_PASS",xl[xl.FRAMEBUFFER=5]="FRAMEBUFFER",xl[xl.SAMPLER=6]="SAMPLER",xl[xl.SHADER=7]="SHADER",xl[xl.PIPELINE_LAYOUT=8]="PIPELINE_LAYOUT",xl[xl.PIPELINE_STATE=9]="PIPELINE_STATE",xl[xl.BINDING_LAYOUT=10]="BINDING_LAYOUT",xl[xl.INPUT_ASSEMBLER=11]="INPUT_ASSEMBLER",xl[xl.COMMAND_ALLOCATOR=12]="COMMAND_ALLOCATOR",xl[xl.COMMAND_BUFFER=13]="COMMAND_BUFFER",xl[xl.QUEUE=14]="QUEUE",xl[xl.WINDOW=15]="WINDOW",(wl=Sl=Sl||P2("GFXStatus",{}))[wl.UNREADY=0]="UNREADY",wl[wl.FAILED=1]="FAILED",wl[wl.SUCCESS=2]="SUCCESS";var kl,Rl,Ol,Ml,Il,Ll,zl,Bl,Pl,Dl,Fl,Nl,Ul,Vl,Gl,Hl,ql,jl,Wl,Xl,Yl,Ql,Kl,Zl,Jl,$l,ec,tc,ic,nc,rc,ac,sc,oc,lc,uc,hc,fc,dc,pc,_c,vc,mc,yc,gc,bc,xc,Sc,wc,Tc,Ec,Cc,Ac,kc,Rc,Oc,Mc,Ic,Lc,zc,Bc,Pc,Dc,Fc,Nc,Uc,Vc,Gc,Hc=P2("GFXObject",function(){function t(e){y(this,t),this._gfxType=bl.UNKNOWN,this._status=Sl.UNREADY,this._gfxType=e}return l(t,[{key:"gfxType",get:function(){return this._gfxType}},{key:"status",get:function(){return this._status}}]),t}());(Rl=kl=kl||P2("GFXAttributeName",{})).ATTR_POSITION="a_position",Rl.ATTR_NORMAL="a_normal",Rl.ATTR_TANGENT="a_tangent",Rl.ATTR_BITANGENT="a_bitangent",Rl.ATTR_WEIGHTS="a_weights",Rl.ATTR_JOINTS="a_joints",Rl.ATTR_COLOR="a_color",Rl.ATTR_COLOR1="a_color1",Rl.ATTR_COLOR2="a_color2",Rl.ATTR_TEX_COORD="a_texCoord",Rl.ATTR_TEX_COORD1="a_texCoord1",Rl.ATTR_TEX_COORD2="a_texCoord2",Rl.ATTR_TEX_COORD3="a_texCoord3",Rl.ATTR_TEX_COORD4="a_texCoord4",Rl.ATTR_TEX_COORD5="a_texCoord5",Rl.ATTR_TEX_COORD6="a_texCoord6",Rl.ATTR_TEX_COORD7="a_texCoord7",Rl.ATTR_TEX_COORD8="a_texCoord8",Rl.ATTR_BATCH_ID="a_batch_id",Rl.ATTR_BATCH_UV="a_batch_uv",(Ml=Ol=Ol||P2("GFXType",{}))[Ml.UNKNOWN=0]="UNKNOWN",Ml[Ml.BOOL=1]="BOOL",Ml[Ml.BOOL2=2]="BOOL2",Ml[Ml.BOOL3=3]="BOOL3",Ml[Ml.BOOL4=4]="BOOL4",Ml[Ml.INT=5]="INT",Ml[Ml.INT2=6]="INT2",Ml[Ml.INT3=7]="INT3",Ml[Ml.INT4=8]="INT4",Ml[Ml.UINT=9]="UINT",Ml[Ml.UINT2=10]="UINT2",Ml[Ml.UINT3=11]="UINT3",Ml[Ml.UINT4=12]="UINT4",Ml[Ml.FLOAT=13]="FLOAT",Ml[Ml.FLOAT2=14]="FLOAT2",Ml[Ml.FLOAT3=15]="FLOAT3",Ml[Ml.FLOAT4=16]="FLOAT4",Ml[Ml.MAT2=17]="MAT2",Ml[Ml.MAT2X3=18]="MAT2X3",Ml[Ml.MAT2X4=19]="MAT2X4",Ml[Ml.MAT3X2=20]="MAT3X2",Ml[Ml.MAT3=21]="MAT3",Ml[Ml.MAT3X4=22]="MAT3X4",Ml[Ml.MAT4X2=23]="MAT4X2",Ml[Ml.MAT4X3=24]="MAT4X3",Ml[Ml.MAT4=25]="MAT4",Ml[Ml.SAMPLER1D=26]="SAMPLER1D",Ml[Ml.SAMPLER1D_ARRAY=27]="SAMPLER1D_ARRAY",Ml[Ml.SAMPLER2D=28]="SAMPLER2D",Ml[Ml.SAMPLER2D_ARRAY=29]="SAMPLER2D_ARRAY",Ml[Ml.SAMPLER3D=30]="SAMPLER3D",Ml[Ml.SAMPLER_CUBE=31]="SAMPLER_CUBE",Ml[Ml.COUNT=32]="COUNT",(Ll=Il=Il||P2("GFXFormat",{}))[Ll.UNKNOWN=0]="UNKNOWN",Ll[Ll.A8=1]="A8",Ll[Ll.L8=2]="L8",Ll[Ll.LA8=3]="LA8",Ll[Ll.R8=4]="R8",Ll[Ll.R8SN=5]="R8SN",Ll[Ll.R8UI=6]="R8UI",Ll[Ll.R8I=7]="R8I",Ll[Ll.R16F=8]="R16F",Ll[Ll.R16UI=9]="R16UI",Ll[Ll.R16I=10]="R16I",Ll[Ll.R32F=11]="R32F",Ll[Ll.R32UI=12]="R32UI",Ll[Ll.R32I=13]="R32I",Ll[Ll.RG8=14]="RG8",Ll[Ll.RG8SN=15]="RG8SN",Ll[Ll.RG8UI=16]="RG8UI",Ll[Ll.RG8I=17]="RG8I",Ll[Ll.RG16F=18]="RG16F",Ll[Ll.RG16UI=19]="RG16UI",Ll[Ll.RG16I=20]="RG16I",Ll[Ll.RG32F=21]="RG32F",Ll[Ll.RG32UI=22]="RG32UI",Ll[Ll.RG32I=23]="RG32I",Ll[Ll.RGB8=24]="RGB8",Ll[Ll.SRGB8=25]="SRGB8",Ll[Ll.RGB8SN=26]="RGB8SN",Ll[Ll.RGB8UI=27]="RGB8UI",Ll[Ll.RGB8I=28]="RGB8I",Ll[Ll.RGB16F=29]="RGB16F",Ll[Ll.RGB16UI=30]="RGB16UI",Ll[Ll.RGB16I=31]="RGB16I",Ll[Ll.RGB32F=32]="RGB32F",Ll[Ll.RGB32UI=33]="RGB32UI",Ll[Ll.RGB32I=34]="RGB32I",Ll[Ll.RGBA8=35]="RGBA8",Ll[Ll.SRGB8_A8=36]="SRGB8_A8",Ll[Ll.RGBA8SN=37]="RGBA8SN",Ll[Ll.RGBA8UI=38]="RGBA8UI",Ll[Ll.RGBA8I=39]="RGBA8I",Ll[Ll.RGBA16F=40]="RGBA16F",Ll[Ll.RGBA16UI=41]="RGBA16UI",Ll[Ll.RGBA16I=42]="RGBA16I",Ll[Ll.RGBA32F=43]="RGBA32F",Ll[Ll.RGBA32UI=44]="RGBA32UI",Ll[Ll.RGBA32I=45]="RGBA32I",Ll[Ll.R5G6B5=46]="R5G6B5",Ll[Ll.R11G11B10F=47]="R11G11B10F",Ll[Ll.RGB5A1=48]="RGB5A1",Ll[Ll.RGBA4=49]="RGBA4",Ll[Ll.RGB10A2=50]="RGB10A2",Ll[Ll.RGB10A2UI=51]="RGB10A2UI",Ll[Ll.RGB9E5=52]="RGB9E5",Ll[Ll.D16=53]="D16",Ll[Ll.D16S8=54]="D16S8",Ll[Ll.D24=55]="D24",Ll[Ll.D24S8=56]="D24S8",Ll[Ll.D32F=57]="D32F",Ll[Ll.D32F_S8=58]="D32F_S8",Ll[Ll.BC1=59]="BC1",Ll[Ll.BC1_ALPHA=60]="BC1_ALPHA",Ll[Ll.BC1_SRGB=61]="BC1_SRGB",Ll[Ll.BC1_SRGB_ALPHA=62]="BC1_SRGB_ALPHA",Ll[Ll.BC2=63]="BC2",Ll[Ll.BC2_SRGB=64]="BC2_SRGB",Ll[Ll.BC3=65]="BC3",Ll[Ll.BC3_SRGB=66]="BC3_SRGB",Ll[Ll.BC4=67]="BC4",Ll[Ll.BC4_SNORM=68]="BC4_SNORM",Ll[Ll.BC5=69]="BC5",Ll[Ll.BC5_SNORM=70]="BC5_SNORM",Ll[Ll.BC6H_UF16=71]="BC6H_UF16",Ll[Ll.BC6H_SF16=72]="BC6H_SF16",Ll[Ll.BC7=73]="BC7",Ll[Ll.BC7_SRGB=74]="BC7_SRGB",Ll[Ll.ETC_RGB8=75]="ETC_RGB8",Ll[Ll.ETC2_RGB8=76]="ETC2_RGB8",Ll[Ll.ETC2_SRGB8=77]="ETC2_SRGB8",Ll[Ll.ETC2_RGB8_A1=78]="ETC2_RGB8_A1",Ll[Ll.ETC2_SRGB8_A1=79]="ETC2_SRGB8_A1",Ll[Ll.ETC2_RGBA8=80]="ETC2_RGBA8",Ll[Ll.ETC2_SRGB8_A8=81]="ETC2_SRGB8_A8",Ll[Ll.EAC_R11=82]="EAC_R11",Ll[Ll.EAC_R11SN=83]="EAC_R11SN",Ll[Ll.EAC_RG11=84]="EAC_RG11",Ll[Ll.EAC_RG11SN=85]="EAC_RG11SN",Ll[Ll.PVRTC_RGB2=86]="PVRTC_RGB2",Ll[Ll.PVRTC_RGBA2=87]="PVRTC_RGBA2",Ll[Ll.PVRTC_RGB4=88]="PVRTC_RGB4",Ll[Ll.PVRTC_RGBA4=89]="PVRTC_RGBA4",Ll[Ll.PVRTC2_2BPP=90]="PVRTC2_2BPP",Ll[Ll.PVRTC2_4BPP=91]="PVRTC2_4BPP",(Bl=zl=zl||P2("GFXBufferUsageBit",{}))[Bl.NONE=0]="NONE",Bl[Bl.TRANSFER_SRC=1]="TRANSFER_SRC",Bl[Bl.TRANSFER_DST=2]="TRANSFER_DST",Bl[Bl.INDEX=4]="INDEX",Bl[Bl.VERTEX=8]="VERTEX",Bl[Bl.UNIFORM=16]="UNIFORM",Bl[Bl.STORAGE=32]="STORAGE",Bl[Bl.INDIRECT=64]="INDIRECT",(Dl=Pl=Pl||P2("GFXMemoryUsageBit",{}))[Dl.NONE=0]="NONE",Dl[Dl.DEVICE=1]="DEVICE",Dl[Dl.HOST=2]="HOST",(Nl=Fl=Fl||P2("GFXBufferFlagBit",{}))[Nl.NONE=0]="NONE",Nl[Nl.BAKUP_BUFFER=4]="BAKUP_BUFFER",(Vl=Ul=Ul||P2("GFXBufferAccessBit",{}))[Vl.NONE=0]="NONE",Vl[Vl.READ=1]="READ",Vl[Vl.WRITE=2]="WRITE",(Hl=Gl=Gl||P2("GFXPrimitiveMode",{}))[Hl.POINT_LIST=0]="POINT_LIST",Hl[Hl.LINE_LIST=1]="LINE_LIST",Hl[Hl.LINE_STRIP=2]="LINE_STRIP",Hl[Hl.LINE_LOOP=3]="LINE_LOOP",Hl[Hl.LINE_LIST_ADJACENCY=4]="LINE_LIST_ADJACENCY",Hl[Hl.LINE_STRIP_ADJACENCY=5]="LINE_STRIP_ADJACENCY",Hl[Hl.ISO_LINE_LIST=6]="ISO_LINE_LIST",Hl[Hl.TRIANGLE_LIST=7]="TRIANGLE_LIST",Hl[Hl.TRIANGLE_STRIP=8]="TRIANGLE_STRIP",Hl[Hl.TRIANGLE_FAN=9]="TRIANGLE_FAN",Hl[Hl.TRIANGLE_LIST_ADJACENCY=10]="TRIANGLE_LIST_ADJACENCY",Hl[Hl.TRIANGLE_STRIP_ADJACENCY=11]="TRIANGLE_STRIP_ADJACENCY",Hl[Hl.TRIANGLE_PATCH_ADJACENCY=12]="TRIANGLE_PATCH_ADJACENCY",Hl[Hl.QUAD_PATCH_LIST=13]="QUAD_PATCH_LIST",(jl=ql=ql||P2("GFXPolygonMode",{}))[jl.FILL=0]="FILL",jl[jl.POINT=1]="POINT",jl[jl.LINE=2]="LINE",(Xl=Wl=Wl||P2("GFXShadeModel",{}))[Xl.GOURAND=0]="GOURAND",Xl[Xl.FLAT=1]="FLAT",(Ql=Yl=Yl||P2("GFXCullMode",{}))[Ql.NONE=0]="NONE",Ql[Ql.FRONT=1]="FRONT",Ql[Ql.BACK=2]="BACK",(Zl=Kl=Kl||P2("GFXComparisonFunc",{}))[Zl.NEVER=0]="NEVER",Zl[Zl.LESS=1]="LESS",Zl[Zl.EQUAL=2]="EQUAL",Zl[Zl.LESS_EQUAL=3]="LESS_EQUAL",Zl[Zl.GREATER=4]="GREATER",Zl[Zl.NOT_EQUAL=5]="NOT_EQUAL",Zl[Zl.GREATER_EQUAL=6]="GREATER_EQUAL",Zl[Zl.ALWAYS=7]="ALWAYS",($l=Jl=Jl||P2("GFXStencilOp",{}))[$l.ZERO=0]="ZERO",$l[$l.KEEP=1]="KEEP",$l[$l.REPLACE=2]="REPLACE",$l[$l.INCR=3]="INCR",$l[$l.DECR=4]="DECR",$l[$l.INVERT=5]="INVERT",$l[$l.INCR_WRAP=6]="INCR_WRAP",$l[$l.DECR_WRAP=7]="DECR_WRAP",(tc=ec=ec||P2("GFXBlendOp",{}))[tc.ADD=0]="ADD",tc[tc.SUB=1]="SUB",tc[tc.REV_SUB=2]="REV_SUB",tc[tc.MIN=3]="MIN",tc[tc.MAX=4]="MAX",(nc=ic=ic||P2("GFXBlendFactor",{}))[nc.ZERO=0]="ZERO",nc[nc.ONE=1]="ONE",nc[nc.SRC_ALPHA=2]="SRC_ALPHA",nc[nc.DST_ALPHA=3]="DST_ALPHA",nc[nc.ONE_MINUS_SRC_ALPHA=4]="ONE_MINUS_SRC_ALPHA",nc[nc.ONE_MINUS_DST_ALPHA=5]="ONE_MINUS_DST_ALPHA",nc[nc.SRC_COLOR=6]="SRC_COLOR",nc[nc.DST_COLOR=7]="DST_COLOR",nc[nc.ONE_MINUS_SRC_COLOR=8]="ONE_MINUS_SRC_COLOR",nc[nc.ONE_MINUS_DST_COLOR=9]="ONE_MINUS_DST_COLOR",nc[nc.SRC_ALPHA_SATURATE=10]="SRC_ALPHA_SATURATE",nc[nc.CONSTANT_COLOR=11]="CONSTANT_COLOR",nc[nc.ONE_MINUS_CONSTANT_COLOR=12]="ONE_MINUS_CONSTANT_COLOR",nc[nc.CONSTANT_ALPHA=13]="CONSTANT_ALPHA",nc[nc.ONE_MINUS_CONSTANT_ALPHA=14]="ONE_MINUS_CONSTANT_ALPHA",(ac=rc=rc||P2("GFXColorMask",{}))[ac.NONE=0]="NONE",ac[ac.R=1]="R",ac[ac.G=2]="G",ac[ac.B=4]="B",ac[ac.A=8]="A",ac[ac.ALL=15]="ALL",(oc=sc=sc||P2("GFXFilter",{}))[oc.NONE=0]="NONE",oc[oc.POINT=1]="POINT",oc[oc.LINEAR=2]="LINEAR",oc[oc.ANISOTROPIC=3]="ANISOTROPIC",(uc=lc=lc||P2("GFXAddress",{}))[uc.WRAP=0]="WRAP",uc[uc.MIRROR=1]="MIRROR",uc[uc.CLAMP=2]="CLAMP",uc[uc.BORDER=3]="BORDER",(fc=hc=hc||P2("GFXTextureType",{}))[fc.TEX1D=0]="TEX1D",fc[fc.TEX2D=1]="TEX2D",fc[fc.TEX3D=2]="TEX3D",(pc=dc=dc||P2("GFXTextureUsageBit",{}))[pc.NONE=0]="NONE",pc[pc.TRANSFER_SRC=1]="TRANSFER_SRC",pc[pc.TRANSFER_DST=2]="TRANSFER_DST",pc[pc.SAMPLED=4]="SAMPLED",pc[pc.STORAGE=8]="STORAGE",pc[pc.COLOR_ATTACHMENT=16]="COLOR_ATTACHMENT",pc[pc.DEPTH_STENCIL_ATTACHMENT=32]="DEPTH_STENCIL_ATTACHMENT",pc[pc.TRANSIENT_ATTACHMENT=64]="TRANSIENT_ATTACHMENT",pc[pc.INPUT_ATTACHMENT=128]="INPUT_ATTACHMENT",(vc=_c=_c||P2("GFXSampleCount",{}))[vc.X1=0]="X1",vc[vc.X2=1]="X2",vc[vc.X4=2]="X4",vc[vc.X8=3]="X8",vc[vc.X16=4]="X16",vc[vc.X32=5]="X32",vc[vc.X64=6]="X64",(yc=mc=mc||P2("GFXTextureFlagBit",{}))[yc.NONE=0]="NONE",yc[yc.GEN_MIPMAP=1]="GEN_MIPMAP",yc[yc.CUBEMAP=2]="CUBEMAP",yc[yc.BAKUP_BUFFER=4]="BAKUP_BUFFER",(bc=gc=gc||P2("GFXTextureViewType",{}))[bc.TV1D=0]="TV1D",bc[bc.TV2D=1]="TV2D",bc[bc.TV3D=2]="TV3D",bc[bc.CUBE=3]="CUBE",bc[bc.TV1D_ARRAY=4]="TV1D_ARRAY",bc[bc.TV2D_ARRAY=5]="TV2D_ARRAY",(Sc=xc=xc||P2("GFXShaderType",{}))[Sc.VERTEX=0]="VERTEX",Sc[Sc.HULL=1]="HULL",Sc[Sc.DOMAIN=2]="DOMAIN",Sc[Sc.GEOMETRY=3]="GEOMETRY",Sc[Sc.FRAGMENT=4]="FRAGMENT",Sc[Sc.COMPUTE=5]="COMPUTE",Sc[Sc.COUNT=6]="COUNT",(Tc=wc=wc||P2("GFXBindingType",{}))[Tc.UNKNOWN=0]="UNKNOWN",Tc[Tc.UNIFORM_BUFFER=1]="UNIFORM_BUFFER",Tc[Tc.SAMPLER=2]="SAMPLER",Tc[Tc.STORAGE_BUFFER=3]="STORAGE_BUFFER",(Cc=Ec=Ec||P2("GFXCommandBufferType",{}))[Cc.PRIMARY=0]="PRIMARY",Cc[Cc.SECONDARY=1]="SECONDARY",(kc=Ac=Ac||P2("GFXLoadOp",{}))[kc.LOAD=0]="LOAD",kc[kc.CLEAR=1]="CLEAR",kc[kc.DISCARD=2]="DISCARD",(Oc=Rc=Rc||P2("GFXStoreOp",{}))[Oc.STORE=0]="STORE",Oc[Oc.DISCARD=1]="DISCARD",(Ic=Mc=Mc||P2("GFXTextureLayout",{}))[Ic.UNDEFINED=0]="UNDEFINED",Ic[Ic.GENERAL=1]="GENERAL",Ic[Ic.COLOR_ATTACHMENT_OPTIMAL=2]="COLOR_ATTACHMENT_OPTIMAL",Ic[Ic.DEPTH_STENCIL_ATTACHMENT_OPTIMAL=3]="DEPTH_STENCIL_ATTACHMENT_OPTIMAL",Ic[Ic.DEPTH_STENCIL_READONLY_OPTIMAL=4]="DEPTH_STENCIL_READONLY_OPTIMAL",Ic[Ic.SHADER_READONLY_OPTIMAL=5]="SHADER_READONLY_OPTIMAL",Ic[Ic.TRANSFER_SRC_OPTIMAL=6]="TRANSFER_SRC_OPTIMAL",Ic[Ic.TRANSFER_DST_OPTIMAL=7]="TRANSFER_DST_OPTIMAL",Ic[Ic.PREINITIALIZED=8]="PREINITIALIZED",Ic[Ic.PRESENT_SRC=9]="PRESENT_SRC",(zc=Lc=Lc||P2("GFXPipelineBindPoint",{}))[zc.GRAPHICS=0]="GRAPHICS",zc[zc.COMPUTE=1]="COMPUTE",zc[zc.RAY_TRACING=2]="RAY_TRACING",(Pc=Bc=Bc||P2("GFXDynamicState",{}))[Pc.VIEWPORT=0]="VIEWPORT",Pc[Pc.SCISSOR=1]="SCISSOR",Pc[Pc.LINE_WIDTH=2]="LINE_WIDTH",Pc[Pc.DEPTH_BIAS=3]="DEPTH_BIAS",Pc[Pc.BLEND_CONSTANTS=4]="BLEND_CONSTANTS",Pc[Pc.DEPTH_BOUNDS=5]="DEPTH_BOUNDS",Pc[Pc.STENCIL_WRITE_MASK=6]="STENCIL_WRITE_MASK",Pc[Pc.STENCIL_COMPARE_MASK=7]="STENCIL_COMPARE_MASK",(Fc=Dc=Dc||P2("GFXStencilFace",{}))[Fc.FRONT=0]="FRONT",Fc[Fc.BACK=1]="BACK",Fc[Fc.ALL=2]="ALL",(Uc=Nc=Nc||P2("GFXQueueType",{}))[Uc.GRAPHICS=0]="GRAPHICS",Uc[Uc.COMPUTE=1]="COMPUTE",Uc[Uc.TRANSFER=2]="TRANSFER",(Gc=Vc=Vc||P2("GFXClearFlag",{}))[Gc.NONE=0]="NONE",Gc[Gc.COLOR=1]="COLOR",Gc[Gc.DEPTH=2]="DEPTH",Gc[Gc.STENCIL=4]="STENCIL",Gc[Gc.DEPTH_STENCIL=6]="DEPTH_STENCIL",Gc[Gc.ALL=7]="ALL";var qc,jc,Wc=P2("GFXTextureSubres",function e(){y(this,e),this.baseMipLevel=0,this.levelCount=1,this.baseArrayLayer=0,this.layerCount=1}),Xc=P2("GFXTextureCopy",function e(){y(this,e),this.srcSubres=new Wc,this.srcOffset={x:0,y:0,z:0},this.dstSubres=new Wc,this.dstOffset={x:0,y:0,z:0},this.extent={width:0,height:0,depth:0}}),Yc=P2("GFXBufferTextureCopy",function e(){y(this,e),this.buffOffset=0,this.buffStride=0,this.buffTexHeight=0,this.texOffset={x:0,y:0,z:0},this.texExtent={width:0,height:0,depth:0},this.texSubres=new Wc});(jc=qc=qc||P2("GFXFormatType",{}))[jc.NONE=0]="NONE",jc[jc.UNORM=1]="UNORM",jc[jc.SNORM=2]="SNORM",jc[jc.UINT=3]="UINT",jc[jc.INT=4]="INT",jc[jc.UFLOAT=5]="UFLOAT",jc[jc.FLOAT=6]="FLOAT";var Qc=P2("GFXFormatInfos",[{name:"UNKNOWN",size:0,count:0,type:qc.NONE,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"A8",size:1,count:1,type:qc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"L8",size:1,count:1,type:qc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"LA8",size:1,count:2,type:qc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R8",size:1,count:1,type:qc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R8SN",size:1,count:1,type:qc.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R8UI",size:1,count:1,type:qc.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R8I",size:1,count:1,type:qc.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R16F",size:2,count:1,type:qc.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R16UI",size:2,count:1,type:qc.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R16I",size:2,count:1,type:qc.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R32F",size:4,count:1,type:qc.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R32UI",size:4,count:1,type:qc.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R32I",size:4,count:1,type:qc.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG8",size:2,count:2,type:qc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG8SN",size:2,count:2,type:qc.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG8UI",size:2,count:2,type:qc.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG8I",size:2,count:2,type:qc.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG16F",size:4,count:2,type:qc.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG16UI",size:4,count:2,type:qc.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG16I",size:4,count:2,type:qc.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG32F",size:8,count:2,type:qc.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG32UI",size:8,count:2,type:qc.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG32I",size:8,count:2,type:qc.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB8",size:3,count:3,type:qc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"SRGB8",size:3,count:3,type:qc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB8SN",size:3,count:3,type:qc.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB8UI",size:3,count:3,type:qc.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB8I",size:3,count:3,type:qc.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB16F",size:6,count:3,type:qc.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB16UI",size:6,count:3,type:qc.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB16I",size:6,count:3,type:qc.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB32F",size:12,count:3,type:qc.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB32UI",size:12,count:3,type:qc.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB32I",size:12,count:3,type:qc.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA8",size:4,count:4,type:qc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"SRGB8_A8",size:4,count:4,type:qc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA8SN",size:4,count:4,type:qc.SNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA8UI",size:4,count:4,type:qc.UINT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA8I",size:4,count:4,type:qc.INT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA16F",size:8,count:4,type:qc.FLOAT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA16UI",size:8,count:4,type:qc.UINT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA16I",size:8,count:4,type:qc.INT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA32F",size:16,count:4,type:qc.FLOAT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA32UI",size:16,count:4,type:qc.UINT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA32I",size:16,count:4,type:qc.INT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R5G6B5",size:2,count:3,type:qc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R11G11B10F",size:4,count:3,type:qc.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB5A1",size:2,count:4,type:qc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA4",size:2,count:4,type:qc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB10A2",size:2,count:4,type:qc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB10A2UI",size:2,count:4,type:qc.UINT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB9E5",size:2,count:4,type:qc.FLOAT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"D16",size:2,count:1,type:qc.UINT,hasAlpha:!1,hasDepth:!0,hasStencil:!1,isCompressed:!1},{name:"D16S8",size:3,count:2,type:qc.UINT,hasAlpha:!1,hasDepth:!0,hasStencil:!0,isCompressed:!1},{name:"D24",size:3,count:1,type:qc.UINT,hasAlpha:!1,hasDepth:!0,hasStencil:!1,isCompressed:!1},{name:"D24S8",size:4,count:2,type:qc.UINT,hasAlpha:!1,hasDepth:!0,hasStencil:!0,isCompressed:!1},{name:"D32F",size:4,count:1,type:qc.FLOAT,hasAlpha:!1,hasDepth:!0,hasStencil:!1,isCompressed:!1},{name:"D32FS8",size:5,count:2,type:qc.FLOAT,hasAlpha:!1,hasDepth:!0,hasStencil:!0,isCompressed:!1},{name:"BC1",size:1,count:3,type:qc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC1_ALPHA",size:1,count:4,type:qc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC1_SRGB",size:1,count:3,type:qc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC1_SRGB_ALPHA",size:1,count:4,type:qc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC2",size:1,count:4,type:qc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC2_SRGB",size:1,count:4,type:qc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC3",size:1,count:4,type:qc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC3_SRGB",size:1,count:4,type:qc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC4",size:1,count:1,type:qc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC4_SNORM",size:1,count:1,type:qc.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC5",size:1,count:2,type:qc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC5_SNORM",size:1,count:2,type:qc.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC6H_UF16",size:1,count:3,type:qc.UFLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC6H_SF16",size:1,count:3,type:qc.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC7",size:1,count:4,type:qc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC7_SRGB",size:1,count:4,type:qc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC_RGB8",size:1,count:3,type:qc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC2_RGB8",size:1,count:3,type:qc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC2_SRGB8",size:1,count:3,type:qc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC2_RGB8_A1",size:1,count:4,type:qc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC2_SRGB8_A1",size:1,count:4,type:qc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC2_RGBA8",size:2,count:4,type:qc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC2_SRGB8_A8",size:2,count:4,type:qc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"EAC_R11",size:1,count:1,type:qc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"EAC_R11SN",size:1,count:1,type:qc.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"EAC_RG11",size:2,count:2,type:qc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"EAC_RG11SN",size:2,count:2,type:qc.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"PVRTC_RGB2",size:2,count:3,type:qc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"PVRTC_RGBA2",size:2,count:4,type:qc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"PVRTC_RGB4",size:2,count:3,type:qc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"PVRTC_RGBA4",size:2,count:4,type:qc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"PVRTC2_2BPP",size:2,count:4,type:qc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"PVRTC2_4BPP",size:2,count:4,type:qc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0}]);function Kc(e,t,i,n){if(!Qc[e].isCompressed)return t*i*n*Qc[e].size;switch(e){case Il.BC1:case Il.BC1_ALPHA:case Il.BC1_SRGB:case Il.BC1_SRGB_ALPHA:return Math.ceil(t/4)*Math.ceil(i/4)*8*n;case Il.BC2:case Il.BC2_SRGB:case Il.BC3:case Il.BC3_SRGB:case Il.BC4:case Il.BC4_SNORM:case Il.BC6H_SF16:case Il.BC6H_UF16:case Il.BC7:case Il.BC7_SRGB:return Math.ceil(t/4)*Math.ceil(i/4)*16*n;case Il.BC5:case Il.BC5_SNORM:return Math.ceil(t/4)*Math.ceil(i/4)*32*n;case Il.ETC_RGB8:case Il.ETC2_RGB8:case Il.ETC2_SRGB8:case Il.ETC2_RGB8_A1:case Il.ETC2_SRGB8_A1:case Il.EAC_R11:case Il.EAC_R11SN:return Math.ceil(t/4)*Math.ceil(i/4)*8*n;case Il.EAC_RG11:case Il.EAC_RG11SN:return Math.ceil(t/4)*Math.ceil(i/4)*16*n;case Il.PVRTC_RGB2:case Il.PVRTC_RGBA2:case Il.PVRTC2_2BPP:return Math.ceil(Math.max(t,16)*Math.max(i,8)/4)*n;case Il.PVRTC_RGB4:case Il.PVRTC_RGBA4:case Il.PVRTC2_4BPP:return Math.ceil(Math.max(t,16)*Math.max(i,8)/2)*n;default:return 0}}function Zc(e,t,i,n,r){for(var a=0,s=0;s<r;++s)a+=Kc(e,t,i,n),t=Math.max(t>>1,1),i=Math.max(i>>1,1),n=Math.max(n>>1,1);return a}var Jc=[0,4,8,12,16,4,8,12,16,4,8,12,16,4,8,12,16,16,24,32,24,36,48,32,48,64,4,4,4,4,4,4];function $c(e){return Jc[e]||0}var eu,tu,iu,nu,ru=Object.freeze({GFX_MAX_VERTEX_ATTRIBUTES:Tl,GFX_MAX_TEXTURE_UNITS:El,GFX_MAX_ATTACHMENTS:Cl,GFX_MAX_BUFFER_BINDINGS:Al,get GFXObjectType(){return bl},get GFXStatus(){return Sl},GFXObject:Hc,get GFXAttributeName(){return kl},get GFXType(){return Ol},get GFXFormat(){return Il},get GFXBufferUsageBit(){return zl},get GFXMemoryUsageBit(){return Pl},get GFXBufferFlagBit(){return Fl},get GFXBufferAccessBit(){return Ul},get GFXPrimitiveMode(){return Gl},get GFXPolygonMode(){return ql},get GFXShadeModel(){return Wl},get GFXCullMode(){return Yl},get GFXComparisonFunc(){return Kl},get GFXStencilOp(){return Jl},get GFXBlendOp(){return ec},get GFXBlendFactor(){return ic},get GFXColorMask(){return rc},get GFXFilter(){return sc},get GFXAddress(){return lc},get GFXTextureType(){return hc},get GFXTextureUsageBit(){return dc},get GFXSampleCount(){return _c},get GFXTextureFlagBit(){return mc},get GFXTextureViewType(){return gc},get GFXShaderType(){return xc},get GFXBindingType(){return wc},get GFXCommandBufferType(){return Ec},get GFXLoadOp(){return Ac},get GFXStoreOp(){return Rc},get GFXTextureLayout(){return Mc},get GFXPipelineBindPoint(){return Lc},get GFXDynamicState(){return Bc},get GFXStencilFace(){return Dc},get GFXQueueType(){return Nc},get GFXClearFlag(){return Vc},GFXTextureSubres:Wc,GFXTextureCopy:Xc,GFXBufferTextureCopy:Yc,get GFXFormatType(){return qc},GFXFormatInfos:Qc,GFXFormatSize:Kc,GFXFormatSurfaceSize:Zc,GFXGetTypeSize:$c});function au(e,t){for(var i=e.length,n=t^i,r=0;4<=i;){var a=255&e.charCodeAt(r)|(255&e.charCodeAt(++r))<<8|(255&e.charCodeAt(++r))<<16|(255&e.charCodeAt(++r))<<24;a=1540483477*(65535&a)+((1540483477*(a>>>16)&65535)<<16),n=1540483477*(65535&n)+((1540483477*(n>>>16)&65535)<<16)^(a=1540483477*(65535&(a^=a>>>24))+((1540483477*(a>>>16)&65535)<<16)),i-=4,++r}switch(i){case 3:n^=(255&e.charCodeAt(r+2))<<16;case 2:n^=(255&e.charCodeAt(r+1))<<8;case 1:n=1540483477*(65535&(n^=255&e.charCodeAt(r)))+((1540483477*(n>>>16)&65535)<<16)}return n=1540483477*(65535&(n^=n>>>13))+((1540483477*(n>>>16)&65535)<<16),(n^=n>>>15)>>>0}mt(Il),(tu=eu=eu||{})[tu.UNKNOWN=0]="UNKNOWN",tu[tu.WEBGL=1]="WEBGL",tu[tu.WEBGL2=2]="WEBGL2",(nu=iu=iu||{})[nu.COLOR_FLOAT=0]="COLOR_FLOAT",nu[nu.COLOR_HALF_FLOAT=1]="COLOR_HALF_FLOAT",nu[nu.TEXTURE_FLOAT=2]="TEXTURE_FLOAT",nu[nu.TEXTURE_HALF_FLOAT=3]="TEXTURE_HALF_FLOAT",nu[nu.TEXTURE_FLOAT_LINEAR=4]="TEXTURE_FLOAT_LINEAR",nu[nu.TEXTURE_HALF_FLOAT_LINEAR=5]="TEXTURE_HALF_FLOAT_LINEAR",nu[nu.FORMAT_R11G11B10F=6]="FORMAT_R11G11B10F",nu[nu.FORMAT_D24S8=7]="FORMAT_D24S8",nu[nu.FORMAT_ETC1=8]="FORMAT_ETC1",nu[nu.FORMAT_ETC2=9]="FORMAT_ETC2",nu[nu.FORMAT_DXT=10]="FORMAT_DXT",nu[nu.FORMAT_PVRTC=11]="FORMAT_PVRTC",nu[nu.FORMAT_ASTC=12]="FORMAT_ASTC",nu[nu.MSAA=13]="MSAA",nu[nu.COUNT=14]="COUNT";var su,ou=P2("GFXDevice",function(){function e(){y(this,e),this._canvas=null,this._canvas2D=null,this._gfxAPI=eu.UNKNOWN,this._deviceName="",this._renderer="",this._vendor="",this._version="",this._features=new Array(iu.COUNT),this._queue=null,this._devicePixelRatio=1,this._width=0,this._height=0,this._nativeWidth=0,this._nativeHeight=0,this._mainWindow=null,this._cmdAllocator=null,this._maxVertexAttributes=0,this._maxVertexUniformVectors=0,this._maxFragmentUniformVectors=0,this._maxTextureUnits=0,this._maxVertexTextureUnits=0,this._maxUniformBufferBindings=Al,this._maxUniformBlockSize=0,this._depthBits=0,this._stencilBits=0,this._colorFmt=Il.UNKNOWN,this._depthStencilFmt=Il.UNKNOWN,this._shaderIdGen=0,this._macros=new Map,this._numDrawCalls=0,this._numTris=0,this._memoryStatus={bufferSize:0,textureSize:0}}return l(e,[{key:"hasFeature",value:function(e){return this._features[e]}},{key:"genShaderId",value:function(){return this._shaderIdGen++}},{key:"defineMacro",value:function(e,t){var i=void 0!==t?t:"";this._macros.set(e,i)}},{key:"canvas",get:function(){return this._canvas}},{key:"canvas2D",get:function(){return this._canvas2D}},{key:"gfxAPI",get:function(){return this._gfxAPI}},{key:"queue",get:function(){return this._queue}},{key:"devicePixelRatio",get:function(){return this._devicePixelRatio}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"nativeWidth",get:function(){return this._nativeWidth}},{key:"nativeHeight",get:function(){return this._nativeHeight}},{key:"mainWindow",get:function(){return this._mainWindow}},{key:"commandAllocator",get:function(){return this._cmdAllocator}},{key:"renderer",get:function(){return this._renderer}},{key:"vendor",get:function(){return this._vendor}},{key:"maxVertexAttributes",get:function(){return this._maxVertexAttributes}},{key:"maxVertexUniformVectors",get:function(){return this._maxVertexUniformVectors}},{key:"maxFragmentUniformVectors",get:function(){return this._maxFragmentUniformVectors}},{key:"maxTextureUnits",get:function(){return this._maxTextureUnits}},{key:"maxVertexTextureUnits",get:function(){return this._maxVertexTextureUnits}},{key:"maxUniformBufferBindings",get:function(){return this._maxUniformBufferBindings}},{key:"maxUniformBlockSize",get:function(){return this._maxUniformBlockSize}},{key:"depthBits",get:function(){return this._depthBits}},{key:"stencilBits",get:function(){return this._stencilBits}},{key:"colorFormat",get:function(){return this._colorFmt}},{key:"depthStencilFormat",get:function(){return this._depthStencilFmt}},{key:"macros",get:function(){return this._macros}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numTris",get:function(){return this._numTris}},{key:"memoryStatus",get:function(){return this._memoryStatus}}]),e}());function lu(i,e){e.forEach(function(t){Object.getOwnPropertyNames(t.prototype).forEach(function(e){"constructor"!==e&&Object.defineProperty(i.prototype,e,Object.getOwnPropertyDescriptor(t.prototype,e))})})}var cu,uu,hu,fu,du,pu,_u,vu=P2("RawAsset",ho("cc.RawAsset")(su=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))))._uuid=void 0,Object.defineProperty(u(t),"_uuid",{value:"",writable:!0}),t}return p(a,No),l(a,null,[{key:"isRawAssetType",value:function(e){return Ge(e,cc.RawAsset)&&!Ge(e,cc.Asset)}}]),a}())||su);cc.RawAsset=vu;var mu,yu,gu,bu,xu,Su,wu,Tu,Eu,Cu,Au,ku,Ru,Ou,Mu=P2("Asset",(cu=ho("cc.Asset"),uu=fo({visible:!1}),cu((_u=pu=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n)))).loaded=!0,v(t,"_native",du,u(t)),t._file=null,t._callbackTable=ke(!0),t}return p(a,vu),l(a,null,[{key:"deserialize",value:function(e){return cc.deserialize(e)}}]),l(a,[{key:"on",value:function(e,t,i){}},{key:"off",value:function(e,t,i){}},{key:"targetOff",value:function(e){}},{key:"once",value:function(e,t,i){}},{key:"dispatchEvent",value:function(e){}},{key:"hasEventListener",value:function(e,t,i){return!1}},{key:"removeAll",value:function(e){}},{key:"emit",value:function(e){}},{key:"toString",value:function(){return this.nativeUrl}},{key:"_setRawAsset",value:function(e,t){var i=!(1<arguments.length&&void 0!==t)||t;this._native=!1!==i?e||void 0:"/"+e}},{key:"nativeUrl",get:function(){if(this._native){var e=this._native;if(47===e.charCodeAt(0))return e.slice(1);if(cc.AssetLibrary){var t=cc.AssetLibrary.getLibUrlNoExt(this._uuid,!0);return 46===e.charCodeAt(0)?t+e:t+"/"+e}cc.errorID(6400)}return""}},{key:"_nativeAsset",get:function(){return this._file},set:function(e){this._file=e}}]),a}(),pu.preventDeferredLoadDependents=!1,pu.preventPreloadNativeObject=!1,du=m((fu=_u).prototype,"_native",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),m(fu.prototype,"nativeUrl",[uu],Object.getOwnPropertyDescriptor(fu.prototype,"nativeUrl"),fu.prototype),m(fu.prototype,"_nativeAsset",[fo],Object.getOwnPropertyDescriptor(fu.prototype,"_nativeAsset"),fu.prototype),hu=fu))||hu));lu(Mu,[sl,ll]),Mu.prototype.createNode=null,cc.Asset=Mu,(yu=mu=mu||{})[yu.RGB565=Il.R5G6B5]="RGB565",yu[yu.RGB5A1=Il.RGB5A1]="RGB5A1",yu[yu.RGBA4444=Il.RGBA4]="RGBA4444",yu[yu.RGB888=Il.RGB8]="RGB888",yu[yu.RGBA8888=Il.RGBA8]="RGBA8888",yu[yu.RGBA32F=Il.RGBA32F]="RGBA32F",yu[yu.A8=Il.A8]="A8",yu[yu.I8=Il.L8]="I8",yu[yu.AI8=Il.LA8]="AI8",yu[yu.RGB_PVRTC_2BPPV1=Il.PVRTC_RGB2]="RGB_PVRTC_2BPPV1",yu[yu.RGBA_PVRTC_2BPPV1=Il.PVRTC_RGBA2]="RGBA_PVRTC_2BPPV1",yu[yu.RGB_PVRTC_4BPPV1=Il.PVRTC_RGB4]="RGB_PVRTC_4BPPV1",yu[yu.RGBA_PVRTC_4BPPV1=Il.PVRTC_RGBA4]="RGBA_PVRTC_4BPPV1",yu[yu.RGB_ETC1=Il.ETC_RGB8]="RGB_ETC1",yu[yu.RGB_ETC2=Il.ETC2_RGB8]="RGB_ETC2",yu[yu.RGBA_ETC2=Il.ETC2_RGBA8]="RGBA_ETC2",(bu=gu=gu||{})[bu.REPEAT=lc.WRAP]="REPEAT",bu[bu.CLAMP_TO_EDGE=lc.CLAMP]="CLAMP_TO_EDGE",bu[bu.MIRRORED_REPEAT=lc.MIRROR]="MIRRORED_REPEAT",bu[bu.CLAMP_TO_BORDER=lc.BORDER]="CLAMP_TO_BORDER",(Su=xu=xu||{})[Su.NONE=sc.NONE]="NONE",Su[Su.LINEAR=sc.LINEAR]="LINEAR",Su[Su.NEAREST=sc.POINT]="NEAREST",(Tu=wu=wu||{})[Tu.NONE=Il.UNKNOWN]="NONE",Tu[Tu.DEPTH_16=Il.D16]="DEPTH_16",Tu[Tu.DEPTH_24=Il.D24]="DEPTH_24",Tu[Tu.DEPTH_32=Il.D32F]="DEPTH_32",Tu[Tu.DEPTH_16_STENCIL_8=Il.D16S8]="DEPTH_16_STENCIL_8",Tu[Tu.DEPTH_24_STENCIL_8=Il.D24S8]="DEPTH_24_STENCIL_8",Tu[Tu.DEPTH_32_STENCIL_8=Il.D32F_S8]="DEPTH_32_STENCIL_8";var Iu,Lu,zu=P2("ImageAsset",(Eu=ho("cc.ImageAsset"),Cu=fo({override:!0}),Eu((Ou=Ru=function(){function b(e){var t;return y(this,b),(t=x(this,g(b).call(this)))._nativeData=void 0,t._tex=void 0,t._url=void 0,t._exportedExts=void 0,t._format=mu.RGBA8888,t._width=0,t._height=0,t._url="",t.loaded=!1,t._nativeData={_data:null,width:0,height:0,format:0,_compressed:!1},void 0!==e&&(t._nativeAsset=e),t}return p(b,Mu),l(b,[{key:"_nativeAsset",get:function(){return this._nativeData},set:function(e){this.reset(e)}},{key:"data",get:function(){var e=this._nativeData._data;return ArrayBuffer.isView(e)||e instanceof ArrayBuffer?e:this._nativeData}},{key:"width",get:function(){return this._nativeData.width||this._width}},{key:"height",get:function(){return this._nativeData.height||this._height}},{key:"format",get:function(){return this._format}},{key:"isCompressed",get:function(){return this._format>=mu.RGB_ETC1&&this._format<=mu.RGBA_PVRTC_4BPPV1}},{key:"url",get:function(){return this._url}},{key:"_texture",set:function(e){this._tex=e},get:function(){if(!this._tex){var e=new cc.Texture2D;e.name=this._url,(e.image=this)._tex=e}return this._tex}}]),l(b,[{key:"reset",value:function(e){e instanceof HTMLElement?this._nativeData=e:(this._nativeData=e,this._nativeData.format=this._format),this._onDataComplete()}},{key:"_serialize",value:function(){var e=this._exportedExts;if(!e&&this._native&&(e=[this._native]),!e)return"";var t=[],i=e,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a,o=s.split("@"),l=b.extnames.indexOf(o[0]),c=l<0?s:"".concat(l);o[1]&&(c+="@"+o[1]),t.push(c)}return{fmt:t.join("_"),w:this.width,h:this.height}}},{key:"_deserialize",value:function(e,t){var i="";i="string"==typeof e?e:(this._width=e.w,this._height=e.h,e.fmt);var n=cc.director.root?cc.director.root.device:null,r=i.split("_"),a=Number.MAX_VALUE,s=this._format,o="",l=cc.macro.SUPPORT_TEXTURE_FORMATS,c=r,u=Array.isArray(c),h=0;for(c=u?c:c[Symbol.iterator]();;){var f;if(u){if(h>=c.length)break;f=c[h++]}else{if((h=c.next()).done)break;f=h.value}var d=f.split("@"),p=parseInt(d[0],void 0),_=b.extnames[p]||d.join(),v=l.indexOf(_);if(-1!==v&&v<a){var m=d[1]?parseInt(d[1]):this._format;if(!(".pvr"!==_||n&&n.hasFeature(iu.FORMAT_PVRTC)))continue;if(!(m!==mu.RGB_ETC1||n&&n.hasFeature(iu.FORMAT_ETC1)))continue;if(!(m!==mu.RGB_ETC2&&m!==mu.RGBA_ETC2||n&&n.hasFeature(iu.FORMAT_ETC2)))continue;if(".webp"===_&&!cc.sys.capabilities.webp)continue;a=v,o=_,s=m}}o&&(this._setRawAsset(o),this._format=s);var y=t.customEnv,g=y&&y.uuid;g&&(this._uuid=g,this._url=this.nativeUrl)}},{key:"_onDataComplete",value:function(){this.loaded=!0,this.emit("load")}}]),b}(),Ru.extnames=[".png",".jpg",".jpeg",".bmp",".webp",".pvr",".pkm"],m((ku=Ou).prototype,"_nativeAsset",[Cu],Object.getOwnPropertyDescriptor(ku.prototype,"_nativeAsset"),ku.prototype),Au=ku))||Au));cc.ImageAsset=zu,(Lu=Iu=Iu||{})[Lu.minFilter=0]="minFilter",Lu[Lu.magFilter=1]="magFilter",Lu[Lu.mipFilter=2]="mipFilter",Lu[Lu.addressU=3]="addressU",Lu[Lu.addressV=4]="addressV",Lu[Lu.addressW=5]="addressW",Lu[Lu.maxAnisotropy=6]="maxAnisotropy",Lu[Lu.cmpFunc=7]="cmpFunc",Lu[Lu.minLOD=8]="minLOD",Lu[Lu.maxLOD=9]="maxLOD",Lu[Lu.mipLODBias=10]="mipLODBias",Lu[Lu.borderColor=11]="borderColor",Lu[Lu.total=15]="total";var Bu=[sc.LINEAR,sc.LINEAR,sc.NONE,lc.WRAP,lc.WRAP,lc.WRAP,16,Kl.NEVER,0,0,0,0,0,0,0],Pu={};function Du(e){for(var t=0,i=0,n=0;n<Bu.length;n++)switch(t=e[n]||Bu[n],n){case Iu.minFilter:i|=t;break;case Iu.magFilter:i|=t<<2;break;case Iu.mipFilter:i|=t<<4;break;case Iu.addressU:i|=t<<6;break;case Iu.addressV:i|=t<<8;break;case Iu.addressW:i|=t<<10;break;case Iu.maxAnisotropy:i|=t<<12;break;case Iu.cmpFunc:i|=t<<16;break;case Iu.minLOD:i|=t<<20;break;case Iu.maxLOD:i|=t<<24;break;case Iu.mipLODBias:i|=t<<28}return i}var Fu,Nu,Uu,Vu,Gu,Hu,qu,ju,Wu,Xu,Yu,Qu,Ku,Zu,Ju,$u,eh,th,ih,nh=new(function(){function e(){y(this,e),this._cache={}}return l(e,[{key:"getSampler",value:function(e,t){var i=this._cache[t];return i||(0===t&&(t=Du(Bu)),Pu.minFilter=3&t,Pu.magFilter=t>>2&3,Pu.mipFilter=t>>4&3,Pu.addressU=t>>6&3,Pu.addressV=t>>8&3,Pu.addressW=t>>10&3,Pu.maxAnisotropy=t>>12&15,Pu.cmpFunc=t>>16&15,Pu.minLOD=t>>20&15,Pu.maxLOD=t>>24&15,Pu.mipLODBias=t>>28&15,Pu.borderColor={r:0,g:0,b:0,a:0},this._cache[t]=e.createSampler(Pu))}}]),e}()),rh=new ve("Tex"),ah=ho("cc.TextureBase")((Zu=Ku=function(){function i(){var e,t=0<arguments.length&&void 0!==arguments[0]&&arguments[0];return y(this,i),v(e=x(this,g(i).call(this)),"_format",Uu,u(e)),v(e,"_premultiplyAlpha",Vu,u(e)),v(e,"_flipY",Gu,u(e)),v(e,"_minFilter",Hu,u(e)),v(e,"_magFilter",qu,u(e)),v(e,"_mipFilter",ju,u(e)),v(e,"_wrapS",Wu,u(e)),v(e,"_wrapT",Xu,u(e)),v(e,"_wrapR",Yu,u(e)),v(e,"_anisotropy",Qu,u(e)),e._width=0,e._height=0,e._id=void 0,e._samplerInfo=[],e._samplerHash=0,e._flipY=t,e._id=rh.getNewId(),e.loaded=!1,e}return p(i,Mu),l(i,[{key:"isCompressed",get:function(){return this._format>=mu.RGB_ETC1&&this._format<=mu.RGBA_PVRTC_4BPPV1}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),l(i,[{key:"getId",value:function(){return this._id}},{key:"getPixelFormat",value:function(){return this._format}},{key:"hasPremultipliedAlpha",value:function(){return this._premultiplyAlpha||!1}},{key:"getAnisotropy",value:function(){return this._anisotropy}},{key:"setWrapMode",value:function(e,t,i){this._wrapS=e,this._samplerInfo[Iu.addressU]=e,this._wrapT=t,this._samplerInfo[Iu.addressV]=t,void 0!==i&&(this._wrapR=i,this._samplerInfo[Iu.addressW]=i),this._samplerHash=Du(this._samplerInfo)}},{key:"setFilters",value:function(e,t){this._minFilter=e,this._samplerInfo[Iu.minFilter]=e,this._magFilter=t,this._samplerInfo[Iu.magFilter]=t,this._samplerHash=Du(this._samplerInfo)}},{key:"setMipFilter",value:function(e){this._mipFilter=e,this._samplerInfo[Iu.mipFilter]=e,this._samplerInfo[Iu.maxLOD]=e===xu.NONE?0:1e3,this._samplerHash=Du(this._samplerInfo)}},{key:"setFlipY",value:function(e){this._flipY=e}},{key:"setPremultiplyAlpha",value:function(e){this._premultiplyAlpha=e}},{key:"setAnisotropy",value:function(e){this._anisotropy=e,this._samplerInfo[Iu.maxAnisotropy]=e,this._samplerHash=Du(this._samplerInfo)}},{key:"destroy",value:function(){return _(g(i.prototype),"destroy",this).call(this)}},{key:"getGFXTextureView",value:function(){return null}},{key:"getSamplerHash",value:function(){return this._samplerHash}},{key:"_serialize",value:function(e){return this._minFilter+","+this._magFilter+","+this._wrapS+","+this._wrapT+","+(this._premultiplyAlpha?1:0)+","+this._mipFilter+","+this._anisotropy+","+(this._flipY?1:0)}},{key:"_deserialize",value:function(e,t){var i=e.split(",");i.unshift(""),6<=i.length&&(this.setFilters(parseInt(i[1]),parseInt(i[2])),this.setWrapMode(parseInt(i[3]),parseInt(i[4])),this._premultiplyAlpha=49===i[5].charCodeAt(0)),8<=i.length&&(this.setMipFilter(parseInt(i[6])),this.setAnisotropy(parseInt(i[7]))),9<=i.length&&(this._flipY=49===i[8].charCodeAt(0))}},{key:"_getGFXDevice",value:function(){return cc.director.root&&cc.director.root.device}},{key:"_getGFXFormat",value:function(){return this._format}},{key:"_setGFXFormat",value:function(e){this._format=void 0===e?mu.RGBA8888:e}}]),i}(),Ku.PixelFormat=mu,Ku.WrapMode=gu,Ku.Filter=xu,Uu=m((Nu=Zu).prototype,"_format",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mu.RGBA8888}}),Vu=m(Nu.prototype,"_premultiplyAlpha",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Gu=m(Nu.prototype,"_flipY",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Hu=m(Nu.prototype,"_minFilter",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xu.LINEAR}}),qu=m(Nu.prototype,"_magFilter",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xu.LINEAR}}),ju=m(Nu.prototype,"_mipFilter",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xu.NONE}}),Wu=m(Nu.prototype,"_wrapS",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return gu.REPEAT}}),Xu=m(Nu.prototype,"_wrapT",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return gu.REPEAT}}),Yu=m(Nu.prototype,"_wrapR",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return gu.REPEAT}}),Qu=m(Nu.prototype,"_anisotropy",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 16}}),Fu=Nu))||Fu;cc.TextureBase=ah,mt(wu);var sh,oh=P2("RenderTexture",ho("cc.RenderTexture")((ih=th=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))))._window=null,v(t,"_depthStencilFormat",eh,u(t)),t}return p(a,ah),l(a,[{key:"getGFXWindow",value:function(){return this._window}},{key:"getGFXTextureView",value:function(){return this._window?this._window.colorTexView:null}},{key:"getGFXStencilTexture",value:function(){return this._window?this._window.depthStencilTexView:null}},{key:"reset",value:function(e){e&&(this._width=e.width,this._height=e.height,e.colorFormat&&(this._format=e.colorFormat),e.depthStencilFormat&&(this._depthStencilFormat=e.depthStencilFormat),this._tryResetWindow(),this.emit("resize",this))}},{key:"destroy",value:function(){return this._window&&(cc.director.root.destroyWindow(this._window),this._window=null),_(g(a.prototype),"destroy",this).call(this)}},{key:"onLoaded",value:function(){this._tryResetWindow(),this.loaded=!0,this.emit("load")}},{key:"_serialize",value:function(e){return{base:_(g(a.prototype),"_serialize",this).call(this),name:this._name,width:this._width,height:this._height,colorFormat:this._format,depthStencilFormat:this._depthStencilFormat}}},{key:"_deserialize",value:function(e,t){_(g(a.prototype),"_deserialize",this).call(this,e.base,t);var i=e;this.name=i.name||"",this._width=i.width,this._height=i.height,this._format=i.colorFormat,this._depthStencilFormat=i.depthStencilFormat}},{key:"_tryResetWindow",value:function(){var e=this._getGFXDevice();e&&(this._window&&this._window.destroy(),this._createWindow(e))}},{key:"_createWindow",value:function(e){var t={title:this.name,isOffscreen:!0,width:this._width,height:this._height,colorFmt:this._format,depthStencilFmt:this._depthStencilFormat};if(this._window)return this._window.initialize(t),this._window;this._window=cc.director.root.createWindow(t)}},{key:"width",get:function(){return this._width},set:function(e){this._width=e,this.reset()}},{key:"height",get:function(){return this._height},set:function(e){this._height=e,this.reset()}},{key:"depthStencilFormat",get:function(){return this._depthStencilFormat},set:function(e){this._depthStencilFormat=e,this.reset()}}]),a}(),th.DepthStencilFormat=wu,eh=m(($u=ih).prototype,"_depthStencilFormat",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wu.NONE}}),m($u.prototype,"width",[fo],Object.getOwnPropertyDescriptor($u.prototype,"width"),$u.prototype),m($u.prototype,"height",[fo],Object.getOwnPropertyDescriptor($u.prototype,"height"),$u.prototype),m($u.prototype,"depthStencilFormat",[fo],Object.getOwnPropertyDescriptor($u.prototype,"depthStencilFormat"),$u.prototype),Ju=$u))||Ju);cc.RenderTexture=oh;var lh,ch,uh,hh,fh,dh=[{buffOffset:0,buffStride:0,buffTexHeight:0,texOffset:{x:0,y:0,z:0},texExtent:{width:1,height:1,depth:1},texSubres:{baseMipLevel:1,levelCount:1,baseArrayLayer:0,layerCount:1}}],ph=ho("cc.SimpleTexture")(sh=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))))._mipmapLevel=1,t._gfxTexture=null,t._gfxTextureView=null,t}return p(a,ah),l(a,[{key:"getGFXTexture",value:function(){return this._gfxTexture}},{key:"getGFXTextureView",value:function(){return this._gfxTextureView}},{key:"destroy",value:function(){return this._tryDestroyTexture(),_(g(a.prototype),"destroy",this).call(this)}},{key:"updateImage",value:function(){this.updateMipmaps(0)}},{key:"updateMipmaps",value:function(){}},{key:"uploadData",value:function(e,t,i){var n=1<arguments.length&&void 0!==t?t:0,r=2<arguments.length&&void 0!==i?i:0;if(this._gfxTexture&&!(this._gfxTexture.mipLevel<=n)){var a=this._getGFXDevice();if(a){var s=dh[0];s.texExtent.width=this._gfxTexture.width>>n,s.texExtent.height=this._gfxTexture.height>>n,s.texSubres.baseMipLevel=n,s.texSubres.baseArrayLayer=r,e instanceof ArrayBuffer?a.copyBuffersToTexture([e],this._gfxTexture,dh):a.copyTexImagesToTexture([e],this._gfxTexture,dh)}}}},{key:"_assignImage",value:function(i,n,r){function e(){var e,t=i.data;t&&(e=ArrayBuffer.isView(t)?t.buffer:t,a.uploadData(e,n,r),a._checkTextureLoaded())}var a=this;if(i.loaded)e();else{if(i.once("load",function(){e()}),!this.isCompressed){var t=cc.builtinResMgr.get("black-texture").image;this.uploadData(t.data,n,r)}cc.textureUtil.postLoadImage(i)}}},{key:"_checkTextureLoaded",value:function(){this._textureReady()}},{key:"_textureReady",value:function(){this.loaded=!0,this.emit("load")}},{key:"_setMipmapLevel",value:function(e){this._mipmapLevel=e<1?1:e}},{key:"_getGfxTextureCreateInfo",value:function(e){return null}},{key:"_getGfxTextureViewCreateInfo",value:function(e){return null}},{key:"_tryReset",value:function(){this._tryDestroyTexture();var e=this._getGFXDevice();e&&this._createTexture(e)}},{key:"_createTexture",value:function(e){var t=this._getGfxTextureCreateInfo({usage:dc.SAMPLED|dc.TRANSFER_DST,format:this._getGFXFormat(),mipLevel:this._mipmapLevel,flags:this._mipFilter!==xu.NONE?mc.GEN_MIPMAP:mc.NONE});if(t){var i=e.createTexture(t),n=this._getGfxTextureViewCreateInfo({texture:i,format:this._getGFXFormat()});if(n){var r=e.createTextureView(n);r?(this._gfxTexture=i,this._gfxTextureView=r):i.destroy()}else i.destroy()}}},{key:"_tryDestroyTexture",value:function(){this._gfxTexture&&(this._gfxTexture.destroy(),this._gfxTexture=null),this._gfxTextureView&&(this._gfxTextureView.destroy(),this._gfxTextureView=null)}}]),a}())||sh;cc.SimpleTexture=ph;var _h,vh=P2("Texture2D",(lh=ho("cc.Texture2D"),ch=fo([zu]),lh((fh=m((hh=function(){function a(){var e;return y(this,a),v(e=x(this,g(a).call(this,!0)),"_mipmaps",fh,u(e)),e}return p(a,ph),l(a,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var i=this;if(this._mipmaps=e,0<this._mipmaps.length){var t=this._mipmaps[0];this.reset({width:t.width,height:t.height,format:t.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach(function(e,t){i._assignImage(e,t)})}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}]),l(a,[{key:"onLoaded",value:function(){this.initialize()}},{key:"reset",value:function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format),this._setMipmapLevel(e.mipmapLevel||1),this._tryReset()}},{key:"create",value:function(e,t,i,n){var r=2<arguments.length&&void 0!==i?i:mu.RGBA8888,a=3<arguments.length&&void 0!==n?n:1;this.reset({width:e,height:t,format:r,mipmapLevel:a})}},{key:"toString",value:function(){return 0!==this._mipmaps.length?this._mipmaps[0].url:""}},{key:"updateMipmaps",value:function(e,t){var i=0<arguments.length&&void 0!==e?e:0,n=1<arguments.length?t:void 0;if(!(i>=this._mipmaps.length))for(var r=Math.min(void 0===n?this._mipmaps.length:n,this._mipmaps.length-i),a=0;a<r;++a){var s=i+a;this._assignImage(this._mipmaps[s],s)}}},{key:"getHtmlElementObj",value:function(){return this._mipmaps[0]&&this._mipmaps[0].data instanceof HTMLElement?this._mipmaps[0].data:null}},{key:"destroy",value:function(){return this._mipmaps=[],_(g(a.prototype),"destroy",this).call(this)}},{key:"description",value:function(){var e=this._mipmaps[0]?this._mipmaps[0].url:"";return"<cc.Texture2D | Name = ".concat(e," | Dimension = ").concat(this.width," x ").concat(this.height,">")}},{key:"releaseTexture",value:function(){this.destroy()}},{key:"_serialize",value:function(t){return{base:_(g(a.prototype),"_serialize",this).call(this,t),mipmaps:this._mipmaps.map(function(e){return e&&e._uuid?t?Editor.Utils.UuidUtils.compressUuid(e._uuid,!0):e._uuid:null})}}},{key:"_deserialize",value:function(e,t){var i=e;_(g(a.prototype),"_deserialize",this).call(this,i.base,t),this._mipmaps=new Array(i.mipmaps.length);for(var n=0;n<i.mipmaps.length;++n)if(this._mipmaps[n]=new zu,i.mipmaps[n]){var r=i.mipmaps[n];t.result.push(this._mipmaps,"".concat(n),r),this._mipmaps[n]._texture=this}}},{key:"initialize",value:function(){this.mipmaps=this._mipmaps}},{key:"_getGfxTextureCreateInfo",value:function(e){return Object.assign({type:hc.TEX2D,width:this._width,height:this._height},e)}},{key:"_getGfxTextureViewCreateInfo",value:function(e){return Object.assign({type:gc.TV2D},e)}},{key:"_checkTextureLoaded",value:function(){for(var e=!0,t=0;t<this._mipmaps.length;++t){if(!this._mipmaps[t].loaded){e=!1;break}}e&&_(g(a.prototype),"_textureReady",this).call(this)}}]),a}()).prototype,"_mipmaps",[ch],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),uh=hh))||uh));cc.Texture2D=vh;var mh,yh,gh,bh,xh,Sh,wh,Th=[{u:0,v:0},{u:0,v:0},{u:0,v:0},{u:0,v:0}],Eh=P2("SpriteFrame",ho("cc.SpriteFrame")(_h=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this))).vertices=null,e.uv=[],e.uvHash=0,e._image=null,e.uvSliced=[],e._rect=new Zn,e._offset=new Mi,e._originalSize=new jn,e._rotated=!1,e._capInsets=[0,0,0,0],e._atlasUuid="",e._texture=void 0,e._flipUv=!1,e}return p(t,Mu),l(t,[{key:"insetTop",get:function(){return this._capInsets[1]},set:function(e){this._capInsets[1]=e,this._calculateSlicedUV()}},{key:"insetBottom",get:function(){return this._capInsets[3]},set:function(e){this._capInsets[3]=e,this._calculateSlicedUV()}},{key:"insetLeft",get:function(){return this._capInsets[0]},set:function(e){this._capInsets[0]=e,this._calculateSlicedUV()}},{key:"insetRight",get:function(){return this._capInsets[2]},set:function(e){this._capInsets[2]=e,this._calculateSlicedUV()}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect.set(e),this._calculateUV()}},{key:"originalSize",get:function(){return this._originalSize},set:function(e){this._originalSize.set(e),this._calculateUV()}},{key:"_imageSource",set:function(e){this._image=e,window.Editor&&Editor.isBuilder||(this._texture=e._texture,this._texture.on("load",this._textureLoaded,this),this._calculateUV())}},{key:"texture",get:function(){return this._texture||(this._texture=!this._image||window.Editor&&Editor.isBuilder?new vh:this._image._texture,this._texture.on("load",this._textureLoaded,this)),this._texture},set:function(e){e?(this.reset({texture:e},!0),this._texture instanceof oh&&this.onLoaded()):console.warn("Error Texture in ".concat(this.name))}},{key:"atlasUuid",get:function(){return this._atlasUuid},set:function(e){this._atlasUuid=e}},{key:"width",get:function(){return this._texture.width}},{key:"height",get:function(){return this._texture.height}}]),l(t,[{key:"textureLoaded",value:function(){return this.loaded}},{key:"isRotated",value:function(){return this._rotated}},{key:"setRotated",value:function(e){this._rotated=e}},{key:"getRect",value:function(e){return e?(e.set(this._rect),e):this._rect.clone()}},{key:"setRect",value:function(e){this._rect.set(e)}},{key:"getOriginalSize",value:function(e){return e?(e.set(this._originalSize),e):this._originalSize.clone()}},{key:"setOriginalSize",value:function(e){this._originalSize.set(e)}},{key:"getOffset",value:function(e){return e?(e.set(this._offset),e):this._offset.clone()}},{key:"setOffset",value:function(e){this._offset.set(e)}},{key:"getGFXTextureView",value:function(){return this._texture.getGFXTextureView()}},{key:"reset",value:function(e,t){var i=!1;1<arguments.length&&void 0!==t&&t&&(this._originalSize.set(0,0),this._rect.set(0,0,0,0),this._offset.set(0,0),this._capInsets=[0,0,0,0],i=!(this._rotated=!1)),e&&(e.texture&&(this._rect.x=this._rect.y=0,this._rect.width=e.texture.width,this._rect.height=e.texture.height,this._texture&&this._texture.off("load"),this._texture=e.texture,this.checkRect(this._texture),this._texture.on("load",this._textureLoaded,this)),e.originalSize&&this._originalSize.set(e.originalSize),e.rect&&this._rect.set(e.rect),e.offset&&this._offset.set(e.offset),void 0!==e.borderTop&&(this._capInsets[1]=e.borderTop),void 0!==e.borderBottom&&(this._capInsets[3]=e.borderBottom),void 0!==e.borderLeft&&(this._capInsets[0]=e.borderLeft),void 0!==e.borderRight&&(this._capInsets[2]=e.borderRight),void 0!==e.isRotate&&(this._rotated=!!e.isRotate),void 0!==e.isFlipUv&&(this._flipUv=!!e.isFlipUv),this._texture instanceof oh&&(this._flipUv=!0),i=!0),i&&this._calculateUV()}},{key:"checkRect",value:function(e){var t=this._rect,i=t.x,n=t.y;return this._rotated?(i+=t.height,n+=t.width):(i+=t.width,n+=t.height),i>e.width?(cc.errorID(3300,this.name+"/"+e.name,i,e.width),!1):!(n>e.height)||(cc.errorID(3400,this.name+"/"+e.name,n,e.height),!1)}},{key:"onLoaded",value:function(){this.loaded=!0,this.emit("load")}},{key:"destroy",value:function(){return this._texture&&this._texture.off("load"),_(g(t.prototype),"destroy",this).call(this)}},{key:"_calculateSlicedUV",value:function(){var e=this._rect,t=this.texture,i=t.width,n=t.height,r=this._capInsets[0],a=this._capInsets[2],s=e.width-r-a,o=this._capInsets[1],l=this._capInsets[3],c=e.height-o-l,u=this.uvSliced;if(u.length=0,this._rotated){Th[0].u=(e.x+e.height)/i,Th[1].u=(e.x+l+c)/i,Th[2].u=(e.x+l)/i,Th[3].u=e.x/i,Th[3].v=(e.y+e.width)/n,Th[2].v=(e.y+r+s)/n,Th[1].v=(e.y+r)/n,Th[0].v=e.y/n;for(var h=0;h<4;++h)for(var f=Th[h],d=0;d<4;++d){var p=Th[3-d];u.push({u:f.u,v:p.v})}}else{Th[0].u=e.x/i,Th[1].u=(e.x+r)/i,Th[2].u=(e.x+r+s)/i,Th[3].u=(e.x+e.width)/i,Th[3].v=e.y/n,Th[2].v=(e.y+o)/n,Th[1].v=(e.y+o+c)/n,Th[0].v=(e.y+e.height)/n;for(var _=0;_<4;++_)for(var v=Th[_],m=0;m<4;++m){var y=Th[m];u.push({u:y.u,v:v.v})}}}},{key:"_calculateUV",value:function(){var e=this._rect,t=this.uv,i=this.texture,n=i.width,r=i.height;if(this._rotated){var a=0===n?0:e.x/n,s=0===n?0:(e.x+e.height)/n,o=0===r?0:e.y/r,l=0===r?0:(e.y+e.width)/r;this._flipUv?(t[0]=a,t[1]=o,t[2]=a,t[3]=l,t[4]=s,t[5]=o,t[6]=s,t[7]=l):(t[0]=s,t[1]=l,t[2]=s,t[3]=o,t[4]=a,t[5]=l,t[6]=a,t[7]=o)}else{var c=0===n?0:e.x/n,u=0===n?0:(e.x+e.width)/n,h=0===r?0:(e.y+e.height)/r,f=0===r?0:e.y/r;this._flipUv?(t[0]=c,t[1]=f,t[2]=u,t[3]=f,t[4]=c,t[5]=h,t[6]=u,t[7]=h):(t[0]=c,t[1]=h,t[2]=u,t[3]=h,t[4]=c,t[5]=f,t[6]=u,t[7]=f)}for(var d="",p=0;p<t.length;p++)d+=t[p];this.uvHash=au(d,666);var _=this.vertices;if(_){_.nu.length=0;for(var v=_.nv.length=0;v<_.u.length;v++)_.nu[v]=_.u[v]/n,_.nv[v]=_.v[v]/r}this._calculateSlicedUV()}},{key:"_serialize",value:function(e){var t,i=this._rect,n=this._offset,r=this._originalSize,a=this._uuid;return a&&e&&(a=Editor.Utils.UuidUtils.compressUuid(a,!0)),this.vertices&&(t={triangles:this.vertices.triangles,x:this.vertices.x,y:this.vertices.y,u:this.vertices.u,v:this.vertices.v}),{image:this._image?e?Editor.Utils.UuidUtils.compressUuid(this._image._uuid,!0):this._image._uuid:void 0,name:this._name,atlas:e?void 0:this._atlasUuid,rect:i,offset:n,originalSize:r,rotated:this._rotated,capInsets:this._capInsets,vertices:t}}},{key:"_deserialize",value:function(e,t){var i=e,n=i.rect;n&&this.setRect(new Zn(n.x,n.y,n.width,n.height));var r=i.offset;i.offset&&this.setOffset(new Mi(r.x,r.y));var a=i.originalSize;i.originalSize&&this.setOriginalSize(new jn(a.width,a.height)),this._rotated=!!i.rotated,this._name=i.name;var s=i.capInsets;s&&(this._capInsets[0]=s[0],this._capInsets[1]=s[1],this._capInsets[2]=s[2],this._capInsets[3]=s[3]),t.result.push(this,"_imageSource",i.image),this.vertices=i.vertices,this.vertices&&(this.vertices.nu=[],this.vertices.nv=[])}},{key:"_textureLoaded",value:function(){var e=this._texture,t={},i=!1;0!==this._rect.width&&0!==this._rect.height&&this.checkRect(e)||(t.rect=new Zn(0,0,e.width,e.height),i=!0),0!==this._originalSize.width&&0!==this._originalSize.height&&!i||(t.originalSize=new jn(e.width,e.height),i=!0),i&&(this.reset(t),this.onLoaded())}}]),t}())||_h);cc.SpriteFrame=Eh,(wh=Sh=Sh||{})[wh.right=0]="right",wh[wh.left=1]="left",wh[wh.top=2]="top",wh[wh.bottom=3]="bottom",wh[wh.front=4]="front",wh[wh.back=5]="back";var Ch=P2("TextureCube",ho("cc.TextureCube")((xh=bh=function(){function s(){var e;return y(this,s),v(e=x(this,g(s).call(this)),"_mipmaps",gh,u(e)),e}return p(s,ph),l(s,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var n=this;if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),0<this._mipmaps.length){var t=this._mipmaps[0].front;this.reset({width:t.width,height:t.height,format:t.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach(function(e,i){Ah(e,function(e,t){n._assignImage(e,i,t)})})}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}],[{key:"fromTexture2DArray",value:function(e,t){for(var i=[],n=e.length/6,r=0;r<n;r++){var a=6*r;i.push({front:e[a+Sh.front].image,back:e[a+Sh.back].image,left:e[a+Sh.left].image,right:e[a+Sh.right].image,top:e[a+Sh.top].image,bottom:e[a+Sh.bottom].image})}return(t=t||new s).mipmaps=i,t}}]),l(s,[{key:"onLoaded",value:function(){this.mipmaps=this._mipmaps,this.loaded=!0,this.emit("load")}},{key:"reset",value:function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format),this._setMipmapLevel(e.mipmapLevel||1),this._tryReset()}},{key:"updateMipmaps",value:function(e,t){var n=this,r=0<arguments.length&&void 0!==e?e:0,i=1<arguments.length?t:void 0;if(!(r>=this._mipmaps.length))for(var a=Math.min(void 0===i?this._mipmaps.length:i,this._mipmaps.length-r),s=function(e){var i=r+e;Ah(n._mipmaps[i],function(e,t){n._assignImage(e,i,t)})},o=0;o<a;++o)s(o)}},{key:"destroy",value:function(){return this._mipmaps=[],_(g(s.prototype),"destroy",this).call(this)}},{key:"releaseTexture",value:function(){this.mipmaps=[]}},{key:"_serialize",value:function(t){return{base:_(g(s.prototype),"_serialize",this).call(this),mipmaps:this._mipmaps.map(function(e){return t?{front:Editor.Utils.UuidUtils.compressUuid(e.front._uuid,!0),back:Editor.Utils.UuidUtils.compressUuid(e.back._uuid,!0),left:Editor.Utils.UuidUtils.compressUuid(e.left._uuid,!0),right:Editor.Utils.UuidUtils.compressUuid(e.right._uuid,!0),top:Editor.Utils.UuidUtils.compressUuid(e.top._uuid,!0),bottom:Editor.Utils.UuidUtils.compressUuid(e.bottom._uuid,!0)}:{front:e.front._uuid,back:e.back._uuid,left:e.left._uuid,right:e.right._uuid,top:e.top._uuid,bottom:e.bottom._uuid}})}}},{key:"_deserialize",value:function(e,t){var i=e;_(g(s.prototype),"_deserialize",this).call(this,i.base,t),this._mipmaps=new Array(i.mipmaps.length);for(var n=0;n<i.mipmaps.length;++n){this._mipmaps[n]={front:new zu,back:new zu,left:new zu,right:new zu,top:new zu,bottom:new zu};var r=i.mipmaps[n];t.result.push(this._mipmaps[n],"front",r.front),t.result.push(this._mipmaps[n],"back",r.back),t.result.push(this._mipmaps[n],"left",r.left),t.result.push(this._mipmaps[n],"right",r.right),t.result.push(this._mipmaps[n],"top",r.top),t.result.push(this._mipmaps[n],"bottom",r.bottom)}}},{key:"_getGfxTextureCreateInfo",value:function(e){var t=Object.assign({type:hc.TEX2D,width:this._width,height:this._height,arrayLayer:6},e);return t.flags=(t.flags||0)|mc.CUBEMAP,t}},{key:"_getGfxTextureViewCreateInfo",value:function(e){return Object.assign({type:gc.CUBE,layerCount:6},e)}}]),s}(),bh.FaceIndex=Sh,gh=m((yh=xh).prototype,"_mipmaps",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),mh=yh))||mh);function Ah(e,t){t(e.front,Sh.front),t(e.back,Sh.back),t(e.left,Sh.left),t(e.right,Sh.right),t(e.top,Sh.top),t(e.bottom,Sh.bottom)}cc.TextureCube=Ch;var kh=P2("GFXBuffer",function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,bl.BUFFER)))._device=void 0,t._usage=zl.NONE,t._memUsage=Pl.NONE,t._size=0,t._stride=1,t._count=0,t._flags=Fl.NONE,t._bufferView=null,t._device=e,t}return p(i,Hc),l(i,[{key:"usage",get:function(){return this._usage}},{key:"memUsage",get:function(){return this._memUsage}},{key:"size",get:function(){return this._size}},{key:"stride",get:function(){return this._stride}},{key:"count",get:function(){return this._count}},{key:"flags",get:function(){return this._flags}},{key:"bufferView",get:function(){return this._bufferView}}]),i}()),Rh=P2("GFXCommandBuffer",function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,bl.COMMAND_BUFFER)))._device=void 0,t._allocator=null,t._type=Ec.PRIMARY,t._numDrawCalls=0,t._numTris=0,t._device=e,t}return p(i,Hc),l(i,[{key:"type",get:function(){return this._type}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numTris",get:function(){return this._numTris}}]),i}()),Oh=P2("GFXFramebuffer",function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,bl.FRAMEBUFFER)))._device=void 0,t._renderPass=null,t._colorViews=[],t._depthStencilView=null,t._isOffscreen=!0,t._device=e,t}return p(i,Hc),l(i,[{key:"renderPass",get:function(){return this._renderPass}},{key:"colorViews",get:function(){return this._colorViews}},{key:"depthStencilView",get:function(){return this._depthStencilView}},{key:"isOffscreen",get:function(){return this._isOffscreen}}]),i}());function Mh(e,t){if(t)0;else{var i=cc.director.getScene();if(!i)return null;t=i}return t.getChildByPath(e)}cc.find=Mh;var Ih,Lh,zh,Bh,Ph=function(){function e(){y(this,e),this._arrayBufferOrPaddings=[],this._length=0}return l(e,[{key:"setNextAlignment",value:function(e){if(0!==e){var t=this._length%e;if(0!=t){var i=e-t;this._arrayBufferOrPaddings.push(i),this._length+=i}}}},{key:"addBuffer",value:function(e){var t=this._length;return this._arrayBufferOrPaddings.push(e),this._length+=e.byteLength,t}},{key:"getLength",value:function(){return this._length}},{key:"getCombined",value:function(){var t=new Uint8Array(this._length),i=0;return this._arrayBufferOrPaddings.forEach(function(e){"number"==typeof e?i+=e:(t.set(new Uint8Array(e),i),i+=e.byteLength)}),t.buffer}}]),e}();var Dh=function(){function t(e){y(this,t),this._subMeshes=e}return l(t,[{key:"getSubmesh",value:function(e){return this._subMeshes[e]}},{key:"destroySubMeshes",value:function(){for(var e=0;e<this._subMeshes.length;++e){for(var t=this._subMeshes[e],i=0;i<t.vertexBuffers.length;++i)t.vertexBuffers[i].destroy();t.indexBuffer&&t.indexBuffer.destroy()}this._subMeshes.splice(0)}},{key:"destroy",value:function(){this.destroySubMeshes(),this._subMeshes.length=0}},{key:"subMeshes",get:function(){return this._subMeshes}},{key:"subMeshCount",get:function(){return this._subMeshes.length}}]),t}(),Fh=P2("Mesh",ho("cc.Mesh")((zh=m((Lh=function(){function t(){var e;return y(this,t),v(e=x(this,g(t).call(this)),"_struct",zh,u(e)),v(e,"_dataLength",Bh,u(e)),e._data=null,e._initialized=!1,e._hasFlatBuffers=!1,e._renderingMesh=null,e.loaded=!1,e}return p(t,Mu),l(t,[{key:"_nativeAsset",get:function(){return this._data.buffer},set:function(e){this._data&&this._data.byteLength===e.byteLength?(this._data.set(new Uint8Array(e)),cc.loader._cache[this.nativeUrl]&&(cc.loader._cache[this.nativeUrl].content=this._data.buffer)):this._data=new Uint8Array(e),this.loaded=!0,this.emit("load")}},{key:"subMeshCount",get:function(){var e=this.renderingMesh;return e?e.subMeshCount:0}},{key:"minPosition",get:function(){return this.struct.minPosition}},{key:"maxPosition",get:function(){return this.struct.maxPosition}},{key:"struct",get:function(){return this._struct}},{key:"data",get:function(){return this._data}},{key:"hasFlatBuffers",get:function(){return this._hasFlatBuffers}}]),l(t,[{key:"initialize",value:function(){var u=this;if(!this._initialized){this._initialized=!0,this._data||(this._data=new Uint8Array(this._dataLength),function(i,n){i.loaded?n&&n():i.nativeUrl?cc.loader.load({url:i.nativeUrl},function(e,t){t&&(i.loaded||(i._nativeAsset=t)),n&&n(e)}):n&&n()}(this));var h=this._data.buffer,f=cc.director.root.device,d=this._createVertexBuffers(f,h),p=[],e=function(){if(v){if(m>=_.length)return"break";y=_[m++]}else{if((m=_.next()).done)return"break";y=m.value}var e=y;if(0===e.vertexBundelIndices.length)return"continue";var t=null,i=null;if(e.indexView){var n=e.indexView;t=f.createBuffer({usage:zl.INDEX|zl.TRANSFER_DST,memUsage:Pl.HOST|Pl.DEVICE,size:n.length,stride:n.stride}),i=new(function(e){switch(e){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}return Uint8Array}(n.stride))(h,n.offset,n.count),u.loaded?t.update(i):u.once("load",function(){t.update(i)})}var r=e.vertexBundelIndices.map(function(e){return d[e]}),a=[];if(0<e.vertexBundelIndices.length){var s=e.vertexBundelIndices[0];a=u._struct.vertexBundles[s].attributes}var o={primitiveMode:e.primitiveMode,vertexBuffers:r,flatBuffers:[],indexBuffer:t,attributes:a};if(e.geometricInfo){var l=e.geometricInfo,c=new Float32Array(h,l.view.offset,l.view.length/4);o.geometricInfo={indices:i,positions:c}}p.push(o)};var _=this._struct.primitives,v=Array.isArray(_),m=0;e:for(_=v?_:_[Symbol.iterator]();;){var y;switch(e()){case"break":break e;case"continue":continue}}this._renderingMesh=new Dh(p)}}},{key:"destroy",value:function(){return this.destroyRenderingMesh(),_(g(t.prototype),"destroy",this).call(this)}},{key:"destroyRenderingMesh",value:function(){this._renderingMesh&&(this._renderingMesh.destroy(),this._renderingMesh=null,this._data=null,this._initialized=!1)}},{key:"assign",value:function(e,t){this.reset({struct:e,data:t})}},{key:"reset",value:function(e){this.destroyRenderingMesh(),this._struct=e.struct,this._data=e.data,this.loaded=!0,this.emit("load")}},{key:"getSubMesh",value:function(e){return this.renderingMesh.getSubmesh(e)}},{key:"merge",value:function(e,t){if(void 0!==t&&t&&(!this.loaded||!e.loaded||!this.validateMergingMesh(e)))return!1;if(!this._initialized&&e._data){var i=JSON.parse(JSON.stringify(e._struct)),n=e._data.slice();return this.reset({struct:i,data:n}),this.initialize(),!0}for(var r,a,s,o,l,c=new Ph,u=0,h=0,f=0,d=0,p=0,_=0,v=0,m=0,y=!1,g=new Array(this._struct.vertexBundles.length),b=0;b<this._struct.vertexBundles.length;++b){var x=this._struct.vertexBundles[b],S=e._struct.vertexBundles[b];f=x.view.offset,d=S.view.offset,h=x.view.stride,u=x.view.count+S.view.count,r=new ArrayBuffer(u*h),a=new Uint8Array(r),f+=(s=this._data.subarray(f,f+x.view.length)).length,d+=(o=e._data.subarray(d,d+S.view.length)).length,a.set(s),p=0;var w=x.attributes,T=Array.isArray(w),E=0;for(w=T?w:w[Symbol.iterator]();;){var C;if(T){if(E>=w.length)break;C=w[E++]}else{if((E=w.next()).done)break;C=E.value}var A=C;v=0,y=!1;var k=S.attributes,R=Array.isArray(k),O=0;for(k=R?k:k[Symbol.iterator]();;){var M;if(R){if(O>=k.length)break;M=k[O++]}else{if((O=k.next()).done)break;M=O.value}var I=M;if(A.name===I.name&&A.format===I.format){y=!0;break}v+=Qc[I.format].size}if(y){m=Qc[A.format].size,_=x.view.length+p;for(var L=0;L<S.view.count;++L)l=o.subarray(v,v+m),a.set(l,_),_+=x.view.stride,v+=S.view.stride}p+=Qc[A.format].size}g[b]={attributes:x.attributes,view:{offset:c.getLength(),length:r.byteLength,count:u,stride:h}},c.addBuffer(r)}for(var z,B,P,D=0,F=2,N=0,U=new Array(this._struct.primitives.length),V=0;V<this._struct.primitives.length;++V){var G=this._struct.primitives[V],H=e._struct.primitives[V];U[V]={primitiveMode:G.primitiveMode,vertexBundelIndices:G.vertexBundelIndices};var q=G.vertexBundelIndices,j=Array.isArray(q),W=0;for(q=j?q:q[Symbol.iterator]();;){var X;if(j){if(W>=q.length)break;X=q[W++]}else{if((W=q.next()).done)break;X=W.value}var Y=X;N=Math.max(N,this._struct.vertexBundles[Y].view.count)}if(G.indexView&&H.indexView){D=G.indexView.count,D+=H.indexView.count,f=G.indexView.offset,d=H.indexView.offset,F=D<256?1:D<65536?2:4;var Q=new ArrayBuffer(D*F);if(z=2===F?new Uint16Array(Q):1===F?new Uint8Array(Q):new Uint32Array(Q),B=2===G.indexView.stride?new Uint16Array(this._data.buffer,f,G.indexView.count):1===G.indexView.stride?new Uint8Array(this._data.buffer,f,G.indexView.count):new Uint32Array(this._data.buffer,f,G.indexView.count),F===G.indexView.stride)z.set(B);else for(var K=0;K<G.indexView.count;++K)z[K]=B[K];f+=G.indexView.length,P=2===H.indexView.stride?new Uint16Array(e._data.buffer,d,H.indexView.count):1===H.indexView.stride?new Uint8Array(e._data.buffer,d,H.indexView.count):new Uint32Array(e._data.buffer,d,H.indexView.count);for(var Z=0;Z<H.indexView.count;++Z)z[G.indexView.count+Z]=N+P[Z];d+=H.indexView.length,U[V].indexView={offset:c.getLength(),length:Q.byteLength,count:D,stride:F},c.setNextAlignment(F),c.addBuffer(Q)}if(G.geometricInfo&&H.geometricInfo){var J=G.geometricInfo.view.length+H.geometricInfo.view.length,$=new ArrayBuffer(J),ee=new Uint8Array($),te=new Uint8Array(this._data.buffer,G.geometricInfo.view.offset,G.geometricInfo.view.length),ie=new Uint8Array(e._data.buffer,H.geometricInfo.view.offset,H.geometricInfo.view.length);ee.set(te),ee.set(ie,te.length),c.setNextAlignment(4),U[V].geometricInfo={doubleSided:G.geometricInfo.doubleSided,view:{offset:c.getLength(),length:ee.length,count:G.geometricInfo.view.count+H.geometricInfo.view.count,stride:G.geometricInfo.view.stride}},c.addBuffer($)}}var ne={vertexBundles:g,primitives:U,minPosition:this._struct.minPosition,maxPosition:this._struct.maxPosition};return ne.minPosition&&e._struct.minPosition&&Fi.min(ne.minPosition,ne.minPosition,e._struct.minPosition),ne.maxPosition&&e._struct.maxPosition&&Fi.max(ne.maxPosition,ne.maxPosition,e._struct.maxPosition),this.reset({struct:ne,data:new Uint8Array(c.getCombined())}),this.initialize(),!0}},{key:"validateMergingMesh",value:function(e){if(!this._data&&e._data)return!0;if(this._struct.vertexBundles.length!==e._struct.vertexBundles.length)return!1;for(var t=0;t<this._struct.vertexBundles.length;++t){var i=this._struct.vertexBundles[t],n=e._struct.vertexBundles[t];if(i.attributes.length!==n.attributes.length)return!1;for(var r=0;r<i.attributes.length;++r)if(i.attributes[r].format!==n.attributes[r].format)return!1}if(this._struct.primitives.length!==e._struct.primitives.length)return!1;for(var a=0;a<this._struct.primitives.length;++a){var s=this._struct.primitives[a],o=e._struct.primitives[a];if(s.vertexBundelIndices.length!==o.vertexBundelIndices.length)return!1;for(var l=0;l<s.vertexBundelIndices.length;++l)if(s.vertexBundelIndices[l]!==o.vertexBundelIndices[l])return!1;if(s.primitiveMode!==o.primitiveMode)return!1;if(s.indexView){if(void 0===o.indexView)return!1}else if(o.indexView)return!1}return!0}},{key:"readAttribute",value:function(e,t){var d=this,p=null;return this._accessAttribute(e,t,function(e,t){var i=e.attributes[t].format,n=new DataView(d._data.buffer,e.view.offset+Nh(e.attributes,t)),r=Qc[i],a=Uh(i),s=Gh(n,i);if(a&&s){for(var o=e.view.count,l=r.count,c=new a(o*l),u=e.view.stride,h=0;h<o;++h)for(var f=0;f<l;++f)c[l*h+f]=s(u*h+c.BYTES_PER_ELEMENT*f);p=c}}),p}},{key:"copyAttribute",value:function(e,t,v,m,y){var g=this,b=!1;return this._accessAttribute(e,t,function(e,t){var i=e.attributes[t].format,n=new DataView(g._data.buffer,e.view.offset+Nh(e.attributes,t)),r=new DataView(v,y),a=Qc[i],s=Gh(n,i),o=function(i,e){var t=Qc[e],n=t.size/t.count;switch(t.type){case qc.UNORM:switch(n){case 1:return function(e,t){return i.setUint8(e,t)};case 2:return function(e,t){return i.setUint16(e,t,Vh)};case 4:return function(e,t){return i.setUint32(e,t,Vh)}}break;case qc.SNORM:switch(n){case 1:return function(e,t){return i.setInt8(e,t)};case 2:return function(e,t){return i.setInt16(e,t,Vh)};case 4:return function(e,t){return i.setInt32(e,t,Vh)}}break;case qc.INT:switch(n){case 1:return function(e,t){return i.setInt8(e,t)};case 2:return function(e,t){return i.setInt16(e,t,Vh)};case 4:return function(e,t){return i.setInt32(e,t,Vh)}}break;case qc.UINT:switch(n){case 1:return function(e,t){return i.setUint8(e,t)};case 2:return function(e,t){return i.setUint16(e,t,Vh)};case 4:return function(e,t){return i.setUint32(e,t,Vh)}}break;case qc.FLOAT:return function(e,t){return i.setFloat32(e,t,Vh)}}return null}(r,i);if(s&&o){for(var l=e.view.count,c=a.count,u=e.view.stride,h=function(e){var t=Qc[e];return t.size/t.count}(i),f=m,d=h,p=0;p<l;++p)for(var _=0;_<c;++_){o(f*p+d*_,s(u*p+h*_))}b=!0}}),b}},{key:"readIndices",value:function(e){if(!this._data||e>=this._struct.primitives.length)return null;var t=this._struct.primitives[e];if(!t.indexView)return null;for(var i=t.indexView.count,n=i<256?Il.R8UI:i<65536?Il.R16UI:Il.R32UI,r=new(Uh(n))(i),a=Gh(new DataView(this._data.buffer),n),s=0;s<i;++s)r[s]=a(t.indexView.offset+r.BYTES_PER_ELEMENT*s);return r}},{key:"copyIndices",value:function(e,t){if(!this._data||e>=this._struct.primitives.length)return!1;var i=this._struct.primitives[e];if(!i.indexView)return!1;for(var n=i.indexView.count,r=1===i.indexView.stride?Il.R8UI:2===i.indexView.stride?Il.R16UI:Il.R32UI,a=Gh(new DataView(this._data.buffer),r),s=0;s<n;++s)t[s]=a(i.indexView.offset+Qc[r].size*s);return!0}},{key:"createFlatBuffers",value:function(){if(!this._renderingMesh||this._hasFlatBuffers)return!1;cc.director.root.device;for(var e,t=0,i=0;i<this._struct.primitives.length;++i){var n=this._struct.primitives[i],r=this._renderingMesh.subMeshes[i];n.indexView&&(t=n.indexView.count);var a=n.vertexBundelIndices,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}var c=l,u=this._struct.vertexBundles[c],h=n.indexView?n.indexView.count:u.view.count,f=u.view.stride,d=f*h,p=new Uint8Array(this._data.buffer,u.view.offset,u.view.length);if(n.indexView){var _=new Uint8Array(d);e=2===(t<65536?2:4)?new Uint16Array(this._data.buffer,n.indexView.offset,n.indexView.count):new Uint32Array(this._data.buffer,n.indexView.offset,n.indexView.count);for(var v=0;v<t;++v)for(var m=v*f,y=e[v]*f,g=0;g<f;++g)_[m+g]=p[y+g];r.flatBuffers.push({stride:f,count:h,buffer:_.buffer})}else r.flatBuffers.push({stride:f,count:h,buffer:p.buffer})}}return this._hasFlatBuffers=!0}},{key:"destroyFlatBuffers",value:function(){if(this._hasFlatBuffers){if(this._renderingMesh)for(var e=this._renderingMesh.subMeshes,t=0;t<e.length;++t)e[t].flatBuffers.splice(0);this._hasFlatBuffers=!1}}},{key:"_accessAttribute",value:function(e,t,i){if(this._data&&!(e>=this._struct.primitives.length)){var n=this._struct.primitives[e].vertexBundelIndices,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s,l=this._struct.vertexBundles[o],c=l.attributes.findIndex(function(e){return e.name===t});if(!(c<0)){i(l,c);break}}}}},{key:"_createVertexBuffers",value:function(n,r){var a=this;return this._struct.vertexBundles.map(function(e){var t=n.createBuffer({usage:zl.VERTEX|zl.TRANSFER_DST,memUsage:Pl.HOST|Pl.DEVICE,size:e.view.length,stride:e.view.stride}),i=new Uint8Array(r,e.view.offset,e.view.length);return a.loaded?t.update(i):a.once("load",function(){t.update(i)}),t})}},{key:"renderingMesh",get:function(){return this.initialize(),this._renderingMesh}}]),t}()).prototype,"_struct",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{vertexBundles:[],primitives:[]}}}),Bh=m(Lh.prototype,"_dataLength",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ih=Lh))||Ih);function Nh(e,t){for(var i=0,n=0;n<t;++n){var r=e[n];i+=Qc[r.format].size}return i}function Uh(e){var t=Qc[e],i=t.size/t.count;switch(t.type){case qc.UNORM:case qc.UINT:switch(i){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}break;case qc.SNORM:case qc.INT:switch(i){case 1:return Int8Array;case 2:return Int16Array;case 4:return Int32Array}break;case qc.FLOAT:return Float32Array}return null}cc.Mesh=Fh;var Vh=cc.sys.isLittleEndian;function Gh(t,e){var i=Qc[e],n=i.size/i.count;switch(i.type){case qc.UNORM:switch(n){case 1:return function(e){return t.getUint8(e)};case 2:return function(e){return t.getUint16(e,Vh)};case 4:return function(e){return t.getUint32(e,Vh)}}break;case qc.SNORM:switch(n){case 1:return function(e){return t.getInt8(e)};case 2:return function(e){return t.getInt16(e,Vh)};case 4:return function(e){return t.getInt32(e,Vh)}}break;case qc.INT:switch(n){case 1:return function(e){return t.getInt8(e)};case 2:return function(e){return t.getInt16(e,Vh)};case 4:return function(e){return t.getInt32(e,Vh)}}break;case qc.UINT:switch(n){case 1:return function(e){return t.getUint8(e)};case 2:return function(e){return t.getUint16(e,Vh)};case 4:return function(e){return t.getUint32(e,Vh)}}break;case qc.FLOAT:return function(e){return t.getFloat32(e,Vh)}}return null}var Hh={NONE:0,IGNORE_RAYCAST:1<<20,GIZMOS:1<<21,EDITOR:1<<22,UI_3D:1<<23,SCENE_GIZMO:1<<24,UI_2D:1<<25,PROFILER:1<<28,ALWAYS:1<<29,DEFAULT:1<<30,ALL:4294967295},qh=P2("Layers",function(){function i(){y(this,i)}return l(i,null,[{key:"makeMaskInclude",value:function(e){var t=0,i=e,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}t|=a}return t}},{key:"makeMaskExclude",value:function(e){return~i.makeMaskInclude(e)}},{key:"addLayer",value:function(e,t){void 0!==t?19<t||t<0?console.warn("maximum layers reached."):(i.Enum[e]=1<<t,i.Enum[t]=e,i.BitMask[e]=1<<t,i.BitMask[t]=e):console.warn("bitNum can't be undefined")}},{key:"deleteLayer",value:function(e){19<e||e<0?console.warn("do not change buildin layers."):(delete i.Enum[i.Enum[e]],delete i.Enum[e],delete i.BitMask[i.BitMask[e]],delete i.BitMask[e])}}]),i}());qh.Enum=vt(Hh),qh.BitMask=_t(Object.assign({},Hh)),cc.Layers=qh;var jh,Wh,Xh,Yh;(Wh=jh=jh||P2("RenderPassStage",{}))[Wh.DEFAULT=100]="DEFAULT",(Yh=Xh=Xh||{})[Yh.MIN=0]="MIN",Yh[Yh.MAX=255]="MAX",Yh[Yh.DEFAULT=128]="DEFAULT";var Qh,Kh;(Kh=Qh=Qh||{})[Kh.UBO_GLOBAL=23]="UBO_GLOBAL",Kh[Kh.UBO_SHADOW=22]="UBO_SHADOW",Kh[Kh.UBO_LOCAL=21]="UBO_LOCAL",Kh[Kh.UBO_LOCAL_BATCHED=20]="UBO_LOCAL_BATCHED",Kh[Kh.UBO_FORWARD_LIGHTS=19]="UBO_FORWARD_LIGHTS",Kh[Kh.UBO_SKINNING_ANIMATION=18]="UBO_SKINNING_ANIMATION",Kh[Kh.UBO_SKINNING_TEXTURE=17]="UBO_SKINNING_TEXTURE",Kh[Kh.UBO_UI=16]="UBO_UI",Kh[Kh.SAMPLER_JOINTS=25]="SAMPLER_JOINTS",Kh[Kh.SAMPLER_ENVIRONMENT=26]="SAMPLER_ENVIRONMENT",Kh[Kh.CUSTUM_UBO_BINDING_END_POINT=17]="CUSTUM_UBO_BINDING_END_POINT",Kh[Kh.CUSTOM_SAMPLER_BINDING_START_POINT=30]="CUSTOM_SAMPLER_BINDING_START_POINT";function Zh(e){return e>=Qh.CUSTUM_UBO_BINDING_END_POINT&&e<Qh.CUSTOM_SAMPLER_BINDING_START_POINT}function Jh(){y(this,Jh),this.view=new Float32Array(Jh.COUNT)}Jh.SIZE=4*(Jh.COUNT=(Jh.AMBIENT_GROUND_OFFSET=(Jh.AMBIENT_SKY_OFFSET=(Jh.MAIN_LIT_COLOR_OFFSET=(Jh.MAIN_LIT_DIR_OFFSET=(Jh.EXPOSURE_OFFSET=(Jh.CAMERA_POS_OFFSET=(Jh.MAT_VIEW_PROJ_INV_OFFSET=(Jh.MAT_VIEW_PROJ_OFFSET=(Jh.MAT_PROJ_INV_OFFSET=(Jh.MAT_PROJ_OFFSET=(Jh.MAT_VIEW_INV_OFFSET=(Jh.MAT_VIEW_OFFSET=(Jh.NATIVE_SIZE_OFFSET=(Jh.SCREEN_SCALE_OFFSET=(Jh.SCREEN_SIZE_OFFSET=(Jh.TIME_OFFSET=0)+4)+4)+4)+4)+16)+16)+16)+16)+16)+16)+4)+4)+4)+4)+4)+4),Jh.BLOCK={binding:Qh.UBO_GLOBAL,name:"CCGlobal",members:[{name:"cc_time",type:Ol.FLOAT4,count:1},{name:"cc_screenSize",type:Ol.FLOAT4,count:1},{name:"cc_screenScale",type:Ol.FLOAT4,count:1},{name:"cc_nativeSize",type:Ol.FLOAT4,count:1},{name:"cc_matView",type:Ol.MAT4,count:1},{name:"cc_matViewInv",type:Ol.MAT4,count:1},{name:"cc_matProj",type:Ol.MAT4,count:1},{name:"cc_matProjInv",type:Ol.MAT4,count:1},{name:"cc_matViewProj",type:Ol.MAT4,count:1},{name:"cc_matViewProjInv",type:Ol.MAT4,count:1},{name:"cc_cameraPos",type:Ol.FLOAT4,count:1},{name:"cc_exposure",type:Ol.FLOAT4,count:1},{name:"cc_mainLitDir",type:Ol.FLOAT4,count:1},{name:"cc_mainLitColor",type:Ol.FLOAT4,count:1},{name:"cc_ambientSky",type:Ol.FLOAT4,count:1},{name:"cc_ambientGround",type:Ol.FLOAT4,count:1}]};function $h(){y(this,$h),this.view=new Float32Array($h.COUNT)}$h.SIZE=4*($h.COUNT=($h.SHADOW_COLOR_OFFSET=($h.MAT_LIGHT_PLANE_PROJ_OFFSET=0)+16)+4),$h.BLOCK={binding:Qh.UBO_SHADOW,name:"CCShadow",members:[{name:"cc_matLightPlaneProj",type:Ol.MAT4,count:1},{name:"cc_shadowColor",type:Ol.FLOAT4,count:1}]};function ef(){y(this,ef),this.view=new Float32Array(ef.COUNT)}var tf={binding:Qh.SAMPLER_ENVIRONMENT,name:"cc_environment",type:Ol.SAMPLER_CUBE,count:1},nf=new Map;ef.BATCHING_COUNT=10,ef.SIZE=4*(ef.COUNT=(ef.MAT_WORLDS_OFFSET=(ef.MAT_WORLD_IT_OFFSET=(ef.MAT_WORLD_OFFSET=0)+16)+16)+16*ef.BATCHING_COUNT),ef.BLOCK={binding:Qh.UBO_LOCAL,name:"CCLocal",members:[{name:"cc_matWorld",type:Ol.MAT4,count:1},{name:"cc_matWorldIT",type:Ol.MAT4,count:1},{name:"cc_matWorlds",type:Ol.MAT4,count:ef.BATCHING_COUNT}]},nf.set(ef.BLOCK.name,{type:wc.UNIFORM_BUFFER,blockInfo:ef.BLOCK});function rf(){y(this,rf),this.view=new Float32Array(rf.COUNT)}rf.MAX_SPHERE_LIGHTS=2,rf.MAX_SPOT_LIGHTS=2,rf.SIZE=4*(rf.COUNT=(rf.SPOT_LIGHT_COLOR_OFFSET=(rf.SPOT_LIGHT_DIR_OFFSET=(rf.SPOT_LIGHT_SIZE_RANGE_ANGLE_OFFSET=(rf.SPOT_LIGHT_POS_OFFSET=(rf.SPHERE_LIGHT_COLOR_OFFSET=(rf.SPHERE_LIGHT_SIZE_RANGE_OFFSET=(rf.SPHERE_LIGHT_POS_OFFSET=0)+4*rf.MAX_SPHERE_LIGHTS)+4*rf.MAX_SPHERE_LIGHTS)+4*rf.MAX_SPOT_LIGHTS)+4*rf.MAX_SPOT_LIGHTS)+4*rf.MAX_SPOT_LIGHTS)+4*rf.MAX_SPOT_LIGHTS)+4*rf.MAX_SPOT_LIGHTS),rf.BLOCK={binding:Qh.UBO_FORWARD_LIGHTS,name:"CCForwardLight",members:[{name:"cc_sphereLitPos",type:Ol.FLOAT4,count:rf.MAX_SPHERE_LIGHTS},{name:"cc_sphereLitSizeRange",type:Ol.FLOAT4,count:rf.MAX_SPHERE_LIGHTS},{name:"cc_sphereLitColor",type:Ol.FLOAT4,count:rf.MAX_SPHERE_LIGHTS},{name:"cc_spotLitPos",type:Ol.FLOAT4,count:rf.MAX_SPOT_LIGHTS},{name:"cc_spotLitSizeRangeAngle",type:Ol.FLOAT4,count:rf.MAX_SPOT_LIGHTS},{name:"cc_spotLitDir",type:Ol.FLOAT4,count:rf.MAX_SPOT_LIGHTS},{name:"cc_spotLitColor",type:Ol.FLOAT4,count:rf.MAX_SPOT_LIGHTS}]},nf.set(rf.BLOCK.name,{type:wc.UNIFORM_BUFFER,blockInfo:rf.BLOCK});function af(){y(this,af)}af.SIZE=4*(af.COUNT=(af.JOINTS_TEXTURE_INFO_OFFSET=0)+4),af.BLOCK={binding:Qh.UBO_SKINNING_TEXTURE,name:"CCSkinningTexture",members:[{name:"cc_jointsTextureInfo",type:Ol.FLOAT4,count:1}]},nf.set(af.BLOCK.name,{type:wc.UNIFORM_BUFFER,blockInfo:af.BLOCK});function sf(){y(this,sf)}sf.SIZE=4*(sf.COUNT=(sf.JOINTS_ANIM_INFO_OFFSET=0)+4),sf.BLOCK={binding:Qh.UBO_SKINNING_ANIMATION,name:"CCSkinningAnimation",members:[{name:"cc_jointsAnimInfo",type:Ol.FLOAT4,count:1}]},nf.set(sf.BLOCK.name,{type:wc.UNIFORM_BUFFER,blockInfo:sf.BLOCK});var of={binding:Qh.SAMPLER_JOINTS,name:"cc_jointsTexture",type:Ol.SAMPLER2D,count:1};nf.set(of.name,{type:wc.SAMPLER,samplerInfo:of});var lf=qh.makeMaskExclude([qh.BitMask.UI_2D,qh.BitMask.GIZMOS,qh.BitMask.EDITOR,qh.BitMask.SCENE_GIZMO,qh.BitMask.PROFILER]),cf=qh.makeMaskExclude([qh.BitMask.UI_2D,qh.BitMask.PROFILER]),uf=(qh.Enum.ALL,function(){function t(e){y(this,t),this._onAttach=void 0,this._onDetach=void 0,this._models={},this._onAttach=e.onAttach,this._onDetach=e.onDetach}return l(t,[{key:"attach",value:function(e){var t=this._models,i=e.id;t[i]?t[i]++:(this._onAttach&&this._onAttach(e),t[i]=1)}},{key:"detach",value:function(e){var t=this._models,i=e.id;!t[i]||0<--t[i]||this._onDetach&&this._onDetach(e)}}]),t}()),hf=new(function(){function e(){y(this,e),this._customs={}}return l(e,[{key:"register",value:function(e,t){this._customs[e]=new uf(t)}},{key:"attach",value:function(e,t){var i=this._customs[e];i?i.attach(t):console.warn("no customization named '".concat(e,"'"))}},{key:"detach",value:function(e,t){var i=this._customs[e];i?i.detach(t):console.warn("no customization named '".concat(e,"'"))}}]),e}());cc.customizationManager=hf;var ff=function(){function e(){y(this,e),this._subMeshObject=void 0,this._inputAssembler=void 0,this._material=void 0,this._cmdBuffers=void 0,this._psos=void 0,this._priority=void 0,this._subMeshObject=null,this._material=null,this._cmdBuffers=new Array,this._psos=null,this._inputAssembler=null,this._priority=Xh.DEFAULT}return l(e,[{key:"initialize",value:function(e,t,i){this._psos=i,this.subMeshData=e,this.material=t}},{key:"destroy",value:function(){this._inputAssembler&&this._inputAssembler.destroy();for(var e=0;e<this.passes.length;e++)this.passes[e].destroyPipelineState(this._psos[e]);var t=this._cmdBuffers,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.destroy()}this._cmdBuffers.splice(0),this._material=null}},{key:"updateCommandBuffer",value:function(){if(this._material){for(var e=0;e<this._material.passes.length;e++)this._subMeshObject&&this._material.passes[e].primitive!==this._subMeshObject.primitiveMode&&console.warn("mesh primitive type doesn't match with pass settings"),this.recordCommandBuffer(e);for(var t=this._cmdBuffers.length-1;t>=this._material.passes.length;t--){var i=this._cmdBuffers.pop();i&&i.destroy()}}}},{key:"recordCommandBuffer",value:function(e){var t=cc.director.root.device,i=this._psos[e];if(null==this._cmdBuffers[e]){var n={allocator:t.commandAllocator,type:Ec.SECONDARY};this._cmdBuffers[e]=t.createCommandBuffer(n)}else this._cmdBuffers[e].status===Sl.UNREADY&&this._cmdBuffers[e].initialize({allocator:t.commandAllocator,type:Ec.SECONDARY});var r=this._inputAssembler,a=this._cmdBuffers[e];a.begin(),a.bindPipelineState(i),a.bindBindingLayout(i.pipelineLayout.layouts[0]),a.bindInputAssembler(r),a.draw(r),a.end()}},{key:"priority",set:function(e){this._priority=e},get:function(){return this._priority}},{key:"subMeshData",set:function(e){this._inputAssembler&&this._inputAssembler.destroy(),this._subMeshObject=e;var t={};t.attributes=this._subMeshObject.attributes,t.vertexBuffers=this._subMeshObject.vertexBuffers,this._subMeshObject.indexBuffer&&(t.indexBuffer=this._subMeshObject.indexBuffer),this._subMeshObject.indirectBuffer&&(t.indirectBuffer=this._subMeshObject.indirectBuffer),this._inputAssembler?this._inputAssembler.initialize(t):this._inputAssembler=cc.director.root.device.createInputAssembler(t)},get:function(){return this._subMeshObject}},{key:"psos",get:function(){return this._psos},set:function(e){this._psos=e}},{key:"material",set:function(e){null!=(this._material=e)&&this.updateCommandBuffer()},get:function(){return this._material}},{key:"inputAssembler",get:function(){return this._inputAssembler}},{key:"passes",get:function(){return this._material.passes}},{key:"commandBuffers",get:function(){return this._cmdBuffers}}]),e}(),df=new zn,pf=new ks(function(){return new ff},32);function _f(e){var t=0,i=e.members,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;t+=$c(s.type)*s.count}return t}var vf=function(){function i(e,t){y(this,i),this._type="default",this._device=void 0,this._scene=void 0,this._node=void 0,this._transform=void 0,this._id=void 0,this._enabled=!1,this._visFlags=qh.Enum.NONE,this._cameraID=-1,this._userKey=-1,this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._matPSORecord=void 0,this._matRefCount=void 0,this._uboLocal=void 0,this._localUBO=null,this._localBindings=new Map,this._inited=!1,this._uboUpdated=!1,this._castShadow=!1,this._isDynamicBatching=!1,this._transformUpdated=!0,this._device=cc.director.root.device,this._scene=e,this._id=this._scene.generateModelId(),this._transform=this._node=t,this._matPSORecord=new Map,this._matRefCount=new Map,this._uboLocal=new ef}return l(i,[{key:"scene",set:function(e){this._scene=e,this._id=this._scene.generateModelId()},get:function(){return this._scene}},{key:"id",get:function(){return this._id}},{key:"subModels",get:function(){return this._subModels}},{key:"subModelNum",get:function(){return this._subModels.length}},{key:"inited",get:function(){return this._inited}},{key:"enabled",set:function(e){this._enabled=e},get:function(){return this._enabled}},{key:"node",get:function(){return this._node},set:function(e){this._node=e}},{key:"transform",get:function(){return this._transform},set:function(e){this._transform=e}},{key:"worldBounds",get:function(){return this._worldBounds}},{key:"modelBounds",get:function(){return this._modelBounds}},{key:"visFlags",get:function(){return this._visFlags},set:function(e){this._visFlags=e}},{key:"userKey",set:function(e){this._userKey=e}},{key:"uboLocal",get:function(){return this._uboLocal}},{key:"localUBO",get:function(){return this._localUBO}},{key:"localBindings",get:function(){return this._localBindings}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}},{key:"isDynamicBatching",get:function(){return this._isDynamicBatching},set:function(e){this._isDynamicBatching=e}},{key:"UBOUpdated",get:function(){return this._uboUpdated}}]),l(i,[{key:"destroy",value:function(){var e=this._subModels,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;r.destroy(),pf.free(r)}for(var a=this._localBindings.values(),s=a.next();!s.done;){var o=s.value;o.buffer&&(o.buffer.destroy(),o.buffer=void 0),s=a.next()}this._localBindings.has(rf.BLOCK.name)&&this._localBindings.delete(rf.BLOCK.name),this._worldBounds=null,this._modelBounds=null,this._subModels.splice(0),this._matPSORecord.clear(),this._matRefCount.clear(),this._inited=!1}},{key:"getSubModel",value:function(e){return this._subModels[e]}},{key:"updateTransform",value:function(){var e=this._transform;(e.hasChangedFlags||e._dirtyFlags)&&(e.updateWorldTransform(),this._transformUpdated=!0,this._modelBounds&&this._worldBounds&&this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,this._worldBounds))}},{key:"_resetUBOUpdateFlag",value:function(){this._uboUpdated=!1}},{key:"updateUBOs",value:function(){if(this._uboUpdated)return!1;if(this._uboUpdated=!0,this._transformUpdated&&!this._isDynamicBatching){var e=this._transform._mat;zn.toArray(this._uboLocal.view,e,ef.MAT_WORLD_OFFSET),zn.inverseTranspose(df,e),zn.toArray(this._uboLocal.view,df,ef.MAT_WORLD_IT_OFFSET);var t=this._localBindings.get(ef.BLOCK.name);t&&t.buffer&&t.buffer.update(this._uboLocal.view),this._transformUpdated=!1}return this._matPSORecord.forEach(this._updatePass,this),!0}},{key:"createBoundingShape",value:function(e,t){e&&t&&(this._modelBounds=cs.fromPoints(cs.create(),e,t),this._worldBounds=cs.clone(this._modelBounds),this._transform.updateWorldTransform(),this._modelBounds.transform(this._transform._mat,this._transform._pos,this._transform._rot,this._transform._scale,this._worldBounds))}},{key:"initSubModel",value:function(e,t,i){if(this.initLocalBindings(i),null==this._subModels[e])this._subModels[e]=pf.alloc();else{var n=this._subModels[e].material;this._subModels[e].destroy(),this.releasePSO(n)}this.allocatePSO(i),this._subModels[e].initialize(t,i,this._matPSORecord.get(i)),this._inited=!0}},{key:"setSubModelMesh",value:function(e,t){null==this._subModels[e]&&(this._subModels[e]=pf.alloc()),this._subModels[e].subMeshData=t}},{key:"setSubModelMaterial",value:function(e,t){null!=this._subModels[e]&&(this.initLocalBindings(t),this._subModels[e].material===t?t&&(this.destroyPipelineState(t,this._matPSORecord.get(t)),this._matPSORecord.set(t,this.createPipelineState(t))):(this._subModels[e].material&&this.releasePSO(this._subModels[e].material),t&&this.allocatePSO(t)),this._subModels[e].psos=t&&this._matPSORecord.get(t)||null,this._subModels[e].material=t)}},{key:"onPipelineChange",value:function(){var e=this._subModels,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}for(var r=n,a=r.material,s=this._matPSORecord.get(a),o=0;o<a.passes.length;o++){var l=a.passes[o];l.tryCompile(),l.destroyPipelineState(s[o]),s[o]=this._doCreatePSO(l),s[o].pipelineLayout.layouts[0].update()}r.updateCommandBuffer()}}},{key:"createPipelineState",value:function(e){for(var t=new Array(e.passes.length),i=0;i<t.length;i++){var n=e.passes[i],r=n.customizations,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}var l=o;hf.attach(l,this)}t[i]=this._doCreatePSO(n)}return t}},{key:"destroyPipelineState",value:function(e,t){for(var i=0;i<e.passes.length;i++){var n=e.passes[i];n.destroyPipelineState(t[i]);var r=n.customizations,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}var l=o;hf.detach(l,this)}}}},{key:"_doCreatePSO",value:function(e){var t=e.createPipelineState();return t.pipelineLayout.layouts[0].bindBuffer(ef.BLOCK.binding,this._localBindings.get(ef.BLOCK.name).buffer),this._localBindings.has(rf.BLOCK.name)&&t.pipelineLayout.layouts[0].bindBuffer(rf.BLOCK.binding,this._localBindings.get(rf.BLOCK.name).buffer),t}},{key:"onSetLocalBindings",value:function(e){this._localBindings.has(ef.BLOCK.name)||this._localBindings.set(ef.BLOCK.name,{type:wc.UNIFORM_BUFFER,blockInfo:ef.BLOCK});var t=!1,i=e.passes,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}if(a.bindings.find(function(e){return e.name===rf.BLOCK.name})){t=!0;break}}t&&"ForwardPipeline"===cc.director.root.pipeline.name&&(this._localBindings.has(rf.BLOCK.name)||this._localBindings.set(rf.BLOCK.name,{type:wc.UNIFORM_BUFFER,blockInfo:rf.BLOCK}))}},{key:"initLocalBindings",value:function(e){if(e){this.onSetLocalBindings(e);for(var t=this._localBindings.values(),i=t.next();!i.done;){var n=i.value;n.buffer||(n.buffer=this._device.createBuffer({usage:zl.UNIFORM|zl.TRANSFER_DST,memUsage:Pl.HOST|Pl.DEVICE,size:_f(n.blockInfo)})),i=t.next()}}}},{key:"_updatePass",value:function(e,t){for(var i=0;i<t.passes.length;i++)t.passes[i].update();for(var n=0;n<e.length;n++)e[n].pipelineLayout.layouts[0].update()}},{key:"allocatePSO",value:function(e){null==this._matRefCount.get(e)?(this._matRefCount.set(e,1),this._matPSORecord.set(e,this.createPipelineState(e))):this._matRefCount.set(e,this._matRefCount.get(e)+1)}},{key:"releasePSO",value:function(e){this._matRefCount.set(e,this._matRefCount.get(e)-1),0===this._matRefCount.get(e)&&(this.destroyPipelineState(e,this._matPSORecord.get(e)),this._matPSORecord.delete(e),this._matRefCount.delete(e))}}]),i}(),mf=function(){function a(){y(this,a)}return l(a,null,[{key:"create",value:function(e){var t=a.pool.get(e);if(t)return t;var i=cc.director.root.device.createBuffer({usage:zl.UNIFORM|zl.TRANSFER_DST,memUsage:Pl.HOST|Pl.DEVICE,size:sf.SIZE,stride:sf.SIZE}),n=new Float32Array([1,0,0,0]);i.update(n);var r={buffer:i,data:n};return a.pool.set(e,r),r}},{key:"destroy",value:function(e){var t=a.pool.get(e);t&&(t.buffer.destroy(),a.pool.delete(e))}},{key:"switchClip",value:function(e,t){var i=a.pool.get(e);i&&(i.data[0]=t?t.keys[0].length:1,i.data[1]=0,i.buffer.update(i.data))}},{key:"get",value:function(e){return a.pool.get(e)||a.create(-1)}}]),a}();mf.pool=new Map;var yf,gf,bf,xf=Du([sc.POINT,sc.POINT,sc.NONE,lc.CLAMP,lc.CLAMP,lc.CLAMP]),Sf=function(){function o(e,t){var i;y(this,o),(i=x(this,g(o).call(this,e,t))).uploadedAnim=null,i._jointsMedium=void 0,i._skeleton=null,i._type="skinning";var n=new Float32Array(4),r=i._scene.texturePool.getDefaultJointsTexture();return i._jointsMedium={buffer:null,jointsTextureInfo:n,texture:r},i}return p(o,vf),l(o,[{key:"worldBounds",get:function(){return this.uploadedAnim?null:this._worldBounds}}]),l(o,[{key:"destroy",value:function(){_(g(o.prototype),"destroy",this).call(this),this._jointsMedium.buffer&&(this._jointsMedium.buffer.destroy(),this._jointsMedium.buffer=null)}},{key:"bindSkeleton",value:function(e,t){(this._skeleton=e)&&t&&(this._transform=t,this._jointsMedium.buffer||(this._jointsMedium.buffer=this._device.createBuffer({usage:zl.UNIFORM|zl.TRANSFER_DST,memUsage:Pl.HOST|Pl.DEVICE,size:af.SIZE,stride:af.SIZE})),this.uploadAnimation(this.uploadedAnim))}},{key:"uploadAnimation",value:function(e){if(this._skeleton){this.uploadedAnim=e;var t=this.uploadedAnim?this._scene.texturePool.getJointsTextureWithAnimation(this._skeleton,this.uploadedAnim):this._scene.texturePool.getDefaultJointsTexture(this._skeleton);mf.switchClip(this._transform.uuid,e),this._applyJointsTexture(t)}}},{key:"_applyJointsTexture",value:function(e){if(e){this._jointsMedium.texture=e;var t=this._jointsMedium,i=t.buffer,n=t.jointsTextureInfo;n[0]=e.handle.texture.width,n[1]=1/n[0],n[2]=e.pixelOffset+.1,i&&i.update(n);var r=nh.getSampler(this._device,xf),a=this._subModels,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}var c=l;if(c.psos){var u=c.psos,h=Array.isArray(u),f=0;for(u=h?u:u[Symbol.iterator]();;){var d;if(h){if(f>=u.length)break;d=u[f++]}else{if((f=u.next()).done)break;d=f.value}var p=d;p.pipelineLayout.layouts[0].bindTextureView(of.binding,e.handle.texView),p.pipelineLayout.layouts[0].bindSampler(of.binding,r)}}}}}},{key:"_doCreatePSO",value:function(e){var t=_(g(o.prototype),"_doCreatePSO",this).call(this,e),i=this._jointsMedium,n=i.buffer,r=i.texture,a=mf.get(this._transform.uuid);t.pipelineLayout.layouts[0].bindBuffer(af.BLOCK.binding,n),t.pipelineLayout.layouts[0].bindBuffer(sf.BLOCK.binding,a.buffer);var s=nh.getSampler(this._device,xf);return r&&(t.pipelineLayout.layouts[0].bindTextureView(of.binding,r.handle.texView),t.pipelineLayout.layouts[0].bindSampler(of.binding,s)),t}}]),o}();(bf=gf=gf||{})[bf.positions=kl.ATTR_POSITION]="positions",bf[bf.normals=kl.ATTR_NORMAL]="normals",bf[bf.uvs=kl.ATTR_TEX_COORD]="uvs",bf[bf.colors=kl.ATTR_COLOR]="colors";var wf=[{name:kl.ATTR_POSITION,format:Il.RGB32F},{name:kl.ATTR_NORMAL,format:Il.RGB32F},{name:kl.ATTR_TEX_COORD,format:Il.RG32F},{name:kl.ATTR_COLOR,format:Il.RGBA32F}],Tf=new Fi;function Ef(e,t,i){i=i||{};var n,r=[],a=0,s=[],o=0;if(0<e.positions.length){if(n=null,e.attributes){var l=e.attributes,c=Array.isArray(l),u=0;for(l=c?l:l[Symbol.iterator]();;){var h;if(c){if(u>=l.length)break;h=l[u++]}else{if((u=l.next()).done)break;h=u.value}var f=h;if(f.name===kl.ATTR_POSITION){n=f;break}}}n=n||wf[0];var d=Qc[n.format];r.push(n),o=Math.max(o,Math.floor(e.positions.length/d.count)),s.push({offset:a,data:e.positions,attribute:n}),a+=d.size}if(e.normals&&0<e.normals.length){if(n=null,e.attributes){var p=e.attributes,_=Array.isArray(p),v=0;for(p=_?p:p[Symbol.iterator]();;){var m;if(_){if(v>=p.length)break;m=p[v++]}else{if((v=p.next()).done)break;m=v.value}var y=m;if(y.name===kl.ATTR_NORMAL){n=y;break}}}n=n||wf[1];var g=Qc[n.format];r.push(n),o=Math.max(o,Math.floor(e.normals.length/g.count)),s.push({offset:a,data:e.normals,attribute:n}),a+=g.size}if(e.uvs&&0<e.uvs.length){if(n=null,e.attributes){var b=e.attributes,x=Array.isArray(b),S=0;for(b=x?b:b[Symbol.iterator]();;){var w;if(x){if(S>=b.length)break;w=b[S++]}else{if((S=b.next()).done)break;w=S.value}var T=w;if(T.name===kl.ATTR_TEX_COORD){n=T;break}}}n=n||wf[2];var E=Qc[n.format];r.push(n),o=Math.max(o,Math.floor(e.uvs.length/E.count)),s.push({offset:a,data:e.uvs,attribute:n}),a+=E.size}if(e.colors&&0<e.colors.length){if(n=null,e.attributes){var C=e.attributes,A=Array.isArray(C),k=0;for(C=A?C:C[Symbol.iterator]();;){var R;if(A){if(k>=C.length)break;R=C[k++]}else{if((k=C.next()).done)break;R=k.value}var O=R;if(O.name===kl.ATTR_COLOR){n=O;break}}}n=n||wf[3];var M=Qc[n.format];r.push(n),o=Math.max(o,Math.floor(e.colors.length/M.count)),s.push({offset:a,data:e.colors,attribute:n}),a+=M.size}if(e.customAttributes){var I=e.customAttributes,L=Array.isArray(I),z=0;for(I=L?I:I[Symbol.iterator]();;){var B;if(L){if(z>=I.length)break;B=I[z++]}else{if((z=I.next()).done)break;B=z.value}var P=B,D=Qc[P.attr.format];r.push(P.attr),o=Math.max(o,Math.floor(P.values.length/D.count)),s.push({offset:a,data:P.values,attribute:P.attr}),a+=D.size}}for(var F=new Ph,N=new ArrayBuffer(o*a),U=new DataView(N),V=0,G=s;V<G.length;V++){var H=G[V];Rf(U,H.data,H.attribute.format,H.offset,a)}F.setNextAlignment(0);var q={attributes:r,view:{offset:F.getLength(),length:N.byteLength,count:o,stride:a}};F.addBuffer(N);var j=null,W=0;if(e.indices){var X=e.indices;W=X.length,j=new ArrayBuffer(2*W),Rf(new DataView(j),X,Il.R16UI)}var Y={primitiveMode:e.primitiveMode||Gl.TRIANGLE_LIST,vertexBundelIndices:[0]};if(Y.primitiveMode>=Gl.TRIANGLE_LIST){var Q=Float32Array.from(e.positions);F.setNextAlignment(4),Y.geometricInfo={doubleSided:e.doubleSided,view:{offset:F.getLength(),length:Q.byteLength,count:e.positions.length/4,stride:4}},F.addBuffer(Q.buffer)}j&&(F.setNextAlignment(2),Y.indexView={offset:F.getLength(),length:j.byteLength,count:W,stride:2},F.addBuffer(j));var K=e.minPos;if(!K&&i.calculateBounds){K=Fi.set(new Fi,1/0,1/0,1/0);for(var Z=0;Z<o;++Z)Fi.set(Tf,e.positions[3*Z+0],e.positions[3*Z+1],e.positions[3*Z+2]),Fi.min(K,K,Tf)}var J=e.maxPos;if(!J&&i.calculateBounds){J=Fi.set(new Fi,-1/0,-1/0,-1/0);for(var $=0;$<o;++$)Fi.set(Tf,e.positions[3*$+0],e.positions[3*$+1],e.positions[3*$+2]),Fi.max(J,J,Tf)}var ee={vertexBundles:[q],primitives:[Y]};return K&&(ee.minPosition=new Fi(K.x,K.y,K.z)),J&&(ee.maxPosition=new Fi(J.x,J.y,J.z)),(t=t||new Fh).reset({struct:ee,data:new Uint8Array(F.getCombined())}),t}var Cf=cc.sys.isLittleEndian,Af=(s(yf={},qc.UNORM,"Uint"),s(yf,qc.SNORM,"Int"),s(yf,qc.UINT,"Uint"),s(yf,qc.INT,"Int"),s(yf,qc.UFLOAT,"Float"),s(yf,qc.FLOAT,"Float"),s(yf,"default","Uint"),yf);function kf(e){return(Af[e.type]||Af.default)+e.size/e.count*8}function Rf(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:Il.R32F,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,a=Qc[i];r=r||a.size;for(var s="set"+kf(a),o=a.size/a.count,l=Math.floor(t.length/a.count),c=0;c<l;++c)for(var u=n+r*c,h=0;h<a.count;++h){var f=u+o*h;e[s](f,t[a.count*c+h],Cf)}}function Of(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:Il.R32F,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:e.byteLength-i,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:[],s=Qc[t];r=r||s.size;for(var o="get"+kf(s),l=s.size/s.count,c=Math.floor(n/r),u=0;u<c;++u)for(var h=i+r*u,f=0;f<s.count;++f){var d=h+l*f;a[s.count*u+f]=e[o](d,Cf)}return a}function Mf(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:Il.R32F,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:e.byteLength-n,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:0,s=6<arguments.length?arguments[6]:void 0;s=s||new DataView(new ArrayBuffer(e.byteLength));var o=Qc[i];a=a||o.size;for(var l="set"+kf(o),c="get"+kf(o),u=o.size/o.count,h=Math.floor(r/a),f=0;f<h;++f)for(var d=n+a*f,p=0;p<o.count;++p){var _=d+u*p,v=e[c](_,Cf);s[l](_,t(v,p,e),Cf)}return s}var If=[],Lf=new Fi;var zf=new(function(){function e(){y(this,e),this._cached=new Map}return l(e,[{key:"use",value:function(e,t){var i=this._cached.get(e);i||(i=new Map,this._cached.set(e,i));var n=i.get(t);return n||(n={bounds:function(e,t){for(var i=new Array(t.joints.length),n=0;n<i.length;++n)i[n]={hasValue:!1,min:new Fi(1/0,1/0,1/0),max:new Fi(-1/0,-1/0,-1/0)};for(var r=0;r<e.struct.primitives.length;++r){var a=e.readAttribute(r,kl.ATTR_JOINTS);if(a){var s=e.readAttribute(r,kl.ATTR_WEIGHTS);if(s){var o=e.readAttribute(r,kl.ATTR_POSITION);if(o)for(var l=Math.min(a.length/4,s.length/4,o.length/3),c=0;c<l;++c){Fi.set(Tf,o[3*c+0],o[3*c+1],o[3*c+2]);for(var u=0;u<4;++u){if(0!==s[4*c+u]){var h=a[4*c+u];if(!(h>=t.joints.length)){t.bindposes?Fi.transformMat4(Lf,Tf,t.bindposes[h]):Fi.copy(Lf,Tf);var f=i[h];f.hasValue=!0,Fi.min(f.min,f.min,Lf),Fi.max(f.max,f.max,Lf)}}}}}}}return i.map(function(e){return e.hasValue?cs.fromPoints(new cs,e.min,e.max):null})}(e,t),referenceCount:0},i.set(t,n)),++n.referenceCount,n.bounds}},{key:"unuse",value:function(e,t){var i=this._cached.get(e);if(i){var n=i.get(t);n&&(--n.referenceCount,0===n.referenceCount&&i.delete(t)),0===i.size&&this._cached.delete(e)}}}]),e}()),Bf=new zn,Pf=new zn,Df=new cs,Ff=new Fi,Nf=new Fi;var Uf=Object.freeze({toPPM:function(e,t,i){return"P3 ".concat(t," ").concat(i," 255\n").concat(e.filter(function(e,t){return t%4<3}).toString(),"\n")},createMesh:Ef,readMesh:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i={positions:[]},n=new DataView(e._nativeAsset),r=e.struct,a=r.primitives[t],s=a.vertexBundelIndices,o=Array.isArray(s),l=0;for(s=o?s:s[Symbol.iterator]();;){var c;if(o){if(l>=s.length)break;c=s[l++]}else{if((l=s.next()).done)break;c=l.value}var u=c,h=r.vertexBundles[u],f=h.view.offset,d=h.view,p=d.length,_=d.stride,v=h.attributes,m=Array.isArray(v),y=0;for(v=m?v:v[Symbol.iterator]();;){var g;if(m){if(y>=v.length)break;g=v[y++]}else{if((y=v.next()).done)break;g=y.value}var b=g,x=gf[b.name];x&&(i[x]=(i[x]||[]).concat(Of(n,b.format,f,p,_))),f+=Qc[b.format].size}}var S=a.indexView;return i.indices=Of(n,Il["R".concat(8*S.stride,"UI")],S.offset,S.length),i},writeBuffer:Rf,readBuffer:Of,mapBuffer:Mf,LCA:function(e,t){if(e===t)return e;var i=t;for(If.length=0;i;)If.push(i),i=i.parent;for(i=e;i;){if(If.find(function(e){return e===i}))return i;i=i.parent}return null},calculateSkinnedBounds:function(e,t){if(t.model&&t.mesh){var i=t.skeleton,n=t.skinningRoot,r=t.model.uploadedAnim,a=n&&mf.get(n.uuid);if(!(i&&n&&r&&a)){if(!t.model.worldBounds)return;return cs.copy(e,t.model.worldBounds),!0}Fi.set(Ff,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),Fi.set(Nf,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY),n.getWorldMatrix(Bf);for(var s=zf.use(t.mesh,i),o=i.joints.length,l=r.convertedData,c=a.data[1],u=0;u<o;++u){var h=s[u],f=l[i.joints[u]];if(h&&f&&f.props){var d=f.props.worldMatrix.values[c];zn.multiply(Pf,Bf,d),cs.transform(Df,h,Pf),Df.getBoundary(Tf,Lf),Fi.min(Ff,Ff,Tf),Fi.max(Nf,Nf,Lf)}}return cs.fromPoints(e,Ff,Nf),!0}},find:Mh});P2("utils",Uf);function Vf(){y(this,Vf),this.isA2C=!1,this.isIndepend=!1,this.blendColor=[0,0,0,0],this.targets=[new Xf]}function Gf(){y(this,Gf),this.attributes=[]}var Hf=P2("GFXInputAssembler",function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,bl.INPUT_ASSEMBLER)))._device=void 0,t._attributes=[],t._vertexBuffers=[],t._indexBuffer=null,t._vertexCount=0,t._firstVertex=0,t._indexCount=0,t._firstIndex=0,t._vertexOffset=0,t._instanceCount=0,t._firstInstance=0,t._isIndirect=!1,t._indirectBuffer=null,t._device=e,t}return p(i,Hc),l(i,[{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"attributes",get:function(){return this._attributes}},{key:"vertexCount",get:function(){return this._vertexCount},set:function(e){this._vertexCount=e}},{key:"firstVertex",get:function(){return this._firstVertex},set:function(e){this._firstVertex=e}},{key:"indexCount",get:function(){return this._indexCount},set:function(e){this._indexCount=e}},{key:"firstIndex",get:function(){return this._firstIndex},set:function(e){this._firstIndex=e}},{key:"vertexOffset",get:function(){return this._vertexOffset},set:function(e){this._vertexOffset=e}},{key:"instanceCount",get:function(){return this._instanceCount},set:function(e){this._instanceCount=e}},{key:"firstInstance",get:function(){return this._firstInstance},set:function(e){this._firstInstance=e}},{key:"isIndirect",get:function(){return this._isIndirect}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}}]),l(i,[{key:"getVertexBuffer",value:function(e){var t=0<arguments.length&&void 0!==e?e:0;return t<this._vertexBuffers.length?this._vertexBuffers[t]:null}},{key:"extractDrawInfo",value:function(e){e.vertexCount=this._vertexCount,e.firstVertex=this._firstVertex,e.indexCount=this._indexCount,e.firstIndex=this._firstIndex,e.vertexOffset=this._vertexOffset,e.instanceCount=this._instanceCount,e.firstInstance=this._firstInstance}},{key:"updateVertexAttr",value:function(e,t,i,n,r){var a=3<arguments.length&&void 0!==n?n:0,s=!(4<arguments.length&&void 0!==r)||r,o=0,l=Il.UNKNOWN,c=this._attributes,u=Array.isArray(c),h=0;for(c=u?c:c[Symbol.iterator]();;){var f;if(u){if(h>=c.length)break;f=c[h++]}else{if((h=c.next()).done)break;f=h.value}var d=f;if(d.name===t){l=d.format;break}o+=Qc[d.format].size}var p=this._vertexBuffers[a];l&&p&&(Rf(new DataView(e),i,l,o,p.stride),s&&p.update(e,0,p.stride*p.count))}},{key:"updateIndexBuffer",value:function(e,t){var i=this._indexCount,n=this._indexBuffer;i&&n&&(Rf(new DataView(e),t,Il["R".concat(8*n.stride,"UI")]),n.update(e,0,n.stride*n.count),this._indexCount=t.length)}}]),i}()),qf=P2("GFXPipelineLayout",function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,bl.PIPELINE_LAYOUT)))._device=void 0,t._pushConstantsRanges=[],t._layouts=[],t._device=e,t}return p(i,Hc),l(i,[{key:"layouts",get:function(){return this._layouts}}]),i}()),jf=function(){function e(){y(this,e),this.isDiscard=!1,this.polygonMode=ql.FILL,this.shadeModel=Wl.GOURAND,this.cullMode=Yl.BACK,this.isFrontFaceCCW=!0,this.depthBias=0,this.depthBiasClamp=0,this.depthBiasSlop=0,this.isDepthClip=!0,this.isMultisample=!1,this.lineWidth=1}return l(e,[{key:"compare",value:function(e){return this.isDiscard===e.isDiscard&&this.polygonMode===e.polygonMode&&this.shadeModel===e.shadeModel&&this.cullMode===e.cullMode&&this.isFrontFaceCCW===e.isFrontFaceCCW&&this.depthBias===e.depthBias&&this.depthBiasClamp===e.depthBiasClamp&&this.depthBiasSlop===e.depthBiasSlop&&this.isDepthClip===e.isDepthClip&&this.lineWidth===e.lineWidth&&this.isMultisample===e.isMultisample}}]),e}(),Wf=function(){function e(){y(this,e),this.depthTest=!0,this.depthWrite=!0,this.depthFunc=Kl.LESS,this.stencilTestFront=!1,this.stencilFuncFront=Kl.ALWAYS,this.stencilReadMaskFront=4294967295,this.stencilWriteMaskFront=4294967295,this.stencilFailOpFront=Jl.KEEP,this.stencilZFailOpFront=Jl.KEEP,this.stencilPassOpFront=Jl.KEEP,this.stencilRefFront=1,this.stencilTestBack=!1,this.stencilFuncBack=Kl.ALWAYS,this.stencilReadMaskBack=4294967295,this.stencilWriteMaskBack=4294967295,this.stencilFailOpBack=Jl.KEEP,this.stencilZFailOpBack=Jl.KEEP,this.stencilPassOpBack=Jl.KEEP,this.stencilRefBack=1}return l(e,[{key:"compare",value:function(e){return this.depthTest===e.depthTest&&this.depthWrite===e.depthWrite&&this.depthFunc===e.depthFunc&&this.stencilTestFront===e.stencilTestFront&&this.stencilFuncFront===e.stencilFuncFront&&this.stencilReadMaskFront===e.stencilReadMaskFront&&this.stencilWriteMaskFront===e.stencilWriteMaskFront&&this.stencilFailOpFront===e.stencilFailOpFront&&this.stencilZFailOpFront===e.stencilZFailOpFront&&this.stencilPassOpFront===e.stencilPassOpFront&&this.stencilRefFront===e.stencilRefFront&&this.stencilTestBack===e.stencilTestBack&&this.stencilFuncBack===e.stencilFuncBack&&this.stencilReadMaskBack===e.stencilReadMaskBack&&this.stencilWriteMaskBack===e.stencilWriteMaskBack&&this.stencilFailOpBack===e.stencilFailOpBack&&this.stencilZFailOpBack===e.stencilZFailOpBack&&this.stencilPassOpBack===e.stencilPassOpBack&&this.stencilRefBack===e.stencilRefBack}}]),e}(),Xf=function(){function e(){y(this,e),this.blend=!1,this.blendSrc=ic.ONE,this.blendDst=ic.ZERO,this.blendEq=ec.ADD,this.blendSrcAlpha=ic.ONE,this.blendDstAlpha=ic.ZERO,this.blendAlphaEq=ec.ADD,this.blendColorMask=rc.ALL}return l(e,[{key:"compare",value:function(e){return this.blend===e.blend&&this.blendSrc===e.blendSrc&&this.blendDst===e.blendDst&&this.blendEq===e.blendEq&&this.blendSrcAlpha===e.blendSrcAlpha&&this.blendDstAlpha===e.blendDstAlpha&&this.blendAlphaEq===e.blendAlphaEq&&this.blendColorMask===e.blendColorMask}}]),e}(),Yf=P2("GFXPipelineState",function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,bl.PIPELINE_STATE)))._device=void 0,t._shader=null,t._primitive=Gl.TRIANGLE_LIST,t._is=null,t._rs=null,t._dss=null,t._bs=null,t._dynamicStates=[],t._layout=null,t._renderPass=null,t._device=e,t}return p(i,Hc),l(i,[{key:"shader",get:function(){return this._shader}},{key:"primitive",get:function(){return this._primitive}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"pipelineLayout",get:function(){return this._layout}},{key:"renderPass",get:function(){return this._renderPass}}]),i}()),Qf=P2("GFXQueue",function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,bl.QUEUE)))._device=void 0,t._type=Nc.GRAPHICS,t._device=e,t}return p(i,Hc),l(i,[{key:"type",get:function(){return this._type}}]),i}()),Kf=P2("GFXRenderPass",function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,bl.RENDER_PASS)))._device=void 0,t._colorInfos=[],t._depthStencilInfo=null,t._device=e,t}return p(i,Hc),i}()),Zf=function(){function e(){y(this,e),this.name="",this.minFilter=sc.LINEAR,this.magFilter=sc.LINEAR,this.mipFilter=sc.NONE,this.addressU=lc.WRAP,this.addressV=lc.WRAP,this.addressW=lc.WRAP,this.maxAnisotropy=16,this.cmpFunc=Kl.NEVER,this.borderColor={r:0,g:0,b:0,a:0},this.minLOD=0,this.maxLOD=0,this.mipLODBias=0}return l(e,[{key:"compare",value:function(e){return this.minFilter===e.minFilter&&this.magFilter===e.magFilter&&this.mipFilter===e.mipFilter&&this.addressU===e.addressU&&this.addressV===e.addressV&&this.addressW===e.addressW&&this.maxAnisotropy===e.maxAnisotropy&&this.cmpFunc===e.cmpFunc&&this.borderColor.r===e.borderColor.r&&this.borderColor.g===e.borderColor.g&&this.borderColor.b===e.borderColor.b&&this.borderColor.a===e.borderColor.a&&this.minLOD===e.minLOD&&this.maxLOD===e.maxLOD&&this.mipLODBias===e.mipLODBias}}]),e}(),Jf=P2("GFXSampler",function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,bl.SAMPLER)))._device=void 0,t._state=new Zf,t._device=e,t}return p(i,Hc),l(i,[{key:"state",get:function(){return this._state}}]),i}()),$f=P2("GFXShader",function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,bl.SHADER)))._device=void 0,t._id=void 0,t._name="",t._stages=[],t._blocks=[],t._samplers=[],t._device=e,t._id=e.genShaderId(),t}return p(i,Hc),l(i,[{key:"id",get:function(){return this._id}},{key:"name",get:function(){return this._name}}]),i}()),ed=P2("GFXTexture",function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,bl.TEXTURE)))._device=void 0,t._type=hc.TEX2D,t._usage=dc.NONE,t._format=Il.UNKNOWN,t._width=0,t._height=0,t._depth=1,t._arrayLayer=1,t._mipLevel=1,t._samples=_c.X1,t._flags=mc.NONE,t._isPowerOf2=!1,t._size=0,t._buffer=null,t._device=e,t}return p(i,Hc),l(i,[{key:"type",get:function(){return this._type}},{key:"usage",get:function(){return this._usage}},{key:"format",get:function(){return this._format}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"depth",get:function(){return this._depth}},{key:"arrayLayer",get:function(){return this._arrayLayer}},{key:"mipLevel",get:function(){return this._mipLevel}},{key:"samples",get:function(){return this._samples}},{key:"flags",get:function(){return this._flags}},{key:"size",get:function(){return this._size}},{key:"buffer",get:function(){return this._buffer}}]),i}()),td=P2("GFXTextureView",function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,bl.TEXTURE_VIEW)))._device=void 0,t._texture=null,t._type=gc.TV2D,t._format=Il.UNKNOWN,t._baseLevel=0,t._levelCount=1,t._baseLayer=0,t._layerCount=1,t._device=e,t}return p(i,Hc),l(i,[{key:"texture",get:function(){return this._texture}},{key:"type",get:function(){return this._type}},{key:"format",get:function(){return this._format}},{key:"baseLevel",get:function(){return this._baseLevel}},{key:"levelCount",get:function(){return this._levelCount}},{key:"baseLayer",get:function(){return this._baseLayer}},{key:"layerCount",get:function(){return this._layerCount}}]),i}());cc.GFXDevice=ou,cc.GFXBuffer=kh,cc.GFXTexture=ed,cc.GFXTextureView=td,cc.GFXSampler=Jf,cc.GFXShader=$f,cc.GFXInputAssembler=Hf,cc.GFXRenderPass=Kf,cc.GFXFramebuffer=Oh,cc.GFXPipelineLayout=qf,cc.GFXPipelineState=Yf,cc.GFXCommandBuffer=Rh,cc.GFXQueue=Qf,Object.assign(cc,ru);var id,nd,rd,ad=function(){function t(e){y(this,t),this._device=void 0,this._format=Il.UNKNOWN,this._formatSize=0,this._chunks=[],this._chunkCount=0,this._handles=[],this._region0=new Yc,this._region1=new Yc,this._region2=new Yc,this._roundUpFn=null,this._inOrderFree=!1,this._device=e}return l(t,[{key:"initialize",value:function(e){return this._format=e.format,this._formatSize=Qc[this._format].size,this._chunks=new Array(e.maxChunks),this._roundUpFn=e.roundUpFn||null,this._inOrderFree=e.inOrderFree||!1,!0}},{key:"destroy",value:function(){for(var e=0;e<this._chunkCount;++e){var t=this._chunks[e];t.texView.destroy(),t.texture.destroy()}this._chunks.splice(0),this._handles.splice(0)}},{key:"alloc",value:function(l){var c=this;if(0===l)return null;for(var e=function(t){var e=c._chunks[t],i=!1,n=e.start;if(n+l<=e.end)i=!0;else if(c._inOrderFree)n>e.end?n+l<=e.size?i=!0:l<=e.end&&(e.start=n=0,i=!0):n===e.end&&(e.start=n=0,e.end=e.size,l<=e.end&&(i=!0));else{n=0;for(var r=c._handles.filter(function(e){return e.chunkIdx===t}).sort(function(e,t){return e.start-t.start}),a=0;a<r.length;a++){var s=r[a];if(n+l<=s.start){i=!0;break}n=s.end}!i&&n+l<=e.size&&(i=!0)}if(i){e.start+=l;var o={chunkIdx:t,start:n,end:n+l,texture:e.texture,texView:e.texView};return c._handles.push(o),{v:o}}},t=0;t<this._chunkCount;++t){var i=e(t);if("object"===de(i))return i.v}if(this._chunkCount>=this._chunks.length)return console.error("TextureBufferPool: Reach max chunk count."),null;var n=Math.sqrt(l/this._formatSize),r=this._roundUpFn&&this._roundUpFn(n,this._formatSize)||Math.max(1024,function(e){return--e,e|=e>>16,e|=e>>8,e|=e>>4,e|=e>>2,e|=e>>1,++e}(n)),a=r*r*this._formatSize;console.info("TextureBufferPool: Allocate chunk "+this._chunkCount+", size: "+a);var s=this._device.createTexture({type:hc.TEX2D,usage:dc.SAMPLED,format:this._format,width:r,height:r,mipLevel:1}),o=this._device.createTextureView({texture:s,type:gc.TV2D,format:this._format}),u={chunkIdx:this._chunkCount,start:0,end:l,texture:s,texView:o};return this._handles.push(u),this._chunks[this._chunkCount++]={texture:s,texView:o,size:a,start:l,end:a},u}},{key:"free",value:function(e){for(var t=0;t<this._handles.length;++t)if(this._handles[t]===e)return this._chunks[e.chunkIdx].end=e.end,void this._handles.splice(t,1)}},{key:"update",value:function(e,t){var i=[],n=[],r=e.start/this._formatSize,a=t.byteLength/this._formatSize,s=r%e.texture.width,o=Math.floor(r/e.texture.width),l=Math.min(e.texture.width-s,a),c=0;0<s&&(this._region0.texOffset.x=s,this._region0.texOffset.y=o,this._region0.texExtent.width=l,this._region0.texExtent.height=1,i.push(t.slice(c*this._formatSize,(c+l)*this._formatSize)),n.push(this._region0),s=0,o+=1,a-=l,c+=l),0<a&&(this._region1.texOffset.x=s,this._region1.texOffset.y=o,a>e.texture.width?(this._region1.texExtent.width=e.texture.width,this._region1.texExtent.height=Math.floor(a/e.texture.width),l=this._region1.texExtent.width*this._region1.texExtent.height):(l=a,this._region1.texExtent.width=l,this._region1.texExtent.height=1),i.push(t.slice(c*this._formatSize,(c+l)*this._formatSize)),n.push(this._region1),s=0,o+=this._region1.texExtent.height,a-=l,c+=l),0<a&&(this._region2.texOffset.x=s,this._region2.texOffset.y=o,this._region2.texExtent.width=a,this._region2.texExtent.height=1,i.push(t.slice(c*this._formatSize,(c+a)*this._formatSize)),n.push(this._region2)),this._device.copyBuffersToTexture(i,e.texture,n)}}]),t}(),sd=function(e,t,i,n){zn.toRTS(i,dd,fd,pd),n?hn.copy(ud,dd):hn.dot(ud,dd)<0&&hn.multiplyScalar(dd,dd,-1);hn.set(hd,fd.x,fd.y,fd.z,0),hn.multiplyScalar(hd,hn.multiply(hd,hd,dd),.5),e[t+0]=dd.x,e[t+1]=dd.y,e[t+2]=dd.z,e[t+3]=dd.w,e[t+4]=hd.x,e[t+5]=hd.y,e[t+6]=hd.z,e[t+7]=hd.w,e[t+8]=pd.x,e[t+9]=pd.y,e[t+10]=pd.z};function od(e){return e.hasFeature(iu.TEXTURE_FLOAT)?nd.RGBA32F:nd.RGBA8}(rd=nd=nd||{})[rd.NONE=0]="NONE",rd[rd.RGBA8=1]="RGBA8",rd[rd.RGBA32F=2]="RGBA32F";var ld=Object.freeze(new zn),cd=new zn,ud=new hn,hd=new hn,fd=new Fi,dd=new hn,pd=new Fi;function _d(e,t){var i=4/Math.sqrt(t);return 12*Math.ceil(Math.max(204*i,e)/12)}function vd(e){return Math.ceil(Math.log2(Math.max(e,2)))}function md(e,t){switch(e.type){case"boolean":return t?"1":"0";case"string":return void 0!==t?t:e.options[0];case"number":return(void 0!==t?t:e.range[0])+""}return console.warn("unknown define type '".concat(e.type,"'")),"-1"}function yd(e,t,i){var n=e.builtins[i],r=e.blocks,a=n.blocks,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}var c=l,u=t.get(c.name);if(u&&u.type===wc.UNIFORM_BUFFER){var h=Object.assign({defines:c.defines},u.blockInfo);r.push(h)}else console.warn("builtin UBO '".concat(c.name,"' not available!"))}var f=e.samplers,d=n.samplers,p=Array.isArray(d),_=0;for(d=p?d:d[Symbol.iterator]();;){var v;if(p){if(_>=d.length)break;v=d[_++]}else{if((_=d.next()).done)break;v=_.value}var m=v,y=t.get(m.name);if(y&&y.type===wc.SAMPLER){var g=Object.assign({defines:m.defines},y.samplerInfo);f.push(g)}else console.warn("builtin sampler '".concat(m.name,"' not available!"))}}var gd,bd,xd,Sd,wd,Td=(s(id={},nd.RGBA8,Il.RGBA8),s(id,nd.RGBA32F,Il.RGBA32F),id),Ed=function(){function t(e){y(this,t),this._device=void 0,this._pool=void 0,this._textureBuffers=new Map,this._formatSize=0,this._device=e,this._pool=new ad(e)}return l(t,[{key:"initialize",value:function(e){var t=0<arguments.length&&void 0!==e?e:8,i=Td[od(this._device)];this._formatSize=Qc[i].size;var n=16/this._formatSize;this._pool.initialize({format:i,maxChunks:t*n,roundUpFn:_d})}},{key:"destroy",value:function(){this._pool.destroy()}},{key:"getDefaultJointsTexture",value:function(e){var t=e&&e.joints.length||1,i=this._textureBuffers.get(t)||null;if(i)return i.refCount++,i;var n=this._pool.alloc(12*t*Float32Array.BYTES_PER_ELEMENT);if(!n)return null;i={pixelOffset:n.start/this._formatSize,refCount:1,hash:t,handle:n};for(var r=new Float32Array(12*t),a=0;a<t;a++)sd(r,12*a,ld,0===a);return this._pool.update(n,r.buffer),this._textureBuffers.set(t,i),i}},{key:"getJointsTextureWithAnimation",value:function(e,t){var i=e.hash^t.hash,n=this._textureBuffers.get(i)||null;if(n)return n.refCount++,n;var r=t.keys[0].length,a=12*e.joints.length*r,s=this._pool.alloc(a*Float32Array.BYTES_PER_ELEMENT);if(!s)return null;n={pixelOffset:s.start/this._formatSize,refCount:1,hash:i,handle:s};for(var o=new Float32Array(a),l=t.convertedData,c=0;c<e.joints.length;c++){var u=l[e.joints[c]];if(u&&u.props)for(var h=e.bindposes[c],f=u.props.worldMatrix.values,d=0;d<r;d++){var p=f[d];zn.multiply(cd,p,h),sd(o,12*(r*c+d),cd,0===c)}}return this._pool.update(s,o.buffer),this._textureBuffers.set(i,n),n}},{key:"releaseTexture",value:function(e){0==--e.refCount&&(this._pool.free(e.handle),this._textureBuffers.delete(e.hash))}}]),t}(),Cd=P2("effects",[{name:"builtin-billboard",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"builtin-billboard|vert:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],inspector:{type:"color"},type:16}}}]}],shaders:[{name:"builtin-billboard|vert:vs_main|tinted-fs:add",hash:1293952533,glsl3:{vert:"\nprecision mediump float;\nuniform Constants{\n    vec4 mainTiling_Offset;\n    vec4 frameTile_velLenScale;\n    vec4 scale;\n};\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  mat4 cc_matWorldIT;\n};\nvec4 quaternionFromAxisAngle(float angle, vec3 axis){\n    angle /= 2.;\n    float s = sin(angle);\n    vec4 res;\n    res.xyz = s * axis;\n    res.w = cos(angle);\n    return res;\n}\nvec4 quaternionFromAxis(vec3 xAxis,vec3 yAxis,vec3 zAxis){\n    mat3 m = mat3(xAxis,yAxis,zAxis);\n    float trace = m[0][0] + m[1][1] + m[2][2];\n    vec4 quat;\n    if (trace > 0.) {\n        float s = 0.5 / sqrt(trace + 1.0);\n        quat.w = 0.25 / s;\n        quat.x = (m[2][1] - m[1][2]) * s;\n        quat.y = (m[0][2] - m[2][0]) * s;\n        quat.z = (m[1][0] - m[0][1]) * s;\n    } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n        float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n        quat.w = (m[2][1] - m[1][2]) / s;\n        quat.x = 0.25 * s;\n        quat.y = (m[0][1] + m[1][0]) / s;\n        quat.z = (m[0][2] + m[2][0]) / s;\n    } else if (m[1][1] > m[2][2]) {\n        float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n        quat.w = (m[0][2] - m[2][0]) / s;\n        quat.x = (m[0][1] + m[1][0]) / s;\n        quat.y = 0.25 * s;\n        quat.z = (m[1][2] + m[2][1]) / s;\n    } else {\n        float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n        quat.w = (m[1][0] - m[0][1]) / s;\n        quat.x = (m[0][2] + m[2][0]) / s;\n        quat.y = (m[1][2] + m[2][1]) / s;\n        quat.z = 0.25 * s;\n    }\n    float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n    if (len > 0.) {\n        len = 1. / sqrt(len);\n        quat.x = quat.x * len;\n        quat.y = quat.y * len;\n        quat.z = quat.z * len;\n        quat.w = quat.w * len;\n    }\n    return quat;\n}\nvec4 quaternionFromEuler(vec3 angle){\n    float x = angle.x / 2.;\n    float y = angle.y / 2.;\n    float z = angle.z / 2.;\n    float sx = sin(x);\n    float cx = cos(x);\n    float sy = sin(y);\n    float cy = cos(y);\n    float sz = sin(z);\n    float cz = cos(z);\n    vec4 quat = vec4(0);\n    quat.x = sx * cy * cz + cx * sy * sz;\n    quat.y = cx * sy * cz + sx * cy * sz;\n    quat.z = cx * cy * sz - sx * sy * cz;\n    quat.w = cx * cy * cz - sx * sy * sz;\n    return quat;\n}\nmat4 matrixFromRT(vec4 q, vec3 p){\n    float x2 = q.x + q.x;\n    float y2 = q.y + q.y;\n    float z2 = q.z + q.z;\n    float xx = q.x * x2;\n    float xy = q.x * y2;\n    float xz = q.x * z2;\n    float yy = q.y * y2;\n    float yz = q.y * z2;\n    float zz = q.z * z2;\n    float wx = q.w * x2;\n    float wy = q.w * y2;\n    float wz = q.w * z2;\n    return mat4(\n        1. - (yy + zz), xy + wz, xz - wy, 0,\n        xy - wz, 1. - (xx + zz), yz + wx, 0,\n        xz + wy, yz - wx, 1. - (xx + yy), 0,\n        p.x, p.y, p.z, 1\n    );\n}\nmat4 matFromRTS(vec4 q, vec3 t, vec3 s){\n    float x = q.x, y = q.y, z = q.z, w = q.w;\n    float x2 = x + x;\n    float y2 = y + y;\n    float z2 = z + z;\n    float xx = x * x2;\n    float xy = x * y2;\n    float xz = x * z2;\n    float yy = y * y2;\n    float yz = y * z2;\n    float zz = z * z2;\n    float wx = w * x2;\n    float wy = w * y2;\n    float wz = w * z2;\n    float sx = s.x;\n    float sy = s.y;\n    float sz = s.z;\n    return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n        (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n        (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n        t.x, t.y, t.z, 1);\n}\nvoid scaleMatrix(inout mat4 m, float s){\n    m[0].xyz *= s;\n    m[1].xyz *= s;\n    m[2].xyz *= s;\n}\nvec4 quatMultiply(vec4 a, vec4 b){\n    vec4 quat;\n    quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n    quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n    quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n    quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n    return quat;\n}\nvoid rotateVecFromQuat(inout vec3 v, vec4 q){\n    float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n    float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n    float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n    float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n    v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n    v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n    v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateVecFromAxis(vec3 v, vec3 axis, float theta){\n    return cos(theta) * v + sin(theta) * cross(v, axis) + (1. - cos(theta)) * dot(v, axis) * axis;\n}\nvec3 rotateInLocalSpace(vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n    vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n    vec4 rotQuat = quatMultiply(viewQuat, q);\n    rotateVecFromQuat(pos, rotQuat);\n    return pos;\n}\nvoid rotateCorner(inout vec2 corner, float angle){\n    float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n    float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n    corner.x = xOS;\n    corner.y = yOS;\n}\nout vec2 uv;\nout vec4 color;\nvoid computeVertPos(inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if 1 || CC_USE_VERTICAL_BILLBOARD\n    , mat4 viewInv\n#endif\n#if CC_USE_STRETCHED_BILLBOARD\n    , vec3 eye\n    , vec4 velocity\n    , float velocityScale\n    , float lengthScale\n    , float xIndex\n#endif\n) {\n#if 1\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n    vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n    vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_USE_STRETCHED_BILLBOARD\n    vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n    vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n    pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_USE_HORIZONTAL_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = vec3(1, 0, 0);\n    vec3 camY = vec3(0, 0, -1);\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_USE_VERTICAL_BILLBOARD\n    vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n    rotateCorner(viewSpaceVert, q.z);\n    vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n    vec3 camY = vec3(0, 1, 0);\n    vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n    pos.xyz += offset;\n#else\n    pos.x += vertOffset.x;\n    pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV(float frameIndex, vec2 vertIndex, vec2 frameTile){\n    vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n    aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if !CC_USE_MESH\n    vertIndex.y = 1. - vertIndex.y;\n#endif\n    return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nuniform builtin {\n  vec4 cc_size_rotation;\n};\nvec4 vs_main() {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matWorld * pos;\n  vec2 vertOffset = a_texCoord.xy - 0.5;\n  computeVertPos(pos, vertOffset, quaternionFromEuler(0., 0., cc_size_rotation.z), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.xy;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }\n",frag:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nuniform FragConstants {\n  vec4 tintColor;\n};\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n  return CCFragOutput(col);\n}\nvec4 multiply () {\n  vec4 col;\n  vec4 texColor = texture(mainTexture, uv);\n  col.rgb = tintColor.rgb * texColor.rgb * color.rgb * vec3(2.0);\n  col.a = (1.0 - texColor.a) * (tintColor.a * color.a * 2.0);\n  return CCFragOutput(col);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform mat4 cc_matView;\nuniform mat4 cc_matViewInv;\nuniform mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nvec4 quaternionFromAxisAngle(float angle, vec3 axis){\n    angle /= 2.;\n    float s = sin(angle);\n    vec4 res;\n    res.xyz = s * axis;\n    res.w = cos(angle);\n    return res;\n}\nvec4 quaternionFromAxis(vec3 xAxis,vec3 yAxis,vec3 zAxis){\n    mat3 m = mat3(xAxis,yAxis,zAxis);\n    float trace = m[0][0] + m[1][1] + m[2][2];\n    vec4 quat;\n    if (trace > 0.) {\n        float s = 0.5 / sqrt(trace + 1.0);\n        quat.w = 0.25 / s;\n        quat.x = (m[2][1] - m[1][2]) * s;\n        quat.y = (m[0][2] - m[2][0]) * s;\n        quat.z = (m[1][0] - m[0][1]) * s;\n    } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n        float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n        quat.w = (m[2][1] - m[1][2]) / s;\n        quat.x = 0.25 * s;\n        quat.y = (m[0][1] + m[1][0]) / s;\n        quat.z = (m[0][2] + m[2][0]) / s;\n    } else if (m[1][1] > m[2][2]) {\n        float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n        quat.w = (m[0][2] - m[2][0]) / s;\n        quat.x = (m[0][1] + m[1][0]) / s;\n        quat.y = 0.25 * s;\n        quat.z = (m[1][2] + m[2][1]) / s;\n    } else {\n        float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n        quat.w = (m[1][0] - m[0][1]) / s;\n        quat.x = (m[0][2] + m[2][0]) / s;\n        quat.y = (m[1][2] + m[2][1]) / s;\n        quat.z = 0.25 * s;\n    }\n    float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n    if (len > 0.) {\n        len = 1. / sqrt(len);\n        quat.x = quat.x * len;\n        quat.y = quat.y * len;\n        quat.z = quat.z * len;\n        quat.w = quat.w * len;\n    }\n    return quat;\n}\nvec4 quaternionFromEuler(vec3 angle){\n    float x = angle.x / 2.;\n    float y = angle.y / 2.;\n    float z = angle.z / 2.;\n    float sx = sin(x);\n    float cx = cos(x);\n    float sy = sin(y);\n    float cy = cos(y);\n    float sz = sin(z);\n    float cz = cos(z);\n    vec4 quat = vec4(0);\n    quat.x = sx * cy * cz + cx * sy * sz;\n    quat.y = cx * sy * cz + sx * cy * sz;\n    quat.z = cx * cy * sz - sx * sy * cz;\n    quat.w = cx * cy * cz - sx * sy * sz;\n    return quat;\n}\nmat4 matrixFromRT(vec4 q, vec3 p){\n    float x2 = q.x + q.x;\n    float y2 = q.y + q.y;\n    float z2 = q.z + q.z;\n    float xx = q.x * x2;\n    float xy = q.x * y2;\n    float xz = q.x * z2;\n    float yy = q.y * y2;\n    float yz = q.y * z2;\n    float zz = q.z * z2;\n    float wx = q.w * x2;\n    float wy = q.w * y2;\n    float wz = q.w * z2;\n    return mat4(\n        1. - (yy + zz), xy + wz, xz - wy, 0,\n        xy - wz, 1. - (xx + zz), yz + wx, 0,\n        xz + wy, yz - wx, 1. - (xx + yy), 0,\n        p.x, p.y, p.z, 1\n    );\n}\nmat4 matFromRTS(vec4 q, vec3 t, vec3 s){\n    float x = q.x, y = q.y, z = q.z, w = q.w;\n    float x2 = x + x;\n    float y2 = y + y;\n    float z2 = z + z;\n    float xx = x * x2;\n    float xy = x * y2;\n    float xz = x * z2;\n    float yy = y * y2;\n    float yz = y * z2;\n    float zz = z * z2;\n    float wx = w * x2;\n    float wy = w * y2;\n    float wz = w * z2;\n    float sx = s.x;\n    float sy = s.y;\n    float sz = s.z;\n    return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n        (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n        (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n        t.x, t.y, t.z, 1);\n}\nvoid scaleMatrix(inout mat4 m, float s){\n    m[0].xyz *= s;\n    m[1].xyz *= s;\n    m[2].xyz *= s;\n}\nvec4 quatMultiply(vec4 a, vec4 b){\n    vec4 quat;\n    quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n    quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n    quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n    quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n    return quat;\n}\nvoid rotateVecFromQuat(inout vec3 v, vec4 q){\n    float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n    float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n    float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n    float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n    v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n    v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n    v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateVecFromAxis(vec3 v, vec3 axis, float theta){\n    return cos(theta) * v + sin(theta) * cross(v, axis) + (1. - cos(theta)) * dot(v, axis) * axis;\n}\nvec3 rotateInLocalSpace(vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n    vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n    vec4 rotQuat = quatMultiply(viewQuat, q);\n    rotateVecFromQuat(pos, rotQuat);\n    return pos;\n}\nvoid rotateCorner(inout vec2 corner, float angle){\n    float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n    float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n    corner.x = xOS;\n    corner.y = yOS;\n}\nvarying vec2 uv;\nvarying vec4 color;\nvoid computeVertPos(inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if 1 || CC_USE_VERTICAL_BILLBOARD\n    , mat4 viewInv\n#endif\n#if CC_USE_STRETCHED_BILLBOARD\n    , vec3 eye\n    , vec4 velocity\n    , float velocityScale\n    , float lengthScale\n    , float xIndex\n#endif\n) {\n#if 1\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n    vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n    vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_USE_STRETCHED_BILLBOARD\n    vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n    vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n    pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_USE_HORIZONTAL_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = vec3(1, 0, 0);\n    vec3 camY = vec3(0, 0, -1);\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_USE_VERTICAL_BILLBOARD\n    vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n    rotateCorner(viewSpaceVert, q.z);\n    vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n    vec3 camY = vec3(0, 1, 0);\n    vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n    pos.xyz += offset;\n#else\n    pos.x += vertOffset.x;\n    pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV(float frameIndex, vec2 vertIndex, vec2 frameTile){\n    vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n    aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if !CC_USE_MESH\n    vertIndex.y = 1. - vertIndex.y;\n#endif\n    return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nuniform vec4 cc_size_rotation;\nvec4 vs_main() {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matWorld * pos;\n  vec2 vertOffset = a_texCoord.xy - 0.5;\n  computeVertPos(pos, vertOffset, quaternionFromEuler(0., 0., cc_size_rotation.z), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.xy;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }\n",frag:"\nprecision mediump float;\nuniform vec4 cc_exposure;\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n  return CCFragOutput(col);\n}\nvec4 multiply () {\n  vec4 col;\n  vec4 texColor = texture2D(mainTexture, uv);\n  col.rgb = tintColor.rgb * texColor.rgb * color.rgb * vec3(2.0);\n  col.a = (1.0 - texColor.a) * (tintColor.a * color.a * 2.0);\n  return CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_USE_STRETCHED_BILLBOARD",type:"boolean",defines:[]},{name:"CC_USE_HORIZONTAL_BILLBOARD",type:"boolean",defines:[]},{name:"CC_USE_VERTICAL_BILLBOARD",type:"boolean",defines:[]},{name:"CC_USE_MESH",type:"boolean",defines:[]},{name:"CC_USE_HDR",type:"boolean",defines:[]}],blocks:[{name:"Constants",defines:[],binding:0,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"builtin",defines:[],binding:1,members:[{name:"cc_size_rotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:2,members:[{name:"tintColor",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],binding:30}],dependencies:{}}]},{name:"builtin-particle-trail",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"builtin-particle-trail|particle-trail:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},frameTile_velLenScale:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],inspector:{type:"color"},type:16}}}]}],shaders:[{name:"builtin-particle-trail|particle-trail:vs_main|tinted-fs:add",hash:3652998255,glsl3:{vert:"\nprecision mediump float;\nuniform Constants{\n    vec4 mainTiling_Offset;\n    vec4 frameTile_velLenScale;\n    vec4 scale;\n};\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  mat4 cc_matWorldIT;\n};\nvec4 quaternionFromAxisAngle(float angle, vec3 axis){\n    angle /= 2.;\n    float s = sin(angle);\n    vec4 res;\n    res.xyz = s * axis;\n    res.w = cos(angle);\n    return res;\n}\nvec4 quaternionFromAxis(vec3 xAxis,vec3 yAxis,vec3 zAxis){\n    mat3 m = mat3(xAxis,yAxis,zAxis);\n    float trace = m[0][0] + m[1][1] + m[2][2];\n    vec4 quat;\n    if (trace > 0.) {\n        float s = 0.5 / sqrt(trace + 1.0);\n        quat.w = 0.25 / s;\n        quat.x = (m[2][1] - m[1][2]) * s;\n        quat.y = (m[0][2] - m[2][0]) * s;\n        quat.z = (m[1][0] - m[0][1]) * s;\n    } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n        float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n        quat.w = (m[2][1] - m[1][2]) / s;\n        quat.x = 0.25 * s;\n        quat.y = (m[0][1] + m[1][0]) / s;\n        quat.z = (m[0][2] + m[2][0]) / s;\n    } else if (m[1][1] > m[2][2]) {\n        float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n        quat.w = (m[0][2] - m[2][0]) / s;\n        quat.x = (m[0][1] + m[1][0]) / s;\n        quat.y = 0.25 * s;\n        quat.z = (m[1][2] + m[2][1]) / s;\n    } else {\n        float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n        quat.w = (m[1][0] - m[0][1]) / s;\n        quat.x = (m[0][2] + m[2][0]) / s;\n        quat.y = (m[1][2] + m[2][1]) / s;\n        quat.z = 0.25 * s;\n    }\n    float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n    if (len > 0.) {\n        len = 1. / sqrt(len);\n        quat.x = quat.x * len;\n        quat.y = quat.y * len;\n        quat.z = quat.z * len;\n        quat.w = quat.w * len;\n    }\n    return quat;\n}\nvec4 quaternionFromEuler(vec3 angle){\n    float x = angle.x / 2.;\n    float y = angle.y / 2.;\n    float z = angle.z / 2.;\n    float sx = sin(x);\n    float cx = cos(x);\n    float sy = sin(y);\n    float cy = cos(y);\n    float sz = sin(z);\n    float cz = cos(z);\n    vec4 quat = vec4(0);\n    quat.x = sx * cy * cz + cx * sy * sz;\n    quat.y = cx * sy * cz + sx * cy * sz;\n    quat.z = cx * cy * sz - sx * sy * cz;\n    quat.w = cx * cy * cz - sx * sy * sz;\n    return quat;\n}\nmat4 matrixFromRT(vec4 q, vec3 p){\n    float x2 = q.x + q.x;\n    float y2 = q.y + q.y;\n    float z2 = q.z + q.z;\n    float xx = q.x * x2;\n    float xy = q.x * y2;\n    float xz = q.x * z2;\n    float yy = q.y * y2;\n    float yz = q.y * z2;\n    float zz = q.z * z2;\n    float wx = q.w * x2;\n    float wy = q.w * y2;\n    float wz = q.w * z2;\n    return mat4(\n        1. - (yy + zz), xy + wz, xz - wy, 0,\n        xy - wz, 1. - (xx + zz), yz + wx, 0,\n        xz + wy, yz - wx, 1. - (xx + yy), 0,\n        p.x, p.y, p.z, 1\n    );\n}\nmat4 matFromRTS(vec4 q, vec3 t, vec3 s){\n    float x = q.x, y = q.y, z = q.z, w = q.w;\n    float x2 = x + x;\n    float y2 = y + y;\n    float z2 = z + z;\n    float xx = x * x2;\n    float xy = x * y2;\n    float xz = x * z2;\n    float yy = y * y2;\n    float yz = y * z2;\n    float zz = z * z2;\n    float wx = w * x2;\n    float wy = w * y2;\n    float wz = w * z2;\n    float sx = s.x;\n    float sy = s.y;\n    float sz = s.z;\n    return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n        (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n        (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n        t.x, t.y, t.z, 1);\n}\nvoid scaleMatrix(inout mat4 m, float s){\n    m[0].xyz *= s;\n    m[1].xyz *= s;\n    m[2].xyz *= s;\n}\nvec4 quatMultiply(vec4 a, vec4 b){\n    vec4 quat;\n    quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n    quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n    quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n    quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n    return quat;\n}\nvoid rotateVecFromQuat(inout vec3 v, vec4 q){\n    float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n    float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n    float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n    float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n    v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n    v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n    v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateVecFromAxis(vec3 v, vec3 axis, float theta){\n    return cos(theta) * v + sin(theta) * cross(v, axis) + (1. - cos(theta)) * dot(v, axis) * axis;\n}\nvec3 rotateInLocalSpace(vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n    vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n    vec4 rotQuat = quatMultiply(viewQuat, q);\n    rotateVecFromQuat(pos, rotQuat);\n    return pos;\n}\nvoid rotateCorner(inout vec2 corner, float angle){\n    float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n    float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n    corner.x = xOS;\n    corner.y = yOS;\n}\nout vec2 uv;\nout vec4 color;\nvoid computeVertPos(inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_USE_BILLBOARD || CC_USE_VERTICAL_BILLBOARD\n    , mat4 viewInv\n#endif\n#if CC_USE_STRETCHED_BILLBOARD\n    , vec3 eye\n    , vec4 velocity\n    , float velocityScale\n    , float lengthScale\n    , float xIndex\n#endif\n) {\n#if CC_USE_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n    vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n    vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_USE_STRETCHED_BILLBOARD\n    vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n    vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n    pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_USE_HORIZONTAL_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = vec3(1, 0, 0);\n    vec3 camY = vec3(0, 0, -1);\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_USE_VERTICAL_BILLBOARD\n    vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n    rotateCorner(viewSpaceVert, q.z);\n    vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n    vec3 camY = vec3(0, 1, 0);\n    vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n    pos.xyz += offset;\n#else\n    pos.x += vertOffset.x;\n    pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV(float frameIndex, vec2 vertIndex, vec2 frameTile){\n    vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n    aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if !CC_USE_MESH\n    vertIndex.y = 1. - vertIndex.y;\n#endif\n    return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nin vec3 a_position;\nin vec4 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\n    out vec3 vBarycentric;\n#endif\nvec4 vs_main() {\n    highp vec4 pos = vec4(a_position, 1);\n    vec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    velocity = cc_matWorld * velocity;\n#endif\n    float vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\n    vec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\n    if (camUp.y < 0.) {\n        camUp *= -1.;\n    }\n    pos.xyz += camUp * vertOffset;\n    pos = cc_matViewProj * pos;\n    uv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\n    color = a_color;\n#if CC_DRAW_WIRE_FRAME\n    vBarycentric = a_texCoord2;\n#endif\n    return pos;\n}\nvoid main() { gl_Position = vs_main(); }\n",frag:"\n  precision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\n  in vec2 uv;\n  in vec4 color;\n  #if CC_DRAW_WIRE_FRAME\n    in vec3 vBarycentric;\n  #endif\n  uniform sampler2D mainTexture;\n  uniform FragConstants {\n    vec4 tintColor;\n  };\n  vec4 add () {\n    vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\n    if (any(lessThan(vBarycentric, vec3(0.02)))) {\n        col = vec4(0., 1., 1., 1.);\n    }\n#endif\n    return CCFragOutput(col);\n  }\n  vec4 multiply () {\n    vec4 col;\n    vec4 texColor = texture(mainTexture, uv);\n    col.rgb = tintColor.rgb * texColor.rgb * color.rgb * vec3(2.0);\n    col.a = (1.0 - texColor.a) * (tintColor.a * color.a * 2.0);\n#if CC_DRAW_WIRE_FRAME\n    if (any(lessThan(vBarycentric, vec3(0.02)))) {\n        col = vec4(0., 1., 1., col.a);\n    }\n#endif\n    return CCFragOutput(col);\n  }\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform vec4 mainTiling_Offset;\nuniform mat4 cc_matView;\nuniform mat4 cc_matViewProj;\nuniform vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvec4 quaternionFromAxisAngle(float angle, vec3 axis){\n    angle /= 2.;\n    float s = sin(angle);\n    vec4 res;\n    res.xyz = s * axis;\n    res.w = cos(angle);\n    return res;\n}\nvec4 quaternionFromAxis(vec3 xAxis,vec3 yAxis,vec3 zAxis){\n    mat3 m = mat3(xAxis,yAxis,zAxis);\n    float trace = m[0][0] + m[1][1] + m[2][2];\n    vec4 quat;\n    if (trace > 0.) {\n        float s = 0.5 / sqrt(trace + 1.0);\n        quat.w = 0.25 / s;\n        quat.x = (m[2][1] - m[1][2]) * s;\n        quat.y = (m[0][2] - m[2][0]) * s;\n        quat.z = (m[1][0] - m[0][1]) * s;\n    } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n        float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n        quat.w = (m[2][1] - m[1][2]) / s;\n        quat.x = 0.25 * s;\n        quat.y = (m[0][1] + m[1][0]) / s;\n        quat.z = (m[0][2] + m[2][0]) / s;\n    } else if (m[1][1] > m[2][2]) {\n        float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n        quat.w = (m[0][2] - m[2][0]) / s;\n        quat.x = (m[0][1] + m[1][0]) / s;\n        quat.y = 0.25 * s;\n        quat.z = (m[1][2] + m[2][1]) / s;\n    } else {\n        float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n        quat.w = (m[1][0] - m[0][1]) / s;\n        quat.x = (m[0][2] + m[2][0]) / s;\n        quat.y = (m[1][2] + m[2][1]) / s;\n        quat.z = 0.25 * s;\n    }\n    float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n    if (len > 0.) {\n        len = 1. / sqrt(len);\n        quat.x = quat.x * len;\n        quat.y = quat.y * len;\n        quat.z = quat.z * len;\n        quat.w = quat.w * len;\n    }\n    return quat;\n}\nvec4 quaternionFromEuler(vec3 angle){\n    float x = angle.x / 2.;\n    float y = angle.y / 2.;\n    float z = angle.z / 2.;\n    float sx = sin(x);\n    float cx = cos(x);\n    float sy = sin(y);\n    float cy = cos(y);\n    float sz = sin(z);\n    float cz = cos(z);\n    vec4 quat = vec4(0);\n    quat.x = sx * cy * cz + cx * sy * sz;\n    quat.y = cx * sy * cz + sx * cy * sz;\n    quat.z = cx * cy * sz - sx * sy * cz;\n    quat.w = cx * cy * cz - sx * sy * sz;\n    return quat;\n}\nmat4 matrixFromRT(vec4 q, vec3 p){\n    float x2 = q.x + q.x;\n    float y2 = q.y + q.y;\n    float z2 = q.z + q.z;\n    float xx = q.x * x2;\n    float xy = q.x * y2;\n    float xz = q.x * z2;\n    float yy = q.y * y2;\n    float yz = q.y * z2;\n    float zz = q.z * z2;\n    float wx = q.w * x2;\n    float wy = q.w * y2;\n    float wz = q.w * z2;\n    return mat4(\n        1. - (yy + zz), xy + wz, xz - wy, 0,\n        xy - wz, 1. - (xx + zz), yz + wx, 0,\n        xz + wy, yz - wx, 1. - (xx + yy), 0,\n        p.x, p.y, p.z, 1\n    );\n}\nmat4 matFromRTS(vec4 q, vec3 t, vec3 s){\n    float x = q.x, y = q.y, z = q.z, w = q.w;\n    float x2 = x + x;\n    float y2 = y + y;\n    float z2 = z + z;\n    float xx = x * x2;\n    float xy = x * y2;\n    float xz = x * z2;\n    float yy = y * y2;\n    float yz = y * z2;\n    float zz = z * z2;\n    float wx = w * x2;\n    float wy = w * y2;\n    float wz = w * z2;\n    float sx = s.x;\n    float sy = s.y;\n    float sz = s.z;\n    return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n        (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n        (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n        t.x, t.y, t.z, 1);\n}\nvoid scaleMatrix(inout mat4 m, float s){\n    m[0].xyz *= s;\n    m[1].xyz *= s;\n    m[2].xyz *= s;\n}\nvec4 quatMultiply(vec4 a, vec4 b){\n    vec4 quat;\n    quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n    quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n    quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n    quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n    return quat;\n}\nvoid rotateVecFromQuat(inout vec3 v, vec4 q){\n    float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n    float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n    float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n    float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n    v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n    v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n    v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateVecFromAxis(vec3 v, vec3 axis, float theta){\n    return cos(theta) * v + sin(theta) * cross(v, axis) + (1. - cos(theta)) * dot(v, axis) * axis;\n}\nvec3 rotateInLocalSpace(vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n    vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n    vec4 rotQuat = quatMultiply(viewQuat, q);\n    rotateVecFromQuat(pos, rotQuat);\n    return pos;\n}\nvoid rotateCorner(inout vec2 corner, float angle){\n    float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n    float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n    corner.x = xOS;\n    corner.y = yOS;\n}\nvarying vec2 uv;\nvarying vec4 color;\nvoid computeVertPos(inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_USE_BILLBOARD || CC_USE_VERTICAL_BILLBOARD\n    , mat4 viewInv\n#endif\n#if CC_USE_STRETCHED_BILLBOARD\n    , vec3 eye\n    , vec4 velocity\n    , float velocityScale\n    , float lengthScale\n    , float xIndex\n#endif\n) {\n#if CC_USE_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n    vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n    vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_USE_STRETCHED_BILLBOARD\n    vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n    vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n    pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_USE_HORIZONTAL_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = vec3(1, 0, 0);\n    vec3 camY = vec3(0, 0, -1);\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_USE_VERTICAL_BILLBOARD\n    vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n    rotateCorner(viewSpaceVert, q.z);\n    vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n    vec3 camY = vec3(0, 1, 0);\n    vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n    pos.xyz += offset;\n#else\n    pos.x += vertOffset.x;\n    pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV(float frameIndex, vec2 vertIndex, vec2 frameTile){\n    vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n    aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if !CC_USE_MESH\n    vertIndex.y = 1. - vertIndex.y;\n#endif\n    return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nattribute vec3 a_position;\nattribute vec4 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\n    varying vec3 vBarycentric;\n#endif\nvec4 vs_main() {\n    highp vec4 pos = vec4(a_position, 1);\n    vec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    velocity = cc_matWorld * velocity;\n#endif\n    float vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\n    vec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\n    if (camUp.y < 0.) {\n        camUp *= -1.;\n    }\n    pos.xyz += camUp * vertOffset;\n    pos = cc_matViewProj * pos;\n    uv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\n    color = a_color;\n#if CC_DRAW_WIRE_FRAME\n    vBarycentric = a_texCoord2;\n#endif\n    return pos;\n}\nvoid main() { gl_Position = vs_main(); }\n",frag:"\n  precision mediump float;\nuniform vec4 cc_exposure;\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\n  varying vec2 uv;\n  varying vec4 color;\n  #if CC_DRAW_WIRE_FRAME\n    varying vec3 vBarycentric;\n  #endif\n  uniform sampler2D mainTexture;\n  uniform vec4 tintColor;\n  vec4 add () {\n    vec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\n    if (any(lessThan(vBarycentric, vec3(0.02)))) {\n        col = vec4(0., 1., 1., 1.);\n    }\n#endif\n    return CCFragOutput(col);\n  }\n  vec4 multiply () {\n    vec4 col;\n    vec4 texColor = texture2D(mainTexture, uv);\n    col.rgb = tintColor.rgb * texColor.rgb * color.rgb * vec3(2.0);\n    col.a = (1.0 - texColor.a) * (tintColor.a * color.a * 2.0);\n#if CC_DRAW_WIRE_FRAME\n    if (any(lessThan(vBarycentric, vec3(0.02)))) {\n        col = vec4(0., 1., 1., col.a);\n    }\n#endif\n    return CCFragOutput(col);\n  }\nvoid main() { gl_FragColor = add(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_USE_BILLBOARD",type:"boolean",defines:[]},{name:"CC_USE_STRETCHED_BILLBOARD",type:"boolean",defines:[]},{name:"CC_USE_HORIZONTAL_BILLBOARD",type:"boolean",defines:[]},{name:"CC_USE_VERTICAL_BILLBOARD",type:"boolean",defines:[]},{name:"CC_USE_MESH",type:"boolean",defines:[]},{name:"CC_DRAW_WIRE_FRAME",type:"boolean",defines:[]},{name:"CC_USE_WORLD_SPACE",type:"boolean",defines:[]},{name:"CC_USE_HDR",type:"boolean",defines:[]}],blocks:[{name:"Constants",defines:[],binding:0,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,members:[{name:"tintColor",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],binding:30}],dependencies:{}}]},{name:"builtin-particle",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"builtin-particle|particle-vs-legacy:lpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],inspector:{type:"color"},type:16}}}]}],shaders:[{name:"builtin-particle|particle-vs-legacy:lpvs_main|tinted-fs:add",hash:722071529,glsl3:{vert:"\nprecision highp float;\nvec4 quaternionFromAxisAngle(float angle, vec3 axis){\n    angle /= 2.;\n    float s = sin(angle);\n    vec4 res;\n    res.xyz = s * axis;\n    res.w = cos(angle);\n    return res;\n}\nvec4 quaternionFromAxis(vec3 xAxis,vec3 yAxis,vec3 zAxis){\n    mat3 m = mat3(xAxis,yAxis,zAxis);\n    float trace = m[0][0] + m[1][1] + m[2][2];\n    vec4 quat;\n    if (trace > 0.) {\n        float s = 0.5 / sqrt(trace + 1.0);\n        quat.w = 0.25 / s;\n        quat.x = (m[2][1] - m[1][2]) * s;\n        quat.y = (m[0][2] - m[2][0]) * s;\n        quat.z = (m[1][0] - m[0][1]) * s;\n    } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n        float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n        quat.w = (m[2][1] - m[1][2]) / s;\n        quat.x = 0.25 * s;\n        quat.y = (m[0][1] + m[1][0]) / s;\n        quat.z = (m[0][2] + m[2][0]) / s;\n    } else if (m[1][1] > m[2][2]) {\n        float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n        quat.w = (m[0][2] - m[2][0]) / s;\n        quat.x = (m[0][1] + m[1][0]) / s;\n        quat.y = 0.25 * s;\n        quat.z = (m[1][2] + m[2][1]) / s;\n    } else {\n        float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n        quat.w = (m[1][0] - m[0][1]) / s;\n        quat.x = (m[0][2] + m[2][0]) / s;\n        quat.y = (m[1][2] + m[2][1]) / s;\n        quat.z = 0.25 * s;\n    }\n    float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n    if (len > 0.) {\n        len = 1. / sqrt(len);\n        quat.x = quat.x * len;\n        quat.y = quat.y * len;\n        quat.z = quat.z * len;\n        quat.w = quat.w * len;\n    }\n    return quat;\n}\nvec4 quaternionFromEuler(vec3 angle){\n    float x = angle.x / 2.;\n    float y = angle.y / 2.;\n    float z = angle.z / 2.;\n    float sx = sin(x);\n    float cx = cos(x);\n    float sy = sin(y);\n    float cy = cos(y);\n    float sz = sin(z);\n    float cz = cos(z);\n    vec4 quat = vec4(0);\n    quat.x = sx * cy * cz + cx * sy * sz;\n    quat.y = cx * sy * cz + sx * cy * sz;\n    quat.z = cx * cy * sz - sx * sy * cz;\n    quat.w = cx * cy * cz - sx * sy * sz;\n    return quat;\n}\nmat4 matrixFromRT(vec4 q, vec3 p){\n    float x2 = q.x + q.x;\n    float y2 = q.y + q.y;\n    float z2 = q.z + q.z;\n    float xx = q.x * x2;\n    float xy = q.x * y2;\n    float xz = q.x * z2;\n    float yy = q.y * y2;\n    float yz = q.y * z2;\n    float zz = q.z * z2;\n    float wx = q.w * x2;\n    float wy = q.w * y2;\n    float wz = q.w * z2;\n    return mat4(\n        1. - (yy + zz), xy + wz, xz - wy, 0,\n        xy - wz, 1. - (xx + zz), yz + wx, 0,\n        xz + wy, yz - wx, 1. - (xx + yy), 0,\n        p.x, p.y, p.z, 1\n    );\n}\nmat4 matFromRTS(vec4 q, vec3 t, vec3 s){\n    float x = q.x, y = q.y, z = q.z, w = q.w;\n    float x2 = x + x;\n    float y2 = y + y;\n    float z2 = z + z;\n    float xx = x * x2;\n    float xy = x * y2;\n    float xz = x * z2;\n    float yy = y * y2;\n    float yz = y * z2;\n    float zz = z * z2;\n    float wx = w * x2;\n    float wy = w * y2;\n    float wz = w * z2;\n    float sx = s.x;\n    float sy = s.y;\n    float sz = s.z;\n    return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n        (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n        (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n        t.x, t.y, t.z, 1);\n}\nvoid scaleMatrix(inout mat4 m, float s){\n    m[0].xyz *= s;\n    m[1].xyz *= s;\n    m[2].xyz *= s;\n}\nvec4 quatMultiply(vec4 a, vec4 b){\n    vec4 quat;\n    quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n    quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n    quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n    quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n    return quat;\n}\nvoid rotateVecFromQuat(inout vec3 v, vec4 q){\n    float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n    float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n    float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n    float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n    v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n    v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n    v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateVecFromAxis(vec3 v, vec3 axis, float theta){\n    return cos(theta) * v + sin(theta) * cross(v, axis) + (1. - cos(theta)) * dot(v, axis) * axis;\n}\nvec3 rotateInLocalSpace(vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n    vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n    vec4 rotQuat = quatMultiply(viewQuat, q);\n    rotateVecFromQuat(pos, rotQuat);\n    return pos;\n}\nvoid rotateCorner(inout vec2 corner, float angle){\n    float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n    float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n    corner.x = xOS;\n    corner.y = yOS;\n}\nuniform Constants{\n    vec4 mainTiling_Offset;\n    vec4 frameTile_velLenScale;\n    vec4 scale;\n};\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  mat4 cc_matWorldIT;\n};\nout vec2 uv;\nout vec4 color;\nvoid computeVertPos(inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_USE_BILLBOARD || CC_USE_VERTICAL_BILLBOARD\n    , mat4 viewInv\n#endif\n#if CC_USE_STRETCHED_BILLBOARD\n    , vec3 eye\n    , vec4 velocity\n    , float velocityScale\n    , float lengthScale\n    , float xIndex\n#endif\n) {\n#if CC_USE_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n    vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n    vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_USE_STRETCHED_BILLBOARD\n    vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n    vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n    pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_USE_HORIZONTAL_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = vec3(1, 0, 0);\n    vec3 camY = vec3(0, 0, -1);\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_USE_VERTICAL_BILLBOARD\n    vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n    rotateCorner(viewSpaceVert, q.z);\n    vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n    vec3 camY = vec3(0, 1, 0);\n    vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n    pos.xyz += offset;\n#else\n    pos.x += vertOffset.x;\n    pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV(float frameIndex, vec2 vertIndex, vec2 frameTile){\n    vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n    aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if !CC_USE_MESH\n    vertIndex.y = 1. - vertIndex.y;\n#endif\n    return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nin vec3 a_position;\nin vec3 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_USE_STRETCHED_BILLBOARD\n    in vec3 a_color1;\n#endif\n#if CC_USE_MESH\n    in vec3 a_texCoord3;\n    in vec3 a_normal;\n    in vec4 a_color1;\n#endif\nvec4 lpvs_main() {\n    vec3 compScale = scale.xyz * a_texCoord1;\n    vec4 pos = vec4(a_position, 1);\n#if CC_USE_STRETCHED_BILLBOARD\n    vec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    #if CC_USE_STRETCHED_BILLBOARD\n        velocity = cc_matWorld * velocity;\n    #endif\n#endif\n#if !CC_USE_MESH\n    vec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n    #if CC_USE_BILLBOARD\n        vec3 rotEuler = a_texCoord2;\n    #elif CC_USE_STRETCHED_BILLBOARD\n        vec3 rotEuler = vec3(0.);\n    #else\n        vec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n    #endif\n    computeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n    #if CC_USE_BILLBOARD || CC_USE_VERTICAL_BILLBOARD\n        , cc_matViewInv\n    #endif\n    #if CC_USE_STRETCHED_BILLBOARD\n        , cc_cameraPos.xyz\n        , velocity\n        , frameTile_velLenScale.z\n        , frameTile_velLenScale.w\n        , a_texCoord.x\n    #endif\n    );\n    color = a_color;\n#else\n    mat4 xformNoScale = matrixFromRT(quaternionFromEuler(a_texCoord2), pos.xyz);\n    mat4 xform = matFromRTS(quaternionFromEuler(a_texCoord2), pos.xyz, compScale);\n    pos = xform * vec4(a_texCoord3, 1);\n    vec4 normal = xformNoScale * vec4(a_normal, 0);\n    color = a_color * a_color1;\n#endif\n    uv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\n    pos = cc_matViewProj * pos;\n    return pos;\n}\nvoid main() { gl_Position = lpvs_main(); }\n",frag:"\nprecision highp float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nuniform FragConstants {\n  vec4 tintColor;\n};\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n  return CCFragOutput(col);\n}\nvec4 multiply () {\n  vec4 col;\n  vec4 texColor = texture(mainTexture, uv);\n  col.rgb = tintColor.rgb * texColor.rgb * color.rgb * vec3(2.0);\n  col.a = (1.0 - texColor.a) * (tintColor.a * color.a * 2.0);\n  return CCFragOutput(col);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }\n"},glsl1:{vert:"\nprecision highp float;\nvec4 quaternionFromAxisAngle(float angle, vec3 axis){\n    angle /= 2.;\n    float s = sin(angle);\n    vec4 res;\n    res.xyz = s * axis;\n    res.w = cos(angle);\n    return res;\n}\nvec4 quaternionFromAxis(vec3 xAxis,vec3 yAxis,vec3 zAxis){\n    mat3 m = mat3(xAxis,yAxis,zAxis);\n    float trace = m[0][0] + m[1][1] + m[2][2];\n    vec4 quat;\n    if (trace > 0.) {\n        float s = 0.5 / sqrt(trace + 1.0);\n        quat.w = 0.25 / s;\n        quat.x = (m[2][1] - m[1][2]) * s;\n        quat.y = (m[0][2] - m[2][0]) * s;\n        quat.z = (m[1][0] - m[0][1]) * s;\n    } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n        float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n        quat.w = (m[2][1] - m[1][2]) / s;\n        quat.x = 0.25 * s;\n        quat.y = (m[0][1] + m[1][0]) / s;\n        quat.z = (m[0][2] + m[2][0]) / s;\n    } else if (m[1][1] > m[2][2]) {\n        float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n        quat.w = (m[0][2] - m[2][0]) / s;\n        quat.x = (m[0][1] + m[1][0]) / s;\n        quat.y = 0.25 * s;\n        quat.z = (m[1][2] + m[2][1]) / s;\n    } else {\n        float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n        quat.w = (m[1][0] - m[0][1]) / s;\n        quat.x = (m[0][2] + m[2][0]) / s;\n        quat.y = (m[1][2] + m[2][1]) / s;\n        quat.z = 0.25 * s;\n    }\n    float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n    if (len > 0.) {\n        len = 1. / sqrt(len);\n        quat.x = quat.x * len;\n        quat.y = quat.y * len;\n        quat.z = quat.z * len;\n        quat.w = quat.w * len;\n    }\n    return quat;\n}\nvec4 quaternionFromEuler(vec3 angle){\n    float x = angle.x / 2.;\n    float y = angle.y / 2.;\n    float z = angle.z / 2.;\n    float sx = sin(x);\n    float cx = cos(x);\n    float sy = sin(y);\n    float cy = cos(y);\n    float sz = sin(z);\n    float cz = cos(z);\n    vec4 quat = vec4(0);\n    quat.x = sx * cy * cz + cx * sy * sz;\n    quat.y = cx * sy * cz + sx * cy * sz;\n    quat.z = cx * cy * sz - sx * sy * cz;\n    quat.w = cx * cy * cz - sx * sy * sz;\n    return quat;\n}\nmat4 matrixFromRT(vec4 q, vec3 p){\n    float x2 = q.x + q.x;\n    float y2 = q.y + q.y;\n    float z2 = q.z + q.z;\n    float xx = q.x * x2;\n    float xy = q.x * y2;\n    float xz = q.x * z2;\n    float yy = q.y * y2;\n    float yz = q.y * z2;\n    float zz = q.z * z2;\n    float wx = q.w * x2;\n    float wy = q.w * y2;\n    float wz = q.w * z2;\n    return mat4(\n        1. - (yy + zz), xy + wz, xz - wy, 0,\n        xy - wz, 1. - (xx + zz), yz + wx, 0,\n        xz + wy, yz - wx, 1. - (xx + yy), 0,\n        p.x, p.y, p.z, 1\n    );\n}\nmat4 matFromRTS(vec4 q, vec3 t, vec3 s){\n    float x = q.x, y = q.y, z = q.z, w = q.w;\n    float x2 = x + x;\n    float y2 = y + y;\n    float z2 = z + z;\n    float xx = x * x2;\n    float xy = x * y2;\n    float xz = x * z2;\n    float yy = y * y2;\n    float yz = y * z2;\n    float zz = z * z2;\n    float wx = w * x2;\n    float wy = w * y2;\n    float wz = w * z2;\n    float sx = s.x;\n    float sy = s.y;\n    float sz = s.z;\n    return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n        (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n        (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n        t.x, t.y, t.z, 1);\n}\nvoid scaleMatrix(inout mat4 m, float s){\n    m[0].xyz *= s;\n    m[1].xyz *= s;\n    m[2].xyz *= s;\n}\nvec4 quatMultiply(vec4 a, vec4 b){\n    vec4 quat;\n    quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n    quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n    quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n    quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n    return quat;\n}\nvoid rotateVecFromQuat(inout vec3 v, vec4 q){\n    float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n    float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n    float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n    float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n    v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n    v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n    v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateVecFromAxis(vec3 v, vec3 axis, float theta){\n    return cos(theta) * v + sin(theta) * cross(v, axis) + (1. - cos(theta)) * dot(v, axis) * axis;\n}\nvec3 rotateInLocalSpace(vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n    vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n    vec4 rotQuat = quatMultiply(viewQuat, q);\n    rotateVecFromQuat(pos, rotQuat);\n    return pos;\n}\nvoid rotateCorner(inout vec2 corner, float angle){\n    float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n    float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n    corner.x = xOS;\n    corner.y = yOS;\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform mat4 cc_matView;\nuniform mat4 cc_matViewInv;\nuniform mat4 cc_matViewProj;\nuniform vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying vec2 uv;\nvarying vec4 color;\nvoid computeVertPos(inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_USE_BILLBOARD || CC_USE_VERTICAL_BILLBOARD\n    , mat4 viewInv\n#endif\n#if CC_USE_STRETCHED_BILLBOARD\n    , vec3 eye\n    , vec4 velocity\n    , float velocityScale\n    , float lengthScale\n    , float xIndex\n#endif\n) {\n#if CC_USE_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n    vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n    vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_USE_STRETCHED_BILLBOARD\n    vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n    vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n    pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_USE_HORIZONTAL_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = vec3(1, 0, 0);\n    vec3 camY = vec3(0, 0, -1);\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_USE_VERTICAL_BILLBOARD\n    vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n    rotateCorner(viewSpaceVert, q.z);\n    vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n    vec3 camY = vec3(0, 1, 0);\n    vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n    pos.xyz += offset;\n#else\n    pos.x += vertOffset.x;\n    pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV(float frameIndex, vec2 vertIndex, vec2 frameTile){\n    vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n    aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if !CC_USE_MESH\n    vertIndex.y = 1. - vertIndex.y;\n#endif\n    return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nattribute vec3 a_position;\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_USE_STRETCHED_BILLBOARD\n    attribute vec3 a_color1;\n#endif\n#if CC_USE_MESH\n    attribute vec3 a_texCoord3;\n    attribute vec3 a_normal;\n    attribute vec4 a_color1;\n#endif\nvec4 lpvs_main() {\n    vec3 compScale = scale.xyz * a_texCoord1;\n    vec4 pos = vec4(a_position, 1);\n#if CC_USE_STRETCHED_BILLBOARD\n    vec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    #if CC_USE_STRETCHED_BILLBOARD\n        velocity = cc_matWorld * velocity;\n    #endif\n#endif\n#if !CC_USE_MESH\n    vec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n    #if CC_USE_BILLBOARD\n        vec3 rotEuler = a_texCoord2;\n    #elif CC_USE_STRETCHED_BILLBOARD\n        vec3 rotEuler = vec3(0.);\n    #else\n        vec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n    #endif\n    computeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n    #if CC_USE_BILLBOARD || CC_USE_VERTICAL_BILLBOARD\n        , cc_matViewInv\n    #endif\n    #if CC_USE_STRETCHED_BILLBOARD\n        , cc_cameraPos.xyz\n        , velocity\n        , frameTile_velLenScale.z\n        , frameTile_velLenScale.w\n        , a_texCoord.x\n    #endif\n    );\n    color = a_color;\n#else\n    mat4 xformNoScale = matrixFromRT(quaternionFromEuler(a_texCoord2), pos.xyz);\n    mat4 xform = matFromRTS(quaternionFromEuler(a_texCoord2), pos.xyz, compScale);\n    pos = xform * vec4(a_texCoord3, 1);\n    vec4 normal = xformNoScale * vec4(a_normal, 0);\n    color = a_color * a_color1;\n#endif\n    uv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\n    pos = cc_matViewProj * pos;\n    return pos;\n}\nvoid main() { gl_Position = lpvs_main(); }\n",frag:"\nprecision highp float;\nuniform vec4 cc_exposure;\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n  return CCFragOutput(col);\n}\nvec4 multiply () {\n  vec4 col;\n  vec4 texColor = texture2D(mainTexture, uv);\n  col.rgb = tintColor.rgb * texColor.rgb * color.rgb * vec3(2.0);\n  col.a = (1.0 - texColor.a) * (tintColor.a * color.a * 2.0);\n  return CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_USE_BILLBOARD",type:"boolean",defines:[]},{name:"CC_USE_STRETCHED_BILLBOARD",type:"boolean",defines:[]},{name:"CC_USE_HORIZONTAL_BILLBOARD",type:"boolean",defines:[]},{name:"CC_USE_VERTICAL_BILLBOARD",type:"boolean",defines:[]},{name:"CC_USE_MESH",type:"boolean",defines:[]},{name:"CC_USE_WORLD_SPACE",type:"boolean",defines:[]},{name:"CC_USE_HDR",type:"boolean",defines:[]}],blocks:[{name:"Constants",defines:[],binding:0,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,members:[{name:"tintColor",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],binding:30}],dependencies:{}}]},{name:"builtin-sprite",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"builtin-sprite|sprite-vs:vert|sprite-fs:frag",priority:244,depthStencilState:{depthTest:!1,depthWrite:!1},properties:{mainTexture:{value:"white",type:28}}}]}],shaders:[{name:"builtin-sprite|sprite-vs:vert|sprite-fs:frag",hash:3858821905,glsl3:{vert:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\n#if USE_LOCAL\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  mat4 cc_matWorldIT;\n};\n#endif\nin vec3 a_position;\nin vec4 a_color;\nout vec4 color;\nin vec2 a_texCoord;\nout vec2 uv0;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  #if USE_LOCAL\n    pos = cc_matViewProj * cc_matWorld * pos;\n  #else\n    pos = cc_matViewProj * pos;\n  #endif\n  uv0 = a_texCoord;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nin vec4 color;\n#if USE_TEXTURE\n  in vec2 uv0;\n  uniform sampler2D mainTexture;\n#endif\nvec4 frag () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= texture(mainTexture, uv0);\n  #endif\n  o *= color;\n  return o;\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform mat4 cc_matViewProj;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 color;\nattribute vec2 a_texCoord;\nvarying vec2 uv0;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  #if USE_LOCAL\n    pos = cc_matViewProj * cc_matWorld * pos;\n  #else\n    pos = cc_matViewProj * pos;\n  #endif\n  uv0 = a_texCoord;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nvarying vec4 color;\n#if USE_TEXTURE\n  varying vec2 uv0;\n  uniform sampler2D mainTexture;\n#endif\nvec4 frag () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= texture2D(mainTexture, uv0);\n  #endif\n  o *= color;\n  return o;\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplers:[]}},defines:[{name:"USE_LOCAL",type:"boolean",defines:[]},{name:"USE_TEXTURE",type:"boolean",defines:[]}],blocks:[],samplers:[{name:"mainTexture",type:28,count:1,defines:["USE_TEXTURE"],binding:30}],dependencies:{}}]},{name:"builtin-standard",techniques:[{name:"opaque",passes:[{program:"builtin-standard|standard-vs:vert|standard-fs:frag",properties:{tilingOffset:{value:[1,1,0,0],type:16},albedo:{value:[1,1,1,1],inspector:{type:"color"},type:16},albedoScale:{value:[1,1,1,0],type:16},pbrParams:{value:[.8,.6,1,1],type:16},pbrScale:{value:[1,1,1,1],type:16},emissive:{value:[0,0,0,1],inspector:{type:"color"},type:16},emissiveScale:{value:[1,1,1,1],type:16},albedoMap:{value:"grey",type:28},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28}}}]}],shaders:[{name:"builtin-standard|standard-vs:vert|standard-fs:frag",hash:3404522821,glsl3:{vert:"\nprecision highp float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  mat4 cc_matWorldIT;\n};\nstruct StandardAttributes {\n  vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec4 a_tangent;\nvoid CCDecode (out StandardAttributes attr) {\n  attr.position = vec4(a_position, 1.0);\n  attr.normal = a_normal;\n  attr.tangent = a_tangent;\n}\n#if CC_USE_SKINNING\nin vec4 a_weights;\nin vec4 a_joints;\nuniform CCSkinningTexture {\n  highp vec4 cc_jointsTextureInfo;\n};\nuniform CCSkinningAnimation {\n  highp vec4 cc_jointsAnimInfo;\n};\nuniform sampler2D cc_jointsTexture;\n#if CC_USE_SKINNING == 1\n  highp float decode32(highp vec4 rgba) {\n    rgba = rgba * 255.0;\n    highp float Sign = 1.0 - step(128.0, rgba[3]) * 2.0;\n    highp float Exponent = 2.0 * mod(rgba[3], 128.0) + step(128.0, rgba[2]) - 127.0;\n    highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n    return Sign * exp2(Exponent - 23.0) * Mantissa;\n  }\n#endif\n#if CC_USE_SKINNING == 1\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 12.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = vec4(\n      decode32(texture(cc_jointsTexture, vec2((x + 0.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 1.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 2.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 3.5) * invSize, y)))\n    );\n    Qt = vec4(\n      decode32(texture(cc_jointsTexture, vec2((x + 4.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 5.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 6.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 7.5) * invSize, y)))\n    );\n    S = vec3(\n      decode32(texture(cc_jointsTexture, vec2((x + 8.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 9.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 10.5) * invSize, y)))\n    );\n  }\n#elif CC_USE_SKINNING == 2\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 3.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = texture(cc_jointsTexture, vec2((x + 0.5) * invSize, y));\n    Qt = texture(cc_jointsTexture, vec2((x + 1.5) * invSize, y));\n    S = texture(cc_jointsTexture, vec2((x + 2.5) * invSize, y)).xyz;\n  }\n#endif\nvoid skinRTS(out vec4 R, out vec3 T, out vec3 S) {\n  vec4 r, t, Qt = vec4(0.0); vec3 s;\n  R = vec4(0.0); S = vec3(0.0);\n  for (int i = 0; i < 4; i++) {\n    float w = a_weights[i];\n    getJointDQ(a_joints[i], r, t, s);\n    S += s * w; R += r * w; Qt += t * w;\n  }\n  float invNorm = 1.0 / length(R); R *= invNorm; Qt *= invNorm;\n  T = 2.0 * (R.w * Qt.xyz - Qt.w * R.xyz + cross(R.xyz, Qt.xyz));\n}\nvec3 VectorTransformQuat(vec3 v, vec4 Q) {\n\treturn v + 2.0 * cross(Q.xyz, cross(Q.xyz, v) + Q.w * v);\n}\nvoid CCSkin(inout vec4 position) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  position.xyz = VectorTransformQuat(position.xyz * S, R) + T;\n}\nvoid CCSkin(inout StandardAttributes attr) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  attr.position.xyz = VectorTransformQuat(attr.position.xyz * S, R) + T;\n  attr.normal = VectorTransformQuat(attr.normal, R);\n  attr.tangent.xyz = VectorTransformQuat(attr.tangent.xyz, R);\n}\n#endif\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nvoid CCAttrToInput (in StandardAttributes attr, out StandardVertInput In) {\n  In.position = attr.position;\n  In.normal = attr.normal;\n  In.tangent = attr.tangent;\n}\nvoid CCVertInput (out StandardVertInput In) {\n  StandardAttributes attr;\n  CCDecode(attr);\n  #if CC_USE_SKINNING\n    CCSkin(attr);\n  #endif\n  CCAttrToInput(attr, In);\n}\nuniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScale;\n  vec4 pbrParams;\n  vec4 pbrScale;\n  vec4 emissive;\n  vec4 emissiveScale;\n};\nout vec3 v_position;\nout vec3 v_normal;\n#if USE_NORMAL_MAP\n  out vec3 v_tangent;\n  out vec3 v_bitangent;\n#endif\n#if USE_ALBEDO_MAP || USE_NORMAL_MAP || USE_PBR_MAP || USE_EMISSIVE_MAP || USE_METALLIC_ROUGHNESS_MAP || USE_OCCLUSION_MAP\n  in vec2 a_texCoord;\n  out vec2 v_uv;\n#endif\nvec4 vert () {\n  StandardVertInput In;\n  CCVertInput(In);\n  vec4 pos = cc_matWorld * In.position;\n  v_position = pos.xyz;\n  v_normal = normalize((cc_matWorldIT * vec4(In.normal, 0.0)).xyz);\n  #if USE_NORMAL_MAP\n    v_tangent = normalize((cc_matWorldIT * vec4(In.tangent.xyz, 0.0)).xyz);\n    v_bitangent = cross(v_tangent, v_normal) * In.tangent.w;\n  #endif\n  #if USE_ALBEDO_MAP || USE_NORMAL_MAP || USE_PBR_MAP || USE_EMISSIVE_MAP || USE_METALLIC_ROUGHNESS_MAP || USE_OCCLUSION_MAP\n    v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  return cc_matViewProj * pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision highp float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\n#endif\n#define saturate(a) clamp( a, 0.0, 1.0 )\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nuniform CCForwardLight {\n  highp vec4 cc_sphereLitPos[2];\n  vec4 cc_sphereLitSizeRange[2];\n  vec4 cc_sphereLitColor[2];\n  highp vec4 cc_spotLitPos[2];\n  vec4 cc_spotLitSizeRangeAngle[2];\n  vec4 cc_spotLitDir[2];\n  vec4 cc_spotLitColor[2];\n};\nfloat SmoothDistAtt2(float distSqr, float invSqrAttRadius) {\n  float factor = distSqr * invSqrAttRadius;\n  float factor2 = factor * factor;\n  float factor3 = factor2 * factor2;\n  float smoothFactor = clamp(1.0 - factor3 * factor3, 0.0, 1.0);\n  return smoothFactor * smoothFactor;\n}\nfloat SmoothDistAtt(float distSqr, float invSqrAttRadius) {\n  float factor = distSqr * invSqrAttRadius;\n  float smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\n  return smoothFactor * smoothFactor;\n}\nfloat GetDistAtt(float distSqr, float invSqrAttRadius) {\n  float attenuation = 1.0 / max(distSqr, 0.01*0.01);\n  attenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\n  return attenuation;\n}\nfloat GetAngleAtt(vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\n  float cd = dot(litDir, L);\n  float attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\n  return (attenuation * attenuation);\n}\nfloat GGXMobile(float roughness, float NoH, vec3 H, vec3 N) {\n  vec3 NxH = cross(N, H);\n  float OneMinusNoHSqr = dot(NxH, NxH);\n  float a = roughness * roughness;\n  float n = NoH * a;\n  float p = a / (OneMinusNoHSqr + n * n);\n  return p * p;\n}\nfloat CalcSpecular(float roughness, float NoH, vec3 H, vec3 N) {\n  return (roughness*0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox(vec3 specular, float roughness, float NoV) {\n  const vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\n  const vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\n  vec4 r = roughness * c0 + c1;\n  float a004 = min( r.x * r.x, exp2( -9.28 * NoV ) ) * r.x + r.y;\n  vec2 AB = vec2( -1.04, 1.04 ) * a004 + r.zw;\n  AB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\n  return specular * AB.x + AB.y;\n}\nvec3 CalcDynamicLighting(vec3 worldPos, vec3 N, vec3 V, vec3 diffuse, vec3 specular, float roughness) {\n  vec3 lighting = vec3(0.0);\n  vec3 diffuseContrib = diffuse / 3.14159265359;\n  for (int i = 0; i < 2; i++) {\n    vec3 PLU = cc_sphereLitPos[i].xyz - worldPos;\n    vec3 PL = normalize(PLU);\n    vec3 PH = normalize(PL + V);\n    float PNL = max(dot(N, PL), 0.001);\n    float PNH = max(dot(N, PH), 0.0);\n    float distSqr = dot(PLU, PLU);\n    float litRadius = cc_sphereLitSizeRange[i].x;\n    float litRadiusSqr = litRadius * litRadius;\n    float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n    float attRadiusSqrInv = 1.0 / max(cc_sphereLitSizeRange[i].y, 0.01);\n    attRadiusSqrInv *= attRadiusSqrInv;\n    float att = GetDistAtt(distSqr, attRadiusSqrInv);\n    vec3 lspec = specular * CalcSpecular(roughness, PNH, PH, N);\n    lighting += PNL * cc_sphereLitColor[i].rgb * cc_sphereLitColor[i].w * illum * att * (diffuseContrib + lspec);\n  }\n  for (int i = 0; i < 2; i++) {\n    vec3 SLU = cc_spotLitPos[i].xyz - worldPos;\n    vec3 SL = normalize(SLU);\n    vec3 SH = normalize(SL + V);\n    float SNL = max(dot(N, SL), 0.001);\n    float SNH = max(dot(N, SH), 0.0);\n    float distSqr = dot(SLU, SLU);\n    float litRadius = cc_spotLitSizeRangeAngle[i].x;\n    float litRadiusSqr = litRadius * litRadius;\n    float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n    float attRadiusSqrInv = 1.0 / max(cc_spotLitSizeRangeAngle[i].y, 0.01);\n    attRadiusSqrInv *= attRadiusSqrInv;\n    float cosInner = max(dot(-cc_spotLitDir[i].xyz, SL), 0.01);\n    float cosOuter = cc_spotLitSizeRangeAngle[i].z;\n    float litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\n    float litAngleOffset = -cosOuter * litAngleScale;\n    float att = GetDistAtt(distSqr, attRadiusSqrInv);\n    att *= GetAngleAtt(SL, -cc_spotLitDir[i].xyz, litAngleScale, litAngleOffset);\n    vec3 lspec = specular * CalcSpecular(roughness, SNH, SH, N);\n    lighting += SNL * cc_spotLitColor[i].rgb * cc_spotLitColor[i].w * illum * att * (diffuseContrib + lspec);\n  }\n  return lighting;\n}\nstruct StandardSurface {\n  vec4 albedo;\n  vec3 position;\n  vec3 normal;\n  vec3 emissive;\n  float roughness;\n  float metallic;\n  float occlusion;\n};\nvec4 CCStandardShading (StandardSurface s) {\n  vec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\n  vec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\n  vec3 N = normalize(s.normal);\n  vec3 V = normalize(cc_cameraPos.xyz - s.position);\n  vec3 L = normalize(-cc_mainLitDir.xyz);\n  vec3 H = normalize(L+V);\n  float NV = max(abs(dot(N, V)), 0.001);\n  float NL = max(dot(N, L), 0.001);\n  float NH = max(dot(N, H), 0.0);\n  specular = BRDFApprox(specular, s.roughness, NV);\n  vec3 diffuseContrib = diffuse / 3.14159265359;\n  vec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\n  vec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w * (diffuseContrib + specularContrib);\n  finalColor += CalcDynamicLighting(s.position, N, V, diffuse, specular, s.roughness);\n  float fAmb = 0.5 - N.y * 0.5;\n  vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n  finalColor += (ambDiff.rgb * diffuse);\n  #if CC_USE_IBL\n    vec3 R = normalize(reflect(-V, N));\n    vec3 env = SRGBToLinear(texture(cc_environment, R).rgb) * cc_ambientSky.w;\n    finalColor += env * specular;\n  #endif\n  finalColor = finalColor * s.occlusion;\n  #if CC_USE_HDR\n    s.emissive *= cc_exposure.w;\n  #endif\n  finalColor += s.emissive;\n  return vec4(finalColor, s.albedo.a);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = LinearToSRGB(color.rgb);\n  #endif\n  return color;\n}\nuniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScale;\n  vec4 pbrParams;\n  vec4 pbrScale;\n  vec4 emissive;\n  vec4 emissiveScale;\n};\nin vec3 v_position;\n#if USE_ALBEDO_MAP || USE_NORMAL_MAP || USE_PBR_MAP || USE_EMISSIVE_MAP || USE_METALLIC_ROUGHNESS_MAP || USE_OCCLUSION_MAP\n  in vec2 v_uv;\n#endif\nin vec3 v_normal;\n#if USE_NORMAL_MAP\n  in vec3 v_tangent;\n  in vec3 v_bitangent;\n#endif\n#if USE_ALBEDO_MAP\n  uniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\n  uniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\n  uniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\n  uniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\n  uniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\n  uniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\n  vec4 baseColor = albedo;\n  #if USE_ALBEDO_MAP\n    vec4 texColor = texture(albedoMap, v_uv);\n    texColor.rgb = SRGBToLinear(texColor.rgb);\n    baseColor *= texColor;\n  #endif\n  s.albedo = baseColor;\n  s.albedo.rgb *= albedoScale.xyz;\n  #if USE_ALPHA_TEST\n    if (s.albedo.ALPHA_TEST_CHANNEL < albedoScale.w) discard;\n  #endif\n  s.normal = v_normal;\n  #if USE_NORMAL_MAP\n    vec3 nmmp = texture(normalMap, v_uv).xyz - vec3(0.5);\n    s.normal =\n      (nmmp.x * pbrScale.w) * normalize(v_tangent) +\n      (nmmp.y * pbrScale.w) * normalize(v_bitangent) +\n      nmmp.z * normalize(s.normal);\n  #endif\n  s.position = v_position;\n  vec4 pbr = pbrParams;\n  #if USE_PBR_MAP\n    pbr = texture(pbrMap, v_uv);\n  #endif\n  #if USE_METALLIC_ROUGHNESS_MAP\n    vec4 metallicRoughness = texture(metallicRoughnessMap, v_uv);\n    pbr.METALLIC_CHANNEL = metallicRoughness.METALLIC_CHANNEL;\n    pbr.ROUGHNESS_CHANNEL = metallicRoughness.ROUGHNESS_CHANNEL;\n  #endif\n  #if USE_OCCLUSION_MAP\n    pbr.OCCLUSION_CHANNEL = texture(occlusionMap, v_uv).OCCLUSION_CHANNEL;\n  #endif\n  pbr *= pbrScale;\n  s.roughness = clamp(pbr.ROUGHNESS_CHANNEL, 0.04, 1.0);\n  s.metallic = clamp(pbr.METALLIC_CHANNEL, 0.0, 0.96);\n  s.occlusion = pbr.OCCLUSION_CHANNEL;\n  s.emissive = emissive.rgb * emissiveScale.xyz;\n  #if USE_EMISSIVE_MAP\n    s.emissive *= SRGBToLinear(texture(emissiveMap, v_uv).rgb);\n  #endif\n}\nvec4 frag () {\n  StandardSurface s; surf(s);\n  vec4 color = CCStandardShading(s);\n  return CCFragOutput(color);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision highp float;\nuniform mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nuniform mat4 cc_matWorldIT;\nstruct StandardAttributes {\n  vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec4 a_tangent;\nvoid CCDecode (out StandardAttributes attr) {\n  attr.position = vec4(a_position, 1.0);\n  attr.normal = a_normal;\n  attr.tangent = a_tangent;\n}\n#if CC_USE_SKINNING\nattribute vec4 a_weights;\nattribute vec4 a_joints;\nuniform highp vec4 cc_jointsTextureInfo;\nuniform highp vec4 cc_jointsAnimInfo;\nuniform sampler2D cc_jointsTexture;\n#if CC_USE_SKINNING == 1\n  highp float decode32(highp vec4 rgba) {\n    rgba = rgba * 255.0;\n    highp float Sign = 1.0 - step(128.0, rgba[3]) * 2.0;\n    highp float Exponent = 2.0 * mod(rgba[3], 128.0) + step(128.0, rgba[2]) - 127.0;\n    highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n    return Sign * exp2(Exponent - 23.0) * Mantissa;\n  }\n#endif\n#if CC_USE_SKINNING == 1\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 12.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = vec4(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 0.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 1.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 2.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 3.5) * invSize, y)))\n    );\n    Qt = vec4(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 4.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 5.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 6.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 7.5) * invSize, y)))\n    );\n    S = vec3(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 8.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 9.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 10.5) * invSize, y)))\n    );\n  }\n#elif CC_USE_SKINNING == 2\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 3.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = texture2D(cc_jointsTexture, vec2((x + 0.5) * invSize, y));\n    Qt = texture2D(cc_jointsTexture, vec2((x + 1.5) * invSize, y));\n    S = texture2D(cc_jointsTexture, vec2((x + 2.5) * invSize, y)).xyz;\n  }\n#endif\nvoid skinRTS(out vec4 R, out vec3 T, out vec3 S) {\n  vec4 r, t, Qt = vec4(0.0); vec3 s;\n  R = vec4(0.0); S = vec3(0.0);\n  for (int i = 0; i < 4; i++) {\n    float w = a_weights[i];\n    getJointDQ(a_joints[i], r, t, s);\n    S += s * w; R += r * w; Qt += t * w;\n  }\n  float invNorm = 1.0 / length(R); R *= invNorm; Qt *= invNorm;\n  T = 2.0 * (R.w * Qt.xyz - Qt.w * R.xyz + cross(R.xyz, Qt.xyz));\n}\nvec3 VectorTransformQuat(vec3 v, vec4 Q) {\n\treturn v + 2.0 * cross(Q.xyz, cross(Q.xyz, v) + Q.w * v);\n}\nvoid CCSkin(inout vec4 position) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  position.xyz = VectorTransformQuat(position.xyz * S, R) + T;\n}\nvoid CCSkin(inout StandardAttributes attr) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  attr.position.xyz = VectorTransformQuat(attr.position.xyz * S, R) + T;\n  attr.normal = VectorTransformQuat(attr.normal, R);\n  attr.tangent.xyz = VectorTransformQuat(attr.tangent.xyz, R);\n}\n#endif\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nvoid CCAttrToInput (in StandardAttributes attr, out StandardVertInput In) {\n  In.position = attr.position;\n  In.normal = attr.normal;\n  In.tangent = attr.tangent;\n}\nvoid CCVertInput (out StandardVertInput In) {\n  StandardAttributes attr;\n  CCDecode(attr);\n  #if CC_USE_SKINNING\n    CCSkin(attr);\n  #endif\n  CCAttrToInput(attr, In);\n}\nuniform vec4 tilingOffset;\nvarying vec3 v_position;\nvarying vec3 v_normal;\n#if USE_NORMAL_MAP\n  varying vec3 v_tangent;\n  varying vec3 v_bitangent;\n#endif\n#if USE_ALBEDO_MAP || USE_NORMAL_MAP || USE_PBR_MAP || USE_EMISSIVE_MAP || USE_METALLIC_ROUGHNESS_MAP || USE_OCCLUSION_MAP\n  attribute vec2 a_texCoord;\n  varying vec2 v_uv;\n#endif\nvec4 vert () {\n  StandardVertInput In;\n  CCVertInput(In);\n  vec4 pos = cc_matWorld * In.position;\n  v_position = pos.xyz;\n  v_normal = normalize((cc_matWorldIT * vec4(In.normal, 0.0)).xyz);\n  #if USE_NORMAL_MAP\n    v_tangent = normalize((cc_matWorldIT * vec4(In.tangent.xyz, 0.0)).xyz);\n    v_bitangent = cross(v_tangent, v_normal) * In.tangent.w;\n  #endif\n  #if USE_ALBEDO_MAP || USE_NORMAL_MAP || USE_PBR_MAP || USE_EMISSIVE_MAP || USE_METALLIC_ROUGHNESS_MAP || USE_OCCLUSION_MAP\n    v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  return cc_matViewProj * pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision highp float;\nuniform vec4 cc_cameraPos;\nuniform vec4 cc_exposure;\nuniform vec4 cc_mainLitDir;\nuniform vec4 cc_mainLitColor;\nuniform vec4 cc_ambientSky;\nuniform vec4 cc_ambientGround;\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\n#endif\n#define saturate(a) clamp( a, 0.0, 1.0 )\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nuniform highp vec4 cc_sphereLitPos[2];\nuniform vec4 cc_sphereLitSizeRange[2];\nuniform vec4 cc_sphereLitColor[2];\nuniform highp vec4 cc_spotLitPos[2];\nuniform vec4 cc_spotLitSizeRangeAngle[2];\nuniform vec4 cc_spotLitDir[2];\nuniform vec4 cc_spotLitColor[2];\nfloat SmoothDistAtt2(float distSqr, float invSqrAttRadius) {\n  float factor = distSqr * invSqrAttRadius;\n  float factor2 = factor * factor;\n  float factor3 = factor2 * factor2;\n  float smoothFactor = clamp(1.0 - factor3 * factor3, 0.0, 1.0);\n  return smoothFactor * smoothFactor;\n}\nfloat SmoothDistAtt(float distSqr, float invSqrAttRadius) {\n  float factor = distSqr * invSqrAttRadius;\n  float smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\n  return smoothFactor * smoothFactor;\n}\nfloat GetDistAtt(float distSqr, float invSqrAttRadius) {\n  float attenuation = 1.0 / max(distSqr, 0.01*0.01);\n  attenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\n  return attenuation;\n}\nfloat GetAngleAtt(vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\n  float cd = dot(litDir, L);\n  float attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\n  return (attenuation * attenuation);\n}\nfloat GGXMobile(float roughness, float NoH, vec3 H, vec3 N) {\n  vec3 NxH = cross(N, H);\n  float OneMinusNoHSqr = dot(NxH, NxH);\n  float a = roughness * roughness;\n  float n = NoH * a;\n  float p = a / (OneMinusNoHSqr + n * n);\n  return p * p;\n}\nfloat CalcSpecular(float roughness, float NoH, vec3 H, vec3 N) {\n  return (roughness*0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox(vec3 specular, float roughness, float NoV) {\n  const vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\n  const vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\n  vec4 r = roughness * c0 + c1;\n  float a004 = min( r.x * r.x, exp2( -9.28 * NoV ) ) * r.x + r.y;\n  vec2 AB = vec2( -1.04, 1.04 ) * a004 + r.zw;\n  AB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\n  return specular * AB.x + AB.y;\n}\nvec3 CalcDynamicLighting(vec3 worldPos, vec3 N, vec3 V, vec3 diffuse, vec3 specular, float roughness) {\n  vec3 lighting = vec3(0.0);\n  vec3 diffuseContrib = diffuse / 3.14159265359;\n  for (int i = 0; i < 2; i++) {\n    vec3 PLU = cc_sphereLitPos[i].xyz - worldPos;\n    vec3 PL = normalize(PLU);\n    vec3 PH = normalize(PL + V);\n    float PNL = max(dot(N, PL), 0.001);\n    float PNH = max(dot(N, PH), 0.0);\n    float distSqr = dot(PLU, PLU);\n    float litRadius = cc_sphereLitSizeRange[i].x;\n    float litRadiusSqr = litRadius * litRadius;\n    float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n    float attRadiusSqrInv = 1.0 / max(cc_sphereLitSizeRange[i].y, 0.01);\n    attRadiusSqrInv *= attRadiusSqrInv;\n    float att = GetDistAtt(distSqr, attRadiusSqrInv);\n    vec3 lspec = specular * CalcSpecular(roughness, PNH, PH, N);\n    lighting += PNL * cc_sphereLitColor[i].rgb * cc_sphereLitColor[i].w * illum * att * (diffuseContrib + lspec);\n  }\n  for (int i = 0; i < 2; i++) {\n    vec3 SLU = cc_spotLitPos[i].xyz - worldPos;\n    vec3 SL = normalize(SLU);\n    vec3 SH = normalize(SL + V);\n    float SNL = max(dot(N, SL), 0.001);\n    float SNH = max(dot(N, SH), 0.0);\n    float distSqr = dot(SLU, SLU);\n    float litRadius = cc_spotLitSizeRangeAngle[i].x;\n    float litRadiusSqr = litRadius * litRadius;\n    float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n    float attRadiusSqrInv = 1.0 / max(cc_spotLitSizeRangeAngle[i].y, 0.01);\n    attRadiusSqrInv *= attRadiusSqrInv;\n    float cosInner = max(dot(-cc_spotLitDir[i].xyz, SL), 0.01);\n    float cosOuter = cc_spotLitSizeRangeAngle[i].z;\n    float litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\n    float litAngleOffset = -cosOuter * litAngleScale;\n    float att = GetDistAtt(distSqr, attRadiusSqrInv);\n    att *= GetAngleAtt(SL, -cc_spotLitDir[i].xyz, litAngleScale, litAngleOffset);\n    vec3 lspec = specular * CalcSpecular(roughness, SNH, SH, N);\n    lighting += SNL * cc_spotLitColor[i].rgb * cc_spotLitColor[i].w * illum * att * (diffuseContrib + lspec);\n  }\n  return lighting;\n}\nstruct StandardSurface {\n  vec4 albedo;\n  vec3 position;\n  vec3 normal;\n  vec3 emissive;\n  float roughness;\n  float metallic;\n  float occlusion;\n};\nvec4 CCStandardShading (StandardSurface s) {\n  vec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\n  vec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\n  vec3 N = normalize(s.normal);\n  vec3 V = normalize(cc_cameraPos.xyz - s.position);\n  vec3 L = normalize(-cc_mainLitDir.xyz);\n  vec3 H = normalize(L+V);\n  float NV = max(abs(dot(N, V)), 0.001);\n  float NL = max(dot(N, L), 0.001);\n  float NH = max(dot(N, H), 0.0);\n  specular = BRDFApprox(specular, s.roughness, NV);\n  vec3 diffuseContrib = diffuse / 3.14159265359;\n  vec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\n  vec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w * (diffuseContrib + specularContrib);\n  finalColor += CalcDynamicLighting(s.position, N, V, diffuse, specular, s.roughness);\n  float fAmb = 0.5 - N.y * 0.5;\n  vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n  finalColor += (ambDiff.rgb * diffuse);\n  #if CC_USE_IBL\n    vec3 R = normalize(reflect(-V, N));\n    vec3 env = SRGBToLinear(textureCube(cc_environment, R).rgb) * cc_ambientSky.w;\n    finalColor += env * specular;\n  #endif\n  finalColor = finalColor * s.occlusion;\n  #if CC_USE_HDR\n    s.emissive *= cc_exposure.w;\n  #endif\n  finalColor += s.emissive;\n  return vec4(finalColor, s.albedo.a);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = LinearToSRGB(color.rgb);\n  #endif\n  return color;\n}\nuniform vec4 albedo;\nuniform vec4 albedoScale;\nuniform vec4 pbrParams;\nuniform vec4 pbrScale;\nuniform vec4 emissive;\nuniform vec4 emissiveScale;\nvarying vec3 v_position;\n#if USE_ALBEDO_MAP || USE_NORMAL_MAP || USE_PBR_MAP || USE_EMISSIVE_MAP || USE_METALLIC_ROUGHNESS_MAP || USE_OCCLUSION_MAP\n  varying vec2 v_uv;\n#endif\nvarying vec3 v_normal;\n#if USE_NORMAL_MAP\n  varying vec3 v_tangent;\n  varying vec3 v_bitangent;\n#endif\n#if USE_ALBEDO_MAP\n  uniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\n  uniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\n  uniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\n  uniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\n  uniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\n  uniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\n  vec4 baseColor = albedo;\n  #if USE_ALBEDO_MAP\n    vec4 texColor = texture2D(albedoMap, v_uv);\n    texColor.rgb = SRGBToLinear(texColor.rgb);\n    baseColor *= texColor;\n  #endif\n  s.albedo = baseColor;\n  s.albedo.rgb *= albedoScale.xyz;\n  #if USE_ALPHA_TEST\n    if (s.albedo.ALPHA_TEST_CHANNEL < albedoScale.w) discard;\n  #endif\n  s.normal = v_normal;\n  #if USE_NORMAL_MAP\n    vec3 nmmp = texture2D(normalMap, v_uv).xyz - vec3(0.5);\n    s.normal =\n      (nmmp.x * pbrScale.w) * normalize(v_tangent) +\n      (nmmp.y * pbrScale.w) * normalize(v_bitangent) +\n      nmmp.z * normalize(s.normal);\n  #endif\n  s.position = v_position;\n  vec4 pbr = pbrParams;\n  #if USE_PBR_MAP\n    pbr = texture2D(pbrMap, v_uv);\n  #endif\n  #if USE_METALLIC_ROUGHNESS_MAP\n    vec4 metallicRoughness = texture2D(metallicRoughnessMap, v_uv);\n    pbr.METALLIC_CHANNEL = metallicRoughness.METALLIC_CHANNEL;\n    pbr.ROUGHNESS_CHANNEL = metallicRoughness.ROUGHNESS_CHANNEL;\n  #endif\n  #if USE_OCCLUSION_MAP\n    pbr.OCCLUSION_CHANNEL = texture2D(occlusionMap, v_uv).OCCLUSION_CHANNEL;\n  #endif\n  pbr *= pbrScale;\n  s.roughness = clamp(pbr.ROUGHNESS_CHANNEL, 0.04, 1.0);\n  s.metallic = clamp(pbr.METALLIC_CHANNEL, 0.0, 0.96);\n  s.occlusion = pbr.OCCLUSION_CHANNEL;\n  s.emissive = emissive.rgb * emissiveScale.xyz;\n  #if USE_EMISSIVE_MAP\n    s.emissive *= SRGBToLinear(texture2D(emissiveMap, v_uv).rgb);\n  #endif\n}\nvec4 frag () {\n  StandardSurface s; surf(s);\n  vec4 color = CCStandardShading(s);\n  return CCFragOutput(color);\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[{name:"cc_environment",defines:["CC_USE_IBL"]}]},locals:{blocks:[{name:"CCLocal",defines:[]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING"]},{name:"CCForwardLight",defines:[]}],samplers:[{name:"cc_jointsTexture",defines:["CC_USE_SKINNING"]}]}},defines:[{name:"CC_USE_SKINNING",type:"number",defines:[],range:[0,2]},{name:"USE_NORMAL_MAP",type:"boolean",defines:[]},{name:"USE_ALBEDO_MAP",type:"boolean",defines:[]},{name:"CC_USE_IBL",type:"boolean",defines:[]},{name:"CC_USE_HDR",type:"boolean",defines:[]},{name:"USE_PBR_MAP",type:"boolean",defines:[]},{name:"USE_METALLIC_ROUGHNESS_MAP",type:"boolean",defines:[]},{name:"USE_OCCLUSION_MAP",type:"boolean",defines:[]},{name:"USE_EMISSIVE_MAP",type:"boolean",defines:[]},{name:"ROUGHNESS_CHANNEL",type:"string",defines:[],options:["r","g","b"]},{name:"METALLIC_CHANNEL",type:"string",defines:[],options:["g","r","b"]},{name:"OCCLUSION_CHANNEL",type:"string",defines:[],options:["b","r","g"]},{name:"USE_ALPHA_TEST",type:"boolean",defines:[]},{name:"ALPHA_TEST_CHANNEL",type:"string",defines:["USE_ALPHA_TEST"],options:["a","r","g","b"]}],blocks:[{name:"Constants",defines:[],binding:0,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScale",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"pbrScale",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScale",type:16,count:1}]}],samplers:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],binding:30},{name:"normalMap",type:28,count:1,defines:["USE_NORMAL_MAP"],binding:31},{name:"pbrMap",type:28,count:1,defines:["USE_PBR_MAP"],binding:32},{name:"metallicRoughnessMap",type:28,count:1,defines:["USE_METALLIC_ROUGHNESS_MAP"],binding:33},{name:"occlusionMap",type:28,count:1,defines:["USE_OCCLUSION_MAP"],binding:34},{name:"emissiveMap",type:28,count:1,defines:["USE_EMISSIVE_MAP"],binding:35}],dependencies:{}}]},{name:"builtin-terrain",techniques:[{name:"opaque",passes:[{program:"builtin-terrain|terrain-vs:vert|terrain-fs:frag",properties:{UVScale:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28}}}]}],shaders:[{name:"builtin-terrain|terrain-vs:vert|terrain-fs:frag",hash:3405213441,glsl3:{vert:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  mat4 cc_matWorldIT;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout vec2 uvw;\nout vec2 uv0;\nout vec2 uv1;\nout vec2 uv2;\nout vec2 uv3;\nout vec3 diffuse;\nuniform TexCoords {\n  vec4 UVScale;\n};\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matWorld * pos;\n  pos = cc_matViewProj * pos;\n  uvw = a_texCoord;\n  uv0 = a_position.xz * UVScale.x;\n  uv1 = a_position.xz * UVScale.y;\n  uv2 = a_position.xz * UVScale.z;\n  uv3 = a_position.xz * UVScale.w;\n  vec3 L = normalize(-cc_mainLitDir.xyz);\n  vec3 N = a_normal;\n  float fAmb = dot(N, vec3(0.0, -1.0, 0.0)) * 0.5 + 0.5;\n  vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n  diffuse = ambDiff + vec3(dot(N, L));\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\n  in vec2 uvw;\n  in vec2 uv0;\n  in vec2 uv1;\n  in vec2 uv2;\n  in vec2 uv3;\n  in vec3 diffuse;\n  uniform sampler2D weightMap;\n  uniform sampler2D detailMap0;\n  uniform sampler2D detailMap1;\n  uniform sampler2D detailMap2;\n  uniform sampler2D detailMap3;\nvec4 frag () {\n  vec4 color = vec4(0, 0, 0, 0);\n  #if LAYERS == 1\n    color = texture(detailMap0, uv0);\n  #elif LAYERS == 2\n    vec4 w = texture(weightMap, uvw);\n    color += texture(detailMap0, uv0) * w.r;\n    color += texture(detailMap1, uv1) * w.g;\n  #elif LAYERS == 3\n    vec4 w = texture(weightMap, uvw);\n    color += texture(detailMap0, uv0) * w.r;\n    color += texture(detailMap1, uv1) * w.g;\n    color += texture(detailMap2, uv2) * w.b;\n  #elif LAYERS == 4\n    vec4 w = texture(weightMap, uvw);\n    color += texture(detailMap0, uv0) * w.r;\n    color += texture(detailMap1, uv1) * w.g;\n    color += texture(detailMap2, uv2) * w.b;\n    color += texture(detailMap3, uv3) * w.a;\n  #else\n    color = texture(detailMap0, uv0);\n  #endif\n  color.rgb *= diffuse;\n  return CCFragOutput(color);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform mat4 cc_matViewProj;\nuniform vec4 cc_mainLitDir;\nuniform vec4 cc_ambientSky;\nuniform vec4 cc_ambientGround;\nuniform highp mat4 cc_matWorld;\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying vec2 uvw;\nvarying vec2 uv0;\nvarying vec2 uv1;\nvarying vec2 uv2;\nvarying vec2 uv3;\nvarying vec3 diffuse;\nuniform vec4 UVScale;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matWorld * pos;\n  pos = cc_matViewProj * pos;\n  uvw = a_texCoord;\n  uv0 = a_position.xz * UVScale.x;\n  uv1 = a_position.xz * UVScale.y;\n  uv2 = a_position.xz * UVScale.z;\n  uv3 = a_position.xz * UVScale.w;\n  vec3 L = normalize(-cc_mainLitDir.xyz);\n  vec3 N = a_normal;\n  float fAmb = dot(N, vec3(0.0, -1.0, 0.0)) * 0.5 + 0.5;\n  vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n  diffuse = ambDiff + vec3(dot(N, L));\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform vec4 cc_exposure;\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\n  varying vec2 uvw;\n  varying vec2 uv0;\n  varying vec2 uv1;\n  varying vec2 uv2;\n  varying vec2 uv3;\n  varying vec3 diffuse;\n  uniform sampler2D weightMap;\n  uniform sampler2D detailMap0;\n  uniform sampler2D detailMap1;\n  uniform sampler2D detailMap2;\n  uniform sampler2D detailMap3;\nvec4 frag () {\n  vec4 color = vec4(0, 0, 0, 0);\n  #if LAYERS == 1\n    color = texture2D(detailMap0, uv0);\n  #elif LAYERS == 2\n    vec4 w = texture2D(weightMap, uvw);\n    color += texture2D(detailMap0, uv0) * w.r;\n    color += texture2D(detailMap1, uv1) * w.g;\n  #elif LAYERS == 3\n    vec4 w = texture2D(weightMap, uvw);\n    color += texture2D(detailMap0, uv0) * w.r;\n    color += texture2D(detailMap1, uv1) * w.g;\n    color += texture2D(detailMap2, uv2) * w.b;\n  #elif LAYERS == 4\n    vec4 w = texture2D(weightMap, uvw);\n    color += texture2D(detailMap0, uv0) * w.r;\n    color += texture2D(detailMap1, uv1) * w.g;\n    color += texture2D(detailMap2, uv2) * w.b;\n    color += texture2D(detailMap3, uv3) * w.a;\n  #else\n    color = texture2D(detailMap0, uv0);\n  #endif\n  color.rgb *= diffuse;\n  return CCFragOutput(color);\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_USE_HDR",type:"boolean",defines:[]},{name:"LAYERS",type:"number",defines:[],range:[0,3]}],blocks:[{name:"TexCoords",defines:[],binding:0,members:[{name:"UVScale",type:16,count:1}]}],samplers:[{name:"weightMap",type:28,count:1,defines:[],binding:30},{name:"detailMap0",type:28,count:1,defines:[],binding:31},{name:"detailMap1",type:28,count:1,defines:[],binding:32},{name:"detailMap2",type:28,count:1,defines:[],binding:33},{name:"detailMap3",type:28,count:1,defines:[],binding:34}],dependencies:{}}]},{name:"builtin-unlit",techniques:[{name:"opaque",passes:[{program:"builtin-unlit|unlit-vs:vert|unlit-fs:frag",properties:{color:{value:[1,1,1,1],inspector:{type:"color"},type:16},tilingOffset:{value:[1,1,0,0],type:16},mainTexture:{value:"grey",type:28}}}]}],shaders:[{name:"builtin-unlit|unlit-vs:vert|unlit-fs:frag",hash:6340035,glsl3:{vert:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  mat4 cc_matWorldIT;\n};\nin vec3 a_position;\nvoid CCDecode (out vec4 position) {\n  position = vec4(a_position, 1.0);\n}\n#if CC_USE_SKINNING\nstruct StandardAttributes {\n  vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nin vec4 a_weights;\nin vec4 a_joints;\nuniform CCSkinningTexture {\n  highp vec4 cc_jointsTextureInfo;\n};\nuniform CCSkinningAnimation {\n  highp vec4 cc_jointsAnimInfo;\n};\nuniform sampler2D cc_jointsTexture;\n#if CC_USE_SKINNING == 1\n  highp float decode32(highp vec4 rgba) {\n    rgba = rgba * 255.0;\n    highp float Sign = 1.0 - step(128.0, rgba[3]) * 2.0;\n    highp float Exponent = 2.0 * mod(rgba[3], 128.0) + step(128.0, rgba[2]) - 127.0;\n    highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n    return Sign * exp2(Exponent - 23.0) * Mantissa;\n  }\n#endif\n#if CC_USE_SKINNING == 1\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 12.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = vec4(\n      decode32(texture(cc_jointsTexture, vec2((x + 0.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 1.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 2.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 3.5) * invSize, y)))\n    );\n    Qt = vec4(\n      decode32(texture(cc_jointsTexture, vec2((x + 4.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 5.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 6.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 7.5) * invSize, y)))\n    );\n    S = vec3(\n      decode32(texture(cc_jointsTexture, vec2((x + 8.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 9.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 10.5) * invSize, y)))\n    );\n  }\n#elif CC_USE_SKINNING == 2\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 3.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = texture(cc_jointsTexture, vec2((x + 0.5) * invSize, y));\n    Qt = texture(cc_jointsTexture, vec2((x + 1.5) * invSize, y));\n    S = texture(cc_jointsTexture, vec2((x + 2.5) * invSize, y)).xyz;\n  }\n#endif\nvoid skinRTS(out vec4 R, out vec3 T, out vec3 S) {\n  vec4 r, t, Qt = vec4(0.0); vec3 s;\n  R = vec4(0.0); S = vec3(0.0);\n  for (int i = 0; i < 4; i++) {\n    float w = a_weights[i];\n    getJointDQ(a_joints[i], r, t, s);\n    S += s * w; R += r * w; Qt += t * w;\n  }\n  float invNorm = 1.0 / length(R); R *= invNorm; Qt *= invNorm;\n  T = 2.0 * (R.w * Qt.xyz - Qt.w * R.xyz + cross(R.xyz, Qt.xyz));\n}\nvec3 VectorTransformQuat(vec3 v, vec4 Q) {\n\treturn v + 2.0 * cross(Q.xyz, cross(Q.xyz, v) + Q.w * v);\n}\nvoid CCSkin(inout vec4 position) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  position.xyz = VectorTransformQuat(position.xyz * S, R) + T;\n}\nvoid CCSkin(inout StandardAttributes attr) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  attr.position.xyz = VectorTransformQuat(attr.position.xyz * S, R) + T;\n  attr.normal = VectorTransformQuat(attr.normal, R);\n  attr.tangent.xyz = VectorTransformQuat(attr.tangent.xyz, R);\n}\n#endif\nvoid CCVertInput (out highp vec4 position) {\n  CCDecode(position);\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n}\n#if USE_VERTEX_COLOR\n  in vec4 a_color;\n  out vec4 v_color;\n#endif\n#if USE_TEXTURE\n  in vec2 a_texCoord;\n  out vec2 v_uv;\n  uniform TexCoords {\n    vec4 tilingOffset;\n  };\n#endif\nhighp vec4 vert () {\n  vec4 position;\n  CCVertInput(position);\n  highp vec4 pos = cc_matViewProj * cc_matWorld * position;\n  #if USE_TEXTURE\n    v_uv = a_texCoord;\n  #if FLIP_UV\n    v_uv.y = 1.0 - v_uv.y;\n  #endif\n    v_uv = v_uv * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\n#if USE_TEXTURE\n  in vec2 v_uv;\n  uniform sampler2D mainTexture;\n#endif\n#if USE_COLOR\n  uniform Constant {\n    vec4 color;\n  };\n#endif\n#if USE_VERTEX_COLOR\n  in vec4 v_color;\n#endif\nvec4 frag () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= texture(mainTexture, v_uv);\n  #endif\n  #if USE_COLOR\n    o *= color;\n  #endif\n  #if USE_VERTEX_COLOR\n    o *= v_color;\n  #endif\n  return CCFragOutput(o);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nattribute vec3 a_position;\nvoid CCDecode (out vec4 position) {\n  position = vec4(a_position, 1.0);\n}\n#if CC_USE_SKINNING\nstruct StandardAttributes {\n  vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nattribute vec4 a_weights;\nattribute vec4 a_joints;\nuniform highp vec4 cc_jointsTextureInfo;\nuniform highp vec4 cc_jointsAnimInfo;\nuniform sampler2D cc_jointsTexture;\n#if CC_USE_SKINNING == 1\n  highp float decode32(highp vec4 rgba) {\n    rgba = rgba * 255.0;\n    highp float Sign = 1.0 - step(128.0, rgba[3]) * 2.0;\n    highp float Exponent = 2.0 * mod(rgba[3], 128.0) + step(128.0, rgba[2]) - 127.0;\n    highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n    return Sign * exp2(Exponent - 23.0) * Mantissa;\n  }\n#endif\n#if CC_USE_SKINNING == 1\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 12.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = vec4(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 0.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 1.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 2.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 3.5) * invSize, y)))\n    );\n    Qt = vec4(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 4.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 5.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 6.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 7.5) * invSize, y)))\n    );\n    S = vec3(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 8.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 9.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 10.5) * invSize, y)))\n    );\n  }\n#elif CC_USE_SKINNING == 2\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 3.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = texture2D(cc_jointsTexture, vec2((x + 0.5) * invSize, y));\n    Qt = texture2D(cc_jointsTexture, vec2((x + 1.5) * invSize, y));\n    S = texture2D(cc_jointsTexture, vec2((x + 2.5) * invSize, y)).xyz;\n  }\n#endif\nvoid skinRTS(out vec4 R, out vec3 T, out vec3 S) {\n  vec4 r, t, Qt = vec4(0.0); vec3 s;\n  R = vec4(0.0); S = vec3(0.0);\n  for (int i = 0; i < 4; i++) {\n    float w = a_weights[i];\n    getJointDQ(a_joints[i], r, t, s);\n    S += s * w; R += r * w; Qt += t * w;\n  }\n  float invNorm = 1.0 / length(R); R *= invNorm; Qt *= invNorm;\n  T = 2.0 * (R.w * Qt.xyz - Qt.w * R.xyz + cross(R.xyz, Qt.xyz));\n}\nvec3 VectorTransformQuat(vec3 v, vec4 Q) {\n\treturn v + 2.0 * cross(Q.xyz, cross(Q.xyz, v) + Q.w * v);\n}\nvoid CCSkin(inout vec4 position) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  position.xyz = VectorTransformQuat(position.xyz * S, R) + T;\n}\nvoid CCSkin(inout StandardAttributes attr) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  attr.position.xyz = VectorTransformQuat(attr.position.xyz * S, R) + T;\n  attr.normal = VectorTransformQuat(attr.normal, R);\n  attr.tangent.xyz = VectorTransformQuat(attr.tangent.xyz, R);\n}\n#endif\nvoid CCVertInput (out highp vec4 position) {\n  CCDecode(position);\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n}\n#if USE_VERTEX_COLOR\n  attribute vec4 a_color;\n  varying vec4 v_color;\n#endif\n#if USE_TEXTURE\n  attribute vec2 a_texCoord;\n  varying vec2 v_uv;\n  uniform vec4 tilingOffset;\n#endif\nhighp vec4 vert () {\n  vec4 position;\n  CCVertInput(position);\n  highp vec4 pos = cc_matViewProj * cc_matWorld * position;\n  #if USE_TEXTURE\n    v_uv = a_texCoord;\n  #if FLIP_UV\n    v_uv.y = 1.0 - v_uv.y;\n  #endif\n    v_uv = v_uv * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform vec4 cc_exposure;\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\n#if USE_TEXTURE\n  varying vec2 v_uv;\n  uniform sampler2D mainTexture;\n#endif\n#if USE_COLOR\n  uniform vec4 color;\n#endif\n#if USE_VERTEX_COLOR\n  varying vec4 v_color;\n#endif\nvec4 frag () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= texture2D(mainTexture, v_uv);\n  #endif\n  #if USE_COLOR\n    o *= color;\n  #endif\n  #if USE_VERTEX_COLOR\n    o *= v_color;\n  #endif\n  return CCFragOutput(o);\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING"]}],samplers:[{name:"cc_jointsTexture",defines:["CC_USE_SKINNING"]}]}},defines:[{name:"CC_USE_SKINNING",type:"number",defines:[],range:[0,2]},{name:"USE_VERTEX_COLOR",type:"boolean",defines:[]},{name:"USE_TEXTURE",type:"boolean",defines:[]},{name:"FLIP_UV",type:"boolean",defines:["USE_TEXTURE"]},{name:"CC_USE_HDR",type:"boolean",defines:[]},{name:"USE_COLOR",type:"boolean",defines:[]}],blocks:[{name:"TexCoords",defines:["USE_TEXTURE"],binding:0,members:[{name:"tilingOffset",type:16,count:1}]},{name:"Constant",defines:["USE_COLOR"],binding:1,members:[{name:"color",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:["USE_TEXTURE"],binding:30}],dependencies:{}}]},{name:"editor/terrain-circle-brush",techniques:[{name:"transparent",passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"editor/terrain-circle-brush|terrain-brush-vs:vert|terrain-brush-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{BrushPos:{value:[0,0,0,1],type:16},BrushParams:{value:[2.5,2.5,0,0],type:16}}}]}],shaders:[{name:"editor/terrain-circle-brush|terrain-brush-vs:vert|terrain-brush-fs:frag",hash:502409078,glsl3:{vert:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  mat4 cc_matWorldIT;\n};\nin vec3 a_position;\nout vec4 wposition;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  wposition = cc_matWorld * pos;\n  wposition.y += 0.01;\n  pos = cc_matViewProj * wposition;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nin vec4 wposition;\nuniform TexCoords {\n  vec4 BrushPos;\n  vec4 BrushParams;\n};\nvec4 frag () {\n  float Radius = BrushParams.x;\n  float Falloff = BrushParams.y;\n  float Distance = length(wposition.xz - BrushPos.xz);\n  float k = 0.0;\n  #if LINEAR\n    if (Distance <= Radius) {\n      k = 1.0;\n    }\n    else if (Distance > Radius + Falloff) {\n      k = 0.0;\n    }\n    else {\n      k = max(0.0, 1.0 - (Distance - Radius) / Falloff);\n    }\n  #elif SMOOTH\n    if (Distance <= Radius) {\n      k = 1.0;\n    }\n    else if (Distance > Radius + Falloff) {\n      k = 0.0;\n    }\n    else {\n      float y = (Distance - Radius) / Falloff;\n      k = sqrt(1.0 - y * y);\n    }\n  #elif SPHERICAL\n    if (Distance <= Radius) {\n      k = 1.0;\n    }\n    else if (Distance > Radius + Falloff) {\n      k = 0.0;\n    }\n    else {\n      k = max(0.0, 1.0 - (Distance - Radius) / Falloff);\n    }\n    k = k*k*(3 - 2 * k);\n  #elif TIP\n    if (Distance <= Radius) {\n      k = 1.0;\n    }\n    else if (Distance > Radius + Falloff) {\n      k = 0.0;\n    }\n    else {\n      float y = (Falloff + Radius - Distance) / Falloff;\n      k = 1.0 - sqrt(1.0 - y * y);\n    }\n  #endif\n  vec4 color = vec4(0, 0, 0, 0);\n  color.rgb = vec3(100, 100, 135) / 255.0;\n  color.a = 0.85 * k;\n  return CCFragOutput(color);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nattribute vec3 a_position;\nvarying vec4 wposition;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  wposition = cc_matWorld * pos;\n  wposition.y += 0.01;\n  pos = cc_matViewProj * wposition;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform vec4 cc_exposure;\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nvarying vec4 wposition;\nuniform vec4 BrushPos;\nuniform vec4 BrushParams;\nvec4 frag () {\n  float Radius = BrushParams.x;\n  float Falloff = BrushParams.y;\n  float Distance = length(wposition.xz - BrushPos.xz);\n  float k = 0.0;\n  #if LINEAR\n    if (Distance <= Radius) {\n      k = 1.0;\n    }\n    else if (Distance > Radius + Falloff) {\n      k = 0.0;\n    }\n    else {\n      k = max(0.0, 1.0 - (Distance - Radius) / Falloff);\n    }\n  #elif SMOOTH\n    if (Distance <= Radius) {\n      k = 1.0;\n    }\n    else if (Distance > Radius + Falloff) {\n      k = 0.0;\n    }\n    else {\n      float y = (Distance - Radius) / Falloff;\n      k = sqrt(1.0 - y * y);\n    }\n  #elif SPHERICAL\n    if (Distance <= Radius) {\n      k = 1.0;\n    }\n    else if (Distance > Radius + Falloff) {\n      k = 0.0;\n    }\n    else {\n      k = max(0.0, 1.0 - (Distance - Radius) / Falloff);\n    }\n    k = k*k*(3 - 2 * k);\n  #elif TIP\n    if (Distance <= Radius) {\n      k = 1.0;\n    }\n    else if (Distance > Radius + Falloff) {\n      k = 0.0;\n    }\n    else {\n      float y = (Falloff + Radius - Distance) / Falloff;\n      k = 1.0 - sqrt(1.0 - y * y);\n    }\n  #endif\n  vec4 color = vec4(0, 0, 0, 0);\n  color.rgb = vec3(100, 100, 135) / 255.0;\n  color.a = 0.85 * k;\n  return CCFragOutput(color);\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_USE_HDR",type:"boolean",defines:[]},{name:"LINEAR",type:"boolean",defines:[]},{name:"SMOOTH",type:"boolean",defines:[]},{name:"SPHERICAL",type:"boolean",defines:[]},{name:"TIP",type:"boolean",defines:[]}],blocks:[{name:"TexCoords",defines:[],binding:0,members:[{name:"BrushPos",type:16,count:1},{name:"BrushParams",type:16,count:1}]}],samplers:[],dependencies:{}}]},{name:"pipeline/planar-shadow",techniques:[{passes:[{phase:"planarShadow",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"pipeline/planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1,stencilTestFront:!0,stencilFuncFront:5,stencilPassOpFront:2,stencilWriteMaskBack:128,stencilWriteMaskFront:128,stencilReadMaskBack:128,stencilReadMaskFront:128,stencilRefBack:128,stencilRefFront:128}}]}],shaders:[{name:"pipeline/planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",hash:2732109558,glsl3:{vert:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  mat4 cc_matWorldIT;\n};\nuniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  vec4 cc_shadowColor;\n};\nin vec3 a_position;\nvoid CCDecode (out vec4 position) {\n  position = vec4(a_position, 1.0);\n}\n#if CC_USE_SKINNING\nstruct StandardAttributes {\n  vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nin vec4 a_weights;\nin vec4 a_joints;\nuniform CCSkinningTexture {\n  highp vec4 cc_jointsTextureInfo;\n};\nuniform CCSkinningAnimation {\n  highp vec4 cc_jointsAnimInfo;\n};\nuniform sampler2D cc_jointsTexture;\n#if CC_USE_SKINNING == 1\n  highp float decode32(highp vec4 rgba) {\n    rgba = rgba * 255.0;\n    highp float Sign = 1.0 - step(128.0, rgba[3]) * 2.0;\n    highp float Exponent = 2.0 * mod(rgba[3], 128.0) + step(128.0, rgba[2]) - 127.0;\n    highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n    return Sign * exp2(Exponent - 23.0) * Mantissa;\n  }\n#endif\n#if CC_USE_SKINNING == 1\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 12.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = vec4(\n      decode32(texture(cc_jointsTexture, vec2((x + 0.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 1.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 2.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 3.5) * invSize, y)))\n    );\n    Qt = vec4(\n      decode32(texture(cc_jointsTexture, vec2((x + 4.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 5.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 6.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 7.5) * invSize, y)))\n    );\n    S = vec3(\n      decode32(texture(cc_jointsTexture, vec2((x + 8.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 9.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 10.5) * invSize, y)))\n    );\n  }\n#elif CC_USE_SKINNING == 2\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 3.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = texture(cc_jointsTexture, vec2((x + 0.5) * invSize, y));\n    Qt = texture(cc_jointsTexture, vec2((x + 1.5) * invSize, y));\n    S = texture(cc_jointsTexture, vec2((x + 2.5) * invSize, y)).xyz;\n  }\n#endif\nvoid skinRTS(out vec4 R, out vec3 T, out vec3 S) {\n  vec4 r, t, Qt = vec4(0.0); vec3 s;\n  R = vec4(0.0); S = vec3(0.0);\n  for (int i = 0; i < 4; i++) {\n    float w = a_weights[i];\n    getJointDQ(a_joints[i], r, t, s);\n    S += s * w; R += r * w; Qt += t * w;\n  }\n  float invNorm = 1.0 / length(R); R *= invNorm; Qt *= invNorm;\n  T = 2.0 * (R.w * Qt.xyz - Qt.w * R.xyz + cross(R.xyz, Qt.xyz));\n}\nvec3 VectorTransformQuat(vec3 v, vec4 Q) {\n\treturn v + 2.0 * cross(Q.xyz, cross(Q.xyz, v) + Q.w * v);\n}\nvoid CCSkin(inout vec4 position) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  position.xyz = VectorTransformQuat(position.xyz * S, R) + T;\n}\nvoid CCSkin(inout StandardAttributes attr) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  attr.position.xyz = VectorTransformQuat(attr.position.xyz * S, R) + T;\n  attr.normal = VectorTransformQuat(attr.normal, R);\n  attr.tangent.xyz = VectorTransformQuat(attr.tangent.xyz, R);\n}\n#endif\nvoid CCVertInput (out highp vec4 position) {\n  CCDecode(position);\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n}\nhighp vec4 vert () {\n  highp vec4 position;\n  CCVertInput(position);\n  position = cc_matViewProj * cc_matLightPlaneProj * cc_matWorld * position;\n  position.z -= 0.0001;\n  return position;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  vec4 cc_shadowColor;\n};\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nvec4 frag () {\n  return CCFragOutput(cc_shadowColor);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matLightPlaneProj;\nattribute vec3 a_position;\nvoid CCDecode (out vec4 position) {\n  position = vec4(a_position, 1.0);\n}\n#if CC_USE_SKINNING\nstruct StandardAttributes {\n  vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nattribute vec4 a_weights;\nattribute vec4 a_joints;\nuniform highp vec4 cc_jointsTextureInfo;\nuniform highp vec4 cc_jointsAnimInfo;\nuniform sampler2D cc_jointsTexture;\n#if CC_USE_SKINNING == 1\n  highp float decode32(highp vec4 rgba) {\n    rgba = rgba * 255.0;\n    highp float Sign = 1.0 - step(128.0, rgba[3]) * 2.0;\n    highp float Exponent = 2.0 * mod(rgba[3], 128.0) + step(128.0, rgba[2]) - 127.0;\n    highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n    return Sign * exp2(Exponent - 23.0) * Mantissa;\n  }\n#endif\n#if CC_USE_SKINNING == 1\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 12.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = vec4(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 0.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 1.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 2.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 3.5) * invSize, y)))\n    );\n    Qt = vec4(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 4.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 5.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 6.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 7.5) * invSize, y)))\n    );\n    S = vec3(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 8.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 9.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 10.5) * invSize, y)))\n    );\n  }\n#elif CC_USE_SKINNING == 2\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 3.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = texture2D(cc_jointsTexture, vec2((x + 0.5) * invSize, y));\n    Qt = texture2D(cc_jointsTexture, vec2((x + 1.5) * invSize, y));\n    S = texture2D(cc_jointsTexture, vec2((x + 2.5) * invSize, y)).xyz;\n  }\n#endif\nvoid skinRTS(out vec4 R, out vec3 T, out vec3 S) {\n  vec4 r, t, Qt = vec4(0.0); vec3 s;\n  R = vec4(0.0); S = vec3(0.0);\n  for (int i = 0; i < 4; i++) {\n    float w = a_weights[i];\n    getJointDQ(a_joints[i], r, t, s);\n    S += s * w; R += r * w; Qt += t * w;\n  }\n  float invNorm = 1.0 / length(R); R *= invNorm; Qt *= invNorm;\n  T = 2.0 * (R.w * Qt.xyz - Qt.w * R.xyz + cross(R.xyz, Qt.xyz));\n}\nvec3 VectorTransformQuat(vec3 v, vec4 Q) {\n\treturn v + 2.0 * cross(Q.xyz, cross(Q.xyz, v) + Q.w * v);\n}\nvoid CCSkin(inout vec4 position) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  position.xyz = VectorTransformQuat(position.xyz * S, R) + T;\n}\nvoid CCSkin(inout StandardAttributes attr) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  attr.position.xyz = VectorTransformQuat(attr.position.xyz * S, R) + T;\n  attr.normal = VectorTransformQuat(attr.normal, R);\n  attr.tangent.xyz = VectorTransformQuat(attr.tangent.xyz, R);\n}\n#endif\nvoid CCVertInput (out highp vec4 position) {\n  CCDecode(position);\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n}\nhighp vec4 vert () {\n  highp vec4 position;\n  CCVertInput(position);\n  position = cc_matViewProj * cc_matLightPlaneProj * cc_matWorld * position;\n  position.z -= 0.0001;\n  return position;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform vec4 cc_shadowColor;\nuniform vec4 cc_exposure;\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nvec4 frag () {\n  return CCFragOutput(cc_shadowColor);\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCShadow",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING"]}],samplers:[{name:"cc_jointsTexture",defines:["CC_USE_SKINNING"]}]}},defines:[{name:"CC_USE_SKINNING",type:"number",defines:[],range:[0,2]},{name:"CC_USE_HDR",type:"boolean",defines:[]}],blocks:[],samplers:[],dependencies:{}}]},{name:"pipeline/skybox",techniques:[{passes:[{rasterizerState:{cullMode:0},program:"pipeline/skybox|sky-vs:vert|sky-fs:frag",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"pipeline/skybox|sky-vs:vert|sky-fs:frag",hash:1957154815,glsl3:{vert:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nin vec3 a_position;\nvoid CCDecode (out vec4 position) {\n  position = vec4(a_position, 1.0);\n}\nout vec4 viewDir;\nhighp vec4 vert () {\n  CCDecode(viewDir);\n  mat4 matViewRotOnly = mat4(mat3(cc_matView));\n  highp vec4 pos = matViewRotOnly * viewDir;\n  highp vec2 f = cc_matProj[3][3] > 0.0 ? vec2(2.0, 1.0) : vec2(cc_matProj[1][1]);\n  pos.xy *= vec2(cc_screenSize.y * cc_screenSize.z, 1.0) * f;\n  pos.zw = vec2(-0.99999 * pos.z, -pos.z);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform samplerCube cc_environment;\nvec3 unpackNormal(vec4 nmap) {\n  return nmap.xyz * 2.0 - 1.0;\n}\nvec3 unpackRGBE(vec4 rgbe) {\n    return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nin vec4 viewDir;\nvec4 frag () {\n  #if USE_RGBE_CUBEMAP\n    vec3 c = unpackRGBE(texture(cc_environment, viewDir.xyz));\n    c = LinearToSRGB(c / (1.0 + c));\n    vec4 o = vec4(c, 1.0);\n  #else\n    vec4 o = texture(cc_environment, viewDir.xyz);\n  #endif\n  return CCFragOutput(o);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform vec4 cc_screenSize;\nuniform mat4 cc_matView;\nuniform mat4 cc_matProj;\nattribute vec3 a_position;\nvoid CCDecode (out vec4 position) {\n  position = vec4(a_position, 1.0);\n}\nvarying vec4 viewDir;\nhighp vec4 vert () {\n  CCDecode(viewDir);\n  mat4 matViewRotOnly = mat4(mat3(cc_matView));\n  highp vec4 pos = matViewRotOnly * viewDir;\n  highp vec2 f = cc_matProj[3][3] > 0.0 ? vec2(2.0, 1.0) : vec2(cc_matProj[1][1]);\n  pos.xy *= vec2(cc_screenSize.y * cc_screenSize.z, 1.0) * f;\n  pos.zw = vec2(-0.99999 * pos.z, -pos.z);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform samplerCube cc_environment;\nvec3 unpackNormal(vec4 nmap) {\n  return nmap.xyz * 2.0 - 1.0;\n}\nvec3 unpackRGBE(vec4 rgbe) {\n    return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nuniform vec4 cc_exposure;\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nvarying vec4 viewDir;\nvec4 frag () {\n  #if USE_RGBE_CUBEMAP\n    vec3 c = unpackRGBE(textureCube(cc_environment, viewDir.xyz));\n    c = LinearToSRGB(c / (1.0 + c));\n    vec4 o = vec4(c, 1.0);\n  #else\n    vec4 o = textureCube(cc_environment, viewDir.xyz);\n  #endif\n  return CCFragOutput(o);\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[{name:"cc_environment",defines:[]}]},locals:{blocks:[],samplers:[]}},defines:[{name:"CC_USE_HDR",type:"boolean",defines:[]},{name:"USE_RGBE_CUBEMAP",type:"boolean",defines:[]}],blocks:[],samplers:[],dependencies:{}}]},{name:"pipeline/smaa",techniques:[{name:"smaa",passes:[{program:"pipeline/smaa|smaa-edge-vs:vert|smaa-edge-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{u_texSampler:{type:28,samplerHash:66186}}},{program:"pipeline/smaa|smaa-blend-vs:vert|smaa-blend-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{u_edgeTexSampler:{type:28,samplerHash:66186},u_areaTexSampler:{type:28,samplerHash:66186},u_searchTexSampler:{type:28,samplerHash:66181}}}]}],shaders:[{name:"pipeline/smaa|smaa-edge-vs:vert|smaa-edge-fs:frag",hash:734353496,glsl3:{vert:"\nprecision highp float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_uv;\nout vec4 v_offsets[3];\nvec4 vert () {\n  vec4 pos = vec4(a_position, 0.0, 1.0);\n  v_uv = a_texCoord * cc_screenScale.xy;\n  v_offsets[0] = v_uv.xyxy + cc_nativeSize.zwzw * vec4(-1.0, 0.0, 0.0, 1.0);\n  v_offsets[1] = v_uv.xyxy + cc_nativeSize.zwzw * vec4( 1.0, 0.0, 0.0, -1.0);\n  v_offsets[2] = v_uv.xyxy + cc_nativeSize.zwzw * vec4(-2.0, 0.0, 0.0, 2.0);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision highp float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\n#define saturate(a) clamp( a, 0.0, 1.0 )\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec3 ACESToneMap(vec3 color) {\n    const float A = 2.51;\n    const float B = 0.03;\n    const float C = 2.43;\n    const float D = 0.59;\n    const float E = 0.14;\n    return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nin vec2 v_uv;\nin vec4 v_offsets[3];\nuniform sampler2D u_texSampler;\nvec3 ToLDR(vec3 color) {\n#if CC_USE_HDR\n  color *= cc_exposure.x * 1024.0;\n  color = ACESToneMap(color);\n  color = LinearToSRGB(color);\n#endif\n  return color;\n}\nvec4 frag () {\n  vec2 threshold = vec2(0.1, 0.1);\n  vec4 delta;\n  vec3 C = ToLDR(texture(u_texSampler, v_uv).rgb);\n  vec3 Cleft = ToLDR(texture(u_texSampler, v_offsets[0].xy).rgb);\n  vec3 t = abs(C - Cleft);\n  delta.x = max(max(t.r, t.g), t.b);\n  vec3 Ctop = ToLDR(texture(u_texSampler, v_offsets[0].zw).rgb);\n  t = abs(C - Ctop);\n  delta.y = max(max(t.r, t.g), t.b);\n  vec2 edges = step(threshold, delta.xy);\n  if (dot(edges, vec2(1.0, 1.0)) == 0.0)\n    discard;\n  vec3 Cright = ToLDR(texture(u_texSampler, v_offsets[1].xy).rgb);\n  t = abs(C - Cright);\n  delta.z = max(max(t.r, t.g), t.b);\n  vec3 Cbottom = ToLDR(texture(u_texSampler, v_offsets[1].zw).rgb);\n  t = abs(C - Cbottom);\n  delta.w = max(max(t.r, t.g), t.b);\n  float maxDelta = max(max(max(delta.x, delta.y), delta.z), delta.w);\n  vec3 Cleftleft = ToLDR(texture(u_texSampler, v_offsets[2].xy).rgb);\n  t = abs(C - Cleftleft);\n  delta.z = max(max(t.r, t.g), t.b);\n  vec3 Ctoptop = ToLDR(texture(u_texSampler, v_offsets[2].zw).rgb);\n  t = abs(C - Ctoptop);\n  delta.w = max(max(t.r, t.g), t.b);\n  maxDelta = max(max(maxDelta, delta.z), delta.w);\n  edges.xy *= step(0.5 * maxDelta, delta.xy);\n  vec4 o = vec4(edges, 0.0, 0.0);\n  return o;\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision highp float;\nuniform vec4 cc_screenScale;\nuniform vec4 cc_nativeSize;\nattribute vec2 a_position;\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nvarying vec4 v_offsets[3];\nvec4 vert () {\n  vec4 pos = vec4(a_position, 0.0, 1.0);\n  v_uv = a_texCoord * cc_screenScale.xy;\n  v_offsets[0] = v_uv.xyxy + cc_nativeSize.zwzw * vec4(-1.0, 0.0, 0.0, 1.0);\n  v_offsets[1] = v_uv.xyxy + cc_nativeSize.zwzw * vec4( 1.0, 0.0, 0.0, -1.0);\n  v_offsets[2] = v_uv.xyxy + cc_nativeSize.zwzw * vec4(-2.0, 0.0, 0.0, 2.0);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision highp float;\nuniform vec4 cc_exposure;\n#define saturate(a) clamp( a, 0.0, 1.0 )\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec3 ACESToneMap(vec3 color) {\n    const float A = 2.51;\n    const float B = 0.03;\n    const float C = 2.43;\n    const float D = 0.59;\n    const float E = 0.14;\n    return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvarying vec2 v_uv;\nvarying vec4 v_offsets[3];\nuniform sampler2D u_texSampler;\nvec3 ToLDR(vec3 color) {\n#if CC_USE_HDR\n  color *= cc_exposure.x * 1024.0;\n  color = ACESToneMap(color);\n  color = LinearToSRGB(color);\n#endif\n  return color;\n}\nvec4 frag () {\n  vec2 threshold = vec2(0.1, 0.1);\n  vec4 delta;\n  vec3 C = ToLDR(texture2D(u_texSampler, v_uv).rgb);\n  vec3 Cleft = ToLDR(texture2D(u_texSampler, v_offsets[0].xy).rgb);\n  vec3 t = abs(C - Cleft);\n  delta.x = max(max(t.r, t.g), t.b);\n  vec3 Ctop = ToLDR(texture2D(u_texSampler, v_offsets[0].zw).rgb);\n  t = abs(C - Ctop);\n  delta.y = max(max(t.r, t.g), t.b);\n  vec2 edges = step(threshold, delta.xy);\n  if (dot(edges, vec2(1.0, 1.0)) == 0.0)\n    discard;\n  vec3 Cright = ToLDR(texture2D(u_texSampler, v_offsets[1].xy).rgb);\n  t = abs(C - Cright);\n  delta.z = max(max(t.r, t.g), t.b);\n  vec3 Cbottom = ToLDR(texture2D(u_texSampler, v_offsets[1].zw).rgb);\n  t = abs(C - Cbottom);\n  delta.w = max(max(t.r, t.g), t.b);\n  float maxDelta = max(max(max(delta.x, delta.y), delta.z), delta.w);\n  vec3 Cleftleft = ToLDR(texture2D(u_texSampler, v_offsets[2].xy).rgb);\n  t = abs(C - Cleftleft);\n  delta.z = max(max(t.r, t.g), t.b);\n  vec3 Ctoptop = ToLDR(texture2D(u_texSampler, v_offsets[2].zw).rgb);\n  t = abs(C - Ctoptop);\n  delta.w = max(max(t.r, t.g), t.b);\n  maxDelta = max(max(maxDelta, delta.z), delta.w);\n  edges.xy *= step(0.5 * maxDelta, delta.xy);\n  vec4 o = vec4(edges, 0.0, 0.0);\n  return o;\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[],samplers:[]}},defines:[{name:"CC_USE_HDR",type:"boolean",defines:[]}],blocks:[],samplers:[{name:"u_texSampler",type:28,count:1,defines:[],binding:30}],dependencies:{}},{name:"pipeline/smaa|smaa-blend-vs:vert|smaa-blend-fs:frag",hash:1697076750,glsl3:{vert:"\nprecision highp float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_uv;\nout vec4 v_offsets[3];\nout vec2 v_pixCoord;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 0.0, 1.0);\n  v_uv = a_texCoord * cc_screenScale.xy;\n  v_pixCoord = v_uv * cc_nativeSize.xy;\n  v_offsets[0] = v_uv.xyxy + cc_nativeSize.zwzw * vec4(-0.25, 0.125, 1.25, 0.125);\n  v_offsets[1] = v_uv.xyxy + cc_nativeSize.zwzw * vec4(-0.125, 0.25, -0.125, -1.25);\n  v_offsets[2] = vec4(v_offsets[0].xz, v_offsets[1].yw) + vec4(-2.0, 2.0, -2.0, 2.0) * cc_nativeSize.zzww * float(8);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision highp float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nin vec2 v_uv;\nin vec4 v_offsets[3];\nin vec2 v_pixCoord;\nuniform sampler2D u_edgeTexSampler;\nuniform sampler2D u_areaTexSampler;\nuniform sampler2D u_searchTexSampler;\nfloat SMAASearchLength(vec2 e, float bias, float scale) {\n  e.r = bias + e.r * scale;\n  return 255.0 * texture(u_searchTexSampler, e).r;\n}\nfloat SMAASearchXLeft(vec2 texcoord, float end) {\n  vec2 e = vec2(0.0, 1.0);\n  for (int i = 0; i < 8; ++i) {\n      e = texture(u_edgeTexSampler, texcoord).rg;\n      texcoord -= vec2( 2.0, 0.0 ) * cc_nativeSize.zw;\n      if (!(texcoord.x > end && e.g > 0.8281 && e.r == 0.0))\n        break;\n  }\n  texcoord.x += 0.25 * cc_nativeSize.z;\n  texcoord.x += cc_nativeSize.z;\n  texcoord.x += 2.0 * cc_nativeSize.z;\n  texcoord.x -= cc_nativeSize.z * SMAASearchLength(e, 0.0, 0.5);\n  return texcoord.x;\n}\nfloat SMAASearchXRight(vec2 texcoord, float end) {\n  vec2 e = vec2(0.0, 1.0);\n  for (int i = 0; i < 8; ++i) {\n      e = texture(u_edgeTexSampler, texcoord).rg;\n      texcoord += vec2( 2.0, 0.0 ) * cc_nativeSize.zw;\n      if (!(texcoord.x < end && e.g > 0.8281 && e.r == 0.0))\n        break;\n  }\n  texcoord.x -= 0.25 * cc_nativeSize.z;\n  texcoord.x -= cc_nativeSize.z;\n  texcoord.x -= 2.0 * cc_nativeSize.z;\n  texcoord.x += cc_nativeSize.z * SMAASearchLength(e, 0.5, 0.5);\n  return texcoord.x;\n}\nfloat SMAASearchYUp(vec2 texcoord, float end) {\n    vec2 e = vec2(1.0, 0.0);\n    for (int i = 0; i < 8; ++i) {\n        e = texture(u_edgeTexSampler, texcoord).rg;\n        texcoord += vec2( 0.0, 2.0 ) * cc_nativeSize.zw;\n        if (!(texcoord.y > end && e.r > 0.8281 && e.g == 0.0))\n          break;\n    }\n    texcoord.y -= 0.25 * cc_nativeSize.w;\n    texcoord.y -= cc_nativeSize.w;\n    texcoord.y -= 2.0 * cc_nativeSize.w;\n    texcoord.y += cc_nativeSize.w * SMAASearchLength(e.gr, 0.0, 0.5);\n    return texcoord.y;\n}\nfloat SMAASearchYDown(vec2 texcoord, float end) {\n    vec2 e = vec2(1.0, 0.0);\n    for (int i = 0; i < 8; ++i) {\n        e = texture(u_edgeTexSampler, texcoord).rg;\n        texcoord -= vec2( 0.0, 2.0 ) * cc_nativeSize.zw;\n        if (!(texcoord.y < end && e.r > 0.8281 && e.g == 0.0))\n          break;\n    }\n    texcoord.y += 0.25 * cc_nativeSize.w;\n    texcoord.y += cc_nativeSize.w;\n    texcoord.y += 2.0 * cc_nativeSize.w;\n    texcoord.y -= cc_nativeSize.w * SMAASearchLength(e.gr, 0.5, 0.5);\n    return texcoord.y;\n}\nvec2 Round(vec2 x) {\n  return sign(x) * floor(abs(x) + 0.5);\n}\nvec2 SMAAArea(vec2 dist, float e1, float e2) {\n    vec2 texcoord = float(16) * Round(4.0 * vec2(e1, e2)) + dist;\n    texcoord = (1.0 / vec2(160.0, 560.0)) * texcoord + 0.5 * (1.0 / vec2(160.0, 560.0));\n    return texture(u_areaTexSampler, texcoord).rg;\n}\nvec4 frag () {\n  vec4 weights = vec4(0.0);\n  vec2 e = texture(u_edgeTexSampler, v_uv).rg;\n  vec2 d;\n  vec2 coords;\n  if ( e.g > 0.0 ) {\n      coords.x = SMAASearchXLeft(v_offsets[0].xy, v_offsets[2].x);\n      coords.y = v_offsets[1].y;\n      d.x = coords.x;\n      float e1 = texture(u_edgeTexSampler, coords).r;\n      coords.x = SMAASearchXRight(v_offsets[0].zw, v_offsets[2].y);\n      d.y = coords.x;\n      d = d / cc_nativeSize.z - v_pixCoord.x;\n      vec2 sqrt_d = sqrt(abs(d));\n      coords.y -= 1.0 * cc_nativeSize.w;\n      float e2 = texture(u_edgeTexSampler, coords + vec2(cc_nativeSize.z, 0.0)).r;\n      weights.rg = SMAAArea(sqrt_d, e1, e2);\n  }\n  if ( e.r > 0.0 ) {\n      coords.y = SMAASearchYUp(v_offsets[1].xy, v_offsets[2].z);\n      coords.x = v_offsets[0].x;\n      d.x = coords.y;\n      float e1 = texture(u_edgeTexSampler, coords).g;\n      coords.y = SMAASearchYDown(v_offsets[1].zw, v_offsets[2].w);\n      d.y = coords.y;\n      d = d / cc_nativeSize.w - v_pixCoord.y;\n      vec2 sqrt_d = sqrt(abs(d));\n      coords.y -= 1.0 * cc_nativeSize.w;\n      float e2 = texture(u_edgeTexSampler, coords + vec2(0.0, cc_nativeSize.w)).g;\n      weights.ba = SMAAArea(sqrt_d, e1, e2);\n  }\n  return weights;\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision highp float;\nuniform vec4 cc_screenScale;\nuniform vec4 cc_nativeSize;\nattribute vec2 a_position;\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nvarying vec4 v_offsets[3];\nvarying vec2 v_pixCoord;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 0.0, 1.0);\n  v_uv = a_texCoord * cc_screenScale.xy;\n  v_pixCoord = v_uv * cc_nativeSize.xy;\n  v_offsets[0] = v_uv.xyxy + cc_nativeSize.zwzw * vec4(-0.25, 0.125, 1.25, 0.125);\n  v_offsets[1] = v_uv.xyxy + cc_nativeSize.zwzw * vec4(-0.125, 0.25, -0.125, -1.25);\n  v_offsets[2] = vec4(v_offsets[0].xz, v_offsets[1].yw) + vec4(-2.0, 2.0, -2.0, 2.0) * cc_nativeSize.zzww * float(8);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision highp float;\nuniform vec4 cc_nativeSize;\nvarying vec2 v_uv;\nvarying vec4 v_offsets[3];\nvarying vec2 v_pixCoord;\nuniform sampler2D u_edgeTexSampler;\nuniform sampler2D u_areaTexSampler;\nuniform sampler2D u_searchTexSampler;\nfloat SMAASearchLength(vec2 e, float bias, float scale) {\n  e.r = bias + e.r * scale;\n  return 255.0 * texture2D(u_searchTexSampler, e).r;\n}\nfloat SMAASearchXLeft(vec2 texcoord, float end) {\n  vec2 e = vec2(0.0, 1.0);\n  for (int i = 0; i < 8; ++i) {\n      e = texture2D(u_edgeTexSampler, texcoord).rg;\n      texcoord -= vec2( 2.0, 0.0 ) * cc_nativeSize.zw;\n      if (!(texcoord.x > end && e.g > 0.8281 && e.r == 0.0))\n        break;\n  }\n  texcoord.x += 0.25 * cc_nativeSize.z;\n  texcoord.x += cc_nativeSize.z;\n  texcoord.x += 2.0 * cc_nativeSize.z;\n  texcoord.x -= cc_nativeSize.z * SMAASearchLength(e, 0.0, 0.5);\n  return texcoord.x;\n}\nfloat SMAASearchXRight(vec2 texcoord, float end) {\n  vec2 e = vec2(0.0, 1.0);\n  for (int i = 0; i < 8; ++i) {\n      e = texture2D(u_edgeTexSampler, texcoord).rg;\n      texcoord += vec2( 2.0, 0.0 ) * cc_nativeSize.zw;\n      if (!(texcoord.x < end && e.g > 0.8281 && e.r == 0.0))\n        break;\n  }\n  texcoord.x -= 0.25 * cc_nativeSize.z;\n  texcoord.x -= cc_nativeSize.z;\n  texcoord.x -= 2.0 * cc_nativeSize.z;\n  texcoord.x += cc_nativeSize.z * SMAASearchLength(e, 0.5, 0.5);\n  return texcoord.x;\n}\nfloat SMAASearchYUp(vec2 texcoord, float end) {\n    vec2 e = vec2(1.0, 0.0);\n    for (int i = 0; i < 8; ++i) {\n        e = texture2D(u_edgeTexSampler, texcoord).rg;\n        texcoord += vec2( 0.0, 2.0 ) * cc_nativeSize.zw;\n        if (!(texcoord.y > end && e.r > 0.8281 && e.g == 0.0))\n          break;\n    }\n    texcoord.y -= 0.25 * cc_nativeSize.w;\n    texcoord.y -= cc_nativeSize.w;\n    texcoord.y -= 2.0 * cc_nativeSize.w;\n    texcoord.y += cc_nativeSize.w * SMAASearchLength(e.gr, 0.0, 0.5);\n    return texcoord.y;\n}\nfloat SMAASearchYDown(vec2 texcoord, float end) {\n    vec2 e = vec2(1.0, 0.0);\n    for (int i = 0; i < 8; ++i) {\n        e = texture2D(u_edgeTexSampler, texcoord).rg;\n        texcoord -= vec2( 0.0, 2.0 ) * cc_nativeSize.zw;\n        if (!(texcoord.y < end && e.r > 0.8281 && e.g == 0.0))\n          break;\n    }\n    texcoord.y += 0.25 * cc_nativeSize.w;\n    texcoord.y += cc_nativeSize.w;\n    texcoord.y += 2.0 * cc_nativeSize.w;\n    texcoord.y -= cc_nativeSize.w * SMAASearchLength(e.gr, 0.5, 0.5);\n    return texcoord.y;\n}\nvec2 Round(vec2 x) {\n  return sign(x) * floor(abs(x) + 0.5);\n}\nvec2 SMAAArea(vec2 dist, float e1, float e2) {\n    vec2 texcoord = float(16) * Round(4.0 * vec2(e1, e2)) + dist;\n    texcoord = (1.0 / vec2(160.0, 560.0)) * texcoord + 0.5 * (1.0 / vec2(160.0, 560.0));\n    return texture2D(u_areaTexSampler, texcoord).rg;\n}\nvec4 frag () {\n  vec4 weights = vec4(0.0);\n  vec2 e = texture2D(u_edgeTexSampler, v_uv).rg;\n  vec2 d;\n  vec2 coords;\n  if ( e.g > 0.0 ) {\n      coords.x = SMAASearchXLeft(v_offsets[0].xy, v_offsets[2].x);\n      coords.y = v_offsets[1].y;\n      d.x = coords.x;\n      float e1 = texture2D(u_edgeTexSampler, coords).r;\n      coords.x = SMAASearchXRight(v_offsets[0].zw, v_offsets[2].y);\n      d.y = coords.x;\n      d = d / cc_nativeSize.z - v_pixCoord.x;\n      vec2 sqrt_d = sqrt(abs(d));\n      coords.y -= 1.0 * cc_nativeSize.w;\n      float e2 = texture2D(u_edgeTexSampler, coords + vec2(cc_nativeSize.z, 0.0)).r;\n      weights.rg = SMAAArea(sqrt_d, e1, e2);\n  }\n  if ( e.r > 0.0 ) {\n      coords.y = SMAASearchYUp(v_offsets[1].xy, v_offsets[2].z);\n      coords.x = v_offsets[0].x;\n      d.x = coords.y;\n      float e1 = texture2D(u_edgeTexSampler, coords).g;\n      coords.y = SMAASearchYDown(v_offsets[1].zw, v_offsets[2].w);\n      d.y = coords.y;\n      d = d / cc_nativeSize.w - v_pixCoord.y;\n      vec2 sqrt_d = sqrt(abs(d));\n      coords.y -= 1.0 * cc_nativeSize.w;\n      float e2 = texture2D(u_edgeTexSampler, coords + vec2(0.0, cc_nativeSize.w)).g;\n      weights.ba = SMAAArea(sqrt_d, e1, e2);\n  }\n  return weights;\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[],samplers:[]}},defines:[],blocks:[],samplers:[{name:"u_edgeTexSampler",type:28,count:1,defines:[],binding:30},{name:"u_areaTexSampler",type:28,count:1,defines:[],binding:31},{name:"u_searchTexSampler",type:28,count:1,defines:[],binding:32}],dependencies:{}}]},{name:"pipeline/tonemap",techniques:[{name:"tonemap",passes:[{program:"pipeline/tonemap|tonemap-vs:vert|tonemap-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{u_texSampler:{type:28,samplerHash:66186},u_blendTexSampler:{type:28,samplerHash:66186}}}]}],shaders:[{name:"pipeline/tonemap|tonemap-vs:vert|tonemap-fs:frag",hash:433933566,glsl3:{vert:"\nprecision highp float;\n#define saturate(a) clamp( a, 0.0, 1.0 )\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_uv;\nout vec4 v_offset;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 0, 1);\n  v_uv = a_texCoord * cc_screenScale.xy;\n  v_offset = v_uv.xyxy + cc_nativeSize.zwzw * vec4(1.0, 0.0, 0.0, -1.0);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision highp float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\n#define saturate(a) clamp( a, 0.0, 1.0 )\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec3 ACESToneMap(vec3 color) {\n    const float A = 2.51;\n    const float B = 0.03;\n    const float C = 2.43;\n    const float D = 0.59;\n    const float E = 0.14;\n    return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nin vec2 v_uv;\nin vec4 v_offset;\nuniform sampler2D u_texSampler;\nuniform sampler2D u_blendTexSampler;\nvec3 ToLDR(vec3 color) {\n  #if CC_USE_HDR\n    color *= cc_exposure.x * 1024.0;\n    color = ACESToneMap(color);\n    color = LinearToSRGB(color);\n  #endif\n  return color;\n}\nvec4 frag () {\n  #if CC_USE_SMAA\n    vec4 a;\n    a.rb = texture(u_blendTexSampler, v_uv).rb;\n    a.g = texture(u_blendTexSampler, v_offset.zw).g;\n    a.a = texture(u_blendTexSampler, v_offset.xy).a;\n    if (dot(a, vec4(1.0)) < 1e-5) {\n      vec4 o = texture(u_texSampler, v_uv);\n      o.rgb = ToLDR(o.rgb);\n      return o;\n    } else {\n      vec2 offset;\n      offset.x = a.a > a.b ? a.a : -a.b;\n      offset.y = a.g > a.r ? -a.g : a.r;\n      if (abs(offset.x) > abs(offset.y)) {\n        offset.y = 0.0;\n      } else {\n        offset.x = 0.0;\n      }\n      vec4 C = texture(u_texSampler, v_uv);\n      C.rgb = ToLDR(C.rgb);\n      vec2 uv = v_uv + sign(offset) * cc_nativeSize.zw;\n      vec4 Cop = texture(u_texSampler, uv);\n      Cop.rgb = ToLDR(Cop.rgb);\n      float s = abs(offset.x) > abs(offset.y) ? abs(offset.x) : abs(offset.y);\n      C.rgb = pow(C.rgb, vec3(2.2));\n      Cop.rgb = pow(Cop.rgb, vec3(2.2));\n      vec4 mixed = mix(C, Cop, s);\n      mixed.rgb = pow(mixed.rgb, vec3(1.0 / 2.2));\n      return mixed;\n    }\n  #else\n    vec4 o = texture(u_texSampler, v_uv);\n    o.rgb = ToLDR(o.rgb);\n    return o;\n  #endif\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision highp float;\n#define saturate(a) clamp( a, 0.0, 1.0 )\nuniform vec4 cc_screenScale;\nuniform vec4 cc_nativeSize;\nattribute vec2 a_position;\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nvarying vec4 v_offset;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 0, 1);\n  v_uv = a_texCoord * cc_screenScale.xy;\n  v_offset = v_uv.xyxy + cc_nativeSize.zwzw * vec4(1.0, 0.0, 0.0, -1.0);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision highp float;\nuniform vec4 cc_nativeSize;\nuniform vec4 cc_exposure;\n#define saturate(a) clamp( a, 0.0, 1.0 )\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec3 ACESToneMap(vec3 color) {\n    const float A = 2.51;\n    const float B = 0.03;\n    const float C = 2.43;\n    const float D = 0.59;\n    const float E = 0.14;\n    return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvarying vec2 v_uv;\nvarying vec4 v_offset;\nuniform sampler2D u_texSampler;\nuniform sampler2D u_blendTexSampler;\nvec3 ToLDR(vec3 color) {\n  #if CC_USE_HDR\n    color *= cc_exposure.x * 1024.0;\n    color = ACESToneMap(color);\n    color = LinearToSRGB(color);\n  #endif\n  return color;\n}\nvec4 frag () {\n  #if CC_USE_SMAA\n    vec4 a;\n    a.rb = texture2D(u_blendTexSampler, v_uv).rb;\n    a.g = texture2D(u_blendTexSampler, v_offset.zw).g;\n    a.a = texture2D(u_blendTexSampler, v_offset.xy).a;\n    if (dot(a, vec4(1.0)) < 1e-5) {\n      vec4 o = texture2D(u_texSampler, v_uv);\n      o.rgb = ToLDR(o.rgb);\n      return o;\n    } else {\n      vec2 offset;\n      offset.x = a.a > a.b ? a.a : -a.b;\n      offset.y = a.g > a.r ? -a.g : a.r;\n      if (abs(offset.x) > abs(offset.y)) {\n        offset.y = 0.0;\n      } else {\n        offset.x = 0.0;\n      }\n      vec4 C = texture2D(u_texSampler, v_uv);\n      C.rgb = ToLDR(C.rgb);\n      vec2 uv = v_uv + sign(offset) * cc_nativeSize.zw;\n      vec4 Cop = texture2D(u_texSampler, uv);\n      Cop.rgb = ToLDR(Cop.rgb);\n      float s = abs(offset.x) > abs(offset.y) ? abs(offset.x) : abs(offset.y);\n      C.rgb = pow(C.rgb, vec3(2.2));\n      Cop.rgb = pow(Cop.rgb, vec3(2.2));\n      vec4 mixed = mix(C, Cop, s);\n      mixed.rgb = pow(mixed.rgb, vec3(1.0 / 2.2));\n      return mixed;\n    }\n  #else\n    vec4 o = texture2D(u_texSampler, v_uv);\n    o.rgb = ToLDR(o.rgb);\n    return o;\n  #endif\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[],samplers:[]}},defines:[{name:"CC_USE_HDR",type:"boolean",defines:[]},{name:"CC_USE_SMAA",type:"boolean",defines:[]}],blocks:[],samplers:[{name:"u_texSampler",type:28,count:1,defines:[],binding:30},{name:"u_blendTexSampler",type:28,count:1,defines:[],binding:31}],dependencies:{}}]},{name:"util/profiler",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"util/profiler|profiler-vs:vert|profiler-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},offset:{type:16}}}]}],shaders:[{name:"util/profiler|profiler-vs:vert|profiler-fs:frag",hash:3710757766,glsl3:{vert:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nin vec3 a_position;\nvoid CCDecode (out vec4 position) {\n  position = vec4(a_position, 1.0);\n}\nin vec2 a_texCoord;\nout vec2 v_uv;\nuniform Constants {\n  vec4 offset;\n};\nvec4 vert () {\n  vec4 position;\n  CCDecode(position);\n  position.x *= cc_screenSize.y * cc_screenSize.z;\n  position.xy += offset.xy + abs(position.xy);\n  v_uv = a_texCoord;\n  return position;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nin vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\n  return CCFragOutput(texture(mainTexture, v_uv));\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform vec4 cc_screenSize;\nattribute vec3 a_position;\nvoid CCDecode (out vec4 position) {\n  position = vec4(a_position, 1.0);\n}\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nuniform vec4 offset;\nvec4 vert () {\n  vec4 position;\n  CCDecode(position);\n  position.x *= cc_screenSize.y * cc_screenSize.z;\n  position.xy += offset.xy + abs(position.xy);\n  v_uv = a_texCoord;\n  return position;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform vec4 cc_exposure;\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\n  return CCFragOutput(texture2D(mainTexture, v_uv));\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[],samplers:[]}},defines:[{name:"CC_USE_HDR",type:"boolean",defines:[]}],blocks:[{name:"Constants",defines:[],binding:0,members:[{name:"offset",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],binding:30}],dependencies:{}}]}]),Ad=function(){function e(){y(this,e),this._device=null,this._resources={}}return l(e,[{key:"initBuiltinRes",value:function(e){this._device=e;var t=this._resources,i=document.createElement("canvas"),n=i.getContext("2d"),r=new zu(i),a=i.width=i.height=2;n.fillStyle="#000",n.fillRect(0,0,a,a);var s=new vh;s._uuid="black-texture",s.image=r,t[s._uuid]=s;var o=new Ch;o._uuid="black-cube-texture",o.setMipFilter(Ch.Filter.LINEAR),o.image={front:new zu(i),back:new zu(i),left:new zu(i),right:new zu(i),top:new zu(i),bottom:new zu(i)},t[o._uuid]=o,n.fillStyle="#777",n.fillRect(0,0,a,a);var l=new vh;l._uuid="grey-texture",l.image=r,t[l._uuid]=l,n.fillStyle="#fff",n.fillRect(0,0,a,a);var c=new vh;c._uuid="white-texture",c.image=r,t[c._uuid]=c;var u=new Ch;u._uuid="white-cube-texture",u.setMipFilter(Ch.Filter.LINEAR),u.image={front:new zu(i),back:new zu(i),left:new zu(i),right:new zu(i),top:new zu(i),bottom:new zu(i)},t[u._uuid]=u,n.fillStyle="#7f7fff",n.fillRect(0,0,a,a);var h=new vh;h._uuid="normal-texture",h.image=r,t[h._uuid]=h,i.width=i.height=16,n.fillStyle="#ddd",n.fillRect(0,0,16,16),n.fillStyle="#555",n.fillRect(0,0,8,8),n.fillStyle="#555",n.fillRect(8,8,8,8);var f=new vh;f._uuid="default-texture",f.image=r,t[f._uuid]=f;var d=new Ch;d.setMipFilter(Ch.Filter.LINEAR),d._uuid="default-cube-texture",d.image={front:new zu(i),back:new zu(i),left:new zu(i),right:new zu(i),top:new zu(i),bottom:new zu(i)},t[d._uuid]=d;var p=new Eh,_=r._texture;p.texture=_,p._uuid="default-spriteframe",t[p._uuid]=p,Cd.forEach(function(e){Object.assign(new cc.EffectAsset,e).onLoaded()});var v=new cc.Material;v._uuid="standard-material",v.initialize({effectName:"builtin-standard"}),t[v._uuid]=v;var m=new cc.Material;m._uuid="missing-material",m.initialize({effectName:"builtin-unlit",defines:{USE_COLOR:!0}}),m.setProperty("color",cc.color("#ff00ff")),t[m._uuid]=m;var y=new cc.Material;y._uuid="missing-skinning-material";var g=od(e);y.initialize({effectName:"builtin-unlit",defines:{USE_COLOR:!0,CC_USE_SKINNING:g}}),y.setProperty("color",cc.color("#ff00ff")),t[y._uuid]=y;var b=new cc.Material;b._uuid="missing-effect-material",b.initialize({effectName:"builtin-unlit",defines:{USE_COLOR:!0}}),b.setProperty("color",cc.color("#ffff00")),t[b._uuid]=b;var x=new cc.Material;x._uuid="ui-base-material",x.initialize({defines:{USE_TEXTURE:!1},effectName:"builtin-sprite"}),t[x._uuid]=x;var S=new cc.Material;S._uuid="ui-sprite-material",S.initialize({defines:{USE_TEXTURE:!0},effectName:"builtin-sprite"}),t[S._uuid]=S;var w=new cc.Material;w._uuid="default-particle-material",w.initialize({effectName:"builtin-particle"}),t[w._uuid]=w;var T=new cc.Material;T._uuid="default-trail-material",T.initialize({effectName:"builtin-particle-trail"}),t[T._uuid]=T;var E=new cc.Material;E._uuid="default-billboard-material",E.initialize({effectName:"builtin-billboard"}),t[E._uuid]=E}},{key:"get",value:function(e){return this._resources[e]}}]),e}(),kd=P2("builtinResMgr",cc.builtinResMgr=new Ad),Rd=function(){function t(e){y(this,t),this.batches=[],this.pso=null,this.ubo=void 0,this.pass=void 0,this._limitCount=10,this.pass=e,this.ubo=e.device.createBuffer({usage:zl.UNIFORM|zl.TRANSFER_DST,memUsage:Pl.HOST|Pl.DEVICE,size:ef.SIZE})}return l(t,[{key:"destroy",value:function(){for(var e=0;e<this.batches.length;++e){for(var t=this.batches[e],i=0;i<t.vbs.length;++i)t.vbs[i].destroy();t.vbIdx.destroy(),t.ia.destroy()}this.batches.splice(0),this.pso=null,this.ubo.destroy()}},{key:"merge",value:function(e,t){var i=e.subMeshData.flatBuffers;if(0!==i.length){for(var n=0,r=0,a=i[0].count,s=!1,o=0;o<this.batches.length;++o){var l=this.batches[o];if(l.vbs.length===i.length&&l.mergeCount<=this._limitCount){s=!0;for(var c=0;c<l.vbs.length;++c){if(l.vbs[c].stride!==i[c].stride){s=!1;break}}if(s){for(var u=0;u<l.vbs.length;++u){var h=i[u],f=l.vbs[u];(n=(a+l.vbCount)*h.stride)>f.size&&f.resize(n),f.update(h.buffer,l.vbCount*h.stride)}(r=4*(a+l.vbCount))>l.vbIdx.size&&l.vbIdx.resize(r);var d=new Float32Array(i[0].count);return d.fill(l.mergeCount),l.vbIdx.update(d.buffer,4*l.vbCount),zn.toArray(l.uboLocal.view,t.model.transform.worldMatrix,ef.MAT_WORLDS_OFFSET+16*l.mergeCount),++l.mergeCount,l.vbCount+=a,void(l.ia.vertexCount+=a)}}}for(var p=this.pass.device,_=[],v=[],m=0;m<i.length;++m){var y=i[m],g=p.createBuffer({usage:zl.VERTEX|zl.TRANSFER_DST,memUsage:Pl.HOST|Pl.DEVICE,size:y.count*y.stride,stride:y.stride,flags:Fl.BAKUP_BUFFER});g.update(y.buffer),_.push(g),v.push(g)}var b=p.createBuffer({usage:zl.VERTEX|zl.TRANSFER_DST,memUsage:Pl.HOST|Pl.DEVICE,size:4*a,stride:4,flags:Fl.BAKUP_BUFFER}),x=new Float32Array(a);x.fill(0),b.update(x),v.push(b);for(var S=e.inputAssembler.attributes,w=new Array(S.length+1),T=0;T<S.length;++T)w[T]=S[T];w[S.length]={name:"a_index",format:Il.R32F,stream:i.length};var E={vbs:_,vbIdx:b,vbCount:a,mergeCount:1,ia:p.createInputAssembler({attributes:w,vertexBuffers:v}),uboLocal:new ef};if(zn.toArray(E.uboLocal.view,t.model.transform.worldMatrix,ef.MAT_WORLDS_OFFSET),this.batches.push(E),this.pass.bindBuffer(Qh.UBO_LOCAL,this.ubo),this.pass.update(),!this.pso)this.pso=e.psos[this.pass.idxInTech],this.pso.pipelineLayout.layouts[0].update()}}},{key:"clear",value:function(){for(var e=0;e<this.batches.length;++e){var t=this.batches[e];t.vbCount=0,t.mergeCount=0,t.ia.vertexCount=0}}}]),t}(),Od=(gd=new Map,bd=0,function(e){return gd.has(e)||(gd.set(e,1<<bd),bd++),gd.get(e)}),Md=0,Id=new(function(){function e(){y(this,e),this._templates=void 0,this._cache=void 0,this._templates={},this._cache={}}return l(e,[{key:"define",value:function(e){var t=this._templates[e.name];if(!t||t.hash!==e.hash){var i=Object.assign({id:++Md},e);i.localsInited||(yd(i,nf,"locals"),i.localsInited=!0);var n=0,r=function(){if(s){if(o>=a.length)return"break";l=a[o++]}else{if((o=a.next()).done)return"break";l=o.value}var i=l,e=1;if("number"===i.type){var t=i.range;e=vd(t[1]-t[0]+1),i._map=function(e){return e-t[0]<<i._offset}}else"string"===i.type?(e=vd(i.options.length),i._map=function(t){return Math.max(0,i.options.findIndex(function(e){return e===t}))<<i._offset}):"boolean"===i.type&&(i._map=function(e){return e?1<<i._offset:0});i._offset=n,n+=e},a=i.defines,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if("break"===r())break}this._templates[e.name]=i}}},{key:"getTemplate",value:function(e){return this._templates[e]}},{key:"hasProgram",value:function(e){return void 0!==this._templates[e]}},{key:"getKey",value:function(e,t){var i=this._templates[e],n=0,r=i.defines,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}var l=o,c=t[l.name];void 0!==c&&l._map&&(n|=l._map(c))}return n<<8|255&i.id}},{key:"destroyShaderByDefines",value:function(e){var i=this,n=Object.keys(e);if(n.length){var r=n.map(function(e){var t=n[e];return"boolean"==typeof t&&(t=t?"1":"0"),new RegExp(e+t)}),t=Object.keys(this._cache).filter(function(t){return r.every(function(e){return e.test(i._cache[t].name)})}),a=Array.isArray(t),s=0;for(t=a?t:t[Symbol.iterator]();;){var o;if(a){if(s>=t.length)break;o=t[s++]}else{if((s=t.next()).done)break;o=s.value}var l=o;console.log("destroyed shader ".concat(this._cache[l].name)),this._cache[l].destroy(),delete this._cache[l]}}}},{key:"getGFXShader",value:function(e,t,i,n){Object.assign(i,n.macros);var r=this.getKey(t,i),a=this._cache[r];if(void 0!==a)return a;var s=this._templates[t];s.globalsInited||(yd(s,n.globalBindings,"globals"),s.globalsInited=!0);var o=function(e,t){var i=[],n=t,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s,l=o.name,c=md(o,e[l]);i.push({name:l,result:c})}return i}(i,s.defines);!function(e,t,i){var n=e,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s,l=o.name;"0"!==o.result&&i[l]&&!t[i[l]]&&(console.warn("".concat(i[l]," not supported on this platform, disabled ").concat(l)),o.result="0")}}(o,e,s.dependencies);var l=o.reduce(function(e,t){return"".concat(e,"#define ").concat(t.name," ").concat(t.result,"\n")},""),c="",u="";return u=e.gfxAPI===eu.WEBGL2?(c="#version 300 es\n".concat(l,"\n").concat(s.glsl3.vert),"#version 300 es\n".concat(l,"\n").concat(s.glsl3.frag)):(c="#version 100\n".concat(l,"\n").concat(s.glsl1.vert),"#version 100\n".concat(l,"\n").concat(s.glsl1.frag)),a=e.createShader({name:function(e,t){return e+t.reduce(function(e,t){return"0"!==t.result?"".concat(e,"|").concat(t.name).concat(t.result):e},"")}(t,o),blocks:s.blocks,samplers:s.samplers,stages:[{type:xc.VERTEX,source:c},{type:xc.FRAGMENT,source:u}]}),this._cache[r]=a}}]),e}());cc.programLib=Id;function Ld(e,t,i,n){return e<<28&Nd|i<<22&Ud|t<<14&4177920|16383&(3<arguments.length&&void 0!==n?n:0)}function zd(e){return(e&Ud)>>>22}function Bd(e,t){return e&~Ud|t<<22&Ud}var Pd=(s(xd={},Ol.UNKNOWN,function(e,t){return console.warn("illegal uniform handle")}),s(xd,Ol.INT,function(e,t){return e[2<arguments.length&&void 0!==arguments[2]?arguments[2]:0]=t}),s(xd,Ol.INT2,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Mi.toArray(e,t,i)}),s(xd,Ol.INT3,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Fi.toArray(e,t,i)}),s(xd,Ol.INT4,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Wi.toArray(e,t,i)}),s(xd,Ol.FLOAT,function(e,t){return e[2<arguments.length&&void 0!==arguments[2]?arguments[2]:0]=t}),s(xd,Ol.FLOAT2,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Mi.toArray(e,t,i)}),s(xd,Ol.FLOAT3,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Fi.toArray(e,t,i)}),s(xd,Ol.FLOAT4,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Wi.toArray(e,t,i)}),s(xd,Ol.MAT3,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return rn.toArray(e,t,i)}),s(xd,Ol.MAT4,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return zn.toArray(e,t,i)}),xd),Dd=(s(Sd={},Ol.UNKNOWN,function(e,t){return console.warn("illegal uniform handle")}),s(Sd,Ol.INT,function(e,t){return e[2<arguments.length&&void 0!==arguments[2]?arguments[2]:0]}),s(Sd,Ol.INT2,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Mi.fromArray(t,e,i)}),s(Sd,Ol.INT3,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Fi.fromArray(t,e,i)}),s(Sd,Ol.INT4,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Wi.fromArray(t,e,i)}),s(Sd,Ol.FLOAT,function(e,t){return e[2<arguments.length&&void 0!==arguments[2]?arguments[2]:0]}),s(Sd,Ol.FLOAT2,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Mi.fromArray(t,e,i)}),s(Sd,Ol.FLOAT3,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Fi.fromArray(t,e,i)}),s(Sd,Ol.FLOAT4,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Wi.fromArray(t,e,i)}),s(Sd,Ol.MAT3,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return rn.fromArray(t,e,i)}),s(Sd,Ol.MAT4,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return zn.fromArray(t,e,i)}),Sd),Fd=(s(wd={},Ol.INT,[0]),s(wd,Ol.INT2,[0,0]),s(wd,Ol.INT3,[0,0,0]),s(wd,Ol.INT4,[0,0,0,0]),s(wd,Ol.FLOAT,[0]),s(wd,Ol.FLOAT2,[0,0]),s(wd,Ol.FLOAT3,[0,0,0]),s(wd,Ol.FLOAT4,[0,0,0,0]),s(wd,Ol.MAT3,[1,0,0,0,1,0,0,0,1]),s(wd,Ol.MAT4,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),s(wd,Ol.SAMPLER2D,"default-texture"),s(wd,Ol.SAMPLER_CUBE,"default-cube-texture"),wd),Nd=4026531840,Ud=264241152,Vd=function(){function f(e){y(this,f),this._buffers={},this._samplers={},this._textureViews={},this._resources=[],this._phase=0,this._idxInTech=0,this._programName="",this._priority=Xh.DEFAULT,this._primitive=Gl.TRIANGLE_LIST,this._stage=jh.DEFAULT,this._bindings=[],this._bs=new Vf,this._dss=new Wf,this._rs=new jf,this._dynamicStates=[],this._dynamics={},this._customizations=[],this._handleMap={},this._blocks=[],this._shaderInfo=null,this._defines={},this._properties={},this._device=void 0,this._renderPass=null,this._shader=null,this._batchedBuffer=null,this._device=e}return l(f,null,[{key:"createPasses",value:function(e,t){var i=t.techIdx,n=t.defines,r=t.states,a=e.techniques[i||0];if(!a)return[];for(var s=a.passes.length,o=[],l=0;l<s;++l){var c=a.passes[l],u=c.curDefs=n.length>l?n[l]:{};if(!c.switch||u[c.switch]){c.states=r.length>l?r[l]:{},c.idxInTech=l;var h=new f(cc.game._gfxDevice);h.initialize(c),o.push(h)}}return o}}]),l(f,[{key:"initialize",value:function(e){var n=this;this._idxInTech=e.idxInTech,this._programName=e.program,this._defines=e.curDefs,this._shaderInfo=Id.getTemplate(e.program),this._properties=e.properties||this._properties;var r=this._device;this._fillinPipelineInfo(e),this._fillinPipelineInfo(e.states);function t(){if(s){if(o>=a.length)return"break";l=a[o++]}else{if((o=a.next()).done)return"break";l=o.value}var i=l;if(Zh(i.binding))return"continue";var e=i.members.reduce(function(e,t){return e+$c(t.type)*t.count},0);n._buffers[i.binding]=r.createBuffer({memUsage:Pl.HOST|Pl.DEVICE,size:16*Math.ceil(e/16),usage:zl.UNIFORM|zl.TRANSFER_DST});var t=new ArrayBuffer(e);n._blocks[i.binding]={buffer:t,dirty:!1,view:new Float32Array(t)},i.members.reduce(function(e,t){return n._handleMap[t.name]=Ld(wc.UNIFORM_BUFFER,i.binding,t.type,e),e+($c(t.type)>>2)*t.count},0)}var a=this._shaderInfo.blocks,s=Array.isArray(a),o=0;e:for(a=s?a:a[Symbol.iterator]();;){var l;switch(t()){case"break":break e;case"continue":continue}}var i=this._shaderInfo.samplers,c=Array.isArray(i),u=0;for(i=c?i:i[Symbol.iterator]();;){var h;if(c){if(u>=i.length)break;h=i[u++]}else{if((u=i.next()).done)break;h=u.value}var f=h;this._handleMap[f.name]=Ld(wc.SAMPLER,f.binding,f.type)}this.resetUBOs(),this.resetTextures(),this.tryCompile()}},{key:"getHandle",value:function(e,t,i){var n=1<arguments.length&&void 0!==t?t:0,r=2<arguments.length&&void 0!==i?i:Ol.UNKNOWN,a=this._handleMap[e];if(a)return r?a=Bd(a,r):n&&(a=Bd(a,zd(a)-n)),a+n}},{key:"getBinding",value:function(e){var t=this.getHandle(e);if(void 0!==t)return f.getBindingFromHandle(t)}},{key:"setUniform",value:function(e,t){var i=f.getBindingFromHandle(e),n=f.getTypeFromHandle(e),r=f.getOffsetFromHandle(e),a=this._blocks[i];Pd[n](a.view,t,r),a.dirty=!0}},{key:"getUniform",value:function(e,t){var i=f.getBindingFromHandle(e),n=f.getTypeFromHandle(e),r=f.getOffsetFromHandle(e),a=this._blocks[i];return Dd[n](a.view,t,r)}},{key:"setUniformArray",value:function(e,t){for(var i=f.getBindingFromHandle(e),n=f.getTypeFromHandle(e),r=$c(n)>>2,a=this._blocks[i],s=f.getOffsetFromHandle(e),o=0;o<t.length;o++,s+=r)null!==t[o]&&Pd[n](a.view,t[o],s);a.dirty=!0}},{key:"bindBuffer",value:function(e,t){if(this._buffers[e]!==t){this._buffers[e]=t;for(var i=this._resources.length,n=0;n<i;n++){this._resources[n].bindingLayout.bindBuffer(e,t)}}}},{key:"bindTextureView",value:function(e,t){if(this._textureViews[e]!==t){this._textureViews[e]=t;for(var i=this._resources.length,n=0;n<i;n++){this._resources[n].bindingLayout.bindTextureView(e,t)}}}},{key:"bindSampler",value:function(e,t){if(this._samplers[e]!==t){this._samplers[e]=t;for(var i=this._resources.length,n=0;n<i;n++){this._resources[n].bindingLayout.bindSampler(e,t)}}}},{key:"setDynamicState",value:function(e,t){var i=this._dynamics[e];i&&i.value===t||(i.value=t,i.dirty=!0)}},{key:"overridePipelineStates",value:function(e,t){this._bs=new Vf,this._dss=new Wf,this._rs=new jf,this._fillinPipelineInfo(e),this._fillinPipelineInfo(t)}},{key:"update",value:function(){for(var e=this._blocks.length,t=0;t<e;t++){var i=this._blocks[t];i.dirty&&(this._buffers[t].update(i.buffer),i.dirty=!1)}for(var n=cc.director.root.pipeline.globalBindings,r=this._shaderInfo.builtins.globals,a=r.samplers.length,s=0;s<a;s++){var o=r.samplers[s],l=n.get(o.name);l.sampler&&this.bindSampler(l.samplerInfo.binding,l.sampler),this.bindTextureView(l.samplerInfo.binding,l.textureView)}}},{key:"destroy",value:function(){var e=this._shaderInfo.blocks,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;Zh(r.binding)||this._buffers[r.binding].destroy()}this._buffers={},this._samplers={},this._textureViews={},this._batchedBuffer&&(this._batchedBuffer.destroy(),this._batchedBuffer=null)}},{key:"resetUBOs",value:function(){var e=this._shaderInfo.blocks,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;if(!Zh(r.binding)){for(var a=this._blocks[r.binding],s=0,o=0;o<r.members.length;o++){for(var l=r.members[o],c=this._properties[l.name],u=c&&c.value,h=u||Fd[l.type],f=$c(l.type)>>2,d=0;d<l.count;d++)a.view.set(h,s+d*f);s+=f*l.count}a.dirty=!0}}}},{key:"resetTextures",value:function(){var e=this._shaderInfo.samplers,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;if(!Zh(r.binding)){var a=this._properties[r.name],s=a&&a.value?a.value+"-texture":Fd[r.type],o=kd.get(s),l=o&&o.getGFXTextureView();if(l){this._textureViews[r.binding]=l;for(var c=a&&void 0!==a.samplerHash?a.samplerHash:o.getSamplerHash(),u=this._samplers[r.binding]=nh.getSampler(this._device,c),h=0;h<this._resources.length;h++){var f=this._resources[h];f.bindingLayout.bindSampler(r.binding,u),f.bindingLayout.bindTextureView(r.binding,l)}}else console.warn("illegal texture default value: "+s)}}}},{key:"tryCompile",value:function(e){var i=this;e&&Object.assign(this._defines,e);var t=cc.director.root.pipeline;return!!t&&(this._renderPass=t.getRenderPass(this._stage),this._renderPass?(this._shader=Id.getGFXShader(this._device,this._programName,this._defines,t),this._shader?(this._bindings=this._shaderInfo.blocks.reduce(function(e,t){return t.defines.every(function(e){return i._defines[e]})&&e.push({name:t.name,binding:t.binding,type:wc.UNIFORM_BUFFER}),e},[]).concat(this._shaderInfo.samplers.reduce(function(e,t){return t.defines.every(function(e){return i._defines[e]})&&e.push({name:t.name,binding:t.binding,type:wc.SAMPLER}),e},[])),!0):(console.warn("create shader ".concat(this._programName," failed")),!1)):(console.warn("illegal pass stage."),!1))}},{key:"createPipelineState",value:function(){if(!(this._renderPass&&this._shader&&this._bindings.length||this.tryCompile()))return console.warn("pass resources not complete, create PSO failed"),null;for(var e=this._device.createBindingLayout({bindings:this._bindings}),t=0,i=Object.keys(this._buffers);t<i.length;t++){var n=i[t];e.bindBuffer(parseInt(n),this._buffers[n])}for(var r=0,a=Object.keys(this._samplers);r<a.length;r++){var s=a[r];e.bindSampler(parseInt(s),this._samplers[s])}for(var o=0,l=Object.keys(this._textureViews);o<l.length;o++){var c=l[o];e.bindTextureView(parseInt(c),this._textureViews[c])}var u=cc.director.root.pipeline.globalBindings,h=this._shaderInfo.builtins.globals,f=h.blocks,d=Array.isArray(f),p=0;for(f=d?f:f[Symbol.iterator]();;){var _;if(d){if(p>=f.length)break;_=f[p++]}else{if((p=f.next()).done)break;_=p.value}var v=_,m=u.get(v.name);m&&m.type===wc.UNIFORM_BUFFER?e.bindBuffer(m.blockInfo.binding,m.buffer):console.warn("builtin UBO '".concat(v.name,"' not available!"))}var y=h.samplers,g=Array.isArray(y),b=0;for(y=g?y:y[Symbol.iterator]();;){var x;if(g){if(b>=y.length)break;x=y[b++]}else{if((b=y.next()).done)break;x=b.value}var S=x,w=u.get(S.name);w&&w.type===wc.SAMPLER?(w.sampler&&e.bindSampler(w.samplerInfo.binding,w.sampler),e.bindTextureView(w.samplerInfo.binding,w.textureView)):console.warn("builtin texture '".concat(S.name,"' not available!"))}var T=this._device.createPipelineLayout({layouts:[e]}),E=this._device.createPipelineState({bs:this._bs,dss:this._dss,dynamicStates:this._dynamicStates,is:new Gf,layout:T,primitive:this._primitive,renderPass:this._renderPass,rs:this._rs,shader:this._shader});return this._resources.push({bindingLayout:e,pipelineLayout:T,pipelineState:E}),E}},{key:"destroyPipelineState",value:function(t){var e=this._resources.findIndex(function(e){return e.pipelineState===t});if(0<=e){var i=this._resources[e],n=i.bindingLayout,r=i.pipelineLayout,a=i.pipelineState;n.destroy(),r.destroy(),a.destroy(),this._resources.splice(e,1)}}},{key:"serializePipelineStates",value:function(){var e=Id.getKey(this._programName,this._defines),t="".concat(e,",").concat(this._stage,",").concat(this._primitive);return t+=rp(this._bs),t+=sp(this._dss),t+=ap(this._rs)}},{key:"createBatchedBuffer",value:function(){this._batchedBuffer||(this._batchedBuffer=new Rd(this))}},{key:"destroyBatchedBuffer",value:function(){this._batchedBuffer&&(this._batchedBuffer.destroy(),this._batchedBuffer=null)}},{key:"clearBatchedBuffer",value:function(){if(this._batchedBuffer){var e=new ef;this._batchedBuffer.ubo.update(e.view.buffer)}}},{key:"_fillinPipelineInfo",value:function(e){if(void 0!==e.priority&&(this._priority=e.priority),void 0!==e.primitive&&(this._primitive=e.primitive),void 0!==e.stage&&(this._stage=e.stage),void 0!==e.dynamics&&(this._dynamicStates=e.dynamics),e.customizations&&(this._customizations=e.customizations),0===this._phase){var t=e.phase||"default";this._phase=Od(t)}var i=this._bs;if(e.blendState){var n=Object.assign({},e.blendState);n.targets&&n.targets.forEach(function(e,t){return Object.assign(i.targets[t]||(i.targets[t]=new Xf),e)}),delete n.targets,Object.assign(i,n)}Object.assign(this._rs,e.rasterizerState),Object.assign(this._dss,e.depthStencilState)}},{key:"device",get:function(){return this._device}},{key:"idxInTech",get:function(){return this._idxInTech}},{key:"programName",get:function(){return this._programName}},{key:"priority",get:function(){return this._priority}},{key:"primitive",get:function(){return this._primitive}},{key:"stage",get:function(){return this._stage}},{key:"phase",get:function(){return this._phase}},{key:"bindings",get:function(){return this._bindings}},{key:"blendState",get:function(){return this._bs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"rasterizerState",get:function(){return this._rs}},{key:"dynamics",get:function(){return this._dynamics}},{key:"customizations",get:function(){return this._customizations}},{key:"shader",get:function(){return this._shader}},{key:"batchedBuffer",get:function(){return this._batchedBuffer}},{key:"shaderInfo",get:function(){return this._shaderInfo}},{key:"properties",get:function(){return this._properties}}]),f}();Vd.getBindingTypeFromHandle=function(e){return(e&Nd)>>>28},Vd.getTypeFromHandle=zd,Vd.getBindingFromHandle=function(e){return(4177920&e)>>>14},Vd.getOffsetFromHandle=function(e){return 16383&e};var Gd,Hd,qd,jd,Wd,Xd,Yd,Qd,Kd,Zd,Jd,$d,ep,tp,ip,np,rp=function(e){var t=",bs,".concat(e.isA2C,",").concat(e.blendColor),i=e.targets,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;t+=",bt,".concat(s.blend,",").concat(s.blendEq,",").concat(s.blendAlphaEq,",").concat(s.blendColorMask),t+=",".concat(s.blendSrc,",").concat(s.blendDst,",").concat(s.blendSrcAlpha,",").concat(s.blendDstAlpha)}return t},ap=function(e){return",rs,".concat(e.cullMode,",").concat(e.depthBias,",").concat(e.isFrontFaceCCW)},sp=function(e){var t=",dss,".concat(e.depthTest,",").concat(e.depthWrite,",").concat(e.depthFunc);return t+=",".concat(e.stencilTestFront,",").concat(e.stencilFuncFront,",").concat(e.stencilRefFront,",").concat(e.stencilReadMaskFront),t+=",".concat(e.stencilFailOpFront,",").concat(e.stencilZFailOpFront,",").concat(e.stencilPassOpFront,",").concat(e.stencilWriteMaskFront),t+=",".concat(e.stencilTestBack,",").concat(e.stencilFuncBack,",").concat(e.stencilRefBack,",").concat(e.stencilReadMaskBack),t+=",".concat(e.stencilFailOpBack,",").concat(e.stencilZFailOpBack,",").concat(e.stencilPassOpBack,",").concat(e.stencilWriteMaskBack)},op={},lp=P2("EffectAsset",ho("cc.EffectAsset")((Yd=Xd=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"techniques",qd,u(t)),v(t,"shaders",jd,u(t)),v(t,"combinations",Wd,u(t)),t}return p(a,Mu),l(a,[{key:"onLoaded",value:function(){this.shaders.forEach(function(e){return Id.define(e)}),cc.game.once(cc.Game.EVENT_ENGINE_INITED,this._precompile,this),a.register(this)}},{key:"_precompile",value:function(){for(var i=this,n=cc.director.root,e=function(e){var t=i.shaders[e],a=i.combinations[e];if(!a)return"continue";Object.keys(a).reduce(function(e,r){return e.reduce(function(e,t){var i=a[r],n=[t].concat(c(Array(i.length-1)).map(function(){return Object.assign({},t)}));return n.forEach(function(e,t){return e[r]=i[t]}),e.concat(n)},[])},[{}]).forEach(function(e){return Id.getGFXShader(n.device,t.name,e,n.pipeline)})},t=0;t<this.shaders.length;t++)e(t)}}],[{key:"register",value:function(e){op[e.name]=e}},{key:"remove",value:function(e){if(op[e])delete op[e];else for(var t in op)if(op[t]._uuid===e)return void delete op[t]}},{key:"get",value:function(e){if(op[e])return op[e];for(var t in op)if(op[t]._uuid===e)return op[t];return null}},{key:"getAll",value:function(){return op}}]),a}(),Xd._effects={},qd=m((Hd=Yd).prototype,"techniques",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),jd=m(Hd.prototype,"shaders",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Wd=m(Hd.prototype,"combinations",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Gd=Hd))||Gd);cc.EffectAsset=lp;var cp=P2("Material",(Qd=ho("cc.Material"),Kd=fo(lp),Qd(($d=m((Jd=function(){function r(){var e;return y(this,r),v(e=x(this,g(r).call(this)),"_effectAsset",$d,u(e)),v(e,"_techIdx",ep,u(e)),v(e,"_defines",tp,u(e)),v(e,"_states",ip,u(e)),v(e,"_props",np,u(e)),e._passes=[],e._owner=null,e._hash=0,e.loaded=!1,e}return p(r,Mu),l(r,[{key:"effectAsset",get:function(){return this._effectAsset}},{key:"effectName",get:function(){return this._effectAsset?this._effectAsset.name:""}},{key:"technique",get:function(){return this._techIdx}},{key:"passes",get:function(){return this._passes}},{key:"hash",get:function(){return this._hash}}],[{key:"getInstantiatedMaterial",value:function(e,t,i){if(e._owner===t)return e;var n=new r;return n.copy(e),n._native=e._native+" (Instance)",n._owner=t,i&&(n._uuid=e._uuid),n}}]),l(r,[{key:"reset",value:function(e){this._defines||(this._defines=[]),this._states||(this._states=[]),this._props||(this._props=[]),void 0!==e.technique&&(this._techIdx=e.technique),e.effectAsset?this._effectAsset=e.effectAsset:e.effectName&&(this._effectAsset=lp.get(e.effectName)),e.defines&&this._prepareInfo(e.defines,this._defines),e.states&&this._prepareInfo(e.states,this._states),this._update()}},{key:"initialize",value:function(e){this.reset(e)}},{key:"destroy",value:function(){if(this._passes&&this._passes.length){var e=this._passes,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}}return this._passes=[],this._effectAsset=null,this._props=[],this._defines=[],this._states=[],_(g(r.prototype),"destroy",this).call(this)}},{key:"resetUniforms",value:function(e){var t=!(0<arguments.length&&void 0!==e)||e;this._props.length=this._passes.length;for(var i=0;i<this._props.length;i++)this._props[i]={};if(t){var n=this._passes,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;o.resetUBOs(),o.resetTextures()}}}},{key:"recompileShaders",value:function(e,t){if(this._passes&&this._effectAsset){if(void 0===t){var i=this._passes,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}a.tryCompile(e)}}else this._passes[t].tryCompile(e);this._onPassesChange()}}},{key:"overridePipelineStates",value:function(e,t){if(this._passes&&this._effectAsset){var i=this._effectAsset.techniques[this._techIdx].passes;if(void 0===t)for(var n=0;n<this._passes.length;n++){var r=this._passes[n];this._states[n]=e,r.overridePipelineStates(i[r.idxInTech],e)}else this._states[t]=e,this._passes[t].overridePipelineStates(i[t],e);this._onPassesChange()}}},{key:"onLoaded",value:function(){this._update(),this.loaded=!0,this.emit("load")}},{key:"setProperty",value:function(e,t,i){var n=!1;if(void 0===i)for(var r=this._passes,a=r.length,s=0;s<a;s++){var o=r[s];this._uploadProperty(o,e,t)&&(this._props[s][e]=t,n=!0)}else{if(i>=this._passes.length)return void console.warn("illegal pass index: ".concat(i,"."));var l=this._passes[i];this._uploadProperty(l,e,t)&&(this._props[i][e]=t,n=!0)}n||console.warn("illegal property name: ".concat(e,"."))}},{key:"getProperty",value:function(e,t){if(void 0===t)for(var i=this._props,n=i.length,r=0;r<n;r++)for(var a=i[r],s=0,o=Object.keys(a);s<o.length;s++){var l=o[s];if(l===e)return a[l]}else{if(t>=this._props.length)return console.warn("illegal pass index: ".concat(t,".")),null;for(var c=this._props[t],u=0,h=Object.keys(c);u<h.length;u++){var f=h[u];if(f===e)return c[f]}}return null}},{key:"copy",value:function(e){this._techIdx=e._techIdx,this._props.length=e._props.length;for(var t=0;t<e._props.length;t++)this._props[t]=Object.assign({},e._props[t]);this._defines.length=e._defines.length;for(var i=0;i<e._defines.length;i++)this._defines[i]=Object.assign({},e._defines[i]);this._states.length=e._states.length;for(var n=0;n<e._states.length;n++)this._states[n]=Object.assign({},e._states[n]);this._effectAsset=e._effectAsset,this._update()}},{key:"_prepareInfo",value:function(e,t){if(!Array.isArray(e)){var i=this._effectAsset?this._effectAsset.techniques[this._techIdx].passes.length:1;e=Array(i).fill(e)}for(var n=0;n<e.length;++n)Object.assign(t[n]||(t[n]={}),e[n])}},{key:"_update",value:function(e){var s=this,t=!(0<arguments.length&&void 0!==e)||e;if(this._effectAsset){if(this._passes&&this._passes.length){var i=this._passes,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}a.destroy()}}this._passes=Vd.createPasses(this._effectAsset,{techIdx:this._techIdx,defines:this._defines,states:this._states});var o=this._effectAsset.techniques[this._techIdx].passes.length;if(this._props.length=o,t)this._passes.forEach(function(e,t){var i=s._props[e.idxInTech];i=i||(s._props[t]={});for(var n=0,r=Object.keys(i);n<r.length;n++){var a=r[n];i[a]&&s._uploadProperty(e,a,i[a])}});else for(var l=0;l<this._props.length;l++)this._props[l]={}}else{var c=kd.get("missing-effect-material");c&&(this._passes=c._passes.slice())}this._onPassesChange()}},{key:"_uploadProperty",value:function(e,t,i){var n=e.getHandle(t);if(void 0===n)return!1;var r=Vd.getBindingTypeFromHandle(n);if(r===wc.UNIFORM_BUFFER)Array.isArray(i)?e.setUniformArray(n,i):e.setUniform(n,i);else if(r===wc.SAMPLER){var a=Vd.getBindingFromHandle(n);if(i instanceof td)e.bindTextureView(a,i);else if(i instanceof ah||i instanceof Eh){var s=i.getGFXTextureView();if(!s||!s.texture.width||!s.texture.height)return!1;e.bindTextureView(a,s),i instanceof ah&&e.bindSampler(a,nh.getSampler(cc.game._gfxDevice,i.getSamplerHash()))}}return!0}},{key:"_onPassesChange",value:function(){var t=this,e="",i=this._passes,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}e+=a.serializePipelineStates()}if(this._hash=au(e,666),this._owner){var s=this._owner,o=s.sharedMaterials.findIndex(function(e){return e===t});0<=o&&s._onRebuildPSO(o,this)}}}]),r}()).prototype,"_effectAsset",[Kd],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ep=m(Jd.prototype,"_techIdx",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),tp=m(Jd.prototype,"_defines",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ip=m(Jd.prototype,"_states",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),np=m(Jd.prototype,"_props",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Zd=Jd))||Zd));function up(e){return e*e}function hp(e){return e*(2-e)}function fp(e){return e*e*e}function dp(e){return--e*e*e+1}function pp(e){return e*e*e*e}function _p(e){return 1- --e*e*e*e}function vp(e){return e*e*e*e*e}function mp(e){return--e*e*e*e*e+1}function yp(e){return 1-Math.cos(e*Math.PI/2)}function gp(e){return Math.sin(e*Math.PI/2)}function bp(e){return 0===e?0:Math.pow(1024,e-1)}function xp(e){return 1===e?1:1-Math.pow(2,-10*e)}function Sp(e){return 1-Math.sqrt(1-e*e)}function wp(e){return Math.sqrt(1- --e*e)}function Tp(e){return e*e*(2.70158*e-1.70158)}function Ep(e){return--e*e*(2.70158*e+1.70158)+1}function Cp(e){return 1-Ap(1-e)}function Ap(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375}cc.Material=cp;var kp=Dp(up,hp),Rp=Dp(fp,dp),Op=Dp(pp,_p),Mp=Dp(vp,mp),Ip=Dp(yp,gp),Lp=Dp(bp,xp),zp=Dp(Sp,wp),Bp=Dp(Tp,Ep),Pp=Dp(Cp,Ap);function Dp(t,i){return function(e){return e<.5?i(2*e)/2:t(2*e-1)/2+.5}}var Fp=Object.freeze({constant:function(){return 0},linear:function(e){return e},quadIn:up,quadOut:hp,quadInOut:function(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)},cubicIn:fp,cubicOut:dp,cubicInOut:function(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)},quartIn:pp,quartOut:_p,quartInOut:function(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)},quintIn:vp,quintOut:mp,quintInOut:function(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)},sineIn:yp,sineOut:gp,sineInOut:function(e){return.5*(1-Math.cos(Math.PI*e))},expoIn:bp,expoOut:xp,expoInOut:function(e){return 0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(2-Math.pow(2,-10*(e-1)))},circIn:Sp,circOut:wp,circInOut:function(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)},elasticIn:function(e){var t,i=.1;return 0===e?0:1===e?1:(t=!i||i<1?(i=1,.1):.4*Math.asin(1/i)/(2*Math.PI),-i*Math.pow(2,10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/.4))},elasticOut:function(e){var t,i=.1;return 0===e?0:1===e?1:(t=!i||i<1?(i=1,.1):.4*Math.asin(1/i)/(2*Math.PI),i*Math.pow(2,-10*e)*Math.sin((e-t)*(2*Math.PI)/.4)+1)},elasticInOut:function(e){var t,i=.1;return 0===e?0:1===e?1:(t=!i||i<1?(i=1,.1):.4*Math.asin(1/i)/(2*Math.PI),(e*=2)<1?i*Math.pow(2,10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/.4)*-.5:i*Math.pow(2,-10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/.4)*.5+1)},backIn:Tp,backOut:Ep,backInOut:function(e){var t=2.5949095;return(e*=2)<1?e*e*((1+t)*e-t)*.5:.5*((e-=2)*e*((1+t)*e+t)+2)},bounceIn:Cp,bounceOut:Ap,bounceInOut:function(e){return e<.5?.5*Cp(2*e):.5*Ap(2*e-1)+.5},smooth:function(e){return e<=0?0:1<=e?1:e*e*(3-2*e)},fade:function(e){return e<=0?0:1<=e?1:e*e*e*(e*(6*e-15)+10)},quadOutIn:kp,cubicOutIn:Rp,quartOutIn:Op,quintOutIn:Mp,sineOutIn:Ip,expoOutIn:Lp,circOutIn:zp,backOutIn:Bp,bounceOutIn:Pp});P2("easing",Fp);var Np="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADqCAYAAADnPAqjAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAFbVSURBVHhe7X0HgBRF9vfrns2wu4Ql55xzBhMiiAqCqICoKGI6vVP/oud5gLiC9x2nnOE805kAAQkCAookEYkqKjnnvGR2F9g03d97r6pnemZ6ZmeX3ZnZ2fnNvKmqV9U9Fd6r1NVVCkRQ5NB13XblypWqiqLUtdlstdFdU1H0aroOVZCXgu4Kiq4ng6KWxdAJeEkcUjT6qfJ6DY1cpCykK8jI1BXlkgLKeR30s4oOabqin1QUOGa3w5G4uLiDeG0akp2uj6DoEFGQawAKsoqKUB2VoC1KdmtN11sitzl6NUFhJaEPGDAuWaAou0CHnaDo2wC0LTExCX9gPFCRFFK4CAqBiIIUANqePbF5NWt21FS4TtGVbph73ZBdWfiGJrDVOq2Avh7N9agla+Lj439FhcmR3hHkg4iC+AC1EJcvX24VFaX2AU3vjTV0D2RTl6jEAtN0BQt9LRb9MsVmWxITE7Mt0sJ4R0RB3KBpWmx2dvaN2McfiH39O5FVQ/hcO1A4IS8vD7KysgG7ZnA1OxtykHJz8yBPs4Ou6RxOURWIUm0QHR0FMbGxEI+UkJAAcXGxEBUVhXpapMV2HKO1ANM9v0yZMj9GWhdXRBQEgYJry8zM7IljiaHovBuFpJzwKThyc3Mh7cwZOJV2Gs2zcPbcOTh3/gKcu3ARLly8BDk5OWDXCldh21QVsMaHCuWSoUL58lCxQjmoVLEiVK6UAlWrVIYqlSqhUkXL0IXCBcyLuZj+GTjwJ2Up9YP+Uq0gWVlZTVAgHkZ6EJ0FbimwpYEjR4/BgSNH4TDSkWPHWSkKqwDXCptNhSopKVC7Zk2oW7sm1KtdG2rXqgGx2AIVAtiy6FOxxfsiOTl5t+SVOpQ6BcFCj7l69epAXdeewuTfgL0Vv/OAFGLv/oOwc89e2L3vABxC5cCuifQNTVCrU6dWTWjSsAE0a9wQGjWoVyCFwe4X9ftWYWvyPg7wvyltXbBSoyCXLl2qGB1tewJAfRqLvbpk54szZ8/Bpq3bYcu2HbB7/34cQ5TsXgeNYZo0qA9tWjaHtq1aQEpKRenjD/QTmH/vYTfyY2xVzklmWCPsFQQHw7Wxlh+lqspITG4ZyfaJ0ziG+PX3TUxHjqNMhCmo8GvVqA6d2rdlqoxjGH+ArfBlbEk+QeukhISEo4IbnghbBcFuVF27rr+MpTlCVZR8R640q/QLKsTaDb/A/kOHJbd0oWG9OtCjS2dUlnaQkBAvud6BipKDivI5dj3/Wb58+UOSHVYIOwXJzMysiqOCMZiwx7HwfCsG9q4PHTkCK1evZeWgGagIAGKio6Fzh3Zw03XdcbBfO18pIUXRNfgYhzuvly1b9pRkhwXCRkHS0tLKlilTZhQOKl9ExfDZlbLb7fD7ps2wbOUqOHD4iOQWA+h5BUaoJKN+3TrQu+eN0L5Na7DZbJLrFZmY4DcyMjImVatW7bLklWiUeAXB2kvFVuM+tE7E1Picqs3JycUu1M+wZMWPcPb8BcktPnTBfv0vf2ymOEpOyUVKhfJwa6+e0KNrZ4iJyadh1vXjGigvJZctOwMrqxL9lL5EKwjWVK0wCe+j9TrBsQZ1nVatXQeLl/0AlzIyJLf40a1TB55e/WLGLMkp+UhOSoTbb+kFN/Tolu9DSU3T1+TlwVMVKyZulawShxKpIJqmxaNyjMMuzCisoaIk2wP0jGIdDroXLF4KFy5dktzAIS42Bj586w34dskymP3NIskND5Qvlwx33nYrdO/SCVQcfHiFDrm6ApMSy5R5DcNdldwSgxKnIOnp6TegQVOMjZjhBdt27ITZ8xfBibQ0yQkOnhr5MFzfvStMxVbku+U/SG74oHrVKnDvgP7QsnlTyfGKvUgjk5KSVgtnyUCJUZAjR47EJ5Ur9zp2cJ/DVsNrvM+cOQszvp4PW1FBQgH0QO7l55/FaGvw4WeTsau3QfqEF1q3aAZDBw2ESpVSJMcCmAm6orydfvHimNq1a5eI1qREKAh2p1rb7dp07FK1kCwP0CrZ77GG/m7ZCshFe6iAlnp8+O+JkJiYiF0+O7z9wf94SjkcER0VBbf3uQX64mCenth7h75Ns9vvr1ChwhbJCFmEtILouq5cunTpKTQmYaPhdQHR/oMHYfJXs+Bk2mnJCS2MGDYEbu11E9tpafsb7/4XtuzYxe5wRPUqVWD40MHQoF5dyfEElm0Wlumo5OTED9AM2Wm+kFWQs2e1pKiojE8xivdIlgdoduqb7xbD0h9XUYZLbuihUf16MH70S9IlFj1OePNt2HvgoOSEH6gX3OemG2HA7bflM9ulz87Ly300JSUlXTJCCiGpIGfPnm1us8XMxcxrIlkeOHbiBHwydRqcOBX6D25pwfA7/3zNZa1TZuZleO1fk8J6rRehetWq8OiD90PN6t7Xh2LltlvT1LtSUpJCY+BoQsgpyPnz5wfoijoVa6BEyXIBtRQ/rl4Lc75ZGFJjjfwwZGB/GHTnHWw3WruLly7Bq/+cBKdOn2F3uILGJvdg+nte14OaFsn1QDpK44MVkpMXSHdIwMcEdmCBQqOgcvwNM3CuCnqiomvgTllXrsBHn02GGV/PK1HKQVj786/S5kS55GQY/fwzUKFcoV9gLBGgspoxZx589PlkyLp6xaNcJSWB3T7v3LlzfyVZkJcGHSGhIBs3boy+cOHC/7B6+X+gg0oVrDudOJkGr//7Hfh9S8l8KHvs5Cl+69Ad9D7G3//vL5BY1q+V+CUav23eCq9PeofL0qqMsfxVRVEnXrhw6WNUEl/TYAFD0DUVM6LsuQsXZmM/va9keWDz1m3w2bSvIAsHtyUZ/W69BR4YfLd0CRgbNRw4dBgmoPBczaK94sIbcbGx8MgD90Gbll5n7bGe1Bfbc3MHV6lSJVOygoKgKkh6enpKdp79W4xEZ8nywNIVK2HuosWkSJJTclGhfDn47xuvO5dmcM0p0kW/O3btgonvfAA5pWDZPc1yDep/O/S5WUx/WwHz5OcYm3pHMN9eDFoX6/TpzGqoHD96Uw5aR/XlzDnw9cLvwkI5COcvXISdu2nFhYBLutDevEljePaJR3jzhXAHpf3rBd/CtFlzuKytgLLRJceurTp9+nQ1yQo4glISOBCrpdhyVmEV0YJkxJ2ys3Pgg0+/gNXrf5ZXhA/WbPhFWDCdrhCMdq1bwpMPP8A1bGnAT+t+hg8/nczbIVnJAsuIGrXq7NmzNcUVgUXAS4GUQwPlR7TWFxxXXL16Fd7/32dh+xCtbEICfPTOG2BTnS8f8cYhLA1kCHPZyp/gi+kzPfUoTEEPU596bCTEx3vZ0ljX9yug35SSknJMcgKCgLYgZ86cqW7X4QcUgvokCO6UefkyvPXfj2APKoeoPMKP7DotwXeb8sW0u+OWm26Aewf2t7xHOBKV+VvvfwiXUQasZAPDNNBB+SHQ3a2AKQgNyDVQl6G1oeC4gpTjbVSOw8cCWkEEFDQ4b49dqCnY76Yn6QQuegkSBCd0GHD7rXBH717SHf44fPQYKslHqCRXJMcVmDuNdEVdRls4SVaxIyAKgi1H4tWc3O/Q2pxkwJ0uX7kC777/MRw7fgJo2Vq40l0o8AcPH4WM9EyYNvtrkTnId4fBIvO+e+6Cntd1t7xfONKxYyfgnQ8+4l1mrGQFQ7XIys77jvYgIFdxo9gVBGvFaLuuzsHEd6IBjzvRwr33PvwEjob5miTapK16tar8kIzw45r1sHvvPrRxqVM+scmQdoMz4v6h0KVDW+kKfxxFJXnvo095Y28rmVEU6Kwotjn0gBmdxYp8t6m4FmChK2lnzv4PE2W5Ipfe4fjg089g30EckHvkQvgQbS794jNPwSdTpsGljHTmUddq/8FDcPMN17m8smooBZvSQRNa7du2hoOHjsCps2dc7h2uRK9IHzpyFDq0bePtld6GyUnJNd58841iXbtVrC3ImTPnXlZAGSGdLtA1Db6Y8RXsxFqU5CBciZZ6P/Pko7Bn/344fPy4i99hbDW/XbrCrfVwMRygF5Ce/dOj0LhBfZd7hDPt3LuXZYRkxRKK8sipU6f/Ll3FgmJTkBNpaYPsmjaBCt+K5i78Fn79Y5OlX7gQlfLD9w3mzaPnydUA7jQH8+HcufOcZyQUxq9hmCx89MHzTz8JdWrUsLxXOBLJyNxF31r6MQGMP3XqzECZRUWOYlGQkydPtlR0dbLi5WnXmvUb+CUnLvswppuu6wY34gB76/ad2J06bBmGDtP5bPpMdEie0/AA8RPi47i7Vq1SZcc9wp2WrlzF+5lZAUVMxdH9lJMnz3lf2HUNKHIFOXjwYDlQouhlp7JWGr93335erh7uqF+nNjw8bAjb53+7mE1v2LhpC2z8YzPaSCLwVxgIh4VB+UdISkqEl557GiqWL8/u0gCSmb37D7jIkpMgUYe8efv3n0+WwYsMRaog48aNU2NjEz7Xda2RVULOX7gAH0+ZGrQDZgKFsmUScLzwGI8/du7eA7v27pc+3kGby9GMnqtKuAHzUJgAFStUgL9iS5JUNiCznUFHnt0OH0+eyjJkJVuIRnEJOZ+h3bLXUlgUqYI8/qen/6IrykAdFCxDV8rNs8P/pnwJGfIBWbhCxV7l048+DJXkuRvzFtLjn/xxBschcxZgX1u6PVsPaQqDhaJalcrwwl+ehIS4gJ44HTRkZGbCJyhDeXbNIVdmwtwfdOLUmb+I0EWDIlOQ48dPtwdN/xeXpAXNW7gIDtFG0RZ+4UR33dEX2rRqyXmyD7sE23butgxnRbQ1Kj0os4KsJdEiDApP1tq1asFzf3qcd2Q33ytc6SDK0LwFCy39JP3r2LHT7UQmXTuKREGOHz+eoCvaNLTGCI4rtmzbBj+uWStd4QvaJG7QgH7Sha3HIt9jD3dQN+LTqdOxjLGgTRBOoRDC5mo2alAf/vzoCH92Xw8L/Lh2HWzZvl26PBCLg/ZptD2tdF8TikRBdMU2EUuxKe0e6E4XL12EqbPmcGGGM6VUrABPP/YIzaqgC7i1/H3LNsuwvmjXvv2wyq0ycaiGNDBjpcVpbdWiGTz+0P38/8QKZ9Iw0V/Oms2bXljJHIZodvzEqX+h5ZpxzQpy6NixXrqmPS2dLqCa8MuvZvMKTXSELcVERcFzTz0OZU3vlc9biK2HRVh/aPrseZCRId40RY7gSxhuB8fkRydDDR9yD69pMu4VrkSLPafNnIVWdFvjqaNHT/aU9kLjmhRk27a0sjZQ/0fVFkXTnWjuesfuPZ4eYUYPDRvMB80YoEWXdL6hVVh/iCYyps2aiw50SgEQvwiT2ykbhkXnYwnuoe2FOEB40/Zde1jGLLzoAQk9H/lk06aT17QbxjUpSFK5vNfQqMcl5UYXzl/wewanJIMeBt584/XSJTAfWw8fNZtf+GndBti1Z5/IT4JxO3Q77mz6D4ciodG3dy+4vU/pWCY/f9F3cPHCRZFwdwKoX7GiRjJaaBRaQQ4dP94e4/AMRcOKvpo3H67kZIOGXfJwpTq1a8KIB+lwKydOnkqDtRt/swxfELJjLn6CA3Y6Lo7yk+DSmhhMp680yabDXf1vhxtRea3uHU50OTsbZsydx6m3JEV55uCxY4We1SrUtAcWlC3zUvo8BZRaGEeegTbTpi1bYfEPK9EWvqBXZ8e++BwkJcoNIOXgfNrMr+Ggxf5XhUF6RibERkdDk4byHTNUECp0tkqTYG49DFBs6EgCOtKa9uQKZ5w+exZqVq0C1SpX9pBFJFXRlTZJSYmfr1q1ypxtfqFQLcjRo8cf0kHpTP/mTlk5OTBnwSJRWmFKlPFPjXwIKqXQWRjkQiCfziahrpF7+Gsh2vLo7LlzaEU3/Q3/IqTbDL7EGQKjpsAj9w+F1s2aSs/wpTkLFkI2bfyAyXYnLKKuIx977CGyFhQFVpCzZ88m4T/+wzImSLSPVTCOOwskBtx2K7Rt3RKTq/OUo1ASBRYsXlLky2io0L+YPgvzlv5HwGk1LBgTp7czAJqqaoMnHxnOy+TDGecvXoIlKHucJVakwT/ozVa0FQgFVpDMK1l/00CvgoT/6Upnz5+H5T+tRpt1HMOBWjZrAncP6McySLU6ESkJrRH6YfU6y2uulWi71d82bWY7g/5cwqp7RTCF4DVhf37sYahTs4bjnuFIK1avgXNYDlayidVW1ctXs1/GYAVCgRRkz9GjNbEgnpNODyz8fkmJ21S6IKDVs0+NFO9/CeVgG5oaHxRaXGmnv5n81RzeetWpCIbF2XqgTVgIjvgJe1xsHDzz+EioWtl5BEO4gXakXPD999LlCSym544cOeLzqHB3FEhBojQYh38Tb9ScZjp27DhsxFqOCiMcKdpmg788NgLKlE0QLA1rJexOaWhevJQOy1f95HFNURK1zrQTIbslKN+FyYaAq0OqDJURQJkyZeC5J0ZCRdpNnhhhSPTaAD2HcpdPzitFj7frJMP+w28F2Xf0aCPsS4zgHLeghUuWikiEKYbdc5d4GEiZzY02ZTo5dfhu6XLIySn+/XSX/LASjmJFJDKd4Mxvio8Bl1Kg+JoYdOTCs6gkSYnhuUyeymMR9mQ4EywIvR/ec/hwA3T5Bb8VRLHDaFAUm8V/8sv123ftRlt4onvnjnDTDT2oHyuEDVsNrpWQQ0+9aRfEQMBu1+Dz6V+J/+aIyPgYMBzsL6xUQmQX8RVMWor/zGOP8NuJ4YhtKIuHjh7l1LoTSnK0TVfHstUP+KUgh1HjFF1/QDpdgf+6ePlyHqiGI9WsXg0eum8wp1MshpNihibRkhU/wJWsLMtri4N27z8AP65Zx1lPQBbGh2PEMNv442Swp+GuUa0aPPXIQziAj7L8n5JO36NMeoOiw7BDh07Wk06f8EtB8jTlRWo9pNMFx0+cwNaDTmylnA8vohr26UdHOA+hRDYpCBcCOq9cycJuD20z7HltcRKtUsjIyHATfulA08E32xniemHT+bXgx4ffD1FRVLSGX3gQtSInTp5EuwUUiLbruc5TVX0gXwXZv39/FVS5h2gi2YqW/0SbtIcfaNn4yAfug8opKShkJGiYSiOh7NZg2Y+reFfIQCPz8hWY/vU8Fn4SdANmG38kw9y9YpAViYxmjRvBiPvu5TchC4OqpoNJQwmU5mU/UuVlLbcY4KGTJ09WRodP5N+CqFFPga7E0au+7nThwiX4fXPInwVfKNx2c08+AclQDJ61IkGTUpedlQ3fY/cqWFjz86+wa6/zrBEGx8+wS9OA2U9qiEiLDm1btYRhdw/kSqGg6N+3Dx/SGYqg50cXL6ZjOj1lFxMbdyUrx/I1DTN8KsiRI0fiMQ//xDWQBa1evwHsfISYeJIcLtSsUUMYcMdtmEasa7ClIMIUSyETRCftZmRS62F9j+Imitvkr2bxYkZ2OMAxFSZHmdyGv+Fj2CTQ0bVTR7jr9r54Z+v/80atWzSH5k3otG5r/2ASTWr8tG69yAMLQtF9Ak3Lt2AN+FSQ7Oy8e/FOlZAop10oLzcX1v/6K0bD/Np8yacKyUl8rjdXpphOTi61HpoYoGMQyMnOge+W/2B5fSDpxMlTsHiZGIxitJyQ8XbA7OY0oFs6ndB56X7fm2+0/C8riouJhtq1amIL1NzSPxRow8ZfwU4PcGW6zaToepWDBw+LvZm8wHcXS1X/RBlpRZu3b+cjC8IJUTYbPIaD1rJlyrBSOGob9KM8NVoTajkvpaeLi4KMhd8v48WMFEGKo4Cwi7gbTGHSL9s4sMmXLwDo26snXN/V65GRLqBBPm2J2qal2KQiFEHT8Ju2eX/1OQ97SGh4hVcF2bV/f2vMta7S6YH1v3ie+13ScXf/O6BeHXozUGSfEBoyeVBHX8jNzYPFy1dw+FAALWacOnMOx43jzPFmLwEZb2EXZPY23OZr7sLuZcc2raXLOxo1FM/bGtSrG9JbD23Ano5XoIzv2LfPq4Z7VRCbJjedppxzo/NYY+09eNDI77Cgjm3bwPXdu2HypEAR4Q+7Ta3J+l82wtkLF12uDTZt2r4Dftu0CW3EkPFnGBZhoo+wcwDhIhgVAdv5F2DIXQOgZdMmxhWW1LiBUBBqRVrhWMQqTCgQHed34cIFdKDLjbAnrUTr6kgMZglLBaFzF7DOvF86PUBrrnQcANEoJxyoeuXKvJQEcwydRPKBIHoTj4jc1JflPr/FPYJN0+fMg6zsLBlnKnunAjDIgeTOY7a8yKwoqqrAA/cOgka0vMbi/4iaNnYeFsZnnluECQXSUFY3/v6HjKknUE2GYdotp+IsFSQxsVwfNCoZTyXdyVFbhQHi4mLh0eHDIBoHnFJcWFAonSxkgsU/v2Imnz4btCO7fYKOmKY9ADi+Boz4M5xpY5N5BLTJQE6eALUMD983BGrXqC45TtBaripYsRigA4JCGb9t3uwhxwbhp/KePftvlUFdYN3FUlXXF61NOHnqFJw6fUa6SjZo3v/+ewZBSsWKLDhOMeFMkxkoWhOaMqSdD0MZK1atgWN0BokodMk1p8oEdDAPw0onOcS10o8QGxsDjz54n8cy+Yb167k8N6lVsyaUTy7yvaOLDCfTTkMakjfoXmTeQ0Gwe5WAg9IBYt2RJ23Ztp0zMhyIzv6jeXwWFmyKxViDnQj6FQJDivLHlq2YyWnIEteGItEzkSlfzUarcJPBIJPcwuUwyeZQEEdgAtr5enFNfEI8K0mFcqgAFA7JGH8YIGXhVkT6hyJt2roVDWu5xkLut2fPnliZHAc8FKRMmeRb0PC6Fpq2fMS/K/FEMy/9bu2NmSObWWSyXT7voDBGaMrAxctWOK4NZdp/6DD8tNZYzEgc+pXpoUQ6eOTEX/Elh6vbAcFILFsWlWQYdr/Lsn/jhp6v8NKexOQXqrR1xw789QJFT7aDjYYWLvBQEF2BgVY3J7pw8RI/nCrpSE5MhOFD72W7EAqhBFSRUELdW5OtO3bC0RNeFr6FIOYu+o53RGFQAih9wiXADpE+thkWBIfk/DDxpL1i+XIw8oGhkBAfjwrSkPnmcDxQD2EcxzLk7UrRbkWKrnucVOWiIJhYGwbrZ3k10q49e9hakkEbPA8feg8/DKREGYUsiB4Ekok+NPtBrQmaoT72cMflK1dh9nxxtiWmhk1OlNMlndLNaUab4SnBvvTlwMK7SqVK/H57OepuSRj5V6lSClSvku/6v6CB4k/ntbDFgjAVt2M6XHTCxbF794H22IJUoorUininvxKO/rf2grp1alFmkFxIE4lbDGKQKbpZ6MUZeujoMXl1ycHPG38Xx0yLZDgh3Zw+djt9HXnhxhMWvor96tauLXgWoN1eQhkkw1ayLUipumv/fpdN5lwURAN7X9pk14p0HADu3bfPkYElkdq2bAbXde1C5cwFzx/pZxS+mag1+R5bD3d+SSCK+7RZX0NeXi67RYoF2M084lqDQ3MwZzi+DM147GIJmydo2YkRh1Ck/QcPoKDTOixrOdfscJtMCsNNQZRb8DaWn1NpafzmXElFFWz+77mzv0gNZhT+CJLpY6f0M1oTOgBnHw56SypOnj4DS35YJV0ITqO00K/MA06zw88J5Eom/ZCL3DrPaolrxAyQo8VF/5YtmrlM/4Ya6F2aU2mnZGo8P5gQmqRywKEgNL2L/l0ojBUdoFNagwR6qnstoLn84YPv5lOYnF0p+jpN/nChI0PaxduCJRuLl/8gdmaUbiNtwmYGZYTMA4dThhNeTLQ2gwbpnhDXJiclQr3atSQvNLH/wCGKriWhrnel1zzQxXAoSFxc2a4K6LEeV0g6eCR4CtLuGlaLUm12T/87ICVFPAyk5JApBuNSWAxCT/6glTai2L0v/8M3Qx20V9RXX88X6Ua3Iw/IE+0ubgdEPggm/RhuHSubWM5TI+/4cg7nRLsQH4cIWRbpcidF0WPT0690QwfD2cWKUntYXyLo8JHgnS/YqGF9qFurpqVfftSjcwdo2awpWkUhGwVL/VBfrcnSldh6sF/JJ3o/+4/NW7kkiUXgdEuItJOfk0cswyQ2EzrF+MMM4oprDWpN072Oi0KPjnjZ8cQg0gUyCA4F0ex6d3MizZSZmQnnLl6kZyRBIaqx+vS6ydLPF9HxBLf26omJpnSQTrimi3KDTPfW5NiJE7Bjz17Le5ZIwvKd+c0CuHoVx5CUTipwR3rJ4QT70pf82C3Bbhx/xOH4w6hcTBWMMyBA86aNwRZts45LCNB5lOUrV65w3C1J011bkFmzZtF+V13QDwN4UvAfDurQ8/oeBXr3ObFsGbhv0EAcv6iYBmfiHcpAH2l3b02Wr/xJ2MMItPvjwu+XCocpbS75IOGwk+nm5zH+4CDyHjIf4+LioInbUpRQAskAVYKULCvSNL0jpgdVSSpI49ata6OrPNmtQAsUFbwyWERILJsIXTu0t/R3J5uiwtCBd/KZgejEVNOXf9gknrfWhA7A2bJjp+V9Szr9tHa92JaTcxThsAhQ3oiv8KBfM1FLThMe7rNXnH/yGgZaaSMIqziECp30UeljOitt376dZxpEFytX83kCT9rp0645FQSiQujd80YPvhX1uel6qFOrlig4KkT6kJVNJ1m1Jj+sWsMtCrLCjui9CBqw66b1ZkxoN8Bcdgpf9mN/2gBbrOUzhzeHMytOfXozU3iFJLFM+0CernYkkxVEUW0+369MO33G6j8CRzLzW7dsDhUrlLcOI4n6v906d0K7LDTkoYV9pcF+hkk8Q1FoOvSPrQU/urkkEZ1+RQdfCiCHM4VsZCendEsvcjHhj3mALsrElcyoXLmi89oQpNP5vLJh6IRQEE1vQTWtJWFtc/bcWQoWVFAB0Hiil9uBmWakoPIMuL0vZgB+ZCsgCk+YlB7KHLbSh/0EkZL88NNaNsMdCxYvg3TamVG6DVCeCCb9cA6hIexE8Ti2MOcZkRlmfqWKFSU3NCE2urCQd0msEwhWEKydm+MPWTwoOzuLnz4GE+Z5dzpRltzuiImJhsED+0NMNA7kKer0kdc47RiQMoDdbLAffS9cvAi/81Ro+ONqVhbMXyTOcad8cUBaieUg6SZLbFy8Z+8TPa0oISEBypZJwBChiYzLl1G2sykBloQ60YzCqRs36tGgQCMcumCCPYmOtsLgwf9gvKlwKleuDC2aNTb78Kdfn1u41uICkqtwHQVmtCb04fTTj2tr8uPadZCn0YmypeND+wrskQ9Cyc1fygwJwSO3IFoFTZUQ+0kvIspazl4iGZpA96pSuRK6Q/dDrylbybwgqLdy5cooVVF20AvHmHIjea7E6+fRGnTC2IhfHKzfdKOLX+d2baEFjj0cCiE9aNxCl3B2GH6GnW8nWpNL6Rnw6++b6ZJSQyTUs79ZBHl2cSoW55mwSOIvW8lCU7cCkuFC0oY/RIbS0CGnjtuFIJFso82aFEhISkqqrCrRSl0SE290CfuqwYboUlHEBbp07ghlsAkn1KpeDW7BbpdINAm/YUry1pqwW5ir121AQbHz/UoT0s6chRU/rnbkB4F+DTLDqSBWMF/lpMqV6BTg0AXJtpXME1EKlOj4Rqqq6LWlpFgSbbMfKqAo0SCaHhje0L0LK8mgfrehAsmHgfQxm5LwB7+YbLKa/fBDu0P+/Hv47NJSUCxDBTlDA1YC5ZXMH8MuSCiIOHJOHDvnyEPhbYlQV5BMkm0jrRZEuqFqdp0O5rTyZ7qMAuTMjOCReFeciNwAvW68AQbd3oefmJPOcxjkY6zZ3whnXM9kak2o3Mm+Zv0vkEPna5vDlSKixYxzsKslco7yS5rSzhYELVJkPyYqD+MeTqVx8sQ15qMjQpGockTDK5FuUNVbTSTHGleuXnVmWJCIYESaGJS4enVqQ5NGjdw9sJCEP3/MpiT8wa9QKErb+o2/05Wlmnbu3Q+btmxjF30oj5y+ADZssW20ZIcrKXM+iqCCBF8oiVAaOuqN7hCqROXvE6gbqgZKZcoUb5+rNBUWbJimeY1Con5iBZ61EollC9ucrQmngEz8cZqS8D7rf93Ie9tGADBv8RLIyhLHTFMukikyFrtX2Ho4+uYy//jhKpWFQXyhIMNaoUIFyyn5UAHJNsbW64d0QwVF99lRzMFMs1rLEkgiaXcUDMYJOVwA5cqXc9iJTBY2edhBpuGmD5lIWVlZsO6X3yz/rzRS+qV0+G7ZCmf+MdGvDjHUvaIyQOKKR5KhNIbikNKYFYc2tE6Ii7X8v1Agkm2fQN1QMVx5I/FWlIt91KADKyEqLoyOI174w8cVJCcnOQoHv6JYySKukH7kkv4y3C84MCclicCJdb9shGMnTjqzj4AmjT8EA0l2T5lkWRBxHhNhKIfSIFWrUgV/QxMk2+Y0eBDqhopJoe3yMLg12bVQmP7ELhZGGH/QbsQNfzEFFbEZN5p4h5JwEIeFTQyCBvrjhwbl67B7FYEraPwwl/f3pXymnMO8w8opNsa8gpfyWNg5bw0y/EwCRkVGA/VQhZBtUxrcSdeSceSllsUGB51eiMIGHUak8ZcLSBYSfsqUTRQbT3PhGAVIJK8gC9uEHxXab5u28N5REXji6PETsAG7ngzMq6goenqucAUjyMhfqnSEojjz3FNpaKAeqsAoYywtZF4SgFoWu1haggjpg0IARgHgL7cU3CIQ4adc+fKi9aCPVBJvrQkdHUddiQi8gzaryMjM5PwUrYfMW/kx562hNIbiOJVGlEMoKwgnwAeRbtBiRY8Nez1gcXFAiaNgUgq0Gx8Cd7OIZ/DJlIoiCK8RN4HNW7dx4QtmhKyIXs1duFi8fcgDdOQRmcM48tb0MRRHKI1QHNo537gm5Ch/xNLkNu2FgxdYUyhM09GqS06T/DggExqNtVzZsmXZybUZWviDpUR2o+Dy8uyw9udI6+EPNm/bAXv3HxRbJaEciEGrG9GHMtZEDr780G4yoQqWbTd5d6NolUJh0jAp1kSrODFoUCkrOwfjQrFBmAtCErlpzl24ySn96BoyZWuyZccuuOBj/U2EXOnbpSv4EB2Rn+LhnyNv0e0YkDt4zryXDn5HR0dBtLp/sIlkG2PplUg3+H0QX4jGGiTYoOUQlNmc+eg2CkAYgk/TvTYbJcfgYyZQa0Ju/NDxaWvD8ODR4gStdXPko4OcS0vEOMOsOMJtVpqYmFgoY7nRXPDhj2zTcxA7ZYI34o3CMGAwyW7sL4vkUmMZHywUClguuZyINKkFh0GnDE/b+NDxDe73jpB3ql+3jhR+Iz9JQQzZMCuNU3FEOKcdQ/J7IVb3Dza5ri+zJDutxfL5JDAuNkbagods6mJxhPHHoRSiIEgB8IsmQHmjm0UMDMNh0aACjMxcFRy03k0Iu8xrJrubMhh5TOVj3dqE6kxWfrKNactVMXm0mxg5LSmBNioO8ifLWDPDhWEoBdodtRmRDrFxsRAbH4ch0Y1h2ANbE3pz7sz58+IekY/fnwaoICJzRZ4zodtQFqEkRHY3twhnKE0KVVwh+CHZxhj6oizqtF/mPPBCCfEJaHG/LrAklgRgAWCEjEwXhMlkwkKhgGgvX05s78WXopsKbS21HsyIkL9E44aKKSlg55YAqxkjr42Khwnz3UNpnHajtalYsYLjvqFEJNuOpFgQ4jKOQZQMsnsjmj61vDqAxApiOCleaDGUgk0qFFlQxslHHAZN2pX+9Jmz8uII+Uu0FzL108ku8lhWUEhCacguFYcsaApyLQ+6lmaynP6hQ/xogJLojVA3VEzgJZEQa6IdDYONHB6DUHyoVhKEP7IQKIRMEjrovYWkJBFnumbdr3LZRAQFQl3sXrHwmz/mvCdCpTEUh5TGW2tDXaxQBMm2kCtrIt2gQTp1zlm+rIhXy1p7BYyuyjf+8MehFOw2Qhh+5MKfcuXKsT8dYXAi7bTjPhHyn2hnSuoe0fnwZIquk8h7K8VhD/Y3lMapOOXL+97sL1iUTOe6W3k4SD+v6gqcMe987U5JScmg0NtkVtcHiPLy8jCulPkmrqNAiMgq7Fg8kFCmDM9xR94WLByBovAMlhh0y+4UK4swzeTIdzLNH+YLxaGn8cbx0aFCJNOkIO7y7kZnVAycZnkHSfS0kY5NpoQGi3L5rT+nmzOfONJOSkEFxIWERGHpuDhamUrhI1QwKo9dVDoFmARcKIFBzileoTTYQmALYyiOZ2sjywQ/3M2S9w8FKodppJ06hSBZEyY5jbpYJyz8XIgXnAURjk0V0C7SZ8p8g9CPFimLGAPUqF4tJNaRlURw94rylAUdFYOUhOyGm/KeeG6KI/hmZRF2Ih6ohxAqVsj/fXlQ9BOqatePKZgAXxTsl16ycsSTdC4Ao4DIzb7OJAm3cFVEpW7auKFgRFAg0MFDJPiUx9xKkKCzG/NeKglanIrDZSMUwak0Tjfdg9bKhRJIpq1k3UxRunJURdE77BQxa6LtPq34gSI7RpZrIqkUxq9hox92kUlhOKwG13XzeiZphHxQ7Zo1RD5KQaeHrcItFUUqjUNxSEmIKDzmvVNxhB+VXUVj/4AQIX9kOk+BQ9iCRB1CwaPke/1UrVKZuy/BItCoCTe/HikMdrGJH3NhCSa0a90KysTHWd4zQtZkUxWoXaMGZjnlpSHgQsgNJTGUxqk4GE7mvVAaURYOpUEiBbH6v2BRtapV8Nf7B9OgxUfp+9Trr293Ft0ZLFNeKCWlkhjQBAnUgvDWoBQfdAvCDxeGq1IQyEoFSku1u3RsL5gR+IXKKRV5BpAFm/KVlASVxTAdisMDc0HuimO4jbIhoqneUAFt9kEyTXLijVCWLnTo0CFdpddBMDk7xKXWoAyrik1SsEAFkkeFhHZHocmCcSqFwRcFRKkks3uXTiJABH6hFrUemG+iC4X5SUJuCDopDRHZKZ+ZsHX3o7Wh89NDZdKEuldUefoCxnwv6YZoFnRlhzNB1lSjRk3MIExqkIjeJRcFRPHhWAs7F4y5QAwS/lTgNapV87hfhKypFo4/DKUg4TaE3i7t3IWiPDf5+dPaxMTEQDx2dzFY0KlGdWOM5Z1IJ0jGWEE0sNO+kz5Ru5DnlBcVicNOMCJopwR4Uwr64cIiBzMAenTtLOwRypdq16juyD/HWII+hp0UQyqHaGH8b20qVQiN99NZlvOBoROsIDgu28yZ4ONTp1ZtCho0XL16VdRGmECnQlDMEGTKQiVChsunU4e2+TapEWBXGvOID71hwRYk8tZwG0ojiD6GUri0NlRObJJb+JO7Ag7Ugw3q5tWtU0dKhvcP6QSFZwXJiVI2o2BhmtHLCyViHzKYCbyanSMKSxLbMdMNxXBRCvJjk4KJ48DatuIj5yLwgWo0W6moDkEXJIRb5LtTadDCdqMMhNKgW34cSkOE/qQ05f2QnxrVqvKMV3GhYvnycoMPSo9XssfagN+wYwXp3aXLOV1XDpsXoVhRg/oNMOloDQLl8XostFMCZIGRj/hIPn0oDJvSjX7E7N6lI9sj5J1qVq/GQq/Z5ZNxspPwO0yDnG5WGiLkUT4LpSFCf3SbW5vytIjU4n+JaCJo+NB7YdSf/wTn+Gg063DXSvXq1UOLtXwbhLpwoGvXrukYXCgIQdG1deiLNu/UsH59NNAeBMqVS97ZjXExfs0f8pM2Ec5BAE0aNoQK9K6ICz9CZqLlOUL4ScDluitSFjMxT4QRJBTFrDhcOZmUBi1s95b/ndq2gU/fexuGDxsKn385A1meYYqKWIZZQrwT6sIvaGE4FAS9UEF8o17detiXt0lXYJGVY7FVPaeHTHKRFX8dJNwGAVYO3Tp14HtFYI1aOEDnLhERtwDCTvlHwi+E3kJxWDHkNQ7TIKdfOVpebkKlihVg3EujYOL4caycG375Fbbs2Cl9ix40Dq1PLUg+QGlx6IJDQVRNX405YBIwT4qNiYZ6derKKwIL2vqH1EBERQo+u01xRDj8zIQf+tJDw8gCRmvQUQXlkpMcgm0MtJnMSiPdRt6S8JPSUAvhojSG4nBrI8IlJSbi4FfhB3X3DugPX3z4Htx4/XX8/+T/v8lfsr24UB8H57T0HiPuk1gXJBwKsnLlku3Yb8SxiOU1DmrWpAnJWsApz3gnhD7mCBHYKvgOYiZ+sXCMMUvFCuWhccP6xI6QG9HSC7KIbpEgFnxWDCHkxrSu0y6JFIDCy7xnpZHXCyURCkNve3Zs1xY+fPsN+NNjj0C8ab+sJct/gINHjnrEqyipaZOmGC+0+yBM39kbb+zmeOzhUJDU1FQNq9cfpNMrmjZuwrWA5d2LkWjJu8NNYKsoEDOJ3EC7VApiGB9kiW4Wh4uQmaqjgthRiEnw+R0PEnpJopIxKY2V4hgm8dlPXk/X4P1t2DWvW68u/PO1Vzy6OXSy1WdfTveIU1ESKSdV7vlBAWUlPUGXTqeCEHAAv0xavaJMmTJQv27gu1m0NxbKOKYVC8udhIcoSOZRUPFBFvO4oNFs1aI5JMT7OtK4dIKmeIWgCyURpqj5yTQUxxB8Z8vsvbUxlIz2523dqhWfm26FuQsWwtlz56WreFAPu1c03Z8fMAkuOuCiIGDTlmITg+kmwfJOrVq0lBcEDmJnEyHkTPhBi6mgKJTg8wcZhlKQn3EdDdQ6tmvD94zACWpBhIBTvpEyiPxzKoYgVhrmSUXy0dqUSYiDllgh1a9f3+uD2kvp6TB99lzpKj6QzFrJshtpKiiL5SUMFwXp1aPHYZSl7dLpFU2xqfJnX9OiBI9B8MNfoyDclAJZzoKicPhjRZEVvq5IKlsWW9V4mXfUGlC3SCiCsAu+UBajdSCFsW5taCKkDvYyWrduDYn0urYPTJs5Gy5fuSJdxQM646R5s6bS5R2Yzm09e3Y9Jp0M1xYEgRky3yxMVkQLz1o0a+aufcVKdBqtUArSCjQtlcKVOD0OO2sMU83q1fmJrdX/lEaqWqWSsKOwU14Ju8g3B98g2kWRTVIM4cdKIxUnpWIKdOzYAWpgHuc3Y3gqLQ3mLVrsiEdxUbOmTbEFoyX8rvJhQQtk1BzwVBDQ50urT3Ro207aAgPen1d+SCkoQfkpBbsdxF5sEEVaESd4BkvCnHck/A4iN/NMJvINpYmPj4U2rVtB8+bNuAL1B59M/lLs3F/M8FdWFVXx6Ot5KMi6Vdf9gQk/ZM4oK6pRo0ZA3xHJldO8TqVwFibBsAs3ewoSLiYsSixcKmwN2rVtxfPxEeD4w4+TaM35aygN5zW2ErR8o0vnzgV673zvvv2wfJXjcUOxgU7ZJVk1x9+KUCb233Jj903yMgc8FCQ1VcGUK19Jp0907hi4l5HEcxDXgjITqwCZTPx1KAX5G9ONBujsi9Ytm0tX6QV1g8wtSEFAe+5279aVp20L+sbpR59PdimP4kLnDh2lLR9o+mzz9K4By1QpWt50Q/B8UasWLaBMXBwfyl7cZGz9QzD+X2iCQfy1VAr6OEDhiIctUZf27Sz/qzRRxXLJPIgtCOLisDvVpjW0b9fO5WGfv9j4+x9ImyzjU5REG3C3RBk15MUX5WnadBk9F1gqSJ8+N23FyzyaG3fQ1F2njoFZJUsH3NPUIiUGfyShh/RnQp6lUiCYJ7tnhlfDBvV5s2vH9aWQaHrXX/DsVJ3a3GpUKWT3OiMjA/7z0SeWcSlq6tShg9fpZTNQJjbdgTIvnS7w2i7quvYFC1U+1LF9h4BM+dKDpPc+/pQ3/OKpQ3qYj3xqLUgpWDGY4wTHkZQCyc2LoaoKdOlQugfr1atWlTbfoP2Ou3bpBI0bNZRn+1lkaD64fPkyvDjmVd4zubhBEwWdsHvlLq+WBNoX8jIPeFWQOJs+Tdc06teQpHklmj/vGKAZLTp19R9vvsV7qtaqVZv3e/UARcuHUrijcwfsZuUzHRnOqF7NdwtCi/toZqpTx/biKAwDVP4FwNWsLHjplddg5569klO86NCmLcRj999dXj1Ju6rkZU2Vl3nAq4L07NnzLBqz8RYsZ76oa5cu/LpmILBt5y6Y8K9J/MeVUirxNpnJSUm0hkYoBiW6AKC33BpjV6s0gsqsMuahFajSqFGjOnTr1gWVyLqV8TevaYp+9KsTYGsxLmU3g3o03bp29ZBTS9Jhbt++fb2uc/GqIATFprxvfVdXKlumLHa12qM1MJ+NmzbDG++8C/QEl/qY9HCqNrYo9L5BYfbvomci5vuXlk+llAryZGBXUMvcEVvWZk2dKyaslYHu4hu0RGjshH/Axs2b5b8W/6dju3ZQJqGMi4x6JTv8F3+9wqc03XrzDeuxb/+H9Z1dqTtqLJ0aGiis2fALvPP+R/K5iNiFvkLFitj1qsX95YIoSsvmTUvlAkb38QdVNjTG6NSxAyRhq0wla4a7m4FjP2+gzf5S//kv2LAxcIcYxaEM9ujaDW1O2fRGqPQbb7vtpvXo8ArfLYii6Ng7/zcJYH4UH5cAPbp0lVcGBvSg6ePPJrOdag4CK0r58gVSFKolO7YtfQsYzTNYtJlaly6doQYdvWaMyahgzXB3Sxh5bwY9SPzHG/+Gn9ZtkJzAoDvKYFxcvItseiP8fYcv8oF8padyxcSZuqIfpVmj/IgeHAb6LJGF3y+BqTPkc02Dj6B3VmiTgJo1avBUbn6KwktPTPctDVQDWxDe8aVta2jRorlYIkJeMk8IFNQMy66WG4+U419vvQPLf1wl/AJE5bDV69Kps6VsehDAkaOHEmeyzQfyVZCOHTvmYnqxFeEmySdRE92r582cwYGkmfO+ga+RDJjjRLUhDeJp8Vy55HJgU62Xl5A/vRdtdf9wJDogpwOOMzp36ij3zSWugNNGcHV5A+W1Yb79/ofw7bIVjv8KFPW6qaeYgjaVvzey6/pbTzzRMd+FYPn3PxBX0+ETjMAZ9whZUbOmzaBu7TpoCywmfzULvlu6zJEBBGHqWKORS+FpyqpYa9I0MWWkO0rLpg5dUDE+ePtNqFu3Di3Qk1wTMNtEDgoY+WnA3S2A+Y6f9z/5DOYt+k7yAgfaDK4pyp4ocd+Ew9bTek7Gx2jNF34pyODBPTN1TX/T8t8sqG/vPpYCWJygQvsQxyMrfxIL4Gg5NkVGKIfwlzauPStXqsQtizme7du0Cdh0dTBAO7e/+rcX4PVxY6Ca5dStkUeUX9Ii4eb0cBM++WIKfPX1POkKHGjR6W29bxWR8ov0SXfeeadfL6H4pSCEsnE85XtaOn2Cpl15wE65HECipdfvfvgxbx9DLFfloJZFMMhN9SYtWKSThgxFSUiIh9YtmjnuFy4UZVN5F5FP//suXNedZniIjX4OmFsRJ19mn4BLeISbe+qMmTBlxizBDzDRwJxWWPgDlIJTem7me9KZL/yu5idPnpwz9IGH6DTN2wTHN2hwvGvPHrh8tXjfFnMHvauw4dff+OGfsV7IqSBkMsNhJ5PGTqQcND6hGa0NG39nv3BAq2ZN4bXRL8MtN98k1iWhLjjVQcExmrS6wMTMJzyN8Wbj+O+DT78wqVbgQBXcgP53Omfe8gHGcfSd/fqukc58UaB+0IP3D9mk67b7MVvyPQ1FVVSoXrUabN621SmYAQLNoqxHJWnZrAlv9UOwUg5SJs4y+kWDWhEaqNMGBifT0iA9I4P9SiJoj6unHxvJ2+vQbB7BIUQmofcuWJ5hCe7hF3y7GN76wK/ufJGDZiaHDLoXkhKTJMc3sIgPZGWeHTF79mw6rswveMsdr1jw7Q9DsGPm1/sihJ/W/ASr162VrsCCWoXUl//KO1qwBiBIOVgt3JSD+W5Ey7K/+e57OHTU5TXlkAYtwOzb62Z4ZPiDjrVqVMhc0ChQRoE7dAUrMqfMk0XkibyCQf5OF7mF6/tlK+D/vfUu51UwcH33HnDDdTdIV/7Q7fqQAf16YT/Qf5jT7RcwM5QFi1eswca2u2T5BL3EP2XaVDhx8qTkBBa0m9/40X8TU7gk+MgTBUpKwEEE34LYD1ujzdu2wzdYU+4/dJh5oYoG9erCX558DJo0aQz8iBcF2RB+HmyyWzLIW9j4UH3D7gon12WyC++xctVqeG3im9xaBwM1qlWH4fc/6NeDYIIG+toBt/W6HtNfIG22zpd8MP/bpR3x0p/xz/yK3YULF+CzyZ/zxgvBAD1ZHz/6Jd6XSYo9KgBbWBGMQnZXDgokumFk1WD7jl2wYPES2LP/APNCBfSwj3ZG73/7bdxNZN2gH4QxjUu/bLNoRcjCmwEKB5JZhiQfDaOw16z/GV55/Z/8fk4wQEuaRj40gldK+AVdz8N86HLnbbcUeHBp5EqB8c2iZR/g5U9KZ77YuXsnzF3gfJgXaFSplIKD1Zd49S7JvKEEpByG3aEcZJrdUmCM9+H37N3HirJrzz4XUQo0qDW4oXtXePyRh/h9cD7BVdZZDiXBMIbsGwJOLYaw8FdYXbpaZjiZ5P8rju1eTn2d9wgIFgbdORCaNcl/Gx8DWEYfDOx3y1PSWSBYZok/WLRodflcyNqFheT3q2XLli+DX38P3MI1d9SqUQ3G4ZiEnoMYwi8UwKQMZJrd6BJsk7+k/QcPwaIly2D7zt0BV5Sa1aviAHwktG3TSigCthQqx8LUjZLF69GKsNLIMGgYvjR+ESDTnCLB37RlC7w0NhV7AsW/E4k30FuCvXv1lq78geWUBmWimt7Vs+dFySoQjBwpFOYvXD4US2eGl6rHA7Sx2PSZM+DoseJ/o8wbaIfvv7/4PB8oaQg6EcNws5V/iSV4wsImdbuEP4eAw4ePwOKlK3jrfoNfXKD3x+8dNADuHjAAomPkm5yY/aQkpAjUihCDFMCqFSGDrQUcsG/HtL04+hV+8SlYqF2zFtw35D5QTQ93fYLKSYGhd93RO981V97gyI7CYu6iZQvwJv2lM19cuXIZvpg6GdLT+QCfoKBJo4bw0v89w888HAKNpjHtK1jC5PEJWoxwhnLwh3iST/bjx0/C4uUreFBP3bGiBu2M/sTIEVC1ahVRcCapdyoCPQQVCkKwUhLuYLFbMshb2CwH7Lv37IVRL48t9h0QfSE5KRkeevAhHm8VAAvu6td7gLQXCu55UWDMX7q0up6tbMM7+X1S/OnTp2HqdNo0LDiDdkLrFs3h/55+kpcpkCiz0LOwC8E2xhukAOxnCsMf6UcQfKc/7Ri4ZMVK+H3L1iJRFDpo5rGHh0O3Lp3RJQWdBJw8zUJOiuDW1XIoCHHcu1p+DNgPHDwAz/11NKRnZkpe4EGrjB8c9gBUruT/RhFYDuf1HHvLu+++7ZqmT42cuCbMXbT0Pqy4LLdN8Yb9B/bDnPlzRQ0dJHTCGvnpxx7hWpMFngXfKejkMOyO2SyTcgg/EZ79yC0H/URnzp6DZT/+BL9t3lKoGR968t2/bx8Ycs8g8UIXdYHYx4eSSD/BcVMSCi88/BqwHzl6DJ7968tw4eIl6RN40DTuPQMH8fmYBYGuwbBBA/rMkM5Cw8iTa8bchUun4c2GSadf2LRlM3y3xGUz7YDjuq5d4NGHHmCBMISdBV6a7uMNs5+wGnZJrCAc3BH+3Pnz8MOqNfDrps28AZ4/aNG0CXenateqxYVE8SNhF90iKejkpsDsIBO/pAhurYiAMP0dsJ88dQqeefFvxX4sgS9QvG7v0xfatC7gy2w6TLvrzj4PSNc1ociW3N79yPAVah4MQYnwu6tVtUoViFJtcOhI8B7AHTl2HDKx+0DnhpAwk3SzifA13hBO6U/kaDk4CF9jTCHHx8VC8yaN+K1FaklOpZ322nImJyXCEw8/BI8MfwCSk5NchFeQVAr8ZdNwm4Wc4sB8ERm6BzcgHBJ/ZVACW417CCuknT6D3aq/cwsYTNx0/Q3Qsb2fOyNKYL4fjIuy9582bVq2ZF0TTFl17Zi/aEkXu11fjQVSoI2yVq5aCet/dRwsGhT0u7U33N3/DiHk6HYIPn1I6okcfJM/kUk58NfFj5iGnRUOxyS0xmv1+g3wyx+bHQ9PqSvR+6Yb4IEhg6Fs2TLIQaHlWSksIkOA8YfHB+wWRSfCkEW4yeHsThV8wE6tHSnHsSCtfDDQrVMX6HnjTdLlHzB7sxVVv2FQ/75FJkxF1oIQvpr+5fEhwx6kDqtfK34N1K1TF7KysuDEqeAVCj0dj8YBe8P69Qo13mA/Gd7ROmBHmPhCMWhzO7pO472mGtarhy1KaxZ42r7zhb88BX169YLYWGMbUBJtNqQphZrcBg9/HX7SZJA/RZP5Ir6sAPwVYQyFILAN3ZcuXYLnXx4LR48fZ36w0Kl9B7j5pp4cpwJBh1F3D+hbpKfxFDAG+QMFRPl6wffT8cZDJcsvkCAt/2E5bPwjiEvNsUDuxwHxTdf3cAg7RcyhAA67JFYQcSm6mOddOYQ/MY3raYBcqVIlKE9PwfG/SVlYgB2lgi4SEvoaA3T84WGE3wN2+qVICru3ViQjIxOe//sYfvgZTJBy9Lq5F0W/QECxm3HPwL4FGgP7A2Myo8iAhaAnxqmPogBsliy/QIV1y823QJcA7hjvARTa6XPmwnp64YoE3SHMZHUKNiuGm3KQYgjloMCitTB4RteKyFCUxKQkqN+gPiqHc8jG9xYWdhMkh3nCT3qbwngFhZVWA9yyEEzXZ16+DC+98mrQlaNrp84oAwVXDsSmGDXnUWkvUhQiLv5h3rzFdfNA+wVrOuut+3xg3fp1sHrdGr9koDhAJ6I+/vAD0KYVncVIAk3yJARbKIbksZ+TiGnYDaUgkxSGDfyhp9+Vq1SBMjjOcGa+sInaXtT0Ru1OfmxnnqjPyC3Ij1YEWwtfT9izs7Pgb2NTA7broRUoTjf06AHduvq1QNwVup6m2LUu99zTr1hmemROFg9mz/u+O4rICrQWeFe2TZs3wdIVy1mogoGoKBs8NXIENGvSiOPgVAwip3J471JR2RmtEPpjTlNXinYQYYElYSYSVyOEm0Avm7FASzf7FcOAPSc7F8akToA/tlhubB4Q0OREn163FHwql6FnYT71uveufusko8ghc7L4MHPet0OwWOghYoG7c/v274MFixbx9pXBQAzW9n95/BGoV7eOVBDBd1UO1gT2I+UgnqFIgq/z8oiUypUd23gauW68yyCc8lcKvFAgZiGkXfqxKQwkyXMJI0wGhSFtQOUxPxvJycuFV8f/E3757Q8RLgig/LizXz9o2KCh5BQE2D7bYdiQe+4o9DorfyBzsXgxc+63z2OZTJLOAiEtLQ2+njcPMoK01IF2CH/miUd43ywCKYehBIZycGvBrQb60liDPmjSk/CUSinYnbLYhZ4Elz5Grc9wCndxDtjpWOcJEyfxex3BAh1hcffAgVDFj+Pf3EHZDKo+asjAfm9JVrFB5mDxY+bXiyZiCf1VOguEy5czYd433wTtrcQyZRLg2SdGQuXKlVgxzK0Dkft4g7I1uVwy7xXMQu0N6EXdKTKdoQxBRptLV4v4zCSbNIUXhxee7Db8hINM/MpWhA78nzjpXVj5k9/7FhQ5qmNlc9edAzBf6XlPwYG5PXHooH5/k85iRZE+B/GF2TOnrdi+a29VTF7BHo0i+Njp5s3hypUrcOp0Ghd4IIlOYt26Yxe0at5UnjnhfbxB+8JWrV6Na0ifykFgb3rJSQo0Q9ocwi2FnmEIPrENf4OMeziVwzAZZGBE//3eB7D8x5+EOwjUtk1rGIDdqsJudI5Z/OHQu/s9L53FjiKf5vUGLFB9x+ZfnsIETibhKiipqg363NIb7rj1VojGATTX1AGki5cuwvuffs4P00ghePrW6FahP818VcLuQvWaNcQet/6A0kYG3UNwEGabtFMGCIvJavhJq+kejjAm0H/896OPYcnyFeiwTmNxUgyW2R239sUBeW8uS4pjQQmze/LOLb8+TckRqSp+kF4HFLNmzbLZ1fgvUGEKvZjs/PlzsODbRXD6jF/72BUp6NXdp0Y+zE+/xVJ2nY8KoO6UvxsIuECWQHEO2CmWn3w+GeZ8sxBtgQctU7/zjv4FOibaHdhDnLJr8x0j+BTmAILyL+AQSpLwP7SOEJyCgxb9rV7zE2z84zesXQJWoTBqYhfqseEPoGIk4iC80rWfi2IItxRoAWlH3rUO2KdMmwHTZ3/N3ECC4kiLDa/vcf21bkX72a6tdzwWaOUgiLwMAlColRlzvn0X8/DPklUo0Ou73y/9Hi5gFyiQoM3l6tct6k26DdE2weEgFaGKwOTLVqfbzcm4cuUqn8gVaNBmdX1794VaNWtJTmGh/wfHHM+isgW2FpRwy86AQ5k+e+GrmAljRZVYONBzkjVr18Dvm/7gcUEEwQN1FTu0awfXdb8OooznPoUAVqA6SkTqsHvuTJWsoCDYCsKYPnvBk1g9vIeRuaZ2mJ6ZLFuxHE6mnZKcCAKJalWrQu9et0CVygV/tuGGPOw1//n+wXd+JN1BQ0goCOHL2d/0Q2MGdiQsnqr5DxqPbN22FdasW8vTwhEUP2ilAG0D2qplK5SoaxQpHTIUXbtv2JCB30pOUBEyCkL46uuFbex52gLM5NqSVWjk5GTD+p9/ht83/+H3a64RFAx0lkr7tu2ga+cuEBNTBAe46vphu64OGD60f+AHTV4QUgpCmPL115VtedFzMGbXS9Y1ISMjA9auXws7du6IjE+KCDTOaNGsOXTv1oMfiBYFsOVfrUXl3TP87rsDP3fvAyGnIIRZs2bF5OhxbwJof772Nlvg4sULsOHnDbBz966IohQS9DC0adOm2GJ0hXLl/N56wCf40aei/OfKhVMvPPHEE8HbstELQlJBDHw5c94QTYePcVzi3wEQfiA9/RJs/G0jbMcWJVirhEsaaNVti2YtoGOHjvxQtKiAypGu6vD4A/fdVawrcq8FIa0ghCkzv2moaPpXGNMiPWGT3oHfsmUzbN66BdIzS+5BOcWJpLKJ/J5G61atIY7WoBUp9I26ot43fMiAfZIRkgh5BSFQl+uqPWq8oqujsMNVpAssNV2D/QcOwJZtW+DwkcOlvvtF4ws6pZiUon69+mK1cRECO1R2FLo3mzWuOZaOGJfskEWJUBADk2ctuA40++fY5SrMGzb5gvbHosH8zl074ey5s5JbOkBnpzRr0gya4eCbjssuDuBAfB/WSCMeun9Q8NbaFxAlSkEICxYsSLiQaf8HRv3PRd2amHEOFWT33j2wd9/esFUWUoqGDRpBk0ZNoGJF/06JLQy41VDgP1fT1dFPPOHf8cuhghKnIAamTJ/fRVe0DzEJbSWr2EBL3A8eOgCHDh2CY8ePB3XT7WsBLcOn04dpH7J6detDcnKy9Ck+YKuxCauxJx4eMii4OwMWEiVWQQjjxo2Lqt+k7Z+xGMZhUvw8j+vaQGOWUydPwtHjx+A40qm0U+LMDKwmQwpYZdPLXVWrVoMa1WtArRo1oWq1akU+pvAO/aKuwKsJtrz3Bg8eHJyz2ooAJVpBDEyZ8nVlzQbU7XoYC6bYul1WoKUtdNYJKcqZM6e5O3bu3HnIyEjnl6kCAVoOn5iYhN2kCpBSsRJvRkfrohITk4voKZL/oO4U/n5u05TRw4eH1kO/wiAsFMTAF9NntwZdmYjJ6itZQQMtbyHFoe5ZOioLTQBcvnwZrly9gi3OVcjGVode5bXn2UHTkFCySNkItLCZhJ7evLNF2Xir0ti4eG4REuIT+F1uGkjT+eDUTaJnE7RBRDCBMcfo60tUVX/p4WH3bpHsEo+wUhADn0+dfZOuqhMwcT0kK+Th3tgEuua/JuiwRlOUMSPvH7RKcsIGYakgEspnU2beAortFRS26yQvgqLFak2B10bef89y6Q47hLOCOPDZ1NnXY1Jpy6HbMcUB26giLCG2b/lOV6MmYotRYp5nFBalQkEMfDJ1fhMVcp/FLgEdKVU0y1BLCXB8kYHiMlVX7O8++uCQ3ZId9ihVCmLgk/nzE/WLeQ8pKjyGztaCG4EldNisKPr/9JzoKY8+OrDULVorlQpixv+mzesAefYRmBODMTMKvBN9WELXaXp2FrYaXzz28ODfBLN0otQriIGVK1dGHTh+trdmh8G6ovdXQCm+tRehibPYWizSdJh14mDKstTUnpHXMBERBbHAuHEro2o0OH+DAtqdWJ3eruvQULmGXVdCEfTQAo19aPsOpWDB8f07fkpNTY0ohRsiCuIHPp4ys56uKX0U0Htiht2A2VZNepUooEacwN/Vimr7QQf7sseHDzkovSLwgoiCFAIffjGjQZSudgcVOuu60lEHvQV2yUJqVgzjlIFx2o4NxUZUjF90RVv35MP37ZfeEfiJiIIUAWgr1XOZufVVxdZaUdRm2NI0pm4Z5m49lNQU7J0VyzoQFP48/A8aOxxEk7pLe/B/d6o2ZXNynHKwJC8SDBVEFKSY8fnnK+Ny1DOVVU2rBbqtCqh6Cgp0BV3Rk9Esi8qTALoSpSmajU9JQ+ioYaqu2jFMHmrBFeRmKrpyCc3zoClnQbGnaap6NEa7fHrEiBFZ/EcRRBBBBBFEEEEEEUQQQQQRRBBBBBFEEEEEEUQQQQQRRBBBBBFEEEEEEUQQQQQRRBBBBBFEEEEEEUQQQWlBkb8PMm7Cv9pqoE7EG9eSLAd0XcnNTICuSenpdj06aTxybkO2y8tEug65igJzldyM8ampqdqY195qpqj2N/F+9WQQBzCsvUx04nVXr564rEUlvYKsAYqiRwtfB/J0BRapORmv0DvXo8f/q4ENbJNA0RtLfw/oduXp8eNGrZROrxib+kYnxab+A6+oIVkmKFlKbnpHLTrxE4x7V8l0Rw6Gm5k6+vl/jpkwqaYKyvcYf59loihRQ1NHP7fllfFvPq0DPIJ5FS+9DGigK2uvxuS98MZLL2WMnTBplQK6z91aFFD+mTpm1JSxr7/ZG699BcNbbFih7FVUGJX691H78L/fwYt6Sw8XUBljGha0bFz7VX9e2MJ7zcV7NZVOV+jKVfz54rWxL/zn5dffaBmtK7Okjyd05YgWBS9NeHlUkR4hXaQKMmnSpPiLV/SDiqJUkSwPKLlqeT3a/izaXpUsa2j6cy2b1n5v256je9HloRwG8kCpbtO1+/A/J0mWJXRdG6vmZf4DFWkrClVzybaGrg/DQpkhXZZ4ceLExPicKHqTz+vuJzs3b4hq1rrrWgzTRbKsocPjiqqt13V1q+R4haJrvTTFlohCPF+yrKEDCtaoEWMnvHkJFcDnyZtY0YxVo21TtNy8PZiPXg88x3A7XhvzfMtxE/69GNN0q2R7w19fGzPqDWn3ilcmTKIzChsIlzUURbsb1f6srqg+9/6ld+7V3Fr1UlMHF9kBLkWqIGNem9RKVUHs7K3rX2qKfoTtElhD5mDL8DrWqkuw0G7GDN+jK9oc6c17gmIN9AAWUm20fG0H/UWboh4QvjBLA83lwEe8X17FxOh/nEvPnYm5OEDX9UO6ok+X3gwV1HvRaIS0NE6NGZal5RjHRc3H++2QdgcUepfPBl9QTSlZlhg3YVJnLJCfya6D/jnSSfaQUDUl67VXXpjwyvhJ66WC/Ir/t0z4crxI4B5GZa2O8f5SVfWJhoIg/xPMF4+jAyhudkX5L175AubV8/jHF/B/P8Q0Y1QEsAG6BfOvM97zwPixLzQYO/7NF9Cfz2zGPG+P1Bf/IRubGa5QFAXTq8MCDVt8FAZRFrr+Npad4yQoVVeaYcC7yM4VXJRGh6qiguhb8T4LOZAE/v9Q/P/6GKNF48eO6i/ZXjF2wr+fxI6AR28D74NRhSfwpwIm7h1V1+Y6FETX38X4ZbIdgfGrjfF7gOyoTK1SR7+4jT2KAEX6rrRNVW06qjpBUaMmThj9nGVEsdkX++Mq+uoJY14czXYJbHKboFEbCcPEIImdaHS7/e0J4/66nh1uwPvZpKb/4nm/SdUxoxuhMNkydE01+l8oNO9PGP2iQ2ALCs1utyk2cRRJjK6njh374mF2eIOur58w1iNubdCojiTyQwKz8T+po0d5PUIA8wjrBkyxAgfGj3nh75LNGDv+DeyWKJ1J8smNSvImeyBIGDEifVHgsj3yacKkOmSin6bmZYyagN1b9kCMfX1ST0UHVpDs2Ku2GLtsZHT4wz1NqJB10ahP2iw4vjF+zPMfSqsHME43o9EF9d/lzBclxj5xwksvnZBOGPf62y113c4KYrdj9VaE8CsREURQWhFRkAgi8IFSqyCqphbp+KtwEN0QBdSL7AwH4ACEDYBrThOOo/heuqpcYEYQUKoUJCZHy8VM5wEtjkE+xD7uOjONHT9p4djUfxXLqVT4p4Pd/w/HoT1xkH1RUe3/lcEYup43xS2s5fQmpqSpW7h1OPR4XHoHAre5/z/y+mO8LuPg+h0RxD/guOp+831wLLMela09JjJN07RPZbCAo1QpSGrq/13ECu4b6aSp425mwrqvH6i2JePGTaSBc5EC/7cqGi7/h1pjx8HvU6mjX3SbTVNo8O4IhwJ3I3HdgfEtg4brPS2ePxUbFIWer7j9vx6FA/TnU8eMKtCxzzooNDnjuA/mV1fk0n5gj7ye3wRIMaLUdbGU3PT76BkL1uj/xdrpfYOwJp/M/ih0enRUkbciKORbzP+HTdj7yL2C8Zg6bvwbNFvjAPJmuoSluFpB18+4hBNheeo5MNB3e/y/zjs9fjju9TcHykB+QQXtR/N9MA8+ILam6vPGvvZmBxEq8Aju0ahBQGpqKu1E6NH8/+Uv78SWq5L3IHZ66QFFkeeLAvqPr4194VnpZLwyflId9LgDu9r3K6C9JdmgKrZ/pI55Lv+TYhXlyGtjRj0tXYyx498Yg90s3w8miwo6/Ixpcvv/N8th7T8MK4QH0en7YaYJqWNf/AENIgewq9UejS5YIkOxTFyetwQKpXaQHkrA1itOWsMGRZomPXj5E1GQCCLwgYiCRBCBD0QUJIIIfCCiIBFE4ANFOltj1zRdlSqnafbBY16f1Fa4BFRNz1XyMmbzwzp64KpDKwzDi8wItMoMvcS7AYqiR9nsum68URCl3oVhXZZF4/3sfD96B4KhNB2H93N5CUGDlmTQilc66Gb73qP3or9HulUtN5EneREaBmamD9htNsdUV66iPIBxc5mrV3XIfm3MqNnSWSBoWl4/vJ/H8dSqpujZ0TmLIFcyihAal51KT8BVPSbpMfz/y9KLyqmjtEFsdmyRzvGNG//vPnZVryydDmBasRB0WmGMMkFre51FoufY7sb4OZ6uo6w1FiWHMoQyI2xFgyJtQXJjcg9hongZMkZ4LArJVDMh8yuAckmYWp7CVBSls9kf1WYqcluQH9q3nk+wHUfLOQ6rKy+awxLhDabnRidXwtDyftCa7uEaRhQuauSWP/aerID+M8z+znD0XAL/BvPbZtPynWKNztX3YVrl4TXKBI/7Acy69957C7WyFPPldff78T0V/cu4XFsxPROI2u6oaHT40Py/KHtielrXj+/YseES24sIuqK9b/4vgzCtU/B/+YEtlqvrS1CK8q45LMkasbE80svGKEV6zFyRKsjEv/0NM08fhhl9TLLcoGPdF52n5qqvYmq+xdbC4o0zCgOzyyXAxP88+2y2AupQvN8h4ecKuj46F6v+WP2fKPhzMZzHKa2St8CWG5Wqq1fyrMIYwPtdwIbmGc8n255ITX3hLJbUA3iRy3sgBvBe2c2bN6fVRFfJjRWixUlQUsEwjN2uZeM1GD3f0GxRVzEQ39MwzcA2gN/jUED38EPtZ55hmjHhlf/biWn/MwrZeclyg74fm5j7Zs+ebTfSZJgukDyr//ACx3sn7sD0ZeHPhy2b1PoCFNXnSVqYdcdUDe5/8cUXnS3fNQPg/wNUUJtMEKHeLQAAAABJRU5ErkJggg==",Up=function(){function t(){y(this,t),this.handle=0,this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.setting=void 0,this.image=void 0,this.device=void 0,this.cmdBuff=void 0,this.assmebler=void 0,this.vertexBuffers=void 0,this.indicesBuffers=void 0,this.pso=void 0,this.framebuffer=void 0,this.renderArea=void 0,this.region=void 0,this.material=void 0,this.texture=void 0,this.textureView=void 0,this._splashFinish=!1,this._loadFinish=!1}return l(t,[{key:"_tryToStart",value:function(){this._splashFinish&&this._loadFinish&&this.callBack&&(this.callBack(),this.hide())}},{key:"main",value:function(e){if(window._CCSettings&&window._CCSettings.PreviewSetting?(this.setting=window._CCSettings.PreviewSetting,this.setting.totalTime=null!=this.setting.totalTime?this.setting.totalTime:3e3,this.setting.base64src=null!=this.setting.base64src?this.setting.base64src:Np,this.setting.effect=null!=this.setting.effect?this.setting.effect:"none"):this.setting={totalTime:3e3,base64src:Np,effect:"none"},this.setting.totalTime<=0)return this.callBack&&this.callBack(),this.callBack=null,this.setting=null,void delete t._ins;this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.device=e,this.image=new Image,this.image.onload=this.init.bind(this),this.image.src=this.setting.base64src}},{key:"setOnFinish",value:function(e){this.callBack=e}},{key:"init",value:function(){var r=this;this.initCMD(),this.initIA(),this.initPSO();this.handle=requestAnimationFrame(function e(t){if(!r.cancelAnimate){r.startTime<0&&(r.startTime=t);var i=t-r.startTime,n=_i(i/r.setting.totalTime);r.material.setProperty("u_precent",dp(n)),r.material.passes[0].update(),r.frame(t),i>r.setting.totalTime&&(r.splashFinish=!0),requestAnimationFrame(e)}})}},{key:"hide",value:function(){cancelAnimationFrame(this.handle),this.cancelAnimate=!0,this.destoy(),delete t._ins}},{key:"frame",value:function(e){var t=this.device,i=this.pso,n=this.cmdBuff,r=this.framebuffer,a=this.renderArea,s=this.assmebler;n.begin(),n.beginRenderPass(r,a,Vc.ALL,[{r:.88,g:.88,b:.88,a:1}],1,0),n.bindPipelineState(i),n.bindBindingLayout(i.pipelineLayout.layouts[0]),n.bindInputAssembler(s),n.draw(s),n.endRenderPass(),n.end(),t.queue.submit([n]),t.present()}},{key:"initCMD",value:function(){var e=this.device;this.renderArea={x:0,y:0,width:e.width,height:e.height},this.framebuffer=e.mainWindow.framebuffer,this.cmdBuff=e.createCommandBuffer({allocator:e.commandAllocator,type:Ec.PRIMARY})}},{key:"initIA",value:function(){var e=this.device,t=4*Float32Array.BYTES_PER_ELEMENT,i=4*t;this.vertexBuffers=e.createBuffer({usage:zl.VERTEX|zl.TRANSFER_DST,memUsage:Pl.HOST|Pl.DEVICE,size:i,stride:t});var n=new Float32Array(16),r=-this.image.width/2,a=-this.image.height/2,s=0;n[s++]=r,n[s++]=a,n[s++]=0,n[s++]=1,n[s++]=-r,n[s++]=a,n[s++]=1,n[s++]=1,n[s++]=r,n[s++]=-a,n[s++]=0,n[s++]=0,n[s++]=-r,n[s++]=-a,n[s++]=1;for(var o=n[s++]=0;o<n.length;o+=4)n[o]=n[o]+e.width/2,n[o+1]=n[o+1]+e.height/2;for(var l=0;l<n.length;l+=4)n[l]=n[l]/e.width*2-1,n[l+1]=n[l+1]/e.height*2-1;this.vertexBuffers.update(n);var c=Uint8Array.BYTES_PER_ELEMENT,u=6*c;this.indicesBuffers=e.createBuffer({usage:zl.INDEX|zl.TRANSFER_DST,memUsage:Pl.HOST|Pl.DEVICE,size:u,stride:c});var h=new Uint8Array(6);h[0]=0,h[1]=1,h[2]=2,h[3]=1,h[4]=3,h[5]=2,this.indicesBuffers.update(h);var f=[{name:"a_position",format:Il.RG32F},{name:"a_texCoord",format:Il.RG32F}];this.assmebler=e.createInputAssembler({attributes:f,vertexBuffers:[this.vertexBuffers],indexBuffer:this.indicesBuffers})}},{key:"initPSO",value:function(){var e=this.device,t="util/splash-image",i=[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"util/splash-image|splash-vs:vert|splash-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},u_precent:{type:13}}}]}],n=[{name:"util/splash-image|splash-vs:vert|splash-fs:frag",hash:2381344969,glsl3:{vert:"\nprecision mediump float;\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_uv;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 0, 1);\n  v_uv = a_texCoord;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nin vec2 v_uv;\nuniform sampler2D mainTexture;\nuniform splashFrag {\n  float u_precent;\n};\nvec4 frag () {\n  vec4 color = texture(mainTexture, v_uv);\n  float precent = clamp(u_precent, 0.0, 1.0);\n  color.xyz *= precent;\n  return color;\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision mediump float;\nattribute vec2 a_position;\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 0, 1);\n  v_uv = a_texCoord;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\nuniform float u_precent;\nvec4 frag () {\n  vec4 color = texture2D(mainTexture, v_uv);\n  float precent = clamp(u_precent, 0.0, 1.0);\n  color.xyz *= precent;\n  return color;\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[],samplers:[]},locals:{blocks:[],samplers:[]}},defines:[],blocks:[{name:"splashFrag",defines:[],binding:0,members:[{name:"u_precent",type:13,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],binding:30}],dependencies:{}}],r=new lp;r.name=t,r.techniques=i,r.shaders=n,r.onLoaded(),this.material=new cp,this.material.initialize({effectAsset:r}),this.texture=e.createTexture({type:hc.TEX2D,usage:dc.SAMPLED,format:Il.RGBA8,width:this.image.width,height:this.image.height,mipLevel:1}),this.textureView=e.createTextureView({texture:this.texture,type:gc.TV2D,format:Il.RGBA8});var a=this.material.passes[0],s=a.getBinding("mainTexture");a.bindTextureView(s,this.textureView),this.pso=a.createPipelineState(),this.pso.pipelineLayout.layouts[0].update(),this.region=new Yc,this.region.texExtent.width=this.image.width,this.region.texExtent.height=this.image.height,this.region.texExtent.depth=1,e.copyTexImagesToTexture([this.image],this.texture,[this.region])}},{key:"destoy",value:function(){this.callBack=null,this.setting=null,this.device=null,this.image=null,this.framebuffer=null,this.renderArea=null,this.region=null,this.cmdBuff.destroy(),this.cmdBuff=null,this.pso.destroy(),this.pso=null,this.material.destroy(),this.material=null,this.textureView.destroy(),this.textureView=null,this.texture.destroy(),this.texture=null,this.assmebler.destroy(),this.assmebler=null,this.vertexBuffers.destroy(),this.vertexBuffers=null,this.indicesBuffers.destroy(),this.indicesBuffers=null}},{key:"splashFinish",set:function(e){this._splashFinish=e,this._tryToStart()}},{key:"loadFinish",set:function(e){this._loadFinish=e,this._tryToStart()}}],[{key:"instance",get:function(){return null==t._ins&&(t._ins=new t),t._ins}}]),t}();Up._ins=void 0;var Vp=P2("Game",function(){function d(){var e,t;y(this,d);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(d)).call.apply(e,[this].concat(n)))).frame=null,t.container=null,t.canvas=null,t.renderType=-1,t.eventTargetOn=_(g(d.prototype),"on",u(t)),t.eventTargetOnce=_(g(d.prototype),"once",u(t)),t.config={},t.onStart=null,t._persistRootNodes={},t._paused=!0,t._configLoaded=!1,t._isCloning=!1,t._prepared=!1,t._rendererInitialized=!1,t._gfxDevice=null,t._intervalId=null,t._lastTime=null,t._frameTime=null,t._sceneInfos=[],t.collisionMatrix=[],t.groupList=[],t}return p(d,ll),l(d,[{key:"setFrameRate",value:function(e){var t=this.config;"number"!=typeof e&&(e=parseInt(e),isNaN(e)&&(e=60)),t.frameRate=e,this._intervalId&&window.cancelAnimationFrame(this._intervalId),this._intervalId=0,this._paused=!0,this._setAnimFrame(),this._runMainLoop()}},{key:"getFrameRate",value:function(){return this.config.frameRate||0}},{key:"step",value:function(){cc.director.mainLoop()}},{key:"pause",value:function(){this._paused||(this._paused=!0,this._intervalId&&window.cancelAnimationFrame(this._intervalId),this._intervalId=0)}},{key:"resume",value:function(){this._paused&&(this._paused=!1,this._runMainLoop())}},{key:"isPaused",value:function(){return this._paused}},{key:"restart",value:function(){cc.director.once(cc.Director.EVENT_AFTER_DRAW,function(){for(var e in cc.game._persistRootNodes)cc.game.removePersistRootNode(cc.game._persistRootNodes[e]);cc.director.getScene().destroy(),cc.Object._deferredDestroy(),cc.director.purgeDirector(),cc.director.reset(),cc.game.onStart()})}},{key:"end",value:function(){this._gfxDevice&&(this._gfxDevice.destroy(),this._gfxDevice=null),close()}},{key:"on",value:function(e,t,i){this._prepared&&e===d.EVENT_ENGINE_INITED?t.call(i):this.eventTargetOn(e,t,i)}},{key:"once",value:function(e,t,i){this._prepared&&e===d.EVENT_ENGINE_INITED?t.call(i):this.eventTargetOnce(e,t,i)}},{key:"run",value:function(e,t){this._initConfig(e),this._initRenderer(),this.onStart=t,Up.instance.main(this._gfxDevice),this.prepare(cc.game.onStart&&cc.game.onStart.bind(cc.game))}},{key:"addPersistRootNode",value:function(e){if(cc.Node.isNode(e)&&e.uuid){var t=e.uuid;if(!this._persistRootNodes[t]){var i=cc.director._scene;if(cc.isValid(i))if(e.parent){if(!(e.parent instanceof cc.Scene))return void B(3801);if(e.parent!==i)return void B(3802)}else e.parent=i;(this._persistRootNodes[t]=e)._persistNode=!0}}else B(3800)}},{key:"removePersistRootNode",value:function(e){var t=e.uuid||"";e===this._persistRootNodes[t]&&(delete this._persistRootNodes[t],e._persistNode=!1)}},{key:"isPersistRootNode",value:function(e){return e._persistNode}},{key:"prepare",value:function(t){if(this._prepared)t&&t();else{var e=this.config.jsList;if(e&&0<e.length){var i=this;cc.loader.load(e,function(e){if(e)throw new Error(JSON.stringify(e));i._prepareFinished(t)})}else this._prepareFinished(t)}}},{key:"_initEngine",value:function(){this._initEvents(),this.emit(d.EVENT_ENGINE_INITED)}},{key:"_prepareFinished",value:function(e){var t=this;this._prepared=!0,this._initEngine(),console.log("Cocos Creator 3D v"+cc.ENGINE_VERSION);function i(){t._setAnimFrame(),t._runMainLoop(),t.emit(d.EVENT_GAME_INITED),e&&e()}Up.instance.setOnFinish(i),Up.instance.loadFinish=!0}},{key:"_setAnimFrame",value:function(){this._lastTime=new Date;var e=cc.game.config.frameRate;this._frameTime=1e3/e,60!==e&&30!==e?(window.requestAnimationFrame=this._stTime,window.cancelAnimationFrame=this._ctTime):(window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||this._stTime,window.cancelAnimationFrame=window.cancelAnimationFrame||window.cancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.ocancelAnimationFrame||this._ctTime)}},{key:"_stTime",value:function(e){var t=(new Date).getTime(),i=Math.max(0,cc.game._frameTime-(t-cc.game._lastTime)),n=window.setTimeout(function(){e()},i);return cc.game._lastTime=t+i,n}},{key:"_ctTime",value:function(e){window.clearTimeout(e)}},{key:"_runMainLoop",value:function(){var t,i=this,e=i.config,n=cc.director,r=!0,a=e.frameRate;q(!!e.showFPS),t=function(e){if(!i._paused){if(i._intervalId=window.requestAnimationFrame(t),30===a&&(r=!r))return;n.mainLoop(e)}},i._intervalId=window.requestAnimationFrame(t),i._paused=!1}},{key:"_initConfig",value:function(e){"number"!=typeof e.debugMode&&(e.debugMode=0),e.exposeClassName=!!e.exposeClassName,"number"!=typeof e.frameRate&&(e.frameRate=60);var t=e.renderMode;("number"!=typeof t||2<t||t<0)&&(e.renderMode=0),"boolean"!=typeof e.registerSystemEvent&&(e.registerSystemEvent=!0),e.showFPS=!!e.showFPS,this._sceneInfos=e.scenes||[],this.collisionMatrix=e.collisionMatrix||[],this.groupList=e.groupList||[],R(e.debugMode),this.config=e,this._configLoaded=!0}},{key:"_determineRenderType",value:function(){var e=this.config,t=parseInt(e.renderMode);this.renderType=d.RENDER_TYPE_CANVAS;var i=!1;if(0===t?cc.sys.capabilities.opengl?(this.renderType=d.RENDER_TYPE_WEBGL,i=!0):cc.sys.capabilities.canvas&&(this.renderType=d.RENDER_TYPE_CANVAS,i=!0):1===t&&cc.sys.capabilities.canvas?(this.renderType=d.RENDER_TYPE_CANVAS,i=!0):2===t&&cc.sys.capabilities.opengl&&(this.renderType=d.RENDER_TYPE_WEBGL,i=!0),!i)throw new Error(G(3820,t))}},{key:"_initRenderer",value:function(){if(!this._rendererInitialized){var e,t,i,n,r,a,s=this.config.id,o=cc.sys.platform===cc.sys.WECHAT_GAME,l=cc.sys.platform===cc.sys.QQ_PLAY;if(o)this.container=n=document.createElement("div"),this.frame=n.parentNode===document.body?document.documentElement:n.parentNode,i=cc.sys.browserType===cc.sys.BROWSER_TYPE_WECHAT_GAME_SUB?window.sharedCanvas||wx.getSharedCanvas():window.canvas,this.canvas=i;else if(l)this.container=cc.container=document.createElement("div"),this.frame=document.documentElement,this.canvas=i=window.canvas;else{var c=s?s instanceof HTMLElement?s:document.querySelector(s)||document.querySelector("#"+s):null;if(!c)throw new Error(G(200));"CANVAS"===c.tagName?(e=c.width,t=c.height,this.canvas=i=c,this.container=n=document.createElement("div"),i&&i.parentNode&&i.parentNode.insertBefore(n,i)):("DIV"!==c.tagName&&B(3819),e=c.clientWidth,t=c.clientHeight,this.canvas=i=document.createElement("canvas"),this.container=n=document.createElement("div"),c.appendChild(n)),n.setAttribute("id","Cocos3dGameContainer"),n.appendChild(i),this.frame=n.parentNode===document.body?document.documentElement:n.parentNode,a="gameCanvas",-1<(" "+(r=i).className+" ").indexOf(" "+a+" ")||(r.className&&(r.className+=" "),r.className+=a),i.setAttribute("width",e||"480"),i.setAttribute("height",t||"320"),i.setAttribute("tabindex","99")}if(this._determineRenderType(),this.renderType===d.RENDER_TYPE_WEBGL){var u=!!window.WebGL2RenderingContext,h=navigator.userAgent.toLowerCase();-1!==h.indexOf("safari")&&-1===h.indexOf("chrome")&&(u=!1),u&&cc.WebGL2GFXDevice?this._gfxDevice=new cc.WebGL2GFXDevice:cc.WebGLGFXDevice&&(this._gfxDevice=new cc.WebGLGFXDevice);var f={canvasElm:i,debug:!0,devicePixelRatio:window.devicePixelRatio,nativeWidth:Math.floor(screen.width*cc.view._devicePixelRatio),nativeHeight:Math.floor(screen.height*cc.view._devicePixelRatio)};!this._gfxDevice.initialize(f)&&u&&(this._gfxDevice=new cc.WebGLGFXDevice,this._gfxDevice.initialize(f))}if(!this._gfxDevice)return console.error("can not support canvas rendering in 3D"),void(this.renderType=d.RENDER_TYPE_CANVAS);this.canvas.oncontextmenu=function(){if(!cc._isContextMenuEnable)return!1},this._rendererInitialized=!0,this.emit(d.EVENT_RENDERER_INITED)}}},{key:"_initEvents",value:function(){var i,e=window;void 0!==document.hidden?i="hidden":void 0!==document.mozHidden?i="mozHidden":void 0!==document.msHidden?i="msHidden":void 0!==document.webkitHidden&&(i="webkitHidden");var t=!1;function n(){t||(t=!0,cc.game.emit(d.EVENT_HIDE))}function r(){t&&(t=!1,cc.game.emit(d.EVENT_SHOW))}if(i)for(var a=["visibilitychange","mozvisibilitychange","msvisibilitychange","webkitvisibilitychange","qbrowserVisibilityChange"],s=0;s<a.length;s++)document.addEventListener(a[s],function(e){var t=document[i];(t=t||e.hidden)?n():r()});else e.addEventListener("blur",n),e.addEventListener("focus",r);-1<navigator.userAgent.indexOf("MicroMessenger")&&(e.onfocus=r),cc.sys.browserType!==cc.sys.BROWSER_TYPE_WECHAT_GAME_SUB&&(wx.onShow&&wx.onShow(r),wx.onHide&&wx.onHide(n)),"onpageshow"in window&&"onpagehide"in window&&(e.addEventListener("pagehide",n),e.addEventListener("pageshow",r),document.addEventListener("pagehide",n),document.addEventListener("pageshow",r)),this.on(d.EVENT_HIDE,function(){cc.game.pause()}),this.on(d.EVENT_SHOW,function(){cc.game.resume()})}}]),d}());Vp.EVENT_HIDE="game_on_hide",Vp.EVENT_SHOW="game_on_show",Vp.EVENT_GAME_INITED="game_inited",Vp.EVENT_ENGINE_INITED="engine_inited",Vp.EVENT_RENDERER_INITED="renderer_inited",Vp.RENDER_TYPE_CANVAS=0,Vp.RENDER_TYPE_WEBGL=1,Vp.RENDER_TYPE_OPENGL=2,cc.Game=Vp;var Gp=P2("game",cc.game=new Vp),Hp=P2("System",function(){function e(){y(this,e),this._id="",this._priority=0,this._executeInEditMode=!1}return l(e,[{key:"init",value:function(){}},{key:"update",value:function(e){}},{key:"postUpdate",value:function(e){}},{key:"priority",set:function(e){this._priority=e},get:function(){return this._priority}},{key:"id",set:function(e){this._id=e},get:function(){return this._id}}],[{key:"sortByPriority",value:function(e,t){return e._priority<t._priority?1:e._priority>t.priority?-1:0}}]),e}());function qp(e,t){var i=cc.loader.getItem(e);if(i){var n=i.dependKeys;if(n)for(var r=0;r<n.length;r++){var a=n[r];t[a]||(t[a]=!0,qp(a,t))}}}function jp(e,t){if(e._uuid){var i=cc.loader._getReferenceKey(e);t[i]||(t[i]=!0,qp(i,t))}}function Wp(e,t){for(var i=Object.getOwnPropertyNames(e),n=0;n<i.length;n++){var r=e[i[n]];if("object"===de(r)&&r)if(Array.isArray(r))for(var a=0;a<r.length;a++){var s=r[a];s instanceof vu&&jp(s,t)}else if(r.constructor&&r.constructor!==Object)r instanceof vu&&jp(r,t);else for(var o=Object.getOwnPropertyNames(r),l=0;l<o.length;l++){var c=r[o[l]];c instanceof vu&&jp(c,t)}}}function Xp(e,t){for(var i=0;i<e._components.length;i++)Wp(e._components[i],t);for(var n=0;n<e._children.length;n++)Xp(e._children[n],t)}function Yp(e){var t={};return qp(e,t),Object.keys(t)}var Qp=P2("EventMouse",function(){function n(e,t){var i;return y(this,n),(i=x(this,g(n).call(this,$o.MOUSE,t))).movementX=0,i.movementY=0,i._eventType=void 0,i._button=0,i._x=0,i._y=0,i._prevX=0,i._prevY=0,i._scrollX=0,i._scrollY=0,i._eventType=e,i}return p(n,$o),l(n,[{key:"setScrollData",value:function(e,t){this._scrollX=e,this._scrollY=t}},{key:"getScrollX",value:function(){return this._scrollX}},{key:"getScrollY",value:function(){return this._scrollY}},{key:"setLocation",value:function(e,t){this._x=e,this._y=t}},{key:"getLocation",value:function(e){return e=e||new Mi,Mi.set(e,this._x,this._y),e}},{key:"getLocationInView",value:function(e){return e=e||new Mi,Mi.set(e,this._x,cc.view._designResolutionSize.height-this._y),e}},{key:"getUILocation",value:function(e){return e=e||new Mi,Mi.set(e,this._x,this._y),cc.view._convertPointWithScale(e),e}},{key:"_setPrevCursor",value:function(e,t){this._prevX=e,this._prevY=t}},{key:"getPreviousLocation",value:function(e){return e=e||new Mi,Mi.set(e,this._prevX,this._prevY),e}},{key:"getUIPreviousLocation",value:function(e){return e=e||new Mi,Mi.set(e,this._prevX,this._prevY),cc.view._convertPointWithScale(e),e}},{key:"getDelta",value:function(e){return e=e||new Mi,Mi.set(e,this._x-this._prevX,this._y-this._prevY),e}},{key:"getDeltaX",value:function(){return this._x-this._prevX}},{key:"getDeltaY",value:function(){return this._y-this._prevY}},{key:"getUIDelta",value:function(e){return e=e||new Mi,Mi.set(e,(this._x-this._prevX)/cc.view.getScaleX(),(this._y-this._prevY)/cc.view.getScaleY()),e}},{key:"getUIDeltaX",value:function(){return(this._x-this._prevX)/cc.view.getScaleX()}},{key:"getUIDeltaY",value:function(){return(this._y-this._prevY)/cc.view.getScaleY()}},{key:"setButton",value:function(e){this._button=e}},{key:"getButton",value:function(){return this._button}},{key:"getLocationX",value:function(){return this._x}},{key:"getLocationY",value:function(){return this._y}},{key:"getUILocationX",value:function(){var e=cc.view.getViewportRect();return(this._x-e.x)/cc.view.getScaleX()}},{key:"getUILocationY",value:function(){var e=cc.view.getViewportRect();return(this._y-e.y)/cc.view.getScaleY()}}]),n}());Qp.NONE=0,Qp.DOWN=1,Qp.UP=2,Qp.MOVE=3,Qp.SCROLL=4,Qp.BUTTON_LEFT=0,Qp.BUTTON_RIGHT=2,Qp.BUTTON_MIDDLE=1,Qp.BUTTON_4=3,Qp.BUTTON_5=4,Qp.BUTTON_6=5,Qp.BUTTON_7=6,Qp.BUTTON_8=7;var Kp=P2("EventTouch",function(){function n(e,t){var i;return y(this,n),(i=x(this,g(n).call(this,$o.TOUCH,t))).touch=null,i._eventCode=0,i.simulate=!1,i._touches=void 0,i._eventCode=0,i._touches=e||[],i}return p(n,$o),l(n,[{key:"getEventCode",value:function(){return this._eventCode}},{key:"getTouches",value:function(){return this._touches}},{key:"_setEventCode",value:function(e){this._eventCode=e}},{key:"_setTouches",value:function(e){this._touches=e}},{key:"setLocation",value:function(e,t){this.touch&&this.touch.setTouchInfo(this.touch.getID(),e,t)}},{key:"getLocation",value:function(e){return this.touch?this.touch.getLocation(e):new Mi}},{key:"getUILocation",value:function(e){return this.touch?this.touch.getUILocation(e):new Mi}},{key:"getLocationInView",value:function(e){return this.touch?this.touch.getLocationInView(e):new Mi}},{key:"getUILocationInView",value:function(e){return this.touch?this.touch.getLocationInView(e):new Mi}},{key:"getPreviousLocation",value:function(e){return this.touch?this.touch.getPreviousLocation(e):new Mi}},{key:"getStartLocation",value:function(e){return this.touch?this.touch.getStartLocation(e):new Mi}},{key:"getUIStartLocation",value:function(e){return this.touch?this.touch.getUIStartLocation(e):new Mi}},{key:"getID",value:function(){return this.touch?this.touch.getID():null}},{key:"getDelta",value:function(e){return this.touch?this.touch.getDelta(e):new Mi}},{key:"getUIDelta",value:function(e){return this.touch?this.touch.getUIDelta(e):new Mi}},{key:"getDeltaX",value:function(e){return this.touch?this.touch.getDelta(e).x:0}},{key:"getDeltaY",value:function(e){return this.touch?this.touch.getDelta(e).y:0}},{key:"getLocationX",value:function(){return this.touch?this.touch.getLocationX():0}},{key:"getLocationY",value:function(){return this.touch?this.touch.getLocationY():0}}]),n}());Kp.MAX_TOUCHES=5,Kp.BEGAN=0,Kp.MOVED=1,Kp.ENDED=2,Kp.CANCELLED=3;var Zp=P2("EventAcceleration",function(){function n(e,t){var i;return y(this,n),(i=x(this,g(n).call(this,$o.ACCELERATION,t))).acc=void 0,i.acc=e,i}return p(n,$o),n}()),Jp=P2("EventKeyboard",function(){function r(e,t,i){var n;return y(this,r),(n=x(this,g(r).call(this,$o.KEYBOARD,i))).keyCode=void 0,n.rawEvent=void 0,n.isPressed=void 0,"number"==typeof e?n.keyCode=e:(n.keyCode=e.keyCode,n.rawEvent=e),n.isPressed=t,n}return p(r,$o),r}());$o.EventMouse=Qp,$o.EventTouch=Kp,$o.EventAcceleration=Zp,$o.EventKeyboard=Jp;var $p=function(){function n(e,t,i){y(this,n),this.owner=null,this.mask=null,this._previousIn=!1,this._target=null,this._onEvent=void 0,this._type=void 0,this._listenerID=void 0,this._registered=!1,this._fixedPriority=0,this._node=null,this._paused=!0,this._isEnabled=!0,this._onEvent=i,this._type=e||0,this._listenerID=t||""}return l(n,[{key:"onEvent",get:function(){return this._onEvent}}],[{key:"create",value:function(e){cc.assertID(e&&e.event,1900);var t=e.event;delete e.event;var i=null;if(t===cc.EventListener.TOUCH_ONE_BY_ONE?i=new i_:t===cc.EventListener.TOUCH_ALL_AT_ONCE?i=new n_:t===cc.EventListener.MOUSE?i=new t_:t===cc.EventListener.KEYBOARD?i=new a_:t===cc.EventListener.ACCELERATION&&(i=new r_(e.callback),delete e.callback),i)for(var n=0,r=Object.keys(e);n<r.length;n++){var a=r[n];i[a]=e[a]}return i}}]),l(n,[{key:"_setPaused",value:function(e){this._paused=e}},{key:"_isPaused",value:function(){return this._paused}},{key:"_setRegistered",value:function(e){this._registered=e}},{key:"_isRegistered",value:function(){return this._registered}},{key:"_getType",value:function(){return this._type}},{key:"_getListenerID",value:function(){return this._listenerID}},{key:"_setFixedPriority",value:function(e){this._fixedPriority=e}},{key:"_getFixedPriority",value:function(){return this._fixedPriority}},{key:"_setSceneGraphPriority",value:function(e){this._target=e,this._node=e}},{key:"_getSceneGraphPriority",value:function(){return this._node}},{key:"checkAvailable",value:function(){return null!==this._onEvent}},{key:"clone",value:function(){return null}},{key:"setEnabled",value:function(e){this._isEnabled=e}},{key:"isEnabled",value:function(){return this._isEnabled}}]),n}();$p.UNKNOWN=0,$p.TOUCH_ONE_BY_ONE=1,$p.TOUCH_ALL_AT_ONCE=2,$p.KEYBOARD=3,$p.MOUSE=4,$p.ACCELERATION=6,$p.CUSTOM=8,$p.ListenerID={MOUSE:"__cc_mouse",TOUCH_ONE_BY_ONE:"__cc_touch_one_by_one",TOUCH_ALL_AT_ONCE:"__cc_touch_all_at_once",KEYBOARD:"__cc_keyboard",ACCELERATION:"__cc_acceleration"};var e_=$p.ListenerID,t_=function(){function i(){var t;return y(this,i),(t=x(this,g(i).call(this,$p.MOUSE,e_.MOUSE,null))).onMouseDown=null,t.onMouseUp=null,t.onMouseMove=null,t.onMouseScroll=null,t._onEvent=function(e){return t._callback(e)},t}return p(i,$p),l(i,[{key:"_callback",value:function(e){var t=cc.Event.EventMouse;switch(e._eventType){case t.DOWN:this.onMouseDown&&this.onMouseDown(e);break;case t.UP:this.onMouseUp&&this.onMouseUp(e);break;case t.MOVE:this.onMouseMove&&this.onMouseMove(e);break;case t.SCROLL:this.onMouseScroll&&this.onMouseScroll(e)}}},{key:"clone",value:function(){var e=new i;return e.onMouseDown=this.onMouseDown,e.onMouseUp=this.onMouseUp,e.onMouseMove=this.onMouseMove,e.onMouseScroll=this.onMouseScroll,e}},{key:"checkAvailable",value:function(){return!0}}]),i}(),i_=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this,$p.TOUCH_ONE_BY_ONE,e_.TOUCH_ONE_BY_ONE,null))).swallowTouches=!1,e.onTouchBegan=null,e.onTouchMoved=null,e.onTouchEnded=null,e.onTouchCancelled=null,e._claimedTouches=[],e}return p(t,$p),l(t,[{key:"setSwallowTouches",value:function(e){this.swallowTouches=e}},{key:"isSwallowTouches",value:function(){return this.swallowTouches}},{key:"clone",value:function(){var e=new t;return e.onTouchBegan=this.onTouchBegan,e.onTouchMoved=this.onTouchMoved,e.onTouchEnded=this.onTouchEnded,e.onTouchCancelled=this.onTouchCancelled,e.swallowTouches=this.swallowTouches,e}},{key:"checkAvailable",value:function(){return!!this.onTouchBegan||(cc.logID(1801),!1)}}]),t}(),n_=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this,$p.TOUCH_ALL_AT_ONCE,e_.TOUCH_ALL_AT_ONCE,null))).onTouchesBegan=null,e.onTouchesMoved=null,e.onTouchesEnded=null,e.onTouchesCancelled=null,e}return p(t,$p),l(t,[{key:"clone",value:function(){var e=new t;return e.onTouchesBegan=this.onTouchesBegan,e.onTouchesMoved=this.onTouchesMoved,e.onTouchesEnded=this.onTouchesEnded,e.onTouchesCancelled=this.onTouchesCancelled,e}},{key:"checkAvailable",value:function(){return null!==this.onTouchesBegan||null!==this.onTouchesMoved||null!==this.onTouchesEnded||null!==this.onTouchesCancelled||(cc.logID(1802),!1)}}]),t}(),r_=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,$p.ACCELERATION,e_.ACCELERATION,null)))._onAccelerationEvent=null,t._onEvent=function(e){return t._callback(e)},t._onAccelerationEvent=e,t}return p(i,$p),l(i,[{key:"_callback",value:function(e){this._onAccelerationEvent&&this._onAccelerationEvent(e.acc,e)}},{key:"checkAvailable",value:function(){return cc.assertID(this._onAccelerationEvent,1803),!0}},{key:"clone",value:function(){return new i(this._onAccelerationEvent)}}]),i}(),a_=function(){function i(){var t;return y(this,i),(t=x(this,g(i).call(this,$p.KEYBOARD,e_.KEYBOARD,null))).onKeyPressed=null,t.onKeyReleased=null,t._onEvent=function(e){return t._callback(e)},t}return p(i,$p),l(i,[{key:"_callback",value:function(e){e.isPressed?this.onKeyPressed&&this.onKeyPressed(e.keyCode,e):this.onKeyReleased&&this.onKeyReleased(e.keyCode,e)}},{key:"clone",value:function(){var e=new i;return e.onKeyPressed=this.onKeyPressed,e.onKeyReleased=this.onKeyReleased,e}},{key:"checkAvailable",value:function(){return null!==this.onKeyPressed||null!==this.onKeyReleased||(cc.logID(1800),!1)}}]),i}(),s_=(cc.EventListener=$p).ListenerID;var o_=function(){function e(){y(this,e),this.gt0Index=0,this._fixedListeners=[],this._sceneGraphListeners=[]}return l(e,[{key:"size",value:function(){return this._fixedListeners.length+this._sceneGraphListeners.length}},{key:"empty",value:function(){return 0===this._fixedListeners.length&&0===this._sceneGraphListeners.length}},{key:"push",value:function(e){0===e._getFixedPriority()?this._sceneGraphListeners.push(e):this._fixedListeners.push(e)}},{key:"clearSceneGraphListeners",value:function(){this._sceneGraphListeners.length=0}},{key:"clearFixedListeners",value:function(){this._fixedListeners.length=0}},{key:"clear",value:function(){this._sceneGraphListeners.length=0,this._fixedListeners.length=0}},{key:"getFixedPriorityListeners",value:function(){return this._fixedListeners}},{key:"getSceneGraphPriorityListeners",value:function(){return this._sceneGraphListeners}}]),e}();var l_,c_,u_=P2("eventManager",new(function(){function e(){y(this,e),this._listenersMap={},this._priorityDirtyFlagMap={},this._nodeListenersMap={},this._toAddedListeners=[],this._toRemovedListeners=[],this._dirtyListeners=[],this._inDispatch=0,this._isEnabled=!1,this._internalCustomListenerIDs=[]}return l(e,[{key:"pauseTarget",value:function(e,t){var i=1<arguments.length&&void 0!==t&&t;if(e instanceof cc._BaseNode){var n=this._nodeListenersMap[e.uuid];if(n)for(var r=0;r<n.length;++r){n[r]._setPaused(!0)}if(!0===i){var a=e.children;if(a)for(var s=0;s<a.length;++s){var o=a[s];this.pauseTarget(o,!0)}}}else cc.warnID(3506)}},{key:"resumeTarget",value:function(e,t){var i=1<arguments.length&&void 0!==t&&t;if(e instanceof cc._BaseNode){var n=this._nodeListenersMap[e.uuid];if(n)for(var r=0;r<n.length;++r){n[r]._setPaused(!1)}if(this._setDirtyForNode(e),!0===i&&0<e.children.length){var a=e.children;if(a)for(var s=0;s<a.length;++s){var o=a[s];this.resumeTarget(o,!0)}}}else cc.warnID(3506)}},{key:"frameUpdateListeners",value:function(){var e=this._listenersMap,t=this._priorityDirtyFlagMap;for(var i in e)e[i].empty()&&(delete t[i],delete e[i]);var n=this._toAddedListeners;if(0!==n.length){for(var r=0,a=n.length;r<a;r++)this._forceAddEventListener(n[r]);n.length=0}0!==this._toRemovedListeners.length&&this._cleanToRemovedListeners()}},{key:"hasEventListener",value:function(e){return!!this._getListeners(e)}},{key:"addListener",value:function(e,t){if(cc.assertID(e&&t,3503),cc.js.isNumber(t)||t instanceof cc._BaseNode){if(e instanceof cc.EventListener){if(e._isRegistered())return void cc.logID(3505)}else cc.assertID(!cc.js.isNumber(t),3504),e=cc.EventListener.create(e);if(e.checkAvailable()){if(cc.js.isNumber(t)){if(0===t)return void cc.logID(3500);e._setSceneGraphPriority(null),e._setFixedPriority(t),e._setRegistered(!0),e._setPaused(!1),this._addListener(e)}else{if(!function(e){for(;e;){if(e.getComponent("cc.CanvasComponent"))return!0;e=e.parent}return!1}(t))return void cc.logID(3512);e._setSceneGraphPriority(t),e._setFixedPriority(0),e._setRegistered(!0),this._addListener(e)}return e}}else cc.warnID(3506)}},{key:"addCustomListener",value:function(e,t){var i=$p.create({event:cc.EventListener.CUSTOM,eventName:e,callback:t});return this.addListener(i,1),i}},{key:"removeListener",value:function(e){if(null!=e){var t=!1,i=this._listenersMap;for(var n in i){var r=i[n],a=r.getFixedPriorityListeners(),s=r.getSceneGraphPriorityListeners();if((t=this._removeListenerInVector(s,e))?this._setDirty(e._getListenerID(),2):(t=this._removeListenerInVector(a,e))&&this._setDirty(e._getListenerID(),1),r.empty()&&(delete this._priorityDirtyFlagMap[e._getListenerID()],delete i[n]),t)break}if(!t)for(var o=this._toAddedListeners,l=o.length-1;0<=l;l--){var c=o[l];if(c===e){cc.js.array.removeAt(o,l),c._setRegistered(!1);break}}}}},{key:"removeListeners",value:function(e,t){var i=1<arguments.length&&void 0!==t&&t;if(cc.js.isNumber(e)||e instanceof cc._BaseNode)if(void 0!==e._id){var n=this._nodeListenersMap[e._id];if(n){for(var r=cc.js.array.copy(n),a=0;a<r.length;++a){var s=r[a];this.removeListener(s)}delete this._nodeListenersMap[e._id]}for(var o=this._toAddedListeners,l=0;l<o.length;){var c=o[l];c._getSceneGraphPriority()===e?(c._setSceneGraphPriority(null),c._setRegistered(!1),o.splice(l,1)):++l}if(!0===i)for(var u=e.getChildren(),h=0;h<u.length;++h){var f=u[h];this.removeListeners(f,!0)}}else e===cc.EventListener.TOUCH_ONE_BY_ONE?this._removeListenersForListenerID(s_.TOUCH_ONE_BY_ONE):e===cc.EventListener.TOUCH_ALL_AT_ONCE?this._removeListenersForListenerID(s_.TOUCH_ALL_AT_ONCE):e===cc.EventListener.MOUSE?this._removeListenersForListenerID(s_.MOUSE):e===cc.EventListener.ACCELERATION?this._removeListenersForListenerID(s_.ACCELERATION):e===cc.EventListener.KEYBOARD?this._removeListenersForListenerID(s_.KEYBOARD):cc.logID(3501);else cc.warnID(3506)}},{key:"removeCustomListeners",value:function(e){this._removeListenersForListenerID(e)}},{key:"removeAllListeners",value:function(){var e=this._listenersMap,t=this._internalCustomListenerIDs;for(var i in e)-1===t.indexOf(i)&&this._removeListenersForListenerID(i)}},{key:"setPriority",value:function(e,t){if(null!=e){var i=this._listenersMap;for(var n in i){var r=i[n].getFixedPriorityListeners();if(r)if(-1!==r.indexOf(e))return null!=e._getSceneGraphPriority()&&cc.logID(3502),void(e._getFixedPriority()!==t&&(e._setFixedPriority(t),this._setDirty(e._getListenerID(),1)))}}}},{key:"setEnabled",value:function(e){this._isEnabled=e}},{key:"isEnabled",value:function(){return this._isEnabled}},{key:"dispatchEvent",value:function(e){if(this._isEnabled)if(this._updateDirtyFlagForSceneGraph(),this._inDispatch++,e&&e.getType){if(e.getType().startsWith(cc.Event.TOUCH))return this._dispatchTouchEvent(e),void this._inDispatch--;var t=function(e){var t=$o,i=e.type;return i===t.ACCELERATION?s_.ACCELERATION:i===t.KEYBOARD?s_.KEYBOARD:i.startsWith(t.MOUSE)?s_.MOUSE:(i.startsWith(t.TOUCH)&&cc.logID(2e3),"")}(e);this._sortEventListeners(t);var i=this._listenersMap[t];null!=i&&(this._dispatchEventToListeners(i,this._onListenerCallback,e),this._onUpdateListeners(i)),this._inDispatch--}else cc.errorID(3511)}},{key:"_onListenerCallback",value:function(e,t){t.currentTarget=e._target;var i=e.onEvent;return i&&i(t),t.isStopped()}},{key:"dispatchCustomEvent",value:function(e,t){var i=new cc.Event.EventCustom(e);i.setUserData(t),this.dispatchEvent(i)}},{key:"_setDirtyForNode",value:function(e){var t=this._nodeListenersMap[e._id];if(void 0!==t)for(var i=0,n=t.length;i<n;i++){var r=t[i]._getListenerID();null==this._dirtyListeners[r]&&(this._dirtyListeners[r]=!0)}if(0<e.children.length)for(var a=e.children,s=0,o=a?a.length:0;s<o;s++)this._setDirtyForNode(a[s])}},{key:"_addListener",value:function(e){0===this._inDispatch?this._forceAddEventListener(e):this._toAddedListeners.push(e)}},{key:"_forceAddEventListener",value:function(e){var t=e._getListenerID(),i=this._listenersMap[t];if(i||(i=new o_,this._listenersMap[t]=i),i.push(e),0===e._getFixedPriority()){this._setDirty(t,2);var n=e._getSceneGraphPriority();null===n&&cc.logID(3507),this._associateNodeAndEventListener(n,e),n.activeInHierarchy&&this.resumeTarget(n)}else this._setDirty(t,1)}},{key:"_getListeners",value:function(e){return this._listenersMap[e]}},{key:"_updateDirtyFlagForSceneGraph",value:function(){var e=this._dirtyListeners;for(var t in e)this._setDirty(t,2);this._dirtyListeners.length=0}},{key:"_removeAllListenersInVector",value:function(e){if(e)for(var t,i=e.length-1;0<=i;i--)(t=e[i])._setRegistered(!1),null!=t._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(t._getSceneGraphPriority(),t),t._setSceneGraphPriority(null)),0===this._inDispatch&&cc.js.array.removeAt(e,i)}},{key:"_removeListenersForListenerID",value:function(e){var t=this._listenersMap[e];if(t){var i=t.getFixedPriorityListeners(),n=t.getSceneGraphPriorityListeners();this._removeAllListenersInVector(n),this._removeAllListenersInVector(i),delete this._priorityDirtyFlagMap[e],this._inDispatch||(t.clear(),delete this._listenersMap[e])}for(var r=this._toAddedListeners,a=r.length-1;0<=a;a--){var s=r[a];s&&s._getListenerID()===e&&cc.js.array.removeAt(r,a)}}},{key:"_sortEventListeners",value:function(e){var t=0,i=this._priorityDirtyFlagMap;i[e]&&(t=i[e]),0!==t&&(i[e]=0,1&t&&this._sortListenersOfFixedPriority(e),2&t&&cc.director.getScene()&&this._sortListenersOfSceneGraphPriority(e))}},{key:"_sortListenersOfSceneGraphPriority",value:function(e){var t=this._getListeners(e);if(t){var i=t.getSceneGraphPriorityListeners();i&&0!==i.length&&t.getSceneGraphPriorityListeners().sort(this._sortEventListenersOfSceneGraphPriorityDes)}}},{key:"_sortEventListenersOfSceneGraphPriorityDes",value:function(e,t){var i=e._getSceneGraphPriority(),n=t._getSceneGraphPriority();if(!(t&&n&&n._activeInHierarchy))return-1;if(!e||!i||!i._activeInHierarchy)return 1;for(var r=i,a=n,s=!1;r.parent._id!==a.parent._id;)r=null===r.parent.parent?(s=!0)&&n:r.parent,a=null===a.parent.parent?(s=!0)&&i:a.parent;if(r._id===a._id){if(r._id===n._id)return-1;if(r._id===i._id)return 1}var o=r.getSiblingIndex(),l=a.getSiblingIndex();return s?o-l:l-o}},{key:"_sortListenersOfFixedPriority",value:function(e){var t=this._listenersMap[e];if(t){var i=t.getFixedPriorityListeners();if(i&&0!==i.length){i.sort(this._sortListenersOfFixedPriorityAsc);for(var n=0,r=i.length;n<r&&!(0<=i[n]._getFixedPriority());)++n;t.gt0Index=n}}}},{key:"_sortListenersOfFixedPriorityAsc",value:function(e,t){return e._getFixedPriority()-t._getFixedPriority()}},{key:"_onUpdateListeners",value:function(e){var t=e.getFixedPriorityListeners(),i=e.getSceneGraphPriorityListeners(),n=this._toRemovedListeners;if(i)for(var r=i.length-1;0<=r;r--){var a=i[r];if(!a._isRegistered()){cc.js.array.removeAt(i,r);var s=n.indexOf(a);-1!==s&&n.splice(s,1)}}if(t)for(var o=t.length-1;0<=o;o--){var l=t[o];if(!l._isRegistered()){cc.js.array.removeAt(t,o);var c=n.indexOf(l);-1!==c&&n.splice(c,1)}}i&&0===i.length&&e.clearSceneGraphListeners(),t&&0===t.length&&e.clearFixedListeners()}},{key:"_updateTouchListeners",value:function(e){var t=this._inDispatch;if(cc.assertID(0<t,3508),!(1<t)){var i;(i=this._listenersMap[s_.TOUCH_ONE_BY_ONE])&&this._onUpdateListeners(i),(i=this._listenersMap[s_.TOUCH_ALL_AT_ONCE])&&this._onUpdateListeners(i),cc.assertID(1===t,3509);var n=this._toAddedListeners;if(0!==n.length){for(var r=0,a=n.length;r<a;r++)this._forceAddEventListener(n[r]);this._toAddedListeners.length=0}0!==this._toRemovedListeners.length&&this._cleanToRemovedListeners()}}},{key:"_cleanToRemovedListeners",value:function(){for(var e=this._toRemovedListeners,t=0;t<e.length;++t){var i=e[t],n=this._listenersMap[i._getListenerID()];if(n){var r=n.getFixedPriorityListeners(),a=n.getSceneGraphPriorityListeners();if(a){var s=a.indexOf(i);-1!==s&&a.splice(s,1)}if(r){var o=r.indexOf(i);-1!==o&&r.splice(o,1)}}}e.length=0}},{key:"_onTouchEventCallback",value:function(e,t){if(!e._isRegistered())return!1;var i=t.event,n=i.touch;i.currentTarget=e._getSceneGraphPriority();var r=!1,a=-1,s=i.getEventCode();return s===Kp.BEGAN?e.onTouchBegan&&(r=e.onTouchBegan(n,i))&&e._isRegistered()&&e._claimedTouches.push(n):0<e._claimedTouches.length&&-1!==(a=e._claimedTouches.indexOf(n))&&(r=!0,s===Kp.MOVED&&e.onTouchMoved?e.onTouchMoved(n,i):s===Kp.ENDED?(e.onTouchEnded&&e.onTouchEnded(n,i),e._isRegistered()&&e._claimedTouches.splice(a,1)):s===Kp.CANCELLED&&(e.onTouchCancelled&&e.onTouchCancelled(n,i),e._isRegistered()&&e._claimedTouches.splice(a,1))),i.isStopped()?(u_._updateTouchListeners(i),!0):!!(r&&e._isRegistered()&&e.swallowTouches)&&(t.needsMutableSet&&t.touches.splice(n,1),!0)}},{key:"_dispatchTouchEvent",value:function(e){this._sortEventListeners(s_.TOUCH_ONE_BY_ONE),this._sortEventListeners(s_.TOUCH_ALL_AT_ONCE);var t=this._getListeners(s_.TOUCH_ONE_BY_ONE),i=this._getListeners(s_.TOUCH_ALL_AT_ONCE);if(null!==t||null!==i){var n=e.getTouches(),r=cc.js.array.copy(n),a={event:e,needsMutableSet:t&&i,touches:r,selTouch:null};if(t)for(var s=0;s<n.length;++s){var o=n[s];e.touch=o,e.propagationStopped=e.propagationImmediateStopped=!1,this._dispatchEventToListeners(t,this._onTouchEventCallback,a)}i&&0<r.length&&(this._dispatchEventToListeners(i,this._onTouchesEventCallback,{event:e,touches:r}),e.isStopped())||this._updateTouchListeners(e)}}},{key:"_onTouchesEventCallback",value:function(e,t){if(!e._isRegistered())return!1;var i=t.event,n=t.touches,r=i.getEventCode();return i.currentTarget=e._getSceneGraphPriority(),r===Kp.BEGAN&&e.onTouchesBegan?e.onTouchesBegan(n,i):r===Kp.MOVED&&e.onTouchesMoved?e.onTouchesMoved(n,i):r===Kp.ENDED&&e.onTouchesEnded?e.onTouchesEnded(n,i):r===Kp.CANCELLED&&e.onTouchesCancelled&&e.onTouchesCancelled(n,i),!!i.isStopped()&&(u_._updateTouchListeners(i),!0)}},{key:"_associateNodeAndEventListener",value:function(e,t){var i=this._nodeListenersMap[e.uuid];i||(i=[],this._nodeListenersMap[e.uuid]=i),i.push(t)}},{key:"_dissociateNodeAndEventListener",value:function(e,t){var i=this._nodeListenersMap[e.uuid];i&&(cc.js.array.remove(i,t),0===i.length&&delete this._nodeListenersMap[e.uuid])}},{key:"_dispatchEventToListeners",value:function(e,t,i){var n=!1,r=e.getFixedPriorityListeners(),a=e.getSceneGraphPriorityListeners(),s=0;if(r&&0!==r.length)for(;s<e.gt0Index;++s){var o=r[s];if(o.isEnabled()&&!o._isPaused()&&o._isRegistered()&&t(o,i)){n=!0;break}}if(a&&!n)for(var l=0;l<a.length;++l){var c=a[l];if(c.isEnabled()&&!c._isPaused()&&c._isRegistered()&&t(c,i)){n=!0;break}}if(r&&!n)for(;s<r.length;++s){var u=r[s];if(u.isEnabled()&&!u._isPaused()&&u._isRegistered()&&t(u,i)){n=!0;break}}}},{key:"_setDirty",value:function(e,t){var i=this._priorityDirtyFlagMap;null==i[e]?i[e]=t:i[e]=t|i[e]}},{key:"_sortNumberAsc",value:function(e,t){return e-t}},{key:"_removeListenerInCallback",value:function(e,t){if(null==e)return!1;for(var i=e.length-1;0<=i;i--){var n=e[i];if(n._onCustomEvent===t||n.onEvent===t)return n._setRegistered(!1),null!=n._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(n._getSceneGraphPriority(),n),n._setSceneGraphPriority(null)),0===this._inDispatch?cc.js.array.removeAt(e,i):this._toRemovedListeners.push(n),!0}return!1}},{key:"_removeListenerInVector",value:function(e,t){if(null==e)return!1;for(var i=e.length-1;0<=i;i--){var n=e[i];if(n===t)return n._setRegistered(!1),null!=n._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(n._getSceneGraphPriority(),n),n._setSceneGraphPriority(null)),0===this._inDispatch?cc.js.array.removeAt(e,i):this._toRemovedListeners.push(n),!0}return!1}}]),e}()));cc.eventManager=u_,(c_=l_=l_||{})[c_.DIRECTIONAL=0]="DIRECTIONAL",c_[c_.SPHERE=1]="SPHERE",c_[c_.SPOT=2]="SPOT",c_[c_.UNKNOWN=3]="UNKNOWN";function h_(e){return 4*Math.PI*Math.PI*e*e}var f_=function(){function n(e,t,i){y(this,n),this._enabled=!0,this._color=new Fi(1,1,1),this._useColorTemp=!1,this._colorTemp=6550,this._colorTempRGB=new Fi(1,1,1),this._scene=void 0,this._node=void 0,this._type=void 0,this._name=void 0,this._scene=e,this._name=t,this._type=l_.UNKNOWN,this._node=i}return l(n,[{key:"enabled",set:function(e){this._enabled=e},get:function(){return this._enabled}},{key:"color",set:function(e){this._color.set(e)},get:function(){return this._color}},{key:"useColorTemperature",set:function(e){this._useColorTemp=e},get:function(){return this._useColorTemp}},{key:"colorTemperature",set:function(e){this._colorTemp=e,function(e,t){t<1e3?t=1e3:15e3<t&&(t=15e3);var i=t*t,n=(.860117757+.000154118254*t+1.28641212e-7*i)/(1+.000842420235*t+7.08145163e-7*i),r=(.317398726+422806245e-13*t+4.20481691e-8*i)/(1-289741816e-13*t+1.61456053e-7*i),a=2*n-8*r+4,s=3*n/a,o=2*r/a,l=1/o*s,c=1/o*(1-s-o);e.x=3.2404542*l-1.5371385+-.4985314*c,e.y=-.969266*l+1.8760108+.041556*c,e.z=.0556434*l-.2040259+1.0572252*c}(this._colorTempRGB,this._colorTemp)},get:function(){return this._colorTemp}},{key:"colorTemperatureRGB",get:function(){return this._colorTempRGB}},{key:"node",set:function(e){this._node=e},get:function(){return this._node}},{key:"type",get:function(){return this._type}},{key:"name",get:function(){return this._name}}]),l(n,[{key:"update",value:function(){}}]),n}();(d_=new vs).accurate=!0;var d_,p_,__,v_,m_,y_,g_,b_,x_,S_=function(){var o=new Fi,l=new Fi,c=new hn,u=new vs;u.accurate=!0;var h=new zn,f=new zn,d=new Fi,p=new Fi;return function(e,t,i,n,r,a){zn.fromRT(h,i.node.getWorldRotation(c),t.node.getWorldPosition(o)),zn.invert(f,h),t.getSplitFrustum(u,n,r),u.transform(f),Fi.set(d,u.vertices[0].x,u.vertices[0].y,u.vertices[0].z),Fi.copy(p,d);for(var s=1;s<u.vertices.length;s++)d.x=Math.min(d.x,u.vertices[s].x),d.y=Math.min(d.y,u.vertices[s].y),d.z=Math.min(d.z,u.vertices[s].z),p.x=Math.max(p.x,u.vertices[s].x),p.y=Math.max(p.y,u.vertices[s].y),p.z=Math.max(p.z,u.vertices[s].z);Fi.set(l,(d.x+p.x)/2,(d.y+p.y)/2,p.z),l.z+=a,Fi.transformMat4(o,l,h),zn.fromRT(h,i.node.getWorldRotation(c),o),vs.createOrtho(e,p.x-d.x,p.y-d.y,0,d.z-a-p.z,h)}}(),w_=function(){function t(e){y(this,t),this._device=void 0,this._pipeline=void 0,this._name="",this._priority=0,this._stages=[],this._material=new cp,this._device=e.device,this._pipeline=e}return l(t,[{key:"device",get:function(){return this._device}},{key:"pipeline",get:function(){return this._pipeline}},{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"stages",get:function(){return this._stages}},{key:"material",get:function(){return this._material}}]),l(t,[{key:"resize",value:function(e,t){var i=this._stages,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}a.resize(e,t)}}},{key:"render",value:function(e){var t=this._stages,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.render(e)}}},{key:"createStage",value:function(e,t){var i=new e(this);return i.initialize(t)?(this._stages.push(i),this._stages.sort(function(e,t){return e.priority-t.priority}),i):null}},{key:"destroyStages",value:function(){var e=this._stages,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._stages=[]}}]),t}(),T_=function(){function t(e){if(y(this,t),this._flow=void 0,this._pipeline=void 0,this._device=void 0,this._name="",this._priority=0,this._framebuffer=null,this._cmdBuff=null,this._clearColors=void 0,this._clearDepth=1,this._clearStencil=0,this._renderArea=void 0,this._pass=null,this._pso=null,this._flow=e,this._pipeline=e.pipeline,this._device=e.device,!this._flow.pipeline.root.device)throw new Error("");this._device=this._flow.pipeline.root.device,this._clearColors=[{r:.3,g:.6,b:.9,a:1}],this._renderArea={x:0,y:0,width:0,height:0}}return l(t,[{key:"flow",get:function(){return this._flow}},{key:"pipeline",get:function(){return this._pipeline}},{key:"priority",get:function(){return this._priority}},{key:"framebuffer",get:function(){return this._framebuffer}}]),l(t,[{key:"setClearColor",value:function(e){0<this._clearColors.length?this._clearColors[0]=e:this._clearColors.push(e)}},{key:"setClearColors",value:function(e){this._clearColors=e}},{key:"setClearDepth",value:function(e){this._clearDepth=e}},{key:"setClearStencil",value:function(e){this._clearStencil=e}},{key:"setRenderArea",value:function(e,t){this._renderArea.width=e,this._renderArea.height=t}}]),t}(),E_=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._hTexSampler=0,t._hBlendTexSampler=0,t._bindingLayout=null,t}return p(i,T_),l(i,[{key:"initialize",value:function(e){return void 0!==e.name&&(this._name=e.name),this._priority=e.priority,void 0!==e.framebuffer&&(this._framebuffer=e.framebuffer),this._cmdBuff=this._device.createCommandBuffer({allocator:this._device.commandAllocator,type:Ec.PRIMARY}),this.rebuild(),!0}},{key:"destroy",value:function(){this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)}},{key:"resize",value:function(e,t){}},{key:"rebuild",value:function(){this._pass=this._flow.material.passes[0],this._hTexSampler=this._pass.getBinding("u_texSampler");var e=this._pipeline.globalBindings.get(Jh.BLOCK.name);this._pso=this._pass.createPipelineState(),this._bindingLayout=this._pso.pipelineLayout.layouts[0],this._pass.bindBuffer(Jh.BLOCK.binding,e.buffer),this._pass.bindTextureView(this._hTexSampler,this._pipeline.curShadingTexView),this._pipeline.useSMAA&&(this._hBlendTexSampler=this._pass.getBinding("u_blendTexSampler"),this._pass.bindTextureView(this._hBlendTexSampler,this._pipeline.smaaBlendTexView)),this._pass.update(),this._bindingLayout.update()}},{key:"render",value:function(e){var t=e.camera;if(this._cmdBuff){this._renderArea.width=t.width,this._renderArea.height=t.height;var i=e.window.framebuffer;this._cmdBuff.begin(),this._cmdBuff.beginRenderPass(i,this._renderArea,Vc.ALL,[{r:0,g:0,b:0,a:1}],1,0),this._cmdBuff.bindPipelineState(this._pso),this._cmdBuff.bindBindingLayout(this._pso.pipelineLayout.layouts[0]),this._cmdBuff.bindInputAssembler(this._pipeline.quadIA),this._cmdBuff.draw(this._pipeline.quadIA),this._cmdBuff.endRenderPass(),this._cmdBuff.end()}this._device.queue.submit([this._cmdBuff])}}]),i}(),C_=function(){function t(e){return y(this,t),x(this,g(t).call(this,e))}return p(t,w_),l(t,[{key:"initialize",value:function(e){void 0!==e.name&&(this._name=e.name),this._priority=e.priority,this._material.initialize({effectName:"pipeline/tonemap",defines:{CC_USE_SMAA:this._pipeline.useSMAA}});var t=this._pipeline.root.mainWindow.framebuffer;return this.createStage(E_,{name:"ToneMapStage",priority:0,framebuffer:t}),!0}},{key:"destroy",value:function(){this._material&&this._material.destroy(),this.destroyStages()}},{key:"rebuild",value:function(){this._material&&(this._material.destroy(),this._material.initialize({effectName:"pipeline/tonemap",defines:{CC_USE_SMAA:this._pipeline.useSMAA}}));var e=this._stages,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.rebuild()}}}]),t}();(__=p_=p_||{})[__.ORTHO=0]="ORTHO",__[__.PERSPECTIVE=1]="PERSPECTIVE",(m_=v_=v_||{})[m_.F1_8=0]="F1_8",m_[m_.F2_0=1]="F2_0",m_[m_.F2_2=2]="F2_2",m_[m_.F2_5=3]="F2_5",m_[m_.F2_8=4]="F2_8",m_[m_.F3_2=5]="F3_2",m_[m_.F3_5=6]="F3_5",m_[m_.F4_0=7]="F4_0",m_[m_.F4_5=8]="F4_5",m_[m_.F5_0=9]="F5_0",m_[m_.F5_6=10]="F5_6",m_[m_.F6_3=11]="F6_3",m_[m_.F7_1=12]="F7_1",m_[m_.F8_0=13]="F8_0",m_[m_.F9_0=14]="F9_0",m_[m_.F10_0=15]="F10_0",m_[m_.F11_0=16]="F11_0",m_[m_.F13_0=17]="F13_0",m_[m_.F14_0=18]="F14_0",m_[m_.F16_0=19]="F16_0",m_[m_.F18_0=20]="F18_0",m_[m_.F20_0=21]="F20_0",m_[m_.F22_0=22]="F22_0",(g_=y_=y_||{})[g_.ISO100=0]="ISO100",g_[g_.ISO200=1]="ISO200",g_[g_.ISO400=2]="ISO400",g_[g_.ISO800=3]="ISO800",(x_=b_=b_||{})[x_.D1=0]="D1",x_[x_.D2=1]="D2",x_[x_.D4=2]="D4",x_[x_.D8=3]="D8",x_[x_.D15=4]="D15",x_[x_.D30=5]="D30",x_[x_.D60=6]="D60",x_[x_.D125=7]="D125",x_[x_.D250=8]="D250",x_[x_.D500=9]="D500",x_[x_.D1000=10]="D1000",x_[x_.D2000=11]="D2000",x_[x_.D4000=12]="D4000";var A_=[1.8,2,2.2,2.5,2.8,3.2,3.5,4,4.5,5,5.6,6.3,7.1,8,9,10,11,13,14,16,18,20,22],k_=[1,.5,.25,1/8,1/15,1/30,1/60,.008,.004,.002,.001,5e-4,25e-5],R_=[100,200,400,800],O_=new Fi,M_=new Fi,I_=new zn,L_=new zn,z_=Vc.STENCIL<<1,B_=function(){function i(e,t){y(this,i),this._scene=void 0,this._name=void 0,this._enabled=!1,this._proj=void 0,this._isWindowSize=!0,this._width=void 0,this._height=void 0,this._screenScale=void 0,this._aspect=void 0,this._orthoHeight=10,this._fov=mi(45),this._nearClip=1,this._farClip=1e3,this._clearStencil=0,this._clearDepth=1,this._clearFlag=Vc.NONE,this._clearColor={r:0,g:0,b:0,a:0},this._viewport=new Zn(0,0,1,1),this._isProjDirty=!0,this._matView=new zn,this._matProj=new zn,this._matProjInv=new zn,this._matViewProj=new zn,this._matViewProjInv=new zn,this._frustum=new vs,this._forward=new Fi,this._position=new Fi,this._node=null,this._view=void 0,this._visibility=lf,this._priority=0,this._aperture=v_.F16_0,this._apertureValue=void 0,this._shutter=b_.D125,this._shutterValue=0,this._iso=y_.ISO100,this._isoValue=0,this._ec=0,this._exposure=0,this._scene=e,this._name=t.name,this._node=t.node,this._proj=t.projection,this._priority=t.priority||0,this._apertureValue=A_[this._aperture],this._shutterValue=k_[this._shutter],this._isoValue=R_[this._iso],this.updateExposure(),this._aspect=this._width=this._height=this._screenScale=1,this._view=this._scene.root.createView({camera:this,name:this._name,priority:this._priority,flows:t.flows}),this.changeTargetWindow(t.window),console.log("Create Camera: "+this._name+" "+this._width+" x "+this._height)}return l(i,[{key:"destroy",value:function(){this._scene.root.destroyView(this._view)}},{key:"resize",value:function(e,t){this._width=e,this._height=t,this._aspect=this._width/this._height,this._isProjDirty=!0}},{key:"setFixedSize",value:function(e,t){this._width=e,this._height=t,this._aspect=this._width/this._height,this._isWindowSize=!1}},{key:"update",value:function(e){var t=0<arguments.length&&void 0!==e&&e;if(this._node){if((this._node.hasChangedFlags||t)&&(zn.invert(this._matView,this.node.worldMatrix),this._forward.x=-this._matView.m02,this._forward.y=-this._matView.m06,this._forward.z=-this._matView.m10,this._node.getWorldPosition(this._position)),this._isProjDirty){if(this._proj===p_.PERSPECTIVE)zn.perspective(this._matProj,this._fov,this._aspect,this._nearClip,this._farClip);else{var i=this._orthoHeight*this._aspect,n=this._orthoHeight;zn.ortho(this._matProj,-i,i,-n,n,this._nearClip,this._farClip)}zn.invert(this._matProjInv,this._matProj)}(this._node.hasChangedFlags||this._isProjDirty||t)&&(zn.multiply(this._matViewProj,this._matProj,this._matView),zn.invert(this._matViewProjInv,this._matViewProj),this._frustum.update(this._matViewProj,this._matViewProjInv)),this._isProjDirty=!1}}},{key:"getSplitFrustum",value:function(e,t,i){if(this._node){if(t=Math.max(t,this._nearClip),i=Math.min(i,this._farClip),zn.invert(this._matView,this.node.worldMatrix),this._proj===p_.PERSPECTIVE)zn.perspective(I_,this._fov,this._aspect,t,i);else{var n=this._orthoHeight*this._aspect,r=this._orthoHeight;zn.ortho(I_,-n,n,-r,r,t,i)}zn.multiply(L_,I_,this._matView),zn.invert(I_,L_),e.update(L_,I_)}}},{key:"changeTargetWindow",value:function(e){var t=0<arguments.length&&void 0!==e?e:null,i=this._scene,n=t||i.root.mainWindow;n&&(this._view.window=n,this.resize(n.width,n.height))}},{key:"screenPointToRay",value:function(e,t,i){var n=this._viewport.x*this._width,r=this._viewport.y*this._height,a=this._viewport.width*this._width,s=this._viewport.height*this._height;return Fi.set(O_,(t-n)/a*2-1,(i-r)/s*2-1,1),Fi.transformMat4(O_,O_,this._matViewProjInv),this._proj===p_.PERSPECTIVE?this._node&&this._node.getWorldPosition(M_):(Fi.set(M_,(t-n)/a*2-1,(i-r)/s*2-1,-1),Fi.transformMat4(M_,M_,this._matViewProjInv)),Ja.fromPoints(e,M_,O_)}},{key:"screenToWorld",value:function(e,t){var i=this._viewport.x*this._width,n=this._viewport.y*this._height,r=this._viewport.width*this._width,a=this._viewport.height*this._height;return this._proj===p_.PERSPECTIVE?(Fi.set(e,(t.x-i)/r*2-1,(t.y-n)/a*2-1,1),Fi.transformMat4(e,e,this._matViewProjInv),this._node&&this._node.getWorldPosition(O_),Fi.lerp(e,O_,e,vi(this._nearClip/this._farClip,1,t.z))):(Fi.set(e,(t.x-i)/r*2-1,(t.y-n)/a*2-1,2*t.z-1),Fi.transformMat4(e,e,this.matViewProjInv)),e}},{key:"worldToScreen",value:function(e,t){var i=this._viewport.x*this._width,n=this._viewport.y*this._height,r=this._viewport.width*this._width,a=this._viewport.height*this._height;return Fi.transformMat4(e,t,this.matViewProj),e.x=i+.5*(e.x+1)*r,e.y=n+.5*(e.y+1)*a,e.z=.5*e.z+.5,e}},{key:"updateExposure",value:function(){var e=Math.log2(this._apertureValue*this._apertureValue/this._shutterValue*100/this._isoValue);this._exposure=.833333/Math.pow(2,e)}},{key:"screenScale",set:function(e){this._screenScale=e},get:function(){return this._screenScale}},{key:"enabled",set:function(e){this._enabled=e,this._view.enable(e)},get:function(){return this._enabled}},{key:"view",get:function(){return this._view}},{key:"node",set:function(e){this._node=e},get:function(){return this._node}},{key:"isWindowSize",get:function(){return this._isWindowSize},set:function(e){this._isWindowSize=e}},{key:"orthoHeight",set:function(e){this._orthoHeight=e,this._isProjDirty=!0},get:function(){return this._orthoHeight}},{key:"projectionType",set:function(e){this._proj=e,this._isProjDirty=!0},get:function(){return this._proj}},{key:"viewport",set:function(e){this._viewport=e},get:function(){return this._viewport}},{key:"fov",set:function(e){this._fov=e,this._isProjDirty=!0},get:function(){return this._fov}},{key:"nearClip",set:function(e){this._nearClip=e,this._isProjDirty=!0},get:function(){return this._nearClip}},{key:"farClip",set:function(e){this._farClip=e,this._isProjDirty=!0},get:function(){return this._farClip}},{key:"clearColor",set:function(e){this._clearColor.r=e.r,this._clearColor.g=e.g,this._clearColor.b=e.b,this._clearColor.a=e.a},get:function(){return this._clearColor}},{key:"clearDepth",set:function(e){this._clearDepth=e},get:function(){return this._clearDepth}},{key:"clearStencil",set:function(e){this._clearStencil=e},get:function(){return this._clearStencil}},{key:"clearFlag",set:function(e){this._clearFlag=e},get:function(){return this._clearFlag}},{key:"scene",get:function(){return this._scene}},{key:"name",get:function(){return this._name}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"aspect",get:function(){return this._aspect}},{key:"matView",get:function(){return this._matView}},{key:"matProj",get:function(){return this._matProj}},{key:"matProjInv",get:function(){return this._matProjInv}},{key:"matViewProj",get:function(){return this._matViewProj}},{key:"matViewProjInv",get:function(){return this._matViewProjInv}},{key:"frustum",get:function(){return this._frustum}},{key:"forward",get:function(){return this._forward}},{key:"position",get:function(){return this._position}},{key:"visibility",set:function(e){this._visibility=e,this._view.visibility=e},get:function(){return this._visibility}},{key:"priority",get:function(){return this._view.priority},set:function(e){this._priority=e,this._view.priority=this._priority}},{key:"aperture",set:function(e){this._aperture=e,this._apertureValue=A_[this._aperture],this.updateExposure()},get:function(){return this._aperture}},{key:"apertureValue",get:function(){return this._apertureValue}},{key:"shutter",set:function(e){this._shutter=e,this._shutterValue=k_[this._shutter],this.updateExposure()},get:function(){return this._shutter}},{key:"shutterValue",get:function(){return this._shutterValue}},{key:"iso",set:function(e){this._iso=e,this._isoValue=R_[this._iso],this.updateExposure()},get:function(){return this._iso}},{key:"isoValue",get:function(){return this._isoValue}},{key:"ec",set:function(e){this._ec=e},get:function(){return this._ec}},{key:"exposure",get:function(){return this._exposure}}]),i}(),P_=new Mi,D_=P2("Touch",function(){function n(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;y(this,n),this._point=new Mi,this._prevPoint=new Mi,this._lastModified=0,this._id=null,this._startPoint=new Mi,this._startPointCaptured=!1,this.setTouchInfo(i,e,t)}return l(n,[{key:"getLocation",value:function(e){return(e=e||new Mi).set(this._point.x,this._point.y),e}},{key:"getLocationX",value:function(){return this._point.x}},{key:"getLocationY",value:function(){return this._point.y}},{key:"getUILocation",value:function(e){return(e=e||new Mi).set(this._point.x,this._point.y),cc.view._convertPointWithScale(e),e}},{key:"getUILocationX",value:function(){var e=cc.view.getViewportRect();return(this._point.x-e.x)/cc.view.getScaleX()}},{key:"getUILocationY",value:function(){var e=cc.view.getViewportRect();return(this._point.y-e.y)/cc.view.getScaleY()}},{key:"getPreviousLocation",value:function(e){return(e=e||new Mi).set(this._prevPoint.x,this._prevPoint.y),e}},{key:"getUIPreviousLocation",value:function(e){return(e=e||new Mi).set(this._prevPoint.x,this._prevPoint.y),cc.view._convertPointWithScale(e),e}},{key:"getStartLocation",value:function(e){return(e=e||new Mi).set(this._startPoint.x,this._startPoint.y),e}},{key:"getUIStartLocation",value:function(e){return(e=e||new Mi).set(this._startPoint.x,this._startPoint.y),cc.view._convertPointWithScale(e),e}},{key:"getDelta",value:function(e){return(e=e||new Mi).set(this._point),e.subtract(this._prevPoint),e}},{key:"getUIDelta",value:function(e){return e=e||new Mi,P_.set(this._point),P_.subtract(this._prevPoint),e.set(cc.view.getScaleX(),cc.view.getScaleY()),Mi.divide(e,P_,e),e}},{key:"getLocationInView",value:function(e){return(e=e||new Mi).set(this._point.x,cc.view._designResolutionSize.height-this._point.y),e}},{key:"getPreviousLocationInView",value:function(e){return(e=e||new Mi).set(this._prevPoint.x,cc.view._designResolutionSize.height-this._prevPoint.y),e}},{key:"getStartLocationInView",value:function(e){return(e=e||new Mi).set(this._startPoint.x,cc.view._designResolutionSize.height-this._startPoint.y),e}},{key:"getID",value:function(){return this._id}},{key:"setTouchInfo",value:function(e,t,i){var n=0<arguments.length&&void 0!==e?e:null,r=1<arguments.length?t:void 0,a=2<arguments.length?i:void 0;this._prevPoint=this._point,this._point=new Mi(r||0,a||0),this._id=n,this._startPointCaptured||(this._startPoint=new Mi(this._point),this._startPointCaptured=!0)}},{key:"_setPoint",value:function(e,t){"object"===de(e)?(this._point.x=e.x,this._point.y=e.y):(this._point.x=e||0,this._point.y=t||0)}},{key:"_setPrevPoint",value:function(e,t){"object"===de(e)?this._prevPoint=new Mi(e.x,e.y):this._prevPoint=new Mi(e||0,t||0)}}]),n}());cc.Touch=D_;function F_(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0;y(this,F_),this.x=void 0,this.y=void 0,this.z=void 0,this.timestamp=void 0,this.x=e,this.y=t,this.z=i,this.timestamp=n}var N_,U_,V_,G_=yl.TOUCH_TIMEOUT,H_=new Mi,q_=new Mi,j_=new(function(){function e(){y(this,e),this._mousePressed=!1,this._isRegisterEvent=!1,this._preTouchPoint=new Mi,this._prevMousePoint=new Mi,this._preTouchPool=[],this._preTouchPoolPointer=0,this._touches=[],this._touchesIntegerDict={},this._indexBitsUsed=0,this._maxTouches=8,this._accelEnabled=!1,this._accelInterval=.2,this._accelMinus=1,this._accelCurTime=0,this._acceleration=null,this._accelDeviceEvent=null,this._glView=null,this._minus=0,this._pointLocked=!1}return l(e,[{key:"handleTouchesBegin",value:function(e){for(var t=[],i=this._touchesIntegerDict,n=ul.now(),r=0;r<e.length;++r){var a=e[r],s=a.getID();if(null!==s)if(void 0===i[s]){var o=this._getUnUsedIndex();if(-1===o){cc.logID(2300,o);continue}var l=new D_(a._point.x,a._point.y,a.getID());(this._touches[o]=l)._lastModified=n,l._setPrevPoint(a._prevPoint),i[s]=o,t.push(l)}}if(0<t.length){var c=new Kp(t);c._eventCode=Kp.BEGAN,u_.dispatchEvent(c)}}},{key:"handleTouchesMove",value:function(e){for(var t=[],i=this._touches,n=ul.now(),r=0;r<e.length;++r){var a=e[r],s=a.getID();if(null!==s){var o=this._touchesIntegerDict[s];void 0!==o&&i[o]&&(i[o]._setPoint(a._point),i[o]._setPrevPoint(a._prevPoint),i[o]._lastModified=n,t.push(i[o]))}}if(0<t.length){var l=new Kp(t);l._eventCode=Kp.MOVED,u_.dispatchEvent(l)}}},{key:"handleTouchesEnd",value:function(e){var t=this.getSetOfTouchesEndOrCancel(e);if(0<t.length){var i=new Kp(t);i._eventCode=Kp.ENDED,u_.dispatchEvent(i)}this._preTouchPool.length=0}},{key:"handleTouchesCancel",value:function(e){var t=this.getSetOfTouchesEndOrCancel(e);if(0<t.length){var i=new Kp(t);i._eventCode=Kp.CANCELLED,u_.dispatchEvent(i)}this._preTouchPool.length=0}},{key:"getSetOfTouchesEndOrCancel",value:function(e){for(var t=[],i=this._touches,n=this._touchesIntegerDict,r=0;r<e.length;++r){var a=e[r],s=a.getID();if(null!==s){var o=n[s];void 0!==o&&i[o]&&(i[o]._setPoint(a._point),i[o]._setPrevPoint(a._prevPoint),t.push(i[o]),this._removeUsedIndexBit(o),delete n[s])}}return t}},{key:"getHTMLElementPosition",value:function(e){if(ul.platform===ul.WECHAT_GAME)return{left:0,top:0,width:window.innerWidth,height:window.innerHeight};var t=document.documentElement,i=window.pageXOffset-t.clientLeft,n=window.pageYOffset-t.clientTop;if(e.getBoundingClientRect){var r=e.getBoundingClientRect();return{left:r.left+i,top:r.top+n,width:r.width,height:r.height}}return e instanceof HTMLCanvasElement?{left:i,top:n,width:e.width,height:e.height}:{left:i,top:n,width:parseInt(e.style.width||"0",void 0),height:parseInt(e.style.height||"0",void 0)}}},{key:"getPreTouch",value:function(e){for(var t=null,i=this._preTouchPool,n=e.getID(),r=i.length-1;0<=r;r--)if(i[r].getID()===n){t=i[r];break}return t=t||e}},{key:"setPreTouch",value:function(e){for(var t=!1,i=this._preTouchPool,n=e.getID(),r=i.length-1;0<=r;r--)if(i[r].getID()===n){i[r]=e,t=!0;break}t||(i.length<=50?i.push(e):(i[this._preTouchPoolPointer]=e,this._preTouchPoolPointer=(this._preTouchPoolPointer+1)%50))}},{key:"getTouchByXY",value:function(e,t,i,n){var r=this._preTouchPoint,a=this._glView.convertToLocationInView(t,i,n);this._pointLocked&&(a.x=r.x+e.movementX,a.y=r.y-e.movementY);var s=new D_(a.x,a.y,0);return s._setPrevPoint(r.x,r.y),r.x=a.x,r.y=a.y,s}},{key:"getMouseEvent",value:function(e,t,i){var n=this._prevMousePoint,r=new Qp(i);return r._setPrevCursor(n.x,n.y),n.x=e.x,n.y=e.y,this._glView._convertMouseToLocation(n,t),r.setLocation(n.x,n.y),r}},{key:"getPointByEvent",value:function(e,t){return null!=e.pageX?{x:e.pageX,y:e.pageY}:(ul.platform===ul.WECHAT_GAME?(t.left=0,t.top=0):(t.left-=document.body.scrollLeft,t.top-=document.body.scrollTop),{x:e.clientX,y:e.clientY})}},{key:"getTouchesByEvent",value:function(e,t){for(var i=[],n=this._glView,r=this._preTouchPoint,a=e.changedTouches.length,s=0;s<a;s++){var o=e.changedTouches[s];if(o){var l=void 0;l=ul.BROWSER_TYPE_FIREFOX===ul.browserType?n.convertToLocationInView(o.pageX,o.pageY,t,H_):n.convertToLocationInView(o.clientX,o.clientY,t,H_);var c=void 0;null!=o.identifier?(c=new D_(l.x,l.y,o.identifier),this.getPreTouch(c).getLocation(q_),c._setPrevPoint(q_.x,q_.y),this.setPreTouch(c)):(c=new D_(l.x,l.y))._setPrevPoint(r.x,r.y),r.x=l.x,r.y=l.y,i.push(c)}}return i}},{key:"registerSystemEvent",value:function(e){if(!this._isRegisterEvent&&e){this._glView=cc.view;var t=ul.isMobile,i="mouse"in ul.capabilities,n="touches"in ul.capabilities;ul.platform===ul.WECHAT_GAME&&(i=!(n=!(t=!1))),i&&this._registerMouseEvents(e,t),window.navigator.msPointerEnabled&&this._registerMousePointerEvents(e),n&&this._registerTouchEvents(e),cc.sys.browserType!==cc.sys.BROWSER_TYPE_WECHAT_GAME_SUB&&this._registerKeyboardEvent(),this._isRegisterEvent=!0}}},{key:"setAccelerometerEnabled",value:function(e){if(this._accelEnabled!==e){this._accelEnabled=e;var t=cc.director.getScheduler();t.enableForTarget(this),this._accelEnabled?(this._registerAccelerometerEvent(),this._accelCurTime=0,t.scheduleUpdate(this)):(this._unregisterAccelerometerEvent(),this._accelCurTime=0,t.unscheduleUpdate(this))}}},{key:"didAccelerate",value:function(e){if(this._accelEnabled){var t=this._acceleration,i=0,n=0,r=0;if(this._accelDeviceEvent===window.DeviceMotionEvent){var a=e.accelerationIncludingGravity;a&&(i=this._accelMinus*(a.x||0)*.1,n=this._accelMinus*(a.y||0)*.1,r=.1*(a.z||0))}else{var s=e;i=(s.gamma||0)/90*.981,n=-(s.beta||0)/90*.981,r=(s.alpha||0)/90*.981}if(cc.view._isRotated){var o=i;i=-n,n=o}t.x=i,t.y=n,t.z=r,t.timestamp=e.timeStamp||Date.now();var l=t.x;90===window.orientation?(t.x=-t.y,t.y=l):-90===window.orientation?(t.x=t.y,t.y=-l):180===window.orientation&&(t.x=-t.x,t.y=-t.y),cc.sys.os===cc.sys.OS_ANDROID&&cc.sys.browserType!==cc.sys.BROWSER_TYPE_MOBILE_QQ&&(t.x=-t.x,t.y=-t.y)}}},{key:"update",value:function(e){this._accelCurTime>this._accelInterval&&(this._accelCurTime-=this._accelInterval,u_.dispatchEvent(new Zp(this._acceleration))),this._accelCurTime+=e}},{key:"setAccelerometerInterval",value:function(e){this._accelInterval!==e&&(this._accelInterval=e)}},{key:"_getUnUsedIndex",value:function(){for(var e=this._indexBitsUsed,t=cc.sys.now(),i=0;i<this._maxTouches;i++){if(!(1&e))return this._indexBitsUsed|=1<<i,i;var n=this._touches[i];if(t-n._lastModified>G_){this._removeUsedIndexBit(i);var r=n.getID();return null!==r&&delete this._touchesIntegerDict[r],i}e>>=1}return-1}},{key:"_removeUsedIndexBit",value:function(e){if(!(e<0||e>=this._maxTouches)){var t=1<<e;t=~t,this._indexBitsUsed&=t}}},{key:"_registerMouseEvents",value:function(e,t){this._registerPointerLockEvent(),t||this._registerWindowMouseEvents(e),this._registerElementMouseEvents(e,t)}},{key:"_registerPointerLockEvent",value:function(){function e(){var e=cc.game.canvas;document.pointerLockElement===e||document.mozPointerLockElement===e?t._pointLocked=!0:t._pointLocked=!1}var t=this;"onpointerlockchange"in document?document.addEventListener("pointerlockchange",e,!1):"onmozpointerlockchange"in document&&document.addEventListener("mozpointerlockchange",e,!1)}},{key:"_registerWindowMouseEvents",value:function(r){var a=this;window.addEventListener("mousedown",function(){a._mousePressed=!0},!1),window.addEventListener("mouseup",function(e){if(a._mousePressed){a._mousePressed=!1;var t=a.getHTMLElementPosition(r),i=a.getPointByEvent(e,t);if(!Jn(t.left,t.top,t.width,t.height).contains(new Mi(i.x,i.y))){a.handleTouchesEnd([a.getTouchByXY(e,i.x,i.y,t)]);var n=a.getMouseEvent(i,t,Qp.UP);n.setButton(e.button),u_.dispatchEvent(n)}}},!1)}},{key:"_registerElementMouseEvents",value:function(s,e){function t(e,r,a){s.addEventListener(e,function(e){var t=o.getHTMLElementPosition(s),i=o.getPointByEvent(e,t),n=o.getMouseEvent(i,t,r);n.setButton(e.button),a(e,n,i,t),u_.dispatchEvent(n),e.stopPropagation(),e.preventDefault()})}var o=this;e||(t("mousedown",Qp.DOWN,function(e,t,i,n){o._mousePressed=!0,o.handleTouchesBegin([o.getTouchByXY(e,i.x,i.y,n)]),s.focus()}),t("mouseup",Qp.UP,function(e,t,i,n){o._mousePressed=!1,o.handleTouchesEnd([o.getTouchByXY(e,i.x,i.y,n)])}),t("mousemove",Qp.MOVE,function(e,t,i,n){o.handleTouchesMove([o.getTouchByXY(e,i.x,i.y,n)]),o._mousePressed||t.setButton(null),void 0!==e.movementX&&void 0!==e.movementY&&(t.movementX=e.movementX,t.movementY=e.movementY)})),t("mousewheel",Qp.SCROLL,function(e,t,i,n){t.setScrollData(0,e.wheelDelta)}),t("DOMMouseScroll",Qp.SCROLL,function(e,t,i,n){t.setScrollData(0,-120*e.detail)})}},{key:"_registerMousePointerEvents",value:function(n){function e(e){var i=t[e];n.addEventListener(e,function(e){var t=r.getHTMLElementPosition(n);t.left-=document.documentElement.scrollLeft,t.top-=document.documentElement.scrollTop,i.call(r,[r.getTouchByXY(e,e.clientX,e.clientY,t)]),e.stopPropagation()},!1)}var r=this,t={MSPointerDown:this.handleTouchesBegin,MSPointerMove:this.handleTouchesMove,MSPointerUp:this.handleTouchesEnd,MSPointerCancel:this.handleTouchesCancel};for(var i in t)e(i)}},{key:"_registerTouchEvents",value:function(e){cc.sys.browserType===cc.sys.BROWSER_TYPE_WECHAT_GAME_SUB?this._registerWXGameTouchEvents(e):this._registerHTMLTouchEvents(e)}},{key:"_registerWXGameTouchEvents",value:function(r){function e(n){return function(e){var t=a.getHTMLElementPosition(r),i=document.body;t.left-=i.scrollLeft||0,t.top-=i.scrollTop||0,n(a.getTouchesByEvent(e,t))}}var a=this;wx.onTouchStart(e(function(e){a.handleTouchesBegin(e)})),wx.onTouchEnd(e(function(e){a.handleTouchesEnd(e)})),wx.onTouchMove(e(function(e){a.handleTouchesMove(e)})),wx.onTouchCancel(e(function(e){a.handleTouchesCancel(e)}))}},{key:"_registerHTMLTouchEvents",value:function(r){function e(n){return function(e){if(e.changedTouches){var t=a.getHTMLElementPosition(r),i=document.body;t.left-=i.scrollLeft||0,t.top-=i.scrollTop||0,n(a.getTouchesByEvent(e,t)),e.stopPropagation(),e.preventDefault()}}}var a=this;r.addEventListener("touchstart",e(function(e){a.handleTouchesBegin(e),ul.platform!==ul.WECHAT_GAME&&r.focus()}),!1),r.addEventListener("touchmove",e(function(e){a.handleTouchesMove(e)}),!1),r.addEventListener("touchend",e(function(e){a.handleTouchesEnd(e)}),!1),r.addEventListener("touchcancel",e(function(e){a.handleTouchesCancel(e)}),!1)}},{key:"_registerKeyboardEvent",value:function(){var e=cc.game.canvas;e.addEventListener("keydown",function(e){u_.dispatchEvent(new Jp(e,!0)),e.stopPropagation(),e.preventDefault()},!1),e.addEventListener("keyup",function(e){u_.dispatchEvent(new Jp(e,!1)),e.stopPropagation(),e.preventDefault()},!1)}},{key:"_registerAccelerometerEvent",value:function(){var e=this;this._acceleration=new F_,this._accelDeviceEvent=window.DeviceMotionEvent||window.DeviceOrientationEvent,cc.sys.browserType===cc.sys.BROWSER_TYPE_MOBILE_QQ&&(this._accelDeviceEvent=window.DeviceOrientationEvent);var t=this._accelDeviceEvent===window.DeviceMotionEvent?"devicemotion":"deviceorientation",i=navigator.userAgent;(/Android/.test(i)||/Adr/.test(i)&&cc.sys.browserType===cc.BROWSER_TYPE_UC)&&(this._minus=-1),N_=function(){return e.didAccelerate.apply(e,arguments)},window.addEventListener(t,N_,!1)}},{key:"_unregisterAccelerometerEvent",value:function(){var e=this._accelDeviceEvent===window.DeviceMotionEvent?"devicemotion":"deviceorientation";N_&&window.removeEventListener(e,N_,!1)}}]),e}());Gp.on(Vp.EVENT_ENGINE_INITED,function(){Gp.config.registerSystemEvent&&j_.registerSystemEvent(Gp.canvas)}),cc.internal.inputManager=j_,(V_=U_=U_||P2("SystemEventType",{})).TOUCH_START="touch-start",V_.TOUCH_MOVE="touch-move",V_.TOUCH_END="touch-end",V_.TOUCH_CANCEL="touch-cancel",V_.MOUSE_DOWN="mouse-down",V_.MOUSE_MOVE="mouse-move",V_.MOUSE_UP="mouse-up",V_.MOUSE_WHEEL="mouse-wheel",V_.MOUSE_ENTER="mouse-enter",V_.MOUSE_LEAVE="mouse-leave",V_.KEY_DOWN="keydown",V_.KEY_UP="keyup",V_.DEVICEMOTION="devicemotion",V_.TRANSFORM_CHANGED="transform-changed",V_.POSITION_PART="position-part",V_.ROTATION_PART="rotation-part",V_.SCALE_PART="scale-part",V_.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",V_.SIZE_CHANGED="size-changed",V_.ANCHOR_CHANGED="anchor-changed",V_.CHILD_ADDED="child-added",V_.CHILD_REMOVED="child-removed",V_.PARENT_CHANGED="parent-changed",mt(U_),cc.SystemEventType=U_;var W_=null,X_=null,Y_=null,Q_=null,K_=P2("SystemEvent",function(){function d(){return y(this,d),x(this,g(d).call(this))}return p(d,ll),l(d,[{key:"setAccelerometerEnabled",value:function(e){j_.setAccelerometerEnabled(e)}},{key:"setAccelerometerInterval",value:function(e){j_.setAccelerometerInterval(e)}},{key:"on",value:function(e,t,i){return _(g(d.prototype),"on",this).call(this,e,t,i),e!==U_.KEY_DOWN&&e!==U_.KEY_UP||W_||(W_=$p.create({event:$p.KEYBOARD,onKeyPressed:function(e,t){t.type=U_.KEY_DOWN,Z_.emit(t.type,t)},onKeyReleased:function(e,t){t.type=U_.KEY_UP,Z_.emit(t.type,t)}}),u_.addListener(W_,256)),e===U_.DEVICEMOTION&&(X_||(X_=$p.create({event:$p.ACCELERATION,callback:function(e,t){t.type=U_.DEVICEMOTION,cc.systemEvent.emit(t.type,t)}}),u_.addListener(X_,256))),e!==U_.TOUCH_START&&e!==U_.TOUCH_MOVE&&e!==U_.TOUCH_END&&e!==U_.TOUCH_CANCEL||Y_||(Y_=$p.create({event:$p.TOUCH_ONE_BY_ONE,onTouchBegan:function(e,t){return t.type=U_.TOUCH_START,cc.systemEvent.emit(t.type,e,t),!0},onTouchMoved:function(e,t){t.type=U_.TOUCH_MOVE,cc.systemEvent.emit(t.type,e,t)},onTouchEnded:function(e,t){t.type=U_.TOUCH_END,cc.systemEvent.emit(t.type,e,t)},onTouchCancelled:function(e,t){t.type=U_.TOUCH_CANCEL,cc.systemEvent.emit(t.type,e,t)}}),u_.addListener(Y_,256)),e!==U_.MOUSE_DOWN&&e!==U_.MOUSE_MOVE&&e!==U_.MOUSE_UP&&e!==U_.MOUSE_WHEEL||Q_||(Q_=$p.create({event:$p.MOUSE,onMouseDown:function(e){e.type=U_.MOUSE_DOWN,cc.systemEvent.emit(e.type,e)},onMouseMove:function(e){e.type=U_.MOUSE_MOVE,cc.systemEvent.emit(e.type,e)},onMouseUp:function(e){e.type=U_.MOUSE_UP,cc.systemEvent.emit(e.type,e)},onMouseScroll:function(e){e.type=U_.MOUSE_WHEEL,cc.systemEvent.emit(e.type,e)}}),u_.addListener(Q_,256)),t}},{key:"off",value:function(e,t,i){if(_(g(d.prototype),"off",this).call(this,e,t,i),W_&&(e===U_.KEY_DOWN||e===U_.KEY_UP)){var n=this.hasEventListener(U_.KEY_DOWN),r=this.hasEventListener(U_.KEY_UP);n||r||(u_.removeListener(W_),W_=null)}if(X_&&e===U_.DEVICEMOTION&&(u_.removeListener(X_),X_=null),Y_&&(e===U_.TOUCH_START||e===U_.TOUCH_MOVE||e===U_.TOUCH_END||e===U_.TOUCH_CANCEL)){var a=this.hasEventListener(U_.TOUCH_START),s=this.hasEventListener(U_.TOUCH_MOVE),o=this.hasEventListener(U_.TOUCH_END),l=this.hasEventListener(U_.TOUCH_CANCEL);a||s||o||l||(u_.removeListener(Y_),Y_=null)}if(Q_&&(e===U_.MOUSE_DOWN||e===U_.MOUSE_MOVE||e===U_.MOUSE_UP||e===U_.MOUSE_WHEEL)){var c=this.hasEventListener(U_.MOUSE_DOWN),u=this.hasEventListener(U_.MOUSE_MOVE),h=this.hasEventListener(U_.MOUSE_UP),f=this.hasEventListener(U_.MOUSE_WHEEL);c||u||h||f||(u_.removeListener(Q_),Q_=null)}}}]),d}());K_.EventType=U_,cc.SystemEvent=K_;var Z_=P2("systemEvent",new K_);cc.systemEvent=Z_;$e.fastRemove;var J_=new Array(16),$_=null,ev=new Mi,tv=[U_.TOUCH_START.toString(),U_.TOUCH_MOVE.toString(),U_.TOUCH_END.toString(),U_.TOUCH_CANCEL.toString()],iv=[U_.MOUSE_DOWN.toString(),U_.MOUSE_ENTER.toString(),U_.MOUSE_MOVE.toString(),U_.MOUSE_LEAVE.toString(),U_.MOUSE_UP.toString(),U_.MOUSE_WHEEL.toString()];function nv(e,t){var i=this.owner;return!(!i||!i.uiTransfromComp)&&(e.getUILocation(ev),!!i.uiTransfromComp.isHit(ev,this)&&(t.type=U_.TOUCH_START.toString(),t.touch=e,t.bubbles=!0,i.dispatchEvent(t),!0))}function rv(e,t){var i=this.owner;if(!i||!i.uiTransfromComp)return!1;t.type=U_.TOUCH_MOVE.toString(),t.touch=e,t.bubbles=!0,i.dispatchEvent(t)}function av(e,t){var i=this.owner;i&&i.uiTransfromComp&&(e.getUILocation(ev),i.uiTransfromComp.isHit(ev,this)?t.type=U_.TOUCH_END.toString():t.type=U_.TOUCH_CANCEL.toString(),t.touch=e,t.bubbles=!0,i.dispatchEvent(t))}function sv(e,t){var i=this.owner;i&&i.uiTransfromComp&&(t.type=U_.TOUCH_CANCEL.toString(),t.touch=e,t.bubbles=!0,i.dispatchEvent(t))}function ov(e){var t=this.owner;t&&t.uiTransfromComp&&(ev=e.getUILocation(),t.uiTransfromComp.isHit(ev,this)&&(e.type=U_.MOUSE_DOWN.toString(),e.bubbles=!0,t.dispatchEvent(e)))}function lv(e){var t=this.owner;if(t&&t.uiTransfromComp){if(ev=e.getUILocation(),t.uiTransfromComp.isHit(ev,this))this._previousIn||($_&&$_.eventProcessor.mouseListener&&(e.type=U_.MOUSE_LEAVE,$_.dispatchEvent(e),$_.eventProcessor.mouseListener&&($_.eventProcessor.mouseListener._previousIn=!1)),$_=t,e.type=U_.MOUSE_ENTER.toString(),t.dispatchEvent(e),this._previousIn=!0),e.type=U_.MOUSE_MOVE.toString(),e.bubbles=!0,t.dispatchEvent(e);else{if(!this._previousIn)return;e.type=U_.MOUSE_LEAVE.toString(),t.dispatchEvent(e),this._previousIn=!1,$_=null}e.propagationStopped=!0}}function cv(e){var t=this.owner;t&&t.uiTransfromComp&&(ev=e.getUILocation(),t.uiTransfromComp.isHit(ev,this)&&(e.type=U_.MOUSE_UP.toString(),e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0))}function uv(e){var t=this.owner;t&&t.uiTransfromComp&&(ev=e.getUILocation(),t.uiTransfromComp.isHit(ev,this)&&(e.type=U_.MOUSE_WHEEL.toString(),e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0))}function hv(e){var t=cc.MaskComponent;if(t)for(var i=0,n=e;n&&cc.Node.isNode(n);n=n.parent,++i)if(n.getComponent(t))return{index:i,node:n};return null}function fv(e,t){if(e._persistNode)return!0;var i=0;if(e.eventProcessor.bubblingTargets)for(;i<t.length;++i)if(e.eventProcessor.bubblingTargets.hasEventListener(t[i]))return!0;if(e.eventProcessor.capturingTargets)for(;i<t.length;++i)if(e.eventProcessor.capturingTargets.hasEventListener(t[i]))return!0;return!1}var dv,pv,_v,vv=function(){function t(e){y(this,t),this.bubblingTargets=null,this.capturingTargets=null,this.touchListener=null,this.mouseListener=null,this._node=void 0,this._node=e}return l(t,[{key:"node",get:function(){return this._node}}]),l(t,[{key:"reattach",value:function(){if(this.touchListener){var e=this.touchListener.mask=hv(this._node);this.mouseListener&&(this.mouseListener.mask=e)}else this.mouseListener&&(this.mouseListener.mask=hv(this._node))}},{key:"destroy",value:function(){$_===this._node&&($_=null),(this.touchListener||this.mouseListener)&&(u_.removeListeners(this._node),this.touchListener&&(this.touchListener.owner=null,this.touchListener.mask=null,this.touchListener=null),this.mouseListener&&(this.mouseListener.owner=null,this.mouseListener.mask=null,this.mouseListener=null))}},{key:"on",value:function(e,t,i,n){return this._checknSetupSysEvent(e)?this._onDispatch(e,t,i,n):(this.bubblingTargets||(this.bubblingTargets=new ll),this.bubblingTargets.on(e,t,i))}},{key:"once",value:function(e,t,i,n){(this._checknSetupSysEvent(e)&&n?this.capturingTargets=this.capturingTargets||new ll:this.bubblingTargets=this.bubblingTargets||new ll).once(e,t,i)}},{key:"off",value:function(e,t,i,n){var r=-1!==tv.indexOf(e),a=!r&&-1!==iv.indexOf(e);r||a?(this._offDispatch(e,t,i,n),r?this.touchListener&&!fv(this._node,tv)&&(u_.removeListener(this.touchListener),this.touchListener=null):a&&this.mouseListener&&!fv(this._node,iv)&&(u_.removeListener(this.mouseListener),this.mouseListener=null)):this.bubblingTargets&&this.bubblingTargets.off(e,t,i)}},{key:"emit",value:function(e){if(this.bubblingTargets){for(var t,i=arguments.length,n=new Array(1<i?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];(t=this.bubblingTargets).emit.apply(t,[e].concat(n))}}},{key:"dispatchEvent",value:function(e){!function(e,t){var i,n=0;for(t.target=e,J_.length=0,e.eventProcessor.getCapturingTargets(t.type,J_),t.eventPhase=1,n=J_.length-1;0<=n;--n)if((i=J_[n]).eventProcessor.capturingTargets&&((t.currentTarget=i).eventProcessor.capturingTargets.emit(t.type,t,J_),t.propagationStopped))return J_.length=0;if(J_.length=0,t.eventPhase=2,(t.currentTarget=e).eventProcessor.capturingTargets&&e.eventProcessor.capturingTargets.emit(t.type,t),!t.propagationImmediateStopped&&e.eventProcessor.bubblingTargets&&e.eventProcessor.bubblingTargets.emit(t.type,t),!t.propagationStopped&&t.bubbles)for(e.eventProcessor.getBubblingTargets(t.type,J_),t.eventPhase=3,n=0;n<J_.length;++n)if((i=J_[n]).eventProcessor.bubblingTargets&&((t.currentTarget=i).eventProcessor.bubblingTargets.emit(t.type,t),t.propagationStopped))return J_.length=0;J_.length=0}(this._node,e),J_.length=0}},{key:"hasEventListener",value:function(e){var t=!1;return this.bubblingTargets&&(t=this.bubblingTargets.hasEventListener(e)),!t&&this.capturingTargets&&(t=this.capturingTargets.hasEventListener(e)),t}},{key:"targetOff",value:function(e){this.capturingTargets&&this.capturingTargets.targetOff(e),this.bubblingTargets&&this.bubblingTargets.targetOff(e),this.touchListener&&!fv(this.node,tv)&&(u_.removeListener(this.touchListener),this.touchListener=null),this.mouseListener&&!fv(this.node,iv)&&(u_.removeListener(this.mouseListener),this.mouseListener=null)}},{key:"getCapturingTargets",value:function(e,t){for(var i=this._node.parent;i;)i.eventProcessor.capturingTargets&&i.eventProcessor.capturingTargets.hasEventListener(e)&&t.push(i),i=i.parent}},{key:"getBubblingTargets",value:function(e,t){for(var i=this._node.parent;i;)i.eventProcessor.bubblingTargets&&i.eventProcessor.bubblingTargets.hasEventListener(e)&&t.push(i),i=i.parent}},{key:"_checknSetupSysEvent",value:function(e){var t=this,i=!1,n=!1;return-1!==tv.indexOf(e)?(this.touchListener||(this.touchListener=cc.EventListener.create({event:cc.EventListener.TOUCH_ONE_BY_ONE,swallowTouches:!0,owner:this._node,mask:hv(this._node),onTouchBegan:nv,onTouchMoved:rv,onTouchEnded:av,onTouchCancelled:sv}),u_.addListener(this.touchListener,this._node),i=!0),n=!0):-1!==iv.indexOf(e)&&(this.mouseListener||(this.mouseListener=cc.EventListener.create({event:cc.EventListener.MOUSE,_previousIn:!1,owner:this._node,mask:hv(this._node),onMouseDown:ov,onMouseMove:lv,onMouseUp:cv,onMouseScroll:uv}),u_.addListener(this.mouseListener,this._node),i=!0),n=!0),i&&!this._node.activeInHierarchy&&cc.director.getScheduler().schedule(function(){t._node.activeInHierarchy||u_.pauseTarget(t._node)},this._node,0,0,0,!1),n}},{key:"_onDispatch",value:function(e,t,i,n){if("boolean"==typeof i?(n=i,i=void 0):n=!!n,t){var r=null;return(r=n?this.capturingTargets=this.capturingTargets||new ll:this.bubblingTargets=this.bubblingTargets||new ll).hasEventListener(e,t,i)||r.on(e,t,i),t}cc.errorID(6800)}},{key:"_offDispatch",value:function(e,t,i,n){if("boolean"==typeof i?(n=i,i=void 0):n=!!n,t){var r=n?this.capturingTargets:this.bubblingTargets;r&&r.off(e,t,i)}else this.capturingTargets&&this.capturingTargets.removeAll(e),this.bubblingTargets&&this.bubblingTargets.removeAll(e)}}]),t}();cc.NodeEventProcessor=vv;var mv=P2("Script",ho("cc.Script")(dv=function(){function e(){return y(this,e),x(this,g(e).apply(this,arguments))}return p(e,Mu),e}())||dv);cc._Script=mv;var yv=P2("JavaScript",ho("cc.JavaScript")(pv=function(){function e(){return y(this,e),x(this,g(e).apply(this,arguments))}return p(e,mv),e}())||pv);cc._JavaScript=yv;var gv,bv,xv,Sv,wv,Tv,Ev,Cv,Av,kv,Rv,Ov,Mv,Iv=P2("TypeScript",ho("cc.TypeScript")(_v=function(){function e(){return y(this,e),x(this,g(e).apply(this,arguments))}return p(e,mv),e}())||_v);cc._TypeScript=Iv;var Lv=new ve("Comp"),zv=(No.Flags.IsOnEnableCalled,No.Flags.IsOnLoadCalled),Bv=P2("Component",(gv=ho("cc.Component"),bv=fo({visible:!1}),xv=fo({visible:!1}),Sv=fo({displayName:"Script",type:mv,tooltip:void 0}),wv=fo({visible:!1}),Tv=fo({visible:!1}),Ev=fo({visible:!1}),gv((Mv=Ov=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"node",kv,u(t)),v(t,"_enabled",Rv,u(t)),t._sceneGetter=null,t._id=Lv.getNewId(),t._eventTargets=[],t}return p(a,No),l(a,[{key:"_getRenderScene",value:function(){return this._sceneGetter?this._sceneGetter():this.node.scene._renderScene}},{key:"addComponent",value:function(e){return this.node.addComponent(e)}},{key:"getComponent",value:function(e){return this.node.getComponent(e)}},{key:"getComponents",value:function(e){return this.node.getComponents(e)}},{key:"getComponentInChildren",value:function(e){return this.node.getComponentInChildren(e)}},{key:"getComponentsInChildren",value:function(e){return this.node.getComponentsInChildren(e)}},{key:"destroy",value:function(){_(g(a.prototype),"destroy",this).call(this)&&this._enabled&&this.node.activeInHierarchy&&cc.director._compScheduler.disableComp(this)}},{key:"_onPreDestroy",value:function(){this.unscheduleAllCallbacks();for(var e=this._eventTargets,t=0,i=e.length;t<i;++t){var n=e[t];n&&n.targetOff(this)}e.length=0,cc.director._nodeActivator.destroyComp(this),this.node._removeComponent(this)}},{key:"_instantiate",value:function(e){return(e=e||cc.instantiate._clone(this,this)).node=null,e}},{key:"schedule",value:function(e,t,i,n){var r=1<arguments.length&&void 0!==t?t:0,a=2<arguments.length&&void 0!==i?i:cc.macro.REPEAT_FOREVER,s=3<arguments.length&&void 0!==n?n:0;cc.assertID(e,1619),cc.assertID(0<=r,1620),r=r||0,a=isNaN(a)?cc.macro.REPEAT_FOREVER:a,s=s||0;var o=cc.director.getScheduler(),l=o.isTargetPaused(this);o.schedule(e,this,r,a,s,l)}},{key:"scheduleOnce",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:0;this.schedule(e,0,0,i)}},{key:"unschedule",value:function(e){e&&cc.director.getScheduler().unschedule(e,this)}},{key:"unscheduleAllCallbacks",value:function(){cc.director.getScheduler().unscheduleAllForTarget(this)}},{key:"name",get:function(){if(this._name)return this._name;var e=Re(this),t=e.lastIndexOf(".");return 0<=t&&(e=e.slice(t+1)),this.node.name+"<"+e+">"},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"__scriptAsset",get:function(){return null}},{key:"enabled",get:function(){return this._enabled},set:function(e){if(this._enabled!==e&&(this._enabled=e,this.node.activeInHierarchy)){var t=cc.director._compScheduler;e?t.enableComp(this):t.disableComp(this)}}},{key:"enabledInHierarchy",get:function(){return this._enabled&&this.node&&this.node.activeInHierarchy}},{key:"_isOnLoadCalled",get:function(){return this._objFlags&zv}}]),a}(),Ov.system=null,m((Av=Mv).prototype,"name",[bv],Object.getOwnPropertyDescriptor(Av.prototype,"name"),Av.prototype),m(Av.prototype,"uuid",[xv],Object.getOwnPropertyDescriptor(Av.prototype,"uuid"),Av.prototype),m(Av.prototype,"__scriptAsset",[Sv],Object.getOwnPropertyDescriptor(Av.prototype,"__scriptAsset"),Av.prototype),m(Av.prototype,"enabled",[wv],Object.getOwnPropertyDescriptor(Av.prototype,"enabled"),Av.prototype),m(Av.prototype,"enabledInHierarchy",[Tv],Object.getOwnPropertyDescriptor(Av.prototype,"enabledInHierarchy"),Av.prototype),kv=m(Av.prototype,"node",[Ev],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Rv=m(Av.prototype,"_enabled",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Cv=Av))||Cv)),Pv=Bv.prototype;Pv.update=null,Pv.lateUpdate=null,Pv.__preload=null,Pv.onLoad=null,Pv.start=null,Pv.onEnable=null,Pv.onDisable=null,Pv.onDestroy=null,Pv.onFocusInEditor=null,Pv.onLostFocusInEditor=null,Pv.resetInEditor=null,Pv._getLocalBounds=null,Pv.onRestore=null,Bv._requireComponent=null,Bv._executionOrder=0,Te(Bv,"_registerEditorProps",function(e,t){var i=t.requireComponent;i&&(e._requireComponent=i);var n=t.executionOrder;n&&"number"==typeof n&&(e._executionOrder=n)}),cc.Component=Bv;var Dv,Fv,Nv,Uv,Vv,Gv,Hv,qv,jv;No.Flags.Destroying;var Wv=No.Flags.Destroying,Xv=No.Flags.DontDestroy,Yv=No.Flags.Deactivating,Qv=new ve("Node");function Kv(e){return e?"string"==typeof e?Ke(e):e:(cc.errorID(3804),null)}var Zv,Jv,$v,em,tm,im,nm,rm,am,sm,om,lm,cm,um,hm,fm=P2("BaseNode",ho("cc._BaseNode")((jv=qv=function(){function c(e){var t;return y(this,c),v(t=x(this,g(c).call(this,e)),"_parent",Nv,u(t)),v(t,"_children",Uv,u(t)),v(t,"_active",Vv,u(t)),v(t,"_components",Gv,u(t)),v(t,"_prefab",Hv,u(t)),t._scene=null,t._activeInHierarchy=!1,t._id=Qv.getNewId(),t._name=void 0,t.__eventTargets=[],t._siblingIndex=0,t._name=void 0!==e?e:"New Node",t}return p(c,No),l(c,[{key:"components",get:function(){return this._components}},{key:"_persistNode",get:function(){return 0<(this._objFlags&Xv)},set:function(e){e?this._objFlags|=Xv:this._objFlags&=~Xv}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"children",get:function(){return this._children}},{key:"active",get:function(){return this._active},set:function(e){if(this._active!==e){this._active=e;var t=this._parent;if(t)t._activeInHierarchy&&cc.director._nodeActivator.activateNode(this,e)}}},{key:"activeInHierarchy",get:function(){return this._activeInHierarchy}},{key:"parent",get:function(){return this._parent},set:function(e){this.setParent(e)}},{key:"scene",get:function(){return this._scene}}],[{key:"_setScene",value:function(e){e instanceof cc.Scene?e._scene=e:null==e._parent?cc.error("Node %s(%s) has not attached to a scene.",e.name,e.uuid):e._scene=e._parent._scene}},{key:"_findComponent",value:function(e,t){var i=t,n=e._components;if(i._sealed)for(var r=0;r<n.length;++r){var a=n[r];if(a.constructor===t)return a}else for(var s=0;s<n.length;++s){var o=n[s];if(o instanceof t)return o}return null}},{key:"_findComponents",value:function(e,t,i){var n=t,r=e._components;if(n._sealed)for(var a=0;a<r.length;++a){var s=r[a];s.constructor===t&&i.push(s)}else for(var o=0;o<r.length;++o){var l=r[o];l instanceof t&&i.push(l)}}},{key:"_findChildComponent",value:function(e,t){for(var i=0;i<e.length;++i){var n=e[i],r=c._findComponent(n,t);if(r)return r;if(0<n._children.length&&(r=c._findChildComponent(n._children,t)))return r}return null}},{key:"_findChildComponents",value:function(e,t,i){for(var n=0;n<e.length;++n){var r=e[n];c._findComponents(r,t,i),0<r._children.length&&c._findChildComponents(r._children,t,i)}}}]),l(c,[{key:"getParent",value:function(){return this._parent}},{key:"setParent",value:function(e,t){var i=1<arguments.length&&void 0!==t&&t;if(this._parent!==e){var n=this._parent;if(this._parent=e,this._siblingIndex=0,this._onSetParent(n,i),this.emit&&this.emit(U_.PARENT_CHANGED,n),e&&(e._children.push(this),this._siblingIndex=e._children.length-1,e.emit&&e.emit(U_.CHILD_ADDED,this)),n&&!(n._objFlags&Wv)){var r=n._children.indexOf(this);0,n._children.splice(r,1),n._updateSiblingIndex(),n.emit&&n.emit(U_.CHILD_REMOVED,this)}this._onHierarchyChanged(n)}}},{key:"attr",value:function(e){Ne(this,e)}},{key:"getChildByUuid",value:function(e){if(!e)return cc.log("Invalid uuid"),null;for(var t=this._children,i=0,n=t.length;i<n;i++)if(t[i]._id===e)return t[i];return null}},{key:"getChildByName",value:function(e){if(!e)return cc.log("Invalid name"),null;for(var t=this._children,i=0,n=t.length;i<n;i++)if(t[i]._name===e)return t[i];return null}},{key:"getChildByPath",value:function(e){for(var n=e.split("/"),r=this,t=function(e){var t=n[e];if(0===t.length)return"continue";var i=r.children.find(function(e){return e.name===t});if(!i)return{v:null};r=i},i=0;i<n.length;++i){var a=t(i);switch(a){case"continue":continue;default:if("object"===de(a))return a.v}}return r}},{key:"addChild",value:function(e){cc.assertID(e,1606),cc.assertID(null===e._parent,1605),e.setParent(this)}},{key:"insertChild",value:function(e,t){e.parent=this,e.setSiblingIndex(t)}},{key:"getSiblingIndex",value:function(){return this._siblingIndex}},{key:"setSiblingIndex",value:function(e){if(this._parent)if(this._parent._objFlags&Yv)cc.errorID(3821);else{var t=this._parent._children;e=-1!==e?e:t.length-1;var i=t.indexOf(this);e!==i&&(t.splice(i,1),e<t.length?t.splice(e,0,this):t.push(this),this._parent._updateSiblingIndex(),this._onSiblingIndexChanged&&this._onSiblingIndexChanged(e))}}},{key:"walk",value:function(e,t){var i=1,n=null,r=null,a=0,s=c._stacks[c._stackId];s||(s=[],c._stacks.push(s)),c._stackId++,s.length=0,s[0]=this;for(var o=null,l=!1;i;)if(r=s[--i])if(!l&&e?e(r):l&&t&&t(r),s[i]=null,l){if(l=!1,n)if(n[++a])s[i]=n[a],i++;else if(o&&(s[i]=o,i++,l=!0,o._parent?(a=(n=o._parent._children).indexOf(o),o=o._parent):n=o=null,a<0))break}else 0<r._children.length?(n=(o=r)._children,a=0,s[i]=n[a],i++):(s[i]=r,i++,l=!0);s.length=0,c._stackId--}},{key:"removeFromParent",value:function(){this._parent&&this._parent.removeChild(this)}},{key:"removeChild",value:function(e){-1<this._children.indexOf(e)&&(e.parent=null)}},{key:"removeAllChildren",value:function(){for(var e=this._children,t=e.length-1;0<=t;t--){var i=e[t];i&&(i.parent=null)}this._children.length=0}},{key:"isChildOf",value:function(e){var t=this;do{if(t===e)return!0;t=t._parent}while(t);return!1}},{key:"getComponent",value:function(e){var t=Kv(e);return t?c._findComponent(this,t):null}},{key:"getComponents",value:function(e){var t=Kv(e),i=[];return t&&c._findComponents(this,t,i),i}},{key:"getComponentInChildren",value:function(e){var t=Kv(e);return t?c._findChildComponent(this._children,t):null}},{key:"getComponentsInChildren",value:function(e){var t=Kv(e),i=[];return t&&(c._findComponents(this,t,i),c._findChildComponents(this._children,t,i)),i}},{key:"addComponent",value:function(e){var t;if("string"==typeof e){if(!(t=Ke(e)))return cc.errorID(3807,e),cc._RF.peek()&&cc.errorID(3808,e),null}else{if(!e)return cc.errorID(3804),null;t=e}if("function"!=typeof t)return cc.errorID(3809),null;if(!Ge(t,cc.Component))return cc.errorID(3810),null;var i=t._requireComponent;if(i&&!this.getComponent(i)&&!this.addComponent(i))return null;var n=new t;return(n.node=this)._components.push(n),this._activeInHierarchy&&cc.director._nodeActivator.activateComp(n),n}},{key:"removeComponent",value:function(e){if(e){var t=null;(t=e instanceof Bv?e:this.getComponent(e))&&t.destroy()}else cc.errorID(3813)}},{key:"destroy",value:function(){return!!_(g(c.prototype),"destroy",this).call(this)&&(this._activeInHierarchy&&this._disableChildComps(),!0)}},{key:"destroyAllChildren",value:function(){for(var e=this._children,t=0;t<e.length;++t)e[t].destroy()}},{key:"_removeComponent",value:function(e){if(e){if(!(this._objFlags&Wv)){var t=this._components.indexOf(e);-1!==t?this._components.splice(t,1):e.node!==this&&cc.errorID(3815)}}else cc.errorID(3814)}},{key:"_updateSiblingIndex",value:function(){for(var e=0;e<this._children.length;++e)this._children[e]._siblingIndex=e}},{key:"_onSetParent",value:function(e){this._parent&&(null!=e&&e._scene===this._parent._scene||null==this._parent._scene||this.walk(function(e){c._setScene(e)}))}},{key:"_onPostActivated",value:function(e){}},{key:"_onBatchRestored",value:function(){}},{key:"_onBatchCreated",value:function(){this._parent&&(this._siblingIndex=this._parent.children.indexOf(this))}},{key:"_onPreDestroy",value:function(){this._onPreDestroyBase()}},{key:"_onHierarchyChanged",value:function(e){return this._onHierarchyChangedBase(e)}},{key:"_instantiate",value:function(e){e=e||cc.instantiate._clone(this,this);var t=this._prefab;t&&this===t.root&&t.sync;return e._parent=null,e._onBatchRestored(),e}},{key:"_onHierarchyChangedBase",value:function(e){var t=this._parent;!this._persistNode||t instanceof cc.Scene||cc.game.removePersistRootNode(this);var i=this._active&&!(!t||!t._activeInHierarchy);this._activeInHierarchy!==i&&cc.director._nodeActivator.activateNode(this,i)}},{key:"_onPreDestroyBase",value:function(){this._objFlags|=Wv;var e=this._parent,t=null!==e&&0!=(e._objFlags&Wv);for(var i=this._children,n=0;n<i.length;++n)i[n]._destroyImmediate();for(var r=this._components,a=0;a<r.length;++a)r[a]._destroyImmediate();for(var s=this.__eventTargets,o=0;o<s.length;++o){var l=s[o];l&&l.targetOff(this)}if(s.length=0,this._persistNode&&cc.game.removePersistRootNode(this),!t&&e){var c=e._children.indexOf(this);e._children.splice(c,1),this._siblingIndex=0,e.emit&&e.emit("child-removed",this)}return t}},{key:"_disableChildComps",value:function(){for(var e=this._components,t=0;t<e.length;++t){var i=e[t];i._enabled&&cc.director._compScheduler.disableComp(i)}for(var n=this._children,r=0;r<n.length;++r){var a=n[r];a._active&&a._disableChildComps()}}}]),c}(),qv.idGenerator=Qv,qv._stacks=[[]],qv._stackId=0,m((Fv=jv).prototype,"_persistNode",[fo],Object.getOwnPropertyDescriptor(Fv.prototype,"_persistNode"),Fv.prototype),m(Fv.prototype,"name",[fo],Object.getOwnPropertyDescriptor(Fv.prototype,"name"),Fv.prototype),m(Fv.prototype,"uuid",[fo],Object.getOwnPropertyDescriptor(Fv.prototype,"uuid"),Fv.prototype),m(Fv.prototype,"children",[fo],Object.getOwnPropertyDescriptor(Fv.prototype,"children"),Fv.prototype),m(Fv.prototype,"active",[fo],Object.getOwnPropertyDescriptor(Fv.prototype,"active"),Fv.prototype),m(Fv.prototype,"activeInHierarchy",[fo],Object.getOwnPropertyDescriptor(Fv.prototype,"activeInHierarchy"),Fv.prototype),m(Fv.prototype,"parent",[fo],Object.getOwnPropertyDescriptor(Fv.prototype,"parent"),Fv.prototype),Nv=m(Fv.prototype,"_parent",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Uv=m(Fv.prototype,"_children",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Vv=m(Fv.prototype,"_active",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Gv=m(Fv.prototype,"_components",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Hv=m(Fv.prototype,"_prefab",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Dv=Fv))||Dv);cc._BaseNode=fm,(Jv=Zv=Zv||{})[Jv.LOCAL=0]="LOCAL",Jv[Jv.WORLD=1]="WORLD",(em=$v=$v||{})[em.NONE=0]="NONE",em[em.POSITION=1]="POSITION",em[em.ROTATION=2]="ROTATION",em[em.SCALE=4]="SCALE",em[em.RS=em.ROTATION|em.SCALE]="RS",em[em.TRS=em.POSITION|em.ROTATION|em.SCALE]="TRS",em[em.TRS_MASK=~em.TRS]="TRS_MASK";var dm=new Fi,pm=new hn,_m=new hn,vm=new Array(10),mm=new hn,ym=new rn,gm=new rn,bm=new zn,xm=new Map,Sm=P2("Node",(tm=ho("cc.Node"),im=fo({type:Fi}),tm((hm=um=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))))._pos=new Fi,t._rot=new hn,t._scale=new Fi(1,1,1),t._mat=new zn,v(t,"_lpos",am,u(t)),v(t,"_lrot",sm,u(t)),v(t,"_lscale",om,u(t)),v(t,"_layer",lm,u(t)),v(t,"_euler",cm,u(t)),t._dirtyFlags=$v.NONE,t._eulerDirty=!1,t._eventProcessor=new vv(u(t)),t._eventMask=0,t._uiTransfromComp=null,t._uiComp=null,t}return p(a,fm),l(a,[{key:"setParent",value:function(e,t){var i=1<arguments.length&&void 0!==t&&t;i&&this.updateWorldTransform(),_(g(a.prototype),"setParent",this).call(this,e,i)}},{key:"_onSetParent",value:function(e,t){if(_(g(a.prototype),"_onSetParent",this).call(this,e,t),t){var i=this._parent;i?(i.updateWorldTransform(),zn.multiply(bm,zn.invert(bm,i._mat),this._mat),zn.toRTS(bm,this._lrot,this._lpos,this._lscale)):(Fi.copy(this._lpos,this._pos),hn.copy(this._lrot,this._rot),Fi.copy(this._lscale,this._scale)),this._eulerDirty=!0}this.invalidateChildren($v.TRS)}},{key:"_onBatchCreated",value:function(){_(g(a.prototype),"_onBatchCreated",this).call(this),xm.set(this._id,$v.TRS),this._dirtyFlags=$v.TRS;for(var e=this._children.length,t=0;t<e;++t)this._children[t]._onBatchCreated()}},{key:"_onBatchRestored",value:function(){this._onBatchCreated()}},{key:"_onBeforeSerialize",value:function(){this.eulerAngles}},{key:"translate",value:function(e,t){var i=t||Zv.LOCAL;if(i===Zv.LOCAL)Fi.transformQuat(dm,e,this._lrot),this._lpos.x+=dm.x,this._lpos.y+=dm.y,this._lpos.z+=dm.z;else if(i===Zv.WORLD)if(this._parent){hn.invert(pm,this.worldRotation),Fi.transformQuat(dm,e,pm);var n=this.worldScale;this._lpos.x+=dm.x/n.x,this._lpos.y+=dm.y/n.y,this._lpos.z+=dm.z/n.z}else this._lpos.x+=e.x,this._lpos.y+=e.y,this._lpos.z+=e.z;this.invalidateChildren($v.POSITION),1&this._eventMask&&this.emit(U_.TRANSFORM_CHANGED,U_.POSITION_PART)}},{key:"rotate",value:function(e,t){var i=t||Zv.LOCAL;if(hn.normalize(pm,e),i===Zv.LOCAL)hn.multiply(this._lrot,this._lrot,pm);else if(i===Zv.WORLD){var n=this.worldRotation;hn.multiply(_m,pm,n),hn.invert(pm,n),hn.multiply(_m,pm,_m),hn.multiply(this._lrot,this._lrot,_m)}this._eulerDirty=!0,this.invalidateChildren($v.ROTATION),1&this._eventMask&&this.emit(U_.TRANSFORM_CHANGED,U_.ROTATION_PART)}},{key:"lookAt",value:function(e,t){this.getWorldPosition(dm),Fi.subtract(dm,dm,e),Fi.normalize(dm,dm),hn.fromViewUp(pm,dm,t),this.setWorldRotation(pm)}},{key:"invalidateChildren",value:function(e){if((this._dirtyFlags&this.hasChangedFlags&e)!==e){this._dirtyFlags|=e,xm.set(this._id,this.hasChangedFlags|e),e|=$v.POSITION;for(var t=this._children.length,i=0;i<t;++i)this._children[i].invalidateChildren(e)}}},{key:"updateWorldTransform",value:function(){if(this._dirtyFlags){for(var e,t=this,i=0;t&&t._dirtyFlags;)t=(vm[i++]=t)._parent;for(var n=0;i;)n|=(e=vm[--i])._dirtyFlags,t?(n&$v.POSITION&&(Fi.transformMat4(e._pos,e._lpos,t._mat),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),n&$v.RS&&(zn.fromRTS(e._mat,e._lrot,e._lpos,e._lscale),zn.multiply(e._mat,t._mat,e._mat),n&$v.ROTATION&&hn.multiply(e._rot,t._rot,e._lrot),rn.fromQuat(ym,hn.conjugate(mm,e._rot)),rn.multiplyMat4(ym,ym,e._mat),e._scale.x=ym.m00,e._scale.y=ym.m04,e._scale.z=ym.m08)):(n&$v.POSITION&&(Fi.copy(e._pos,e._lpos),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),n&$v.RS&&(n&$v.ROTATION?hn.copy(e._rot,e._lrot):Fi.copy(e._scale,e._lscale),zn.fromRTS(e._mat,e._rot,e._pos,e._scale))),e._dirtyFlags=$v.NONE,t=e}}},{key:"setPosition",value:function(e,t,i){void 0===t||void 0===i?Fi.copy(this._lpos,e):Fi.set(this._lpos,e,t,i),this.invalidateChildren($v.POSITION),1&this._eventMask&&this.emit(U_.TRANSFORM_CHANGED,U_.POSITION_PART)}},{key:"getPosition",value:function(e){return e?Fi.set(e,this._lpos.x,this._lpos.y,this._lpos.z):Fi.copy(new Fi,this._lpos)}},{key:"setRotation",value:function(e,t,i,n){void 0===t||void 0===i||void 0===n?hn.copy(this._lrot,e):hn.set(this._lrot,e,t,i,n),this._eulerDirty=!0,this.invalidateChildren($v.ROTATION),1&this._eventMask&&this.emit(U_.TRANSFORM_CHANGED,U_.ROTATION_PART)}},{key:"setRotationFromEuler",value:function(e,t,i){Fi.set(this._euler,e,t,i),hn.fromEuler(this._lrot,e,t,i),this._eulerDirty=!1,this.invalidateChildren($v.ROTATION),1&this._eventMask&&this.emit(U_.TRANSFORM_CHANGED,U_.ROTATION_PART)}},{key:"getRotation",value:function(e){return e?hn.set(e,this._lrot.x,this._lrot.y,this._lrot.z,this._lrot.w):hn.copy(new hn,this._lrot)}},{key:"setScale",value:function(e,t,i){void 0===t||void 0===i?Fi.copy(this._lscale,e):Fi.set(this._lscale,e,t,i),this.invalidateChildren($v.SCALE),1&this._eventMask&&this.emit(U_.TRANSFORM_CHANGED,U_.SCALE_PART)}},{key:"getScale",value:function(e){return e?Fi.set(e,this._lscale.x,this._lscale.y,this._lscale.z):Fi.copy(new Fi,this._lscale)}},{key:"inverseTransformPoint",value:function(e,t){Fi.copy(e,t);for(var i=this,n=0;i._parent;)i=(vm[n++]=i)._parent;for(;0<=n;)Fi.transformInverseRTS(e,e,i._lrot,i._lpos,i._lscale),i=vm[--n];return e}},{key:"setWorldPosition",value:function(e,t,i){void 0===t||void 0===i?Fi.copy(this._pos,e):Fi.set(this._pos,e,t,i);var n=this._parent,r=this._lpos;n?(n.updateWorldTransform(),Fi.transformMat4(r,this._pos,zn.invert(bm,n._mat))):Fi.copy(r,this._pos),this.invalidateChildren($v.POSITION),1&this._eventMask&&this.emit(U_.TRANSFORM_CHANGED,U_.POSITION_PART)}},{key:"getWorldPosition",value:function(e){return this.updateWorldTransform(),e?Fi.copy(e,this._pos):Fi.copy(new Fi,this._pos)}},{key:"setWorldRotation",value:function(e,t,i,n){void 0===t||void 0===i||void 0===n?hn.copy(this._rot,e):hn.set(this._rot,e,t,i,n),this._parent?(this._parent.updateWorldTransform(),hn.multiply(this._lrot,hn.conjugate(this._lrot,this._parent._rot),this._rot)):hn.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren($v.ROTATION),1&this._eventMask&&this.emit(U_.TRANSFORM_CHANGED,U_.ROTATION_PART)}},{key:"setWorldRotationFromEuler",value:function(e,t,i){hn.fromEuler(this._rot,e,t,i),this._parent?(this._parent.updateWorldTransform(),hn.multiply(this._lrot,hn.conjugate(this._lrot,this._parent._rot),this._rot)):hn.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren($v.ROTATION),1&this._eventMask&&this.emit(U_.TRANSFORM_CHANGED,U_.ROTATION_PART)}},{key:"getWorldRotation",value:function(e){return this.updateWorldTransform(),e?hn.copy(e,this._rot):hn.copy(new hn,this._rot)}},{key:"setWorldScale",value:function(e,t,i){void 0===t||void 0===i?Fi.copy(this._scale,e):Fi.set(this._scale,e,t,i);var n=this._parent;n?(n.updateWorldTransform(),rn.fromQuat(ym,hn.conjugate(mm,n._rot)),rn.multiplyMat4(ym,ym,n._mat),gm.m00=this._scale.x,gm.m04=this._scale.x,gm.m08=this._scale.z,rn.multiply(ym,gm,rn.invert(ym,ym)),this._lscale.x=ym.m00,this._lscale.y=ym.m04,this._lscale.z=ym.m08):Fi.copy(this._lscale,this._scale),this.invalidateChildren($v.SCALE),1&this._eventMask&&this.emit(U_.TRANSFORM_CHANGED,U_.SCALE_PART)}},{key:"getWorldScale",value:function(e){return this.updateWorldTransform(),e?Fi.copy(e,this._scale):Fi.copy(new Fi,this._scale)}},{key:"getWorldMatrix",value:function(e){return this.updateWorldTransform(),e=e||new zn,zn.copy(e,this._mat)}},{key:"getWorldRS",value:function(e){return this.updateWorldTransform(),e=e||new zn,zn.copy(e,this._mat),e.m12=0,e.m13=0,e.m14=0,e}},{key:"getWorldRT",value:function(e){return this.updateWorldTransform(),e=e||new zn,zn.fromRT(e,this._rot,this._pos)}},{key:"getAnchorPoint",value:function(e){return(e=e||new Mi).set(this.uiTransfromComp.anchorPoint),e}},{key:"setAnchorPoint",value:function(e,t){this.uiTransfromComp.setAnchorPoint(e,t)}},{key:"getContentSize",value:function(e){return(e=e||new jn).set(this.uiTransfromComp.contentSize),e}},{key:"setContentSize",value:function(e,t){this.uiTransfromComp.setContentSize(e,t)}},{key:"on",value:function(e,t,i,n){switch(e){case U_.TRANSFORM_CHANGED:this._eventMask|=1}this._eventProcessor.on(e,t,i,n)}},{key:"off",value:function(e,t,i,n){if(this._eventProcessor.off(e,t,i,n),!this._eventProcessor.hasEventListener(e))switch(e){case U_.TRANSFORM_CHANGED:this._eventMask&=-2}}},{key:"once",value:function(e,t,i,n){this._eventProcessor.once(e,t,i,n)}},{key:"emit",value:function(e){for(var t,i=arguments.length,n=new Array(1<i?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];(t=this._eventProcessor).emit.apply(t,[e].concat(n))}},{key:"dispatchEvent",value:function(e){this._eventProcessor.dispatchEvent(e)}},{key:"hasEventListener",value:function(e){return this._eventProcessor.hasEventListener(e)}},{key:"targetOff",value:function(e){this._eventProcessor.targetOff(e),1&this._eventMask&&!this._eventProcessor.hasEventListener(U_.TRANSFORM_CHANGED)&&(this._eventMask&=-2)}},{key:"pauseSystemEvents",value:function(e){u_.pauseTarget(this,e)}},{key:"resumeSystemEvents",value:function(e){u_.resumeTarget(this,e)}},{key:"_onPostActivated",value:function(e){e?(u_.resumeTarget(this),this.eventProcessor.reattach()):u_.pauseTarget(this)}},{key:"_onPreDestroy",value:function(){this._eventProcessor.destroy(),_(g(a.prototype),"_onPreDestroy",this).call(this)}},{key:"position",get:function(){return this._lpos},set:function(e){this.setPosition(e)}},{key:"worldPosition",get:function(){return this.updateWorldTransform(),this._pos},set:function(e){this.setWorldPosition(e)}},{key:"rotation",get:function(){return this._lrot},set:function(e){this.setRotation(e)}},{key:"eulerAngles",set:function(e){this.setRotationFromEuler(e.x,e.y,e.z)},get:function(){return this._eulerDirty&&(hn.toEuler(this._euler,this._lrot),this._eulerDirty=!1),this._euler}},{key:"worldRotation",get:function(){return this.updateWorldTransform(),this._rot},set:function(e){this.setWorldRotation(e)}},{key:"scale",get:function(){return this._lscale},set:function(e){this.setScale(e)}},{key:"worldScale",get:function(){return this.updateWorldTransform(),this._scale},set:function(e){this.setWorldScale(e)}},{key:"matrix",set:function(e){zn.toRTS(e,this._lrot,this._lpos,this._lscale),this.invalidateChildren($v.TRS),this._eulerDirty=!0,1&this._eventMask&&(this.emit(U_.TRANSFORM_CHANGED,U_.POSITION_PART),this.emit(U_.TRANSFORM_CHANGED,U_.ROTATION_PART),this.emit(U_.TRANSFORM_CHANGED,U_.SCALE_PART))}},{key:"worldMatrix",get:function(){return this.updateWorldTransform(),this._mat}},{key:"forward",get:function(){return this.getWorldRotation(pm),Fi.transformQuat(new Fi,Fi.UNIT_Z,pm)},set:function(e){var t=e.length();Fi.multiplyScalar(dm,e,-1/t),hn.fromViewUp(pm,dm),this.setWorldRotation(pm)}},{key:"layer",set:function(e){this._layer=e},get:function(){return this._layer}},{key:"hasChangedFlags",get:function(){return xm.get(this._id)||0},set:function(e){xm.set(this._id,e)}},{key:"uiTransfromComp",get:function(){return this._uiTransfromComp||(this._uiTransfromComp=this.getComponent("cc.UITransformComponent")),this._uiTransfromComp},set:function(e){this._uiTransfromComp=e}},{key:"width",get:function(){return this.uiTransfromComp.width},set:function(e){this.uiTransfromComp.width=e}},{key:"height",get:function(){return this.uiTransfromComp.height},set:function(e){this.uiTransfromComp.height=e}},{key:"anchorX",get:function(){return this.uiTransfromComp.anchorX},set:function(e){this.uiTransfromComp.anchorX=e}},{key:"anchorY",get:function(){return this.uiTransfromComp.anchorY},set:function(e){this.uiTransfromComp.anchorY=e}},{key:"eventProcessor",get:function(){return this._eventProcessor}}],[{key:"isNode",value:function(e){return e instanceof a&&(e.constructor===a||!(e instanceof cc.Scene))}}]),a}(),um.bookOfChange=xm,um.EventType=U_,um.NodeSpace=Zv,um.TransformDirtyBit=$v,am=m((rm=hm).prototype,"_lpos",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi}}),sm=m(rm.prototype,"_lrot",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new hn}}),om=m(rm.prototype,"_lscale",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi(1,1,1)}}),lm=m(rm.prototype,"_layer",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qh.Enum.DEFAULT}}),cm=m(rm.prototype,"_euler",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi}}),m(rm.prototype,"eulerAngles",[im],Object.getOwnPropertyDescriptor(rm.prototype,"eulerAngles"),rm.prototype),m(rm.prototype,"layer",[fo],Object.getOwnPropertyDescriptor(rm.prototype,"layer"),rm.prototype),nm=rm))||nm));cc.Node=Sm;var wm,Tm,Em,Cm,Am,km,Rm,Om,Mm,Im,Lm,zm,Bm,Pm,Dm,Fm,Nm,Um,Vm,Gm,Hm,qm,jm,Wm,Xm,Ym,Qm,Km,Zm,Jm,$m,ey,ty,iy,ny,ry,ay,sy,oy,ly,cy,uy=function(){function t(e){y(this,t),this._enabled=!0,this._skyColor=Float32Array.from([.2,.5,.8,1]),this._skyIllum=t.SKY_ILLUM,this._groundAlbedo=Float32Array.from([.2,.2,.2,1]),this._scene=void 0,this._scene=e}return l(t,[{key:"enabled",set:function(e){this._enabled=e},get:function(){return this._enabled}},{key:"skyColor",get:function(){return this._skyColor},set:function(e){this._skyColor=e}},{key:"skyIllum",set:function(e){this._skyIllum=e},get:function(){return this._skyIllum}},{key:"groundAlbedo",get:function(){return this._groundAlbedo},set:function(e){this._groundAlbedo=e}}]),l(t,[{key:"update",value:function(){}}]),t}();uy.SUN_ILLUM=65e3,uy.SKY_ILLUM=2e4;var hy=new Fi(0,1,0),fy=new Fi,dy=new hn,py=(wm=ho("cc.AmbientInfo"),Tm=fo({type:rr}),Em=fo({type:kt}),Cm=fo({type:rr}),wm((Rm=m((km=function(){function e(){y(this,e),v(this,"_skyColor",Rm,this),v(this,"_skyIllum",Om,this),v(this,"_groundAlbedo",Mm,this),this._resource=null}return l(e,[{key:"skyColor",set:function(e){this._skyColor.set(e),this._resource&&rr.toArray(this._resource.skyColor,this.skyColor)},get:function(){return this._skyColor}},{key:"skyIllum",set:function(e){this._skyIllum=e,this._resource&&(this._resource.skyIllum=this.skyIllum)},get:function(){return this._skyIllum}},{key:"groundAlbedo",set:function(e){this._groundAlbedo.set(e),this._resource&&rr.toArray(this._resource.groundAlbedo,this.groundAlbedo)},get:function(){return this._groundAlbedo}},{key:"renderScene",set:function(e){this._resource=e.ambient,this.skyColor=this._skyColor,this.skyIllum=this._skyIllum,this.groundAlbedo=this._groundAlbedo}}]),e}()).prototype,"_skyColor",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rr(51,128,204,1)}}),Om=m(km.prototype,"_skyIllum",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return uy.SKY_ILLUM}}),Mm=m(km.prototype,"_groundAlbedo",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rr(51,51,51,255)}}),m(km.prototype,"skyColor",[Tm],Object.getOwnPropertyDescriptor(km.prototype,"skyColor"),km.prototype),m(km.prototype,"skyIllum",[Em],Object.getOwnPropertyDescriptor(km.prototype,"skyIllum"),km.prototype),m(km.prototype,"groundAlbedo",[Cm],Object.getOwnPropertyDescriptor(km.prototype,"groundAlbedo"),km.prototype),Am=km))||Am);cc.AmbientInfo=py;var _y=(Im=ho("cc.SkyboxInfo"),Lm=fo(Ch),zm=fo({type:Rt}),Bm=fo({type:Rt}),Pm=fo({type:Ch}),Dm=fo({type:Rt}),Im((Um=m((Nm=function(){function e(){y(this,e),v(this,"_envmap",Um,this),v(this,"_isRGBE",Vm,this),v(this,"_enabled",Gm,this),v(this,"_useIBL",Hm,this),this._resource=null}return l(e,[{key:"enabled",set:function(e){this._enabled=e,this._resource&&(this._resource.enabled=this._enabled)},get:function(){return this._enabled}},{key:"useIBL",set:function(e){this._useIBL=e,this._resource&&(this._resource.useIBL=this._useIBL)},get:function(){return this._useIBL}},{key:"envmap",set:function(e){this._envmap=e,this._resource&&(this._resource.envmap=this._envmap)},get:function(){return this._envmap}},{key:"isRGBE",set:function(e){this._isRGBE=e,this._resource&&(this._resource.isRGBE=this._isRGBE)},get:function(){return this._isRGBE}},{key:"renderScene",set:function(e){this._resource=e.skybox,this.isRGBE=this._isRGBE,this.envmap=this._envmap,this.enabled=this._enabled,this.useIBL=this._useIBL}}]),e}()).prototype,"_envmap",[Lm],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Vm=m(Nm.prototype,"_isRGBE",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Gm=m(Nm.prototype,"_enabled",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Hm=m(Nm.prototype,"_useIBL",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),m(Nm.prototype,"enabled",[zm],Object.getOwnPropertyDescriptor(Nm.prototype,"enabled"),Nm.prototype),m(Nm.prototype,"useIBL",[Bm],Object.getOwnPropertyDescriptor(Nm.prototype,"useIBL"),Nm.prototype),m(Nm.prototype,"envmap",[Pm],Object.getOwnPropertyDescriptor(Nm.prototype,"envmap"),Nm.prototype),m(Nm.prototype,"isRGBE",[Dm],Object.getOwnPropertyDescriptor(Nm.prototype,"isRGBE"),Nm.prototype),Fm=Nm))||Fm);cc.SkyboxInfo=_y;var vy=(qm=ho("cc.PlanarShadowInfo"),jm=fo({type:Rt}),Wm=fo({type:Fi}),Xm=fo({type:kt}),Ym=fo({type:rr}),qm((Zm=m((Km=function(){function e(){y(this,e),v(this,"_enabled",Zm,this),v(this,"_normal",Jm,this),v(this,"_distance",$m,this),v(this,"_shadowColor",ey,this),this._resource=null}return l(e,[{key:"setPlaneFromNode",value:function(e){e.getWorldRotation(dy),this.normal=Fi.transformQuat(fy,hy,dy),e.getWorldPosition(fy),this.distance=Fi.dot(this._normal,fy)}},{key:"enabled",set:function(e){this._enabled=e,this._resource&&(this._resource.enabled=e)},get:function(){return this._enabled}},{key:"normal",set:function(e){Fi.copy(this._normal,e),this._resource&&(this._resource.normal=e)},get:function(){return this._normal}},{key:"distance",set:function(e){this._distance=e,this._resource&&(this._resource.distance=e)},get:function(){return this._distance}},{key:"shadowColor",set:function(e){this._shadowColor.set(e),this._resource&&(this._resource.shadowColor=e)},get:function(){return this._shadowColor}},{key:"renderScene",set:function(e){this._resource=e.planarShadows,this.normal=this._normal,this.distance=this._distance,this.shadowColor=this._shadowColor,this.enabled=this._enabled}}]),e}()).prototype,"_enabled",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Jm=m(Km.prototype,"_normal",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi(0,1,0)}}),$m=m(Km.prototype,"_distance",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ey=m(Km.prototype,"_shadowColor",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rr(0,0,0,76)}}),m(Km.prototype,"enabled",[jm],Object.getOwnPropertyDescriptor(Km.prototype,"enabled"),Km.prototype),m(Km.prototype,"normal",[Wm],Object.getOwnPropertyDescriptor(Km.prototype,"normal"),Km.prototype),m(Km.prototype,"distance",[Xm],Object.getOwnPropertyDescriptor(Km.prototype,"distance"),Km.prototype),m(Km.prototype,"shadowColor",[Ym],Object.getOwnPropertyDescriptor(Km.prototype,"shadowColor"),Km.prototype),Qm=Km))||Qm);cc.PlanarShadowInfo=vy;var my,yy,gy,by,xy=(ty=ho("cc.SceneGlobals"),iy=fo({type:py}),ny=fo({type:_y}),ry=fo({type:vy}),ty((oy=m((sy=function(){function e(){y(this,e),v(this,"ambient",oy,this),v(this,"skybox",ly,this),v(this,"planarShadows",cy,this)}return l(e,[{key:"renderScene",set:function(e){this.ambient.renderScene=e,this.skybox.renderScene=e,this.planarShadows.renderScene=e}}]),e}()).prototype,"ambient",[iy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new py}}),ly=m(sy.prototype,"skybox",[ny],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _y}}),cy=m(sy.prototype,"planarShadows",[ry],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vy}}),ay=sy))||ay);cc.SceneGlobals=xy;var Sy,wy=P2("Scene",ho("cc.Scene")((gy=m((yy=function(){function i(e){var t;return y(this,i),v(t=x(this,g(i).call(this,e)),"autoReleaseAssets",gy,u(t)),v(t,"_globals",by,u(t)),t._renderScene=null,t.dependAssets=null,t._inited=void 0,t._prefabSyncedInLiveReload=!1,t._activeInHierarchy=!1,cc.director&&cc.director.root&&(t._renderScene=cc.director.root.createScene({})),t._inited=!cc.game||!cc.game._isCloning,t}return p(i,Sm),l(i,[{key:"renderScene",get:function(){return this._renderScene}},{key:"globals",get:function(){return this._globals}}]),l(i,[{key:"destroy",value:function(){var e=_(g(i.prototype),"destroy",this).call(this);return cc.director.root.destroyScene(this._renderScene),this._activeInHierarchy=!1,e}},{key:"_onHierarchyChanged",value:function(){}},{key:"_instantiate",value:function(){}},{key:"_load",value:function(){this._inited||(this._onBatchCreated(),this._inited=!0),this.walk(fm._setScene)}},{key:"_activate",value:function(e){e=!1!==e,cc.director._nodeActivator.activateNode(this,e),this._globals.renderScene=this._renderScene}}]),i}()).prototype,"autoReleaseAssets",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),by=m(yy.prototype,"_globals",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new xy}}),my=yy))||my);cc.Scene=wy;var Ty=No.Flags.HideInHierarchy,Ey=P2("PrivateNode",ho("cc.PrivateNode")(Sy=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._objFlags|=Ty,t}return p(i,Sm),i}())||Sy);cc.PrivateNode=Ey;function Cy(e){e.start(),e._objFlags|=Oy}function Ay(e,t){e.update(t)}function ky(e,t){e.lateUpdate(t)}var Ry=$e.fastRemoveAt,Oy=No.Flags.IsStartCalled,My=No.Flags.IsOnEnableCalled;No.Flags.IsEditorOnEnableCalled;function Iy(e,t){for(var i=t.constructor._executionOrder,n=t._id,r=0,a=e.length-1,s=a>>>1;r<=a;s=r+a>>>1){var o=e[s],l=o.constructor._executionOrder;if(i<l)a=s-1;else if(l<i)r=s+1;else{var c=o._id;if(n<c)a=s-1;else{if(!(c<n))return s;r=s+1}}}return~r}function Ly(e,t){for(var i=e.array,n=e.i+1;n<i.length;){var r=i[n];r._enabled&&r.node._activeInHierarchy?++n:(e.removeAt(n),t&&(r._objFlags&=~t))}}function zy(e){y(this,zy),this._zero=void 0,this._neg=void 0,this._pos=void 0,this._invoke=void 0;var t=ue;this._zero=new t([]),this._neg=new t([]),this._pos=new t([]),this._invoke=e}function By(e,t){return e.constructor._executionOrder-t.constructor._executionOrder}zy.stableRemoveInactive=Ly;var Py=function(){function e(){return y(this,e),x(this,g(e).apply(this,arguments))}return p(e,zy),l(e,[{key:"add",value:function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).array.push(e)}},{key:"remove",value:function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).fastRemove(e)}},{key:"cancelInactive",value:function(e){Ly(this._zero,e),Ly(this._neg,e),Ly(this._pos,e)}},{key:"invoke",value:function(){var e=this._neg;0<e.array.length&&(e.array.sort(By),this._invoke(e),e.array.length=0),this._invoke(this._zero),this._zero.array.length=0;var t=this._pos;0<t.array.length&&(t.array.sort(By),this._invoke(t),t.array.length=0)}}]),e}(),Dy=function(){function e(){return y(this,e),x(this,g(e).apply(this,arguments))}return p(e,zy),l(e,[{key:"add",value:function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.array.push(e);else{var i=t<0?this._neg.array:this._pos.array,n=Iy(i,e);n<0&&i.splice(~n,0,e)}}},{key:"remove",value:function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.fastRemove(e);else{var i=t<0?this._neg:this._pos,n=Iy(i.array,e);0<=n&&i.removeAt(n)}}},{key:"invoke",value:function(e){0<this._neg.array.length&&this._invoke(this._neg,e),this._invoke(this._zero,e),0<this._pos.array.length&&this._invoke(this._pos,e)}}]),e}();function Fy(r,e){if("function"==typeof r)return e?function(e,t){var i=e.array;for(e.i=0;e.i<i.length;++e.i){var n=i[e.i];r(n,t)}}:function(e){var t=e.array;for(e.i=0;e.i<t.length;++e.i){var i=t[e.i];r(i)}};var t="var a=it.array;for(it.i=0;it.i<a.length;++it.i){var c=a[it.i];"+r+"}";return e?Function("it","dt",t):Function("it",t)}var Ny=function(){function e(){y(this,e),this.startInvoker=void 0,this.updateInvoker=void 0,this.lateUpdateInvoker=void 0,this.scheduleInNextFrame=void 0,this._updating=void 0,this.unscheduleAll()}return l(e,[{key:"unscheduleAll",value:function(){this.startInvoker=new Py(Fy(Cy)),this.updateInvoker=new Dy(Fy(Ay,!0)),this.lateUpdateInvoker=new Dy(Fy(ky,!0)),this.scheduleInNextFrame=[],this._updating=!1}},{key:"_onEnabled",value:function(e){cc.director.getScheduler().resumeTarget(e),e._objFlags|=My,this._updating?this.scheduleInNextFrame.push(e):this._scheduleImmediate(e)}},{key:"_onDisabled",value:function(e){cc.director.getScheduler().pauseTarget(e),e._objFlags&=~My;var t=this.scheduleInNextFrame.indexOf(e);0<=t?Ry(this.scheduleInNextFrame,t):(!e.start||e._objFlags&Oy||this.startInvoker.remove(e),e.update&&this.updateInvoker.remove(e),e.lateUpdate&&this.lateUpdateInvoker.remove(e))}},{key:"enableComp",value:function(e,t){if(!(e._objFlags&My)){if(e.onEnable){if(t)return void t.add(e);if(e.onEnable(),!e.node._activeInHierarchy)return}this._onEnabled(e)}}},{key:"disableComp",value:function(e){e._objFlags&My&&(e.onDisable&&e.onDisable(),this._onDisabled(e))}},{key:"startPhase",value:function(){this._updating=!0,0<this.scheduleInNextFrame.length&&this._deferredSchedule(),this.startInvoker.invoke()}},{key:"updatePhase",value:function(e){this.updateInvoker.invoke(e)}},{key:"lateUpdatePhase",value:function(e){this.lateUpdateInvoker.invoke(e),this._updating=!1}},{key:"_scheduleImmediate",value:function(e){!e.start||e._objFlags&Oy||this.startInvoker.add(e),e.update&&this.updateInvoker.add(e),e.lateUpdate&&this.lateUpdateInvoker.add(e)}},{key:"_deferredSchedule",value:function(){for(var e=this.scheduleInNextFrame,t=0,i=e.length;t<i;t++){var n=e[t];this._scheduleImmediate(n)}e.length=0}}]),e}();Ny.LifeCycleInvoker=zy,Ny.OneOffInvoker=Py,Ny.createInvokeImpl=Fy,Ny.invokeOnEnable=function(e){var t=cc.director._compScheduler,i=e.array;for(e.i=0;e.i<i.length;++e.i){var n=i[e.i];if(n._enabled)n.onEnable(),n.node._activeInHierarchy&&t._onEnabled(n)}};function Uy(e){e.__preload()}function Vy(e){e.onLoad(),e._objFlags|=qy}var Gy=No.Flags.IsPreloadStarted,Hy=No.Flags.IsOnLoadStarted,qy=No.Flags.IsOnLoadCalled,jy=No.Flags.Deactivating,Wy=function(){function e(){return y(this,e),x(this,g(e).apply(this,arguments))}return p(e,Ny.LifeCycleInvoker),l(e,[{key:"add",value:function(e){this._zero.array.push(e)}},{key:"remove",value:function(e){this._zero.fastRemove(e)}},{key:"cancelInactive",value:function(e){Ny.LifeCycleInvoker.stableRemoveInactive(this._zero,e)}},{key:"invoke",value:function(){this._invoke(this._zero),this._zero.array.length=0}}]),e}(),Xy=Ny.createInvokeImpl(Uy),Yy=Ny.createInvokeImpl(Vy),Qy=new Je(4);Qy.get=function(){var e=this._get()||{preload:new Wy(Xy),onLoad:new Ny.OneOffInvoker(Yy),onEnable:new Ny.OneOffInvoker(Ny.invokeOnEnable)};e.preload._zero.i=-1;var t=e.onLoad;return t._zero.i=-1,t._neg.i=-1,t._pos.i=-1,(t=e.onEnable)._zero.i=-1,t._neg.i=-1,t._pos.i=-1,e};var Ky=P2("NodeActivator",function(){function e(){y(this,e),this.resetComp=void 0,this._activatingStack=void 0,this.reset()}return l(e,[{key:"reset",value:function(){this._activatingStack=[]}},{key:"activateNode",value:function(e,t){if(t){var i=Qy.get();this._activatingStack.push(i),this._activateNodeRecursively(e,i.preload,i.onLoad,i.onEnable),i.preload.invoke(),i.onLoad.invoke(),i.onEnable.invoke(),this._activatingStack.pop(),Qy.put(i)}else{this._deactivateNodeRecursively(e);var n=this._activatingStack,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;o.preload.cancelInactive(Gy),o.onLoad.cancelInactive(Hy),o.onEnable.cancelInactive()}}e.emit("active-in-hierarchy-changed",e)}},{key:"activateComp",value:function(e,t,i,n){if(e._objFlags&Gy||(e._objFlags|=Gy,e.__preload&&(t?t.add(e):e.__preload())),e._objFlags&Hy||(e._objFlags|=Hy,e.onLoad?i?i.add(e):(e.onLoad(),e._objFlags|=qy):e._objFlags|=qy),e._enabled){if(!e.node._activeInHierarchy)return;cc.director._compScheduler.enableComp(e,n)}}},{key:"destroyComp",value:function(e){cc.director._compScheduler.disableComp(e),e.onDestroy&&e._objFlags&qy&&e.onDestroy()}},{key:"_activateNodeRecursively",value:function(e,t,i,n){if(e._objFlags&jy)cc.errorID(3816,e.name);else{e._activeInHierarchy=!0;for(var r,a,s,o=e._components.length,l=0;l<o;++l){var c=e._components[l];c instanceof cc.Component?this.activateComp(c,t,i,n):(r=e,s=l,(a=c)?r._removeComponent(a):$e.removeAt(r._components,s),--l,--o)}e._childArrivalOrder=e._children.length;for(var u=0,h=e._children.length;u<h;++u){var f=e._children[u];f._active&&this._activateNodeRecursively(f,t,i,n)}e._onPostActivated(!0)}}},{key:"_deactivateNodeRecursively",value:function(e){e._objFlags|=jy,e._activeInHierarchy=!1;for(var t=e._components.length,i=0;i<t;++i){var n=e._components[i];if(n._enabled&&(cc.director._compScheduler.disableComp(n),e._activeInHierarchy))return void(e._objFlags&=~jy)}for(var r=0,a=e._children.length;r<a;++r){var s=e._children[r];if(s._activeInHierarchy&&(this._deactivateNodeRecursively(s),e._activeInHierarchy))return void(e._objFlags&=~jy)}e._onPostActivated(!1),e._objFlags&=~jy}}]),e}());sr(fm.prototype,"BaseNode",[{name:"childrenCount",newName:"children.length",customGetter:function(){return this.children.length}}]),or(Sm.prototype,"Node.prototype",[{name:"addLayer"},{name:"removeLayer"}]),or(qh,"Layers",[{name:"All"},{name:"RaycastMask"},{name:"check"}]),sr(qh,"Layers",[{name:"Default",newName:"DEFAULT",target:qh.Enum,targetName:"Layers.Enum"},{name:"Always",newName:"ALWAYS",target:qh.Enum,targetName:"Layers.Enum"},{name:"IgnoreRaycast",newName:"IGNORE_RAYCAST",target:qh.Enum,targetName:"Layers.Enum"},{name:"Gizmos",newName:"GIZMOS",target:qh.Enum,targetName:"Layers.Enum"},{name:"Editor",newName:"EDITOR",target:qh.Enum,targetName:"Layers.Enum"},{name:"UI",newName:"UI_3D",target:qh.Enum,targetName:"Layers.Enum"},{name:"UI2D",newName:"UI_2D",target:qh.Enum,targetName:"Layers.Enum"},{name:"SceneGizmo",newName:"SCENE_GIZMO",target:qh.Enum,targetName:"Layers.Enum"},{name:"makeInclusiveMask",newName:"makeMaskInclude",target:qh,targetName:"Layers"},{name:"makeExclusiveMask",newName:"makeMaskExclude",target:qh,targetName:"Layers"}]);var Zy=new Float32Array(4),Jy=(new zn,new Fi),$y=new Wi(0,0,0,0),eg=function(){function t(e){y(this,t),this._root=void 0,this._device=void 0,this._name="BasePipeline",this._renderObjects=[],this._renderPasses=new Map,this._flows=[],this._isHDRSupported=!1,this._isHDR=!1,this._lightMeterScale=1e4,this._shadingPass=null,this._fboCount=0,this._msaaShadingTex=null,this._msaaShadingTexView=null,this._msaaDepthStencilTex=null,this._msaaDepthStencilTexView=null,this._msaaShadingFBO=null,this._colorFmt=Il.UNKNOWN,this._depthStencilFmt=Il.UNKNOWN,this._shadingTextures=[],this._shadingTexViews=[],this._depthStencilTex=null,this._depthStencilTexView=null,this._shadingFBOs=[],this._shadingWidth=0,this._shadingHeight=0,this._shadingScale=1,this._curIdx=0,this._prevIdx=1,this._usePostProcess=!1,this._useMSAA=!1,this._useSMAA=!1,this._smaaPass=null,this._smaaEdgeFBO=null,this._smaaEdgeTex=null,this._smaaEdgeTexView=null,this._smaaBlendFBO=null,this._smaaBlendTex=null,this._smaaBlendTexView=null,this._quadVB=null,this._quadIB=null,this._quadIA=null,this._uboGlobal=new Jh,this._globalBindings=new Map,this._defaultTex=null,this._defaultTexView=null,this._fpScale=1/1024,this._fpScaleInv=1024,this._macros={},this._useDynamicBatching=!1,this._root=e,this._device=e.device}return l(t,[{key:"root",get:function(){return this._root}},{key:"device",get:function(){return this._device}},{key:"name",get:function(){return this._name}},{key:"renderObjects",get:function(){return this._renderObjects}},{key:"flows",get:function(){return this._flows}},{key:"usePostProcess",get:function(){return this._usePostProcess}},{key:"isHDRSupported",get:function(){return this._isHDRSupported}},{key:"isHDR",get:function(){return this._isHDR}},{key:"shadingScale",get:function(){return this._shadingScale}},{key:"lightMeterScale",set:function(e){this._lightMeterScale=e},get:function(){return this._lightMeterScale}},{key:"depthStencilTexView",get:function(){return this._depthStencilTexView}},{key:"curShadingTexView",get:function(){return this._shadingTexViews[this._curIdx]}},{key:"prevShadingTexView",get:function(){return this._shadingTexViews[this._prevIdx]}},{key:"curShadingFBO",get:function(){return this._shadingFBOs[this._curIdx]}},{key:"prevShadingFBO",get:function(){return this._shadingFBOs[this._prevIdx]}},{key:"msaaShadingFBO",get:function(){return this._msaaShadingFBO}},{key:"useMSAA",get:function(){return this._useMSAA}},{key:"useSMAA",get:function(){return this._useSMAA}},{key:"smaaEdgeTexView",get:function(){return this._smaaEdgeTexView}},{key:"smaaEdgeFBO",get:function(){return this._smaaEdgeFBO}},{key:"smaaBlendTexView",get:function(){return this._smaaBlendTexView}},{key:"smaaBlendFBO",get:function(){return this._smaaBlendFBO}},{key:"quadIA",get:function(){return this._quadIA}},{key:"globalBindings",get:function(){return this._globalBindings}},{key:"defaultTexture",get:function(){return this._defaultTex}},{key:"fpScale",get:function(){return this._fpScale}},{key:"fpScaleInv",get:function(){return this._fpScaleInv}},{key:"macros",get:function(){return this._macros}},{key:"defaultGlobalUBOData",get:function(){return this._uboGlobal.view}},{key:"useDynamicBatching",get:function(){return this._useDynamicBatching}}]),l(t,[{key:"render",value:function(e){e.camera.update(),this.sceneCulling(e),this.updateUBOs(e);var t=e.flows,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.render(e)}}},{key:"rebuild",value:function(){this.updateMacros()}},{key:"resize",value:function(e,t){var i=Math.floor(e*this._shadingScale),n=Math.floor(t*this._shadingScale);(i>this._shadingWidth||n>this._shadingHeight)&&this.resizeFBOs(i,n);var r=this._flows,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}o.resize(e,t)}}},{key:"swapFBOs",value:function(){var e=this._curIdx;this._curIdx=this._prevIdx,this._prevIdx=e}},{key:"addRenderPass",value:function(e,t){t&&this._renderPasses.set(e,t)}},{key:"getRenderPass",value:function(e){var t=this._renderPasses.get(e);return t||null}},{key:"removeRenderPass",value:function(e){this._renderPasses.delete(e)}},{key:"clearRenderPasses",value:function(){this._renderPasses.clear()}},{key:"createFlow",value:function(e,t){var i=new e(this);return i.initialize(t)?(this._flows.push(i),this._flows.sort(function(e,t){return e.priority-t.priority}),i):null}},{key:"destroyFlows",value:function(){var e=this._flows,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._flows=[]}},{key:"getFlow",value:function(e){var t=this._flows,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;if(a.name===e)return a}return null}},{key:"updateMacros",value:function(){Id.destroyShaderByDefines(this._macros),this._macros.CC_USE_HDR=this._isHDR;var e=this._root.scenes,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.onPipelineChange()}}},{key:"_initialize",value:function(e){if(void 0!==e.enablePostProcess?this._usePostProcess=e.enablePostProcess:this._usePostProcess=!1,this._usePostProcess&&((this._device.hasFeature(iu.FORMAT_R11G11B10F)||this._device.hasFeature(iu.TEXTURE_HALF_FLOAT)||this._device.hasFeature(iu.TEXTURE_FLOAT))&&(this._isHDRSupported=!0),this._fboCount=1,this._shadingTextures=new Array(this._fboCount),this._shadingTexViews=new Array(this._fboCount),this._shadingFBOs=new Array(this._fboCount),this._isHDR=void 0===e.enableHDR||e.enableHDR,this._useSMAA=void 0!==e.enableSMAA&&e.enableSMAA,this._useMSAA=void 0!==e.enableMSAA&&e.enableMSAA,this._useMSAA&&(this._useMSAA=this.device.hasFeature(iu.MSAA))),this._isHDR&&this._isHDRSupported&&(this._device.hasFeature(iu.COLOR_HALF_FLOAT)&&this._device.hasFeature(iu.TEXTURE_HALF_FLOAT_LINEAR)?this._device.hasFeature(iu.FORMAT_R11G11B10F)?(this._colorFmt=Il.R11G11B10F,this._isHDR=!0):this._device.hasFeature(iu.TEXTURE_HALF_FLOAT)&&(this._colorFmt=Il.RGBA16F,this._isHDR=!0):this._device.hasFeature(iu.COLOR_FLOAT)&&this._device.hasFeature(iu.TEXTURE_FLOAT_LINEAR)&&this._device.hasFeature(iu.TEXTURE_FLOAT)&&(this._colorFmt=Il.RGBA32F,this._isHDR=!0),this._isHDR=!1),this._isHDR||(this._colorFmt=Il.RGBA8),24===this._device.depthBits?8===this._device.stencilBits?this._depthStencilFmt=Il.D24S8:this._depthStencilFmt=Il.D24:this._depthStencilFmt=Il.D16,this.updateMacros(),this._shadingScale=1,this._shadingWidth=Math.floor(this._device.nativeWidth),this._shadingHeight=Math.floor(this._device.nativeHeight),console.info("USE_POST_PROCESS: "+this._usePostProcess),this._usePostProcess&&(console.info("USE_MSAA: "+this._useMSAA),console.info("USE_SMAA: "+this._useSMAA),console.info("USE_HDR: "+this._isHDR)),console.info("SHADING_SIZE: "+this._shadingWidth+" x "+this._shadingHeight),console.info("SHADING_SCALE: "+this._shadingScale.toFixed(4)),console.info("SHADING_COLOR_FORMAT: "+Qc[this._colorFmt].name),console.info("SHADING_DEPTH_FORMAT: "+Qc[this._depthStencilFmt].name),this._shadingPass=this._device.createRenderPass({colorAttachments:[{format:this._colorFmt,loadOp:Ac.CLEAR,storeOp:Rc.STORE,sampleCount:1,beginLayout:Mc.COLOR_ATTACHMENT_OPTIMAL,endLayout:Mc.COLOR_ATTACHMENT_OPTIMAL}],depthStencilAttachment:{format:this._depthStencilFmt,depthLoadOp:Ac.CLEAR,depthStoreOp:Rc.STORE,stencilLoadOp:Ac.CLEAR,stencilStoreOp:Rc.STORE,sampleCount:1,beginLayout:Mc.DEPTH_STENCIL_ATTACHMENT_OPTIMAL,endLayout:Mc.DEPTH_STENCIL_ATTACHMENT_OPTIMAL}}),this._useMSAA&&(this._msaaShadingTex=this._device.createTexture({type:hc.TEX2D,usage:dc.COLOR_ATTACHMENT|dc.SAMPLED,format:this._colorFmt,width:this._shadingWidth,height:this._shadingHeight}),this._msaaShadingTexView=this._device.createTextureView({texture:this._msaaShadingTex,type:gc.TV2D,format:this._colorFmt}),this._msaaDepthStencilTex=this._device.createTexture({type:hc.TEX2D,usage:dc.DEPTH_STENCIL_ATTACHMENT|dc.SAMPLED,format:this._depthStencilFmt,width:this._shadingWidth,height:this._shadingHeight}),this._msaaDepthStencilTexView=this._device.createTextureView({texture:this._msaaDepthStencilTex,type:gc.TV2D,format:this._depthStencilFmt}),this._msaaShadingFBO=this._device.createFramebuffer({renderPass:this._shadingPass,colorViews:[this._msaaShadingTexView],depthStencilView:this._msaaDepthStencilTexView})),0<this._fboCount){this._depthStencilTex=this._device.createTexture({type:hc.TEX2D,usage:dc.DEPTH_STENCIL_ATTACHMENT|dc.SAMPLED,format:this._depthStencilFmt,width:this._shadingWidth,height:this._shadingHeight}),this._depthStencilTexView=this._device.createTextureView({texture:this._depthStencilTex,type:gc.TV2D,format:this._depthStencilFmt});for(var t=0;t<this._fboCount;++t)this._shadingTextures[t]=this._device.createTexture({type:hc.TEX2D,usage:dc.COLOR_ATTACHMENT|dc.SAMPLED,format:this._colorFmt,width:this._shadingWidth,height:this._shadingHeight}),this._shadingTexViews[t]=this._device.createTextureView({texture:this._shadingTextures[t],type:gc.TV2D,format:this._colorFmt}),this._shadingFBOs[t]=this._device.createFramebuffer({renderPass:this._shadingPass,colorViews:[this._shadingTexViews[t]],depthStencilView:this._depthStencilTexView})}if(this._useSMAA){var i=Il.RGBA8;this._smaaPass=this._device.createRenderPass({colorAttachments:[{format:i,loadOp:Ac.CLEAR,storeOp:Rc.STORE,sampleCount:1,beginLayout:Mc.COLOR_ATTACHMENT_OPTIMAL,endLayout:Mc.COLOR_ATTACHMENT_OPTIMAL}]}),this._smaaEdgeTex=this._device.createTexture({type:hc.TEX2D,usage:dc.COLOR_ATTACHMENT|dc.SAMPLED,format:i,width:this._shadingWidth,height:this._shadingHeight}),this._smaaEdgeTexView=this._device.createTextureView({texture:this._smaaEdgeTex,type:gc.TV2D,format:i}),this._smaaEdgeFBO=this._device.createFramebuffer({renderPass:this._smaaPass,colorViews:[this._smaaEdgeTexView],depthStencilView:null}),this._smaaBlendTex=this._device.createTexture({type:hc.TEX2D,usage:dc.COLOR_ATTACHMENT|dc.SAMPLED,format:i,width:this._shadingWidth,height:this._shadingHeight}),this._smaaBlendTexView=this._device.createTextureView({texture:this._smaaBlendTex,type:gc.TV2D,format:i}),this._smaaBlendFBO=this._device.createFramebuffer({renderPass:this._smaaPass,colorViews:[this._smaaBlendTexView],depthStencilView:null})}return!!this.createQuadInputAssembler()&&!!this.createUBOs()}},{key:"_destroy",value:function(){this.destroyFlows(),this.clearRenderPasses(),this.destroyQuadInputAssembler(),this.destroyUBOs(),this._smaaEdgeTexView&&(this._smaaEdgeTexView.destroy(),this._smaaEdgeTexView=null),this._smaaEdgeTex&&(this._smaaEdgeTex.destroy(),this._smaaEdgeTex=null),this._smaaEdgeFBO&&(this._smaaEdgeFBO.destroy(),this._smaaEdgeFBO=null),this._smaaBlendTexView&&(this._smaaBlendTexView.destroy(),this._smaaBlendTexView=null),this._smaaBlendTex&&(this._smaaBlendTex.destroy(),this._smaaBlendTex=null),this._smaaBlendFBO&&(this._smaaBlendFBO.destroy(),this._smaaBlendFBO=null),this._msaaShadingTexView&&(this._msaaShadingTexView.destroy(),this._msaaShadingTexView=null),this._msaaShadingTex&&(this._msaaShadingTex.destroy(),this._msaaShadingTex=null),this._msaaDepthStencilTexView&&(this._msaaDepthStencilTexView.destroy(),this._msaaDepthStencilTexView=null),this._msaaDepthStencilTex&&(this._msaaDepthStencilTex.destroy(),this._msaaDepthStencilTex=null),this._msaaShadingFBO&&(this._msaaShadingFBO.destroy(),this._msaaShadingFBO=null);for(var e=0;e<this._shadingTexViews.length;++e)this._shadingTexViews[e]&&this._shadingTexViews[e].destroy(),this._shadingTextures[e]&&this._shadingTextures[e].destroy(),this._shadingFBOs[e]&&this._shadingFBOs[e].destroy();this._shadingTexViews.splice(0),this._shadingTextures.splice(0),this._shadingFBOs.splice(0),this._depthStencilTexView&&(this._depthStencilTexView.destroy(),this._depthStencilTexView=null),this._depthStencilTex&&(this._depthStencilTex.destroy(),this._depthStencilTex=null),this._shadingPass&&(this._shadingPass.destroy(),this._shadingPass=null)}},{key:"resizeFBOs",value:function(e,t){this._shadingWidth=e,this._shadingHeight=t,this._depthStencilTex&&(this._depthStencilTex.resize(e,t),this._depthStencilTexView.destroy(),this._depthStencilTexView.initialize({texture:this._depthStencilTex,type:gc.TV2D,format:this._depthStencilFmt}));for(var i=0;i<this._fboCount;++i)this._shadingTextures[i].resize(e,t),this._shadingTexViews[i].destroy(),this._shadingTexViews[i].initialize({texture:this._shadingTextures[i],type:gc.TV2D,format:this._colorFmt}),this._shadingFBOs[i].destroy(),this._shadingFBOs[i].initialize({renderPass:this._shadingPass,colorViews:[this._shadingTexViews[i]],depthStencilView:this._depthStencilTexView});if(this._useMSAA&&(this._msaaShadingTex.resize(e,t),this._msaaShadingTexView.destroy(),this._msaaShadingTexView.initialize({texture:this._msaaShadingTex,type:gc.TV2D,format:this._colorFmt}),this._msaaDepthStencilTex.resize(e,t),this._msaaDepthStencilTexView.destroy(),this._msaaDepthStencilTexView.initialize({texture:this._msaaDepthStencilTex,type:gc.TV2D,format:this._depthStencilFmt}),this._msaaShadingFBO.destroy(),this._msaaShadingFBO.initialize({renderPass:this._shadingPass,colorViews:[this._msaaShadingTexView],depthStencilView:this._msaaDepthStencilTexView})),this._useSMAA){var n=this._smaaEdgeTex.format;this._smaaEdgeTex.resize(e,t),this._smaaEdgeTexView.destroy(),this._smaaEdgeTexView.initialize({texture:this._smaaEdgeTex,type:gc.TV2D,format:n}),this._smaaEdgeFBO.destroy(),this._smaaEdgeFBO.initialize({renderPass:this._smaaPass,colorViews:[this._smaaEdgeTexView],depthStencilView:null}),this._smaaBlendTex.resize(e,t),this._smaaBlendTexView.destroy(),this._smaaBlendTexView.initialize({texture:this._smaaBlendTex,type:gc.TV2D,format:n}),this._smaaBlendFBO.destroy(),this._smaaBlendFBO.initialize({renderPass:this._smaaPass,colorViews:[this._smaaBlendTexView],depthStencilView:null})}console.info("Resizing shading fbos: "+this._shadingWidth+"x"+this._shadingHeight)}},{key:"createQuadInputAssembler",value:function(){var e=4*Float32Array.BYTES_PER_ELEMENT,t=4*e;if(this._quadVB=this._device.createBuffer({usage:zl.VERTEX|zl.TRANSFER_DST,memUsage:Pl.HOST|Pl.DEVICE,size:t,stride:e}),!this._quadVB)return!1;var i=new Float32Array(16),n=0;i[n++]=-1,i[n++]=-1,i[n++]=0,i[n++]=0,i[n++]=1,i[n++]=-1,i[n++]=1,i[n++]=0,i[n++]=-1,i[n++]=1,i[n++]=0,i[n++]=1,i[n++]=1,i[n++]=1,i[n++]=1,i[n++]=1,this._quadVB.update(i);var r=Uint8Array.BYTES_PER_ELEMENT,a=6*r;if(this._quadIB=this._device.createBuffer({usage:zl.INDEX|zl.TRANSFER_DST,memUsage:Pl.HOST|Pl.DEVICE,size:a,stride:r}),!this._quadIB)return!1;var s=new Uint8Array(6);s[0]=0,s[1]=1,s[2]=2,s[3]=1,s[4]=3,s[5]=2,this._quadIB.update(s);var o=[{name:"a_position",format:Il.RG32F},{name:"a_texCoord",format:Il.RG32F}];return this._quadIA=this._device.createInputAssembler({attributes:o,vertexBuffers:[this._quadVB],indexBuffer:this._quadIB}),!0}},{key:"destroyQuadInputAssembler",value:function(){this._quadVB&&(this._quadVB.destroy(),this._quadVB=null),this._quadIB&&(this._quadIB.destroy(),this._quadIB=null),this._quadIA&&(this._quadIA.destroy(),this._quadIA=null)}},{key:"createUBOs",value:function(){if(!this._globalBindings.get(Jh.BLOCK.name)){var e=this._root.device.createBuffer({usage:zl.UNIFORM|zl.TRANSFER_DST,memUsage:Pl.HOST|Pl.DEVICE,size:Jh.SIZE});this._globalBindings.set(Jh.BLOCK.name,{type:wc.UNIFORM_BUFFER,blockInfo:Jh.BLOCK,buffer:e})}if(!this._globalBindings.get($h.BLOCK.name)){var t=this._root.device.createBuffer({usage:zl.UNIFORM|zl.TRANSFER_DST,memUsage:Pl.HOST|Pl.DEVICE,size:$h.SIZE});this._globalBindings.set($h.BLOCK.name,{type:wc.UNIFORM_BUFFER,blockInfo:$h.BLOCK,buffer:t})}return this._globalBindings.get(tf.name)||this._globalBindings.set(tf.name,{type:wc.SAMPLER,samplerInfo:tf}),!0}},{key:"destroyUBOs",value:function(){var e=this._globalBindings.get(Jh.BLOCK.name);e&&(e.buffer.destroy(),this._globalBindings.delete(Jh.BLOCK.name));var t=this._globalBindings.get($h.BLOCK.name);t&&(t.buffer.destroy(),this._globalBindings.delete($h.BLOCK.name))}},{key:"updateUBOs",value:function(e){var t=e.camera,i=t.scene,n=this._root.device,r=i.mainLight,a=i.ambient,s=this._uboGlobal.view;s[Jh.TIME_OFFSET]=this._root.cumulativeTime,s[Jh.SCREEN_SIZE_OFFSET]=n.width,s[Jh.SCREEN_SIZE_OFFSET+1]=n.height,s[Jh.SCREEN_SIZE_OFFSET+2]=1/s[Jh.SCREEN_SIZE_OFFSET],s[Jh.SCREEN_SIZE_OFFSET+3]=1/s[Jh.SCREEN_SIZE_OFFSET+1],s[Jh.SCREEN_SCALE_OFFSET]=t.width/this._shadingWidth*this._shadingScale,s[Jh.SCREEN_SCALE_OFFSET+1]=t.height/this._shadingHeight*this._shadingScale,s[Jh.SCREEN_SCALE_OFFSET+2]=1/s[Jh.SCREEN_SCALE_OFFSET],s[Jh.SCREEN_SCALE_OFFSET+3]=1/s[Jh.SCREEN_SCALE_OFFSET+1],s[Jh.NATIVE_SIZE_OFFSET]=this._shadingWidth,s[Jh.NATIVE_SIZE_OFFSET+1]=this._shadingHeight,s[Jh.NATIVE_SIZE_OFFSET+2]=1/s[Jh.NATIVE_SIZE_OFFSET],s[Jh.NATIVE_SIZE_OFFSET+3]=1/s[Jh.NATIVE_SIZE_OFFSET+1],zn.toArray(s,t.matView,Jh.MAT_VIEW_OFFSET),zn.toArray(s,t.node.worldMatrix,Jh.MAT_VIEW_INV_OFFSET),zn.toArray(s,t.matProj,Jh.MAT_PROJ_OFFSET),zn.toArray(s,t.matProjInv,Jh.MAT_PROJ_INV_OFFSET),zn.toArray(s,t.matViewProj,Jh.MAT_VIEW_PROJ_OFFSET),zn.toArray(s,t.matViewProjInv,Jh.MAT_VIEW_PROJ_INV_OFFSET),Fi.toArray(s,t.position,Jh.CAMERA_POS_OFFSET);var o=t.exposure;if(s[Jh.EXPOSURE_OFFSET]=o,s[Jh.EXPOSURE_OFFSET+1]=1/o,s[Jh.EXPOSURE_OFFSET+2]=this._isHDR?1:0,s[Jh.EXPOSURE_OFFSET+3]=this._fpScale/o,Fi.toArray(s,r.direction,Jh.MAIN_LIT_DIR_OFFSET),r.enabled){if(Fi.toArray(s,r.color,Jh.MAIN_LIT_COLOR_OFFSET),r.useColorTemperature){var l=r.colorTemperatureRGB;s[Jh.MAIN_LIT_COLOR_OFFSET]*=l.x,s[Jh.MAIN_LIT_COLOR_OFFSET+1]*=l.y,s[Jh.MAIN_LIT_COLOR_OFFSET+2]*=l.z}this._isHDR?s[Jh.MAIN_LIT_COLOR_OFFSET+3]=r.illuminance*this._fpScale:s[Jh.MAIN_LIT_COLOR_OFFSET+3]=r.illuminance*o}else Wi.toArray(s,$y,Jh.MAIN_LIT_COLOR_OFFSET);Zy.set(a.skyColor),this._isHDR?Zy[3]=a.skyIllum*this._fpScale:Zy[3]=a.skyIllum*o,this._uboGlobal.view.set(Zy,Jh.AMBIENT_SKY_OFFSET),this._uboGlobal.view.set(a.groundAlbedo,Jh.AMBIENT_GROUND_OFFSET),this._globalBindings.get(Jh.BLOCK.name).buffer.update(this._uboGlobal.view.buffer)}},{key:"sceneCulling",value:function(e){var t=e.camera,i=t.scene;this._renderObjects.splice(0);var n=i.mainLight;n&&n.enabled&&n.update();var r=i.planarShadows;r.enabled&&n.node.hasChangedFlags&&r.updateDirLight(n),i.skybox.enabled&&t.clearFlag&z_&&this.addVisibleModel(i.skybox,t);var a=i.models,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}var c=l;if(c._resetUBOUpdateFlag(),c.enabled)if(e.visibility&qh.BitMask.UI_2D)(c.node&&e.visibility===c.node.layer||e.visibility===c.visFlags)&&(c.updateTransform(),c.updateUBOs(),this.addVisibleModel(c,t));else if(c.node&&e.visibility&c.node.layer||e.visibility&c.visFlags){if(c.updateTransform(),c.worldBounds&&!ja.aabb_frustum(c.worldBounds,t.frustum))continue;c.updateUBOs(),this.addVisibleModel(c,t)}}r.enabled&&r.updateCommandBuffers()}},{key:"addVisibleModel",value:function(e,t){var i=0;e.node&&(e.node.getWorldPosition(Jy),Fi.subtract(Jy,Jy,t.position),i=Fi.dot(Jy,t.forward)),this._renderObjects.push({model:e,depth:i})}}]),t}(),tg=function(){function i(e,t){y(this,i),this.array=void 0,this.length=0,this.cache=void 0,this._compareFn=void 0,this.array=new Array(e),this.cache=this.array,this.length=0,this._compareFn=void 0!==t?t:function(e,t){return e-t}}return l(i,[{key:"push",value:function(e){this.array[this.length++]=e}},{key:"pop",value:function(){return this.array[this.length--]}},{key:"get",value:function(e){return this.array[e]}},{key:"clear",value:function(){this.cache.fill(null),this.length=0}},{key:"sort",value:function(){this.array.length=this.length,this.array.sort(this._compareFn)}},{key:"concat",value:function(e){for(var t=0;t<e.length;++t)this.array[this.length++]=e.array[t]}},{key:"append",value:function(e){var t=e,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;this.array[this.length++]=a}}}]),i}();function ig(e,t){return e.hash===t.hash?e.depth===t.depth?e.shaderId-t.shaderId:e.depth-t.depth:e.hash-t.hash}function ng(e,t){return e.hash===t.hash?e.depth===t.depth?e.shaderId-t.shaderId:t.depth-e.depth:e.hash-t.hash}var rg=function(){function t(e){y(this,t),this.queue=void 0,this.cmdBuffs=void 0,this.cmdBuffCount=0,this._passDesc=void 0,this._passDesc=e,this.cmdBuffs=new tg(64),this.queue=new tg(64,this._passDesc.sortFunc)}return l(t,[{key:"clear",value:function(){this.queue.clear(),this.cmdBuffCount=0}},{key:"insertRenderPass",value:function(e,t,i){var n=e.model.getSubModel(t),r=n.passes[i],a=n.psos[i];if(a.blendState.targets[0].blend!==this._passDesc.isTransparent||!(r.phase&this._passDesc.phases))return!1;var s=0|r.priority<<16|n.priority<<8|i;return this.queue.push({hash:s,depth:e.depth,shaderId:a.shader.id,subModel:n,cmdBuff:n.commandBuffers[i]}),!0}},{key:"sort",value:function(){this.queue.sort(),this.cmdBuffCount=this.queue.length;for(var e=0;e<this.queue.length;++e)this.cmdBuffs.array[e]=this.queue.array[e].cmdBuff}}]),t}(),ag=[],sg=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._uiQueue=void 0,t._uiQueue=new rg({isTransparent:!0,phases:Od("default"),sortFunc:ng}),t}return p(i,T_),l(i,[{key:"initialize",value:function(e){return void 0!==e.name&&(this._name=e.name),this._priority=e.priority,void 0!==e.framebuffer&&(this._framebuffer=e.framebuffer),this._cmdBuff=this._device.createCommandBuffer({allocator:this._device.commandAllocator,type:Ec.PRIMARY}),!0}},{key:"destroy",value:function(){this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)}},{key:"resize",value:function(e,t){}},{key:"rebuild",value:function(){}},{key:"render",value:function(e){this._uiQueue.clear();var t=this._pipeline.renderObjects,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}for(var a=r,s=0;s<a.model.subModelNum;s++)for(var o=0;o<a.model.getSubModel(s).passes.length;o++)this._uiQueue.insertRenderPass(a,s,o)}this._uiQueue.sort();var l=e.window.framebuffer,c=this._cmdBuff,u=e.camera;this._renderArea.width=this.flow.pipeline.root.device.width,this._renderArea.height=this.flow.pipeline.root.device.height,c.begin(),c.beginRenderPass(l,this._renderArea,u.clearFlag,[u.clearColor],u.clearDepth,u.clearStencil),c.execute(this._uiQueue.cmdBuffs.array,this._uiQueue.cmdBuffCount),c.endRenderPass(),c.end(),ag[0]=c,this._device.queue.submit(ag)}}]),i}(),og=function(){function i(e){return y(this,i),x(this,g(i).call(this,e))}return p(i,w_),l(i,[{key:"initialize",value:function(e){void 0!==e.name&&(this._name=e.name),this._priority=e.priority;var t=this._pipeline.root.mainWindow;return!(!t||!t.framebuffer)&&(this.createStage(sg,{name:"UIStage",priority:0,framebuffer:t.framebuffer}),!0)}},{key:"destroy",value:function(){this.destroyStages()}},{key:"rebuild",value:function(){}},{key:"render",value:function(e){var t=this.pipeline.defaultGlobalUBOData[Jh.EXPOSURE_OFFSET+2];this.pipeline.defaultGlobalUBOData[Jh.EXPOSURE_OFFSET+2]=0,this.pipeline.globalBindings.get(Jh.BLOCK.name).buffer.update(this.pipeline.defaultGlobalUBOData.buffer),_(g(i.prototype),"render",this).call(this,e),this.pipeline.defaultGlobalUBOData[Jh.EXPOSURE_OFFSET+2]=t,this.pipeline.globalBindings.get(Jh.BLOCK.name).buffer.update(this.pipeline.defaultGlobalUBOData.buffer)}}]),i}();var lg,cg,ug=function(){function e(){y(this,e),this.queue=new Set}return l(e,[{key:"clear",value:function(){var e=this.queue.values(),t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.clear()}this.queue.clear()}},{key:"recordCommandBuffer",value:function(e){var t=this.queue.values(),i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;a.pso&&(e.bindPipelineState(a.pso),e.bindBindingLayout(a.pso.pipelineLayout.layouts[0]));for(var s=0;s<a.batches.length;++s){var o=a.batches[s];a.ubo.update(o.uboLocal.view),e.bindInputAssembler(o.ia),e.draw(o.ia)}}}}]),e}(),hg=[],fg=[],dg=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._opaqueQueue=void 0,t._transparentQueue=void 0,t._opaqueBatchedQueue=void 0,t._opaqueQueue=new rg({isTransparent:!1,phases:Od("default"),sortFunc:ig}),t._transparentQueue=new rg({isTransparent:!0,phases:Od("default")|Od("planarShadow"),sortFunc:ng}),t._opaqueBatchedQueue=new ug,t}return p(i,T_),l(i,[{key:"initialize",value:function(e){return void 0!==e.name&&(this._name=e.name),this._priority=e.priority,this._cmdBuff=this._device.createCommandBuffer({allocator:this._device.commandAllocator,type:Ec.PRIMARY}),!0}},{key:"destroy",value:function(){this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)}},{key:"resize",value:function(e,t){}},{key:"rebuild",value:function(){}},{key:"render",value:function(e){this._opaqueBatchedQueue.clear(),this._opaqueQueue.clear(),this._transparentQueue.clear();for(var t=this._pipeline.renderObjects,i=0;i<t.length;++i){var n=t[i];if(n.model.isDynamicBatching)for(var r=0;r<n.model.subModels.length;++r)for(var a=n.model.subModels[r],s=a.passes,o=0;o<s.length;++o){var l=a.passes[o];if(l.batchedBuffer){var c=a.psos[o];if(c.blendState.targets[0].blend){var u=0|l.priority<<16|a.priority<<8|o;this._transparentQueue.queue.push({hash:u,depth:n.depth,shaderId:c.shader.id,subModel:a,cmdBuff:a.commandBuffers[o]})}else l.batchedBuffer.merge(a,n),this._opaqueBatchedQueue.queue.add(l.batchedBuffer)}}else for(var h=n.model.subModels,f=0;f<h.length;++f)for(var d=h[f],p=d.passes,_=0;_<p.length;++_){var v=d.passes[_],m=d.psos[_],y=m.blendState.targets[0].blend,g=0|v.priority<<16|d.priority<<8|_;y?this._transparentQueue.queue.push({hash:g,depth:n.depth,shaderId:m.shader.id,subModel:d,cmdBuff:d.commandBuffers[_]}):this._opaqueQueue.queue.push({hash:g,depth:n.depth,shaderId:m.shader.id,subModel:d,cmdBuff:d.commandBuffers[_]})}}this._opaqueQueue.sort(),this._transparentQueue.sort();var b=e.camera,x=this._cmdBuff,S=b.viewport;if(this._renderArea.x=S.x*b.width,this._renderArea.y=S.y*b.height,this._renderArea.width=S.width*b.width*this.pipeline.shadingScale,this._renderArea.height=S.height*b.height*this.pipeline.shadingScale,b.clearFlag&Vc.COLOR){if(hg[0]=b.clearColor,this._pipeline.isHDR){hg[0]=function(e){return{r:Math.pow(e.r,2.2),g:Math.pow(e.g,2.2),b:Math.pow(e.b,2.2),a:1}}(hg[0]);var w=this._pipeline.fpScale/b.exposure;hg[0].r*=w,hg[0].g*=w,hg[0].b*=w}hg.length=1}this._pipeline.usePostProcess?this._pipeline.useMSAA?this._framebuffer=this._pipeline.msaaShadingFBO:this._framebuffer=this._pipeline.curShadingFBO:this._framebuffer=e.window.framebuffer;var T=b.scene.planarShadows;x.begin(),x.beginRenderPass(this._framebuffer,this._renderArea,b.clearFlag,hg,b.clearDepth,b.clearStencil),x.execute(this._opaqueQueue.cmdBuffs.array,this._opaqueQueue.cmdBuffCount),this._opaqueBatchedQueue.recordCommandBuffer(x),x.execute(T.cmdBuffs.array,T.cmdBuffCount),x.execute(this._transparentQueue.cmdBuffs.array,this._transparentQueue.cmdBuffCount),x.endRenderPass(),x.end(),fg[0]=x,this._device.queue.submit(fg),this._pipeline.useMSAA&&this._device.blitFramebuffer(this._framebuffer,this._pipeline.curShadingFBO,this._renderArea,this._renderArea,sc.POINT)}}]),i}();(cg=lg=lg||{})[cg.FORWARD=0]="FORWARD";var pg,_g,vg=function(){function t(e){return y(this,t),x(this,g(t).call(this,e))}return p(t,w_),l(t,[{key:"initialize",value:function(e){return void 0!==e.name&&(this._name=e.name),this._priority=e.priority,this.createStage(dg,{name:"ForwardStage",priority:lg.FORWARD}),!0}},{key:"destroy",value:function(){this.destroyStages()}},{key:"rebuild",value:function(){}}]),t}();(_g=pg=pg||{})[_g.FORWARD=0]="FORWARD",_g[_g.UI=10]="UI";var mg,yg,gg=new Float32Array(4),bg=ns.create(0,0,0,1),xg=[],Sg=[],wg=new Fi,Tg=function(){function f(e){var t;return y(this,f),(t=x(this,g(f).call(this,e)))._uboLights=new rf,t._lightsUBO=null,t._validLights=void 0,t._lightIndexOffset=void 0,t._lightIndices=void 0,t._validLights=[],t._lightIndexOffset=[],t._lightIndices=[],t}return p(f,eg),l(f,[{key:"lightsUBO",get:function(){return this._lightsUBO}}]),l(f,[{key:"initialize",value:function(e){if(!this._initialize(e))return!1;if(this._name="ForwardPipeline",!this._globalBindings.get(rf.BLOCK.name)){var t=this._root.device.createBuffer({usage:zl.UNIFORM|zl.TRANSFER_DST,memUsage:Pl.HOST|Pl.DEVICE,size:rf.SIZE});if(!t)return!1;this._globalBindings.set(rf.BLOCK.name,{type:wc.UNIFORM_BUFFER,blockInfo:rf.BLOCK,buffer:t})}var i=this._root.mainWindow,n=null;return i&&(n=i.renderPass),n?(this.addRenderPass(jh.DEFAULT,n),this.createFlow(vg,{name:"ForwardFlow",priority:pg.FORWARD}),this._usePostProcess&&(this._useSMAA,this.createFlow(C_,{name:"ToneMapFlow",priority:0})),this.createFlow(og,{name:"UIFlow",priority:pg.UI}),!0):(console.error("RenderPass of main window is null."),!1)}},{key:"destroy",value:function(){var e=this._globalBindings.get(rf.BLOCK.name);e&&(e.buffer.destroy(),this._globalBindings.delete(rf.BLOCK.name)),this._destroy()}},{key:"rebuild",value:function(){_(g(f.prototype),"rebuild",this).call(this);var e=this._flows,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.rebuild()}}},{key:"updateUBOs",value:function(e){_(g(f.prototype),"updateUBOs",this).call(this,e);for(var t=e.camera.exposure,i=0;i<this._renderObjects.length;i++){this._uboLights.view.fill(0);var n=i+1<this._renderObjects.length?this._lightIndexOffset[i+1]:this._lightIndices.length;if(this._renderObjects[i].model.localBindings.get(rf.BLOCK.name)){for(var r=0,a=0,s=this._lightIndexOffset[i];s<n;s++){var o=this._validLights[this._lightIndices[s]];if(o&&o.enabled)switch(o.type){case l_.SPHERE:if(rf.MAX_SPHERE_LIGHTS<=r)continue;var l=o;if(Fi.toArray(gg,l.position),this._uboLights.view.set(gg,rf.SPHERE_LIGHT_POS_OFFSET+4*r),gg[0]=l.size,gg[1]=l.range,gg[2]=0,this._uboLights.view.set(gg,rf.SPHERE_LIGHT_SIZE_RANGE_OFFSET+4*r),Fi.toArray(gg,o.color),o.useColorTemperature){var c=o.colorTemperatureRGB;gg[0]*=c.x,gg[1]*=c.y,gg[2]*=c.z}gg[3]=l.luminance*this._lightMeterScale,this._isHDR?gg[3]=l.luminance*this._fpScale*this._lightMeterScale:gg[3]=l.luminance*t*this._lightMeterScale,this._uboLights.view.set(gg,rf.SPHERE_LIGHT_COLOR_OFFSET+4*r),r++;break;case l_.SPOT:if(rf.MAX_SPOT_LIGHTS<=a)continue;var u=o;if(Fi.toArray(gg,u.position),gg[3]=u.size,this._uboLights.view.set(gg,rf.SPOT_LIGHT_POS_OFFSET+4*a),gg[0]=u.size,gg[1]=u.range,gg[2]=u.spotAngle,this._uboLights.view.set(gg,rf.SPOT_LIGHT_SIZE_RANGE_ANGLE_OFFSET+4*a),Fi.toArray(gg,u.direction),this._uboLights.view.set(gg,rf.SPOT_LIGHT_DIR_OFFSET+4*a),Fi.toArray(gg,o.color),o.useColorTemperature){var h=o.colorTemperatureRGB;gg[0]*=h.x,gg[1]*=h.y,gg[2]*=h.z}this._isHDR?gg[3]=u.luminance*this._fpScale*this._lightMeterScale:gg[3]=u.luminance*t*this._lightMeterScale,this._uboLights.view.set(gg,rf.SPOT_LIGHT_COLOR_OFFSET+4*a),a++}}this._renderObjects[i].model.localBindings.get(rf.BLOCK.name).buffer.update(this._uboLights.view)}}}},{key:"sceneCulling",value:function(e){_(g(f.prototype),"sceneCulling",this).call(this,e),this._validLights.splice(0);var t=e.camera.scene.sphereLights,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;a.enabled&&(a.update(),ns.set(bg,a.position.x,a.position.y,a.position.z,a.range),ja.sphere_frustum(bg,e.camera.frustum)&&this._validLights.push(a))}var s=e.camera.scene.spotLights,o=Array.isArray(s),l=0;for(s=o?s:s[Symbol.iterator]();;){var c;if(o){if(l>=s.length)break;c=s[l++]}else{if((l=s.next()).done)break;c=l.value}var u=c;u.enabled&&(u.update(),ns.set(bg,u.position.x,u.position.y,u.position.z,u.range),ja.sphere_frustum(bg,e.camera.frustum)&&this._validLights.push(u))}this._lightIndexOffset.splice(0),this._lightIndices.splice(0);for(var h=0;h<this._renderObjects.length;h++)this._lightIndexOffset[h]=this._lightIndices.length,this._renderObjects[h].model.localBindings.get(rf.BLOCK.name)&&this.cullLightPerModel(this._renderObjects[h].model)}},{key:"cullLightPerModel",value:function(e){var t,i,n,r,a;xg.splice(0);for(var s=0;s<this._validLights.length;s++){var o=!1;switch(this._validLights[s].type){case l_.DIRECTIONAL:this._validLights[s],o=!1;break;case l_.SPHERE:r=this._validLights[s],o=!(!(a=e).worldBounds||ja.aabb_aabb(a.worldBounds,r.aabb));break;case l_.SPOT:i=this._validLights[s],o=!(!(n=e).worldBounds||ja.aabb_aabb(n.worldBounds,i.aabb)&&ja.aabb_frustum(n.worldBounds,i.frustum))}o||(xg.push(s),this._validLights[s].type===l_.DIRECTIONAL?Sg[s]=0:Sg[s]=Fi.distance(this._validLights[s].position,e.node.getWorldPosition(wg)))}xg.sort(this.sortLight),(t=this._lightIndices).push.apply(t,xg)}},{key:"sortLight",value:function(e,t){return Sg[e]-Sg[t]}}]),f}();(yg=mg=mg||{})[yg.GENERAL=100]="GENERAL";var Eg=function(){function i(e,t){y(this,i),this._root=void 0,this._name="",this._window=null,this._priority=0,this._visibility=lf,this._camera=void 0,this._isEnable=!0,this._flows=[],this._root=e,this._camera=t}return l(i,[{key:"name",get:function(){return this._name}},{key:"window",get:function(){return this._window},set:function(e){this._window=e}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"visibility",set:function(e){this._visibility=e},get:function(){return this._visibility}},{key:"camera",get:function(){return this._camera}},{key:"isEnable",get:function(){return this._isEnable}},{key:"flows",get:function(){return this._flows}}],[{key:"registerCreateFunc",value:function(e){e._createViewFun=function(e,t){return new i(e,t)}}}]),l(i,[{key:"initialize",value:function(e){this._name=e.name,this.priority=e.priority,e.flows||(e.flows=["ForwardFlow","ToneMapFlow","SMAAFlow"]);var t=cc.director.root.pipeline.flows,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;-1!==e.flows.indexOf(a.name)&&this.flows.push(a)}return!0}},{key:"destroy",value:function(){this._window=null,this._priority=0}},{key:"enable",value:function(e){this._isEnable=e}}]),i}(),Cg=new Fi(0,0,-1),Ag=new Fi,kg=new hn,Rg=function(){function r(e,t,i){var n;return y(this,r),(n=x(this,g(r).call(this,e,t,i)))._dir=new Fi(1,-1,-1),n._illum=65e3,n._type=l_.DIRECTIONAL,n}return p(r,f_),l(r,[{key:"direction",set:function(e){this._dir=e,Fi.normalize(this._dir,this._dir)},get:function(){return this._dir}},{key:"illuminance",set:function(e){this._illum=e},get:function(){return this._illum}}]),l(r,[{key:"update",value:function(){this._node&&(this._dir=Fi.transformQuat(Ag,Cg,this._node.getWorldRotation(kg)),Fi.normalize(this._dir,this._dir))}}]),r}(),Og=new Fi(0,0,-1),Mg=new Fi,Ig=new hn,Lg=function(){function n(e){y(this,n),this._scene=void 0,this._enabled=!1,this._normal=new Fi(0,1,0),this._distance=0,this._matLight=new zn,this._data=Float32Array.from([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,.3]),this._globalBindings=void 0,this._cmdBuffs=void 0,this._cmdBuffCount=0,this._psoRecord=new Map,this._cbRecord=new Map,this._passNormal=void 0,this._passSkinning=void 0,this._scene=e,this._globalBindings=e.root.pipeline.globalBindings.get($h.BLOCK.name),this._cmdBuffs=new tg(64);var t=lp.get("pipeline/planar-shadow"),i={CC_USE_SKINNING:od(e.root.device)};this._passNormal=Vd.createPasses(t,{techIdx:0,defines:[],states:[]})[0],this._passSkinning=Vd.createPasses(t,{techIdx:0,defines:[i],states:[]})[0]}return l(n,[{key:"enabled",set:function(e){this._enabled=e,this.updateDirLight(),this._cmdBuffs.clear()},get:function(){return this._enabled}},{key:"normal",set:function(e){Fi.copy(this._normal,e),this.updateDirLight()},get:function(){return this._normal}},{key:"distance",set:function(e){this._distance=e,this.updateDirLight()},get:function(){return this._distance}},{key:"shadowColor",set:function(e){rr.toArray(this._data,e,$h.SHADOW_COLOR_OFFSET),this._globalBindings.buffer.update(this.data)}},{key:"matLight",get:function(){return this._matLight}},{key:"data",get:function(){return this._data}},{key:"cmdBuffs",get:function(){return this._cmdBuffs}},{key:"cmdBuffCount",get:function(){return this._cmdBuffs.length}}]),l(n,[{key:"updateSphereLight",value:function(e){e.node.getWorldPosition(Mg);var t=this._normal,i=this._distance,n=Fi.dot(t,Mg),r=Mg.x,a=Mg.y,s=Mg.z,o=t.x,l=t.y,c=t.z,u=this._matLight;u.m00=n-i-r*o,u.m01=-a*o,u.m02=-s*o,u.m03=-o,u.m04=-r*l,u.m05=n-i-a*l,u.m06=-s*l,u.m07=-l,u.m08=-r*c,u.m09=-a*c,u.m10=n-i-s*c,u.m11=-c,u.m12=r*i,u.m13=a*i,u.m14=s*i,u.m15=n,zn.toArray(this.data,this._matLight),this._globalBindings.buffer.update(this.data)}},{key:"updateDirLight",value:function(e){(0<arguments.length&&void 0!==e?e:this._scene.mainLight).node.getWorldRotation(Ig),Fi.transformQuat(Mg,Og,Ig);var t=this._normal,i=this._distance,n=1/Fi.dot(t,Mg),r=Mg.x*n,a=Mg.y*n,s=Mg.z*n,o=t.x,l=t.y,c=t.z,u=this._matLight;u.m00=1-o*r,u.m01=-o*a,u.m02=-o*s,u.m03=0,u.m04=-l*r,u.m05=1-l*a,u.m06=-l*s,u.m07=0,u.m08=-c*r,u.m09=-c*a,u.m10=1-c*s,u.m11=0,u.m12=r*i,u.m13=a*i,u.m14=s*i,u.m15=1,zn.toArray(this.data,this._matLight,$h.MAT_LIGHT_PLANE_PROJ_OFFSET),this._globalBindings.buffer.update(this.data)}},{key:"updateCommandBuffers",value:function(){if(this._cmdBuffs.clear(),this._scene.mainLight.enabled){var e=this._scene.models,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;if(r.enabled&&r.node&&r.castShadow){var a=this._psoRecord.get(r);a||(a=this._createPSO(r),this._psoRecord.set(r,a)),r.UBOUpdated||r.updateUBOs();for(var s=0;s<r.subModelNum;s++){var o=r.getSubModel(s).inputAssembler;if(o){var l=this._cbRecord.get(o);l||((l=this._createCommandBuffer()).begin(),l.bindPipelineState(a),l.bindBindingLayout(a.pipelineLayout.layouts[0]),l.bindInputAssembler(o),l.draw(o),l.end(),this._cbRecord.set(o,l)),this.cmdBuffs.push(l)}}}}}}},{key:"onPipelineChange",value:function(){for(var e=this._cbRecord.values(),t=e.next();!t.done;)t.value.destroy(),t=e.next();this._cbRecord.clear();for(var i=this._psoRecord.keys(),n=i.next();!n.done;){(n.value instanceof Sf?this._passSkinning:this._passNormal).destroyPipelineState(this._psoRecord.get(n.value)),n=i.next()}this._psoRecord.clear()}},{key:"destroy",value:function(){this.onPipelineChange(),this._passNormal.destroy(),this._passSkinning.destroy()}},{key:"_createPSO",value:function(e){var t=e instanceof Sf?this._passSkinning:this._passNormal,i=e._doCreatePSO(t);return i.pipelineLayout.layouts[0].update(),i}},{key:"_createCommandBuffer",value:function(){var e=this._scene.root.device;return e.createCommandBuffer({allocator:e.commandAllocator,type:Ec.SECONDARY})}}]),n}();function zg(e){return void 0===(e=e||{}).includeNormal&&(e.includeNormal=!0),void 0===e.includeUV&&(e.includeUV=!0),e}function Bg(e){var t=(e=e||{}).widthSegments||1,i=e.heightSegments||1,n=e.lengthSegments||1,r=(e.width||1)/2,a=(e.height||1)/2,s=(e.length||1)/2,_=[Fi.set(Ug,-r,-a,s),Fi.set(Vg,r,-a,s),Fi.set(Gg,r,a,s),Fi.set(Hg,-r,a,s),Fi.set(qg,r,-a,-s),Fi.set(jg,-r,-a,-s),Fi.set(Wg,-r,a,-s),Fi.set(Xg,r,a,-s)],v=[[2,3,1],[4,5,7],[7,6,2],[1,0,4],[1,4,2],[5,0,6]],m=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],y=[],g=[],b=[],x=[],o=new Fi(-r,-a,-s),l=new Fi(r,a,s),c=Math.sqrt(r*r+a*a+s*s);function u(e,t,i){var n,r,a,s,o=y.length/3,l=v[e],c=m[e];for(s=0;s<=i;s++)for(a=0;a<=t;a++)if(n=a/t,r=s/i,Fi.lerp(Pg,_[l[0]],_[l[1]],n),Fi.lerp(Dg,_[l[0]],_[l[2]],r),Fi.subtract(Fg,Dg,_[l[0]]),Fi.add(Ng,Pg,Fg),y.push(Ng.x,Ng.y,Ng.z),g.push(c[0],c[1],c[2]),b.push(n,r),a<t&&s<i){var u=t+1,h=a+s*u,f=a+(s+1)*u,d=a+1+(s+1)*u,p=a+1+s*u;x.push(o+h,o+p,o+f),x.push(o+f,o+p,o+d)}}return u(0,t,i),u(4,n,i),u(1,t,i),u(5,n,i),u(3,t,n),u(2,t,n),{positions:y,normals:g,uvs:b,indices:x,minPos:o,maxPos:l,boundingRadius:c}}var Pg=new Fi,Dg=new Fi,Fg=new Fi,Ng=new Fi,Ug=new Fi,Vg=new Fi,Gg=new Fi,Hg=new Fi,qg=new Fi,jg=new Fi,Wg=new Fi,Xg=new Fi,Yg=new Fi(0,0,0),Qg=new Fi(0,0,0);function Kg(){var y=0<arguments.length&&void 0!==arguments[0]?arguments[0]:.5,g=1<arguments.length&&void 0!==arguments[1]?arguments[1]:.5,b=2<arguments.length&&void 0!==arguments[2]?arguments[2]:2,e=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{},x=.5*b,S=e.radialSegments||32,w=e.heightSegments||1,t=void 0===e.capped||e.capped,T=e.arc||2*Math.PI,i=0;t||(0<y&&i++,0<g&&i++);var n=(S+1)*(w+1);t&&(n+=(S+1)*i+S*i);var r=S*w*2*3;t&&(r+=S*i*3);var E=new Array(r),C=new Array(3*n),A=new Array(3*n),k=new Array(2*n),a=Math.max(y,g),s=new Fi(-a,-x,-a),o=new Fi(a,x,a),l=Math.sqrt(a*a+x*x),R=0,O=0;return function(){for(var e=[],t=y-g,i=t*t/b*Math.sign(t),n=0;n<=w;n++){for(var r=[],a=n/w,s=a*t+g,o=0;o<=S;++o){var l=o/S,c=l*T,u=Math.sin(c),h=Math.cos(c);C[3*R]=s*u,C[3*R+1]=a*b-x,C[3*R+2]=s*h,Fi.normalize(Yg,Fi.set(Qg,u,-i,h)),A[3*R]=Yg.x,A[3*R+1]=Yg.y,A[3*R+2]=Yg.z,k[2*R]=2*(1-l)%1,k[2*R+1]=a,r.push(R),++R}e.push(r)}for(var f=0;f<w;++f)for(var d=0;d<S;++d){var p=e[f][d],_=e[f+1][d],v=e[f+1][d+1],m=e[f][d+1];E[O]=p,E[++O]=m,E[++O]=_,E[++O]=m,E[++O]=v,E[++O]=_,++O}}(),t&&(0<g&&c(!1),0<y&&c(!0)),{positions:C,normals:A,uvs:k,indices:E,minPos:s,maxPos:o,boundingRadius:l};function c(e){for(var t=e?y:g,i=e?1:-1,n=R,r=1;r<=S;++r)C[3*R]=0,C[3*R+1]=x*i,C[3*R+2]=0,A[3*R]=0,A[3*R+1]=i,A[3*R+2]=0,k[2*R]=.5,k[2*R+1]=.5,++R;for(var a=R,s=0;s<=S;++s){var o=s/S*T,l=Math.cos(o),c=Math.sin(o);C[3*R]=t*c,C[3*R+1]=x*i,C[3*R+2]=t*l,A[3*R]=0,A[3*R+1]=i,A[3*R+2]=0,k[2*R]=.5-.5*c*i,k[2*R+1]=.5+.5*l,++R}for(var u=0;u<S;++u){var h=n+u,f=a+u;e?(E[O]=f+1,E[++O]=h):(E[O]=h,E[++O]=f+1),E[++O]=f,++O}}}var Zg=new Fi(0,0,0),Jg=new Fi(0,0,0),$g=new Fi(0,0,0),eb=new Fi(0,0,0),tb=new Fi(0,0,0),ib=new Fi(0,0,0),nb=new Fi(0,0,0);var rb=new Fi(0,0,0),ab=new Fi(0,0,0);var sb=Object.freeze({box:Bg,cone:function(){return Kg(0,0<arguments.length&&void 0!==arguments[0]?arguments[0]:.5,1<arguments.length&&void 0!==arguments[1]?arguments[1]:1,2<arguments.length&&void 0!==arguments[2]?arguments[2]:{})},cylinder:Kg,plane:function(e){var t=function(e){return(e=zg(e)).width=e.width||10,e.length=e.length||10,e.widthSegments=e.widthSegments||10,e.lengthSegments=e.lengthSegments||10,e}(e),i=t.width,n=t.length,r=t.widthSegments,a=t.lengthSegments,s=.5*i,o=.5*n,l=[],c=[],u=[],h=new Fi(-s,0,-o),f=new Fi(s,0,o),d=Math.sqrt(i*i+n*n);Fi.set(tb,-s,0,o),Fi.set(ib,s,0,o),Fi.set(nb,-s,0,-o);for(var p=0;p<=a;p++)for(var _=0;_<=r;_++){var v=_/r,m=p/a;if(Fi.lerp(Zg,tb,ib,v),Fi.lerp(Jg,tb,nb,m),Fi.subtract($g,Jg,tb),Fi.add(eb,Zg,$g),l.push(eb.x,eb.y,eb.z),t.includeUV&&c.push(v,m),_<r&&p<a){var y=r+1,g=_+p*y,b=_+(p+1)*y,x=_+1+(p+1)*y,S=_+1+p*y;u.push(g,S,b),u.push(S,x,b)}}var w={positions:l,indices:u,minPos:h,maxPos:f,boundingRadius:d};if(t.includeNormal){var T=(a+1)*(r+1),E=new Array(3*T);w.normals=E;for(var C=0;C<T;++C)E[3*C+0]=0,E[3*C+1]=1,E[3*C+2]=0}return t.includeUV&&(w.uvs=c),w},quad:function(e){var t=zg(e),i={positions:[-.5,-.5,0,-.5,.5,0,.5,.5,0,.5,-.5,0],indices:[0,3,1,3,2,1],minPos:{x:-.5,y:-.5,z:0},maxPos:{x:.5,y:.5,z:0},boundingRadius:Math.sqrt(.5)};return!1!==t.includeNormal&&(i.normals=[0,0,1,0,0,1,0,0,1,0,0,1]),!1!==t.includeUV&&(i.uvs=[0,0,0,1,1,1,1,0]),i},sphere:function(){for(var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:.5,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},i=void 0!==t.segments?t.segments:32,n=[],r=[],a=[],s=[],o=new Fi(-e,-e,-e),l=new Fi(e,e,e),c=e,u=0;u<=i;++u)for(var h=u*Math.PI/i,f=Math.sin(h),d=-Math.cos(h),p=0;p<=i;++p){var _=2*p*Math.PI/i-Math.PI/2,v=Math.sin(_)*f,m=d,y=Math.cos(_)*f,g=p/i,b=u/i;if(n.push(v*e,m*e,y*e),r.push(v,m,y),a.push(g,b),u<i&&p<i){var x=i+1,S=x*u+p,w=x*(u+1)+p,T=x*(u+1)+p+1,E=x*u+p+1;s.push(S,E,w),s.push(E,T,w)}}return{positions:n,indices:s,normals:r,uvs:a,minPos:o,maxPos:l,boundingRadius:c}},torus:function(){for(var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:.4,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:.1,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},n=i.radialSegments||32,r=i.tubularSegments||32,a=i.arc||2*Math.PI,s=[],o=[],l=[],c=[],u=new Fi(-e-t,-t,-e-t),h=new Fi(e+t,t,e+t),f=e+t,d=0;d<=n;d++)for(var p=0;p<=r;p++){var _=p/r,v=d/n,m=_*a,y=v*Math.PI*2,g=(e+t*Math.cos(y))*Math.sin(m),b=t*Math.sin(y),x=(e+t*Math.cos(y))*Math.cos(m),S=Math.sin(m)*Math.cos(y),w=Math.sin(y),T=Math.cos(m)*Math.cos(y);if(s.push(g,b,x),o.push(S,w,T),l.push(_,v),p<r&&d<n){var E=r+1,C=E*d+p,A=E*(d+1)+p,k=E*(d+1)+p+1,R=E*d+p+1;c.push(C,R,A),c.push(R,k,A)}}return{positions:s,normals:o,uvs:l,indices:c,minPos:u,maxPos:h,boundingRadius:f}},capsule:function(){var y=0<arguments.length&&void 0!==arguments[0]?arguments[0]:.5,g=1<arguments.length&&void 0!==arguments[1]?arguments[1]:.5,e=2<arguments.length&&void 0!==arguments[2]?arguments[2]:2,t=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{},m=e-y-g,b=t.sides||32,x=t.heightSegments||32,S=g/e,w=m/e,T=y/e,E=Math.floor(x*S),C=Math.floor(x*T),A=Math.floor(x*w),k=m+g-e/2,R=g-e/2,O=g-e/2,M=t.arc||2*Math.PI,I=[],L=[],z=[],B=[],i=Math.max(y,g),n=new Fi(-i,-e/2,-i),r=new Fi(i,e/2,i),a=e/2,P=0,D=[];return function(){for(var e=0;e<=E;++e)for(var t=e*Math.PI/E/2,i=Math.sin(t),n=-Math.cos(t),r=0;r<=b;++r){var a=2*r*Math.PI/b-Math.PI/2,s=Math.sin(a),o=Math.cos(a),l=s*i,c=n,u=o*i,h=r/b,f=e/x;if(I.push(l*g,c*g+O,u*g),L.push(l,c,u),z.push(h,f),e<E&&r<b){var d=b+1,p=d*e+r,_=d*(e+1)+r,v=d*(e+1)+r+1,m=d*e+r+1;B.push(p,m,_),B.push(m,v,_)}++P}}(),function(){for(var e=(y-g)/m,t=0;t<=A;t++){for(var i=[],n=t/A,r=n*(y-g)+g,a=0;a<=b;++a){var s=a/b,o=n*w+S,l=s*M-M/4,c=Math.sin(l),u=Math.cos(l);I.push(r*c),I.push(n*m+R),I.push(r*u),Fi.normalize(rb,Fi.set(ab,c,-e,u)),L.push(rb.x),L.push(rb.y),L.push(rb.z),z.push(s,o),i.push(P),++P}D.push(i)}for(var h=0;h<A;++h)for(var f=0;f<b;++f){var d=D[h][f],p=D[h+1][f],_=D[h+1][f+1],v=D[h][f+1];B.push(d),B.push(v),B.push(p),B.push(v),B.push(_),B.push(p)}}(),function(){for(var e=0;e<=C;++e)for(var t=e*Math.PI/C/2+Math.PI/2,i=Math.sin(t),n=-Math.cos(t),r=0;r<=b;++r){var a=2*r*Math.PI/b-Math.PI/2,s=Math.sin(a),o=Math.cos(a),l=s*i,c=n,u=o*i,h=r/b,f=e/x+(1-T);if(I.push(l*y,c*y+k,u*y),L.push(l,c,u),z.push(h,f),e<C&&r<b){var d=b+1,p=d*e+r+D[A][b]+1,_=d*(e+1)+r+D[A][b]+1,v=d*(e+1)+r+1+D[A][b]+1,m=d*e+r+1+D[A][b]+1;B.push(p,m,_),B.push(m,v,_)}}}(),{positions:I,normals:L,uvs:z,indices:B,minPos:n,maxPos:r,boundingRadius:a}},circle:function(e){var t=function(e){return(e=zg(e)).segments=64,e}(e).segments,i=new Array(3*(t+1));i[0]=0,i[1]=0,i[2]=0;var n=new Array(1+2*t);n[0]=0;for(var r=2*Math.PI/t,a=0;a<t;++a){var s=r*a,o=Math.cos(s),l=Math.sin(s),c=3*(a+1);i[0+c]=o,i[1+c]=l,i[2+c]=0;var u=2*a;n[1+u]=a+1,n[1+u+1]=a+2}return 0<t&&(n[n.length-1]=1),{positions:i,indices:n,minPos:{x:1,y:1,z:0},maxPos:{x:-1,y:-1,z:0},boundingRadius:1,primitiveMode:Gl.TRIANGLE_FAN}},translate:function(e,t){for(var i=t.x||0,n=t.y||0,r=t.z||0,a=Math.floor(e.positions.length/3),s=0;s<a;++s){var o=3*s,l=3*s+1,c=3*s+2;e.positions[o]=e.positions[o]+i,e.positions[l]=e.positions[l]+n,e.positions[c]=e.positions[c]+r}return e.minPos&&(e.minPos.x+=i,e.minPos.y+=n,e.minPos.z+=r),e.maxPos&&(e.maxPos.x+=i,e.maxPos.y+=n,e.maxPos.z+=r),e},scale:function(e,t){for(var i=t.x||0,n=t.y||0,r=t.z||0,a=Math.floor(e.positions.length/3),s=0;s<a;++s){var o=3*s,l=3*s+1,c=3*s+2;e.positions[o]*=i,e.positions[l]*=n,e.positions[c]*=r}return e.minPos&&(e.minPos.x*=i,e.minPos.y*=n,e.minPos.z*=r),e.maxPos&&(e.maxPos.x*=i,e.maxPos.y*=n,e.maxPos.z*=r),e.boundingRadius=Math.max(Math.max(i,n),r),e},wireframed:function(e){var t=e.indices;if(!t)return e;if(e.primitiveMode&&e.primitiveMode!==Gl.TRIANGLE_LIST)return e;for(var i=[[0,1],[1,2],[2,0]],n=[],r={},a=0;a<t.length;a+=3)for(var s=0;s<3;++s){var o=t[a+i[s][0]],l=t[a+i[s][1]],c=l<o?l<<16|o:o<<16|l;void 0===r[c]&&(r[c]=0,n.push(o,l))}return e.indices=n,e.primitiveMode=Gl.LINE_LIST,e},wireframe:function(e){for(var t=[[0,1],[1,2],[2,0]],i=[],n={},r=0;r<e.length;r+=3)for(var a=0;a<3;++a){var s=e[r+t[a][0]],o=e[r+t[a][1]],l=o<s?o<<16|s:s<<16|o;void 0===n[l]&&(n[l]=0,i.push(s,o))}return i},invWinding:function(e){for(var t=[],i=0;i<e.length;i+=3)t.push(e[i],e[i+2],e[i+1]);return t},toWavefrontOBJ:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:1;if(!e.indices||!e.uvs||!e.normals||void 0!==e.primitiveMode&&e.primitiveMode!==Gl.TRIANGLE_LIST)return"";for(var i=e.positions,n=e.uvs,r=e.normals,a=e.indices,s=function(e){return"".concat(a[e]+1,"/").concat(a[e]+1,"/").concat(a[e]+1)},o="",l=0;l<i.length;l+=3)o+="v ".concat(i[l]*t," ").concat(i[l+1]*t," ").concat(i[l+2]*t,"\n");for(var c=0;c<n.length;c+=2)o+="vt ".concat(n[c]," ").concat(n[c+1],"\n");for(var u=0;u<r.length;u+=3)o+="vn ".concat(r[u]," ").concat(r[u+1]," ").concat(r[u+2],"\n");for(var h=0;h<a.length;h+=3)o+="f ".concat(s(h)," ").concat(s(h+1)," ").concat(s(h+2),"\n");return o},normals:function(e,t){for(var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1,n=new Array(2*e.length),r=0;r<e.length/3;++r){var a=3*r,s=6*r;n[0+s]=e[0+a],n[1+s]=e[1+a],n[2+s]=e[2+a],n[3+s]=e[0+a]+t[0+a]*i,n[4+s]=e[1+a]+t[1+a]*i,n[5+s]=e[2+a]+t[2+a]*i}return n},applyDefaultGeometryOptions:zg});P2("primitives",sb);var ob,lb,cb=function(){function n(e){var t;y(this,n),(t=x(this,g(n).call(this,e,null)))._default=kd.get("default-cube-texture"),t._envmap=t._default,t._isRGBE=!1,t._useIBL=!1,t._material=new cp,t._globalBinding=void 0,t._scene=e,t._material.initialize({effectName:"pipeline/skybox",defines:{USE_RGBE_CUBEMAP:t._isRGBE}}),t._globalBinding=t._scene.root.pipeline.globalBindings.get(tf.name);var i=Ef(Bg({width:2,height:2,length:2})).renderingMesh.getSubmesh(0);return t.initSubModel(0,i,t._material),t}return p(n,vf),l(n,[{key:"useIBL",set:function(e){this._useIBL=e;var t=this._scene.root.pipeline;!!t.macros.CC_USE_IBL!==e&&(t.macros.CC_USE_IBL=e,this._scene.onPipelineChange(),this._updateGlobalBinding())},get:function(){return this._useIBL}},{key:"envmap",set:function(e){var t=e||this._default;this._envmap=t,this._updateGlobalBinding()},get:function(){return this._envmap}},{key:"isRGBE",set:function(e){e!==this._isRGBE&&(this._isRGBE=e,this._material.recompileShaders({USE_RGBE_CUBEMAP:this._isRGBE}),this.setSubModelMaterial(0,this._material),this._updateGlobalBinding())},get:function(){return this._isRGBE}}]),l(n,[{key:"_updateGlobalBinding",value:function(){var e=this._envmap.getGFXTextureView(),t=nh.getSampler(this._device,this._envmap.getSamplerHash());this._globalBinding.sampler=t,this._globalBinding.textureView=e;var i=this._material;i.passes[0].bindSampler(tf.binding,t),i.passes[0].bindTextureView(tf.binding,e);var n=this._matPSORecord.get(i),r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}s.pipelineLayout.layouts[0].update()}}}]),n}(),ub=function(){function r(e,t,i){var n;return y(this,r),(n=x(this,g(r).call(this,e,t,i)))._size=.15,n._range=1,n._luminance=1700/h_(n._size),n._pos=void 0,n._aabb=void 0,n._type=l_.SPHERE,n._aabb=cs.create(),n._pos=new Fi,n}return p(r,f_),l(r,[{key:"position",get:function(){return this._pos}},{key:"size",set:function(e){this._size=e},get:function(){return this._size}},{key:"range",set:function(e){this._range=e},get:function(){return this._range}},{key:"luminance",set:function(e){this._luminance=e},get:function(){return this._luminance}},{key:"aabb",get:function(){return this._aabb}}]),l(r,[{key:"update",value:function(){this._node&&(this._node.getWorldPosition(this._pos),cs.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range))}}]),r}(),hb=new Fi(0,0,-1),fb=new Fi,db=new hn,pb=new zn,_b=new zn,vb=new zn,mb=new zn,yb=function(){function r(e,t,i){var n;return y(this,r),(n=x(this,g(r).call(this,e,t,i)))._dir=new Fi(1,-1,-1),n._size=.15,n._range=5,n._luminance=1700/h_(n._size),n._spotAngle=Math.cos(Math.PI/6),n._pos=void 0,n._aabb=void 0,n._frustum=void 0,n._angle=0,n._type=l_.SPOT,n._aabb=cs.create(),n._frustum=vs.create(),n._pos=new Fi,n}return p(r,f_),l(r,[{key:"position",get:function(){return this._pos}},{key:"size",set:function(e){this._size=e},get:function(){return this._size}},{key:"range",set:function(e){this._range=e},get:function(){return this._range}},{key:"luminance",set:function(e){this._luminance=e},get:function(){return this._luminance}},{key:"direction",get:function(){return this._dir}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._angle=.5*e,this._spotAngle=Math.cos(.5*e)}},{key:"aabb",get:function(){return this._aabb}},{key:"frustum",get:function(){return this._frustum}}]),l(r,[{key:"update",value:function(){this._node&&(this._node.getWorldPosition(this._pos),this._dir=Fi.transformQuat(fb,hb,this._node.getWorldRotation(db)),Fi.normalize(this._dir,this._dir),cs.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT(pb),zn.invert(pb,pb),zn.perspective(_b,this._angle,1,.001,this._range),zn.multiply(vb,_b,pb),zn.invert(mb,vb),this._frustum.update(vb,mb))}}]),r}(),gb=function(){function t(e){y(this,t),this._root=void 0,this._name="",this._cameras=[],this._ambient=void 0,this._skybox=void 0,this._planarShadows=void 0,this._mainLight=void 0,this._defaultMainLightNode=void 0,this._sphereLights=[],this._spotLights=[],this._models=[],this._modelId=0,this._texturePool=void 0,this._root=e,this._ambient=new uy(this),this._defaultMainLightNode=new Sm("Main Light"),this._mainLight=new Rg(this,"Main Light",this._defaultMainLightNode),this._mainLight.illuminance=uy.SUN_ILLUM,this._mainLight.enabled=!1,this._ambient=new uy(this),this._skybox=new cb(this),this._planarShadows=new Lg(this),this._texturePool=new Ed(e.device)}return l(t,[{key:"root",get:function(){return this._root}},{key:"name",get:function(){return this._name}},{key:"cameras",get:function(){return this._cameras}},{key:"ambient",get:function(){return this._ambient}},{key:"skybox",get:function(){return this._skybox}},{key:"planarShadows",get:function(){return this._planarShadows}},{key:"defaultMainLightNode",get:function(){return this._defaultMainLightNode}},{key:"mainLight",get:function(){return this._mainLight}},{key:"sphereLights",get:function(){return this._sphereLights}},{key:"spotLights",get:function(){return this._spotLights}},{key:"models",get:function(){return this._models}},{key:"texturePool",get:function(){return this._texturePool}}],[{key:"registerCreateFunc",value:function(e){e._createSceneFun=function(e){return new t(e)}}}]),l(t,[{key:"initialize",value:function(e){return this._name=e.name,this._texturePool.initialize(),!0}},{key:"destroy",value:function(){this.destroyCameras(),this.destroyPointLights(),this.destroySpotLights(),this.destroyModels(),this._planarShadows.destroy(),this._texturePool.destroy()}},{key:"createCamera",value:function(e){var t=new B_(this,e);return this._cameras.push(t),t}},{key:"destroyCamera",value:function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return e.destroy(),void this._cameras.splice(t,1)}},{key:"destroyCameras",value:function(){var e=this._cameras,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._cameras.splice(0)}},{key:"createSphereLight",value:function(e,t){var i=new ub(this,e,t);return this._sphereLights.push(i),i}},{key:"destroySphereLight",value:function(e){for(var t=0;t<this._sphereLights.length;++t)if(this._sphereLights[t]===e)return void this._sphereLights.splice(t,1)}},{key:"createSpotLight",value:function(e,t){var i=new yb(this,e,t);return this._spotLights.push(i),i}},{key:"destroySpotLight",value:function(e){for(var t=0;t<this._spotLights.length;++t)if(this._spotLights[t]===e)return void this._spotLights.splice(t,1)}},{key:"destroyPointLights",value:function(){this._sphereLights=[]}},{key:"destroySpotLights",value:function(){this._spotLights=[]}},{key:"createModel",value:function(e,t){var i=new e(this,t);return this._models.push(i),i}},{key:"destroyModel",value:function(e){for(var t=0;t<this._models.length;++t)if(this._models[t]===e)return void this._models.splice(t,1)[0].destroy()}},{key:"destroyModels",value:function(){var e=this._models,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._models=[]}},{key:"onPipelineChange",value:function(){var e=this._models,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.onPipelineChange()}this._skybox.onPipelineChange(),this._planarShadows.onPipelineChange()}},{key:"generateModelId",value:function(){return this._modelId++}},{key:"raycastModels",value:function(e,t,i){var n=1<arguments.length&&void 0!==t?t:qh.Enum.DEFAULT,r=2<arguments.length&&void 0!==i?i:1/0;Eb.reset();var a=this._models,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}var c=l,u=c.transform;if(u&&c.enabled&&!(c.node.layer&qh.Enum.IGNORE_RAYCAST)&&c.node.layer&n&&c.modelBounds){zn.invert(Sb,u.getWorldMatrix(Sb)),Fi.transformMat4(bb.o,e.o,Sb),Fi.normalize(bb.d,Fi.transformMat4Normal(bb.d,e.d,Sb));var h=ja.ray_aabb(bb,c.modelBounds);if(!(h<=0||r<h))for(var f=0;f<c.subModelNum;++f){var d=c.getSubModel(f).subMeshData;if(d&&d.geometricInfo){var p=d.geometricInfo,_=p.positions,v=p.indices,m=p.doubleSided;Ob(_,v,d.primitiveMode,m,r)}if(wb<r){var y=Eb.add();y.node=c.node,y.distance=wb*Fi.multiply(xb,bb.d,u.worldScale).length(),Cb[Eb.length-1]=y}}}}return Cb.length=Eb.length,Cb}},{key:"raycastModel",value:function(e,t,i,n){var r=2<arguments.length&&void 0!==i?i:qh.Enum.DEFAULT,a=3<arguments.length&&void 0!==n?n:1/0;Eb.reset(),Cb.length=0;var s=t,o=s.transform;if(!o||!s.enabled||s.node.layer&qh.Enum.IGNORE_RAYCAST||!(s.node.layer&r)||!s.modelBounds)return Cb;zn.invert(Sb,o.getWorldMatrix(Sb)),Fi.transformMat4(bb.o,e.o,Sb),Fi.normalize(bb.d,Fi.transformMat4Normal(bb.d,e.d,Sb));var l=ja.ray_aabb(bb,s.modelBounds);if(l<=0||a<l)return Cb;for(var c=0;c<s.subModelNum;++c){var u=s.getSubModel(c).subMeshData;if(u&&u.geometricInfo){var h=u.geometricInfo,f=h.positions,d=h.indices,p=h.doubleSided;Ob(f,d,u.primitiveMode,p,a)}if(wb<a){var _=Eb.add();_.node=s.node,_.distance=wb*Fi.multiply(xb,bb.d,o.worldScale).length(),Cb[Eb.length-1]=_}}return Cb}},{key:"raycastUI2D",value:function(e,t,i){var n=1<arguments.length&&void 0!==t?t:qh.Enum.UI_2D,r=2<arguments.length&&void 0!==i?i:1/0;kb.reset();var a=cc.director.getScene().getComponentsInChildren(cc.CanvasComponent);if(null!=a&&0<a.length)for(var s=0;s<a.length;s++){var o=a[s].node;null!=o&&o.active&&this._raycastUI2DNodeRecursiveChildren(e,o,n,r)}return Rb.length=kb.length,Rb}},{key:"raycastUI2DNode",value:function(e,t,i,n){var r=2<arguments.length&&void 0!==i?i:qh.Enum.UI_2D,a=3<arguments.length&&void 0!==n?n:1/0;var s=t.uiTransfromComp;if(!(null==s||t.layer&qh.Enum.IGNORE_RAYCAST)&&t.layer&r){s.getComputeAABB(Ab);var o=ja.ray_aabb(e,Ab);if(!(o<=0)&&o<a){var l=kb.add();return l.node=t,l.distance=o,l}}}},{key:"_raycastUI2DNodeRecursiveChildren",value:function(e,t,i,n){var r=2<arguments.length&&void 0!==i?i:qh.Enum.UI_2D,a=3<arguments.length&&void 0!==n?n:1/0,s=this.raycastUI2DNode(e,t,r,a);null!=s&&(Rb[kb.length-1]=s);var o=t.children,l=Array.isArray(o),c=0;for(o=l?o:o[Symbol.iterator]();;){var u;if(l){if(c>=o.length)break;u=o[c++]}else{if((c=o.next()).done)break;u=c.value}var h=u;null!=h&&h.active&&this._raycastUI2DNodeRecursiveChildren(e,h,r,a)}}}]),t}(),bb=Ja.create(),xb=new Fi,Sb=new zn,wb=1/0,Tb=$a.create(),Eb=new Rs(function(){return{node:null,distance:1/0}},8),Cb=[],Ab=new cs,kb=new Rs(function(){return{node:null,distance:1/0}},8),Rb=[],Ob=function(e,t,i,n,r){if(wb=4<arguments.length&&void 0!==r?r:1/0,i===Gl.TRIANGLE_LIST)for(var a=t.length,s=0;s<a;s+=3){var o=3*t[s],l=3*t[s+1],c=3*t[s+2];Fi.set(Tb.a,e[o],e[1+o],e[2+o]),Fi.set(Tb.b,e[l],e[1+l],e[2+l]),Fi.set(Tb.c,e[c],e[1+c],e[2+c]);var u=ja.ray_triangle(bb,Tb,n);u<=0||wb<u||(wb=u)}else if(i===Gl.TRIANGLE_STRIP)for(var h=t.length-2,f=0,d=0;d<h;d+=1){var p=3*t[d-f],_=3*t[d+f+1],v=3*t[d+2];Fi.set(Tb.a,e[p],e[1+p],e[2+p]),Fi.set(Tb.b,e[_],e[1+_],e[2+_]),Fi.set(Tb.c,e[v],e[1+v],e[2+v]),f=~f;var m=ja.ray_triangle(bb,Tb,n);m<=0||wb<m||(wb=m)}else if(i===Gl.TRIANGLE_FAN){var y=t.length-1,g=3*t[0];Fi.set(Tb.a,e[g],e[1+g],e[2+g]);for(var b=1;b<y;b+=1){var x=3*t[b],S=3*t[b+1];Fi.set(Tb.b,e[x],e[1+x],e[2+x]),Fi.set(Tb.c,e[S],e[1+S],e[2+S]);var w=ja.ray_triangle(bb,Tb,n);w<=0||wb<w||(wb=w)}}},Mb=P2("MeshBuffer",function(){function t(e){y(this,t),this.batcher=void 0,this.vData=null,this.iData=null,this.vb=null,this.ib=null,this.ia=null,this.byteStart=0,this.byteOffset=0,this.indiceStart=0,this.indiceOffset=0,this.vertexStart=0,this.vertexOffset=0,this.dirty=!1,this._vertexFormatBytes=9*Float32Array.BYTES_PER_ELEMENT,this._initVDataCount=256*this._vertexFormatBytes,this._initIDataCount=1536,this._outofCallback=null,this.batcher=e}return l(t,[{key:"initialize",value:function(e,t){this._outofCallback=t;var i=9*Float32Array.BYTES_PER_ELEMENT;this.vb=this.vb||this.batcher.device.createBuffer({usage:zl.VERTEX|zl.TRANSFER_DST,memUsage:Pl.HOST|Pl.DEVICE,size:0,stride:i});var n=Uint16Array.BYTES_PER_ELEMENT;this.ib=this.ib||this.batcher.device.createBuffer({usage:zl.INDEX|zl.TRANSFER_DST,memUsage:Pl.HOST|Pl.DEVICE,size:0,stride:n}),this.ia=this.ia||this.batcher.device.createInputAssembler({attributes:e,vertexBuffers:[this.vb],indexBuffer:this.ib}),this._reallocBuffer()}},{key:"request",value:function(e,t){var i=0<arguments.length&&void 0!==e?e:4,n=1<arguments.length&&void 0!==t?t:6,r=this.byteOffset+i*this._vertexFormatBytes,a=this.indiceOffset+n;if(65535<i+this.vertexOffset)return this.batcher.autoMergeBatches(),this._outofCallback&&this._outofCallback.call(this.batcher,i,n),!1;var s=this.vData.byteLength,o=this.iData.length;if(s<r||o<a){for(;s<r||o<a;)this._initVDataCount*=2,this._initIDataCount*=2,s=4*this._initVDataCount,o=this._initIDataCount;this._reallocBuffer()}return this.vertexOffset+=i,this.indiceOffset+=n,this.byteOffset=r,this.dirty=!0}},{key:"reset",value:function(){this.byteStart=0,this.byteOffset=0,this.indiceStart=0,this.indiceOffset=0,this.vertexStart=0,this.vertexOffset=0,this.dirty=!1}},{key:"destroy",value:function(){this.ib.destroy(),this.vb.destroy(),this.ia.destroy(),this.ib=null,this.vb=null,this.ia=null}},{key:"uploadData",value:function(){if(0!==this.byteOffset&&this.dirty){var e=new Float32Array(this.vData.buffer,0,this.byteOffset>>2),t=new Uint16Array(this.iData.buffer,0,this.indiceOffset);this.byteOffset>this.vb.size&&this.vb.resize(this.byteOffset),this.vb.update(e),2*this.indiceOffset>this.ib.size&&this.ib.resize(2*this.indiceOffset),this.ib.update(t)}}},{key:"_reallocBuffer",value:function(){this._reallocVData(!0),this._reallocIData(!0)}},{key:"_reallocVData",value:function(e){var t;if(this.vData&&(t=new Uint8Array(this.vData.buffer)),this.vData=new Float32Array(this._initVDataCount),t&&e)for(var i=new Uint8Array(this.vData.buffer),n=0,r=t.length;n<r;n++)i[n]=t[n]}},{key:"_reallocIData",value:function(e){var t=this.iData;if(this.iData=new Uint16Array(this._initIDataCount),t&&e)for(var i=this.iData,n=0,r=t.length;n<r;n++)i[n]=t[n]}}]),t}());(lb=ob=ob||{})[lb.DISABLED=0]="DISABLED",lb[lb.CLEAR=1]="CLEAR",lb[lb.ENTER_LEVEL=2]="ENTER_LEVEL",lb[lb.ENABLED=3]="ENABLED",lb[lb.EXIT_LEVEL=4]="EXIT_LEVEL";var Ib=P2("StencilManager",function(){function e(){y(this,e),this.stage=ob.DISABLED,this._maskStack=[],this._stencilPattern={stencilTest:!0,func:Kl.ALWAYS,stencilMask:4294967295,writeMask:4294967295,failOp:Jl.KEEP,zFailOp:Jl.KEEP,passOp:Jl.KEEP,ref:1},this._defaultPipelineState={depthStencilState:{},rasterizerState:{},blendState:{}}}return l(e,[{key:"pushMask",value:function(e){this._maskStack.push(e)}},{key:"clear",value:function(){this.stage=ob.CLEAR}},{key:"enterLevel",value:function(){this.stage=ob.ENTER_LEVEL}},{key:"enableMask",value:function(){this.stage=ob.ENABLED}},{key:"exitMask",value:function(){0!==this._maskStack.length&&(this._maskStack.pop(),0===this._maskStack.length?this.stage=ob.DISABLED:this.stage=ob.ENABLED)}},{key:"handleMaterial",value:function(e){var t=this._stencilPattern;this.stage===ob.DISABLED?(t.stencilTest=!1,t.func=Kl.ALWAYS,t.failOp=Jl.KEEP,t.stencilMask=t.writeMask=4294967295,t.ref=1):(t.stencilTest=!0,this.stage===ob.ENABLED?(t.func=Kl.EQUAL,t.failOp=Jl.KEEP,t.stencilMask=t.ref=this.getStencilRef(),t.writeMask=this.getWriteMask()):this.stage===ob.CLEAR?(t.func=Kl.NEVER,t.failOp=Jl.ZERO,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()):this.stage===ob.ENTER_LEVEL&&(t.func=Kl.NEVER,t.failOp=Jl.REPLACE,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()));var i=e.passes[0];if(this._changed(i)){var n=this._stencilPattern;return this._defaultPipelineState.depthStencilState={stencilTestFront:n.stencilTest,stencilFuncFront:n.func,stencilReadMaskFront:n.stencilMask,stencilWriteMaskFront:n.writeMask,stencilFailOpFront:n.failOp,stencilZFailOpFront:n.zFailOp,stencilPassOpFront:n.passOp,stencilRefFront:n.ref,stencilTestBack:n.stencilTest,stencilFuncBack:n.func,stencilReadMaskBack:n.stencilMask,stencilWriteMaskBack:n.writeMask,stencilFailOpBack:n.failOp,stencilZFailOpBack:n.zFailOp,stencilPassOpBack:n.passOp,stencilRefBack:n.ref},this._defaultPipelineState.blendState=i.blendState,this._defaultPipelineState.rasterizerState=i.rasterizerState,e.overridePipelineStates(this._defaultPipelineState),!0}return!1}},{key:"getWriteMask",value:function(){return 1<<this._maskStack.length-1}},{key:"getExitWriteMask",value:function(){return 1<<this._maskStack.length}},{key:"getStencilRef",value:function(){for(var e=0,t=0;t<this._maskStack.length;++t)e+=1<<t;return e}},{key:"getInvertedRef",value:function(){for(var e=0,t=0;t<this._maskStack.length-1;++t)e+=1<<t;return e}},{key:"reset",value:function(){this._maskStack.length=0,this.stage=ob.DISABLED}},{key:"_changed",value:function(e){var t=e.depthStencilState,i=this._stencilPattern;return i.stencilTest!==t.stencilTestFront||i.func!==t.stencilFuncFront||i.failOp!==t.stencilFailOpFront||i.zFailOp!==t.stencilZFailOpFront||i.passOp!==t.stencilPassOpFront||i.stencilMask!==t.stencilReadMaskFront||i.writeMask!==t.stencilWriteMaskFront||i.ref!==t.stencilRefFront}}]),e}());Ib.sharedManager=null,Ib.sharedManager=new Ib;var Lb=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e,null)))._subModel=void 0,t._subModel=new zb,t}return p(i,vf),l(i,[{key:"updateTransform",value:function(){}},{key:"updateUBOs",value:function(){return!1}},{key:"initialize",value:function(e,t){this._subModel.directInitialize(e,t.material,t.pipelineState),this._subModels[0]=this._subModel}},{key:"destroy",value:function(){this._subModel.destroy()}}]),i}(),zb=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this))).psos=[],e}return p(t,ff),l(t,[{key:"directInitialize",value:function(e,t,i){this._inputAssembler=e,this.psos[0]=i,this.material=t}},{key:"destroy",value:function(){0<this.commandBuffers.length&&this.commandBuffers[0].destroy()}}]),t}(),Bb=function(){function e(){y(this,e),this._material=null,this._pass=null,this._psos=void 0,this._refCount=0,this._psos=null}return l(e,[{key:"material",get:function(){return this._material}},{key:"pass",get:function(){return this._pass}}]),l(e,[{key:"initialize",value:function(e){var t=this;return!!e.material&&(this._material=new cp,this._material.copy(e.material),this._pass=this._material.passes[0],this._psos=new ks(function(){return t._pass.createPipelineState()},1),!0)}},{key:"increase",value:function(){return this._refCount++,this._refCount}},{key:"decrease",value:function(){return this._refCount--,0===this._refCount&&this.destroy(),this._refCount}},{key:"getPipelineState",value:function(){return this._psos.alloc()}},{key:"revertPipelineState",value:function(e){this._psos.free(e)}},{key:"destroy",value:function(){var t=this;this._psos&&this._psos.clear(function(e){t._pass.destroyPipelineState(e)}),this._material&&(this._material.destroy(),this._material=null),this._refCount=0}}]),e}(),Pb=[{name:kl.ATTR_POSITION,format:Il.RGB32F},{name:kl.ATTR_TEX_COORD,format:Il.RG32F},{name:kl.ATTR_COLOR,format:Il.RGBA32F}],Db=Object.freeze({vfmt:Pb});P2("UIVertexFormat",Db);function Fb(e,t,i,n){y(this,Fb),this.target=void 0,this.priority=void 0,this.paused=void 0,this.markedForDeletion=void 0,this.target=e,this.priority=t,this.paused=i,this.markedForDeletion=n}var Nb=function(){function e(){y(this,e),this.camera=null,this.bufferBatch=null,this.model=null,this.material=null,this.texView=null,this.firstIdx=0,this.idxCount=0,this.pipelineState=null,this.bindingLayout=null,this.useLocalData=null}return l(e,[{key:"destroy",value:function(e){this.pipelineState&&(e._getUIMaterial(this.material).revertPipelineState(this.pipelineState),this.pipelineState=null),this.bindingLayout&&(this.bindingLayout=null)}},{key:"clear",value:function(e){this.pipelineState&&(e._getUIMaterial(this.material).revertPipelineState(this.pipelineState),this.pipelineState=null),this.camera=null,this.bufferBatch=null,this.material=null,this.texView=null,this.firstIdx=0,this.idxCount=0,this.model=null}}]),e}(),Ub=function(){function i(e){var t=this;y(this,i),this._root=e,this.device=void 0,this._screens=[],this._bufferBatchPool=new Rs(function(){return new Mb(t)},128),this._drawBatchPool=new ks(function(){return new Nb},128),this._cmdBuff=null,this._scene=void 0,this._attributes=[],this._meshBuffers=[],this._meshBufferUseCount=0,this._uiMaterials=new Map,this._canvasMaterials=new Map,this._batches=void 0,this._uiModelPool=null,this._modelInUse=void 0,this._emptyMaterial=new cp,this._currMeshBuffer=null,this._currMaterial=this._emptyMaterial,this._currTexView=null,this._currCanvas=-1,this.device=e.device,this._scene=this._root.createScene({name:"GUIScene"}),this._uiModelPool=new ks(function(){var e=t._scene.createModel(Lb,null);return e.visFlags|=qh.Enum.UI_3D,e},2),this._modelInUse=new tg(10),this._batches=new tg(64),cc.director.on(cc.Director.EVENT_BEFORE_DRAW,this.update,this)}return l(i,[{key:"renderScene",get:function(){return this._scene}},{key:"currBufferBatch",get:function(){return this._currMeshBuffer}}]),l(i,[{key:"initialize",value:function(){return this._attributes=Pb,this._requireBufferBatch(),this._cmdBuff=this.device.createCommandBuffer({allocator:this.device.commandAllocator,type:Ec.PRIMARY}),!0}},{key:"destroy",value:function(){this._destroyUIMaterials();var e=this._batches.array,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy(this)}var r=this._meshBuffers,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}o.destroy()}this._meshBuffers.splice(0);for(var l=this._uiMaterials.values(),c=l.next();!c.done;){c.value.destroy(),c=l.next()}this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)}},{key:"getRenderSceneGetter",value:function(){return Object.getOwnPropertyDescriptor(Object.getPrototypeOf(this),"renderScene").get.bind(this)}},{key:"_getUIMaterial",value:function(e){if(this._uiMaterials.has(e.hash))return this._uiMaterials.get(e.hash);var t=new Bb;return t.initialize({material:e}),this._uiMaterials.set(e.hash,t),t}},{key:"_removeUIMaterial",value:function(e){this._uiMaterials.has(e)&&0===this._uiMaterials.get(e).decrease()&&this._uiMaterials.delete(e)}},{key:"addScreen",value:function(e){this._screens.push(e),e.camera&&(e.camera.view.visibility=qh.BitMask.UI_2D|this._screens.length,this._canvasMaterials.set(e.camera.view.visibility,new Map)),this._screens.sort(this._screenSort)}},{key:"getScreen",value:function(e){for(var t=this._screens,i=0;i<t.length;++i){var n=t[i];if(n.camera&&n.camera.view.visibility===e)return n}return null}},{key:"removeScreen",value:function(e){var t=this._screens.indexOf(e);if(-1!==t){if(this._screens.splice(t,1),e.camera)for(var i=this._canvasMaterials.get(e.camera.view.visibility).keys(),n=i.next();!n.done;)this._removeUIMaterial(n.value),n=i.next();for(var r,a=t;a<this._screens.length;a++)if(r=this._screens[a].camera){var s=this._canvasMaterials.get(r.view.visibility);r.view.visibility-=1,this._canvasMaterials.set(r.view.visibility,s)}}}},{key:"update",value:function(e){if(this._renderScreens(),0<this._batches.length)for(var t=this._meshBuffers,i=0;i<t.length;++i){var n=t[i];n.uploadData(),n.reset()}this.render(),this._reset()}},{key:"render",value:function(){for(var e=0,t=0;t<this._modelInUse.length;t++)this._modelInUse.get(t).enabled=!1,this._uiModelPool.free(this._modelInUse.get(t));if(this._modelInUse.clear(),this._batches.length)for(var i=0;i<this._batches.length;++i){var n=this._batches.array[i];if(n.model){if(n.camera){var r=n.camera.view.visibility;n.model.visFlags=r,n.model.node.layer=r}for(var a=0;a<n.model.subModelNum;a++)n.model.getSubModel(a).priority=e++}else{var s=n.bindingLayout;s.bindTextureView(Qh.CUSTOM_SAMPLER_BINDING_START_POINT,n.texView),s.update();var o=n.bufferBatch.ia;o.firstIndex=n.firstIdx,o.indexCount=n.idxCount;var l=this._uiModelPool.alloc();l.initialize(o,n),l.enabled=!0,l.getSubModel(0).priority=e++,n.camera&&(l.visFlags=n.camera.view.visibility,null==this._canvasMaterials.get(n.camera.view.visibility).get(n.material.hash)&&(this._uiMaterials.get(n.material.hash).increase(),this._canvasMaterials.get(n.camera.view.visibility).set(n.material.hash,1))),this._modelInUse.push(l)}}}},{key:"commitComp",value:function(e,t,i){var n=2<arguments.length?i:void 0,r=e,a=1<arguments.length&&void 0!==t?t:null;this._currMaterial.hash===r.material.hash&&this._currTexView===a&&this._currCanvas===r.visibility||(this.autoMergeBatches(),this._currMaterial=r.material,this._currTexView=a,this._currCanvas=r.visibility),n&&n.fillBuffers(r,this)}},{key:"commitModel",value:function(e,t,i){if((this._currMaterial!==this._emptyMaterial&&this.autoMergeBatches(),i)&&(Ib.sharedManager.handleMaterial(i)&&t))for(var n=0;n<t.subModelNum;n++)t.setSubModelMaterial(n,i);var r=this.getScreen(e.visibility),a=this._drawBatchPool.alloc();a.camera=r&&r.camera,a.model=t,a.bufferBatch=null,a.material=i,a.texView=null,a.firstIdx=0,a.idxCount=0,a.pipelineState=null,a.bindingLayout=null,this._currMaterial=this._emptyMaterial,this._currTexView=null,this._currCanvas=e.visibility,this._batches.push(a)}},{key:"autoMergeBatches",value:function(){var e=this._currMaterial,t=this._currMeshBuffer,i=t.indiceStart,n=t.indiceOffset-i;if(n&&e){var r=this.getScreen(this._currCanvas);Ib.sharedManager.handleMaterial(e);var a=this._drawBatchPool.alloc();a.camera=r&&r.camera,a.bufferBatch=this._currMeshBuffer,a.material=e,a.texView=this._currTexView,a.firstIdx=i,a.idxCount=n,a.pipelineState=this._getUIMaterial(e).getPipelineState(),a.bindingLayout=a.pipelineState.pipelineLayout.layouts[0],this._batches.push(a),t.vertexStart=t.vertexOffset,t.indiceStart=t.indiceOffset,t.byteStart=t.byteOffset}}},{key:"forceMergeBatches",value:function(e,t){this._currMaterial=e,this._currTexView=t,this.autoMergeBatches()}},{key:"_deleteUIMaterial",value:function(e){this._uiMaterials.has(e.hash)&&(this._uiMaterials.get(e.hash).destroy(),this._uiMaterials.delete(e.hash))}},{key:"_destroyUIMaterials",value:function(){for(var e=this._uiMaterials.values(),t=e.next();!t.done;){t.value.destroy(),t=e.next()}this._uiMaterials.clear()}},{key:"_walk",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:0,n=e.children.length;if(this._preprocess(e),0<n)for(var r=e.children,a=0;a<r.length;++a){var s=r[a];this._walk(s,i)}this._postprocess(e),i+=1}},{key:"_renderScreens",value:function(){for(var e=this._screens,t=0;t<e.length;++t){var i=e[t];i.enabledInHierarchy&&this._recursiveScreenNode(i.node)}}},{key:"_preprocess",value:function(e){var t=e._uiComp;t&&t.enabledInHierarchy&&t.updateAssembler(this)}},{key:"_postprocess",value:function(e){var t=e._uiComp;t&&t.enabledInHierarchy&&t.postUpdateAssembler(this)}},{key:"_recursiveScreenNode",value:function(e){this._walk(e),this.autoMergeBatches()}},{key:"_reset",value:function(){for(var e=0;e<this._batches.length;++e){var t=this._batches.array[e];t.clear(this),this._drawBatchPool.free(t)}this._batches.clear(),this._currMaterial=this._emptyMaterial,this._currCanvas=-1,this._currTexView=null,this._meshBufferUseCount=0,this._requireBufferBatch(),Ib.sharedManager.reset()}},{key:"_createMeshBuffer",value:function(){var e=this._bufferBatchPool.add();return e.initialize(this._attributes,this._requireBufferBatch.bind(this)),this._meshBuffers.push(e),e}},{key:"_requireBufferBatch",value:function(e,t){this._meshBufferUseCount>=this._meshBuffers.length?this._currMeshBuffer=this._createMeshBuffer():this._currMeshBuffer=this._meshBuffers[this._meshBufferUseCount],this._meshBufferUseCount++,2===arguments.length&&this._currMeshBuffer.request(e,t)}},{key:"_screenSort",value:function(e,t){return e.priority-t.priority}}]),i}(),Vb=function(){function t(e){y(this,t),this._createSceneFun=void 0,this._createViewFun=void 0,this._device=void 0,this._windows=[],this._mainWindow=null,this._curWindow=null,this._tempWindow=null,this._pipeline=null,this._ui=null,this._scenes=[],this._views=[],this._time=0,this._frameTime=0,this._fpsTime=0,this._frameCount=0,this._fps=0,this._fixedFPS=0,this._fixedFPSFrameTime=0,this._device=e,gb.registerCreateFunc(this),Eg.registerCreateFunc(this)}return l(t,[{key:"device",get:function(){return this._device}},{key:"mainWindow",get:function(){return this._mainWindow}},{key:"curWindow",set:function(e){this._curWindow=e},get:function(){return this._curWindow}},{key:"tempWindow",set:function(e){this._tempWindow=e},get:function(){return this._tempWindow}},{key:"windows",get:function(){return this._windows}},{key:"pipeline",get:function(){return this._pipeline}},{key:"ui",get:function(){return this._ui}},{key:"scenes",get:function(){return this._scenes}},{key:"views",get:function(){return this._views}},{key:"cumulativeTime",get:function(){return this._time}},{key:"frameTime",get:function(){return this._frameTime}},{key:"frameCount",get:function(){return this._frameCount}},{key:"fps",get:function(){return this._fps}},{key:"fixedFPS",set:function(e){0<e?(this._fixedFPS=e,this._fixedFPSFrameTime=1e3/e):this._fixedFPSFrameTime=0},get:function(){return this._fixedFPS}}]),l(t,[{key:"initialize",value:function(e){var i=this;return!!this._device.mainWindow&&(this._mainWindow=this._device.mainWindow,this._curWindow=this._mainWindow,kd.initBuiltinRes(this._device),this._pipeline=new Tg(this),this._pipeline.initialize(e)?(this._ui=new Ub(this),this._ui.initialize()?(cc.view.on("design-resolution-changed",function(){var e=cc.game.canvas.width,t=cc.game.canvas.height;i.resize(e,t)},this),!0):(this.destroy(),!1)):(this.destroy(),!1))}},{key:"destroy",value:function(){this.destroyViews(),this.destroyScenes(),this._pipeline&&(this._pipeline.destroy(),this._pipeline=null),this._ui&&(this._ui.destroy(),this._ui=null),this._curWindow=null,this._mainWindow=null}},{key:"resize",value:function(e,t){this._device.resize(e,t),this._mainWindow.resize(e,t);var i=this._windows,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;s.isOffscreen||s.resize(e,t)}this._pipeline&&this._pipeline.resize(e,t);var o=this._views,l=Array.isArray(o),c=0;for(o=l?o:o[Symbol.iterator]();;){var u;if(l){if(c>=o.length)break;u=o[c++]}else{if((c=o.next()).done)break;u=c.value}var h=u;h.camera.isWindowSize&&h.camera.resize(e,t)}}},{key:"activeWindow",value:function(e){this._curWindow=e}},{key:"resetCumulativeTime",value:function(){this._time=0}},{key:"frameMove",value:function(e){this._frameTime=e,++this._frameCount,this._time+=this._frameTime,this._fpsTime+=this._frameTime,1<this._fpsTime&&(this._fps=this._frameCount,this._frameCount=0,this._fpsTime=0),this._views.sort(function(e,t){return e.priority-t.priority});var t=this._views,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;a.isEnable&&a.window&&(a.window.isOffscreen||!a.window.isOffscreen&&a.window===this._curWindow)&&this._pipeline.render(a)}}},{key:"createWindow",value:function(e){if(this._device){var t=this._device.createWindow(e);if(t)return this._windows.push(t),t}return null}},{key:"destroyWindow",value:function(e){for(var t=0;t<this._windows.length;++t)if(this._windows[t]===e)return e.destroy(),void this._windows.splice(t,1)}},{key:"destroyWindows",value:function(){var e=this._windows,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._windows=[]}},{key:"createScene",value:function(e){var t=this._createSceneFun(this);return t.initialize(e),this._scenes.push(t),t}},{key:"destroyScene",value:function(e){for(var t=0;t<this._scenes.length;++t)if(this._scenes[t]===e)return e.destroy(),void this._scenes.splice(t,1)}},{key:"destroyScenes",value:function(){var e=this._scenes,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._scenes=[]}},{key:"createView",value:function(e){var t=this._createViewFun(this,e.camera);return t.initialize(e),this._views.push(t),t}},{key:"destroyView",value:function(e){for(var t=0;t<this._views.length;++t)if(this._views[t]===e)return this._views.splice(t,1),void e.destroy()}},{key:"destroyViews",value:function(){var e=this._views,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._views=[]}}]),t}(),Gb=new ve("Scheduler");Fb.get=function(e,t,i,n){var r=Fb._listEntries.pop();return r?(r.target=e,r.priority=t,r.paused=i,r.markedForDeletion=n):r=new Fb(e,t,i,n),r},Fb.put=function(e){Fb._listEntries.length<20&&(e.target=null,Fb._listEntries.push(e))},Fb._listEntries=[];function Hb(e,t,i,n){y(this,Hb),this.list=void 0,this.entry=void 0,this.target=void 0,this.callback=void 0,this.list=e,this.entry=t,this.target=i,this.callback=n}Hb.get=function(e,t,i,n){var r=Hb._hashUpdateEntries.pop();return r?(r.list=e,r.entry=t,r.target=i,r.callback=n):r=new Hb(e,t,i,n),r},Hb.put=function(e){Hb._hashUpdateEntries.length<20&&(e.list=e.entry=e.target=e.callback=null,Hb._hashUpdateEntries.push(e))},Hb._hashUpdateEntries=[];function qb(e,t,i,n,r,a){y(this,qb),this.timers=void 0,this.target=void 0,this.timerIndex=void 0,this.currentTimer=void 0,this.currentTimerSalvaged=void 0,this.paused=void 0,this.timers=e,this.target=t,this.timerIndex=i,this.currentTimer=n,this.currentTimerSalvaged=r,this.paused=a}qb.get=function(e,t,i,n,r,a){var s=qb._hashTimerEntries.pop();return s?(s.timers=e,s.target=t,s.timerIndex=i,s.currentTimer=n,s.currentTimerSalvaged=r,s.paused=a):s=new qb(e,t,i,n,r,a),s},qb.put=function(e){qb._hashTimerEntries.length<20&&(e.timers=e.target=e.currentTimer=null,qb._hashTimerEntries.push(e))},qb._hashTimerEntries=[];var jb=function(){function e(){y(this,e),this._lock=void 0,this._scheduler=void 0,this._elapsed=void 0,this._runForever=void 0,this._useDelay=void 0,this._timesExecuted=void 0,this._repeat=void 0,this._delay=void 0,this._interval=void 0,this._target=void 0,this._callback=void 0,this._lock=!1,this._scheduler=null,this._elapsed=-1,this._runForever=!1,this._useDelay=!1,this._timesExecuted=0,this._repeat=0,this._delay=0,this._interval=0,this._target=null,this._callback=null}return l(e,[{key:"initWithCallback",value:function(e,t,i,n,r,a){return this._lock=!1,this._scheduler=e,this._target=i,this._callback=t,this._elapsed=-1,this._interval=n,this._delay=a,this._useDelay=0<this._delay,this._repeat=r,this._runForever=this._repeat===cc.macro.REPEAT_FOREVER,!0}},{key:"getInterval",value:function(){return this._interval}},{key:"setInterval",value:function(e){this._interval=e}},{key:"update",value:function(e){-1===this._elapsed?(this._elapsed=0,this._timesExecuted=0):(this._elapsed+=e,this._runForever&&!this._useDelay?this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0):(this._useDelay?this._elapsed>=this._delay&&(this.trigger(),this._elapsed-=this._delay,this._timesExecuted+=1,this._useDelay=!1):this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0,this._timesExecuted+=1),this._callback&&!this._runForever&&this._timesExecuted>this._repeat&&this.cancel()))}},{key:"getCallback",value:function(){return this._callback}},{key:"trigger",value:function(){this._target&&this._callback&&(this._lock=!0,this._callback.call(this._target,this._elapsed),this._lock=!1)}},{key:"cancel",value:function(){this._scheduler.unschedule(this._callback,this._target)}}]),e}();jb._timers=[],jb.get=function(){return jb._timers.pop()||new jb},jb.put=function(e){jb._timers.length<20&&!e._lock&&(e._scheduler=e._target=e._callback=null,jb._timers.push(e))};var Wb=P2("Scheduler",function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this)))._timeScale=void 0,e._updatesNegList=void 0,e._updates0List=void 0,e._updatesPosList=void 0,e._hashForUpdates=void 0,e._hashForTimers=void 0,e._currentTarget=void 0,e._currentTargetSalvaged=void 0,e._updateHashLocked=void 0,e._arrayForTimers=void 0,e._timeScale=1,e._updatesNegList=[],e._updates0List=[],e._updatesPosList=[],e._hashForUpdates=ke(!0),e._hashForTimers=ke(!0),e._currentTarget=null,e._currentTargetSalvaged=!1,e._updateHashLocked=!1,e._arrayForTimers=[],e}return p(t,Hp),l(t,null,[{key:"enableForTarget",value:function(e){var t=!1;e.uuid?t=!0:e.id&&(t=!0),t||(e.__instanceId?cc.warnID(1513):e.id=Gb.getNewId())}}]),l(t,[{key:"setTimeScale",value:function(e){this._timeScale=e}},{key:"getTimeScale",value:function(){return this._timeScale}},{key:"update",value:function(e){var t,i,n,r,a;for(this._updateHashLocked=!0,1!==this._timeScale&&(e*=this._timeScale),t=0,n=(i=this._updatesNegList).length;t<n;t++)(r=i[t]).paused||r.markedForDeletion||r.target.update(e);for(t=0,n=(i=this._updates0List).length;t<n;t++)(r=i[t]).paused||r.markedForDeletion||r.target.update(e);for(t=0,n=(i=this._updatesPosList).length;t<n;t++)(r=i[t]).paused||r.markedForDeletion||r.target.update(e);var s=this._arrayForTimers;for(t=0;t<s.length;t++){if(a=s[t],this._currentTarget=a,this._currentTargetSalvaged=!1,!a.paused)for(a.timerIndex=0;a.timerIndex<a.timers.length;++a.timerIndex)a.currentTimer=a.timers[a.timerIndex],a.currentTimerSalvaged=!1,a.currentTimer.update(e),a.currentTimer=null;this._currentTargetSalvaged&&0===this._currentTarget.timers.length&&(this._removeHashElement(this._currentTarget),--t)}for(t=0,i=this._updatesNegList;t<i.length;)(r=i[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;for(t=0,i=this._updates0List;t<i.length;)(r=i[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;for(t=0,i=this._updatesPosList;t<i.length;)(r=i[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;this._updateHashLocked=!1,this._currentTarget=null}},{key:"schedule",value:function(e,t,i,n,r,a){if("function"!=typeof e){var s=e;e=t,t=s}4!==arguments.length&&5!==arguments.length||(a=!!n,n=cc.macro.REPEAT_FOREVER,r=0),cc.assertID(t,1502);var o=t.uuid||t.id;if(o){var l,c,u=this._hashForTimers[o];if(u?u.paused!==a&&cc.warnID(1511):(u=qb.get(null,t,0,null,null,a),this._arrayForTimers.push(u),this._hashForTimers[o]=u),null==u.timers)u.timers=[];else for(c=0;c<u.timers.length;++c)if((l=u.timers[c])&&e===l._callback)return cc.logID(1507,l.getInterval(),i),void(l._interval=i);(l=jb.get()).initWithCallback(this,e,t,i,n,r),u.timers.push(l),this._currentTarget===u&&this._currentTargetSalvaged&&(this._currentTargetSalvaged=!1)}else cc.errorID(1510)}},{key:"scheduleUpdate",value:function(e,t,i){var n=e.uuid||e.id;if(n){var r=this._hashForUpdates[n];if(r&&r.entry){if(r.entry.priority===t)return r.entry.markedForDeletion=!1,void(r.entry.paused=i);if(this._updateHashLocked)return cc.logID(1506),r.entry.markedForDeletion=!1,void(r.entry.paused=i);this.unscheduleUpdate(e)}var a,s=Fb.get(e,t,i,!1);0===t?(a=this._updates0List,this._appendIn(a,s)):(a=t<0?this._updatesNegList:this._updatesPosList,this._priorityIn(a,s,t)),this._hashForUpdates[n]=Hb.get(a,s,e,null)}else cc.errorID(1510)}},{key:"unschedule",value:function(e,t){if(t&&e){var i=t.uuid||t.id;if(i){var n=this._hashForTimers[i];if(n)for(var r=n.timers,a=0,s=r.length;a<s;a++){var o=r[a];if(e===o._callback)return o!==n.currentTimer||n.currentTimerSalvaged||(n.currentTimerSalvaged=!0),r.splice(a,1),jb.put(o),n.timerIndex>=a&&n.timerIndex--,void(0===r.length&&(this._currentTarget===n?this._currentTargetSalvaged=!0:this._removeHashElement(n)))}}else cc.errorID(1510)}}},{key:"unscheduleUpdate",value:function(e){if(e){var t=e.uuid||e.id;if(t){var i=this._hashForUpdates[t];i&&(this._updateHashLocked?i.entry.markedForDeletion=!0:this._removeUpdateFromHash(i.entry))}else cc.errorID(1510)}}},{key:"unscheduleAllForTarget",value:function(e){if(e){var t=e.uuid||e.id;if(t){var i=this._hashForTimers[t];if(i){var n=i.timers;-1<n.indexOf(i.currentTimer)&&!i.currentTimerSalvaged&&(i.currentTimerSalvaged=!0);for(var r=0,a=n.length;r<a;r++)jb.put(n[r]);n.length=0,this._currentTarget===i?this._currentTargetSalvaged=!0:this._removeHashElement(i)}this.unscheduleUpdate(e)}else cc.errorID(1510)}}},{key:"unscheduleAll",value:function(){this.unscheduleAllWithMinPriority(cc.Scheduler.PRIORITY_SYSTEM)}},{key:"unscheduleAllWithMinPriority",value:function(e){var t,i,n,r=this._arrayForTimers;for(t=r.length-1;0<=t;t--)i=r[t],this.unscheduleAllForTarget(i.target);var a=0;if(e<0)for(t=0;t<this._updatesNegList.length;)a=this._updatesNegList.length,(n=this._updatesNegList[t])&&n.priority>=e&&this.unscheduleUpdate(n.target),a===this._updatesNegList.length&&t++;if(e<=0)for(t=0;t<this._updates0List.length;)a=this._updates0List.length,(n=this._updates0List[t])&&this.unscheduleUpdate(n.target),a===this._updates0List.length&&t++;for(t=0;t<this._updatesPosList.length;)a=this._updatesPosList.length,(n=this._updatesPosList[t])&&n.priority>=e&&this.unscheduleUpdate(n.target),a===this._updatesPosList.length&&t++}},{key:"isScheduled",value:function(e,t){cc.assertID(e,1508),cc.assertID(t,1509);var i=t.uuid||t.id;if(i){var n=this._hashForTimers[i];if(!n)return!1;if(null==n.timers)return!1;for(var r=n.timers,a=0;a<r.length;++a){if(e===r[a]._callback)return!0}return!1}cc.errorID(1510)}},{key:"pauseAllTargets",value:function(){return this.pauseAllTargetsWithMinPriority(cc.Scheduler.PRIORITY_SYSTEM)}},{key:"pauseAllTargetsWithMinPriority",value:function(e){var t,i,n,r,a=[],s=this._arrayForTimers;for(i=0,n=s.length;i<n;i++)(t=s[i])&&(t.paused=!0,a.push(t.target));if(e<0)for(i=0;i<this._updatesNegList.length;i++)(r=this._updatesNegList[i])&&r.priority>=e&&(r.paused=!0,a.push(r.target));if(e<=0)for(i=0;i<this._updates0List.length;i++)(r=this._updates0List[i])&&(r.paused=!0,a.push(r.target));for(i=0;i<this._updatesPosList.length;i++)(r=this._updatesPosList[i])&&r.priority>=e&&(r.paused=!0,a.push(r.target));return a}},{key:"resumeTargets",value:function(e){if(e)for(var t=0;t<e.length;t++)this.resumeTarget(e[t])}},{key:"pauseTarget",value:function(e){cc.assertID(e,1503);var t=e.uuid||e.id;if(t){var i=this._hashForTimers[t];i&&(i.paused=!0);var n=this._hashForUpdates[t];n&&(n.entry.paused=!0)}else cc.errorID(1510)}},{key:"resumeTarget",value:function(e){cc.assertID(e,1504);var t=e.uuid||e.id;if(t){var i=this._hashForTimers[t];i&&(i.paused=!1);var n=this._hashForUpdates[t];n&&(n.entry.paused=!1)}else cc.errorID(1510)}},{key:"isTargetPaused",value:function(e){cc.assertID(e,1505);var t=e.uuid||e.id;if(t){var i=this._hashForTimers[t];if(i)return i.paused;var n=this._hashForUpdates[t];return!!n&&n.entry.paused}cc.errorID(1510)}},{key:"_removeHashElement",value:function(e){var t=e.target.uuid||e.target.id;delete this._hashForTimers[t];for(var i=this._arrayForTimers,n=0,r=i.length;n<r;n++)if(i[n]===e){i.splice(n,1);break}qb.put(e)}},{key:"_removeUpdateFromHash",value:function(e){var t=e.target.uuid||e.target.id,i=this._hashForUpdates[t];if(i){for(var n=i.list,r=i.entry,a=0,s=n.length;a<s;a++)if(n[a]===r){n.splice(a,1);break}delete this._hashForUpdates[t],Fb.put(r),Hb.put(i)}}},{key:"_priorityIn",value:function(e,t,i){for(var n=0;n<e.length;n++)if(i<e[n].priority)return void e.splice(n,0,t);e.push(t)}},{key:"_appendIn",value:function(e,t){e.push(t)}}]),t}());Wb.PRIORITY_SYSTEM=1<<31,Wb.PRIORITY_NON_SYSTEM=Wb.PRIORITY_SYSTEM+1,Wb.ID="scheduler",cc.Scheduler=Wb;var Xb=P2("Director",function(){function r(){var e;y(this,r),(e=x(this,g(r).call(this)))._compScheduler=void 0,e._nodeActivator=void 0,e.invalid=void 0,e._paused=void 0,e._purgeDirectorInNextLoop=void 0,e._root=void 0,e._loadingScene=void 0,e._scene=void 0,e._totalFrames=void 0,e._lastUpdate=void 0,e._deltaTime=void 0,e._scheduler=void 0,e._systems=void 0,e.invalid=!1,e._paused=!1,e._purgeDirectorInNextLoop=!1,e._root=null,e._loadingScene="",e._scene=null,e._totalFrames=0,e._lastUpdate=0,e._deltaTime=0,e._scheduler=new Wb,e._compScheduler=new Ny,e._nodeActivator=new Ky,e._systems=[];var t=u(e);return cc.game.on(Vp.EVENT_SHOW,function(){t._lastUpdate=performance.now()}),cc.game.once(Vp.EVENT_RENDERER_INITED,e.initOnRenererInited,u(e)),cc.game.once(Vp.EVENT_ENGINE_INITED,e.initOnEngineInited,u(e)),e}return p(r,ll),l(r,[{key:"initOnRenererInited",value:function(){this._root=new Vb(cc.game._gfxDevice);return!!this._root.initialize({})}},{key:"initOnEngineInited",value:function(){this._totalFrames=0,this._lastUpdate=performance.now(),this._paused=!1,this._purgeDirectorInNextLoop=!1,cc.loader.init(this),u_&&u_.setEnabled(!0),this.registerSystem(Wb.ID,this._scheduler,200),this.emit(r.EVENT_INIT)}},{key:"calculateDeltaTime",value:function(){var e=performance.now();this._deltaTime=(e-this._lastUpdate)/1e3,this._lastUpdate=e}},{key:"convertToGL",value:function(e){var t=cc.game.container,i=cc.view,n=t.getBoundingClientRect(),r=n.left+window.pageXOffset-t.clientLeft,a=n.top+window.pageYOffset-t.clientTop,s=i._devicePixelRatio*(e.x-r),o=i._devicePixelRatio*(a+n.height-e.y);return i._isRotated?cc.v2(i._viewportRect.width-o,s):cc.v2(s,o)}},{key:"convertToUI",value:function(e){var t=cc.game.container,i=cc.view,n=t.getBoundingClientRect(),r=n.left+window.pageXOffset-t.clientLeft,a=n.top+window.pageYOffset-t.clientTop,s=cc.v2(0,0);return i._isRotated?(s.x=r+e.y/i._devicePixelRatio,s.y=a+n.height-(i._viewportRect.width-e.x)/i._devicePixelRatio):(s.x=r+e.x*i._devicePixelRatio,s.y=a+n.height-e.y*i._devicePixelRatio),s}},{key:"end",value:function(){this._purgeDirectorInNextLoop=!0}},{key:"getWinSize",value:function(){return cc.size(cc.winSize)}},{key:"getWinSizeInPixels",value:function(){return cc.size(cc.winSize)}},{key:"pause",value:function(){this._paused||(this._paused=!0)}},{key:"purgeCachedData",value:function(){cc.loader.releaseAll()}},{key:"purgeDirector",value:function(){this._scheduler.unscheduleAll(),this._compScheduler.unscheduleAll(),this._nodeActivator.reset(),u_&&u_.setEnabled(!1),cc.isValid(this._scene)&&this._scene.destroy(),this._scene=null,this.stopAnimation(),null!=this._root&&this._root.destroy(),this._root=null,cc.loader.releaseAll()}},{key:"reset",value:function(){this.purgeDirector(),this.emit(r.EVENT_RESET),u_&&u_.setEnabled(!0),this.startAnimation()}},{key:"runSceneImmediate",value:function(e,t,i){cc.assertID(e instanceof cc.Scene,1216);var n=cc.loader._getReferenceKey(e.uuid);cc.loader.removeItem(n),e._load();for(var r=Object.keys(cc.game._persistRootNodes).map(function(e){return cc.game._persistRootNodes[e]}),a=0;a<r.length;a++){var s=r[a];s.emit(cc.Node.SCENE_CHANGED_FOR_PERSISTS,e.renderScene);var o=e.getChildByUuid(s.uuid);if(o){var l=o.getSiblingIndex();o._destroyImmediate(),e.insertChild(s,l)}else s.parent=e}var c=this._scene;!function(e,t,i){var n=cc.loader._autoReleaseSetting,r=ke();if(t)for(var a=0;a<t.length;a++)r[t[a]]=!0;for(var s=0;s<i.length;s++)Xp(i[s],r);if(e)for(var o=0;o<e.length;o++){var l=e[o];!1===n[l]||r[l]||cc.loader.release(l)}for(var c=Object.keys(n),u=0;u<c.length;u++){var h=c[u];!0!==n[h]||r[h]||cc.loader.release(h)}}(c&&c.autoReleaseAssets&&c.dependAssets,e.dependAssets,r),cc.isValid(c)&&c.destroy(),this._scene=null,No._deferredDestroy(),t&&t(),this.emit(cc.Director.EVENT_BEFORE_SCENE_LAUNCH,e),(this._scene=e)._activate(),this._root&&this._root.resetCumulativeTime(),this.startAnimation(),i&&i(null,e),this.emit(cc.Director.EVENT_AFTER_SCENE_LAUNCH,e)}},{key:"runScene",value:function(e,t,i){var n=this;cc.assertID(e,1205),cc.assertID(e instanceof cc.Scene,1216),e._load(),this.once(cc.Director.EVENT_AFTER_UPDATE,function(){n.runSceneImmediate(e,t,i)})}},{key:"_getSceneUuid",value:function(e){var t=cc.game._sceneInfos;if("string"==typeof e){e.endsWith(".scene")||(e+=".scene"),"/"===e[0]||e.startsWith("db://")||(e="/"+e);for(var i=0;i<t.length;i++){var n=t[i];if(n.url.endsWith(e))return n}}else if("number"==typeof e){if(0<=e&&e<t.length)return t[e];cc.errorID(1206,e)}else cc.errorID(1207,e);return null}},{key:"loadScene",value:function(e,t,i){if(this._loadingScene)return cc.errorID(1208,e,this._loadingScene),!1;var n=this._getSceneUuid(e);if(n){var r=n.uuid;return this.emit(cc.Director.EVENT_BEFORE_SCENE_LOADING,e),this._loadingScene=e,this._loadSceneByUuid(r,t,i),!0}return cc.errorID(1209,e),!1}},{key:"preloadScene",value:function(i,e,n){void 0===n&&(n=e,e=null);var t=this._getSceneUuid(i);if(t)this.emit(cc.Director.EVENT_BEFORE_SCENE_LOADING,i),cc.loader.load({uuid:t.uuid,type:"uuid"},e,function(e,t){e&&cc.errorID(1210,i,e.message),n&&n(e,t)});else{var r='Can not preload the scene "'+i+'" because it is not in the build settings.';n(new Error(r)),cc.error("preloadScene: "+r)}}},{key:"_loadSceneByUuid",value:function(r,e,t,i){var a=1<arguments.length&&void 0!==e?e:null,s=2<arguments.length&&void 0!==t?t:null;console.time("LoadScene "+r),cc.AssetLibrary.loadAsset(r,function(e,t){console.timeEnd("LoadScene "+r);var i=Yb;if(i._loadingScene="",e)e="Failed to load scene: "+e,cc.error(e);else{if(t instanceof cc.SceneAsset){var n=t.scene;return n._id=t._uuid,n._name=t._name,void i.runSceneImmediate(n,s,a)}e="The asset "+r+" is not a scene",cc.error(e)}a&&a(e)})}},{key:"resume",value:function(){this._paused&&(this._lastUpdate=performance.now(),this._lastUpdate||cc.logID(1200),this._paused=!1,this._deltaTime=0)}},{key:"setDepthTest",value:function(e){cc.Camera.main&&(cc.Camera.main.depth=!!e)}},{key:"setClearColor",value:function(e){cc.Camera.main&&(cc.Camera.main.backgroundColor=e)}},{key:"getRunningScene",value:function(){return this._scene}},{key:"getScene",value:function(){return this._scene}},{key:"getAnimationInterval",value:function(){return 1e3/cc.game.getFrameRate()}},{key:"setAnimationInterval",value:function(e){cc.game.setFrameRate(Math.round(1e3/e))}},{key:"getDeltaTime",value:function(){return this._deltaTime}},{key:"getCurrentTime",value:function(){return this._lastUpdate}},{key:"getTotalFrames",value:function(){return this._totalFrames}},{key:"isPaused",value:function(){return this._paused}},{key:"getScheduler",value:function(){return this._scheduler}},{key:"setScheduler",value:function(e){this._scheduler!==e&&(this.unregisterSystem(this._scheduler),this._scheduler=e,this.registerSystem(Wb.ID,e,200))}},{key:"registerSystem",value:function(e,t,i){t.id=e,t.priority=i,t.init(),this._systems.push(t),this._systems.sort(Hp.sortByPriority)}},{key:"unregisterSystem",value:function(e){$e.fastRemove(this._systems,e),this._systems.sort(Hp.sortByPriority)}},{key:"getSystem",value:function(t){return this._systems.find(function(e){return e.id===t})}},{key:"getAnimationManager",value:function(){return this.getSystem(cc.AnimationManager.ID)}},{key:"startAnimation",value:function(){this.invalid=!1,this._lastUpdate=performance.now()}},{key:"stopAnimation",value:function(){this.invalid=!0}},{key:"mainLoop",value:function(e){if(this._purgeDirectorInNextLoop)this._purgeDirectorInNextLoop=!1,this.purgeDirector();else if(!this.invalid){this.calculateDeltaTime();var t=this._deltaTime;if(!this._paused){this.emit(r.EVENT_BEFORE_UPDATE),this._compScheduler.startPhase(),this._compScheduler.updatePhase(t);for(var i=0;i<this._systems.length;++i)this._systems[i].update(t);this._compScheduler.lateUpdatePhase(t),this.emit(r.EVENT_AFTER_UPDATE),No._deferredDestroy();for(var n=0;n<this._systems.length;++n)this._systems[n].postUpdate(t)}this.emit(r.EVENT_BEFORE_DRAW),this._root.frameMove(this._deltaTime),this._root.device.present(),this.emit(r.EVENT_AFTER_DRAW),u_.frameUpdateListeners(),Sm.bookOfChange.clear(),this._totalFrames++}}},{key:"root",get:function(){return this._root}}]),r}());Xb.EVENT_INIT="director_init",Xb.EVENT_RESET="director_reset",Xb.EVENT_BEFORE_SCENE_LOADING="director_before_scene_loading",Xb.EVENT_BEFORE_SCENE_LAUNCH="director_before_scene_launch",Xb.EVENT_AFTER_SCENE_LAUNCH="director_after_scene_launch",Xb.EVENT_BEFORE_UPDATE="director_before_update",Xb.EVENT_AFTER_UPDATE="director_after_update",Xb.EVENT_BEFORE_DRAW="director_before_draw",Xb.EVENT_AFTER_DRAW="director_after_draw",Xb.EVENT_BEFORE_PHYSICS="director_before_physics",Xb.EVENT_AFTER_PHYSICS="director_after_physics",Xb.instance=void 0,cc.Director=Xb;var Yb=P2("director",Xb.instance=cc.director=new Xb),Qb=0,Kb=new(function(){function e(){y(this,e),this.html=void 0,this.meta={width:"device-width"},this.adaptationType=cc.sys.browserType}return l(e,[{key:"init",value:function(){0}},{key:"availWidth",value:function(e){return cc.sys.isMobile||!e||e===this.html?window.innerWidth:e.clientWidth}},{key:"availHeight",value:function(e){return cc.sys.isMobile||!e||e===this.html?window.innerHeight:e.clientHeight}}]),e}());switch(cc.sys.os===cc.sys.OS_IOS&&(Kb.adaptationType=cc.sys.BROWSER_TYPE_SAFARI),cc.sys.browserType===cc.sys.BROWSER_TYPE_WECHAT_GAME_SUB?Kb.adaptationType=cc.sys.BROWSER_TYPE_WECHAT_GAME_SUB:Kb.adaptationType=cc.sys.BROWSER_TYPE_WECHAT_GAME,Kb.adaptationType){case cc.sys.BROWSER_TYPE_SAFARI:Kb.meta["minimal-ui"]="true";case cc.sys.BROWSER_TYPE_SOUGOU:case cc.sys.BROWSER_TYPE_WECHAT_GAME:Kb.availWidth=function(){return window.innerWidth},Kb.availHeight=function(){return window.innerHeight};break;case cc.sys.BROWSER_TYPE_WECHAT_GAME_SUB:var Zb=window.sharedCanvas||wx.getSharedCanvas();Kb.availWidth=function(){return Zb.width},Kb.availHeight=function(){return Zb.height}}var Jb=null,$b=P2("View",function(){function n(){var e;y(this,n),(e=x(this,g(n).call(this)))._frameSize=void 0,e._scaleX=void 0,e._scaleY=void 0,e._viewportRect=void 0,e._visibleRect=void 0,e._autoFullScreen=void 0,e._devicePixelRatio=void 0,e._retinaEnabled=void 0,e._resizeCallback=void 0,e._resizing=void 0,e._orientationChanging=void 0,e._isRotated=void 0,e._orientation=void 0,e._isAdjustViewport=void 0,e._antiAliasEnabled=void 0,e._resolutionPolicy=void 0,e._rpExactFit=void 0,e._rpShowAll=void 0,e._rpNoBorder=void 0,e._rpFixedHeight=void 0,e._rpFixedWidth=void 0,e._resizeWithBrowserSize=void 0,e._designResolutionSize=void 0,e._originalDesignResolutionSize=void 0;u(e);var t=ex,i=tx;return e._frameSize=new jn(0,0),e._designResolutionSize=new jn(0,0),e._originalDesignResolutionSize=new jn(0,0),e._scaleX=1,e._scaleY=1,e._viewportRect=new Zn(0,0,0,0),e._visibleRect=new Zn(0,0,0,0),e._autoFullScreen=!1,e._devicePixelRatio=1,e._retinaEnabled=!1,e._resizeCallback=null,e._resizing=!1,e._resizeWithBrowserSize=!1,e._orientationChanging=!0,e._isRotated=!1,e._orientation=cc.macro.ORIENTATION_AUTO,e._isAdjustViewport=!0,e._antiAliasEnabled=!1,e._resolutionPolicy=null,e._rpExactFit=new ix(t.EQUAL_TO_FRAME,i.EXACT_FIT),e._rpShowAll=new ix(t.EQUAL_TO_FRAME,i.SHOW_ALL),e._rpNoBorder=new ix(t.EQUAL_TO_FRAME,i.NO_BORDER),e._rpFixedHeight=new ix(t.EQUAL_TO_FRAME,i.FIXED_HEIGHT),e._rpFixedWidth=new ix(t.EQUAL_TO_FRAME,i.FIXED_WIDTH),cc.game.once(cc.Game.EVENT_ENGINE_INITED,e.init,u(e)),e}return p(n,ll),l(n,[{key:"init",value:function(){Kb.init(),this._initFrameSize(),this.enableAntiAlias(!0);var e=cc.game.canvas.width,t=cc.game.canvas.height;this._designResolutionSize.width=e,this._designResolutionSize.height=t,this._originalDesignResolutionSize.width=e,this._originalDesignResolutionSize.height=t,this._viewportRect.width=e,this._viewportRect.height=t,this._visibleRect.width=e,this._visibleRect.height=t,cc.winSize.width=this._visibleRect.width,cc.winSize.height=this._visibleRect.height,cc.visibleRect&&cc.visibleRect.init(this._visibleRect)}},{key:"resizeWithBrowserSize",value:function(e){e?this._resizeWithBrowserSize||(this._resizeWithBrowserSize=!0,window.addEventListener("resize",this._resizeEvent),window.addEventListener("orientationchange",this._orientationChange)):this._resizeWithBrowserSize&&(this._resizeWithBrowserSize=!1,window.removeEventListener("resize",this._resizeEvent),window.removeEventListener("orientationchange",this._orientationChange))}},{key:"setResizeCallback",value:function(e){"function"!=typeof e&&null!=e||(this._resizeCallback=e)}},{key:"setOrientation",value:function(e){(e&=cc.macro.ORIENTATION_AUTO)&&this._orientation!==e&&(this._orientation=e)}},{key:"adjustViewportMeta",value:function(e){this._isAdjustViewport=e}},{key:"enableRetina",value:function(e){this._retinaEnabled=!!e}},{key:"isRetinaEnabled",value:function(){return this._retinaEnabled}},{key:"enableAntiAlias",value:function(e){if(this._antiAliasEnabled!==e)if(this._antiAliasEnabled=e,cc.game.renderType===cc.Game.RENDER_TYPE_WEBGL){var t=cc.loader._cache;for(var i in t){var n=t[i],r=n&&n.content instanceof cc.Texture2D?n.content:null;if(r){var a=cc.Texture2D.Filter;e?r.setFilters(a.LINEAR,a.LINEAR):r.setFilters(a.NEAREST,a.NEAREST)}}}else if(cc.game.renderType===cc.Game.RENDER_TYPE_CANVAS){var s=cc.game.canvas.getContext("2d");s.imageSmoothingEnabled=e,s.mozImageSmoothingEnabled=e}}},{key:"isAntiAliasEnabled",value:function(){return this._antiAliasEnabled}},{key:"enableAutoFullScreen",value:function(e){e&&e!==this._autoFullScreen&&cc.sys.isMobile&&cc.sys.browserType!==cc.sys.BROWSER_TYPE_WECHAT?(this._autoFullScreen=!0,cc.screen.autoFullScreen(cc.game.frame)):this._autoFullScreen=!1}},{key:"isAutoFullScreenEnabled",value:function(){return this._autoFullScreen}},{key:"setCanvasSize",value:function(e,t){var i=cc.game.canvas,n=cc.game.container;i.width=e*this._devicePixelRatio,i.height=t*this._devicePixelRatio,i.style.width=e+"px",i.style.height=t+"px",n.style.width=e+"px",n.style.height=t+"px",this._resizeEvent()}},{key:"getCanvasSize",value:function(){return cc.size(cc.game.canvas.width,cc.game.canvas.height)}},{key:"getFrameSize",value:function(){return cc.size(this._frameSize.width,this._frameSize.height)}},{key:"setFrameSize",value:function(e,t){this._frameSize.width=e,this._frameSize.height=t,cc.frame.style.width=e+"px",cc.frame.style.height=t+"px",this._resizeEvent()}},{key:"getVisibleSize",value:function(){return cc.size(this._visibleRect.width,this._visibleRect.height)}},{key:"getVisibleSizeInPixel",value:function(){return cc.size(this._visibleRect.width*this._scaleX,this._visibleRect.height*this._scaleY)}},{key:"getVisibleOrigin",value:function(){return cc.v2(this._visibleRect.x,this._visibleRect.y)}},{key:"getVisibleOriginInPixel",value:function(){return cc.v2(this._visibleRect.x*this._scaleX,this._visibleRect.y*this._scaleY)}},{key:"getResolutionPolicy",value:function(){return this._resolutionPolicy}},{key:"setResolutionPolicy",value:function(e){var t=this;if(e instanceof ix)t._resolutionPolicy=e;else{var i=ix;e===i.EXACT_FIT&&(t._resolutionPolicy=t._rpExactFit),e===i.SHOW_ALL&&(t._resolutionPolicy=t._rpShowAll),e===i.NO_BORDER&&(t._resolutionPolicy=t._rpNoBorder),e===i.FIXED_HEIGHT&&(t._resolutionPolicy=t._rpFixedHeight),e===i.FIXED_WIDTH&&(t._resolutionPolicy=t._rpFixedWidth)}}},{key:"setDesignResolutionSize",value:function(e,t,i){if(0<e||0<t){this.setResolutionPolicy(i);var n=this._resolutionPolicy;if(n&&n.preApply(this),cc.sys.isMobile&&this._adjustViewportMeta(),this._orientationChanging=!0,this._resizing||this._initFrameSize(),n){this._originalDesignResolutionSize.width=this._designResolutionSize.width=e,this._originalDesignResolutionSize.height=this._designResolutionSize.height=t;var r=n.apply(this,this._designResolutionSize);if(r.scale&&2===r.scale.length&&(this._scaleX=r.scale[0],this._scaleY=r.scale[1]),r.viewport){var a=this._viewportRect,s=this._visibleRect,o=r.viewport;a.x=o.x,a.y=o.y,a.width=o.width,a.height=o.height,s.x=0,s.y=0,s.width=o.width/this._scaleX,s.height=o.height/this._scaleY}n.postApply(this),cc.winSize.width=this._visibleRect.width,cc.winSize.height=this._visibleRect.height,cc.visibleRect&&cc.visibleRect.init(this._visibleRect),this.emit("design-resolution-changed")}else cc.logID(2201)}else cc.logID(2200)}},{key:"getDesignResolutionSize",value:function(){return cc.size(this._designResolutionSize.width,this._designResolutionSize.height)}},{key:"setRealPixelResolution",value:function(e,t,i){this.setDesignResolutionSize(e,t,i)}},{key:"setViewportInPoints",value:function(e,t,i,n){var r=this._scaleX,a=this._scaleY;cc.game._renderContext.viewport(e*r+this._viewportRect.x,t*a+this._viewportRect.y,i*r,n*a)}},{key:"setScissorInPoints",value:function(e,t,i,n){var r=this._scaleX,a=this._scaleY,s=Math.ceil(e*r+this._viewportRect.x),o=Math.ceil(t*a+this._viewportRect.y),l=Math.ceil(i*r),c=Math.ceil(n*a),u=cc.game._renderContext;if(!Jb){var h=u.getParameter(u.SCISSOR_BOX);Jb=new Zn(h[0],h[1],h[2],h[3])}Jb.x===s&&Jb.y===o&&Jb.width===l&&Jb.height===c||(Jb.x=s,Jb.y=o,Jb.width=l,Jb.height=c,u.scissor(s,o,l,c))}},{key:"isScissorEnabled",value:function(){var e=cc.game._renderContext;return e.isEnabled(e.SCISSOR_TEST)}},{key:"getScissorRect",value:function(){var e=cc.game._renderContext;if(!Jb){var t=e.getParameter(e.SCISSOR_BOX);Jb=new Zn(t[0],t[1],t[2],t[3])}var i=1/this._scaleX,n=1/this._scaleY;return new Zn((Jb.x-this._viewportRect.x)*i,(Jb.y-this._viewportRect.y)*n,Jb.width*i,Jb.height*n)}},{key:"getViewportRect",value:function(){return this._viewportRect}},{key:"getScaleX",value:function(){return this._scaleX}},{key:"getScaleY",value:function(){return this._scaleY}},{key:"getDevicePixelRatio",value:function(){return this._devicePixelRatio}},{key:"convertToLocationInView",value:function(e,t,i,n){var r=n||cc.v2(),a=this._devicePixelRatio*(e-i.left),s=this._devicePixelRatio*(i.top+i.height-t);return this._isRotated?(r.x=cc.game.canvas.width-s,r.y=a):(r.x=a,r.y=s),r}},{key:"_resizeEvent",value:function(){var e=Yb.getTotalFrames();if(Qb!==e){var t;Qb=e;var i=(t=this.setDesignResolutionSize?this:cc.view)._frameSize.width,n=t._frameSize.height,r=t._isRotated;if(cc.sys.isMobile){var a=cc.game.container.style,s=a.margin;a.margin="0",a.display="none",t._initFrameSize(),a.margin=s,a.display="block"}else t._initFrameSize();if(t._orientationChanging||t._isRotated!==r||t._frameSize.width!==i||t._frameSize.height!==n){var o=t._originalDesignResolutionSize.width,l=t._originalDesignResolutionSize.height;t._resizing=!0,0<o&&t.setDesignResolutionSize(o,l,t._resolutionPolicy),t._resizing=!1,t._resizeCallback&&t._resizeCallback.call()}}}},{key:"_orientationChange",value:function(){cc.view._orientationChanging=!0,cc.view._resizeEvent()}},{key:"_initFrameSize",value:function(){var e=this._frameSize,t=Kb.availWidth(cc.game.frame),i=Kb.availHeight(cc.game.frame),n=i<=t;!cc.sys.isMobile||n&&this._orientation&cc.macro.ORIENTATION_LANDSCAPE||!n&&this._orientation&cc.macro.ORIENTATION_PORTRAIT?(e.width=t,e.height=i,cc.game.container.style["-webkit-transform"]="rotate(0deg)",cc.game.container.style.transform="rotate(0deg)",this._isRotated=!1):(e.width=i,e.height=t,cc.game.container.style["-webkit-transform"]="rotate(90deg)",cc.game.container.style.transform="rotate(90deg)",cc.game.container.style["-webkit-transform-origin"]="0px 0px 0px",cc.game.container.style.transformOrigin="0px 0px 0px",this._isRotated=!0,cc.game.canvas.style["-webkit-transform"]="translateZ(0px)",cc.game.canvas.style.transform="translateZ(0px)"),this._orientationChanging&&setTimeout(function(){cc.view._orientationChanging=!1},1e3)}},{key:"_adjustSizeKeepCanvasSize",value:function(){var e=this._originalDesignResolutionSize.width,t=this._originalDesignResolutionSize.height;0<e&&this.setDesignResolutionSize(e,t,this._resolutionPolicy)}},{key:"_setViewportMeta",value:function(e,t){var i=document.getElementById("cocosMetaElement");i&&t&&document.head.removeChild(i);var n,r,a,s=document.getElementsByName("viewport"),o=s?s[0]:null;for(r in n=o?o.content:"",(i=i||document.createElement("meta")).id="cocosMetaElement",i.name="viewport",i.content="",e)-1===n.indexOf(r)?n+=","+r+"="+e[r]:t&&(a=new RegExp(r+"s*=s*[^,]+"),n.replace(a,r+"="+e[r]));/^,/.test(n)&&(n=n.substr(1)),i.content=n,o&&(o.content=n),document.head.appendChild(i)}},{key:"_adjustViewportMeta",value:function(){this._isAdjustViewport,0}},{key:"_convertMouseToLocation",value:function(e,t){e.x=this._devicePixelRatio*(e.x-t.left),e.y=this._devicePixelRatio*(t.top+t.height-e.y)}},{key:"_convertPointWithScale",value:function(e){var t=this._viewportRect;e.x=(e.x-t.x)/this._scaleX,e.y=(e.y-t.y)/this._scaleY}},{key:"_convertTouchWidthScale",value:function(e){var t=this._viewportRect,i=this._scaleX,n=this._scaleY;e._point.x=(e._point.x-t.x)/i,e._point.y=(e._point.y-t.y)/n,e._prevPoint.x=(e._prevPoint.x-t.x)/i,e._prevPoint.y=(e._prevPoint.y-t.y)/n}},{key:"_convertTouchesWithScale",value:function(e){for(var t,i,n=this._viewportRect,r=this._scaleX,a=this._scaleY,s=0;s<e.length;s++){var o=e[s];t=o._point,i=o._prevPoint,t.x=(t.x-n.x)/r,t.y=(t.y-n.y)/a,i.x=(i.x-n.x)/r,i.y=(i.y-n.y)/a}}}]),n}());$b.instance=void 0;var ex=function(){function e(){y(this,e),this.name="ContainerStrategy"}return l(e,[{key:"preApply",value:function(e){}},{key:"apply",value:function(e,t){}},{key:"postApply",value:function(e){}},{key:"_setupContainer",value:function(e,t,i){var n=cc.game.canvas,r=cc.game.container;cc.sys.platform!==cc.sys.WECHAT_GAME&&(cc.sys.os===cc.sys.OS_ANDROID&&(document.body.style.width=(e._isRotated?i:t)+"px",document.body.style.height=(e._isRotated?t:i)+"px"),r.style.width=n.style.width=t+"px",r.style.height=n.style.height=i+"px");var a=e._devicePixelRatio=1;e.isRetinaEnabled()&&(a=e._devicePixelRatio=Math.min(2,window.devicePixelRatio||1)),n.width=t*a,n.height=i*a}},{key:"_fixContainer",value:function(){document.body.insertBefore(cc.game.container,document.body.firstChild);var e=document.body.style;e.width=window.innerWidth+"px",e.height=window.innerHeight+"px",e.overflow="hidden";var t=cc.game.container.style;t.position="fixed",t.left=t.top="0px",document.body.scrollTop=0}}]),e}();ex.EQUAL_TO_FRAME=void 0,ex.PROPORTION_TO_FRAME=void 0;var tx=function(){function e(){y(this,e),this.name="ContentStrategy",this._result=void 0,this._result={scale:[1,1],viewport:null}}return l(e,[{key:"preApply",value:function(e){}},{key:"apply",value:function(e,t){return{scale:[1,1]}}},{key:"postApply",value:function(e){}},{key:"_buildResult",value:function(e,t,i,n,r,a){Math.abs(e-i)<2&&(i=e),Math.abs(t-n)<2&&(n=t);var s=new Zn(Math.round((e-i)/2),Math.round((t-n)/2),i,n);return cc.game.renderType,Vp.RENDER_TYPE_CANVAS,this._result.scale=[r,a],this._result.viewport=s,this._result}}]),e}();tx.EXACT_FIT=void 0,tx.SHOW_ALL=void 0,tx.NO_BORDER=void 0,tx.FIXED_HEIGHT=void 0,tx.FIXED_WIDTH=void 0,function(){var e=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n)))).name="EqualToFrame",t}return p(a,ex),l(a,[{key:"apply",value:function(e){var t=e._frameSize.height,i=cc.game.container.style;this._setupContainer(e,e._frameSize.width,e._frameSize.height),e._isRotated?i.margin="0 0 0 "+t+"px":i.margin="0px",i.padding="0px"}}]),a}(),t=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n)))).name="ProportionalToFrame",t}return p(a,ex),l(a,[{key:"apply",value:function(e,t){var i,n,r=e._frameSize.width,a=e._frameSize.height,s=cc.game.container.style,o=t.width,l=t.height,c=r/o,u=a/l;n=c<u?(i=r,l*c):(i=o*u,a);var h=Math.round((r-i)/2),f=Math.round((a-n)/2);i=r-2*h,n=a-2*f,this._setupContainer(e,i,n),e._isRotated?s.margin="0 0 0 "+a+"px":s.margin="0px",s.paddingLeft=h+"px",s.paddingRight=h+"px",s.paddingTop=f+"px",s.paddingBottom=f+"px"}}]),a}();ex.EQUAL_TO_FRAME=new e,ex.PROPORTION_TO_FRAME=new t;var i=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n)))).name="ExactFit",t}return p(a,tx),l(a,[{key:"apply",value:function(e,t){var i=cc.game.canvas.width,n=cc.game.canvas.height,r=i/t.width,a=n/t.height;return this._buildResult(i,n,i,n,r,a)}}]),a}(),n=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n)))).name="ShowAll",t}return p(a,tx),l(a,[{key:"apply",value:function(e,t){var i,n,r=cc.game.canvas.width,a=cc.game.canvas.height,s=t.width,o=t.height,l=r/s,c=a/o,u=0;return n=l<c?(i=r,o*(u=l)):(i=s*(u=c),a),this._buildResult(r,a,i,n,u,u)}}]),a}(),r=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n)))).name="NoBorder",t}return p(a,tx),l(a,[{key:"apply",value:function(e,t){var i,n,r,a=cc.game.canvas.width,s=cc.game.canvas.height,o=t.width,l=t.height,c=a/o,u=s/l;return r=c<u?(n=o*(i=u),s):(n=a,l*(i=c)),this._buildResult(a,s,n,r,i,i)}}]),a}(),a=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n)))).name="FixedHeight",t}return p(a,tx),l(a,[{key:"apply",value:function(e,t){var i=cc.game.canvas.width,n=cc.game.canvas.height,r=n/t.height,a=i,s=n;return this._buildResult(i,n,a,s,r,r)}}]),a}(),s=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n)))).name="FixedWidth",t}return p(a,tx),l(a,[{key:"apply",value:function(e,t){var i=cc.game.canvas.width,n=cc.game.canvas.height,r=i/t.width,a=i,s=n;return this._buildResult(i,n,a,s,r,r)}}]),a}();tx.EXACT_FIT=new i,tx.SHOW_ALL=new n,tx.NO_BORDER=new r,tx.FIXED_HEIGHT=new a,tx.FIXED_WIDTH=new s}();var ix=P2("ResolutionPolicy",function(){function i(e,t){y(this,i),this.name="ResolutionPolicy",this._containerStrategy=void 0,this._contentStrategy=void 0,this._containerStrategy=null,this._contentStrategy=null,this.setContainerStrategy(e),this.setContentStrategy(t)}return l(i,[{key:"preApply",value:function(e){this._containerStrategy.preApply(e),this._contentStrategy.preApply(e)}},{key:"apply",value:function(e,t){return this._containerStrategy.apply(e,t),this._contentStrategy.apply(e,t)}},{key:"postApply",value:function(e){this._containerStrategy.postApply(e),this._contentStrategy.postApply(e)}},{key:"setContainerStrategy",value:function(e){e instanceof ex&&(this._containerStrategy=e)}},{key:"setContentStrategy",value:function(e){e instanceof tx&&(this._contentStrategy=e)}},{key:"canvasSize",get:function(){return cc.v2(cc.game.canvas.width,cc.game.canvas.height)}}]),i}());ix.EXACT_FIT=void 0,ix.SHOW_ALL=void 0,ix.NO_BORDER=void 0,ix.FIXED_HEIGHT=void 0,ix.FIXED_WIDTH=void 0,ix.UNKNOWN=void 0,ix.ContainerStrategy=void 0,ix.ContentStrategy=void 0,ix.EXACT_FIT=0,ix.NO_BORDER=1,ix.SHOW_ALL=2,ix.FIXED_HEIGHT=3,ix.FIXED_WIDTH=4,ix.UNKNOWN=5,ix.ContainerStrategy=ex,ix.ContentStrategy=tx,cc.ResolutionPolicy=ix;var nx=P2("view",$b.instance=cc.view=new $b);cc.winSize=cc.v2();var rx=P2("screen",{_supportsFullScreen:!1,_preOnFullScreenChange:null,_touchEvent:"",_fn:null,_fnMap:[["requestFullscreen","exitFullscreen","fullscreenchange","fullscreenEnabled","fullscreenElement"],["requestFullScreen","exitFullScreen","fullScreenchange","fullScreenEnabled","fullScreenElement"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitfullscreenchange","webkitIsFullScreen","webkitCurrentFullScreenElement"],["mozRequestFullScreen","mozCancelFullScreen","mozfullscreenchange","mozFullScreen","mozFullScreenElement"],["msRequestFullscreen","msExitFullscreen","MSFullscreenChange","msFullscreenEnabled","msFullscreenElement"]],init:function(){this._fn={};var e,t,i,n,r=this._fnMap;for(e=0,t=r.length;e<t;e++)if((i=r[e])&&void 0!==document[i[1]]){for(e=0,n=i.length;e<n;e++)this._fn[r[0][e]]=i[e];break}this._supportsFullScreen=void 0!==this._fn.requestFullscreen,this._touchEvent="ontouchstart"in window?"touchstart":"mousedown"},fullScreen:function(){return!!this._supportsFullScreen&&(void 0!==document[this._fn.fullscreenElement]&&null!==document[this._fn.fullscreenElement])},requestFullScreen:function(e,t){if(this._supportsFullScreen){if(e=e||document.documentElement,t){var i=this._fn.fullscreenchange;this._preOnFullScreenChange&&document.removeEventListener(i,this._preOnFullScreenChange),this._preOnFullScreenChange=t,document.addEventListener(i,t,!1)}return e[this._fn.requestFullscreen]()}},exitFullScreen:function(){return!this._supportsFullScreen||document[this._fn.exitFullscreen]()},autoFullScreen:function(t,i){t=t||document.body;var n=cc.game.canvas||t,r=this;this.requestFullScreen(t,i),n.addEventListener(this._touchEvent,function e(){n.removeEventListener(r._touchEvent,e),r.requestFullScreen(t,i)})}});function ax(e){var t=[];return function e(t,i){var n=i,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;Array.isArray(o)?e(t,o):t.push(o)}}(t,e),t.join("")}rx.init(),cc.screen=rx,cc.RenderPassStage=jh;var sx=No.Flags.Destroyed,ox=No.Flags.PersistentMask,lx=gt+"default",cx=ai.IDENTIFIER_RE,ux="var ",hx="o",fx={"cc.Node":"cc.Node","cc.Sprite":"cc.Sprite","cc.Label":"cc.Label","cc.Button":"cc.Button","cc.Widget":"cc.Widget","cc.Animation":"cc.Animation","cc.ClickEvent":!1,"cc.PrefabInfo":!1},dx=ai.escapeForJS,px=function(){function i(e,t){y(this,i),this.varName=void 0,this.expression=void 0,this.varName=e,this.expression=t}return l(i,[{key:"toString",value:function(){return ux+this.varName+"="+this.expression+";"}}]),i}();function _x(e,t){return t instanceof px?new px(t.varName,e+t.expression):e+t}function vx(e,t,i){Array.isArray(i)?(i[0]=_x(t,i[0]),e.push(i)):e.push(_x(t,i)+";")}var mx=function(){function t(e){y(this,t),this._exps=void 0,this._targetExp=void 0,this._exps=[],this._targetExp=e}return l(t,[{key:"append",value:function(e,t){this._exps.push([e,t])}},{key:"writeCode",value:function(e){var t;if(1<this._exps.length)e.push("t="+this._targetExp+";"),t="t";else{if(1!==this._exps.length)return;t=this._targetExp}for(var i=0;i<this._exps.length;i++){var n=this._exps[i];vx(e,t+yx(n[0])+"=",n[1])}}}]),t}();function yx(e){return cx.test(e)?"."+e:"["+dx(e)+"]"}mx.pool=void 0,mx.pool=new Je(function(e){e._exps.length=0,e._targetExp=null},1),mx.pool.get=function(e){var t=this._get()||new mx;return t._targetExp=e,t};var gx,bx,xx,Sx,Tx,Ex,Cx,Ax=function(){function s(e,t){var i;y(this,s),this.parent=void 0,this.objsToClear_iN$t=void 0,this.codeArray=void 0,this.objs=void 0,this.funcs=void 0,this.funcModuleCache=void 0,this.globalVariables=void 0,this.globalVariableId=void 0,this.localVariableId=void 0,this.result=void 0,this.parent=t,this.objsToClear_iN$t=[],this.codeArray=[],this.objs=[],this.funcs=[],this.funcModuleCache=ke(),Ne(this.funcModuleCache,fx),this.globalVariables=[],this.globalVariableId=0,this.localVariableId=0,this.codeArray.push("var o,t;","if(R){","o=R;","}else{","o=R=new "+this.getFuncModule(e.constructor,!0)+"();","}"),e._iN$t={globalVar:"R"},this.objsToClear_iN$t.push(e),this.enumerateObject(this.codeArray,e),0<this.globalVariables.length&&(i=ux+this.globalVariables.join(",")+";");var n=ax(["return (function(R){",i||[],this.codeArray,"return o;","})"]);this.result=Function("O","F",n)(this.objs,this.funcs);for(var r=0,a=this.objsToClear_iN$t.length;r<a;++r)this.objsToClear_iN$t[r]._iN$t=null;this.objsToClear_iN$t.length=0}return l(s,[{key:"getFuncModule",value:function(e,t){var i=Re(e);if(i){var n=this.funcModuleCache[i];if(n)return n;if(void 0===n){var r=-1!==i.indexOf(".");if(r)try{if(r=e===Function("return "+i)())return this.funcModuleCache[i]=i}catch(e){}}}var a=this.funcs.indexOf(e);a<0&&(a=this.funcs.length,this.funcs.push(e));var s="F["+a+"]";return t&&(s="("+s+")"),this.funcModuleCache[i]=s}},{key:"getObjRef",value:function(e){var t=this.objs.indexOf(e);return t<0&&(t=this.objs.length,this.objs.push(e)),"O["+t+"]"}},{key:"setValueType",value:function(e,t,i,n){var r=mx.pool.get(n),a=t.constructor.__props__;a=a||Object.keys(t);for(var s=0;s<a.length;s++){var o=a[s],l=i[o];if(t[o]!==l){var c=this.enumerateField(i,o,l);r.append(o,c)}}r.writeCode(e),mx.pool.put(r)}},{key:"enumerateCCClass",value:function(e,t,i){for(var n=i.__values__,r=wt(i),a=0;a<n.length;a++){var s=n[a],o=t[s],l=r[s+lx];if(!kx(l,o))if("object"===de(o)&&o instanceof cc.ValueType&&(l=ai.getDefault(l))&&l.constructor===o.constructor){var c=hx+yx(s);this.setValueType(e,l,o,c)}else this.setObjProp(e,t,s,o)}}},{key:"instantiateArray",value:function(e){if(0===e.length)return"[]";var t="a"+ ++this.localVariableId,i=[new px(t,"new Array("+e.length+")")];e._iN$t={globalVar:"",source:i},this.objsToClear_iN$t.push(e);for(var n=0;n<e.length;++n){vx(i,t+"["+n+"]=",this.enumerateField(e,n,e[n]))}return i}},{key:"enumerateField",value:function(e,t,i){if("object"===de(i)&&i){var n=i._iN$t;if(n){var r=n.globalVar;if(!r){r=n.globalVar="v"+ ++this.globalVariableId,this.globalVariables.push(r);var a=n.source[0];n.source[0]=_x(r+"=",a)}return r}return Array.isArray(i)?this.instantiateArray(i):this.instantiateObj(i)}return"function"==typeof i?this.getFuncModule(i):"string"==typeof i?dx(i):("_objFlags"===t&&e instanceof No&&(i&=ox),i)}},{key:"setObjProp",value:function(e,t,i,n){vx(e,hx+yx(i)+"=",this.enumerateField(t,i,n))}},{key:"enumerateObject",value:function(e,t){var i=t.constructor;if(cc.Class._isCCClass(i))this.enumerateCCClass(e,t,i);else for(var n in t)if(t.hasOwnProperty(n)&&(95!==n.charCodeAt(0)||95!==n.charCodeAt(1)||"__type__"===n)){var r=t[n];"object"===de(r)&&r&&r===t._iN$t||this.setObjProp(e,t,n,r)}}},{key:"instantiateObj",value:function(e){if(e instanceof cc.ValueType)return ai.getNewValueTypeCode(e);if(e instanceof cc.Asset)return this.getObjRef(e);if(e._objFlags&sx)return null;var t,i=e.constructor;if(cc.Class._isCCClass(i)){if(this.parent)if(this.parent instanceof cc.Component){if(e instanceof cc._BaseNode||e instanceof cc.Component)return this.getObjRef(e)}else if(this.parent instanceof cc._BaseNode)if(e instanceof cc._BaseNode){if(!e.isChildOf(this.parent))return this.getObjRef(e)}else if(e instanceof cc.Component&&!e.node.isChildOf(this.parent))return this.getObjRef(e);t=new px(hx,"new "+this.getFuncModule(i,!0)+"()")}else if(i===Object)t=new px(hx,"{}");else{if(i)return this.getObjRef(e);t=new px(hx,"Object.create(null)")}var n=[t];return e._iN$t={globalVar:"",source:n},this.objsToClear_iN$t.push(e),this.enumerateObject(n,e),["(function(){",n,"return o;})();"]}}]),s}();function kx(e,t){if("function"==typeof e)try{e=e()}catch(e){return!1}if(e===t)return!0;if(e&&t){if(e instanceof cc.ValueType&&e.equals(t))return!0;if(Array.isArray(e)&&Array.isArray(t)||e.constructor===Object&&t.constructor===Object)try{return Array.isArray(e)&&Array.isArray(t)&&0===e.length&&0===t.length}catch(e){}}return!1}function Rx(e){var t=e instanceof cc._BaseNode&&e;return new Ax(e,t).result}var Ox,Mx,Ix,Lx,zx=vt({AUTO:0,SINGLE_INSTANCE:1,MULTI_INSTANCE:2}),Bx=P2("Prefab",ho("cc.Prefab")((Cx=Ex=function(){function t(){var e;return y(this,t),v(e=x(this,g(t).call(this)),"data",xx,u(e)),v(e,"optimizationPolicy",Sx,u(e)),v(e,"asyncLoadAssets",Tx,u(e)),e._createFunction=void 0,e._instantiatedTimes=void 0,e._createFunction=null,e._instantiatedTimes=0,e}return p(t,Mu),l(t,[{key:"createNode",value:function(e){var t=cc.instantiate(this);t.name=this.name,e(null,t)}},{key:"compileCreateFunction",value:function(){this._createFunction=Rx(this.data)}},{key:"_doInstantiate",value:function(e){return this.data._prefab?this.data._prefab._synced=!0:cc.warnID(3700),this._createFunction||this.compileCreateFunction(),this._createFunction(e)}},{key:"_instantiate",value:function(){var e,t=!1;return t?(e=this._doInstantiate(),this.data._instantiate(e)):(this.data._prefab._synced=!0,e=this.data._instantiate()),++this._instantiatedTimes,e}}]),t}(),Ex.OptimizationPolicy=zx,Ex.OptimizationPolicyThreshold=3,xx=m((bx=Cx).prototype,"data",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Sx=m(bx.prototype,"optimizationPolicy",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return zx.AUTO}}),Tx=m(bx.prototype,"asyncLoadAssets",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),gx=bx))||gx);cc.Prefab=Bx,Oe(cc,"cc._Prefab","Prefab");var Px,Dx,Fx,Nx=P2("SceneAsset",ho("cc.SceneAsset")((Ix=m((Mx=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"scene",Ix,u(t)),v(t,"asyncLoadAssets",Lx,u(t)),t}return p(a,Mu),a}()).prototype,"scene",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Lx=m(Mx.prototype,"asyncLoadAssets",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Ox=Mx))||Ox);cc.SceneAsset=Nx;var Ux,Vx,Gx,Hx=P2("SpriteAtlas",ho("cc.SpriteAtlas")((Fx=m((Dx=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"spriteFrames",Fx,u(t)),t}return p(a,Mu),l(a,[{key:"getTexture",value:function(){var e=Object.keys(this.spriteFrames);if(0<e.length){var t=this.spriteFrames[e[0]];return t&&t._image}return null}},{key:"getSpriteFrame",value:function(e){var t=this.spriteFrames[e];return t?(t.name||(t.name=e),t):null}},{key:"getSpriteFrames",value:function(){for(var e=[],t=this.spriteFrames,i=0,n=Object.keys(t);i<n.length;i++){var r=n[i];e.push(t[r])}return e}},{key:"_serialize",value:function(e){for(var t=[],i=0,n=Object.keys(this.spriteFrames);i<n.length;i++){var r=n[i],a=this.spriteFrames[r],s=a?a._uuid:"";s&&e&&(s=Editor.Utils.UuidUtils.compressUuid(s,!0)),t.push(r),t.push(s)}return{name:this._name,spriteFrames:t}}},{key:"_deserialize",value:function(e,t){var i=e;this._name=i.name;var n=i.spriteFrames;this.spriteFrames=ke();for(var r=0;r<n.length;r+=2)t.result.push(this.spriteFrames,n[r],n[r+1])}}]),a}()).prototype,"spriteFrames",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ke()}}),Px=Dx))||Px);cc.SpriteAtlas=Hx;var qx,jx,Wx,Xx=P2("TextAsset",ho("cc.TextAsset")((Gx=m((Vx=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"text",Gx,u(t)),t}return p(a,Mu),l(a,[{key:"toString",value:function(){return this.text}}]),a}()).prototype,"text",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Ux=Vx))||Ux);cc.TextAsset=Xx;var Yx=P2("JsonAsset",ho("cc.JsonAsset")((Wx=m((jx=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"json",Wx,u(t)),t}return p(a,Mu),a}()).prototype,"json",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qx=jx))||qx);cc.JsonAsset=Yx;var Qx="0123456789abcdef".split(""),Kx=["","","",""],Zx=Kx.concat(Kx,"-",Kx,"-",Kx,"-",Kx,"-",Kx,Kx,Kx),Jx=Zx.map(function(e,t){return"-"===e?NaN:t}).filter(isFinite);function $x(e){var t=e.split("@")[0];if(22!==t.length)return e;Zx[0]=e[0],Zx[1]=e[1];for(var i=2,n=2;i<22;i+=2){var r=at[e.charCodeAt(i)],a=at[e.charCodeAt(i+1)];Zx[Jx[n++]]=Qx[r>>2],Zx[Jx[n++]]=Qx[(3&r)<<2|a>>4],Zx[Jx[n++]]=Qx[15&a]}return e.replace(t,Zx.join(""))}var eS={_rawAssets:"",normalize:function(e){return e&&(46===e.charCodeAt(0)&&47===e.charCodeAt(1)?e=e.slice(2):47===e.charCodeAt(0)&&(e=e.slice(1))),e},raw:function(e){if((e=this.normalize(e)).startsWith("resources/")){var t=cc.loader._getResUuid(e.slice(10),cc.Asset,null,!0);if(t)return cc.AssetLibrary.getLibUrlNoExt(t,!0)+cc.path.extname(e)}else cc.errorID(7002,e);return this._rawAssets+e},_init:function(e){this._rawAssets=cc.path.stripSep(e)+"/"}};cc.url=eS,P2("url",eS);function tS(e,t){y(this,tS),this.uuid=void 0,this.type=void 0,this.uuid=e,this.type=t}var iS,nS,rS=function(){function e(){y(this,e),this._pathToUuid=void 0,this._pathToUuid=ke(!0)}return l(e,[{key:"getUuid",value:function(e,t){e=eS.normalize(e);var i=this._pathToUuid[e];if(i)if(Array.isArray(i)){if(!t)return i[0].uuid;for(var n=0;n<i.length;n++){var r=i[n];if(Ge(r.type,t))return r.uuid}}else{if(!t||Ge(i.type,t))return i.uuid}return""}},{key:"getUuidArray",value:function(e,t,i){"/"===(e=eS.normalize(e))[e.length-1]&&(e=e.slice(0,-1));var n,r,a=this._pathToUuid,s=[];for(var o in a)if(o.startsWith(e)&&(r=e,!((n=o).length>r.length)||47===n.charCodeAt(r.length))||!e){var l=a[o];if(Array.isArray(l))for(var c=0;c<l.length;c++){var u=l[c];(!t||Ge(u.type,t))&&(s.push(u.uuid),i&&i.push(o))}else(!t||Ge(l.type,t))&&(s.push(l.uuid),i&&i.push(o))}return s}},{key:"add",value:function(e,t,i,n){n&&(e=e.substring(0,e.length-K(e).length));var r=new tS(t,i);lt(this._pathToUuid,e,r,n)}},{key:"_getInfo_DEBUG",value:function(e,t){for(var i=this._pathToUuid,n=Object.keys(i),r=0;r<n.length;++r){var a=n[r],s=i[a];if(Array.isArray(s))for(var o=0;o<s.length;o++){var l=s[o];if(l.uuid===e)return t.path=a,t.type=l.type,!0}else if(s.uuid===e)return t.path=a,t.type=s.type,!0}return!1}},{key:"reset",value:function(){this._pathToUuid=ke(!0)}}]),e}(),aS=0|998*Math.random(),sS=ke(!0),oS=[];(nS=iS=iS||{})[nS.WORKING=0]="WORKING",nS[nS.COMPLETE=1]="COMPLETE",nS[nS.ERROR=2]="ERROR";var lS=ke(!0);function cS(t,e){var i="object"===de(t)?t.url:t,n={queueId:e,id:i,url:i,rawUrl:void 0,urlParam:function(e){if(e){var t=e.split("?");if(t&&t[0]&&t[1]){var i={};return t[1].split("&").forEach(function(e){var t=e.split("=");i[t[0]]=t[1]}),i}}}(i),type:"",error:null,content:null,complete:!1,states:{},deps:null,isScene:t.uuid&&cc.game._sceneInfos.find(function(e){return e.uuid===t.uuid})};if("object"===de(t)&&(Ne(n,t),t.skips))for(var r=0;r<t.skips.length;r++){var a=t.skips[r];n.states[a]=iS.COMPLETE}return n.rawUrl=n.url,i&&!n.type&&(n.type=K(i).toLowerCase().substr(1)),n}var uS=[];function hS(e,t,i){if(!e||!t)return!1;var n=!1;if(uS.push(t.id),t.deps){var r,a,s=t.deps;for(r=0;r<s.length;r++){if((a=s[r]).id===e.id){n=!0;break}if(!(0<=uS.indexOf(a.id))&&(a.deps&&hS(e,a,!0))){n=!0;break}}}return i||(uS.length=0),n}var fS=P2("LoadingItems",function(){function c(e,t,i,n){var r;return y(this,c),(r=x(this,g(c).call(this))).onProgress=void 0,r.onComplete=void 0,r.map=ke(!0),r.completed={},r.totalCount=0,r.completedCount=0,r.active=void 0,r._id=void 0,r._pipeline=void 0,r._errorUrls=[],r._appending=!1,r._ownerQueue=null,r._id=++aS,sS[r._id]=u(r),r._pipeline=e,r.onProgress=i,r.onComplete=n,r._pipeline?r.active=!0:r.active=!1,t&&(0<t.length?r.append(t):r.allComplete()),r}return p(c,sl),l(c,[{key:"append",value:function(e,i){var n=this;if(!this.active)return[];i&&!i.deps&&(i.deps=[]),this._appending=!0;var t,r,a,s,o=[];for(t=0;t<e.length;++t){if((r=e[t]).queueId&&!this.map[r.id]){if(this.map[r.id]=r,i&&i.deps.push(r),r.complete||hS(i,r)){this.totalCount++,this.itemComplete(r.id);continue}if("continue"===function(){var t=n,e=sS[r.queueId];return e&&(n.totalCount++,c.registerQueueDep(i||n._id,r.id),e.addListener(r.id,function(e){t.itemComplete(e.id)})),"continue"}())continue}if("string"==typeof((s=r).url||s)){var l=(a=cS(r,this._id)).id;this.map[l]||(this.map[l]=a,this.totalCount++,i&&i.deps.push(a),c.registerQueueDep(i||this._id,l),o.push(a))}}return this._appending=!1,this.completedCount===this.totalCount?this.allComplete():this._pipeline.flowIn(o),o}},{key:"_childOnProgress",value:function(e){if(this.onProgress){var t=lS[this._id];this.onProgress(t?t.completed.length:this.completedCount,t?t.deps.length:this.totalCount,e)}}},{key:"allComplete",value:function(){var e=0===this._errorUrls.length?null:this._errorUrls;this.onComplete&&this.onComplete(e,this)}},{key:"isCompleted",value:function(){return this.completedCount>=this.totalCount}},{key:"isItemCompleted",value:function(e){return!!this.completed[e]}},{key:"exists",value:function(e){return!!this.map[e]}},{key:"getContent",value:function(e){var t=this.map[e],i=null;return t&&(t.content?i=t.content:t.alias&&(i=t.alias.content)),i}},{key:"getError",value:function(e){var t=this.map[e],i=null;return t&&(t.error?i=t.error:t.alias&&(i=t.alias.error)),i}},{key:"removeItem",value:function(e){var t=this.map[e];t&&this.completed[t.alias||e]&&(delete this.completed[e],delete this.map[e],t.alias&&(delete this.completed[t.alias.id],delete this.map[t.alias.id]),this.completedCount--,this.totalCount--)}},{key:"itemComplete",value:function(e){var t=this.map[e];if(t){var i=this._errorUrls.indexOf(e);if(t.error&&-1===i?this._errorUrls.push(e):t.error||-1===i||this._errorUrls.splice(i,1),this.completed[e]=t,this.completedCount++,c.finishDep(t.id),this.onProgress){var n=lS[this._id];this.onProgress(n?n.completed.length:this.completedCount,n?n.deps.length:this.totalCount,t)}this.emit(e,t),this.removeAll(e),!this._appending&&this.completedCount>=this.totalCount&&this.allComplete()}}},{key:"destroy",value:function(){this.active=!1,this._appending=!1,this._pipeline=null,this._ownerQueue=null,this._errorUrls.length=0,this.onProgress=void 0,this.onComplete=void 0,this.map=ke(!0),this.completed={},this.totalCount=0,this.completedCount=0,sl.call(this),sS[this._id]=null,lS[this._id]&&(lS[this._id].completed.length=0,lS[this._id].deps.length=0),-1===oS.indexOf(this)&&oS.length<10&&oS.push(this)}},{key:"addListener",value:function(e,t,i){return _(g(c.prototype),"on",this).call(this,e,t,i)}},{key:"hasListener",value:function(e,t,i){return _(g(c.prototype),"hasEventListener",this).call(this,e,t,i)}},{key:"removeListener",value:function(e,t,i){return _(g(c.prototype),"off",this).call(this,e,t,i)}},{key:"removeAllListeners",value:function(e){_(g(c.prototype),"removeAll",this).call(this,e)}}],[{key:"create",value:function(e,t,i,n){void 0===i?"function"==typeof t&&(n=t,t=i=null):void 0===n&&("function"==typeof t?(n=i,i=t,t=null):(n=i,i=null));var r=oS.pop();return r?(r._pipeline=e,r.onProgress=i,r.onComplete=n,(sS[r._id]=r)._pipeline&&(r.active=!0),t&&r.append(t)):r=new c(e,t,i,n),r}},{key:"getQueue",value:function(e){return e.queueId?sS[e.queueId]:null}},{key:"itemComplete",value:function(e){var t=sS[e.queueId];t&&t.itemComplete(e.id)}},{key:"initQueueDeps",value:function(e){var t=lS[e._id];t?(t.completed.length=0,t.deps.length=0):t=lS[e._id]={completed:[],deps:[]}}},{key:"registerQueueDep",value:function(e,t){var i=e.queueId||e;if(!i)return!1;var n=lS[i];if(n)-1===n.deps.indexOf(t)&&n.deps.push(t);else if(e.id)for(var r in lS){var a=lS[r];-1!==a.deps.indexOf(e.id)&&-1===a.deps.indexOf(t)&&a.deps.push(t)}}},{key:"finishDep",value:function(e){for(var t in lS){var i=lS[t];-1!==i.deps.indexOf(e)&&-1===i.completed.indexOf(e)&&i.completed.push(e)}}}]),c}());fS.ItemState=new cc.Enum(iS);var dS=(cc.LoadingItems=fS).ItemState;function pS(e,i){var n=e.id,t=i.states[n],r=e.next,a=e.pipeline;if(!i.error&&t!==dS.WORKING&&t!==dS.ERROR)if(t===dS.COMPLETE)r?pS(r,i):a.flowOut(i);else{i.states[n]=dS.WORKING;var s=e.handle(i,function(e,t){e?(i.error=e,i.states[n]=dS.ERROR,a.flowOut(i)):(t&&(i.content=t),i.states[n]=dS.COMPLETE,r?pS(r,i):a.flowOut(i))});s instanceof Error?(i.error=s,i.states[n]=dS.ERROR,a.flowOut(i)):void 0!==s&&(null!==s&&(i.content=s),i.states[n]=dS.COMPLETE,r?pS(r,i):a.flowOut(i))}}var _S=P2("Pipeline",function(){function n(e){y(this,n),this._pipes=void 0,this._cache=ke(!0),this._pipes=e;for(var t=0;t<e.length;++t){var i=e[t];i.handle&&i.id&&(i.pipeline=this,i.next=t<e.length-1?e[t+1]:null)}}return l(n,[{key:"insertPipe",value:function(e,t){if(!e.handle||!e.id||t>this._pipes.length)cc.warnID(4921);else if(0<this._pipes.indexOf(e))cc.warnID(4922);else{var i=null;t<(e.pipeline=this)._pipes.length&&(i=this._pipes[t]);var n=null;0<t&&(n=this._pipes[t-1]),n&&(n.next=e),e.next=i,this._pipes.splice(t,0,e)}}},{key:"insertPipeAfter",value:function(e,t){var i=this._pipes.indexOf(e);i<0||this.insertPipe(t,i+1)}},{key:"appendPipe",value:function(e){e.handle&&e.id&&(e.pipeline=this,e.next=null,0<this._pipes.length&&(this._pipes[this._pipes.length-1].next=e),this._pipes.push(e))}},{key:"flowIn",value:function(e){var t,i,n=this._pipes[0];if(n){for(t=0;t<e.length;t++)(i=e[t]).isScene||(this._cache[i.id]=i);for(t=0;t<e.length;t++)pS(n,i=e[t])}else for(t=0;t<e.length;t++)this.flowOut(e[t])}},{key:"flowInDeps",value:function(e,t,i){return fS.create(this,function(e,t){i(e,t),t.destroy()}).append(t,e)}},{key:"flowOut",value:function(e){e.error?delete this._cache[e.id]:this._cache[e.id]||e.isScene||(this._cache[e.id]=e),e.complete=!0,fS.itemComplete(e)}},{key:"copyItemStates",value:function(e,t){if(t instanceof Array)for(var i=0;i<t.length;++i)t[i].states=e.states;else t.states=e.states}},{key:"getItem",value:function(e){var t=this._cache[e];return t&&t.alias&&(t=t.alias),t}},{key:"removeItem",value:function(e){var t=this._cache[e];t&&t.complete&&delete this._cache[e];return t}},{key:"clear",value:function(){for(var e in this._cache){var t=this._cache[e];delete this._cache[e],t.complete||(t.error=new Error("Canceled manually"),this.flowOut(t))}}}]),n}());_S.ItemState=dS,cc.Pipeline=_S;var vS="MD5Pipe",mS=/(\.[^.\n\\/]*)$/,yS=/([^/\\]*)\.[^\.]*$/;var gS=function(){function n(e,t,i){y(this,n),this.id=vS,this.async=!1,this.pipeline=null,this.md5AssetsMap=void 0,this.md5NativeAssetsMap=void 0,this.libraryBase=void 0,this.id=vS,this.async=!1,this.pipeline=null,this.md5AssetsMap=e,this.md5NativeAssetsMap=t,this.libraryBase=i}return l(n,[{key:"handle",value:function(e){var t=!1;return"ttf"===e.type&&(t=!0),e.url=this.transformURL(e.url,t),e}},{key:"transformURL",value:function(e,t){var i=function(e){var t=e.match(yS);return t?t[1]:""}(e);if(i){var n=(!e.match(this.libraryBase)?this.md5NativeAssetsMap:this.md5AssetsMap)[i];if(n)if(t){var r=cc.path.dirname(e),a=cc.path.basename(e);e="".concat(r,".").concat(n,"/").concat(a)}else{var s=!1;e=e.replace(mS,function(e,t){return s=!0,"."+n+t}),s||(e=e+"."+n)}}return e}}]),n}();gS.ID=vS,_S.MD5Pipe=gS;var bS,xS,SS=function(){function e(){y(this,e),this.jsons={}}return l(e,[{key:"load",value:function(e,t){t.length!==e.length&&cc.errorID(4915);for(var i=0;i<e.length;i++){var n=e[i],r=t[i];this.jsons[n]=r}}},{key:"retrieve",value:function(e){return this.jsons[e]||null}}]),e}(),wS=function(){function e(){y(this,e),this.contents={}}return l(e,[{key:"load",value:function(e,t){var i=t.data;i.length!==e.length&&cc.errorID(4915);for(var n=0;n<e.length;n++)this.contents[e[n]]={base:i[n][0],mipmaps:i[n][1]}}},{key:"retrieve",value:function(e){var t=this.contents[e];return t?{__type__:cc.js._getClassId(cc.Texture2D),content:t}:null}}]),e}(),TS=/\?/;function ES(e){return cc.game.config.noCache&&"string"==typeof e&&(TS.test(e)?e+="&_t="+(new Date-0):e+="?_t="+(new Date-0)),e}function CS(e,t){if(Array.isArray(e))for(var i=0,n=e.length;i<n;i++)CS(e[i],t);else if("object"===de(e))for(var r in e)CS(e[r],t),Number.isNaN(Number(r))||(e[t[r]]=e[r],delete e[r]);return null}(xS=bS=bS||{})[xS.Invalid=0]="Invalid",xS[xS.Removed=1]="Removed",xS[xS.Downloading=2]="Downloading",xS[xS.Loaded=3]="Loaded";var AS=function e(){y(this,e),this.unpacker=void 0,this.state=void 0,this.unpacker=null,this.state=bS.Invalid},kS={},RS={},OS={};function MS(e,t){return new Error("Can not retrieve "+e+" from packer "+t)}function IS(e){for(var t in RS=e)for(var i=e[t],n=0;n<i.length;n++){var r=i[n],a=1===i.length;lt(kS,r,t,a)}}function LS(n,r,a){var e=cc.AssetLibrary.getLibUrlNoExt(r)+".json";cc.loader.load({url:e,ignoreMaxConcurrency:!0},function(e,t){if(e)return D(4916,n),a(e);var i=BS(n,r,t);i?a(null,i):a(MS(n,r))})}function zS(e,t){var i=OS[e];i||((i=OS[e]=new AS).state=bS.Downloading),i.state!==bS.Loaded&&(i.unpacker=new SS,i.unpacker.load(RS[e],t),i.state=bS.Loaded)}function BS(e,t,i){var n=OS[t];if(n.state!==bS.Loaded){if("string"==typeof i&&(i=JSON.parse(i)),i.keys&&i.data){var r=i.keys;CS(i=i.data,r)}Array.isArray(i)?n.unpacker=new SS:i.type===Ze(vh)&&(n.unpacker=new wS),n.unpacker.load(RS[t],i),n.state=bS.Loaded}return n.unpacker.retrieve(e)}function PS(e){for(var t=bS.Invalid,i="",n=0;n<e.length;n++){var r=e[n],a=OS[r];if(a){var s=a.state;if(s===bS.Loaded)return r;t<s&&(t=s,i=r)}}return t!==bS.Invalid?i:e[0]}function DS(e,t){var i=e.uuid,n=kS[i];if(n){Array.isArray(n)&&(n=PS(n));var r=OS[n];if(r&&r.state===bS.Loaded){var a=r.unpacker.retrieve(i);return a||MS(i,n)}return r||(console.log("Create unpacker %s for %s",n,i),(r=OS[n]=new AS).state=bS.Downloading),LS(i,n,t),null}}var FS=Object.freeze({initPacks:IS,_loadNewPack:LS,_doPreload:zS,_doLoadNewPack:BS,_selectLoadedPack:PS,load:DS}),NS="SubPackPipe",US=/([^/\\]*)\.[^\.]*$/;var VS=Object.create(null),GS=function(){function n(t){y(this,n),this.id=NS,this.async=!1,this.pipeline=null;function e(e){var i=t[e];i.uuids&&i.uuids.forEach(function(e){var t=$x(e);t=t.split("@").map(function(e){return encodeURIComponent(e)}).join("@"),VS[t]=i.path})}for(var i in t)e(i)}return l(n,[{key:"handle",value:function(e){return e.url=this.transformURL(e.url),null}},{key:"transformURL",value:function(e){var t=function(e){var t=e.match(US);return t?t[1]:""}(e);if(t){var i=VS[t];if(i)return e.replace("res/raw-assets/",i+"raw-assets/")}return e}}]),n}();GS.ID=NS,_S.SubPackPipe=GS;var HS="",qS="",jS=ke(!0);function WS(e,t){this.url=e,this.type=t}var XS,YS={_uuidToAsset:{},loadAsset:function(n,r,e){if("string"!=typeof n)return ht(r,new Error("[AssetLibrary] uuid must be string"),null);var t={uuid:n,type:"uuid"};e&&e.existingAsset&&(t.existingAsset=e.existingAsset),cc.loader.load(t,function(e,t){if(e||!t)e=new Error("[AssetLibrary] loading JSON or dependencies failed: "+(e?e.message:"Unknown error"));else if(t.constructor===cc.SceneAsset){var i=cc.loader._getReferenceKey(n);t.scene.dependAssets=Yp(i)}r&&r(e,t)})},getLibUrlNoExt:function(e,t){return e=(e=$x(e)).split("@").map(function(e){return encodeURIComponent(e)}).join("@"),(t?qS+"assets/":HS)+e.slice(0,2)+"/"+e},_queryAssetInfoInEditor:function(e,t){t(new Error("Unable to load resource: EditorExtends is not defined."))},_getAssetInfoInRuntime:function(e,t){t=t||{url:null,raw:!1};var i=jS[e];return i&&!Ge(i.type,cc.Asset)?(t.url=qS+i.url,t.raw=!0):(t.url=this.getLibUrlNoExt(e)+".json",t.raw=!1),t},_uuidInSettings:function(e){return e in jS},queryAssetInfo:function(e,t){var i=this._getAssetInfoInRuntime(e);t(null,i.url,i.raw)},parseUuidInEditor:function(e){},loadJson:function(e,r){var a=""+((new Date).getTime()+Math.random()),t={uuid:a,type:"uuid",content:e,skips:[cc.loader.assetLoader.id,cc.loader.downloader.id]};cc.loader.load(t,function(e,t){if(e)e=new Error("[AssetLibrary] loading JSON or dependencies failed: "+e.message);else{if(t.constructor===cc.SceneAsset){var i=cc.loader._getReferenceKey(a);t.scene.dependAssets=Yp(i)}if(function(e){return e&&(e.constructor===cc.SceneAsset||e instanceof cc.Scene)}(t)){var n=cc.loader._getReferenceKey(a);cc.loader.removeItem(n)}}t._uuid="",r&&r(e,t)})},getAssetByUuid:function(e){return YS._uuidToAsset[e]||null},init:function(e){var t=e.libraryPath;t=t.replace(/\\/g,"/"),HS=cc.path.stripSep(t)+"/",qS=e.rawAssetsBase;var i=e.md5AssetsMap;if(i&&i.import){var n=0,r=ke(!0),a=i.import;for(n=0;n<a.length;n+=2){r[$x(a[n]).split("@").map(function(e){return encodeURIComponent(e)}).join("@")]=a[n+1]}var s=ke(!0);for(a=i["raw-assets"],n=0;n<a.length;n+=2){s[$x(a[n]).split("@").map(function(e){return encodeURIComponent(e)}).join("@")]=a[n+1]}var o=new gS(r,s,HS);cc.loader.insertPipeAfter(cc.loader.assetLoader,o),cc.loader.md5Pipe=o}if(e.subpackages){var l=new GS(e.subpackages);cc.loader.insertPipeAfter(cc.loader.assetLoader,l),cc.loader.subPackPipe=l}var c=cc.loader._assetTables;for(var u in c)c[u].reset();var h=e.rawAssets;if(h)for(var f in h){var d=h[f];for(var p in d){var _=d[p],v=_[0],m=_[1],y=Qe(m);if(y){jS[p]=new WS(f+"/"+v,y);var g=1===_[2];c[f]||(c[f]=new rS),c[f].add(v,p,y,!g)}else cc.error("Cannot get",m)}}e.packedAssets&&IS(e.packedAssets),cc.url._init(e.mountPaths&&e.mountPaths.assets||qS+"assets")}};cc.AssetLibrary=YS,P2("AssetLibrary",YS);var QS,KS,ZS,JS,$S,ew=P2("Font",ho("cc.Font")(XS=function(){function e(){return y(this,e),x(this,g(e).apply(this,arguments))}return p(e,Mu),e}())||XS);cc.Font=ew;var tw,iw,nw,rw,aw,sw,ow,lw,cw=P2("TTFFont",(QS=ho("cc.TTFFont"),KS=fo({type:cc.String,override:!0}),QS(($S=m((JS=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"_fontFamily",$S,u(t)),t}return p(a,ew),l(a,[{key:"_nativeAsset",get:function(){return this._fontFamily},set:function(e){this._fontFamily=e||"Arial"}}]),a}()).prototype,"_fontFamily",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),m(JS.prototype,"_nativeAsset",[KS],Object.getOwnPropertyDescriptor(JS.prototype,"_nativeAsset"),JS.prototype),ZS=JS))||ZS));cc.TTFFont=cw;var uw,hw=P2("BitmapFont",(tw=ho("cc.BitmapFont"),iw=fo({type:Eh}),tw((aw=m((rw=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"fntDataStr",aw,u(t)),v(t,"spriteFrame",sw,u(t)),v(t,"fontSize",ow,u(t)),v(t,"fntConfig",lw,u(t)),t}return p(a,ew),a}()).prototype,"fntDataStr",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),sw=m(rw.prototype,"spriteFrame",[iw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ow=m(rw.prototype,"fontSize",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),lw=m(rw.prototype,"fntConfig",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),nw=rw))||nw));cc.BitmapFont=hw;var fw=P2("LabelAtlas",ho("cc.LabelAtlas")(uw=function(){function e(){return y(this,e),x(this,g(e).apply(this,arguments))}return p(e,hw),e}())||uw);cc.LabelAtlas=fw;var dw="AssetLoader",pw=[],_w=function(){function e(){y(this,e),this.id=dw,this.async=!0,this.pipeline=null}return l(e,[{key:"handle",value:function(a,s){var o=a.uuid;if(!o)return a.content||null;cc.AssetLibrary.queryAssetInfo(o,function(e,t,i){if(e)s(e);else if(a.url=a.rawUrl=t,a.isRawAsset=i){var n=K(t).toLowerCase();if(!n)return void s(new Error(G(4931,o,t)));n=n.substr(1);var r=fS.getQueue(a);pw[0]={queueId:a.queueId,id:t,url:t,type:n,error:null,alias:a,complete:!0},r.append(pw),a.type=n,s(null,a.content)}else a.type="uuid",s(null,a.content)})}}]),e}();function vw(e,t){var i=e.url,n=cc.loader.getXMLHttpRequest(),r="Load binary data failed: "+i;n.open("GET",i,!0),n.responseType="arraybuffer",n.onload=function(){var e=n.response;e?t(null,e):t({status:n.status,errorMessage:r+"(no response)"})},n.onerror=function(){t({status:n.status,errorMessage:r+"(error)"})},n.ontimeout=function(){t({status:n.status,errorMessage:r+"(time out)"})},n.send(null)}function mw(e,t){var i=e.url;i=ES(i);var n=cc.loader.getXMLHttpRequest(),r="Load text file failed: "+i;n.open("GET",i,!0),n.overrideMimeType&&n.overrideMimeType("text/plain; charset=utf-8"),n.onload=function(){4===n.readyState?200===n.status||0===n.status?t(null,n.responseText):t({status:n.status,errorMessage:r+"(wrong status)"}):t({status:n.status,errorMessage:r+"(wrong readyState)"})},n.onerror=function(){t({status:n.status,errorMessage:r+"(error)"})},n.ontimeout=function(){t({status:n.status,errorMessage:r+"(time out)"})},n.send(null)}function yw(){return null}function gw(e,t,i){var n=e.url,r=document,a=document.createElement("script");function s(){a.parentNode&&a.parentNode.removeChild(a),a.removeEventListener("load",s,!1),a.removeEventListener("error",o,!1),t(null,n)}function o(){a.parentNode&&a.parentNode.removeChild(a),a.removeEventListener("load",s,!1),a.removeEventListener("error",o,!1),t(new Error(G(4928,n)))}a.async=!!i,a.src=ES(n),a.addEventListener("load",s,!1),a.addEventListener("error",o,!1),r.body.appendChild(a)}function bw(e,t,i,n){void 0===i&&(i=!0);var r=ES(e.url);function a(){n.removeEventListener("load",a),n.removeEventListener("error",s),n.id=e.id,t(null,n)}function s(){n.removeEventListener("load",a),n.removeEventListener("error",s),"https:"!==window.location.protocol&&n.crossOrigin&&"anonymous"===n.crossOrigin.toLowerCase()?bw(e,t,!1,n):t(new Error(G(4930,r)))}if(n=n||new Image,i&&"file:"!==window.location.protocol?n.crossOrigin="anonymous":n.crossOrigin=null,n.complete&&0<n.naturalWidth&&n.src===r)return n;n.addEventListener("load",a),n.addEventListener("error",s),n.src=r}_w.ID=dw,_S.AssetLoader=_w;var xw={js:gw,png:bw,jpg:bw,bmp:bw,jpeg:bw,gif:bw,ico:bw,tiff:bw,webp:function(e,t,i,n){return cc.sys.capabilities.webp?bw(e,t,i,n):new Error(G(4929,e.url))},image:bw,pvr:vw,pkm:vw,txt:mw,xml:mw,vsh:mw,fsh:mw,atlas:mw,tmx:mw,tsx:mw,json:mw,ExportJson:mw,plist:mw,fnt:mw,font:yw,eot:yw,ttf:yw,woff:yw,svg:yw,ttc:yw,uuid:function(e,t){var i=DS(e,t);return void 0===i?this.extMap.json(e,t):i||void 0},binary:vw,bin:vw,default:mw},Sw="Downloader",ww=P2("Downloader",function(){function t(e){y(this,t),this.id=Sw,this.async=!0,this.pipeline=null,this.extMap=void 0,this._curConcurrent=0,this._loadQueue=[],this._subpackages={},this.extMap=Ne(e,xw)}return l(t,[{key:"addHandlers",value:function(e){Ne(this.extMap,e)}},{key:"_handleLoadQueue",value:function(){for(;this._curConcurrent<cc.macro.DOWNLOAD_MAX_CONCURRENT;){var e=this._loadQueue.shift();if(!e)break;var t=this.handle(e.item,e.callback);void 0!==t&&(t instanceof Error?e.callback(t):e.callback(null,t))}}},{key:"handle",value:function(e,i){var n=this,t=this.extMap[e.type]||this.extMap.default,r=void 0;if(this._curConcurrent<cc.macro.DOWNLOAD_MAX_CONCURRENT){if(this._curConcurrent++,void 0!==(r=t.call(this,e,function(e,t){n._curConcurrent=Math.max(0,n._curConcurrent-1),n._handleLoadQueue(),i&&i(e,t)})))return this._curConcurrent=Math.max(0,this._curConcurrent-1),this._handleLoadQueue(),r}else if(e.ignoreMaxConcurrency){if(void 0!==(r=t.call(this,e,i)))return r}else this._loadQueue.push({item:e,callback:i})}},{key:"loadSubpackage",value:function(e,t){var i=this._subpackages[e];i?i.loaded?t&&t():gw({url:i.path},function(e){e||(i.loaded=!0),t&&t(e)}):t&&t(new Error("Can't find subpackage ".concat(e)))}}]),t}());ww.ID=Sw,ww.PackDownloader=FS,_S.Downloader=ww;var Tw=function(){function e(){y(this,e),this._isSupportDOMParser=void 0,this._parser=void 0,window.DOMParser?(this._isSupportDOMParser=!0,this._parser=new DOMParser):(this._isSupportDOMParser=!1,this._parser=null)}return l(e,[{key:"parse",value:function(e){return this._parseXML(e)}},{key:"_parseXML",value:function(e){var t;return this._isSupportDOMParser?t=this._parser.parseFromString(e,"text/xml"):((t=new ActiveXObject("Microsoft.XMLDOM")).async="false",t.loadXML(e)),t}}]),e}(),Ew=new(function(){function e(){return y(this,e),x(this,g(e).apply(this,arguments))}return p(e,Tw),l(e,[{key:"parse",value:function(e){var t=this._parseXML(e),i=t.documentElement;if("plist"!==i.tagName)return cc.warnID(5100),{};for(var n=null,r=0,a=i.childNodes.length;r<a&&1!==(n=i.childNodes[r]).nodeType;r++);return t=null,this._parseNode(n)}},{key:"_parseNode",value:function(e){var t=null,i=e.tagName;if("dict"===i)t=this._parseDict(e);else if("array"===i)t=this._parseArray(e);else if("string"===i)if(1===e.childNodes.length)t=e.firstChild.nodeValue;else{t="";for(var n=0;n<e.childNodes.length;n++)t+=e.childNodes[n].nodeValue}else"false"===i?t=!1:"true"===i?t=!0:"real"===i?t=parseFloat(e.firstChild.nodeValue):"integer"===i&&(t=parseInt(e.firstChild.nodeValue,10));return t}},{key:"_parseArray",value:function(e){for(var t=[],i=0,n=e.childNodes.length;i<n;i++){var r=e.childNodes[i];1===r.nodeType&&t.push(this._parseNode(r))}return t}},{key:"_parseDict",value:function(e){for(var t={},i=null,n=0,r=e.childNodes.length;n<r;n++){var a=e.childNodes[n];1===a.nodeType&&("key"===a.tagName?i=a.firstChild.nodeValue:t[i]=this._parseNode(a))}return t}}]),e}());function Cw(e){return e&&(e[0]&&"cc.Scene"===e[0].__type__||e[1]&&"cc.Scene"===e[1].__type__||e[0]&&"cc.Prefab"===e[0].__type__)}function Aw(t,i){var e,n;if("string"==typeof t.content)try{if((e=JSON.parse(t.content)).keys&&e.data){var r=e.keys;CS(e=e.data,r)}}catch(e){return new Error(G(4923,t.id,e.stack))}else{if("object"!==de(t.content))return new Error(G(4924));e=t.content}if(null==e)return new Error(G(4923,t.id));var a=Cw(e);n=a?cc._MissingScript.safeFindClass:function(e){var t=Qe(e);return t||(cc.warnID(4903,e),Object)};var s,o=cc.deserialize.Details.pool.get();try{s=cc.deserialize(e,o,{classFinder:n,target:t.existingAsset,customEnv:t})}catch(e){return cc.deserialize.Details.pool.put(o),console.error(e),new Error("Failed to load asset ".concat(t.id,", exception occurs during deserialization: ").concat(e.stack,"."))}s._uuid=t.uuid;var l=function(e,t,i){var n=t.deferredLoadRaw;return n?e instanceof cc.Asset&&e.constructor.preventDeferredLoadDependents&&(n=!1):i&&(e instanceof cc.SceneAsset||e instanceof cc.Prefab)&&(n=e.asyncLoadAssets),n}(s,t,a),c=function(e,t,i,n){var r,a,s,o=i.uuidList,l=i.uuidObjList,c=i.uuidPropList,u=i._stillUseUrl,h=e.dependKeys=[];if(n)for(r=[],a=0;a<o.length;a++){s=o[a];var f=l[a],d=c[a],p=cc.AssetLibrary._getAssetInfoInRuntime(s);if(p.raw){var _=p.url;f[d]=_,h.push(_)}else r.push({type:"uuid",uuid:s,deferredLoadRaw:!0,_owner:f,_ownerProp:d,_stillUseUrl:u[a]})}else{for(r=new Array(o.length),a=0;a<o.length;a++)s=o[a],r[a]={type:"uuid",uuid:s,_owner:l[a],_ownerProp:c[a],_stillUseUrl:u[a]};t._native&&!t.constructor.preventPreloadNativeObject&&r.push({url:t.nativeUrl,_owner:t,_ownerProp:"_nativeAsset"})}return r}(t,s,o,l);cc.deserialize.Details.pool.put(o);function u(t,e){if(!t&&e.onLoaded)try{e.onLoaded()}catch(e){t=e}i(t,e)}if(0===c.length)return u(null,s);!function(e,t,d,p,_){t.content=d;var v=t.dependKeys;e.flowInDeps(t,p,function(e,t){var i,n=t.map;for(var r in n)(i=n[r]).uuid&&i.content&&(i.content._uuid=i.uuid);for(var a=0;a<p.length;a++){var s=function(e){var t=e.content;this._stillUseUrl&&(t=t?t.nativeUrl:e.rawUrl),this._owner[this._ownerProp]=t,e.uuid!==d._uuid&&v.indexOf(e.id)<0&&v.push(e.id)},o=p[a],l=o.uuid,c=o.url;o._owner,o._ownerProp;if(i=n[c]){var u=o;if(i.complete||i.content){if(i.error)cc._throw(i.error);else s.call(u,i)}else{var h=fS.getQueue(i),f=h._callbackTable[l];f?f.unshift(s,u):h.addListener(l,s,u)}}}_(e,d)})}(this.pipeline,t,s,c,u)}Aw.isSceneObj=Cw;var kw=null,Rw="BES bswy:->@",Ow={},Mw=-1,Iw=[],Lw=6e4;function zw(){for(var e=!0,t=Date.now(),i=Iw.length-1;0<=i;i--){var n=Iw[i],r=n.fontFamilyName;if(t-n.startTime>Lw)cc.warnID(4933,r),n.callback(null,r),Iw.splice(i,1);else{var a=n.refWidth;kw.font="40px "+r,a!==Qs(kw,Rw)?(Iw.splice(i,1),n.callback(null,r)):e=!1}}e&&(clearInterval(Mw),Mw=-1)}function Bw(e,t){var i=e.url,n=function(e){var t=e.lastIndexOf(".ttf");if(-1===t)return e;var i,n=e.lastIndexOf("/");i=-1===n?e.substring(0,t)+"_LABEL":e.substring(n+1,t)+"_LABEL";-1!==i.indexOf(" ")&&(i='"'+i+'"');return i}(i);if(Ow[n])return n;if(!kw){var r=document.createElement("canvas");r.width=100,r.height=100,kw=r.getContext("2d")}var a="40px "+n;kw.font=a;var s=Qs(kw,Rw),o=document.createElement("style");o.type="text/css";var l="";isNaN(n-0)?l+="@font-face { font-family:"+n+"; src:":l+="@font-face { font-family:'"+n+"'; src:",l+="url('"+i+"');",o.textContent=l+"}",document.body.appendChild(o);var c=document.createElement("div"),u=c.style;u.fontFamily=n,c.innerHTML=".",u.position="absolute",u.left="-100px",u.top="-100px",document.body.appendChild(c);var h={fontFamilyName:n,refWidth:s,callback:t,startTime:Date.now()};Iw.push(h),Ow[n]=o,-1===Mw&&(Mw=setInterval(zw,100))}function Pw(t){if("string"!=typeof t.content)return new Error("JSON Loader: Input item doesn't contain string content");try{return JSON.parse(t.content)}catch(e){return new Error("JSON Loader: Parse json ["+t.id+"] failed : "+e)}}function Dw(e){if(e._owner instanceof cc.Asset)return null;var t=e.content;var i=e.rawUrl,n=e.imageAsset||new zu;return n._uuid=e.uuid,n._url=i,n._setRawAsset(i,!1),n._nativeAsset=t,n}function Fw(e,t){if(e._owner instanceof cc.Asset)return null;var i=new cc.AudioClip;return i._setRawAsset(e.rawUrl,!1),i._nativeAsset=e.content,i}function Nw(e){return e.load?e.load(e.content):e.content}function Uw(e,t){return e[t]<<8|e[t+1]}var Vw={png:Dw,jpg:Dw,bmp:Dw,jpeg:Dw,gif:Dw,ico:Dw,tiff:Dw,webp:Dw,image:Dw,pvr:function(e){var t=e.content instanceof ArrayBuffer?e.content:e.content.buffer,i=new Int32Array(t,0,13);if(55727696===i[0]){var n=i[7],r=i[6],a=i[12]+52;return t=t.slice(a,t.byteLength),{_data:new Uint8Array(t),_compressed:!0,width:n,height:r}}if(559044176!==i[11])return new Error("Invalid magic number in PVR header");var s=i[0],o=i[1],l=i[2];return t=t.slice(s,t.byteLength),{_data:new Uint8Array(t),_compressed:!0,width:l,height:o}},pkm:function(e){var t=e.content instanceof ArrayBuffer?e.content:e.content.buffer,i=new Uint8Array(t),n=Uw(i,6);if(0!==n&&1!==n&&3!==n)return new Error("Invalid magic number in ETC header");var r=Uw(i,12),a=Uw(i,14);return Uw(i,8),Uw(i,10),t=t.slice(16,t.byteLength),{_data:new Uint8Array(t),_compressed:!0,width:r,height:a}},mp3:Fw,ogg:Fw,wav:Fw,m4a:Fw,json:Pw,ExportJson:Pw,plist:function(e){if("string"!=typeof e.content)return new Error("Plist Loader: Input item doesn't contain string content");var t=Ew.parse(e.content);return t||new Error("Plist Loader: Parse ["+e.id+"] failed")},uuid:Aw,prefab:Aw,fire:Aw,scene:Aw,binary:Nw,bin:Nw,font:Bw,eot:Bw,ttf:Bw,woff:Bw,svg:Bw,ttc:Bw,default:function(){return null}},Gw=P2("Loader",function(){function t(e){y(this,t),this.id="Loader",this.async=!0,this.pipeline=null,this.extMap=void 0,this.extMap=Ne(e,Vw)}return l(t,[{key:"addHandlers",value:function(e){this.extMap=Ne(this.extMap,e)}},{key:"handle",value:function(e,t){return(this.extMap[e.type]||this.extMap.default).call(this,e,t)}}]),t}());Gw.ID="Loader",_S.Loader=Gw;var Hw=Object.create(null);function qw(){return window.XMLHttpRequest?new window.XMLHttpRequest:new ActiveXObject("MSXML2.XMLHTTP")}Hw.assets=new rS,Hw.internal=new rS;var jw={url:null,raw:!1};function Ww(e){var t,i,n;if("object"===de(e)){if((i=e).url)return i;t=e.uuid}else i={},t=e;return n=i.type?"uuid"===i.type:cc.AssetLibrary._uuidInSettings(t),cc.AssetLibrary._getAssetInfoInRuntime(t,jw),i.url=n?jw.url:t,jw.url&&"uuid"===i.type&&jw.raw?(i.type=null,i.isRawAsset=!0):n||(i.isRawAsset=!0),i}var Xw=[],Yw=[],Qw=function(){function r(){var e;y(this,r);var t=new _w,i=new ww,n=new Gw;return(e=x(this,g(r).call(this,[t,i,n]))).getXMLHttpRequest=void 0,e.assetLoader=void 0,e.md5Pipe=void 0,e.downloader=void 0,e.loader=void 0,e.onProgress=void 0,e._assetTables=void 0,e._autoReleaseSetting=void 0,e._releasedAssetChecker_DEBUG=void 0,e.getXMLHttpRequest=qw,e.assetLoader=t,e.md5Pipe=null,e.downloader=i,e.loader=n,e.onProgress=null,e._assetTables=Hw,e._autoReleaseSetting=ke(!0),e}return p(r,_S),l(r,[{key:"init",value:function(e){}},{key:"addDownloadHandlers",value:function(e){this.downloader.addHandlers(e)}},{key:"addLoadHandlers",value:function(e){this.loader.addHandlers(e)}},{key:"load",value:function(e,t,n){void 0===n&&(n=t,t=this.onProgress||null);var r,a=this,s=!1;e instanceof Array||(e=e?(s=!0,[e]):[]);for(var i=Xw.length=0;i<e.length;++i){var o=e[i];if(o&&o.id&&(cc.warnID(4920,o.id),o.uuid||o.url||(o.url=o.id)),(r=Ww(o)).url||r.uuid){var l=this._cache[r.url];Xw.push(l||r)}}var c=fS.create(this,t,function(t,i){ht(function(){if(n){if(s){var e=r.url;n.call(a,i.getError(e),i.getContent(e))}else n.call(a,t,i);n=null}i.destroy()})});fS.initQueueDeps(c),c.append(Xw),Xw.length=0}},{key:"flowInDeps",value:function(i,e,n){for(var t=Yw.length=0;t<e.length;++t){var r=Ww(e[t]);if(r.url||r.uuid){var a=this._cache[r.url];a?Yw.push(a):Yw.push(r)}}var s=fS.create(this,i?function(e,t,i){s._ownerQueue&&s._ownerQueue.onProgress&&s._ownerQueue._childOnProgress(i)}:null,function(e,t){n(e,t),i&&i.deps&&(i.deps.length=0),t.destroy()});if(i){var o=fS.getQueue(i);s._ownerQueue=o._ownerQueue||o}var l=s.append(Yw,i);return Yw.length=0,l}},{key:"loadRes",value:function(e,t,i,n,r){5!==arguments.length&&(r=n,n=i,i="assets");var a=this._parseLoadResArgs(t,n,r);t=a.type,n=a.onProgress,r=a.onComplete;var s=this,o=s._getResUuid(e,t,i,!0);o?this.load({type:"uuid",uuid:o},n,function(e,t){t&&s.setAutoReleaseRecursively(o,!1),r&&r(e,t)}):s._urlNotFound(e,t,r)}},{key:"loadResDir",value:function(e,t,i,n,l){if(5!==arguments.length&&(l=n,n=i,i="assets"),Hw[i]){var r=this._parseLoadResArgs(t,n,l);t=r.type,n=r.onProgress,l=r.onComplete;var a=[],s=Hw[i].getUuidArray(e,t,a);this._loadResUuids(s,n,function(e,t,i){for(var n=t.length,r=0;r<n;++r)if(t[r]instanceof cc.SpriteAtlas){var a=t[r].getSpriteFrames();for(var s in a){var o=a[s];t.push(o),i&&i.push("".concat(i[r],"/").concat(o.name))}}l&&l(e,t,i)},a)}}},{key:"loadResArray",value:function(e,t,i,n,r){5!==arguments.length&&(r=n,n=i,i="assets");var a=this._parseLoadResArgs(t,n,r);t=a.type,n=a.onProgress,r=a.onComplete;for(var s=[],o=0;o<e.length;o++){var l=e[o],c=this._getResUuid(l,t,i,!0);if(!c)return void this._urlNotFound(l,t,r);s.push(c)}this._loadResUuids(s,n,r)}},{key:"getRes",value:function(e,t){var i=this._cache[e];if(!i){var n=this._getResUuid(e,t,null,!0);if(!n)return null;var r=this._getReferenceKey(n);i=this._cache[r]}return i&&i.alias&&(i=i.alias),i&&i.complete?i.content:null}},{key:"getResCount",value:function(){return Object.keys(this._cache).length}},{key:"getDependsRecursively",value:function(e){if(e){var t=this._getReferenceKey(e),i=Yp(t);return i.push(t),i}return[]}},{key:"release",value:function(e){if(Array.isArray(e))for(var t=0;t<e.length;t++){var i=e[t];this.release(i)}else if(e){var n=this._getReferenceKey(e),r=this.getItem(n);if(r){this.removeItem(n);if((e=r.content)instanceof cc.Asset){var a=e.nativeUrl;a&&this.release(a),e.destroy()}0}}}},{key:"releaseAsset",value:function(e){var t=e._uuid;t&&this.release(t)}},{key:"releaseRes",value:function(e,t,i){var n=this._getResUuid(e,t,i,!0);n?this.release(n):cc.errorID(4914,e)}},{key:"releaseResDir",value:function(e,t,i){if(Hw[i=i||"assets"])for(var n=Hw[i].getUuidArray(e,t),r=0;r<n.length;r++){var a=n[r];this.release(a)}}},{key:"releaseAll",value:function(){for(var e in this._cache)this.release(e)}},{key:"removeItem",value:function(e){var t=_S.prototype.removeItem.call(this,e);return delete this._autoReleaseSetting[e],t}},{key:"setAutoRelease",value:function(e,t){var i=this._getReferenceKey(e);i&&(this._autoReleaseSetting[i]=!!t)}},{key:"setAutoReleaseRecursively",value:function(e,t){t=!!t;var i=this._getReferenceKey(e);if(i){this._autoReleaseSetting[i]=t;for(var n=Yp(i),r=0;r<n.length;r++){var a=n[r];this._autoReleaseSetting[a]=t}}else 0}},{key:"isAutoRelease",value:function(e){var t=this._getReferenceKey(e);return!!t&&!!this._autoReleaseSetting[t]}},{key:"_getResUuid",value:function(e,t,i,n){var r=Hw[i=i||"assets"];if(!e||!r)return null;var a=e.indexOf("?");-1!==a&&(e=e.substr(0,a));var s=r.getUuid(e,t);if(!s){var o=cc.path.extname(e);o&&(e=e.slice(0,-o.length),(s=r.getUuid(e,t))&&!n&&cc.warnID(4901,e,o))}return s}},{key:"_getReferenceKey",value:function(e){var t;return"object"===de(e)?t=e._uuid||null:"string"==typeof e&&(t=this._getResUuid(e,null,null,!0)||e),t?(cc.AssetLibrary._getAssetInfoInRuntime(t,jw),this._cache[jw.url]?jw.url:t):(cc.warnID(4800,e),t)}},{key:"_urlNotFound",value:function(t,i,n){ht(function(){t=cc.url.normalize(t);var e="".concat(i?Re(i):"Asset",' in "resources/').concat(t,'" does not exist.');n&&n(new Error(e),[])})}},{key:"_parseLoadResArgs",value:function(e,t,i){if(void 0===i){var n=Ge(e,cc.RawAsset);t?(i=t,n&&(t=this.onProgress||null)):void 0!==t||n||(i=e,t=this.onProgress||null,e=null),void 0===t||n||(t=e,e=null)}return{type:e,onProgress:t,onComplete:i}}},{key:"_loadResUuids",value:function(e,t,l,c){if(0<e.length){var u=this,h=e.map(function(e){return{type:"uuid",uuid:e}});this.load(h,t,function(e,t){if(l){for(var i=[],n=c&&[],r=0;r<h.length;++r){var a=h[r].uuid,s=u._getReferenceKey(a),o=t.getContent(s);o&&(u.setAutoReleaseRecursively(a,!1),i.push(o),n&&n.push(c[r]))}c?l(e,i,n):l(e,i)}})}else l&&ht(function(){c?l(null,[],[]):l(null,[])})}}]),r}(),Kw=P2("loader",cc.loader=new Qw);var Zw,Jw,$w,eT,tT,iT,nT,rT=Object.freeze({loadImage:function(e,i,n){V(!!e,3103);var r=Kw.getRes(e);return r?r.loaded?i&&i.call(n,null,r):r.once("load",function(){i&&i.call(n,null,r)},n):(r=new zu,Kw.load({url:e,imageAsset:r},function(e,t){if(e)return i&&i.call(n,e||new Error("Unknown error")),r;i&&i.call(n,null,t)})),r},cacheImage:function(e,t){if(e&&t){var i=new zu(t),n={id:e,url:e,error:null,content:i,complete:!1};return Kw.flowOut(n),i}},postLoadImage:function(i,n){i.loaded?n&&n():i.nativeUrl?Kw.load({url:i.nativeUrl,skips:i.isCompressed?void 0:["Loader"]},function(e,t){t&&(i.loaded||(i._nativeAsset=t)),n&&n(e)}):n&&n()}});P2("textureUtil",rT);var aT,sT,oT,lT,cT,uT,hT,fT,dT,pT=P2("Skeleton",(Zw=ho("cc.Skeleton"),Jw=fo([Ot]),$w=fo([zn]),Zw((iT=m((tT=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"_joints",iT,u(t)),v(t,"_bindposes",nT,u(t)),t._bindTRS=[],t._hash=0,t}return p(a,Mu),l(a,[{key:"onLoaded",value:function(){this.bindposes=this._bindposes}},{key:"bindposes",get:function(){return this._bindposes},set:function(e){this._bindposes=e,this._bindTRS=e.map(function(e){var t=new Fi,i=new hn,n=new Fi;return zn.toRTS(e,i,t,n),{position:t,rotation:i,scale:n}}),this._hash=au(this.bindposes.reduce(function(e,t){return e+t.m00.toPrecision(2)+" "+t.m01.toPrecision(2)+" "+t.m02.toPrecision(2)+" "+t.m03.toPrecision(2)+" "+t.m04.toPrecision(2)+" "+t.m05.toPrecision(2)+" "+t.m06.toPrecision(2)+" "+t.m07.toPrecision(2)+" "+t.m08.toPrecision(2)+" "+t.m09.toPrecision(2)+" "+t.m10.toPrecision(2)+" "+t.m11.toPrecision(2)+" "+t.m12.toPrecision(2)+" "+t.m13.toPrecision(2)+" "+t.m14.toPrecision(2)+" "+t.m15.toPrecision(2)+"\n"},""),666)}},{key:"bindTRS",get:function(){return this._bindTRS}},{key:"joints",get:function(){return this._joints},set:function(e){this._joints=e}},{key:"hash",get:function(){return this._hash}}]),a}()).prototype,"_joints",[Jw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),nT=m(tT.prototype,"_bindposes",[$w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),eT=tT))||eT));cc.Skeleton=pT,cc.textureUtil=rT;var _T,vT,mT,yT,gT,bT,xT,ST,wT,TT,ET,CT,AT,kT=P2("EventHandler",(aT=ho("cc.ClickEvent"),sT=fo(cc.Node),aT((m((lT=function(){function o(){y(this,o),v(this,"target",cT,this),v(this,"component",uT,this),v(this,"_componentId",hT,this),v(this,"handler",fT,this),v(this,"customEventData",dT,this)}return l(o,[{key:"emit",value:function(e){var t=this.target;if(cc.isValid(t)){this._genCompIdIfNeeded();var i=cc.js._getClassById(this._componentId),n=t.getComponent(i);if(cc.isValid(n)){var r=n[this.handler];"function"==typeof r&&(null!=this.customEventData&&""!==this.customEventData&&(e=e.slice()).push(this.customEventData),r.apply(n,e))}}}},{key:"_compName2Id",value:function(e){var t=cc.js.getClassByName(e);return cc.js._getClassId(t)}},{key:"_compId2Name",value:function(e){var t=cc.js._getClassById(e);return cc.js.getClassName(t)}},{key:"_genCompIdIfNeeded",value:function(){this._componentId||(this._componentName=this.component,this.component="")}},{key:"_componentName",get:function(){return this._genCompIdIfNeeded(),this._compId2Name(this._componentId)},set:function(e){this._componentId=this._compName2Id(e)}}],[{key:"emitEvents",value:function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];for(var r=0,a=e.length;r<a;r++){var s=e[r];s instanceof o&&s.emit(i)}}}]),o}()).prototype,"_componentName",[fo],Object.getOwnPropertyDescriptor(lT.prototype,"_componentName"),lT.prototype),cT=m(lT.prototype,"target",[sT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),uT=m(lT.prototype,"component",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),hT=m(lT.prototype,"_componentId",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),fT=m(lT.prototype,"handler",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),dT=m(lT.prototype,"customEventData",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),oT=lT))||oT));cc.Component.EventHandler=kT;var RT,OT=(_T=ho("cc.MissingClass"),vT=fo({visible:!1,editorOnly:!0}),_T((gT=m((yT=function e(){y(this,e),v(this,"_$erialized",gT,this)}).prototype,"_$erialized",[vT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),mT=yT))||mT),MT=P2("MissingScript",(bT=ho("cc.MissingScript"),xT=So("packages://inspector/inspectors/comps/missing-script.js"),ST=fo({serializable:!1}),wT=fo({visible:!1,editorOnly:!0}),bT(TT=xT((CT=m((ET=function(){function n(){var e;return y(this,n),v(e=x(this,g(n).call(this)),"compiled",CT,u(e)),v(e,"_$erialized",AT,u(e)),e}return p(n,Bv),l(n,null,[{key:"safeFindClass",value:function(e,t){var i=Qe(e);return i||(e?(cc.deserialize.reportMissingClass(e),n.getMissingWrapper(e,t)):null)}},{key:"getMissingWrapper",value:function(e,t){return t.node&&(/^[0-9a-zA-Z+/]{23}$/.test(e)||tt.test(e))?n:OT}}]),l(n,[{key:"onLoad",value:function(){cc.warnID(4600,this.node.name)}}]),n}()).prototype,"compiled",[ST],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),AT=m(ET.prototype,"_$erialized",[wT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),TT=ET))||TT)||TT));cc._MissingScript=MT;var IT=[U_.TOUCH_START,U_.TOUCH_END,U_.TOUCH_MOVE,U_.MOUSE_DOWN,U_.MOUSE_MOVE,U_.MOUSE_UP,U_.MOUSE_ENTER,U_.MOUSE_LEAVE,U_.MOUSE_WHEEL];function LT(e){e.propagationStopped=!0}var zT,BT,PT,DT,FT,NT,UT,VT,GT,HT,qT,jT=P2("BlockInputEventsComponent",ho("cc.BlockInputEventsComponent")(RT=yo("Components/BlockInputEvents")(RT=function(){function e(){return y(this,e),x(this,g(e).apply(this,arguments))}return p(e,Bv),l(e,[{key:"onEnable",value:function(){for(var e=0;e<IT.length;e++)this.node.on(IT[e],LT,this)}},{key:"onDisable",value:function(){for(var e=0;e<IT.length;e++)this.node.off(IT[e],LT,this)}}]),e}())||RT)||RT);cc.BlockInputEventsComponent=jT;var WT,XT,YT,QT,KT,ZT,JT,$T,eE,tE,iE,nE,rE,aE,sE,oE,lE,cE,uE,hE,fE,dE,pE,_E,vE,mE=new Mi,yE=new Mi,gE=new zn,bE=new zn,xE=new zn,SE=P2("UITransformComponent",(zT=ho("cc.UITransformComponent"),BT=go(110),PT=yo("UI/UITransform"),DT=fo({displayOrder:0}),FT=fo({displayOrder:1}),zT(NT=BT(NT=PT(NT=vo((qT=HT=function(){function h(){var e,t;y(this,h);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(h)).call.apply(e,[this].concat(n))),"_contentSize",VT,u(t)),v(t,"_anchorPoint",GT,u(t)),t}return p(h,Bv),l(h,[{key:"__preload",value:function(){this.node.uiTransfromComp=this}},{key:"onDestroy",value:function(){this.node.uiTransfromComp=null}},{key:"setContentSize",value:function(e,t){var i=this._contentSize;if(void 0===t){if((e=e).width===i.width&&e.height===i.height)return;0,i.width=e.width,i.height=e.height}else{if(e===i.width&&t===i.height)return;0,i.width=e,i.height=t}this.node.emit(U_.SIZE_CHANGED)}},{key:"setAnchorPoint",value:function(e,t){var i=this._anchorPoint;if(void 0===t){if((e=e).x===i.x&&e.y===i.y)return;i.x=e.x,i.y=e.y}else{if(e===i.x&&t===i.y)return;i.x=e,i.y=t}this.node.emit(U_.ANCHOR_CHANGED,this._anchorPoint)}},{key:"isHit",value:function(e,t){var i=this._contentSize.width,n=this._contentSize.height,r=mE,a=yE,s=-1,o=this.node.getComponent(cc.UIRenderComponent);s=o?o.visibility:this._getVisibility();var l=Yb.root.ui.getScreen(s);if(l){l.node.getWorldRT(gE);var c=gE.m12,u=gE.m13,h=cc.visibleRect.center;if(gE.m12=h.x-(gE.m00*c+gE.m04*u),gE.m13=h.y-(gE.m01*c+gE.m05*u),zn.invert(gE,gE),Mi.transformMat4(r,e,gE),this.node.getWorldMatrix(xE),zn.invert(gE,xE),Mi.transformMat4(a,r,gE),a.x+=this._anchorPoint.x*i,a.y+=this._anchorPoint.y*n,0<=a.x&&0<=a.y&&a.x<=i&&a.y<=n){if(t&&t.mask){for(var f=t.mask,d=this.node,p=0;d&&p<f.index;++p,d=d.parent);if(d!==f.node)return!(t.mask=null);var _=d.getComponent(cc.MaskComponent);return!_||!_.enabledInHierarchy||_.isHit(r)}return!0}return!1}}},{key:"convertToNodeSpaceAR",value:function(e,t){return this.node.getWorldMatrix(xE),zn.invert(gE,xE),t=t||new Fi,Fi.transformMat4(t,e,gE)}},{key:"convertToWorldSpaceAR",value:function(e,t){return this.node.getWorldMatrix(xE),t=t||new Fi,Fi.transformMat4(t,e,xE)}},{key:"getBoundingBox",value:function(){zn.fromRTS(bE,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var e=this._contentSize.width,t=this._contentSize.height,i=new Zn(-this._anchorPoint.x*e,-this._anchorPoint.y*t,e,t);return i.transformMat4(bE),i}},{key:"getBoundingBoxToWorld",value:function(){return this.node.parent?(this.node.parent.getWorldMatrix(xE),this.getBoundingBoxTo(xE)):this.getBoundingBox()}},{key:"getBoundingBoxTo",value:function(e){zn.fromRTS(bE,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var t=this._contentSize.width,i=this._contentSize.height,n=new Zn(-this._anchorPoint.x*t,-this._anchorPoint.y*i,t,i);if(zn.multiply(xE,e,bE),n.transformMat4(xE),!this.node.children)return n;var r=this.node.children,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}var l=o;if(l&&l.active){var c=l.getComponent(h);if(c){var u=c.getBoundingBoxTo(e);u&&Zn.union(n,n,u)}}}return n}},{key:"getComputeAABB",value:function(e){var t=this.getBoundingBoxToWorld(),i=t.center.x,n=t.center.y,r=this.node.worldPosition.z,a=t.width/2,s=t.height/2;if(null==e)return new cs(i,n,r,a,s,.01);cs.set(e,i,n,r,a,s,.01)}},{key:"_getVisibility",value:function(){for(var e=-1,t=this.node;t;){if(t){var i=t.getComponent("cc.CanvasComponent");if(i){e=i.visibility;break}}t=t.parent}return e}},{key:"contentSize",get:function(){return this._contentSize},set:function(e){this._contentSize.equals(e)||(this._contentSize.set(e),this.node.emit(U_.SIZE_CHANGED))}},{key:"width",get:function(){return this._contentSize.width},set:function(e){this._contentSize.width!==e&&(this._contentSize.width=e,this.node.emit(U_.SIZE_CHANGED))}},{key:"height",get:function(){return this._contentSize.height},set:function(e){this.contentSize.height!==e&&(this._contentSize.height=e,this.node.emit(U_.SIZE_CHANGED))}},{key:"anchorPoint",get:function(){return this._anchorPoint},set:function(e){this._anchorPoint.equals(e)||(this._anchorPoint.set(e),this.node.emit(U_.ANCHOR_CHANGED,this._anchorPoint))}},{key:"anchorX",get:function(){return this._anchorPoint.x},set:function(e){this._anchorPoint.x!==e&&(this._anchorPoint.x=e,this.node.emit(U_.ANCHOR_CHANGED,this._anchorPoint))}},{key:"anchorY",get:function(){return this._anchorPoint.y},set:function(e){this._anchorPoint.y!==e&&(this._anchorPoint.y=e,this.node.emit(U_.ANCHOR_CHANGED,this._anchorPoint))}}]),h}(),HT.EventType=U_,m((UT=qT).prototype,"contentSize",[DT],Object.getOwnPropertyDescriptor(UT.prototype,"contentSize"),UT.prototype),m(UT.prototype,"anchorPoint",[FT],Object.getOwnPropertyDescriptor(UT.prototype,"anchorPoint"),UT.prototype),VT=m(UT.prototype,"_contentSize",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new jn(100,100)}}),GT=m(UT.prototype,"_anchorPoint",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Mi(.5,.5)}}),NT=UT))||NT)||NT)||NT)||NT));cc.UITransformComponent=SE;var wE,TE,EE,CE,AE,kE,RE,OE,ME,IE,LE,zE,BE,PE,DE,FE,NE,UE,VE,GE,HE=vt({ORTHO:0,PERSPECTIVE:1}),qE=vt({SKYBOX:z_|Vc.DEPTH_STENCIL,SOLID_COLOR:Vc.ALL,DEPTH_ONLY:Vc.DEPTH_STENCIL,DONT_CLEAR:Vc.NONE}),jE=P2("CameraComponent",(WT=ho("cc.CameraComponent"),XT=yo("Components/Camera"),YT=fo({type:HE}),QT=fo({type:qE}),KT=fo({visible:!1}),ZT=fo({type:qh.BitMask}),JT=fo({type:oh}),WT($T=XT($T=vo((vE=_E=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"_projection",tE,u(t)),v(t,"_priority",iE,u(t)),v(t,"_fov",nE,u(t)),v(t,"_orthoHeight",rE,u(t)),v(t,"_near",aE,u(t)),v(t,"_far",sE,u(t)),v(t,"_color",oE,u(t)),v(t,"_depth",lE,u(t)),v(t,"_stencil",cE,u(t)),v(t,"_clearFlags",uE,u(t)),v(t,"_rect",hE,u(t)),v(t,"_screenScale",fE,u(t)),v(t,"_visibility",dE,u(t)),v(t,"_targetTexture",pE,u(t)),t._camera=null,t}return p(a,Bv),l(a,[{key:"onLoad",value:function(){cc.director.on(cc.Director.EVENT_AFTER_SCENE_LAUNCH,this.onSceneChanged,this)}},{key:"onEnable",value:function(){this._camera||this._createCamera(),this._camera.enabled=!0}},{key:"onDisable",value:function(){this._camera&&(this._camera.enabled=!1)}},{key:"onDestroy",value:function(){this._camera&&(this._getRenderScene().destroyCamera(this._camera),this._camera=null),this._targetTexture&&this._targetTexture.off("resize")}},{key:"screenPointToRay",value:function(e,t,i){return i=i||Ja.create(),this._camera&&this._camera.screenPointToRay(i,e,t),i}},{key:"worldToScreen",value:function(e,t){return t=t||new Fi,this._camera&&this._camera.worldToScreen(t,e),t}},{key:"screenToWorld",value:function(e,t){return t=t||this.node.getWorldPosition(),this._camera&&this._camera.screenToWorld(t,e),t}},{key:"_createCamera",value:function(){var t=this;if(this.node.scene){var e=this._getRenderScene();if(!this._camera||!e.cameras.find(function(e){return e===t._camera})){if(this._camera=e.createCamera({name:this.node.name,node:this.node,projection:this._projection,window:cc.director.root&&cc.director.root.tempWindow,priority:this._priority}),this._camera){this._camera.viewport=this._rect,this._camera.fov=mi(this._fov),this._camera.orthoHeight=this._orthoHeight,this._camera.nearClip=this._near,this._camera.farClip=this._far;var i=this._color.x,n=this._color.y,r=this._color.z,a=this._color.w;this._camera.clearColor={r:i,g:n,b:r,a:a},this._camera.clearDepth=this._depth,this._camera.clearStencil=this._stencil,this._camera.clearFlag=this._clearFlags,this._camera.visibility=this._visibility}this._updateTargetTexture()}}}},{key:"onSceneChanged",value:function(e){this._camera&&this._camera.scene!==e.renderScene&&(this._createCamera(),this._camera.enabled=!0)}},{key:"_chechTargetTextureEvent",value:function(e){var t=this;e&&e.off("resize"),this._targetTexture&&this._targetTexture.on("resize",function(e){t._camera&&t._camera.setFixedSize(e.width,e.height)},this)}},{key:"_updateTargetTexture",value:function(){if(this._camera&&this._targetTexture){var e=this._targetTexture.getGFXWindow();this._camera.changeTargetWindow(e),this._camera.setFixedSize(e.width,e.height)}}},{key:"projection",get:function(){return this._projection},set:function(e){this._projection=e,this._camera&&(this._camera.projectionType=e)}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e,this._camera&&(this._camera.priority=e)}},{key:"fov",get:function(){return this._fov},set:function(e){this._fov=e,this._camera&&(this._camera.fov=mi(e))}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(e){this._orthoHeight=e,this._camera&&(this._camera.orthoHeight=e)}},{key:"near",get:function(){return this._near},set:function(e){this._near=e,this._camera&&(this._camera.nearClip=e)}},{key:"far",get:function(){return this._far},set:function(e){this._far=e,this._camera&&(this._camera.farClip=e)}},{key:"color",get:function(){return this._color},set:function(e){this._color.set(e),this._camera&&(this._camera.clearColor.r=e.x,this._camera.clearColor.g=e.y,this._camera.clearColor.b=e.z,this._camera.clearColor.a=e.w)}},{key:"depth",get:function(){return this._depth},set:function(e){this._depth=e,this._camera&&(this._camera.clearDepth=e)}},{key:"stencil",get:function(){return this._stencil},set:function(e){this._stencil=e,this._camera&&(this._camera.clearStencil=e)}},{key:"clearFlags",get:function(){return this._clearFlags},set:function(e){this._clearFlags=e,this._camera&&(this._camera.clearFlag=e)}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect=e,this._camera&&(this._camera.viewport=e)}},{key:"screenScale",get:function(){return this._screenScale},set:function(e){this._screenScale=e,this._camera&&(this._camera.screenScale=e)}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e,this._camera&&(this._camera.visibility=e)}},{key:"targetTexture",get:function(){return this._targetTexture},set:function(e){if(this._targetTexture!==e){var t=this._targetTexture;this._targetTexture=e,this._chechTargetTextureEvent(t),this._updateTargetTexture(),!e&&this._camera&&(this._camera.changeTargetWindow(null),this._camera.isWindowSize=!0)}}}]),a}(),_E.ProjectionType=HE,_E.CameraClearFlag=qE,tE=m((eE=vE).prototype,"_projection",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return HE.PERSPECTIVE}}),iE=m(eE.prototype,"_priority",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),nE=m(eE.prototype,"_fov",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 45}}),rE=m(eE.prototype,"_orthoHeight",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),aE=m(eE.prototype,"_near",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),sE=m(eE.prototype,"_far",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),oE=m(eE.prototype,"_color",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rr("#334C78")}}),lE=m(eE.prototype,"_depth",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),cE=m(eE.prototype,"_stencil",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),uE=m(eE.prototype,"_clearFlags",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qE.SOLID_COLOR}}),hE=m(eE.prototype,"_rect",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Zn(0,0,1,1)}}),fE=m(eE.prototype,"_screenScale",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),dE=m(eE.prototype,"_visibility",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lf}}),pE=m(eE.prototype,"_targetTexture",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),m(eE.prototype,"projection",[YT],Object.getOwnPropertyDescriptor(eE.prototype,"projection"),eE.prototype),m(eE.prototype,"priority",[fo],Object.getOwnPropertyDescriptor(eE.prototype,"priority"),eE.prototype),m(eE.prototype,"fov",[fo],Object.getOwnPropertyDescriptor(eE.prototype,"fov"),eE.prototype),m(eE.prototype,"orthoHeight",[fo],Object.getOwnPropertyDescriptor(eE.prototype,"orthoHeight"),eE.prototype),m(eE.prototype,"near",[fo],Object.getOwnPropertyDescriptor(eE.prototype,"near"),eE.prototype),m(eE.prototype,"far",[fo],Object.getOwnPropertyDescriptor(eE.prototype,"far"),eE.prototype),m(eE.prototype,"color",[fo],Object.getOwnPropertyDescriptor(eE.prototype,"color"),eE.prototype),m(eE.prototype,"depth",[fo],Object.getOwnPropertyDescriptor(eE.prototype,"depth"),eE.prototype),m(eE.prototype,"stencil",[fo],Object.getOwnPropertyDescriptor(eE.prototype,"stencil"),eE.prototype),m(eE.prototype,"clearFlags",[QT],Object.getOwnPropertyDescriptor(eE.prototype,"clearFlags"),eE.prototype),m(eE.prototype,"rect",[fo],Object.getOwnPropertyDescriptor(eE.prototype,"rect"),eE.prototype),m(eE.prototype,"screenScale",[KT],Object.getOwnPropertyDescriptor(eE.prototype,"screenScale"),eE.prototype),m(eE.prototype,"visibility",[ZT],Object.getOwnPropertyDescriptor(eE.prototype,"visibility"),eE.prototype),m(eE.prototype,"targetTexture",[JT],Object.getOwnPropertyDescriptor(eE.prototype,"targetTexture"),eE.prototype),$T=eE))||$T)||$T)||$T)),WE=new Fi,XE=vt({SOLID_COLOR:Vc.ALL,DEPTH_STENCIL:Vc.DEPTH_STENCIL,NONE:Vc.NONE}),YE=vt({OVERLAY:0,INTERSPERSE:1}),QE=P2("CanvasComponent",(wE=ho("cc.CanvasComponent"),TE=go(100),EE=mo(SE),CE=yo("UI/Canvas"),AE=fo({type:XE}),kE=fo({type:YE}),RE=fo(),OE=fo({type:oh}),ME=fo({type:XE}),IE=fo({type:YE}),wE(LE=TE(LE=EE(LE=CE(LE=vo(LE=bo((m((zE=function(){function t(){var e;return y(this,t),v(e=x(this,g(t).call(this)),"_priority",BE,u(e)),v(e,"_targetTexture",PE,u(e)),v(e,"_clearFlag",DE,u(e)),v(e,"_color",FE,u(e)),v(e,"_renderMode",NE,u(e)),e._thisOnResized=void 0,e._camera=null,e._pos=new Fi,e._thisOnResized=e.alignWithScreen.bind(u(e)),e}return p(t,Bv),l(t,[{key:"clearFlag",get:function(){return this._clearFlag},set:function(e){this._clearFlag=e,this._camera&&(this._camera.clearFlag=this._clearFlag)}},{key:"color",get:function(){return this._color},set:function(e){rr.copy(this._color,e),this._camera&&(this._camera.clearColor.r=e.r/255,this._camera.clearColor.g=e.g/255,this._camera.clearColor.b=e.b/255,this._camera.clearColor.a=e.a/255)}},{key:"renderMode",get:function(){return this._renderMode},set:function(e){this._renderMode=e,this._camera&&(this._camera.priority=this._getViewPriority())}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e,this._camera&&(this._camera.priority=this._getViewPriority())}},{key:"targetTexture",get:function(){return this._targetTexture},set:function(e){if(this._targetTexture!==e){var t=this._targetTexture;this._targetTexture=e,this._chechTargetTextureEvent(t),this._updateTargetTexture()}}},{key:"visibility",get:function(){return this._camera?this._camera.view.visibility:-1}},{key:"camera",get:function(){return this._camera}}]),l(t,[{key:"__preload",value:function(){var e=new Sm("UICamera_"+this.node.name);e.setPosition(0,0,1e3),this._camera=Yb.root.ui.renderScene.createCamera({name:"ui_"+this.node.name,node:e,projection:jE.ProjectionType.ORTHO,priority:this._getViewPriority(),flows:["UIFlow"]}),this._camera.fov=45,this._camera.clearFlag=this.clearFlag,this.color=this._color;var t=Yb.root.device;if(this._camera.resize(t.width,t.height),this._targetTexture){var i=this._targetTexture.getGFXWindow();this._camera.changeTargetWindow(i),this._camera.setFixedSize(i.width,i.height)}nx.on("design-resolution-changed",this._thisOnResized),this.alignWithScreen(),Yb.root.ui.addScreen(this)}},{key:"onDestroy",value:function(){this._camera&&Yb.root.ui.renderScene.destroyCamera(this._camera),this._targetTexture&&this._targetTexture.off("resize"),nx.off("design-resolution-changed",this._thisOnResized),Yb.root.ui.removeScreen(this)}},{key:"alignWithScreen",value:function(){var e,t;this.node.getPosition(this._pos);var i=gl;e=i,t=nx.getDesignResolutionSize();var n=0,r=0;if(nx.getResolutionPolicy()===ix.NO_BORDER&&(n=.5*(t.width-i.width),r=.5*(t.height-i.height)),Fi.set(WE,.5*i.width+n,.5*i.height+r,0),this._pos.equals(WE)||this.node.setPosition(WE),this.node.width!==e.width&&(this.node.width=e.width),this.node.height!==e.height&&(this.node.height=e.height),this.node.getWorldPosition(WE),this._camera){var a=nx.getVisibleSize();this._camera.resize(a.width,a.height),this._camera.orthoHeight=this._camera.height/2,this._camera.node.setPosition(WE.x,WE.y,999),this._camera.update()}}},{key:"_chechTargetTextureEvent",value:function(e){var t=this;e&&e.off("resize"),this._targetTexture&&this._targetTexture.on("resize",function(e){t._camera&&t._camera.setFixedSize(e.width,e.height)},this)}},{key:"_updateTargetTexture",value:function(){if(this._camera)if(this._targetTexture){var e=this._targetTexture.getGFXWindow();this._camera.changeTargetWindow(e),this._camera.setFixedSize(e.width,e.height)}else this._camera.changeTargetWindow(),this._camera.isWindowSize=!0}},{key:"_getViewPriority",value:function(){return this._renderMode===YE.OVERLAY?this._priority|1<<30:this._priority}}]),t}()).prototype,"clearFlag",[AE],Object.getOwnPropertyDescriptor(zE.prototype,"clearFlag"),zE.prototype),m(zE.prototype,"color",[fo],Object.getOwnPropertyDescriptor(zE.prototype,"color"),zE.prototype),m(zE.prototype,"renderMode",[kE],Object.getOwnPropertyDescriptor(zE.prototype,"renderMode"),zE.prototype),m(zE.prototype,"priority",[RE],Object.getOwnPropertyDescriptor(zE.prototype,"priority"),zE.prototype),m(zE.prototype,"targetTexture",[OE],Object.getOwnPropertyDescriptor(zE.prototype,"targetTexture"),zE.prototype),BE=m(zE.prototype,"_priority",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),PE=m(zE.prototype,"_targetTexture",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),DE=m(zE.prototype,"_clearFlag",[ME],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return XE.NONE}}),FE=m(zE.prototype,"_color",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rr(0,0,0,0)}}),NE=m(zE.prototype,"_renderMode",[IE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return YE.OVERLAY}}),LE=zE))||LE)||LE)||LE)||LE)||LE)||LE));cc.CanvasComponent=QE;function KE(){y(this,KE),this.material=null,this.vertexCount=0,this.indiceCount=0}var ZE,JE,$E,eC,tC,iC,nC,rC,aC,sC,oC,lC,cC,uC,hC,fC,dC,pC,_C,vC,mC,yC,gC,bC,xC,SC=P2("UIComponent",ho("cc.UIComponent")(UE=go(110)(UE=bo(UE=vo((m((VE=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"_priority",GE,u(t)),t._followScreen=null,t._lastParent=null,t}return p(a,Bv),l(a,[{key:"onEnable",value:function(){this._lastParent=this.node.parent,this._updateVisibility(),this._lastParent&&this.node.on(U_.CHILD_REMOVED,this._parentChanged,this),(this.node._uiComp=this)._sortSiblings()}},{key:"onDisable",value:function(){this._cancelEventFromParent(),this.node._uiComp===this&&(this.node._uiComp=null)}},{key:"updateAssembler",value:function(e){}},{key:"postUpdateAssembler",value:function(e){}},{key:"setVisibility",value:function(e){}},{key:"_setScreen",value:function(e){this._followScreen=e}},{key:"_parentChanged",value:function(e){return e===this.node&&(this._updateVisibility(),this._cancelEventFromParent(),this._lastParent=this.node.parent,this._sortSiblings(),!0)}},{key:"_sortSiblings",value:function(){var e=this.node.parent&&this.node.parent.children;e&&e.sort(function(e,t){var i=e._uiComp,n=t._uiComp;return(i?i.priority:0)-(n?n.priority:0)})}},{key:"_updateVisibility",value:function(){for(var e=this.node;e;){if(e){var t=e.getComponent(QE);if(t){this._followScreen=t;break}}e=e.parent}}},{key:"_cancelEventFromParent",value:function(){this._lastParent&&(this._lastParent.off(U_.CHILD_REMOVED,this._parentChanged,this),this._lastParent=null),this._followScreen=null}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority!==e&&(this._priority=e,this._sortSiblings())}},{key:"visibility",get:function(){return this._screen?this._screen.visibility:-1}},{key:"_screen",get:function(){return this._followScreen}}]),a}()).prototype,"priority",[fo],Object.getOwnPropertyDescriptor(VE.prototype,"priority"),VE.prototype),GE=m(VE.prototype,"_priority",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),UE=VE))||UE)||UE)||UE)||UE),wC=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n)))).vData=null,t.uvDirty=!0,t.vertDirty=!0,t._datas=[],t._indices=[],t._pivotX=0,t._pivotY=0,t._width=0,t._height=0,t}return p(a,KE),l(a,[{key:"updateSizeNPivot",value:function(e,t,i,n){e===this._width&&t===this._height&&i===this._pivotX&&n===this._pivotY||(this._width=e,this._height=t,this._pivotX=i,this._pivotY=n,this.vertDirty=!0)}},{key:"clear",value:function(){this._datas.length=0,this._indices.length=0,this._pivotX=0,this._pivotY=0,this._width=0,this._height=0,this.uvDirty=!0,this.vertDirty=!0,this.material=null,this.vertexCount=0,this.indiceCount=0}},{key:"dataLength",get:function(){return this._datas.length},set:function(e){var t=this._datas;if(t.length!==e){var i=t.length,n=0;for(n=e;n<i;n++)EC.free(t[n]);for(n=i;n<e;n++)t[n]=EC.alloc();t.length=e}}},{key:"datas",get:function(){return this._datas}}],[{key:"add",value:function(){return CC.add()}},{key:"remove",value:function(e){var t=CC.data.indexOf(e);-1!==t&&(CC.data[t].clear(),CC.removeAt(t))}}]),a}(),TC=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n)))).vData=new Float32Array(2304*Float32Array.BYTES_PER_ELEMENT),t.iData=new Uint16Array(1536),t.vertexStart=0,t.indiceStart=0,t.byteStart=0,t.byteCount=0,t._formatByte=9*Float32Array.BYTES_PER_ELEMENT,t}return p(a,KE),l(a,[{key:"request",value:function(e,t){var i=this.byteCount+e*this._formatByte,n=this.indiceCount+t;if(65535<e+this.vertexCount)return!1;var r=this.vData.byteLength,a=this.iData.length,s=this.vData.length,o=this.iData.length;if(r<i||a<n){for(;r<i||a<n;)r=4*(s*=2),a=o*=2;var l=new Float32Array(this.vData.buffer);this.vData=new Float32Array(s),this.vData.set(l,0);var c=new Uint16Array(this.iData.buffer);this.iData=new Uint16Array(o),this.iData.set(c,0)}return this.vertexCount+=e,this.indiceCount+=t,this.byteCount=i,!0}},{key:"reset",value:function(){this.vertexCount=0,this.indiceCount=0,this.byteCount=0,this.vertexStart=0,this.indiceStart=0,this.byteStart=0}}]),a}(),EC=new ks(function(){return{x:0,y:0,z:0,u:0,v:0,color:rr.WHITE.clone()}},128),CC=new Rs(function(){return new wC},32),AC=fo,kC=P2("RenderableComponent",(ZE=ho("cc.RenderableComponent"),JE=AC({type:[cp]}),$E=AC({type:cp,displayName:"Materials"}),eC=AC({visible:!1}),ZE((nC=m((iC=function(){function t(){var e;return y(this,t),v(e=x(this,g(t).call(this)),"_materials",nC,u(e)),v(e,"_visFlags",rC,u(e)),e}return p(t,Bv),l(t,[{key:"getMaterial",value:function(e,t,i){var n=1<arguments.length&&void 0!==t&&t,r=2<arguments.length&&void 0!==i&&i,a=this._materials[e];if(!a)return null;var s=cp.getInstantiatedMaterial(a,this,n);return s!==this._materials[e]&&this.setMaterial(s,e,r||!n),this._materials[e]}},{key:"getSharedMaterial",value:function(e){return e<0||e>=this._materials.length?null:this._materials[e]}},{key:"setMaterial",value:function(e,t,i){var n=!(2<arguments.length&&void 0!==i)||i;this._materials[t]=e,n&&this._onMaterialModified(t,e)}},{key:"_getModel",value:function(){return null}},{key:"recreateModel",value:function(){}},{key:"_onMaterialModified",value:function(e,t){}},{key:"_onRebuildPSO",value:function(e,t){}},{key:"_clearMaterials",value:function(){}},{key:"_onVisiblityChange",value:function(e){}},{key:"sharedMaterials",get:function(){return this._materials.slice()},set:function(e){for(var t=0;t<e.length;t++)e[t]!==this._materials[t]&&this.setMaterial(e[t],t);if(e.length<this._materials.length){for(var i=e.length;i<this._materials.length;i++)this.setMaterial(null,i);this._materials.splice(e.length)}}},{key:"materials",get:function(){for(var e=0;e<this._materials.length;e++)this._materials[e]=this.getMaterial(e);return this._materials},set:function(e){var t=e.length-this._materials.length;if(0<t)this._materials=this._materials.concat(new Array(t).fill(null));else if(t<0){for(var i=-t;i<this._materials.length;++i)this.setMaterial(null,i);this._materials=this._materials.splice(-t)}}},{key:"material",get:function(){return this.getMaterial(0)},set:function(e){1===this._materials.length&&this._materials[0]===e||this.setMaterial(e,0)}},{key:"sharedMaterial",get:function(){return this.getSharedMaterial(0)}},{key:"visibility",get:function(){return this._visFlags},set:function(e){this._visFlags=e,this._onVisiblityChange(e)}}]),t}()).prototype,"_materials",[JE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),rC=m(iC.prototype,"_visFlags",[AC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qh.Enum.NONE}}),m(iC.prototype,"sharedMaterials",[$E],Object.getOwnPropertyDescriptor(iC.prototype,"sharedMaterials"),iC.prototype),m(iC.prototype,"visibility",[eC],Object.getOwnPropertyDescriptor(iC.prototype,"visibility"),iC.prototype),tC=iC))||tC));mt(ic),(xC=bC=bC||P2("InstanceMaterialType",{}))[xC.ADDCOLOR=0]="ADDCOLOR",xC[xC.ADDCOLORANDTEXTURE=1]="ADDCOLORANDTEXTURE";var RC,OC,MC,IC,LC,zC,BC,PC,DC,FC,NC,UC,VC,GC=P2("UIRenderComponent",(aC=ho("cc.UIRenderComponent"),sC=go(110),oC=mo(SE),lC=fo({type:ic,displayOrder:0}),cC=fo({type:ic,displayOrder:1}),uC=fo({displayOrder:2}),hC=fo({type:cp,displayOrder:3}),aC(fC=sC(fC=oC(fC=vo((gC=yC=function(){function s(){var e,t;y(this,s);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(s)).call.apply(e,[this].concat(n))),"_srcBlendFactor",pC,u(t)),v(t,"_dstBlendFactor",_C,u(t)),v(t,"_color",vC,u(t)),v(t,"_sharedMaterial",mC,u(t)),t._assembler=null,t._postAssembler=null,t._renderData=null,t._renderDataFlag=!0,t._renderFlag=!0,t._material=null,t._instanceMaterialType=bC.ADDCOLORANDTEXTURE,t._blendTemplate={blendState:{targets:[{blendSrc:ic.SRC_ALPHA,blendDst:ic.ONE_MINUS_SRC_ALPHA}]},depthStencilState:{},rasterizerState:{}},t}return p(s,SC),l(s,[{key:"__preload",value:function(){this._instanceMaterial(),this._flushAssembler&&this._flushAssembler(),this._updateColor()}},{key:"onEnable",value:function(){_(g(s.prototype),"onEnable",this).call(this),this.node.on(U_.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.on(U_.SIZE_CHANGED,this._nodeStateChange,this),this._renderFlag=this._canRender()}},{key:"onDisable",value:function(){_(g(s.prototype),"onDisable",this).call(this),this.node.off(U_.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.off(U_.SIZE_CHANGED,this._nodeStateChange,this),this._renderFlag=!1}},{key:"onDestroy",value:function(){this.destroyRenderData(),this._material&&this._material.destroy(),this._updateMaterial(null),this._renderData=null}},{key:"markForUpdateRenderData",value:function(e){var t=!(0<arguments.length&&void 0!==e)||e;if(this._renderFlag=this._canRender(),t&&this._renderFlag){var i=this._renderData;i&&(i.vertDirty=!0),this._renderDataFlag=t}else t||(this._renderDataFlag=t)}},{key:"requestRenderData",value:function(){var e=wC.add();return this._renderData=e}},{key:"destroyRenderData",value:function(){this._renderData&&(wC.remove(this._renderData),this._renderData=null)}},{key:"updateAssembler",value:function(e){_(g(s.prototype),"updateAssembler",this).call(this,e),this._renderFlag&&(this._checkAndUpdateRenderData(),this._render(e))}},{key:"postUpdateAssembler",value:function(e){_(g(s.prototype),"postUpdateAssembler",this).call(this,e),this._renderFlag&&this._postRender(e)}},{key:"_render",value:function(e){}},{key:"_postRender",value:function(e){}},{key:"_checkAndUpdateRenderData",value:function(){this._renderDataFlag&&(this._assembler.updateRenderData(this),this._renderDataFlag=!1)}},{key:"_canRender",value:function(){return null!==this.material&&this.enabled&&this.enabledInHierarchy}},{key:"_postCanRender",value:function(){}},{key:"_updateColor",value:function(){this._assembler&&this._assembler.updateColor&&this._assembler.updateColor(this)}},{key:"_updateMaterial",value:function(e){this._material=e,this._updateBlendFunc()}},{key:"_updateBlendFunc",value:function(){if(this._material){var e=this._blendTemplate.blendState.targets[0];e.blendDst===this._dstBlendFactor&&e.blendSrc===this._srcBlendFactor||(e.blendDst=this._dstBlendFactor,e.blendSrc=this._srcBlendFactor,this._blendTemplate.depthStencilState=this._material.passes[0].depthStencilState,this._blendTemplate.rasterizerState=this._material.passes[0].rasterizerState,this._material.overridePipelineStates(this._blendTemplate,0))}}},{key:"_nodeStateChange",value:function(e){this._renderData&&this.markForUpdateRenderData();var t=this.node.children,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r.getComponent(s);a&&a.markForUpdateRenderData()}}},{key:"_instanceMaterial",value:function(){var e=null;if(this._sharedMaterial)e=cp.getInstantiatedMaterial(this._sharedMaterial,new kC,!1);else switch(this._instanceMaterialType){case bC.ADDCOLOR:e=cp.getInstantiatedMaterial(cc.builtinResMgr.get("ui-base-material"),new kC,!1);break;case bC.ADDCOLORANDTEXTURE:e=cp.getInstantiatedMaterial(cc.builtinResMgr.get("ui-sprite-material"),new kC,!1)}this._updateMaterial(e)}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(e){this._srcBlendFactor!==e&&(this._srcBlendFactor=e,this._updateBlendFunc())}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(e){this._dstBlendFactor!==e&&(this._dstBlendFactor=e,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateColor(),this.markForUpdateRenderData())}},{key:"sharedMaterial",get:function(){return this._sharedMaterial},set:function(e){this._sharedMaterial!==e&&(this._sharedMaterial=e,this._instanceMaterial&&this._instanceMaterial())}},{key:"material",get:function(){return this._material||this._instanceMaterial&&this._instanceMaterial(),this._material}},{key:"renderData",get:function(){return this._renderData}}]),s}(),yC.BlendState=ic,yC.Assembler=null,yC.PostAssembler=null,m((dC=gC).prototype,"srcBlendFactor",[lC],Object.getOwnPropertyDescriptor(dC.prototype,"srcBlendFactor"),dC.prototype),m(dC.prototype,"dstBlendFactor",[cC],Object.getOwnPropertyDescriptor(dC.prototype,"dstBlendFactor"),dC.prototype),m(dC.prototype,"color",[uC],Object.getOwnPropertyDescriptor(dC.prototype,"color"),dC.prototype),m(dC.prototype,"sharedMaterial",[hC],Object.getOwnPropertyDescriptor(dC.prototype,"sharedMaterial"),dC.prototype),pC=m(dC.prototype,"_srcBlendFactor",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ic.SRC_ALPHA}}),_C=m(dC.prototype,"_dstBlendFactor",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ic.ONE_MINUS_SRC_ALPHA}}),vC=m(dC.prototype,"_color",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rr.WHITE.clone()}}),mC=m(dC.prototype,"_sharedMaterial",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),fC=dC))||fC)||fC)||fC)||fC));cc.UIRenderComponent=GC;var HC,qC,jC,WC,XC,YC,QC,KC,ZC,JC,$C,eA,tA,iA,nA,rA,aA,sA,oA,lA,cA,uA,hA,fA,dA,pA,_A,vA,mA,yA,gA,bA,xA,SA,wA,TA,EA,CA,AA,kA,RA,OA,MA,IA,LA,zA,BA,PA,DA,FA,NA,UA,VA,GA,HA,qA,jA,WA,XA,YA,QA,KA,ZA,JA,$A,ek,tk,ik,nk,rk,ak,sk,ok,lk,ck,uk=vt({OFF:0,ON:1}),hk=P2("ModelComponent",(RC=ho("cc.ModelComponent"),OC=go(100),MC=yo("Components/Model"),IC=fo({type:Fh}),LC=fo({type:uk}),RC(zC=OC(zC=MC(zC=vo((VC=UC=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))))._model=null,v(t,"_enableDynamicBatching",PC,u(t)),v(t,"_mesh",DC,u(t)),v(t,"_shadowCastingMode",FC,u(t)),v(t,"_receiveShadows",NC,u(t)),t}return p(a,kC),l(a,[{key:"onLoad",value:function(){this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()}},{key:"onEnable",value:function(){this._model&&(this._model.inited||this._updateModels(),this._model.enabled=!0)}},{key:"onDisable",value:function(){this._model&&(this._model.enabled=!1)}},{key:"onDestroy",value:function(){this._model&&(this._getRenderScene().destroyModel(this._model),this._model=null)}},{key:"_getModel",value:function(){return this._model}},{key:"recreateModel",value:function(){this.isValid&&(this._model&&(this._model.destroy(),this._model.scene.destroyModel(this._model),this._model=null),this._updateModels())}},{key:"_updateModels",value:function(){if(this.enabledInHierarchy&&this._mesh&&(this._model&&this._model.inited?this._model.destroy():this._createModel(),this._model.createBoundingShape(this._mesh.minPosition,this._mesh.maxPosition),this._updateModelParams(),this._model&&(this._model.enabled=!0,this._model.isDynamicBatching=this._enableDynamicBatching,this._enableDynamicBatching))){this._mesh.hasFlatBuffers||this._mesh.createFlatBuffers();for(var e=0;e<this._model.subModels.length;++e)for(var t=this._model.subModels[e],i=0;i<t.passes.length;++i){var n=t.passes[i];n.batchedBuffer||n.createBatchedBuffer()}}}},{key:"_createModel",value:function(){if(this.node.scene){var e=this._getRenderScene();this._model=e.createModel(this._getModelConstructor(),this.node),this._model.visFlags=this.visibility}}},{key:"_getModelConstructor",value:function(){return vf}},{key:"_updateModelParams",value:function(){if(this._mesh&&this._model){this.node.hasChangedFlags=this._model.transform.hasChangedFlags=$v.POSITION;for(var e=this._mesh?this._mesh.subMeshCount:0,t=0;t<e;++t){var i=this.getSharedMaterial(t),n=this._mesh.renderingMesh;if(n){var r=n.getSubmesh(t);r&&this._model.initSubModel(t,r,i||this._getBuiltinMaterial())}}}}},{key:"_onMaterialModified",value:function(e,t){if(null!=this._model&&(this._onRebuildPSO(e,t||this._getBuiltinMaterial()),this._enableDynamicBatching&&t))for(var i=0;i<t.passes.length;++i){var n=t.passes[i];n.batchedBuffer||n.createBatchedBuffer()}}},{key:"_onRebuildPSO",value:function(e,t){this._model&&this._model.setSubModelMaterial(e,t)}},{key:"_onMeshChanged",value:function(e){}},{key:"_clearMaterials",value:function(){if(null!=this._model)for(var e=0;e<this._model.subModelNum;++e)this._onMaterialModified(e,null)}},{key:"_getBuiltinMaterial",value:function(){return kd.get("missing-material")}},{key:"_onVisiblityChange",value:function(e){this._model&&(this._model.visFlags=e)}},{key:"_updateCastShadow",value:function(){this._model&&(this._shadowCastingMode===uk.OFF?this._model.castShadow=!1:this._shadowCastingMode===uk.ON?this._model.castShadow=!0:console.warn("ShadowCastingMode ".concat(this._shadowCastingMode," is not supported.")))}},{key:"_updateReceiveShadow",value:function(){this.enabledInHierarchy&&this._model}},{key:"mesh",get:function(){return this._mesh},set:function(e){var t=this._mesh;this._mesh=e,this._onMeshChanged(t),this._updateModels()}},{key:"shadowCastingMode",get:function(){return this._shadowCastingMode},set:function(e){this._shadowCastingMode=e,this._updateCastShadow()}},{key:"receiveShadows",get:function(){return this._receiveShadows},set:function(e){this._receiveShadows=e,this._updateReceiveShadow()}},{key:"model",get:function(){return this._model}},{key:"enableDynamicBatching",set:function(e){if(this._enableDynamicBatching=e,this._mesh&&(e?this._mesh.createFlatBuffers():this._mesh.destroyFlatBuffers()),this._model)if(this._model.isDynamicBatching=e,this._model.isDynamicBatching)for(var t=0;t<this._model.subModels.length;++t)for(var i=this._model.subModels[t],n=0;n<i.passes.length;++n){var r=i.passes[n];r.batchedBuffer||r.createBatchedBuffer()}else for(var a=0;a<this._model.subModels.length;++a)for(var s=this._model.subModels[a],o=0;o<s.passes.length;++o){var l=s.passes[o];l.batchedBuffer&&l.clearBatchedBuffer()}},get:function(){return this._enableDynamicBatching}}]),a}(),UC.ShadowCastingMode=uk,m((BC=VC).prototype,"mesh",[IC],Object.getOwnPropertyDescriptor(BC.prototype,"mesh"),BC.prototype),m(BC.prototype,"shadowCastingMode",[LC],Object.getOwnPropertyDescriptor(BC.prototype,"shadowCastingMode"),BC.prototype),m(BC.prototype,"enableDynamicBatching",[fo],Object.getOwnPropertyDescriptor(BC.prototype,"enableDynamicBatching"),BC.prototype),PC=m(BC.prototype,"_enableDynamicBatching",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),DC=m(BC.prototype,"_mesh",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),FC=m(BC.prototype,"_shadowCastingMode",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return uk.OFF}}),NC=m(BC.prototype,"_receiveShadows",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),zC=BC))||zC)||zC)||zC)||zC)),fk=P2("SkinningModelComponent",(HC=ho("cc.SkinningModelComponent"),qC=go(100),jC=yo("Components/SkinningModel"),WC=fo(pT),XC=fo(Sm),YC=fo({type:pT}),QC=fo({type:Sm}),HC(KC=qC(KC=vo(KC=jC((JC=m((ZC=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"_skeleton",JC,u(t)),v(t,"_skinningRoot",$C,u(t)),t}return p(a,hk),l(a,[{key:"uploadAnimation",value:function(e){this._model&&this._model.uploadAnimation(e)}},{key:"_updateModelParams",value:function(){this._update(),_(g(a.prototype),"_updateModelParams",this).call(this)}},{key:"_onMaterialModified",value:function(e,t){var i=od(Yb.root.device),n=this.getMaterial(e)||this._getBuiltinMaterial();n.recompileShaders({CC_USE_SKINNING:i}),_(g(a.prototype),"_onMaterialModified",this).call(this,e,n)}},{key:"_getModelConstructor",value:function(){return Sf}},{key:"_getBuiltinMaterial",value:function(){return kd.get("missing-skinning-material")}},{key:"_update",value:function(){var i=this;this._model&&this._model.bindSkeleton(this._skeleton,this._skinningRoot),this._materials.forEach(function(e,t){return e&&i._onMaterialModified(t,e)})}},{key:"skeleton",get:function(){return this._skeleton},set:function(e){this._skeleton=e,this._update()}},{key:"skinningRoot",get:function(){return this._skinningRoot},set:function(e){this._skinningRoot=e,this._update()}},{key:"model",get:function(){return this._model}}]),a}()).prototype,"_skeleton",[WC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$C=m(ZC.prototype,"_skinningRoot",[XC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),m(ZC.prototype,"skeleton",[YC],Object.getOwnPropertyDescriptor(ZC.prototype,"skeleton"),ZC.prototype),m(ZC.prototype,"skinningRoot",[QC],Object.getOwnPropertyDescriptor(ZC.prototype,"skinningRoot"),ZC.prototype),KC=ZC))||KC)||KC)||KC)||KC)),dk={name:kl.ATTR_BATCH_ID,format:Il.R32F,isNormalized:!1},pk={name:kl.ATTR_BATCH_UV,format:Il.RG32F,isNormalized:!1},_k=Qc[dk.format].size+Qc[pk.format].size,vk=P2("SkinningModelUnit",(eA=ho("cc.SkinningModelUnit"),tA=fo(Fh),iA=fo(pT),nA=fo(cp),rA=fo({type:fk}),eA((oA=m((sA=function(){function e(){y(this,e),v(this,"mesh",oA,this),v(this,"skeleton",lA,this),v(this,"material",cA,this),v(this,"_offset",uA,this),v(this,"_size",hA,this)}return l(e,[{key:"offset",set:function(e){Mi.copy(this._offset,e)},get:function(){return this._offset}},{key:"size",set:function(e){Mi.copy(this._size,e)},get:function(){return this._size}},{key:"copyFrom",set:function(e){e&&(this.mesh=e.mesh,this.skeleton=e.skeleton,this.material=e.getSharedMaterial(0))},get:function(){return null}}]),e}()).prototype,"mesh",[tA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lA=m(sA.prototype,"skeleton",[iA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),cA=m(sA.prototype,"material",[nA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),uA=m(sA.prototype,"_offset",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Mi(0,0)}}),hA=m(sA.prototype,"_size",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Mi(1,1)}}),m(sA.prototype,"offset",[fo],Object.getOwnPropertyDescriptor(sA.prototype,"offset"),sA.prototype),m(sA.prototype,"size",[fo],Object.getOwnPropertyDescriptor(sA.prototype,"size"),sA.prototype),m(sA.prototype,"copyFrom",[rA],Object.getOwnPropertyDescriptor(sA.prototype,"copyFrom"),sA.prototype),aA=sA))||aA)),mk=P2("BatchedSkinningModelComponent",(fA=ho("cc.BatchedSkinningModelComponent"),dA=go(100),pA=yo("Components/BatchedSkinningModel"),_A=fo({type:[Ot]}),vA=fo({type:[vk]}),mA=fo({override:!0,visible:!1}),yA=fo({override:!0,visible:!1}),fA(gA=dA(gA=vo(gA=pA((xA=m((bA=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"atlasSize",xA,u(t)),v(t,"batchableTextureNames",SA,u(t)),v(t,"units",wA,u(t)),t._textures={},t._batchMaterial=null,t}return p(a,fk),l(a,[{key:"onLoad",value:function(){_(g(a.prototype),"onLoad",this).call(this),this.cook()}},{key:"onDestroy",value:function(){for(var e=0,t=Object.keys(this._textures);e<t.length;e++){var i=t[e];this._textures[i].destroy()}this._textures={},this._mesh&&(this._mesh.destroy(),this._mesh=null),_(g(a.prototype),"onDestroy",this).call(this)}},{key:"cook",value:function(){this.cookMaterials(),this.cookSkeletons(),this.cookMeshes()}},{key:"cookMaterials",value:function(){var f=this;this._batchMaterial||(this._batchMaterial=this.getSharedMaterial(0));var d=this.getMaterial(0);if(d&&this._batchMaterial&&this._batchMaterial.effectAsset){d.copy(this._batchMaterial),this.resizeAtlases();for(var t=d.effectAsset.techniques[d.technique],e=function(l){var c=t.passes[l];if(!c.properties)return"continue";for(var e=function(){var t=h[u];if(c.properties[t].type>=Ol.SAMPLER1D){var i=null;f.batchableTextureNames.find(function(e){return e===t})?(i=(i=f._textures[t])||f.createTexture(t),f.cookTextures(i,t,l)):f.units.some(function(e){return i=e.material&&e.material.getProperty(t,l)}),i&&d.setProperty(t,i,l)}else{var e=[],n=f.units,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;o.material&&e.push(o.material.getProperty(t.slice(0,-3),l))}d.setProperty(t,e,l)}},u=0,h=Object.keys(c.properties);u<h.length;u++)e()},i=0;i<t.passes.length;i++)e(i)}else console.warn("incomplete batch material!")}},{key:"cookSkeletons",value:function(){if(this._skinningRoot){var i=new pT,n=[],e=this.units,t=Array.isArray(e),r=0;for(e=t?e:e[Symbol.iterator]();;){var a;if(t){if(r>=e.length)break;a=e[r++]}else{if((r=e.next()).done)break;a=r.value}var s=a;if(s&&s.skeleton)for(var o=s.skeleton,l=function(e){var t=o.joints[e];if(0<=i.joints.findIndex(function(e){return e===t}))return"continue";i.joints.push(t),n.push(o.bindposes[e]||new zn)},c=0;c<o.joints.length;c++)l(c)}var u=Array.from(Array(i.joints.length).keys()).sort(function(e,t){return i.joints[e]>i.joints[t]?1:i.joints[e]<i.joints[t]?-1:0});i.joints=i.joints.map(function(e,t,i){return i[u[t]]}),i.bindposes=n.map(function(e,t,i){return i[u[t]]}),this._skeleton&&this._skeleton.destroy(),this.skeleton=i}else console.warn("no skinning root specified!")}},{key:"cookMeshes",value:function(){var q=this,e=!1,t=this.units,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}if(r.mesh){e=!0;break}}if(this._mesh?this._mesh.destroyRenderingMesh():this._mesh=new Fh,e&&this._skinningRoot){for(var j,W=0,X=Il.UNKNOWN,Y=0,Q=Il.UNKNOWN,K=new Array(this.units.length),a=this.units.length,s=0;s<a;s++){var o=this.units[s];o&&o.skeleton&&(K[s]=o.skeleton.joints.map(function(t){return q._skeleton.joints.findIndex(function(e){return t===e})}))}for(var l=function(f){var e=q.units[f];if(!e||!e.mesh||!e.mesh.data)return"continue";var t=JSON.parse(JSON.stringify(e.mesh.struct)),i=0,n=t.vertexBundles,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;o.attributes.push(dk),o.attributes.push(pk),o.view.offset=i,o.view.length+=o.view.count*_k,o.view.stride+=_k,i+=o.view.length}var l=t.primitives,c=Array.isArray(l),u=0;for(l=c?l:l[Symbol.iterator]();;){var h;if(c){if(u>=l.length)break;h=l[u++]}else{if((u=l.next()).done)break;h=u.value}var d=h;d.indexView&&(d.indexView.offset=i,i+=d.indexView.length),d.geometricInfo&&(i=4*Math.ceil(i/4),d.geometricInfo.view.offset=i,i+=d.geometricInfo.view.length)}var p=e.mesh.data,_=0,v=new Uint8Array(i);j=new DataView(v.buffer);for(var m=0;m<t.vertexBundles.length;m++){var y=e.mesh.readAttribute(m,kl.ATTR_TEX_COORD),g=e.mesh.struct.vertexBundles[m].view,b=t.vertexBundles[m].view,x=g.stride,S=b.stride;_=g.offset,i=b.offset;for(var w=0;w<b.count;w++){var T=p.subarray(_,_+x);v.set(T,i),j.setFloat32(i+x,f,cc.sys.isLittleEndian),j.setFloat32(i+x+4,y[2*w],cc.sys.isLittleEndian),j.setFloat32(i+x+8,y[2*w+1],cc.sys.isLittleEndian),i+=S,_+=x}}for(var E=0;E<t.primitives.length;E++){var C=e.mesh.struct.primitives[E],A=t.primitives[E];if(C.indexView&&A.indexView){var k=C.indexView.stride,R=A.indexView.stride;_=C.indexView.offset,i=A.indexView.offset;for(var O=0;O<A.indexView.count;O++){var M=p.subarray(_,_+k);v.set(M,i),i+=R,_+=k}}if(C.geometricInfo&&A.geometricInfo){var I=C.geometricInfo.view.stride,L=A.geometricInfo.view.stride;_=C.geometricInfo.view.offset,i=A.geometricInfo.view.offset;for(var z=0;z<A.geometricInfo.view.count;z++){var B=p.subarray(_,_+I);v.set(B,i),i+=L,_+=I}}}var P=new Fh;P.reset({struct:t,data:v});function D(){if(V){if(G>=U.length)return"break";H=U[G++]}else{if((G=U.next()).done)return"break";H=G.value}var e=H;W=e.view.offset,X=Il.UNKNOWN;var t=e.attributes,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;if(a.name===kl.ATTR_BATCH_UV){X=a.format;break}W+=Qc[a.format].size}X&&Mf(j,function(e,t){var i=0===t?"x":"y";return(e=function(e){return e-Math.floor(e)}(e))*N[i]+F[i]},X,W,e.view.length,e.view.stride,j);var s=K[f];if(!s)return"continue";Y=e.view.offset,Q=Il.UNKNOWN;var o=e.attributes,l=Array.isArray(o),c=0;for(o=l?o:o[Symbol.iterator]();;){var u;if(l){if(c>=o.length)break;u=o[c++]}else{if((c=o.next()).done)break;u=c.value}var h=u;if(h.name===kl.ATTR_JOINTS){Q=h.format;break}Y+=Qc[h.format].size}Q&&Mf(j,function(e){return s[e]},Q,Y,e.view.length,e.view.stride,j)}var F=e.offset,N=e.size;var U=t.vertexBundles,V=Array.isArray(U),G=0;e:for(U=V?U:U[Symbol.iterator]();;){var H;switch(D()){case"break":break e;case"continue":continue}}q._mesh.merge(P)},c=0;c<a;c++)l(c);this._onMeshChanged(this._mesh),this._updateModels()}}},{key:"cookTextures",value:function(e,t,i){var n=[],r=[],a=[],s=[],o=this.units,l=Array.isArray(o),c=0;for(o=l?o:o[Symbol.iterator]();;){var u;if(l){if(c>=o.length)break;u=o[c++]}else{if((c=o.next()).done)break;u=c.value}var h=u;if(h.material){var f=h.material.getProperty(t,i);if(f&&f.image&&f.image.data){var d=new Yc;d.texOffset.x=h.offset.x*this.atlasSize,d.texOffset.y=h.offset.y*this.atlasSize,d.texExtent.width=h.size.x*this.atlasSize,d.texExtent.height=h.size.y*this.atlasSize;var p=f.image.data;p instanceof HTMLCanvasElement||p instanceof HTMLImageElement?(n.push(p),r.push(d)):(a.push(p.buffer),s.push(d))}}}var _=e.getGFXTexture(),v=cc.director.root.device;0<a.length&&v.copyBuffersToTexture(a,_,s),0<n.length&&v.copyTexImagesToTexture(n,_,r)}},{key:"createTexture",value:function(e){var t=new vh;return t.setFilters(xu.LINEAR,xu.LINEAR),t.reset({width:this.atlasSize,height:this.atlasSize,format:mu.RGBA8888}),t.loaded=!0,this._textures[e]=t}},{key:"resizeAtlases",value:function(){for(var e=0,t=Object.keys(this._textures);e<t.length;e++){var i=t[e];this._textures[i].reset({width:this.atlasSize,height:this.atlasSize,format:mu.RGBA8888})}}},{key:"mesh",get:function(){return this._mesh},set:function(e){r(g(a.prototype),"mesh",e,this,!0)}},{key:"skeleton",get:function(){return this._skeleton},set:function(e){r(g(a.prototype),"skeleton",e,this,!0)}}]),a}()).prototype,"atlasSize",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1024}}),SA=m(bA.prototype,"batchableTextureNames",[_A],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),wA=m(bA.prototype,"units",[vA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),m(bA.prototype,"mesh",[mA],Object.getOwnPropertyDescriptor(bA.prototype,"mesh"),bA.prototype),m(bA.prototype,"skeleton",[yA],Object.getOwnPropertyDescriptor(bA.prototype,"skeleton"),bA.prototype),gA=bA))||gA)||gA)||gA)||gA)),yk=vt({LUMINOUS_POWER:0,LUMINANCE:1}),gk=P2("LightComponent",(TA=ho("cc.LightComponent"),EA=fo({slide:!0,range:[1e3,15e3,1]}),TA((IA=MA=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"_color",kA,u(t)),v(t,"_useColorTemperature",RA,u(t)),v(t,"_colorTemperature",OA,u(t)),t._type=l_.UNKNOWN,t._light=null,t}return p(a,Bv),l(a,[{key:"onEnable",value:function(){this._light?this._light.enabled=!0:this._createLight()}},{key:"onDisable",value:function(){this._light&&(this._light.enabled=!1)}},{key:"onDestroy",value:function(){this._destroyLight()}},{key:"_createLight",value:function(e){this._light&&(this.color=this._color,this.useColorTemperature=this._useColorTemperature,this.colorTemperature=this._colorTemperature,this._light.node=this.node,this._light.enabled=this.enabledInHierarchy)}},{key:"_destroyLight",value:function(e){this._light=null}},{key:"color",get:function(){return this._color},set:function(e){this._color=e,this._light&&(this._light.color.x=e.r/255,this._light.color.y=e.g/255,this._light.color.z=e.b/255)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(e){this._useColorTemperature=e,this._light&&(this._light.useColorTemperature=e)}},{key:"colorTemperature",get:function(){return this._colorTemperature},set:function(e){this._colorTemperature=e,this._light&&(this._light.colorTemperature=e)}},{key:"type",get:function(){return this._type}}]),a}(),MA.Type=l_,MA.PhotometricTerm=yk,kA=m((AA=IA).prototype,"_color",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rr.WHITE.clone()}}),RA=m(AA.prototype,"_useColorTemperature",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),OA=m(AA.prototype,"_colorTemperature",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 6550}}),m(AA.prototype,"color",[fo],Object.getOwnPropertyDescriptor(AA.prototype,"color"),AA.prototype),m(AA.prototype,"useColorTemperature",[fo],Object.getOwnPropertyDescriptor(AA.prototype,"useColorTemperature"),AA.prototype),m(AA.prototype,"colorTemperature",[EA],Object.getOwnPropertyDescriptor(AA.prototype,"colorTemperature"),AA.prototype),CA=AA))||CA)),bk=P2("DirectionalLightComponent",(LA=ho("cc.DirectionalLightComponent"),zA=yo("Components/DirectionalLight"),BA=fo({unit:"lx"}),LA(PA=zA(PA=vo((FA=m((DA=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"_illuminance",FA,u(t)),t._type=l_.DIRECTIONAL,t._light=null,t}return p(a,gk),l(a,[{key:"_createLight",value:function(e){this.node.scene&&((e=e||this._getRenderScene()).mainLight.node.activeInHierarchy?console.warn("there can be only one directional(main) light."):(this._light=e.mainLight,this.illuminance=this._illuminance,_(g(a.prototype),"_createLight",this).call(this,e)))}},{key:"_destroyLight",value:function(e){this.node.scene&&this._light&&(this._light.enabled=!1,e=e||this._getRenderScene(),this._light.node=e.defaultMainLightNode,_(g(a.prototype),"_destroyLight",this).call(this,e))}},{key:"illuminance",get:function(){return this._illuminance},set:function(e){this._illuminance=e,this._light&&(this._light.illuminance=this._illuminance)}}]),a}()).prototype,"_illuminance",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 65e3}}),m(DA.prototype,"illuminance",[BA],Object.getOwnPropertyDescriptor(DA.prototype,"illuminance"),DA.prototype),PA=DA))||PA)||PA)||PA)),xk=ho("cc.EditorCameraComponent")(NA=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))))._uiEditorCamera=null,t}return p(a,jE),l(a,[{key:"onLoad",value:function(){_(g(a.prototype),"onLoad",this).call(this)}},{key:"onEnable",value:function(){_(g(a.prototype),"onEnable",this).call(this)}},{key:"onDisable",value:function(){_(g(a.prototype),"onDisable",this).call(this)}},{key:"onDestroy",value:function(){_(g(a.prototype),"onDestroy",this).call(this),this._uiEditorCamera&&(cc.director.root.ui.renderScene.destroyCamera(this._uiEditorCamera),this._uiEditorCamera=null)}},{key:"_createCamera",value:function(){var e=this._camera;_(g(a.prototype),"_createCamera",this).call(this),this._camera&&this._camera.changeTargetWindow(cc.director.root.mainWindow),this._camera!==e&&this._camera&&(this._uiEditorCamera&&(cc.director.root.ui.renderScene.destroyCamera(this._uiEditorCamera),this._uiEditorCamera=null),this._uiEditorCamera=cc.director.root.ui.renderScene.createCamera({name:"Editor UICamera",node:this._camera.node,projection:this._projection,window:cc.director.root.mainWindow,priority:this._priority+1,flows:["UIFlow"]}),this._uiEditorCamera.visibility=cf,this._uiEditorCamera.viewport=this._camera.viewport,this._uiEditorCamera.fov=this._camera.fov,this._uiEditorCamera.nearClip=this._camera.nearClip,this._uiEditorCamera.farClip=this._camera.farClip,this._uiEditorCamera.clearColor=this._camera.clearColor,this._uiEditorCamera.clearDepth=this._camera.clearDepth,this._uiEditorCamera.clearStencil=this._camera.clearStencil,this._uiEditorCamera.clearFlag=Vc.DEPTH_STENCIL)}},{key:"projection",set:function(e){r(g(a.prototype),"projection",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.projectionType=e)}},{key:"fov",set:function(e){r(g(a.prototype),"fov",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.fov=mi(e))}},{key:"orthoHeight",set:function(e){r(g(a.prototype),"orthoHeight",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.orthoHeight=e)}},{key:"near",set:function(e){r(g(a.prototype),"near",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.nearClip=e)}},{key:"far",set:function(e){r(g(a.prototype),"far",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.farClip=e)}},{key:"color",set:function(e){r(g(a.prototype),"color",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.clearColor=e)}},{key:"depth",set:function(e){r(g(a.prototype),"depth",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.clearDepth=e)}},{key:"stencil",set:function(e){r(g(a.prototype),"stencil",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.clearStencil=e)}},{key:"clearFlags",set:function(e){r(g(a.prototype),"clearFlags",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.clearFlag=e)}},{key:"rect",set:function(e){r(g(a.prototype),"rect",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.viewport=e)}},{key:"screenScale",set:function(e){r(g(a.prototype),"screenScale",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.screenScale=e)}}]),a}())||NA,Sk=P2("SphereLightComponent",(UA=ho("cc.SphereLightComponent"),VA=yo("Components/SphereLight"),GA=fo({unit:"lm"}),HA=fo({unit:"cd/m²"}),qA=fo({type:yk}),UA(jA=VA(jA=vo((XA=m((WA=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"_size",XA,u(t)),v(t,"_luminance",YA,u(t)),v(t,"_term",QA,u(t)),v(t,"_range",KA,u(t)),t._type=l_.SPHERE,t._light=null,t}return p(a,gk),l(a,[{key:"_createLight",value:function(e){var t=this;this.node.scene&&(e=e||this._getRenderScene(),this._light&&e.sphereLights.find(function(e){return e===t._light})||(this._light=e.createSphereLight(this.name,this.node),this._light?(this._light.luminance=this._luminance,this.size=this._size,this.range=this._range,_(g(a.prototype),"_createLight",this).call(this,e)):console.warn("we don't support this many lights in forward pipeline.")))}},{key:"_destroyLight",value:function(e){this.node.scene&&this._light&&((e=e||this._getRenderScene()).destroySphereLight(this._light),_(g(a.prototype),"_destroyLight",this).call(this,e))}},{key:"luminousPower",get:function(){return this._luminance*h_(this._size)},set:function(e){this._luminance=e/h_(this._size),this._light&&(this._light.luminance=this._luminance)}},{key:"luminance",get:function(){return this._luminance},set:function(e){this._luminance=e,this._light&&(this._light.luminance=e)}},{key:"term",get:function(){return this._term},set:function(e){this._term=e}},{key:"size",get:function(){return this._size},set:function(e){this._size=e,this._light&&(this._light.size=e)}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._light&&(this._light.range=e)}}]),a}()).prototype,"_size",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),YA=m(WA.prototype,"_luminance",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/h_(.15)}}),QA=m(WA.prototype,"_term",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return yk.LUMINOUS_POWER}}),KA=m(WA.prototype,"_range",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),m(WA.prototype,"luminousPower",[GA],Object.getOwnPropertyDescriptor(WA.prototype,"luminousPower"),WA.prototype),m(WA.prototype,"luminance",[HA],Object.getOwnPropertyDescriptor(WA.prototype,"luminance"),WA.prototype),m(WA.prototype,"term",[qA],Object.getOwnPropertyDescriptor(WA.prototype,"term"),WA.prototype),m(WA.prototype,"size",[fo],Object.getOwnPropertyDescriptor(WA.prototype,"size"),WA.prototype),m(WA.prototype,"range",[fo],Object.getOwnPropertyDescriptor(WA.prototype,"range"),WA.prototype),jA=WA))||jA)||jA)||jA)),wk=P2("SpotLightComponent",(ZA=ho("cc.SpotLightComponent"),JA=yo("Components/SpotLight"),$A=fo({unit:"lm"}),ek=fo({unit:"cd/m²"}),tk=fo({type:yk}),ik=fo({slide:!0,range:[2,180,1]}),ZA(nk=JA(nk=vo((ak=m((rk=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"_size",ak,u(t)),v(t,"_luminance",sk,u(t)),v(t,"_term",ok,u(t)),v(t,"_range",lk,u(t)),v(t,"_spotAngle",ck,u(t)),t._type=l_.SPOT,t._light=null,t}return p(a,gk),l(a,[{key:"_createLight",value:function(e){var t=this;this.node.scene&&(e=e||this._getRenderScene(),this._light&&e.spotLights.find(function(e){return e===t._light})||(this._light=e.createSpotLight(this.name,this.node),this._light?(this._light.luminance=this._luminance,this.size=this._size,this.range=this._range,this.spotAngle=this._spotAngle,_(g(a.prototype),"_createLight",this).call(this,e)):console.warn("we don't support this many lights in forward pipeline.")))}},{key:"_destroyLight",value:function(e){this.node.scene&&this._light&&((e=e||this._getRenderScene()).destroySpotLight(this._light),_(g(a.prototype),"_destroyLight",this).call(this,e))}},{key:"luminousPower",get:function(){return this._luminance*h_(this._size)},set:function(e){this._luminance=e/h_(this._size),this._light&&(this._light.luminance=this._luminance)}},{key:"luminance",get:function(){return this._luminance},set:function(e){this._luminance=e,this._light&&(this._light.luminance=e)}},{key:"term",get:function(){return this._term},set:function(e){this._term=e}},{key:"size",get:function(){return this._size},set:function(e){this._size=e,this._light&&(this._light.size=e)}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._light&&(this._light.range=e)}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._spotAngle=e,this._light&&(this._light.spotAngle=mi(e))}}]),a}()).prototype,"_size",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),sk=m(rk.prototype,"_luminance",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/h_(.15)}}),ok=m(rk.prototype,"_term",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return yk.LUMINOUS_POWER}}),lk=m(rk.prototype,"_range",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),ck=m(rk.prototype,"_spotAngle",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),m(rk.prototype,"luminousPower",[$A],Object.getOwnPropertyDescriptor(rk.prototype,"luminousPower"),rk.prototype),m(rk.prototype,"luminance",[ek],Object.getOwnPropertyDescriptor(rk.prototype,"luminance"),rk.prototype),m(rk.prototype,"term",[tk],Object.getOwnPropertyDescriptor(rk.prototype,"term"),rk.prototype),m(rk.prototype,"size",[fo],Object.getOwnPropertyDescriptor(rk.prototype,"size"),rk.prototype),m(rk.prototype,"range",[fo],Object.getOwnPropertyDescriptor(rk.prototype,"range"),rk.prototype),m(rk.prototype,"spotAngle",[ik],Object.getOwnPropertyDescriptor(rk.prototype,"spotAngle"),rk.prototype),nk=rk))||nk)||nk)||nk));function Tk(e,t,i,n,r){var a=1-r;return e*a*a*a+3*t*a*a*r+3*i*a*r*r+n*r*r*r}cc.CameraComponent=jE,cc.EditorComponent=xk,cc.RenderableComponent=kC,cc.ModelComponent=hk,cc.SkinningModelComponent=fk,cc.BatchedSkinningModelComponent=mk,cc.SkinningModelUnit=vk,cc.LightComponent=gk,cc.DirectionalLightComponent=bk,cc.SphereLightComponent=Sk,cc.SpotLightComponent=wk,cc.utils=Uf,cc.bezier=Tk;var Ek=Math.cos,Ck=Math.acos,Ak=Math.max,kk=2*Math.PI,Rk=Math.sqrt;function Ok(e){return e<0?-Math.pow(-e,1/3):Math.pow(e,1/3)}function Mk(e,t){var i=function(e,t){var i,n,r,a,s=t-0,o=t-e[0],l=3*s,c=3*o,u=3*(t-e[2]),h=1/(c-s-u+(t-1)),f=(l-6*o+u)*h,d=1/3*f,p=(c-l)*h,_=1/3*(3*p-f*f),v=1/3*_,m=(2*f*f*f-9*f*p+27*(s*h))/27,y=m/2,g=y*y+v*v*v;if(g<0){var b=1/3*-_,x=Rk(b*b*b),S=-m/(2*x),w=Ck(S<-1?-1:1<S?1:S),T=2*Ok(x);return n=T*Ek(w*(1/3))-d,r=T*Ek((w+kk)*(1/3))-d,a=T*Ek((w+2*kk)*(1/3))-d,0<=n&&n<=1?0<=r&&r<=1?0<=a&&a<=1?Ak(n,r,a):Ak(n,r):0<=a&&a<=1?Ak(n,a):n:0<=r&&r<=1?0<=a&&a<=1?Ak(r,a):r:a}if(0==g)return r=-(i=y<0?Ok(-y):-Ok(y))-d,0<=(n=2*i-d)&&n<=1?0<=r&&r<=1?Ak(n,r):n:r;var E=Rk(g);return n=(i=Ok(-y+E))-Ok(y+E)-d}(e,t),n=1-i;return 0*n*n*n+3*e[1]*i*n*n+3*e[3]*i*i*n+1*i*i*i}cc.bezierByTime=Mk;var Ik,Lk,zk,Bk,Pk=1e-6;function Dk(e,t){for(var i=0,n=e.length-1,r=n>>>1;i<=n;r=i+n>>>1){var a=e[r];if(t+Pk<a)n=r-1;else{if(!(a<t-Pk))return r;i=r+1}}return~i}(Lk=Ik=Ik||{})[Lk.Loop=2]="Loop",Lk[Lk.ShouldWrap=4]="ShouldWrap",Lk[Lk.PingPong=22]="PingPong",Lk[Lk.Reverse=36]="Reverse",(Bk=zk=zk||{})[Bk.Default=0]="Default",Bk[Bk.Normal=1]="Normal",Bk[Bk.Reverse=Ik.Reverse]="Reverse",Bk[Bk.Loop=Ik.Loop]="Loop",Bk[Bk.LoopReverse=Ik.Loop|Ik.Reverse]="LoopReverse",Bk[Bk.PingPong=Ik.PingPong]="PingPong",Bk[Bk.PingPongReverse=Ik.PingPong|Ik.Reverse]="PingPongReverse",mt(zk);var Fk,Nk=function(){function t(e){y(this,t),this.ratio=0,this.time=0,this.direction=1,this.stopped=!0,this.iterations=0,this.frameIndex=void 0,e&&this.set(e)}return l(t,[{key:"set",value:function(e){this.ratio=e.ratio,this.time=e.time,this.direction=e.direction,this.stopped=e.stopped,this.iterations=e.iterations,this.frameIndex=e.frameIndex}}]),t}();var Uk=P2("RatioSampler",function(){function s(e){var t,i;y(this,s),this.ratios=void 0;for(var n=!(this._findRatio=void 0),r=1,a=(this.ratios=e).length;r<a;r++)if(t=e[r]-e[r-1],1===r)i=t;else if(1e-6<Math.abs(t-i)){n=!1;break}this._findRatio=n?jk:Dk}return l(s,[{key:"sample",value:function(e){return this._findRatio(this.ratios,e)}}]),s}());cc.RatioSampler=Uk;var Vk=P2("AnimCurve",function(){function r(e,t){y(this,r),this.types=void 0,this.type=null,this._values=[],this._lerp=void 0,this._stepfiedValues=void 0,this._duration=void 0,this._duration=t,this._values=e.values;function i(e){return"string"==typeof e?e:Array.isArray(e)?e[0]===e[1]&&e[2]===e[3]?r.Linear:r.Bezier(e):r.Linear}void 0!==e.easingMethod?this.type=i(e.easingMethod):void 0!==e.easingMethods?this.types=e.easingMethods.map(i):this.type=null;var n=e.values[0];void 0!==e.interpolate&&!e.interpolate||(this._lerp=Wk(n))}return l(r,null,[{key:"Bezier",value:function(e){return e}}]),l(r,[{key:"hasLerp",value:function(){return!!this._lerp}},{key:"valueAt",value:function(e){var t=this._values[e];return t&&t.getNoLerp?t.getNoLerp():t}},{key:"valueBetween",value:function(e,t,i,n,r){if(this._lerp){var a=this.types?this.types[t]:this.type,s=r-i,o=(e-i)/s;a&&(o=qk(o,a));var l=this._values[t],c=this._values[n];return this._lerp(l,c,o,s*this._duration)}return this.valueAt(t)}},{key:"empty",value:function(){return 0===this._values.length}}]),r}());Vk.Linear=null,cc.AnimCurve=Vk;P2("EventInfo",function(){function e(){y(this,e),this.events=[]}return l(e,[{key:"add",value:function(e,t){this.events.push({func:e||"",params:t||[]})}}]),e}());var Gk=P2("CurveValueAdapter",ho("cc.CurveValueAdapter")(Fk=function(){function e(){y(this,e)}return l(e,[{key:"forTarget",value:function(e){return{set:function(e){}}}}]),e}())||Fk);function Hk(e,t,i){var n=t.sample(i);if(n<0)if((n=~n)<=0)n=0;else{if(!(n>=t.ratios.length))return e.valueBetween(i,n-1,t.ratios[n-1],n,t.ratios[n]);n=t.ratios.length-1}return e.valueAt(n)}function qk(e,t){if("string"==typeof t){var i=Fp[t];i?e=i(e):D(3906,t)}else Array.isArray(t)&&(e=Mk(t,e));return e}function jk(e,t){var i=e.length-1;if(0==i)return 0;var n=e[0];if(t<n)return 0;var r=e[i];if(r<t)return i;var a=(t=(t-n)/(r-n))/(1/i),s=0|a;return a-s<1e-6?s:1+s-a<1e-6?1+s:~(1+s)}cc.CurveValueAdapter=Gk,cc.sampleAnimationCurve=Hk;var Wk=function(e){if(null!==e){if("number"==typeof e)return vi;if("object"===de(e)&&e.constructor){if(e instanceof hn)return function(){var r=new hn;return function(e,t,i,n){return hn.slerp(r,e,t,i)}}();if(e instanceof yt)return function(n){var r=new n;return function(e,t,i){return n.lerp(r,e,t,i),r}}(e.constructor);if(e.constructor===Number)return vi;if(function(e){return"function"==typeof e.lerp}(e))return Xk}}};function Xk(e,t,i,n){return e.lerp(t,i,n)}var Yk,Qk,Kk,Zk,Jk,$k;function eR(e){return"string"==typeof e}function tR(e){return"number"==typeof e}function iR(e,t){return e instanceof t}cc.isPropertyModifier=eR,cc.isElementModifier=tR,cc.isCustomTargetModifier=iR;var nR=P2("HierachyModifier",ho("cc.HierachyModifier")((Kk=m((Qk=function(){function t(e){y(this,t),v(this,"path",Kk,this),this.path=e||""}return l(t,[{key:"get",value:function(e){if(!(e instanceof Sm))throw new Error("Target of hierachy modifier shall be Node.");var t=e.getChildByPath(this.path);if(!t)throw new Error('Node "'.concat(e.name,'" has no path "').concat(this.path,'"'));return t}}]),t}()).prototype,"path",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Yk=Qk))||Yk);cc.HierachyModifier=nR;var rR=P2("ComponentModifier",ho("cc.ComponentModifier")(($k=m((Jk=function(){function t(e){y(this,t),v(this,"component",$k,this),this.component=e||""}return l(t,[{key:"get",value:function(e){if(!(e instanceof Sm))throw new Error("Target of hierachy modifier shall be Node.");var t=e.getComponent(this.component);if(!t)throw new Error('Node "'.concat(e.name,'" has no component "').concat(this.component,'"'));return t}}]),t}()).prototype,"component",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Zk=Jk))||Zk);cc.ComponentModifier=rR;var aR,sR,oR,lR,cR,uR,hR,fR,dR,pR,_R,vR,mR,yR,gR,bR=function(){function s(e,t,i){var n;y(this,s),this._isProxy=void 0,this._assignmentOrProxy=void 0;for(var r=0;r<t.length;++r){var a=t[r];if(tR(a)||eR(a))if(r!==t.length-1||i){if(!(a in e))throw new Error('Target object has no property "'.concat(a,'"'));e=e[a]}else n=a;else e=a.get(e)}if(void 0!==n)this._assignmentOrProxy={object:e,propertyOrElement:n},this._isProxy=!1;else{if(!i)throw new Error("Bad animation curve.");this._assignmentOrProxy=i.forTarget(e),this._isProxy=!0}}return l(s,[{key:"setValue",value:function(e){this._isProxy?this._assignmentOrProxy.set(e):this._assignmentOrProxy.object[this._assignmentOrProxy.propertyOrElement]=e}}]),s}(),xR=P2("AnimationClip",(aR=ho("cc.AnimationClip"),sR=fo({visible:!1}),aR((gR=yR=function(){function o(){var e,t;y(this,o);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(o)).call.apply(e,[this].concat(n))),"sample",cR,u(t)),v(t,"speed",uR,u(t)),v(t,"wrapMode",hR,u(t)),v(t,"curveDatas",fR,u(t)),v(t,"_curves",dR,u(t)),v(t,"events",pR,u(t)),v(t,"_duration",_R,u(t)),v(t,"_keys",vR,u(t)),t._ratioSamplers=[],t._runtimeCurves=void 0,t._runtimeEvents=void 0,t.frameRate=0,v(t,"_stepness",mR,u(t)),t._hash=0,t}return p(o,Mu),l(o,[{key:"onLoaded",value:function(){this.frameRate=this.sample,this._migrateCurveDatas()}},{key:"getPropertyCurves",value:function(e){return this._runtimeCurves||this._createPropertyCurves(),this._runtimeCurves}},{key:"updateCurveDatas",value:function(){this._migrateCurveDatas(),delete this._runtimeCurves}},{key:"updateEventDatas",value:function(){delete this._runtimeEvents}},{key:"getEventGroupIndexAtRatio",value:function(e){return this._runtimeEvents||this._createRuntimeEvents(),function(e,t){for(var i=0,n=e.length-1,r=n>>>1;i<=n;r=i+n>>>1){var a=e[r];if(t+1e-6<a)n=r-1;else{if(!(a<t-1e-6))return r;i=r+1}}return~i}(this._runtimeEvents.ratios,e)}},{key:"hasEvents",value:function(){return 0!==this.events.length}},{key:"_createPropertyCurves",value:function(){var t=this;this._ratioSamplers=this._keys.map(function(e){return new Uk(e.map(function(e){return e/t._duration}))}),this._runtimeCurves=this._curves.map(function(e){return{curve:new Vk(e.data,t._duration),modifiers:e.modifiers,valueAdapter:e.valueAdapter,sampler:t._ratioSamplers[e.data.keys]}}),this._applyStepness()}},{key:"_createRuntimeEvents",value:function(){var n=this;var r=[],a=[],e=function(){if(o){if(l>=s.length)return"break";c=s[l++]}else{if((l=s.next()).done)return"break";c=l.value}var e=c,t=e.frame/n._duration,i=r.findIndex(function(e){return e===t});i<0&&(i=r.length,r.push(t),a.push({events:[]})),a[i].events.push({functionName:e.func,parameters:e.params})},s=this.events.sort(function(e,t){return e.frame-t.frame}),o=Array.isArray(s),l=0;for(s=o?s:s[Symbol.iterator]();;){var c;if("break"===e())break}this._runtimeEvents={ratios:r,eventGroups:a}}},{key:"_applyStepness",value:function(){this._runtimeCurves}},{key:"_migrateCurveDatas",value:function(){if(this.curveDatas){for(var e=0,t=Object.keys(this.curveDatas);e<t.length;e++){var i=t[e],n=new nR;n.path=i;var r=this.curveDatas[i];if(r.props)for(var a=0,s=Object.keys(r.props);a<s.length;a++){var o=s[a],l=r.props[o];this._curves.push({modifiers:[n,o],data:l})}if(r.comps)for(var c=0,u=Object.keys(r.comps);c<u.length;c++){var h=u[c],f=new rR;f.component=h;for(var d=r.comps[h],p=0,_=Object.keys(d);p<_.length;p++){var v=_[p],m=d[v];this._curves.push({modifiers:[n,f,v],data:m})}}}delete this.curveDatas}}},{key:"_getDeprecatedCurveDatas",value:function(){var e={},t=this._curves,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;if(0!==a.modifiers.length&&iR(a.modifiers[0],nR)){var s=null,o=void 0;if(2===a.modifiers.length&&eR(a.modifiers[1]))o=a.modifiers[1];else{if(3!==a.modifiers.length||!iR(a.modifiers[1],rR)||!eR(a.modifiers[2]))continue;s=a.modifiers[1].component,o=a.modifiers[2]}var l=a.modifiers[0].path;l in e||(e[l]={});var c=e[l],u=void 0;if(s){"comps"in c||(c.comps={});var h=c.comps;s in h||(h[s]={}),u=h[s]}else"props"in c||(c.props={}),u=c.props;u[o]=a.data}}return e}},{key:"duration",get:function(){return this._duration},set:function(e){this._duration=e}},{key:"keys",get:function(){return this._keys},set:function(e){this._keys=e}},{key:"eventGroups",get:function(){return this._runtimeEvents||this._createRuntimeEvents(),this._runtimeEvents.eventGroups}},{key:"stepness",get:function(){return this._stepness},set:function(e){this._stepness=e,this._applyStepness()}},{key:"hash",get:function(){return this._hash||(this._hash=au(JSON.stringify(this._getDeprecatedCurveDatas()),666)),this._hash}},{key:"curves",get:function(){return this._curves},set:function(e){this._curves=e,delete this._runtimeCurves}}],[{key:"createWithSpriteFrames",value:function(e,t){if(!Array.isArray(e))return D(3905),null;var i=new o;i.sample=t||i.sample,i.duration=e.length/i.sample;for(var n=1/i.sample,r=new Array(e.length),a=new Array(r.length),s=0;s<e.length;s++)r[s]=s*n,a[s]=e[s];return i.keys=[r],i.curves=[{modifiers:[new rR("cc.SpriteComponent"),"spriteFrame"],data:{keys:0,values:a}}],i}}]),o}(),yR.WrapMode=zk,cR=m((lR=gR).prototype,"sample",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),uR=m(lR.prototype,"speed",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),hR=m(lR.prototype,"wrapMode",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return zk.Normal}}),fR=m(lR.prototype,"curveDatas",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{}}}),dR=m(lR.prototype,"_curves",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),pR=m(lR.prototype,"events",[sR],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_R=m(lR.prototype,"_duration",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),vR=m(lR.prototype,"_keys",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),mR=m(lR.prototype,"_stepness",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),oR=lR))||oR));cc.AnimationClip=xR;var SR,wR,TR,ER=function(){function e(){y(this,e),this._blendTargets=[]}return l(e,[{key:"refPropertyBlendTarget",value:function(t,i){var e=this._blendTargets.find(function(e){return e.target===t});e||(e={target:t,properties:[]},this._blendTargets.push(e));var n=e.properties,r=n.find(function(e){return e.name===i});return r||(r={name:i,weight:0,value:void 0,refCount:0},n.push(r)),++r.refCount,r}},{key:"derefPropertyBlendTarget",value:function(t,i){var e=this._blendTargets.findIndex(function(e){return e.target===t});if(!(e<0)){var n=this._blendTargets[e].properties,r=n.findIndex(function(e){return e.name===i});if(!(r<0)){var a=n[r];--a.refCount,0<a.refCount||(2<=n.length?n.splice(r,1):this._blendTargets.splice(e,1))}}}},{key:"apply",value:function(){var e=this._blendTargets,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n,a=r.target,s=r.properties,o=Array.isArray(s),l=0;for(s=o?s:s[Symbol.iterator]();;){var c;if(o){if(l>=s.length)break;c=s[l++]}else{if((l=s.next()).done)break;c=l.value}var u=c;0!==u.weight&&(a instanceof Sm?"position"===u.name?a.setPosition(u.value):"rotation"===u.name?a.setRotation(u.value):a.setScale(u.value):a[u.name]=u.value)}}}},{key:"clear",value:function(){var e=this._blendTargets,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n.properties,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}o.weight=0}}}}]),e}(),CR=P2("AnimationManager",ho((TR=wR=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))))._anims=new ue([]),t._delayEvents=[],t._blendState=new ER,t._crossFades=[],t}return p(a,Hp),l(a,[{key:"addCrossFade",value:function(e){this._crossFades.push(e)}},{key:"removeCrossFade",value:function(e){fe(this._crossFades,e)}},{key:"update",value:function(e){var t=this._crossFades,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.update(e)}this._blendState.clear();var a=this._anims,s=a.array;for(a.i=0;a.i<s.length;++a.i){var o=s[a.i];o.isPlaying&&!o.isPaused&&o.update(e)}this._blendState.apply();for(var l=this._delayEvents,c=0,u=l.length;c<u;c++){var h=l[c];h.target[h.func].apply(h.target,h.args)}l.length=0}},{key:"destruct",value:function(){}},{key:"addAnimation",value:function(e){-1===this._anims.array.indexOf(e)&&(e.attachToBlendState(this._blendState),this._anims.push(e))}},{key:"removeAnimation",value:function(e){var t=this._anims.array.indexOf(e);0<=t?(e.detachFromBlendState(this._blendState),this._anims.fastRemoveAt(t)):D(3907)}},{key:"pushDelayEvent",value:function(e,t,i){this._delayEvents.push({target:e,func:t,args:i})}},{key:"blendState",get:function(){return this._blendState}}]),a}(),wR.ID="animation",SR=TR))||SR);Yb.on(Xb.EVENT_INIT,function(){var e=new CR;Yb.registerSystem(CR.ID,e,Wb.PRIORITY_SYSTEM)}),cc.AnimationManager=CR;var AR,kR,RR=function(){function e(){y(this,e),this._isPlaying=!1,this._isPaused=!1,this._stepOnce=!1}return l(e,[{key:"play",value:function(){this._isPlaying?this._isPaused?(this._isPaused=!1,this.onResume()):this.onError(G(3912)):(this._isPlaying=!0,this.onPlay())}},{key:"stop",value:function(){this._isPlaying&&(this._isPlaying=!1,this.onStop(),this._isPaused=!1)}},{key:"pause",value:function(){this._isPlaying&&!this._isPaused&&(this._isPaused=!0,this.onPause())}},{key:"resume",value:function(){this._isPlaying&&this._isPaused&&(this._isPaused=!1,this.onResume())}},{key:"step",value:function(){this.pause(),this._stepOnce=!0,this._isPlaying||this.play()}},{key:"update",value:function(e){}},{key:"onPlay",value:function(){}},{key:"onPause",value:function(){}},{key:"onResume",value:function(){}},{key:"onStop",value:function(){}},{key:"onError",value:function(e){}},{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}}]),e}();function OR(e,t,i){return i.value||(i.value=new Fi),0===i.weight&&Fi.zero(i.value),0===t?i.value:1===t?Fi.copy(i.value,e):Fi.scaleAndAdd(i.value,i.value,e,t)}function MR(e,t,i){if(i.value||(i.value=new hn),0===i.weight&&hn.identity(i.value),0===t)return i.value;if(1===t)return hn.copy(i.value,e);var n=t/(i.weight+t);return hn.slerp(i.value,i.value,e,n)}(kR=AR=AR||{})[kR.NodePosition=0]="NodePosition",kR[kR.NodeScale=1]="NodeScale",kR[kR.NodeRotation=2]="NodeRotation",kR[kR.None=3]="None";var IR=function(){function n(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;if(y(this,n),this._curve=void 0,this._boundTarget=void 0,this._curveValueProxy=void 0,this._rootTarget=void 0,this._rootTargetProperty=void 0,this._isNodeTarget=void 0,this._propertySpecialization=void 0,this._blendTarget=void 0,this._blendFunction=void 0,this._cached=void 0,this._curveDetail=void 0,this._curve=e.curve,this._curveDetail=e,this._boundTarget=new bR(t,e.modifiers,e.valueAdapter),this._rootTarget=t,this._isNodeTarget=t instanceof Sm,this._propertySpecialization=AR.None,this._blendFunction=null,this._isNodeTarget&&1===e.modifiers.length)switch(e.modifiers[0]){case"position":this._propertySpecialization=AR.NodePosition,this._blendFunction=OR;break;case"rotation":this._propertySpecialization=AR.NodeRotation,this._blendFunction=MR;break;case"scale":this._propertySpecialization=AR.NodeScale,this._blendFunction=OR}this._blendTarget=i}return l(n,[{key:"attachToBlendState",value:function(e){this._rootTargetProperty&&(this._blendTarget=e.refPropertyBlendTarget(this._rootTarget,this._rootTargetProperty))}},{key:"dettachFromBlendState",value:function(e){this._rootTargetProperty&&(this._blendTarget=null,e.derefPropertyBlendTarget(this._rootTarget,this._rootTargetProperty))}},{key:"applySample",value:function(e,t,i,n,r){var a;this._curve.empty()||(a=i?this._curve.valueBetween(e,n.from,n.fromRatio,n.to,n.toRatio):this._curve.valueAt(t),this._setValue(a,r))}},{key:"_setValue",value:function(e,t){if(!this._blendFunction||!this._blendTarget||this._blendTarget.refCount<=1)switch(this._propertySpecialization){case AR.NodePosition:this._rootTarget.setPosition(e);break;case AR.NodeRotation:this._rootTarget.setRotation(e);break;case AR.NodeScale:this._rootTarget.setScale(e);break;default:this._boundTarget.setValue(e)}else this._blendTarget.value=this._blendFunction(e,t,this._blendTarget),this._blendTarget.weight+=t}},{key:"propertyName",get:function(){return this._rootTargetProperty||""}},{key:"curveDetail",get:function(){return this._curveDetail}}]),n}();var LR,zR,BR,PR,DR,FR=P2("AnimationState",function(){function n(e,t){var i;return y(this,n),(i=x(this,g(n).call(this))).duration=1,i.speed=1,i.time=0,i.weight=0,i.frameRate=0,i._lastframeEventOn=!1,i._wrapMode=zk.Normal,i._repeatCount=1,i._currentFramePlayed=!1,i._delay=0,i._delayTime=0,i._wrappedInfo=new Nk,i._lastWrapInfo=null,i._lastWrapInfoEvent=null,i._process=i.process,i._target=null,i._targetNode=null,i._clip=void 0,i._name=void 0,i._lastIterations=void 0,i._samplerSharedGroups=[],i._curveLoaded=!1,i._ignoreIndex=-1,i._clip=e,i._name=t||e&&e.name,i}return p(n,RR),l(n,[{key:"clip",get:function(){return this._clip}},{key:"name",get:function(){return this._name}},{key:"length",get:function(){return this.duration}},{key:"wrapMode",get:function(){return this._wrapMode},set:function(e){this._wrapMode=e,this.time=0,e&Ik.Loop?this.repeatCount=1/0:this.repeatCount=1}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(e){this._repeatCount=e;var t=this._wrapMode&Ik.ShouldWrap,i=(this.wrapMode&Ik.Reverse)===Ik.Reverse;this._process=e!==1/0||t||i?this.process:this.simpleProcess}},{key:"delay",get:function(){return this._delay},set:function(e){this._delayTime=this._delay=e}}]),l(n,[{key:"initialize",value:function(n){var r=this;if(!this._curveLoaded){this._curveLoaded=!0,this._samplerSharedGroups.length=0,this._targetNode=n;var e=this._clip;this.duration=e.duration,this.speed=e.speed,this.wrapMode=e.wrapMode,this.frameRate=e.sample,(this.wrapMode&Ik.Loop)===Ik.Loop?this.repeatCount=1/0:this.repeatCount=1;for(var a=e.getPropertyCurves(n),t=function(e){var t=a[e],i=r._samplerSharedGroups.find(function(e){return e.sampler===t.sampler});i||(i=function(e){return{sampler:e,curves:[],samplerResultCache:{from:0,fromRatio:0,to:0,toRatio:0}}}(t.sampler),r._samplerSharedGroups.push(i));try{i.curves.push(new IR(t,n))}catch(e){}},i=0;i<a.length;++i)t(i)}}},{key:"_emit",value:function(e,t){this._target&&this._target.isValid&&this._target.emit(e,e,t)}},{key:"emit",value:function(){for(var e=new Array(arguments.length),t=0,i=e.length;t<i;t++)e[t]=t<0||arguments.length<=t?void 0:arguments[t];Yb.getAnimationManager().pushDelayEvent(this,"_emit",e)}},{key:"on",value:function(e,t,i){return this._target&&this._target.isValid?("lastframe"===e&&(this._lastframeEventOn=!0),this._target.on(e,t,i)):null}},{key:"once",value:function(e,t,i){var n=this;return this._target&&this._target.isValid?("lastframe"===e&&(this._lastframeEventOn=!0),this._target.once(e,function(e){t.call(i,e),n._lastframeEventOn=!1})):null}},{key:"off",value:function(e,t,i){this._target&&this._target.isValid&&("lastframe"===e&&(this._target.hasEventListener(e)||(this._lastframeEventOn=!1)),this._target.off(e,t,i))}},{key:"_setEventTarget",value:function(e){this._target=e}},{key:"setTime",value:function(e){this._currentFramePlayed=!1,this.time=e||0,this._lastWrapInfoEvent=null,this._ignoreIndex=-1;var t=this.getWrappedInfo(e,this._wrappedInfo),i=t.direction,n=this._clip.getEventGroupIndexAtRatio(t.ratio);n<0&&(n=~n-1,i<0&&(n+=1),this._ignoreIndex=n)}},{key:"update",value:function(e){0<this._delayTime&&(this._delayTime-=e,0<this._delayTime)||(this._currentFramePlayed?this.time+=e*this.speed:this._currentFramePlayed=!0,this._process())}},{key:"_needReverse",value:function(e){var t=this.wrapMode,i=!1;(t&Ik.PingPong)===Ik.PingPong&&(e-(0|e)==0&&0<e&&(e-=1),1&e&&(i=!i));return(t&Ik.Reverse)===Ik.Reverse&&(i=!i),i}},{key:"getWrappedInfo",value:function(e,t){t=t||new Nk;var i=!1,n=this.duration,r=this.repeatCount,a=0<e?e/n:-e/n;if(r<=a){i=!0;var s=(a=r)-(0|r);0===s&&(s=1),e=s*n*(0<e?1:-1)}if(n<e){var o=e%n;e=0==o?n:o}else e<0&&0!==(e%=n)&&(e+=n);var l=!1,c=this._wrapMode&Ik.ShouldWrap;c&&(l=this._needReverse(a));var u=l?-1:1;return this.speed<0&&(u*=-1),c&&l&&(e=n-e),t.ratio=e/n,t.time=e,t.direction=u,t.stopped=i,t.iterations=a,t}},{key:"sample",value:function(){var e=this.getWrappedInfo(this.time,this._wrappedInfo);return this._sampleCurves(e.ratio),this._sampleEvents(e),e}},{key:"process",value:function(){var e,t=this.sample();this._lastframeEventOn&&(e=this._lastWrapInfo?this._lastWrapInfo:this._lastWrapInfo=new Nk(t),1<this.repeatCount&&(0|t.iterations)>(0|e.iterations)&&this.emit("lastframe",this),e.set(t));t.stopped&&(this.stop(),this.emit("finished",this))}},{key:"simpleProcess",value:function(){var e=this.time,t=this.duration;t<e?0===(e%=t)&&(e=t):e<0&&0!==(e%=t)&&(e+=t);var i=e/t;this._sampleCurves(i),this._clip.hasEvents()&&this._sampleEvents(this.getWrappedInfo(this.time,this._wrappedInfo)),this._lastframeEventOn&&(void 0===this._lastIterations&&(this._lastIterations=i),(0<this.time&&this._lastIterations>i||this.time<0&&this._lastIterations<i)&&this.emit("lastframe",this),this._lastIterations=i)}},{key:"attachToBlendState",value:function(e){var t=this._samplerSharedGroups,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r.curves,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}l.attachToBlendState(e)}}}},{key:"detachFromBlendState",value:function(e){var t=this._samplerSharedGroups,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r.curves,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}l.dettachFromBlendState(e)}}}},{key:"cache",value:function(e){}},{key:"onPlay",value:function(){this.setTime(0),this._delayTime=this._delay,Yb.getAnimationManager().addAnimation(this),this.emit("play",this)}},{key:"onStop",value:function(){this.isPaused||Yb.getAnimationManager().removeAnimation(this),this.emit("stop",this)}},{key:"onResume",value:function(){Yb.getAnimationManager().addAnimation(this),this.emit("resume",this)}},{key:"onPause",value:function(){Yb.getAnimationManager().removeAnimation(this),this.emit("pause",this)}},{key:"_sampleCurves",value:function(e){for(var t=0,i=this._samplerSharedGroups.length;t<i;++t){var n=this._samplerSharedGroups[t],r=n.sampler,a=n.samplerResultCache,s=0,o=!1;r?(s=r.sample(e))<0&&((s=~s)<=0?s=0:s>=r.ratios.length?s=r.ratios.length-1:(o=!0,a.from=s-1,a.fromRatio=r.ratios[a.from],a.to=s,a.toRatio=r.ratios[a.to])):s=0;for(var l=0,c=n.curves.length;l<c;++l){n.curves[l].applySample(e,s,o,a,this.weight)}}}},{key:"_sampleEvents",value:function(e){var t=this._clip.eventGroups.length,i=e.direction,n=this._clip.getEventGroupIndexAtRatio(e.ratio);if(n<0&&(n=~n-1,i<0&&(n+=1)),this._ignoreIndex!==n&&(this._ignoreIndex=-1),e.frameIndex=n,!this._lastWrapInfoEvent)return this._fireEvent(n),void(this._lastWrapInfoEvent=new Nk(e));var r=this.wrapMode,a=NR(e.iterations),s=this._lastWrapInfoEvent,o=NR(s.iterations),l=s.frameIndex,c=s.direction,u=-1!==o&&a!==o;if(l===n&&u&&1===t)this._fireEvent(0);else if(l!==n||u){i=c;do{if(l!==n){if(-1===i&&0===l&&0<n?((r&Ik.PingPong)===Ik.PingPong?i*=-1:l=t,o++):1===i&&l===t-1&&n<t-1&&((r&Ik.PingPong)===Ik.PingPong?i*=-1:l=-1,o++),l===n)break;if(a<o)break}l+=i,Yb.getAnimationManager().pushDelayEvent(this,"_fireEvent",[l])}while(l!==n&&-1<l&&l<t)}this._lastWrapInfoEvent.set(e)}},{key:"_fireEvent",value:function(e){if(this._targetNode&&this._targetNode.isValid){var t=this._clip.eventGroups;if(!(e<0||e>=t.length||this._ignoreIndex===e)){var i=t[e],n=this._targetNode.components,r=i.events,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}var l=o,c=l.functionName,u=n,h=Array.isArray(u),f=0;for(u=h?u:u[Symbol.iterator]();;){var d;if(h){if(f>=u.length)break;d=u[f++]}else{if((f=u.next()).done)break;d=f.value}var p=d,_=p[c];"function"==typeof _&&_.apply(p,l.parameters)}}}}}},{key:"curveLoaded",get:function(){return this._curveLoaded}}]),n}());function NR(e){return e-(0|e)==0&&(e-=1),0|e}function UR(e,r,u,h){var t,i,a,s,o,f=new r,d=new r,p=new r;return ho(e)((a=m((i=function(){function n(e,t,i){y(this,n),v(this,"dataPoint",a,this),v(this,"inTangent",s,this),v(this,"outTangent",o,this),this.dataPoint=e||new r,this.inTangent=t||new r,this.outTangent=i||new r}return l(n,[{key:"lerp",value:function(e,t,i){var n=this.dataPoint,r=e.dataPoint;d=u(d,this.outTangent,i),p=u(p,e.inTangent,i);var a=t*t*t,s=t*t,o=a-2*s+t,l=-2*a+3*s,c=a-s;return f=u(f,n,2*a-3*s+1),f=h(f,f,d,o),f=h(f,f,r,l),f=h(f,f,p,c)}},{key:"getNoLerp",value:function(){return this.dataPoint}}]),n}()).prototype,"dataPoint",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new r}}),s=m(i.prototype,"inTangent",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new r}}),o=m(i.prototype,"outTangent",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new r}}),t=i))||t}cc.AnimationState=FR;var VR=P2("CubicSplineVec2Value",UR("cc.CubicSplineVec2Value",Mi,Mi.multiplyScalar,Mi.scaleAndAdd));cc.CubicSplineVec2Value=VR;var GR=P2("CubicSplineVec3Value",UR("cc.CubicSplineVec3Value",Fi,Fi.multiplyScalar,Fi.scaleAndAdd));cc.CubicSplineVec3Value=GR;var HR=P2("CubicSplineVec4Value",UR("cc.CubicSplineVec4Value",Wi,Wi.multiplyScalar,Wi.scaleAndAdd));cc.CubicSplineVec4Value=HR;var qR=P2("CubicSplineQuatValue",UR("cc.CubicSplineQuatValue",hn,hn.multiplyScalar,hn.scaleAndAdd));cc.CubicSplineQuatValue=qR;var jR=P2("CubicSplineNumberValue",ho("cc.CubicSplineNumberValue")((BR=m((zR=function(){function n(e,t,i){y(this,n),v(this,"dataPoint",BR,this),v(this,"inTangent",PR,this),v(this,"outTangent",DR,this),this.dataPoint=e,this.inTangent=t,this.outTangent=i}return l(n,[{key:"lerp",value:function(e,t,i){var n=this.dataPoint,r=e.dataPoint,a=t*t*t,s=t*t;return n*(2*a-3*s+1)+this.outTangent*i*(a-2*s+t)+r*(-2*a+3*s)+e.inTangent*i*(a-s)}},{key:"getNoLerp",value:function(){return this.dataPoint}}]),n}()).prototype,"dataPoint",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),PR=m(zR.prototype,"inTangent",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),DR=m(zR.prototype,"outTangent",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),LR=zR))||LR);cc.CubicSplineNumberValue=jR;var WR,XR,YR,QR,KR,ZR,JR,$R,eO,tO,iO,nO,rO,aO,sO,oO=function(){function i(){var e;return y(this,i),(e=x(this,g(i).call(this)))._managedStates=[],e._fadings=[],e}return p(i,RR),l(i,[{key:"update",value:function(e){if(this.isPlaying&&!this.isPaused){for(var t=0;t<this._managedStates.length;++t){var i=this._managedStates[t].state;i&&(i.weight=0)}for(var n=1,r=this._fadings.length,a=0;a<this._fadings.length;++a){if(0===n){r=a;break}var s=this._fadings[a];s.easeTime+=e;var o=_i(s.easeTime/s.easeDuration),l=o*n;n*=1-o,s.target.state&&(s.target.state.weight+=l)}if(r!==this._fadings.length){for(var c=r;c<this._fadings.length;++c){var u=this._fadings[c];--u.target.reference,u.target.reference<=0&&(u.target.state&&u.target.state.stop(),fe(this._managedStates,u.target))}this._fadings.splice(r)}}}},{key:"crossFade",value:function(t,e){0===e&&this.clear();var i=this._managedStates.find(function(e){return e.state===t});i||(i={state:t,reference:0},t&&t.play(),this._managedStates.push(i)),++i.reference,this._fadings.unshift({easeDuration:e,easeTime:0,target:i})}},{key:"onPlay",value:function(){_(g(i.prototype),"onPlay",this).call(this),Yb.getAnimationManager().addCrossFade(this)}},{key:"onPause",value:function(){_(g(i.prototype),"onPause",this).call(this),Yb.getAnimationManager().removeCrossFade(this);for(var e=0;e<this._managedStates.length;++e){var t=this._managedStates[e].state;t&&t.pause()}}},{key:"onResume",value:function(){_(g(i.prototype),"onResume",this).call(this),Yb.getAnimationManager().addCrossFade(this);for(var e=0;e<this._managedStates.length;++e){var t=this._managedStates[e].state;t&&t.resume()}}},{key:"onStop",value:function(){_(g(i.prototype),"onStop",this).call(this),Yb.getAnimationManager().removeCrossFade(this),this.clear()}},{key:"clear",value:function(){for(var e=0;e<this._managedStates.length;++e){var t=this._managedStates[e].state;t&&t.stop()}this._managedStates.length=0,this._fadings.length=0}}]),i}();(sO=aO=aO||P2("EventType",{})).PLAY="play",sO.STOP="stop",sO.PAUSE="pause",sO.RESUME="resume",sO.LASTFRAME="lastframe",sO.FINISHED="finished",mt(aO);var lO,cO=P2("AnimationComponent",(WR=ho("cc.AnimationComponent"),XR=go(99),YR=yo("Components/Animation"),QR=fo({type:[xR]}),KR=fo({type:xR}),ZR=fo({type:[xR]}),WR(JR=XR(JR=vo(JR=YR((rO=nO=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"playOnLoad",eO,u(t)),t._callbackTable=ke(!0),t._crossFade=new oO,t._nameToState=ke(!0),v(t,"_clips",tO,u(t)),v(t,"_defaultClip",iO,u(t)),t}return p(a,Bv),l(a,[{key:"onLoad",value:function(){this.clips=this._clips;for(var e=0,t=Object.keys(this._nameToState);e<t.length;e++){var i=t[e];this._nameToState[i].initialize(this.node)}}},{key:"start",value:function(){this._crossFade.play(),this.playOnLoad&&this._defaultClip&&this.crossFade(this._defaultClip.name,0)}},{key:"onEnable",value:function(){this._crossFade.resume()}},{key:"onDisable",value:function(){this._crossFade.pause()}},{key:"onDestroy",value:function(){this._crossFade.stop();for(var e=0,t=Object.keys(this._nameToState);e<t.length;e++){var i=t[e];this._nameToState[i].stop()}this._nameToState=ke(!0)}},{key:"play",value:function(e){if(!e){if(!this._defaultClip)return;e=this._defaultClip.name}this.crossFade(e,0)}},{key:"crossFade",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:.3,n=this._nameToState[e];n&&this._crossFade.crossFade(n,i)}},{key:"pause",value:function(){this._crossFade.pause()}},{key:"resume",value:function(){this._crossFade.resume()}},{key:"stop",value:function(){this._crossFade.stop()}},{key:"getAnimationState",value:function(e){return this.getState(e)}},{key:"getState",value:function(e){var t=this._nameToState[e];return t&&!t.curveLoaded&&t.initialize(this.node),t||null}},{key:"createState",value:function(e,t){return t=t||e.name,this.removeState(t),this._doCreateState(e,t)}},{key:"removeState",value:function(e){var t=this._nameToState[e];t&&(t.stop(),delete this._nameToState[e])}},{key:"addClip",value:function(e,t){return pe(this._clips,e)||this._clips.push(e),this.createState(e,t)}},{key:"removeClip",value:function(t,e){for(var i,n=0,r=Object.keys(this._nameToState);n<r.length;n++){var a=r[n];if((i=this._nameToState[a]).clip===t)break}if(t===this._defaultClip){if(!e)return void B(3902);this._defaultClip=null}if(i&&i.isPlaying){if(!e)return void B(3903);i.stop()}this._clips=this._clips.filter(function(e){return e!==t}),i&&delete this._nameToState[i.name]}},{key:"on",value:function(e,t,i){var n=ll.prototype.on.call(this,e,t,i);if("lastframe"===e)for(var r=0,a=Object.keys(this._nameToState);r<a.length;r++){var s=a[r];this._nameToState[s]._lastframeEventOn=!0}return n}},{key:"off",value:function(e,t,i){if("lastframe"===e)for(var n=this._nameToState,r=0,a=Object.keys(n);r<a.length;r++){n[a[r]]._lastframeEventOn=!1}ll.prototype.off.call(this,e,t,i)}},{key:"targetOff",value:function(e){}},{key:"once",value:function(e,t,i){}},{key:"dispatchEvent",value:function(e){}},{key:"hasEventListener",value:function(e,t,i){return!1}},{key:"removeAll",value:function(e){}},{key:"emit",value:function(e){}},{key:"_createState",value:function(e,t){return new FR(e,t)}},{key:"_doCreateState",value:function(e,t){var i=this._createState(e,t);return i._setEventTarget(this),this.node&&i.initialize(this.node),this._nameToState[i.name]=i}},{key:"_getStateByNameOrDefaultClip",value:function(e){if(!e){if(!this._defaultClip)return null;e=this._defaultClip.name}var t=this._nameToState[e];return t||null}},{key:"_removeStateOfAutomaticClip",value:function(e){for(var t in this._nameToState){var i=this._nameToState[t];dO(e,i.clip)&&(i.stop(),delete this._nameToState[t])}}},{key:"clips",get:function(){return this._clips},set:function(e){var t=this;this._crossFade&&this._crossFade.clear();var i=this._clips,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;s&&this._removeStateOfAutomaticClip(s)}var o=e,l=Array.isArray(o),c=0;for(o=l?o:o[Symbol.iterator]();;){var u;if(l){if(c>=o.length)break;u=o[c++]}else{if((c=o.next()).done)break;u=c.value}var h=u;h&&this.createState(h)}var f=e.find(function(e){return dO(e,t._defaultClip)});this._defaultClip=f||null,this._clips=e}},{key:"defaultClip",get:function(){return this._defaultClip},set:function(t){(this._defaultClip=t)&&(0<=this._clips.findIndex(function(e){return dO(e,t)})||(this._clips.push(t),this.createState(t)))}}]),a}(),nO.EventType=aO,m(($R=rO).prototype,"clips",[QR],Object.getOwnPropertyDescriptor($R.prototype,"clips"),$R.prototype),m($R.prototype,"defaultClip",[KR],Object.getOwnPropertyDescriptor($R.prototype,"defaultClip"),$R.prototype),eO=m($R.prototype,"playOnLoad",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),tO=m($R.prototype,"_clips",[ZR],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),iO=m($R.prototype,"_defaultClip",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),JR=$R))||JR)||JR)||JR)||JR)),uO=cO.prototype,hO=uO.on,fO=uO.off;function dO(e,t){return e===t||!(!e||!t||e.name!==t.name&&e._uuid!==t._uuid)}lu(cO,[sl,ll]),cO.prototype.on=hO,cO.prototype.off=fO,cc.AnimationComponent=cO;var pO=P2("SkeletalAnimationClip",ho("cc.SkeletalAnimationClip")(lO=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n)))).originalKeys=[],t.convertedData={},t._converted=!1,t}return p(a,xR),l(a,[{key:"getPropertyCurves",value:function(e){return this.hash,e.getComponent(cc.SkeletalAnimationComponent)?this._convertToSkeletalCurves(e):console.warn("skeletal clip in non-skeletal component"),_(g(a.prototype),"getPropertyCurves",this).call(this,e)}},{key:"_convertToSkeletalCurves",value:function(e){var a=this;if(!this._converted){var s={};this.curves.forEach(function(e){if(!e.valueAdapter&&iR(e.modifiers[0],nR)&&eR(e.modifiers[1])){var t=e.modifiers[0].path,i=s[t];i=i||(s[t]={props:{}});var n=e.modifiers[1];i.props[n]=e.data}}),this.convertedData=s,this.curves=[];for(var t=function(){var n=o[i],r=s[n]&&s[n].props;if(!r)return"continue";Object.defineProperty(r,"worldMatrix",{get:function(){if(!r._worldMatrix){var e=r.position,t=r.rotation,i=r.scale;a._convertToUniformSample(e),a._convertToUniformSample(t),a._convertToUniformSample(i),a._convertToWorldSpace(n,r)}return r._worldMatrix}})},i=0,o=Object.keys(s);i<o.length;i++)t();for(var n=new Array(Math.ceil(this.sample*this._duration/this.speed)+1),r=0;r<n.length;r++)n[r]=r;var l=[{modifiers:[new nR(""),new rR("cc.SkeletalAnimationComponent"),"frameID"],data:{keys:0,values:n,interpolate:!1}}];if(this.curves=l,this.originalKeys=this._keys,this._keys=[n.map(function(e,t){return t*a.speed/a.sample})],this._duration=this._keys[0][n.length-1],this._converted=!0,e)for(var c=e.getComponentsInChildren(fk),u=0;u<c.length;++u){var h=c[u];if(h.skinningRoot===e&&h.skeleton){var f=h.skeleton.joints,d=Array.isArray(f),p=0;for(f=d?f:f[Symbol.iterator]();;){var _;if(d){if(p>=f.length)break;_=f[p++]}else{if((p=f.next()).done)break;_=p.value}var v=s[_];v&&v.props&&v.props.worldMatrix}}}}}},{key:"_convertToUniformSample",value:function(e){var t=this.originalKeys[e.keys];e.keys=0;var i=this._keys[0].length,n=[];if(t&&1!==t.length)for(var r=0,a=0;r<i;r++){for(var s=r*this.speed/this.sample;t[a]<=s;)a++;a>t.length-1?s=t[a=t.length-1]:0===a&&(a=1);var o=e.values[a-1].clone();o.lerp(e.values[a],(s-t[a-1])/(t[a]-t[a-1])),n[r]=o}else for(var l=0;l<i;l++)n[l]=e.values[0].clone();e.values=n}},{key:"_convertToWorldSpace",value:function(e,t){var i=t.position.values,n=t.rotation.values,r=t.scale.values,a=i.map(function(){return new zn}),s=e.lastIndexOf("/"),o=null;if(0<s){var l=e.substring(0,s),c=this.convertedData[l];if(!c||!c.props)return void console.warn("no data for parent bone?");o=c.props.worldMatrix.values}for(var u=0;u<i.length;u++){var h=i[u],f=n[u],d=r[u],p=a[u];zn.fromRTS(p,f,h,d),o&&zn.multiply(p,o[u],p)}Object.keys(t).forEach(function(e){return delete t[e]}),t._worldMatrix={keys:0,interpolate:!1,values:a}}}]),a}())||lO);cc.SkeletalAnimationClip=pO;var _O=new zn;function vO(e,t){for(var i=e,n="";null!==i&&i!==t;)n="".concat(i.name,"/").concat(n),i=i.parent;return n.slice(0,-1)}function mO(e,t,i){for(zn.identity(i);e!==t;)zn.fromRTS(_O,e.rotation,e.position,e.scale),zn.multiply(i,_O,i),e=e.parent}var yO=new zn;var gO,bO,xO,SO,wO,TO,EO,CO,AO,kO,RO,OO,MO,IO,LO,zO,BO=P2("SkeletalAnimationState",function(){function n(){return y(this,n),x(this,g(n).apply(this,arguments))}return p(n,FR),l(n,[{key:"onPlay",value:function(){_(g(n.prototype),"onPlay",this).call(this);for(var e=this._targetNode.getComponentsInChildren(fk),t=0;t<e.length;++t){var i=e[t];i.skinningRoot===this._targetNode&&i.uploadAnimation(this.clip)}}},{key:"rebuildSocketCurves",value:function(e){if(this._samplerSharedGroups.length){for(var t,i=this._samplerSharedGroups[0].curves,n=0;n<i.length;n++){var r=i[n].curveDetail;3===(t=r.modifiers).length&&t[0]instanceof nR&&t[1]instanceof rR&&"frameID"===t[2]||i.splice(n--,1)}for(var a=0;a<e.length;++a){var s=this._buildSocketData(e[a]);s&&i.push(s)}}}},{key:"_buildSocketData",value:function(e){if(!this._targetNode)return null;var t=this._targetNode,i=t.getChildByPath(e.path);if(!i||!e.target)return null;for(var n=e.path,r=this.clip.convertedData,a=n,s=r[a],o=i;!s||!s.props;){var l=a.lastIndexOf("/");if(s=r[a=a.substring(0,l)],o=o.parent,l<0)return null}var c={matrix:{keys:0,interpolate:!1,values:s.props.worldMatrix.values.map(function(e){return e.clone()})}},u=c.matrix.values;mO(i,o,yO);for(var h=0;h<u.length;h++){var f=u[h];zn.multiply(f,f,yO)}var d=this.clip.duration,p=new nR;return new IR({curve:new Vk(c.matrix,d),modifiers:[p,"matrix"]},e.target)}}]),n}());cc.SkeletalAnimationState=BO;var PO=P2("Socket",(gO=ho("cc.SkeletalAnimationComponent.Socket"),bO=fo(Sm),gO((wO=m((SO=function e(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;y(this,e),v(this,"path",wO,this),v(this,"target",TO,this),this.path=t,this.target=i}).prototype,"path",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),TO=m(SO.prototype,"target",[bO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),xO=SO))||xO)),DO=new zn;function FO(e,t,i){for(var n=1<arguments.length&&void 0!==t?t:"",r=2<arguments.length&&void 0!==i?i:[],a=0;a<e.children.length;a++){var s=e.children[a];if(s){var o=n?"".concat(n,"/").concat(s.name):s.name;r.push(o),FO(s,o,r)}}return r}var NO,UO,VO,GO,HO=P2("SkeletalAnimationComponent",(EO=ho("cc.SkeletalAnimationComponent"),CO=go(99),AO=yo("Components/SkeletalAnimation"),kO=fo({type:[PO]}),RO=fo({type:[PO]}),EO(OO=CO(OO=vo(OO=AO((zO=LO=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"_sockets",IO,u(t)),t._animInfo=null,t}return p(a,cO),l(a,[{key:"onLoad",value:function(){_(g(a.prototype),"onLoad",this).call(this),this._animInfo=mf.create(this.node.uuid)}},{key:"onDestroy",value:function(){this._animInfo&&(mf.destroy(this.node.uuid),this._animInfo=null),_(g(a.prototype),"onDestroy",this).call(this)}},{key:"start",value:function(){_(g(a.prototype),"start",this).call(this),this.sockets=this._sockets}},{key:"querySockets",value:function(){var e=[];if(!this._defaultClip)return e;for(var t=Object.keys(this._defaultClip.convertedData).sort().reduce(function(e,t){return t.startsWith(e[e.length-1])||e.push(t),e},[]),i=0;i<t.length;i++){var n=t[i],r=this.node.getChildByPath(n);r&&(e.push(n),FO(r,n,e))}return e}},{key:"rebuildSocketAnimations",value:function(){var e=this._sockets,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n,a=this.node.getChildByPath(r.path),s=r.target;a&&s&&(s.name="".concat(r.path.substring(r.path.lastIndexOf("/")+1)," Socket"),s.parent=this.node,mO(a,this.node,DO),s.matrix=DO)}for(var o=0,l=Object.keys(this._nameToState);o<l.length;o++){var c=l[o];this._nameToState[c].rebuildSocketCurves(this._sockets)}}},{key:"createSocket",value:function(t){var e=this._sockets.find(function(e){return e.path===t});if(e)return e.target;if(!this.node.getChildByPath(t))return console.warn("illegal socket path"),null;var i=new Sm;return i.parent=this.node,this._sockets.push(new PO(t,i)),this.rebuildSocketAnimations(),i}},{key:"_createState",value:function(e,t){return new BO(e,t)}},{key:"_doCreateState",value:function(e,t){e instanceof pO||console.warn("non-skeletal clip in skeletal component");var i=_(g(a.prototype),"_doCreateState",this).call(this,e,t);return i.rebuildSocketCurves(this._sockets),i}},{key:"sockets",get:function(){return this._sockets},set:function(e){this._sockets=e,this.rebuildSocketAnimations()}},{key:"frameID",set:function(e){if(this._animInfo){var t=this._animInfo,i=t.data,n=t.buffer;i[1]=e,n.update(i)}},get:function(){return this._animInfo&&this._animInfo.data[1]||0}}]),a}(),LO.Socket=PO,IO=m((MO=zO).prototype,"_sockets",[kO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),m(MO.prototype,"sockets",[RO],Object.getOwnPropertyDescriptor(MO.prototype,"sockets"),MO.prototype),OO=MO))||OO)||OO)||OO)||OO));cc.SkeletalAnimationComponent=HO;var qO,jO=P2("UniformCurveValueAdapter",ho("cc.UniformCurveValueAdapter")((VO=m((UO=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"passIndex",VO,u(t)),v(t,"uniformName",GO,u(t)),t}return p(a,Gk),l(a,[{key:"forTarget",value:function(e){var i=e.passes[this.passIndex],t=i.getHandle(this.uniformName);if(void 0===t)throw new Error('Material "'.concat(e.name,'" has no uniform "').concat(this.uniformName,'"'));var n=Vd.getBindingTypeFromHandle(t);if(n===wc.UNIFORM_BUFFER)return function(e,t){var i=e.shaderInfo.blocks,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a.members,o=Array.isArray(s),l=0;for(s=o?s:s[Symbol.iterator]();;){var c;if(o){if(l>=s.length)break;c=s[l++]}else{if((l=s.next()).done)break;c=l.value}var u=c;if(u.name===t)return 1<u.count}}return!1}(i,this.uniformName)?{set:function(e){i.setUniformArray(t,e)}}:{set:function(e){i.setUniform(t,e)}};if(n!==wc.SAMPLER)throw new Error("Animations are not avaiable for uniforms with binding type ".concat(n,"."));var r=Vd.getBindingFromHandle(t),a=i.properties[this.uniformName],s=a&&a.value?a.value+"-texture":Fd[a.type],o=kd.get(s);return o||(console.warn("illegal texture default value: "+s),o=kd.get("default-texture")),{set:function(e){var t=(e=e||o).getGFXTextureView();t&&t.texture.width&&t.texture.height&&(i.bindTextureView(r,t),e instanceof ah&&i.bindSampler(r,nh.getSampler(cc.game._gfxDevice,e.getSamplerHash())))}}}}]),a}()).prototype,"passIndex",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),GO=m(UO.prototype,"uniformName",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),NO=UO))||NO);cc.UniformCurveValueAdapter=jO,sr(cO.prototype,"AnimationComponent",[{name:"getAnimationState",newName:"getState"},{name:"removeClip",newName:"removeState",customFunction:function(e){var t=arguments.length<=0?void 0:e;return cO.prototype.removeState.call(this,t.name)}}]),cc.easing=Fp;var WO,XO=ho("cc.Counter")(qO=function(){function n(e,t,i){y(this,n),this._id=void 0,this._opts=void 0,this._accumStart=void 0,this._total=0,this._value=0,this._averageValue=0,this._accumValue=0,this._accumSamples=0,this._id=e,this._opts=t,this._accumStart=i}return l(n,[{key:"value",get:function(){return this._value},set:function(e){this._value=e}}]),l(n,[{key:"sample",value:function(e){this._average(this._value,e)}},{key:"human",value:function(e){var t=!(0<arguments.length&&void 0!==e)||e,i=this._opts.average?this._averageValue:this._value;return t?Math.round(100*i)/100:Math.round(i)}},{key:"alarm",value:function(){return this._opts.below&&this._value<this._opts.below||this._opts.over&&this._value>this._opts.over}},{key:"_average",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:0;if(this._opts.average){this._accumValue+=e,++this._accumSamples;var n=i;n-this._accumStart>=this._opts.average&&(this._averageValue=this._accumValue/this._accumSamples,this._accumValue=0,this._accumStart=n,this._accumSamples=0)}}}]),n}())||qO,YO=ho("cc.PerfCounter")(WO=function(){function r(e,t,i){var n;return y(this,r),(n=x(this,g(r).call(this,e,t,i)))._time=void 0,n._time=i,n}return p(r,XO),l(r,[{key:"start",value:function(e){var t=0<arguments.length&&void 0!==e?e:0;this._time=t}},{key:"end",value:function(e){var t=0<arguments.length&&void 0!==e?e:0;this._value=t-this._time,this._average(this._value)}},{key:"tick",value:function(){this.end(),this.start()}},{key:"frame",value:function(e){var t=e,i=t-this._time;this._total++,(this._opts.average||1e3)<i&&(this._value=1e3*this._total/i,this._total=0,this._time=t,this._average(this._value))}}]),r}())||WO,QO=P2("Profiler",function(){function e(){y(this,e),this._stats=null,this._showFPS=!1,this._fontSize=22,this._lineHeight=this._fontSize+2,this._left=10,this._right=10,this._top=10,this._bottom=10,this._rootNode=null,this._device=null,this._canvas=null,this._ctx=null,this._texture=null,this._textureView=null,this._region=new Yc,this._canvasArr=[],this._regionArr=[this._region],this._canvasDone=!1,this._statsDone=!1,this._canvas=document.createElement("canvas"),this._ctx=this._canvas.getContext("2d"),this._region=new Yc,this._canvasArr.push(this._canvas)}return l(e,[{key:"isShowingStats",value:function(){return this._showFPS}},{key:"hideStats",value:function(){this._showFPS&&(this._rootNode&&(this._rootNode.active=!1),Yb.off(Xb.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),Yb.off(Xb.EVENT_AFTER_UPDATE,this.afterUpdate,this),Yb.off(Xb.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),Yb.off(Xb.EVENT_AFTER_PHYSICS,this.afterPhysics,this),Yb.off(Xb.EVENT_BEFORE_DRAW,this.beforeDraw,this),Yb.off(Xb.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!1)}},{key:"showStats",value:function(){this._showFPS||(this.initDevice(),this.generateCanvas(),this.generateStats(),this._rootNode&&(this._rootNode.active=!0),Yb.on(Xb.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),Yb.on(Xb.EVENT_AFTER_UPDATE,this.afterUpdate,this),Yb.on(Xb.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),Yb.on(Xb.EVENT_AFTER_PHYSICS,this.afterPhysics,this),Yb.on(Xb.EVENT_BEFORE_DRAW,this.beforeDraw,this),Yb.on(Xb.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!0,this._canvasDone=!0,this._statsDone=!0)}},{key:"initDevice",value:function(){this._device||(this._device=Yb.root.device)}},{key:"generateCanvas",value:function(){if(!this._canvasDone){this._ctx&&this._canvas&&(this._canvas.width=350,this._canvas.height=200,this._canvas.style.width="".concat(this._canvas.width),this._canvas.style.height="".concat(this._canvas.height),this._ctx.font="".concat(this._fontSize,"px Arial"),this._ctx.textBaseline="top",this._ctx.fillStyle="#fff",this._texture=this._device.createTexture({type:hc.TEX2D,usage:dc.SAMPLED,format:Il.RGBA8,width:350,height:200,mipLevel:1}),this._textureView=this._device.createTextureView({texture:this._texture,type:gc.TV2D,format:Il.RGBA8}),this._region.texExtent.width=350,this._region.texExtent.height=200)}}},{key:"generateStats",value:function(){if(!this._statsDone&&this._ctx){this._stats=null;var e=performance.now(),t={frame:{desc:"Frame time (ms)",min:0,max:50,average:500},fps:{desc:"Framerate (FPS)",below:30,average:500},draws:{desc:"Draw call"},tricount:{desc:"Triangle"},logic:{desc:"Game Logic (ms)",min:0,max:50,average:500,color:"#080"},physics:{desc:"Physics (ms)",min:0,max:50,average:500},render:{desc:"Renderer (ms)",min:0,max:50,average:500,color:"#f90"},textureMemory:{desc:"GFX Texture Mem(M)"},bufferMemory:{desc:"GFX Buffer Mem(M)"}};this._ctx.textAlign="left";for(var i=0,n=0,r=Object.keys(t);n<r.length;n++){var a=r[n];this._ctx.fillText(t[a].desc,this._left,this._top+i*this._lineHeight),t[a].counter=new YO(a,t[a],e),i++}this._ctx.textAlign="end",this._stats=t}}},{key:"generateNode",value:function(){if(!this._rootNode||!this._rootNode.isValid){this._rootNode=new Sm("PROFILER_NODE"),cc.game.addPersistRootNode(this._rootNode);var e=new Sm("Profiler_Camera");e.setPosition(0,0,1),e.parent=this._rootNode;var t=e.addComponent("cc.CameraComponent");t.projection=jE.ProjectionType.ORTHO,t.near=0,t.far=0,t.orthoHeight=this._device.height,t.visibility=qh.BitMask.PROFILER,t.clearFlags=Vc.DEPTH|Vc.STENCIL,t.priority=1073741928;var i=new Sm("Profiler_Root");i.parent=this._rootNode;var n=i.addComponent("cc.ModelComponent");n.mesh=Ef({positions:[-.3,-.2,0,-.3,.2,0,.3,.2,0,.3,-.2,0],indices:[0,2,1,0,3,2],uvs:[0,1,0,0,1,0,1,1]});var r=new cp;r.initialize({effectName:"util/profiler"}),r.setProperty("offset",new Wi(-.9,-.9,0,0));var a=r.passes[0],s=a.getBinding("mainTexture");a.bindTextureView(s,this._textureView),n.material=r,n.node.layer=qh.Enum.PROFILER}}},{key:"beforeUpdate",value:function(){if(this._stats){this.generateNode();var e=performance.now();this.getCounter("frame").end(e),this.getCounter("frame").start(e),this.getCounter("logic").start(e)}}},{key:"afterUpdate",value:function(){if(this._stats){var e=performance.now();Yb.isPaused()?this.getCounter("frame").start(e):this.getCounter("logic").end(e)}}},{key:"beforePhysics",value:function(){if(this._stats){var e=performance.now();this.getCounter("physics").start(e)}}},{key:"afterPhysics",value:function(){if(this._stats){var e=performance.now();this.getCounter("physics").end(e)}}},{key:"beforeDraw",value:function(){if(this._stats){var e=performance.now();this.getCounter("render").start(e)}}},{key:"afterDraw",value:function(){if(this._stats&&this._ctx&&this._canvas){var e=performance.now();this.getCounter("fps").frame(e),this.getCounter("draws").value=this._device.numDrawCalls,this.getCounter("bufferMemory").value=this._device.memoryStatus.bufferSize/1048576,this.getCounter("textureMemory").value=this._device.memoryStatus.textureSize/1048576,this.getCounter("tricount").value=this._device.numTris,this.getCounter("render").end(e);var t=this._left+this._ctx.measureText("GFX Texture Mem(M)").width;this._ctx.clearRect(t,0,this._canvas.width-t,this._canvas.height);for(var i=0,n=0,r=Object.keys(this._stats);n<r.length;n++){var a=r[n],s=this._stats[a];s.counter.sample(e),this._ctx.fillText(s.counter.human(!("Framerate (FPS)"===s.desc)),this._canvas.width-this._right,this._top+i*this._lineHeight),i++}this._canvasArr[0]=this._canvas,this.updateTexture()}}},{key:"getCounter",value:function(e){return this._stats[e].counter}},{key:"updateTexture",value:function(){Yb.root.device.copyTexImagesToTexture(this._canvasArr,this._texture,this._regionArr)}}]),e}()),KO=P2("profiler",new QO);cc.profiler=KO;var ZO={};sr(ZO,"vmath",[{name:"vec2",newName:"Vec2",target:pr,targetName:"math"},{name:"vec3",newName:"Vec3",target:pr,targetName:"math"},{name:"vec4",newName:"Vec4",target:pr,targetName:"math"},{name:"quat",newName:"Quat",target:pr,targetName:"math"},{name:"mat3",newName:"Mat3",target:pr,targetName:"math"},{name:"mat4",newName:"Mat4",target:pr,targetName:"math"},{name:"color4",newName:"Color",target:pr,targetName:"math"},{name:"rect",newName:"Rect",target:pr,targetName:"math"},{name:"approx",newName:"approx",target:pr,targetName:"math"},{name:"EPSILON",newName:"EPSILON",target:pr,targetName:"math"},{name:"equals",newName:"equals",target:pr,targetName:"math"},{name:"clamp",newName:"clamp",target:pr,targetName:"math"},{name:"clamp01",newName:"clamp01",target:pr,targetName:"math"},{name:"lerp",newName:"lerp",target:pr,targetName:"math"},{name:"toRadian",newName:"toRadian",target:pr,targetName:"math"},{name:"toDegree",newName:"toDegree",target:pr,targetName:"math"},{name:"random",newName:"random",target:pr,targetName:"math"},{name:"randomRange",newName:"randomRange",target:pr,targetName:"math"},{name:"randomRangeInt",newName:"randomRangeInt",target:pr,targetName:"math"},{name:"pseudoRandom",newName:"pseudoRandom",target:pr,targetName:"math"},{name:"pseudoRandomRangeInt",newName:"pseudoRandomRangeInt",target:pr,targetName:"math"},{name:"nextPow2",newName:"nextPow2",target:pr,targetName:"math"},{name:"repeat",newName:"repeat",target:pr,targetName:"math"},{name:"pingPong",newName:"pingPong",target:pr,targetName:"math"},{name:"inverseLerp",newName:"inverseLerp",target:pr,targetName:"math"}]),cc.vmath=ZO,sr(Wb.prototype,"Scheduler.prototype",[{name:"enableForTarget",newName:"enableForTarget",target:Wb,targetName:"Scheduler"}]),cc.math=pr,cc.geometry=Vs;var JO,$O,eM,tM,iM=0,nM={},rM=function(e){if(void 0===nM[e]){var t=1<<iM;nM[e]=t,iM+=1}};($O=JO=JO||{})[$O.OPAQUE=0]="OPAQUE",$O[$O.TRANSPARENT=1]="TRANSPARENT",$O[$O.OVERLAY=2]="OVERLAY",(tM=eM=eM||{})[tM.DEFAULT=1]="DEFAULT",tM[tM.FORWARD=2]="FORWARD",tM[tM.SHADOWCAST=4]="SHADOWCAST",sr(gb.prototype,"RenderScene.prototype",[{name:"raycastUI",newName:"raycastUI2D"},{name:"raycastUINode",newName:"raycastUI2DNode"},{name:"raycast",newName:"raycastModels"}]);var aM={};or(aM,"CameraVisFlags",[{name:"GENERAL"}]),sr(aM,"CameraVisFlags",[{name:"PROFILER",newName:"PROFILER",target:qh.BitMask,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:qh.BitMask,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:qh.BitMask,targetName:"EDITOR"},{name:"UI",newName:"UI",target:qh.BitMask,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:qh.BitMask,targetName:"UI_2D"}]),cc.CameraVisFlags=aM;var sM={};or(sM,"VisibilityFlags",[{name:"GENERAL"}]),sr(sM,"VisibilityFlags",[{name:"ALWALS",newName:"ALWALS",target:qh.Enum,targetName:"ALWALS"},{name:"PROFILER",newName:"PROFILER",target:qh.Enum,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:qh.Enum,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:qh.Enum,targetName:"EDITOR"},{name:"UI",newName:"UI",target:qh.Enum,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:qh.Enum,targetName:"UI_2D"}]),cc.VisibilityFlags=sM;var oM=rM;cc.samplerLib=nh;var lM=Object.freeze({addStage:oM,samplerLib:nh,createIA:function(e,t){if(!t.positions)return console.error("The data must have positions field"),null;for(var i=[],n=t.positions.length/3,r=0;r<n;++r)i.push(t.positions[3*r],t.positions[3*r+1],t.positions[3*r+2]),t.normals&&i.push(t.normals[3*r],t.normals[3*r+1],t.normals[3*r+2]),t.uvs&&i.push(t.uvs[2*r],t.uvs[2*r+1]),t.colors&&i.push(t.colors[3*r],t.uvs[3*r+1],t.colors[3*r+2]);var a=[];a.push({name:kl.ATTR_POSITION,format:Il.RGB32F}),t.normals&&a.push({name:kl.ATTR_NORMAL,format:Il.RGB32F}),t.uvs&&a.push({name:kl.ATTR_TEX_COORD,format:Il.RG32F}),t.colors&&a.push({name:kl.ATTR_COLOR,format:Il.RGB32F});var s=e.createBuffer({usage:zl.VERTEX|zl.TRANSFER_DST,memUsage:Pl.HOST|Pl.DEVICE,size:4*i.length,stride:4*i.length/n});s.update(new Float32Array(i));var o=e.createBuffer({usage:zl.INDEX|zl.TRANSFER_DST,memUsage:Pl.HOST|Pl.DEVICE,size:2*t.indices.length,stride:2});return o.update(new Uint16Array(t.indices)),e.createInputAssembler({attributes:a,vertexBuffers:[s],indexBuffer:o})},get RenderQueue(){return JO},get PassStage(){return eM},Pass:Vd,programLib:Id,Light:f_,Camera:B_,Model:vf,SkinningModel:Sf,TextureBufferPool:ad,get JointsMediumType(){return nd},selectJointsMediumType:od,JointsTexturePool:Ed});P2("renderer",lM);var cM,uM,hM,fM,dM,pM,_M,vM,mM=P2("NodePool",function(){function t(e){y(this,t),this.poolHandlerComp=void 0,this._pool=void 0,this.poolHandlerComp=e,this._pool=[]}return l(t,[{key:"size",value:function(){return this._pool.length}},{key:"clear",value:function(){for(var e=this._pool.length,t=0;t<e;++t)this._pool[t].destroy();this._pool.length=0}},{key:"put",value:function(e){if(e&&-1===this._pool.indexOf(e)){e.removeFromParent();var t=this.poolHandlerComp?e.getComponent(this.poolHandlerComp):null;t&&t.unuse&&t.unuse(),this._pool.push(e)}}},{key:"get",value:function(){var e=this._pool.length-1;if(e<0)return null;var t=this._pool[e];this._pool.length=e;var i=this.poolHandlerComp?t.getComponent(this.poolHandlerComp):null;if(i&&i.reuse){for(var n,r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];(n=i.reuse).apply.apply(n,[i].concat(a))}return t}}]),t}());cc.NodePool=mM,(vM=_M=_M||{})[vM.BOX=0]="BOX",vM[vM.SPHERE=1]="SPHERE",vM[vM.CYLINDER=2]="CYLINDER",vM[vM.CONE=3]="CONE",vM[vM.CAPSULE=4]="CAPSULE",vM[vM.TORUS=5]="TORUS",vM[vM.PLANE=6]="PLANE",vM[vM.QUAD=7]="QUAD",mt(_M);var yM=P2("Primitive",(cM=ho("cc.Primitive"),uM=fo({type:_M}),cM((dM=m((fM=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"type",dM,u(t)),v(t,"info",pM,u(t)),t}return p(a,Fh),l(a,[{key:"onLoaded",value:function(){Ef(sb[_M[this.type]](this.info),this)}}]),a}()).prototype,"type",[uM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _M.BOX}}),pM=m(fM.prototype,"info",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{}}}),hM=fM))||hM));cc.Primitive=yM,cc.renderer=lM;P2("cclegacy",cc);cc.primitives=sb;var gM,bM,xM=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,bl.BINDING_LAYOUT)))._device=void 0,t._bindingUnits=[],t._isDirty=!1,t._device=e,t}return p(i,Hc),l(i,[{key:"bindBuffer",value:function(e,t){var i=this._bindingUnits,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;if(s.binding===e)return void(s.type===wc.UNIFORM_BUFFER?s.buffer!==t&&(s.buffer=t,this._isDirty=!0):console.error("Setting binding is not GFXBindingType.UNIFORM_BUFFER."))}}},{key:"bindSampler",value:function(e,t){var i=this._bindingUnits,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;if(s.binding===e)return void(s.type===wc.SAMPLER?s.sampler!==t&&(s.sampler=t,this._isDirty=!0):console.error("Setting binding is not GFXBindingType.SAMPLER."))}}},{key:"bindTextureView",value:function(e,t){var i=this._bindingUnits,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;if(s.binding===e)return void(s.type===wc.SAMPLER?s.texView!==t&&(s.texView=t,this._isDirty=!0):console.error("Setting binding is not GFXBindingType.SAMPLER."))}}},{key:"getBindingUnit",value:function(e){var t=this._bindingUnits,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;if(a.binding===e)return a}return null}}]),i}(),SM=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._gpuBindingLayout=null,t}return p(i,xM),l(i,[{key:"gpuBindingLayout",get:function(){return this._gpuBindingLayout}}]),l(i,[{key:"initialize",value:function(e){this._bindingUnits=new Array(e.bindings.length);for(var t=0;t<e.bindings.length;++t){var i=e.bindings[t];this._bindingUnits[t]={binding:i.binding,type:i.type,name:i.name,buffer:null,texView:null,sampler:null}}this._gpuBindingLayout={gpuBindings:new Array(e.bindings.length)};for(var n=0;n<e.bindings.length;++n){var r=e.bindings[n];this._gpuBindingLayout.gpuBindings[n]={binding:r.binding,type:r.type,name:r.name,gpuBuffer:null,gpuTexView:null,gpuSampler:null}}return this._status=Sl.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuBindingLayout=null,this._status=Sl.UNREADY}},{key:"update",value:function(){if(this._isDirty&&this._gpuBindingLayout){for(var e=0;e<this._bindingUnits.length;++e){var t=this._bindingUnits[e];switch(t.type){case wc.UNIFORM_BUFFER:t.buffer&&(this._gpuBindingLayout.gpuBindings[e].gpuBuffer=t.buffer.gpuBuffer);break;case wc.SAMPLER:t.texView&&(this._gpuBindingLayout.gpuBindings[e].gpuTexView=t.texView.gpuTextureView),t.sampler&&(this._gpuBindingLayout.gpuBindings[e].gpuSampler=t.sampler.gpuSampler)}}this._isDirty=!1}}}]),i}();function wM(e,t){switch(e){case Il.R8:return t.UNSIGNED_BYTE;case Il.R8SN:return t.BYTE;case Il.R8UI:return t.UNSIGNED_BYTE;case Il.R8I:return t.BYTE;case Il.R16F:return gM.HALF_FLOAT_OES;case Il.R16UI:return t.UNSIGNED_SHORT;case Il.R16I:return t.SHORT;case Il.R32F:return t.FLOAT;case Il.R32UI:return t.UNSIGNED_INT;case Il.R32I:return t.INT;case Il.RG8:return t.UNSIGNED_BYTE;case Il.RG8SN:return t.BYTE;case Il.RG8UI:return t.UNSIGNED_BYTE;case Il.RG8I:return t.BYTE;case Il.RG16F:return gM.HALF_FLOAT_OES;case Il.RG16UI:return t.UNSIGNED_SHORT;case Il.RG16I:return t.SHORT;case Il.RG32F:return t.FLOAT;case Il.RG32UI:return t.UNSIGNED_INT;case Il.RG32I:return t.INT;case Il.RGB8:case Il.SRGB8:return t.UNSIGNED_BYTE;case Il.RGB8SN:return t.BYTE;case Il.RGB8UI:return t.UNSIGNED_BYTE;case Il.RGB8I:return t.BYTE;case Il.RGB16F:return gM.HALF_FLOAT_OES;case Il.RGB16UI:return t.UNSIGNED_SHORT;case Il.RGB16I:return t.SHORT;case Il.RGB32F:return t.FLOAT;case Il.RGB32UI:return t.UNSIGNED_INT;case Il.RGB32I:return t.INT;case Il.RGBA8:case Il.SRGB8_A8:return t.UNSIGNED_BYTE;case Il.RGBA8SN:return t.BYTE;case Il.RGBA8UI:return t.UNSIGNED_BYTE;case Il.RGBA8I:return t.BYTE;case Il.RGBA16F:return gM.HALF_FLOAT_OES;case Il.RGBA16UI:return t.UNSIGNED_SHORT;case Il.RGBA16I:return t.SHORT;case Il.RGBA32F:return t.FLOAT;case Il.RGBA32UI:return t.UNSIGNED_INT;case Il.RGBA32I:return t.INT;case Il.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case Il.R11G11B10F:return t.FLOAT;case Il.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case Il.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case Il.RGB10A2:return t.UNSIGNED_BYTE;case Il.RGB10A2UI:return t.UNSIGNED_INT;case Il.RGB9E5:return t.UNSIGNED_BYTE;case Il.D16:case Il.D16S8:return t.UNSIGNED_SHORT;case Il.D24:return t.UNSIGNED_INT;case Il.D24S8:return gM.UNSIGNED_INT_24_8_WEBGL;case Il.D32F:case Il.D32F_S8:return t.FLOAT;case Il.BC1:case Il.BC1_SRGB:case Il.BC2:case Il.BC2_SRGB:case Il.BC3:case Il.BC3_SRGB:case Il.BC4:return t.UNSIGNED_BYTE;case Il.BC4_SNORM:return t.BYTE;case Il.BC5:return t.UNSIGNED_BYTE;case Il.BC5_SNORM:return t.BYTE;case Il.BC6H_SF16:case Il.BC6H_UF16:return t.FLOAT;case Il.BC7:case Il.BC7_SRGB:case Il.ETC_RGB8:case Il.ETC2_RGB8:case Il.ETC2_SRGB8:case Il.ETC2_RGB8_A1:case Il.ETC2_SRGB8_A1:case Il.ETC2_RGB8:case Il.ETC2_SRGB8:case Il.EAC_R11:return t.UNSIGNED_BYTE;case Il.EAC_R11SN:return t.BYTE;case Il.EAC_RG11:return t.UNSIGNED_BYTE;case Il.EAC_RG11SN:return t.BYTE;case Il.PVRTC_RGB2:case Il.PVRTC_RGBA2:case Il.PVRTC_RGB4:case Il.PVRTC_RGBA4:case Il.PVRTC2_2BPP:case Il.PVRTC2_4BPP:default:return t.UNSIGNED_BYTE}}function TM(e,t){switch(e){case Il.A8:return t.ALPHA;case Il.L8:return t.LUMINANCE;case Il.LA8:return t.LUMINANCE_ALPHA;case Il.RGB8:case Il.RGB16F:case Il.RGB32F:return t.RGB;case Il.RGBA8:case Il.RGBA16F:case Il.RGBA32F:return t.RGBA;case Il.R5G6B5:return t.RGB565;case Il.RGB5A1:return t.RGB5_A1;case Il.RGBA4:return t.RGBA4;case Il.D16:return t.DEPTH_COMPONENT;case Il.D16S8:return t.DEPTH_STENCIL;case Il.D24:return t.DEPTH_COMPONENT;case Il.D24S8:return t.DEPTH_STENCIL;case Il.D32F:return t.DEPTH_COMPONENT;case Il.D32F_S8:return t.DEPTH_STENCIL;case Il.BC1:return gM.COMPRESSED_RGB_S3TC_DXT1_EXT;case Il.BC1_ALPHA:return gM.COMPRESSED_RGBA_S3TC_DXT1_EXT;case Il.BC1_SRGB:return gM.COMPRESSED_SRGB_S3TC_DXT1_EXT;case Il.BC1_SRGB_ALPHA:return gM.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case Il.BC2:return gM.COMPRESSED_RGBA_S3TC_DXT3_EXT;case Il.BC2_SRGB:return gM.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case Il.BC3:return gM.COMPRESSED_RGBA_S3TC_DXT5_EXT;case Il.BC3_SRGB:return gM.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case Il.ETC_RGB8:return gM.COMPRESSED_RGB_ETC1_WEBGL;case Il.PVRTC_RGB2:return gM.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case Il.PVRTC_RGBA2:return gM.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case Il.PVRTC_RGB4:return gM.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case Il.PVRTC_RGBA4:return gM.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;default:return console.error("Unsupported GFXFormat, convert to WebGL internal format failed."),t.RGBA}}function EM(e,t){switch(e){case Il.A8:return t.ALPHA;case Il.L8:return t.LUMINANCE;case Il.LA8:return t.LUMINANCE_ALPHA;case Il.RGB8:case Il.RGB16F:case Il.RGB32F:return t.RGB;case Il.RGBA8:case Il.RGBA16F:case Il.RGBA32F:return t.RGBA;case Il.R5G6B5:return t.RGB;case Il.RGB5A1:case Il.RGBA4:return t.RGBA;case Il.D16:return t.DEPTH_COMPONENT;case Il.D16S8:return t.DEPTH_STENCIL;case Il.D24:return t.DEPTH_COMPONENT;case Il.D24S8:return t.DEPTH_STENCIL;case Il.D32F:return t.DEPTH_COMPONENT;case Il.D32F_S8:return t.DEPTH_STENCIL;case Il.BC1:return gM.COMPRESSED_RGB_S3TC_DXT1_EXT;case Il.BC1_ALPHA:return gM.COMPRESSED_RGBA_S3TC_DXT1_EXT;case Il.BC1_SRGB:return gM.COMPRESSED_SRGB_S3TC_DXT1_EXT;case Il.BC1_SRGB_ALPHA:return gM.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case Il.BC2:return gM.COMPRESSED_RGBA_S3TC_DXT3_EXT;case Il.BC2_SRGB:return gM.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case Il.BC3:return gM.COMPRESSED_RGBA_S3TC_DXT5_EXT;case Il.BC3_SRGB:return gM.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case Il.ETC_RGB8:return gM.COMPRESSED_RGB_ETC1_WEBGL;case Il.ETC2_RGB8:return gM.COMPRESSED_RGB8_ETC2;case Il.ETC2_SRGB8:return gM.COMPRESSED_SRGB8_ETC2;case Il.ETC2_RGB8_A1:return gM.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Il.ETC2_SRGB8_A1:return gM.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Il.ETC2_RGBA8:return gM.COMPRESSED_RGBA8_ETC2_EAC;case Il.ETC2_SRGB8_A8:return gM.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case Il.EAC_R11:return gM.COMPRESSED_R11_EAC;case Il.EAC_R11SN:return gM.COMPRESSED_SIGNED_R11_EAC;case Il.EAC_RG11:return gM.COMPRESSED_RG11_EAC;case Il.EAC_RG11SN:return gM.COMPRESSED_SIGNED_RG11_EAC;case Il.PVRTC_RGB2:return gM.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case Il.PVRTC_RGBA2:return gM.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case Il.PVRTC_RGB4:return gM.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case Il.PVRTC_RGBA4:return gM.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;default:return console.error("Unsupported GFXFormat, convert to WebGL format failed."),t.RGBA}}function CM(e,t){switch(e){case Ol.BOOL:return t.BOOL;case Ol.BOOL2:return t.BOOL_VEC2;case Ol.BOOL3:return t.BOOL_VEC3;case Ol.BOOL4:return t.BOOL_VEC4;case Ol.INT:return t.INT;case Ol.INT2:return t.INT_VEC2;case Ol.INT3:return t.INT_VEC3;case Ol.INT4:return t.INT_VEC4;case Ol.UINT:return t.UNSIGNED_INT;case Ol.FLOAT:return t.FLOAT;case Ol.FLOAT2:return t.FLOAT_VEC2;case Ol.FLOAT3:return t.FLOAT_VEC3;case Ol.FLOAT4:return t.FLOAT_VEC4;case Ol.MAT2:return t.FLOAT_MAT2;case Ol.MAT3:return t.FLOAT_MAT3;case Ol.MAT4:return t.FLOAT_MAT4;case Ol.SAMPLER2D:return t.SAMPLER_2D;case Ol.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),Ol.UNKNOWN}}function AM(e,t){switch(e){case t.BOOL:return Ol.BOOL;case t.BOOL_VEC2:return Ol.BOOL2;case t.BOOL_VEC3:return Ol.BOOL3;case t.BOOL_VEC4:return Ol.BOOL4;case t.INT:return Ol.INT;case t.INT_VEC2:return Ol.INT2;case t.INT_VEC3:return Ol.INT3;case t.INT_VEC4:return Ol.INT4;case t.UNSIGNED_INT:return Ol.UINT;case t.FLOAT:return Ol.FLOAT;case t.FLOAT_VEC2:return Ol.FLOAT2;case t.FLOAT_VEC3:return Ol.FLOAT3;case t.FLOAT_VEC4:return Ol.FLOAT4;case t.FLOAT_MAT2:return Ol.MAT2;case t.FLOAT_MAT3:return Ol.MAT3;case t.FLOAT_MAT4:return Ol.MAT4;case t.SAMPLER_2D:return Ol.SAMPLER2D;case t.SAMPLER_CUBE:return Ol.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GFXType failed."),Ol.UNKNOWN}}function kM(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function RM(e,t){switch(e){case t.FLOAT_MAT2:return 2;case t.FLOAT_MAT3:return 3;case t.FLOAT_MAT4:return 4;default:return 1}}(bM=gM=gM||{})[bM.RGBA16F_EXT=34842]="RGBA16F_EXT",bM[bM.RGB16F_EXT=34843]="RGB16F_EXT",bM[bM.RGBA32F_EXT=34836]="RGBA32F_EXT",bM[bM.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT",bM[bM.UNSIGNED_NORMALIZED_EXT=35863]="UNSIGNED_NORMALIZED_EXT",bM[bM.UNSIGNED_INT_24_8_WEBGL=34042]="UNSIGNED_INT_24_8_WEBGL",bM[bM.HALF_FLOAT_OES=36193]="HALF_FLOAT_OES",bM[bM.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",bM[bM.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",bM[bM.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",bM[bM.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",bM[bM.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",bM[bM.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",bM[bM.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",bM[bM.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",bM[bM.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",bM[bM.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",bM[bM.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",bM[bM.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",bM[bM.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",bM[bM.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",bM[bM.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",bM[bM.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",bM[bM.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",bM[bM.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",bM[bM.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",bM[bM.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",bM[bM.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",bM[bM.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",bM[bM.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC";var OM,MM,IM=[512,513,514,515,516,517,518,519],LM=[0,7680,7681,7682,7683,5386,34055,34056],zM=[32774,32778,32779,32774,32774],BM=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];(MM=OM=OM||{})[MM.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",MM[MM.END_RENDER_PASS=1]="END_RENDER_PASS",MM[MM.BIND_STATES=2]="BIND_STATES",MM[MM.DRAW=3]="DRAW",MM[MM.UPDATE_BUFFER=4]="UPDATE_BUFFER",MM[MM.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",MM[MM.COUNT=6]="COUNT";function PM(e){y(this,PM),this.cmdType=void 0,this.refCount=0,this.cmdType=e}var DM=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this,OM.BEGIN_RENDER_PASS))).gpuFramebuffer=null,e.renderArea={x:0,y:0,width:0,height:0},e.clearFlag=Vc.NONE,e.clearColors=[],e.clearDepth=1,e.clearStencil=0,e}return p(t,PM),l(t,[{key:"clear",value:function(){this.gpuFramebuffer=null,this.clearColors=[]}}]),t}(),FM=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this,OM.BIND_STATES))).gpuPipelineState=null,e.gpuBindingLayout=null,e.gpuInputAssembler=null,e.viewport=null,e.scissor=null,e.lineWidth=null,e.depthBias=null,e.blendConstants=null,e.depthBounds=null,e.stencilWriteMask=null,e.stencilCompareMask=null,e}return p(t,PM),l(t,[{key:"clear",value:function(){this.gpuPipelineState=null,this.gpuBindingLayout=null,this.gpuInputAssembler=null,this.viewport=null,this.scissor=null,this.lineWidth=null,this.depthBias=null,this.blendConstants=null,this.depthBounds=null,this.stencilWriteMask=null,this.stencilCompareMask=null}}]),t}(),NM=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this,OM.DRAW))).drawInfo={vertexCount:0,firstVertex:0,indexCount:0,firstIndex:0,vertexOffset:0,instanceCount:0,firstInstance:0},e}return p(t,PM),l(t,[{key:"clear",value:function(){}}]),t}(),UM=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this,OM.UPDATE_BUFFER))).gpuBuffer=null,e.buffer=null,e.offset=0,e.size=0,e}return p(t,PM),l(t,[{key:"clear",value:function(){this.gpuBuffer=null,this.buffer=null}}]),t}(),VM=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this,OM.COPY_BUFFER_TO_TEXTURE))).gpuBuffer=null,e.gpuTexture=null,e.dstLayout=null,e.regions=[],e}return p(t,PM),l(t,[{key:"clear",value:function(){this.gpuBuffer=null,this.gpuTexture=null,this.dstLayout=null,this.regions=[]}}]),t}(),GM=function(){function e(){y(this,e),this.cmds=new tg(1),this.beginRenderPassCmds=new tg(1),this.bindStatesCmds=new tg(1),this.drawCmds=new tg(1),this.updateBufferCmds=new tg(1),this.copyBufferToTextureCmds=new tg(1)}return l(e,[{key:"clearCmds",value:function(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()}}]),e}();function HM(e,t,i,n,r){if(t.usage&zl.UNIFORM)i instanceof Float32Array?t.vf32.set(i,n/Float32Array.BYTES_PER_ELEMENT):t.vf32.set(new Float32Array(i),n/Float32Array.BYTES_PER_ELEMENT);else if(t.usage&zl.INDIRECT)t.indirects=i.drawInfos;else{var a=i,s=e.gl,o=e.stateCache;switch(t.glTarget){case s.ARRAY_BUFFER:e.useVAO&&o.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),o.glVAO=null),e.stateCache.glArrayBuffer!==t.glBuffer&&(s.bindBuffer(s.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer);break;case s.ELEMENT_ARRAY_BUFFER:e.useVAO&&o.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),o.glVAO=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&(s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer);break;default:return void console.error("Unsupported GFXBufferType, update buffer failed.")}r===a.byteLength?s.bufferSubData(t.glTarget,n,a):s.bufferSubData(t.glTarget,n,a.slice(0,r))}}var qM=new Array(OM.COUNT);function jM(e,t){for(var i=e.gl,n=e.stateCache,r=0;r<OM.COUNT;++r)qM[r]=0;for(var a,s,o,l=null,c=null,u=!1,h=null,f=i.TRIANGLES,d=0;d<t.cmds.length;++d){var p=t.cmds.array[d],_=qM[p]++;switch(p){case OM.BEGIN_RENDER_PASS:var v=t.beginRenderPassCmds.array[_],m=0;if(v.gpuFramebuffer){n.glFramebuffer!==v.gpuFramebuffer.glFramebuffer&&(i.bindFramebuffer(i.FRAMEBUFFER,v.gpuFramebuffer.glFramebuffer),n.glFramebuffer=v.gpuFramebuffer.glFramebuffer),n.viewport.left===v.renderArea.x&&n.viewport.top===v.renderArea.y&&n.viewport.width===v.renderArea.width&&n.viewport.height===v.renderArea.height||(i.viewport(v.renderArea.x,v.renderArea.y,v.renderArea.width,v.renderArea.height),n.viewport.left=v.renderArea.x,n.viewport.top=v.renderArea.y,n.viewport.width=v.renderArea.width,n.viewport.height=v.renderArea.height),n.scissorRect.x===v.renderArea.x&&n.scissorRect.y===v.renderArea.y&&n.scissorRect.width===v.renderArea.width&&n.scissorRect.height===v.renderArea.height||(i.scissor(v.renderArea.x,v.renderArea.y,v.renderArea.width,v.renderArea.height),n.scissorRect.x=v.renderArea.x,n.scissorRect.y=v.renderArea.y,n.scissorRect.width=v.renderArea.width,n.scissorRect.height=v.renderArea.height);var y=v.gpuFramebuffer.gpuRenderPass,g=v.clearColors.length;e.WEBGL_draw_buffers||(g=1);for(var b=0;b<g;++b){var x=y.colorAttachments[b];if(x.format!==Il.UNKNOWN)switch(x.loadOp){case Ac.LOAD:break;case Ac.CLEAR:if(v.clearFlag&Vc.COLOR){n.bs.targets[0].blendColorMask!==rc.ALL&&i.colorMask(!0,!0,!0,!0);var S=v.clearColors[0];i.clearColor(S.r,S.g,S.b,S.a),m|=i.COLOR_BUFFER_BIT}break;case Ac.DISCARD:}}if(y.depthStencilAttachment&&y.depthStencilAttachment.format!==Il.UNKNOWN){switch(y.depthStencilAttachment.depthLoadOp){case Ac.LOAD:break;case Ac.CLEAR:v.clearFlag&Vc.DEPTH&&(n.dss.depthWrite||i.depthMask(!0),i.clearDepth(v.clearDepth),m|=i.DEPTH_BUFFER_BIT);break;case Ac.DISCARD:}if(Qc[y.depthStencilAttachment.format].hasStencil)switch(y.depthStencilAttachment.stencilLoadOp){case Ac.LOAD:break;case Ac.CLEAR:v.clearFlag&Vc.STENCIL&&(n.dss.stencilWriteMaskFront||i.stencilMaskSeparate(i.FRONT,4294967295),n.dss.stencilWriteMaskBack||i.stencilMaskSeparate(i.BACK,4294967295),i.clearStencil(v.clearStencil),m|=i.STENCIL_BUFFER_BIT);break;case Ac.DISCARD:}}if(m&&i.clear(m),m&i.COLOR_BUFFER_BIT){var w=n.bs.targets[0].blendColorMask;if(w!==rc.ALL){var T=(w&rc.R)!==rc.NONE,E=(w&rc.G)!==rc.NONE,C=(w&rc.B)!==rc.NONE,A=(w&rc.A)!==rc.NONE;i.colorMask(T,E,C,A)}}m&i.DEPTH_BUFFER_BIT&&!n.dss.depthWrite&&i.depthMask(!1),m&i.STENCIL_BUFFER_BIT&&(n.dss.stencilWriteMaskFront||i.stencilMaskSeparate(i.FRONT,0),n.dss.stencilWriteMaskBack||i.stencilMaskSeparate(i.BACK,0))}break;case OM.BIND_STATES:var k=t.bindStatesCmds.array[_];if(u=!1,k.gpuPipelineState){if(l=k.gpuPipelineState,f=k.gpuPipelineState.glPrimitive,k.gpuPipelineState.gpuShader){var R=k.gpuPipelineState.gpuShader.glProgram;n.glProgram!==R&&(i.useProgram(R),n.glProgram=R,u=!0),c=k.gpuPipelineState.gpuShader}var O=k.gpuPipelineState.rs;if(O){if(n.rs.cullMode!==O.cullMode){switch(O.cullMode){case Yl.NONE:i.disable(i.CULL_FACE);break;case Yl.FRONT:i.enable(i.CULL_FACE),i.cullFace(i.FRONT);break;case Yl.BACK:i.enable(i.CULL_FACE),i.cullFace(i.BACK)}n.rs.cullMode=O.cullMode}n.rs.isFrontFaceCCW!==O.isFrontFaceCCW&&(i.frontFace(O.isFrontFaceCCW?i.CCW:i.CW),n.rs.isFrontFaceCCW=O.isFrontFaceCCW),n.rs.depthBias===O.depthBias&&n.rs.depthBiasSlop===O.depthBiasSlop||(i.polygonOffset(O.depthBias,O.depthBiasSlop),n.rs.depthBias=O.depthBias,n.rs.depthBiasSlop=O.depthBiasSlop),n.rs.lineWidth!==O.lineWidth&&(i.lineWidth(O.lineWidth),n.rs.lineWidth=O.lineWidth)}var M=k.gpuPipelineState.dss;M&&(n.dss.depthTest!==M.depthTest&&(M.depthTest?i.enable(i.DEPTH_TEST):i.disable(i.DEPTH_TEST),n.dss.depthTest=M.depthTest),n.dss.depthWrite!==M.depthWrite&&(i.depthMask(M.depthWrite),n.dss.depthWrite=M.depthWrite),n.dss.depthFunc!==M.depthFunc&&(i.depthFunc(IM[M.depthFunc]),n.dss.depthFunc=M.depthFunc),n.dss.stencilTestFront===M.stencilTestFront&&n.dss.stencilTestBack===M.stencilTestBack||(M.stencilTestFront||M.stencilTestBack?i.enable(i.STENCIL_TEST):i.disable(i.STENCIL_TEST),n.dss.stencilTestFront=M.stencilTestFront,n.dss.stencilTestBack=M.stencilTestBack),n.dss.stencilFuncFront===M.stencilFuncFront&&n.dss.stencilRefFront===M.stencilRefFront&&n.dss.stencilReadMaskFront===M.stencilReadMaskFront||(i.stencilFuncSeparate(i.FRONT,IM[M.stencilFuncFront],M.stencilRefFront,M.stencilReadMaskFront),n.dss.stencilFuncFront=M.stencilFuncFront,n.dss.stencilRefFront=M.stencilRefFront,n.dss.stencilReadMaskFront=M.stencilReadMaskFront),n.dss.stencilFailOpFront===M.stencilFailOpFront&&n.dss.stencilZFailOpFront===M.stencilZFailOpFront&&n.dss.stencilPassOpFront===M.stencilPassOpFront||(i.stencilOpSeparate(i.FRONT,LM[M.stencilFailOpFront],LM[M.stencilZFailOpFront],LM[M.stencilPassOpFront]),n.dss.stencilFailOpFront=M.stencilFailOpFront,n.dss.stencilZFailOpFront=M.stencilZFailOpFront,n.dss.stencilPassOpFront=M.stencilPassOpFront),n.dss.stencilWriteMaskFront!==M.stencilWriteMaskFront&&(i.stencilMaskSeparate(i.FRONT,M.stencilWriteMaskFront),n.dss.stencilWriteMaskFront=M.stencilWriteMaskFront),n.dss.stencilFuncBack===M.stencilFuncBack&&n.dss.stencilRefBack===M.stencilRefBack&&n.dss.stencilReadMaskBack===M.stencilReadMaskBack||(i.stencilFuncSeparate(i.BACK,IM[M.stencilFuncBack],M.stencilRefBack,M.stencilReadMaskBack),n.dss.stencilFuncBack=M.stencilFuncBack,n.dss.stencilRefBack=M.stencilRefBack,n.dss.stencilReadMaskBack=M.stencilReadMaskBack),n.dss.stencilFailOpBack===M.stencilFailOpBack&&n.dss.stencilZFailOpBack===M.stencilZFailOpBack&&n.dss.stencilPassOpBack===M.stencilPassOpBack||(i.stencilOpSeparate(i.BACK,LM[M.stencilFailOpBack],LM[M.stencilZFailOpBack],LM[M.stencilPassOpBack]),n.dss.stencilFailOpBack=M.stencilFailOpBack,n.dss.stencilZFailOpBack=M.stencilZFailOpBack,n.dss.stencilPassOpBack=M.stencilPassOpBack),n.dss.stencilWriteMaskBack!==M.stencilWriteMaskBack&&(i.stencilMaskSeparate(i.BACK,M.stencilWriteMaskBack),n.dss.stencilWriteMaskBack=M.stencilWriteMaskBack));var I=k.gpuPipelineState.bs;if(I){n.bs.isA2C!==I.isA2C&&(I.isA2C?i.enable(i.SAMPLE_ALPHA_TO_COVERAGE):i.disable(i.SAMPLE_ALPHA_TO_COVERAGE),n.bs.isA2C=I.isA2C),n.bs.blendColor[0]===I.blendColor[0]&&n.bs.blendColor[1]===I.blendColor[1]&&n.bs.blendColor[2]===I.blendColor[2]&&n.bs.blendColor[3]===I.blendColor[3]||(i.blendColor(I.blendColor[0],I.blendColor[1],I.blendColor[2],I.blendColor[3]),n.bs.blendColor[0]=I.blendColor[0],n.bs.blendColor[1]=I.blendColor[1],n.bs.blendColor[2]=I.blendColor[2],n.bs.blendColor[3]=I.blendColor[3]);var L=I.targets[0],z=n.bs.targets[0];z.blend!==L.blend&&(L.blend?i.enable(i.BLEND):i.disable(i.BLEND),z.blend=L.blend),z.blendEq===L.blendEq&&z.blendAlphaEq===L.blendAlphaEq||(i.blendEquationSeparate(zM[L.blendEq],zM[L.blendAlphaEq]),z.blendEq=L.blendEq,z.blendAlphaEq=L.blendAlphaEq),z.blendSrc===L.blendSrc&&z.blendDst===L.blendDst&&z.blendSrcAlpha===L.blendSrcAlpha&&z.blendDstAlpha===L.blendDstAlpha||(i.blendFuncSeparate(BM[L.blendSrc],BM[L.blendDst],BM[L.blendSrcAlpha],BM[L.blendDstAlpha]),z.blendSrc=L.blendSrc,z.blendDst=L.blendDst,z.blendSrcAlpha=L.blendSrcAlpha,z.blendDstAlpha=L.blendDstAlpha),z.blendColorMask!==L.blendColorMask&&(i.colorMask((L.blendColorMask&rc.R)!==rc.NONE,(L.blendColorMask&rc.G)!==rc.NONE,(L.blendColorMask&rc.B)!==rc.NONE,(L.blendColorMask&rc.A)!==rc.NONE),z.blendColorMask=L.blendColorMask)}}if(k.gpuBindingLayout&&c)for(var B=k.gpuBindingLayout.gpuBindings.length,P=0;P<B;P++){var D=k.gpuBindingLayout.gpuBindings[P];switch(D.type){case wc.UNIFORM_BUFFER:if(D.gpuBuffer&&D.gpuBuffer.buffer){for(var F=null,N=c.glBlocks.length,U=0;U<N;U++){var V=c.glBlocks[U];if(V.binding===D.binding){F=V;break}}if(F&&D.gpuBuffer.vf32)for(var G=F.glActiveUniforms.length,H=0;H<G;H++){var q=F.glActiveUniforms[H];switch(q.glType){case i.BOOL:case i.INT:for(var j=0;j<q.array.length;++j){var W=q.begin+j;if(D.gpuBuffer.vf32[W]!==q.array[j]){for(var X=j,Y=q.begin+j;X<q.array.length;++X,++Y)q.array[X]=D.gpuBuffer.vf32[Y];i.uniform1iv(q.glLoc,q.array);break}}break;case i.BOOL_VEC2:case i.INT_VEC2:for(var Q=0;Q<q.array.length;++Q){var K=q.begin+Q;if(D.gpuBuffer.vf32[K]!==q.array[Q]){for(var Z=Q,J=q.begin+Q;Z<q.array.length;++Z,++J)q.array[Z]=D.gpuBuffer.vf32[J];i.uniform2iv(q.glLoc,q.array);break}}break;case i.BOOL_VEC3:case i.INT_VEC3:for(var $=0;$<q.array.length;++$){var ee=q.begin+$;if(D.gpuBuffer.vf32[ee]!==q.array[$]){for(var te=$,ie=q.begin+$;te<q.array.length;++te,++ie)q.array[te]=D.gpuBuffer.vf32[ie];i.uniform3iv(q.glLoc,q.array);break}}break;case i.BOOL_VEC4:case i.INT_VEC4:for(var ne=0;ne<q.array.length;++ne){var re=q.begin+ne;if(D.gpuBuffer.vf32[re]!==q.array[ne]){for(var ae=ne,se=q.begin+ne;ae<q.array.length;++ae,++se)q.array[ae]=D.gpuBuffer.vf32[se];i.uniform4iv(q.glLoc,q.array);break}}break;case i.FLOAT:for(var oe=0;oe<q.array.length;++oe){var le=q.begin+oe;if(D.gpuBuffer.vf32[le]!==q.array[oe]){for(var ce=oe,ue=q.begin+oe;ce<q.array.length;++ce,++ue)q.array[ce]=D.gpuBuffer.vf32[ue];i.uniform1fv(q.glLoc,q.array);break}}break;case i.FLOAT_VEC2:for(var he=0;he<q.array.length;++he){var fe=q.begin+he;if(D.gpuBuffer.vf32[fe]!==q.array[he]){for(var de=he,pe=q.begin+he;de<q.array.length;++de,++pe)q.array[de]=D.gpuBuffer.vf32[pe];i.uniform2fv(q.glLoc,q.array);break}}break;case i.FLOAT_VEC3:for(var _e=0;_e<q.array.length;++_e){var ve=q.begin+_e;if(D.gpuBuffer.vf32[ve]!==q.array[_e]){for(var me=_e,ye=q.begin+_e;me<q.array.length;++me,++ye)q.array[me]=D.gpuBuffer.vf32[ye];i.uniform3fv(q.glLoc,q.array);break}}break;case i.FLOAT_VEC4:for(var ge=0;ge<q.array.length;++ge){var be=q.begin+ge;if(D.gpuBuffer.vf32[be]!==q.array[ge]){for(var xe=ge,Se=q.begin+ge;xe<q.array.length;++xe,++Se)q.array[xe]=D.gpuBuffer.vf32[Se];i.uniform4fv(q.glLoc,q.array);break}}break;case i.FLOAT_MAT2:for(var we=0;we<q.array.length;++we){var Te=q.begin+we;if(D.gpuBuffer.vf32[Te]!==q.array[we]){for(var Ee=we,Ce=q.begin+we;Ee<q.array.length;++Ee,++Ce)q.array[Ee]=D.gpuBuffer.vf32[Ce];i.uniformMatrix2fv(q.glLoc,!1,q.array);break}}break;case i.FLOAT_MAT3:for(var Ae=0;Ae<q.array.length;++Ae){var ke=q.begin+Ae;if(D.gpuBuffer.vf32[ke]!==q.array[Ae]){for(var Re=Ae,Oe=q.begin+Ae;Re<q.array.length;++Re,++Oe)q.array[Re]=D.gpuBuffer.vf32[Oe];i.uniformMatrix3fv(q.glLoc,!1,q.array);break}}break;case i.FLOAT_MAT4:for(var Me=0;Me<q.array.length;++Me){var Ie=q.begin+Me;if(D.gpuBuffer.vf32[Ie]!==q.array[Me]){for(var Le=Me,ze=q.begin+Me;Le<q.array.length;++Le,++ze)q.array[Le]=D.gpuBuffer.vf32[ze];i.uniformMatrix4fv(q.glLoc,!1,q.array);break}}}}}break;case wc.SAMPLER:if(D.gpuSampler){for(var Be=null,Pe=c.glSamplers.length,De=0;De<Pe;De++){var Fe=c.glSamplers[De];if(Fe.binding===D.binding){Be=Fe;break}}if(Be)for(var Ne=Be.units.length,Ue=0;Ue<Ne;Ue++){var Ve=Be.units[Ue];if(D.gpuTexView&&0<D.gpuTexView.gpuTexture.size){var Ge=D.gpuTexView.gpuTexture,He=n.glTexUnits[Ve];He.glTexture!==Ge.glTexture&&(n.texUnit!==Ve&&(i.activeTexture(i.TEXTURE0+Ve),n.texUnit=Ve),Ge.glTexture?i.bindTexture(Ge.glTarget,Ge.glTexture):i.bindTexture(Ge.glTarget,e.nullTex2D.gpuTexture.glTexture),He.glTexture=Ge.glTexture);var qe=D.gpuSampler;s=Ge.isPowerOf2?(a=qe.glWrapS,qe.glWrapT):(a=i.CLAMP_TO_EDGE,i.CLAMP_TO_EDGE),o=Ge.isPowerOf2?Ge.mipLevel<=1&&(qe.glMinFilter===i.LINEAR_MIPMAP_NEAREST||qe.glMinFilter===i.LINEAR_MIPMAP_LINEAR)?i.LINEAR:qe.glMinFilter:qe.glMinFilter===i.LINEAR||qe.glMinFilter===i.LINEAR_MIPMAP_NEAREST||qe.glMinFilter===i.LINEAR_MIPMAP_LINEAR?i.LINEAR:i.NEAREST,Ge.glWrapS!==a&&(n.texUnit!==Ve&&(i.activeTexture(i.TEXTURE0+Ve),n.texUnit=Ve),i.texParameteri(Ge.glTarget,i.TEXTURE_WRAP_S,a),Ge.glWrapS=a),Ge.glWrapT!==s&&(n.texUnit!==Ve&&(i.activeTexture(i.TEXTURE0+Ve),n.texUnit=Ve),i.texParameteri(Ge.glTarget,i.TEXTURE_WRAP_T,s),Ge.glWrapT=s),Ge.glMinFilter!==o&&(n.texUnit!==Ve&&(i.activeTexture(i.TEXTURE0+Ve),n.texUnit=Ve),i.texParameteri(Ge.glTarget,i.TEXTURE_MIN_FILTER,o),Ge.glMinFilter=o),Ge.glMagFilter!==qe.glMagFilter&&(n.texUnit!==Ve&&(i.activeTexture(i.TEXTURE0+Ve),n.texUnit=Ve),i.texParameteri(Ge.glTarget,i.TEXTURE_MAG_FILTER,qe.glMagFilter),Ge.glMagFilter=qe.glMagFilter)}}}else console.error("Not found sampler on binding unit "+D.binding)}}if(k.gpuInputAssembler&&c&&(u||h!==k.gpuInputAssembler))if(h=k.gpuInputAssembler,e.useVAO){var je=e.OES_vertex_array_object,We=h.glVAOs.get(c.glProgram);if(!We){We=je.createVertexArrayOES(),h.glVAOs.set(c.glProgram,We),je.bindVertexArrayOES(We),i.bindBuffer(i.ARRAY_BUFFER,null),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null);for(var Xe=void 0,Ye=c.glInputs.length,Qe=0;Qe<Ye;Qe++){var Ke=c.glInputs[Qe];Xe=null;for(var Ze=h.glAttribs.length,Je=0;Je<Ze;Je++){var $e=h.glAttribs[Je];if($e.name===Ke.name){Xe=$e;break}}if(Xe){i.bindBuffer(i.ARRAY_BUFFER,Xe.glBuffer);for(var et=0;et<Xe.componentCount;++et){var tt=Ke.glLoc+et,it=Xe.offset+Xe.size*et;i.enableVertexAttribArray(tt),n.glCurrentAttribLocs[tt]=!0,i.vertexAttribPointer(tt,Xe.count,Xe.glType,Xe.isNormalized,Xe.stride,it)}}}var nt=h.gpuIndexBuffer;nt&&i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,nt.glBuffer),je.bindVertexArrayOES(null),i.bindBuffer(i.ARRAY_BUFFER,null),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),n.glArrayBuffer=null,n.glElementArrayBuffer=null}n.glVAO!==We&&(je.bindVertexArrayOES(We),n.glVAO=We)}else{for(var rt=0;rt<e.maxVertexAttributes;++rt)n.glCurrentAttribLocs[rt]=!1;for(var at=c.glInputs.length,st=0;st<at;st++){for(var ot=c.glInputs[st],lt=null,ct=h.glAttribs.length,ut=0;ut<ct;ut++){var ht=h.glAttribs[ut];if(ht.name===ot.name){lt=ht;break}}if(lt){n.glArrayBuffer!==lt.glBuffer&&(i.bindBuffer(i.ARRAY_BUFFER,lt.glBuffer),n.glArrayBuffer=lt.glBuffer);for(var ft=0;ft<lt.componentCount;++ft){var dt=ot.glLoc+ft,pt=lt.offset+lt.size*ft;!n.glEnabledAttribLocs[dt]&&0<=dt&&(i.enableVertexAttribArray(dt),n.glEnabledAttribLocs[dt]=!0),n.glCurrentAttribLocs[dt]=!0,i.vertexAttribPointer(dt,lt.count,lt.glType,lt.isNormalized,lt.stride,pt)}}}var _t=h.gpuIndexBuffer;_t&&n.glElementArrayBuffer!==_t.glBuffer&&(i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,_t.glBuffer),n.glElementArrayBuffer=_t.glBuffer);for(var vt=0;vt<e.maxVertexAttributes;++vt)n.glEnabledAttribLocs[vt]!==n.glCurrentAttribLocs[vt]&&(i.disableVertexAttribArray(vt),n.glEnabledAttribLocs[vt]=!1)}if(l)for(var mt=l.dynamicStates.length,yt=0;yt<mt;yt++){switch(l.dynamicStates[yt]){case Bc.VIEWPORT:k.viewport&&(n.viewport.left===k.viewport.left&&n.viewport.top===k.viewport.top&&n.viewport.width===k.viewport.width&&n.viewport.height===k.viewport.height||(i.viewport(k.viewport.left,k.viewport.top,k.viewport.width,k.viewport.height),n.viewport.left=k.viewport.left,n.viewport.top=k.viewport.top,n.viewport.width=k.viewport.width,n.viewport.height=k.viewport.height));break;case Bc.SCISSOR:k.scissor&&(n.scissorRect.x===k.scissor.x&&n.scissorRect.y===k.scissor.y&&n.scissorRect.width===k.scissor.width&&n.scissorRect.height===k.scissor.height||(i.scissor(k.scissor.x,k.scissor.y,k.scissor.width,k.scissor.height),n.scissorRect.x=k.scissor.x,n.scissorRect.y=k.scissor.y,n.scissorRect.width=k.scissor.width,n.scissorRect.height=k.scissor.height));break;case Bc.LINE_WIDTH:k.lineWidth&&n.rs.lineWidth!==k.lineWidth&&(i.lineWidth(k.lineWidth),n.rs.lineWidth=k.lineWidth);break;case Bc.DEPTH_BIAS:k.depthBias&&(n.rs.depthBias===k.depthBias.constantFactor&&n.rs.depthBiasSlop===k.depthBias.slopeFactor||(i.polygonOffset(k.depthBias.constantFactor,k.depthBias.slopeFactor),n.rs.depthBias=k.depthBias.constantFactor,n.rs.depthBiasSlop=k.depthBias.slopeFactor));break;case Bc.BLEND_CONSTANTS:k.blendConstants&&(n.bs.blendColor[0]===k.blendConstants[0]&&n.bs.blendColor[1]===k.blendConstants[1]&&n.bs.blendColor[2]===k.blendConstants[2]&&n.bs.blendColor[3]===k.blendConstants[3]||(i.blendColor(k.blendConstants[0],k.blendConstants[1],k.blendConstants[2],k.blendConstants[3]),n.bs.blendColor[0]=k.blendConstants[0],n.bs.blendColor[1]=k.blendConstants[1],n.bs.blendColor[2]=k.blendConstants[2],n.bs.blendColor[3]=k.blendConstants[3]));break;case Bc.STENCIL_WRITE_MASK:if(k.stencilWriteMask)switch(k.stencilWriteMask.face){case Dc.FRONT:n.dss.stencilWriteMaskFront!==k.stencilWriteMask.writeMask&&(i.stencilMaskSeparate(i.FRONT,k.stencilWriteMask.writeMask),n.dss.stencilWriteMaskFront=k.stencilWriteMask.writeMask);break;case Dc.BACK:n.dss.stencilWriteMaskBack!==k.stencilWriteMask.writeMask&&(i.stencilMaskSeparate(i.BACK,k.stencilWriteMask.writeMask),n.dss.stencilWriteMaskBack=k.stencilWriteMask.writeMask);break;case Dc.ALL:n.dss.stencilWriteMaskFront===k.stencilWriteMask.writeMask&&n.dss.stencilWriteMaskBack===k.stencilWriteMask.writeMask||(i.stencilMask(k.stencilWriteMask.writeMask),n.dss.stencilWriteMaskFront=k.stencilWriteMask.writeMask,n.dss.stencilWriteMaskBack=k.stencilWriteMask.writeMask)}break;case Bc.STENCIL_COMPARE_MASK:if(k.stencilCompareMask)switch(k.stencilCompareMask.face){case Dc.FRONT:n.dss.stencilRefFront===k.stencilCompareMask.reference&&n.dss.stencilReadMaskFront===k.stencilCompareMask.compareMask||(i.stencilFuncSeparate(i.FRONT,IM[n.dss.stencilFuncFront],k.stencilCompareMask.reference,k.stencilCompareMask.compareMask),n.dss.stencilRefFront=k.stencilCompareMask.reference,n.dss.stencilReadMaskFront=k.stencilCompareMask.compareMask);break;case Dc.BACK:n.dss.stencilRefBack===k.stencilCompareMask.reference&&n.dss.stencilReadMaskBack===k.stencilCompareMask.compareMask||(i.stencilFuncSeparate(i.BACK,IM[n.dss.stencilFuncBack],k.stencilCompareMask.reference,k.stencilCompareMask.compareMask),n.dss.stencilRefBack=k.stencilCompareMask.reference,n.dss.stencilReadMaskBack=k.stencilCompareMask.compareMask);break;case Dc.ALL:n.dss.stencilRefFront===k.stencilCompareMask.reference&&n.dss.stencilReadMaskFront===k.stencilCompareMask.compareMask&&n.dss.stencilRefBack===k.stencilCompareMask.reference&&n.dss.stencilReadMaskBack===k.stencilCompareMask.compareMask||(i.stencilFunc(IM[n.dss.stencilFuncBack],k.stencilCompareMask.reference,k.stencilCompareMask.compareMask),n.dss.stencilRefFront=k.stencilCompareMask.reference,n.dss.stencilReadMaskFront=k.stencilCompareMask.compareMask,n.dss.stencilRefBack=k.stencilCompareMask.reference,n.dss.stencilReadMaskBack=k.stencilCompareMask.compareMask)}}}break;case OM.DRAW:var gt=t.drawCmds.array[_];if(h&&c)if(h.gpuIndirectBuffer){if(h.gpuIndirectBuffer)for(var bt=h.gpuIndirectBuffer.indirects.length,xt=0;xt<bt;xt++){var St=h.gpuIndirectBuffer.indirects[xt],wt=h.gpuIndexBuffer;if(wt&&-1<St.indexCount){var Tt=St.firstIndex*wt.stride;i.drawElements(f,St.indexCount,h.glIndexType,Tt)}else i.drawArrays(f,St.firstVertex,St.vertexCount)}}else{var Et=h.gpuIndexBuffer;if(Et&&-1<gt.drawInfo.indexCount){var Ct=gt.drawInfo.firstIndex*Et.stride;i.drawElements(f,gt.drawInfo.indexCount,h.glIndexType,Ct)}else i.drawArrays(f,gt.drawInfo.firstVertex,gt.drawInfo.vertexCount)}break;case OM.UPDATE_BUFFER:var At=t.updateBufferCmds.array[_];HM(e,At.gpuBuffer,At.buffer,At.offset,At.size);break;case OM.COPY_BUFFER_TO_TEXTURE:var kt=t.copyBufferToTextureCmds.array[_];WM(e,[kt.gpuBuffer.buffer],kt.gpuTexture,kt.regions)}}}function WM(e,t,i,n){var r=e.gl,a=e.stateCache.glTexUnits[e.stateCache.texUnit];a.glTexture!==i.glTexture&&(r.bindTexture(i.glTarget,i.glTexture),a.glTexture=i.glTexture);var s=0,o=0,l=1,c=1,u=0,h=Qc[i.format],f=h.isCompressed;switch(i.glTarget){case r.TEXTURE_2D:var d=n,p=Array.isArray(d),_=0;for(d=p?d:d[Symbol.iterator]();;){var v;if(p){if(_>=d.length)break;v=d[_++]}else{if((_=d.next()).done)break;v=_.value}var m=v;for(l=m.texExtent.width,c=m.texExtent.height,s=m.texSubres.baseMipLevel;s<m.texSubres.levelCount;++s){var y=h.type!==qc.FLOAT||f?new Uint8Array(t[o++]):new Float32Array(t[o++]);f?i.glInternelFmt!==gM.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_2D,s,m.texOffset.x,m.texOffset.y,l,c,i.glFormat,y):r.compressedTexImage2D(r.TEXTURE_2D,s,i.glInternelFmt,l,c,0,y):r.texSubImage2D(r.TEXTURE_2D,s,m.texOffset.x,m.texOffset.y,l,c,i.glFormat,i.glType,y),l=Math.max(1,l>>1),c=Math.max(1,l>>1)}}break;case r.TEXTURE_CUBE_MAP:var g=n,b=Array.isArray(g),x=0;for(g=b?g:g[Symbol.iterator]();;){var S;if(b){if(x>=g.length)break;S=g[x++]}else{if((x=g.next()).done)break;S=x.value}var w=S;o=0;var T=w.texSubres.baseArrayLayer+w.texSubres.layerCount;for(u=w.texSubres.baseArrayLayer;u<T;++u){l=w.texExtent.width,c=w.texExtent.height;var E=w.texSubres.baseMipLevel+w.texSubres.levelCount;for(s=w.texSubres.baseMipLevel;s<E;++s){var C=h.type!==qc.FLOAT||f?new Uint8Array(t[o++]):new Float32Array(t[o++]);f?i.glInternelFmt!==gM.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+u,s,w.texOffset.x,w.texOffset.y,l,c,i.glFormat,C):r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+u,s,i.glInternelFmt,l,c,0,C):r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+u,s,w.texOffset.x,w.texOffset.y,l,c,i.glFormat,i.glType,C),l=Math.max(1,l>>1),c=Math.max(1,l>>1)}}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&mc.GEN_MIPMAP&&r.generateMipmap(i.glTarget)}function XM(){y(this,XM),this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glVAO=null,this.texUnit=0,this.glTexUnits=void 0,this.glRenderbuffer=null,this.glFramebuffer=null,this.viewport=void 0,this.scissorRect=void 0,this.rs=void 0,this.dss=void 0,this.bs=void 0,this.glProgram=null,this.glEnabledAttribLocs=void 0,this.glCurrentAttribLocs=void 0,this.glTexUnits=new Array(El),this.viewport={left:0,top:0,width:0,height:0,minDepth:0,maxDepth:0},this.scissorRect={x:0,y:0,width:0,height:0},this.rs=new jf,this.dss=new Wf,this.bs=new Vf,this.glEnabledAttribLocs=new Array(Tl),this.glCurrentAttribLocs=new Array(Tl),this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.fill(!1);for(var e=0;e<El;++e)this.glTexUnits[e]={glTexture:null}}var YM=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._gpuBuffer=null,t._uniformBuffer=null,t._indirectBuffer=null,t}return p(i,kh),l(i,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}}]),l(i,[{key:"initialize",value:function(e){return this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._flags=void 0!==e.flags?e.flags:Fl.NONE,this._usage&zl.INDIRECT?this._indirectBuffer={drawInfos:[]}:this._usage&zl.UNIFORM&&0<this._size&&(this._uniformBuffer=new ArrayBuffer(this._size)),this._flags&Fl.BAKUP_BUFFER&&(this._bufferView=new Uint8Array(this._size)),this._gpuBuffer={usage:e.usage,memUsage:e.memUsage,size:e.size,stride:this._stride,buffer:null,vf32:null,indirects:[],glTarget:0,glBuffer:null},e.usage&zl.INDIRECT?this._gpuBuffer.indirects=this._indirectBuffer.drawInfos:this._usage&zl.UNIFORM&&(this._gpuBuffer.buffer=this._uniformBuffer),function(e,t){var i=e.gl,n=e.stateCache,r=t.memUsage&Pl.HOST?i.DYNAMIC_DRAW:i.STATIC_DRAW;if(t.usage&zl.VERTEX){t.glTarget=i.ARRAY_BUFFER;var a=i.createBuffer();a&&(t.glBuffer=a,0<t.size&&(e.useVAO&&n.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=null),e.stateCache.glArrayBuffer!==t.glBuffer&&(i.bindBuffer(i.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),i.bufferData(i.ARRAY_BUFFER,t.size,r),i.bindBuffer(i.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&zl.INDEX){t.glTarget=i.ELEMENT_ARRAY_BUFFER;var s=i.createBuffer();s&&(t.glBuffer=s,0<t.size&&(e.useVAO&&n.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&(i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.size,r),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else t.usage&zl.UNIFORM?(t.glTarget=i.NONE,t.buffer&&(t.vf32=new Float32Array(t.buffer))):(t.usage&zl.INDIRECT||t.usage&zl.TRANSFER_DST||t.usage&zl.TRANSFER_SRC||console.error("Unsupported GFXBufferType, create buffer failed."),t.glTarget=i.NONE)}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize+=this._size,this._status=Sl.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuBuffer&&(function(e,t){t.glBuffer&&(e.gl.deleteBuffer(t.glBuffer),t.glBuffer=null)}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize-=this._size,this._gpuBuffer=null),this._bufferView=null,this._status=Sl.UNREADY}},{key:"resize",value:function(e){var t=this._size;if(this._size=e,this._count=this._size/this._stride,this._uniformBuffer&&(this._uniformBuffer=new ArrayBuffer(this._size)),this._bufferView&&t!==e){var i=this._bufferView;this._bufferView=new Uint8Array(this._size),this._bufferView.set(i),this._gpuBuffer&&(this._gpuBuffer.buffer=this._bufferView.buffer)}this._gpuBuffer&&(this._uniformBuffer&&(this._gpuBuffer.buffer=this._uniformBuffer),this._gpuBuffer.size=this._size,0<this._size&&(function(e,t){var i=e.gl,n=e.stateCache,r=t.memUsage&Pl.HOST?i.DYNAMIC_DRAW:i.STATIC_DRAW;t.usage&zl.VERTEX?(e.useVAO&&n.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=null),e.stateCache.glArrayBuffer!==t.glBuffer&&i.bindBuffer(i.ARRAY_BUFFER,t.glBuffer),t.buffer?i.bufferData(i.ARRAY_BUFFER,t.buffer,r):i.bufferData(i.ARRAY_BUFFER,t.size,r),i.bindBuffer(i.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null):t.usage&zl.INDEX?(e.useVAO&&n.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,t.glBuffer),t.buffer?i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.buffer,r):i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.size,r),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null):t.usage&zl.UNIFORM?t.buffer&&(t.vf32=new Float32Array(t.buffer)):(t.usage&zl.INDIRECT||t.usage&zl.TRANSFER_DST||t.usage&zl.TRANSFER_SRC||console.error("Unsupported GFXBufferType, create buffer failed."),t.glTarget=i.NONE)}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize-=t,this._device.memoryStatus.bufferSize+=this._size,this._bufferView&&(this._device.memoryStatus.bufferSize-=t,this._device.memoryStatus.bufferSize+=this._size)))}},{key:"update",value:function(e,t,i){var n;if(n=void 0!==i?i:this._usage&zl.INDIRECT?0:e.byteLength,this._bufferView){var r=new Uint8Array(e,0,i);this._bufferView.set(r,t)}HM(this._device,this._gpuBuffer,e,t||0,n)}}]),i}(),QM=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,bl.COMMAND_ALLOCATOR)))._device=void 0,t._device=e,t}return p(i,Hc),i}(),KM=function(){function n(e,t){y(this,n),this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(t),this._freeCmds=new tg(t);for(var i=0;i<t;++i)this._frees[i]=new e;this._freeIdx=t-1}return l(n,[{key:"alloc",value:function(e){if(this._freeIdx<0){var t=2*this._frees.length,i=this._frees;this._frees=new Array(t);for(var n=t-i.length,r=0;r<n;++r)this._frees[r]=new e;for(var a=n,s=0;a<t;++a,++s)this._frees[a]=i[s];this._freeIdx+=n}var o=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++o.refCount,o}},{key:"free",value:function(e){0==--e.refCount&&this._freeCmds.push(e)}},{key:"freeCmds",value:function(e){for(var t=0;t<e.length;++t)0==--e.array[t].refCount&&this._freeCmds.push(e.array[t])}},{key:"release",value:function(){for(var e=0;e<this._freeCmds.length;++e){var t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()}}]),n}(),ZM=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e))).beginRenderPassCmdPool=void 0,t.bindStatesCmdPool=void 0,t.drawCmdPool=void 0,t.updateBufferCmdPool=void 0,t.copyBufferToTextureCmdPool=void 0,t.beginRenderPassCmdPool=new KM(DM,1),t.bindStatesCmdPool=new KM(FM,1),t.drawCmdPool=new KM(NM,1),t.updateBufferCmdPool=new KM(UM,1),t.copyBufferToTextureCmdPool=new KM(VM,1),t}return p(i,QM),l(i,[{key:"initialize",value:function(e){return this._status=Sl.SUCCESS,!0}},{key:"destroy",value:function(){this._status=Sl.UNREADY}},{key:"clearCmds",value:function(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.cmds.clear()}},{key:"releaseCmds",value:function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()}}]),i}(),JM=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e))).cmdPackage=new GM,t._webGLAllocator=null,t._isInRenderPass=!1,t._curGPUPipelineState=null,t._curGPUBindingLayout=null,t._curGPUInputAssembler=null,t._curViewport=null,t._curScissor=null,t._curLineWidth=null,t._curDepthBias=null,t._curBlendConstants=[],t._curDepthBounds=null,t._curStencilWriteMask=null,t._curStencilCompareMask=null,t._isStateInvalied=!1,t}return p(i,Rh),l(i,[{key:"initialize",value:function(e){return!!e.allocator&&(this._allocator=e.allocator,this._webGLAllocator=this._allocator,this._type=e.type,this._status=Sl.SUCCESS,!0)}},{key:"destroy",value:function(){this._webGLAllocator&&(this._webGLAllocator.clearCmds(this.cmdPackage),this._allocator=null,this._webGLAllocator=null),this._status=Sl.UNREADY}},{key:"begin",value:function(){this._webGLAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUBindingLayout=null,this._curGPUInputAssembler=null,this._curViewport=null,this._curScissor=null,this._curLineWidth=null,this._curDepthBias=null,this._curBlendConstants=[],this._curDepthBounds=null,this._curStencilWriteMask=null,this._curStencilCompareMask=null,this._numDrawCalls=0,this._numTris=0}},{key:"end",value:function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1}},{key:"beginRenderPass",value:function(e,t,i,n,r,a){var s=this._webGLAllocator.beginRenderPassCmdPool.alloc(DM);s.gpuFramebuffer=e.gpuFramebuffer,s.renderArea=t,s.clearFlag=i,s.clearColors.length=n.length;for(var o=0;o<n.length;++o)s.clearColors[o]=n[o];s.clearDepth=r,s.clearStencil=a,this.cmdPackage.beginRenderPassCmds.push(s),this.cmdPackage.cmds.push(OM.BEGIN_RENDER_PASS),this._isInRenderPass=!0}},{key:"endRenderPass",value:function(){this._isInRenderPass=!1}},{key:"bindPipelineState",value:function(e){var t=e.gpuPipelineState;this._curGPUPipelineState=t,this._isStateInvalied=!0}},{key:"bindBindingLayout",value:function(e){var t=e.gpuBindingLayout;this._curGPUBindingLayout=t,this._isStateInvalied=!0}},{key:"bindInputAssembler",value:function(e){var t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0}},{key:"setViewport",value:function(e){this._curViewport?this._curViewport.left===e.left&&this._curViewport.top===e.top&&this._curViewport.width===e.width&&this._curViewport.height===e.height&&this._curViewport.minDepth===e.minDepth&&this._curViewport.maxDepth===e.maxDepth||(this._curViewport.left=e.left,this._curViewport.top=e.top,this._curViewport.width=e.width,this._curViewport.height=e.height,this._curViewport.minDepth=e.minDepth,this._curViewport.maxDepth=e.maxDepth,this._isStateInvalied=!0):this._curViewport={left:e.left,top:e.top,width:e.width,height:e.height,minDepth:e.minDepth,maxDepth:e.maxDepth},this._curViewport!==e&&(this._curViewport=e,this._isStateInvalied=!0)}},{key:"setScissor",value:function(e){this._curScissor?this._curScissor.x===e.x&&this._curScissor.y===e.y&&this._curScissor.width===e.width&&this._curScissor.height===e.height||(this._curScissor.x=e.x,this._curScissor.y=e.y,this._curScissor.width=e.width,this._curScissor.height=e.height,this._isStateInvalied=!0):this._curScissor={x:e.x,y:e.y,width:e.width,height:e.height}}},{key:"setLineWidth",value:function(e){this._curLineWidth!==e&&(this._curLineWidth=e,this._isStateInvalied=!0)}},{key:"setDepthBias",value:function(e,t,i){this._curDepthBias?this._curDepthBias.constantFactor===e&&this._curDepthBias.clamp===t&&this._curDepthBias.slopeFactor===i||(this._curDepthBias.constantFactor=e,this._curDepthBias.clamp=t,this._curDepthBias.slopeFactor=i,this._isStateInvalied=!0):(this._curDepthBias={constantFactor:e,clamp:t,slopeFactor:i},this._isStateInvalied=!0)}},{key:"setBlendConstants",value:function(e){(this._curBlendConstants||4!==e.length)&&(4!==e.length||this._curBlendConstants[0]===e[0]&&this._curBlendConstants[1]===e[1]&&this._curBlendConstants[2]===e[2]&&this._curBlendConstants[3]===e[3])||(this._curBlendConstants=[e[0],e[1],e[2],e[3]],this._isStateInvalied=!0)}},{key:"setDepthBound",value:function(e,t){this._curDepthBounds&&this._curDepthBounds.minBounds===e&&this._curDepthBounds.maxBounds===t||(this._curDepthBounds={minBounds:e,maxBounds:t},this._isStateInvalied=!0)}},{key:"setStencilWriteMask",value:function(e,t){this._curStencilWriteMask?this._curStencilWriteMask.face===e&&this._curStencilWriteMask.writeMask===t||(this._curStencilWriteMask.face=e,this._curStencilWriteMask.writeMask=t,this._isStateInvalied=!0):(this._curStencilWriteMask={face:e,writeMask:t},this._isStateInvalied=!0)}},{key:"setStencilCompareMask",value:function(e,t,i){this._curStencilCompareMask?this._curStencilCompareMask.face===e&&this._curStencilCompareMask.reference===t&&this._curStencilCompareMask.compareMask===i||(this._curStencilCompareMask.face=e,this._curStencilCompareMask.reference=t,this._curStencilCompareMask.compareMask=i,this._isStateInvalied=!0):(this._curStencilCompareMask={face:e,reference:t,compareMask:i},this._isStateInvalied=!0)}},{key:"draw",value:function(e){if(this._type===Ec.PRIMARY&&this._isInRenderPass||this._type===Ec.SECONDARY){this._isStateInvalied&&this.bindStates();var t=this._allocator.drawCmdPool.alloc(NM);if(e.extractCmdDraw(t),this.cmdPackage.drawCmds.push(t),this.cmdPackage.cmds.push(OM.DRAW),++this._numDrawCalls,this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=e.indexCount/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(e.indexCount-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")}},{key:"updateBuffer",value:function(e,t,i,n){if(this._type===Ec.PRIMARY&&!this._isInRenderPass||this._type===Ec.SECONDARY){var r=e.gpuBuffer;if(r){var a=this._webGLAllocator.updateBufferCmdPool.alloc(UM);if(a){var s;s=void 0!==n?n:e.usage&zl.INDIRECT?0:t.byteLength;var o=t;a.gpuBuffer=r,a.buffer=o,a.offset=void 0!==i?i:0,a.size=s,this.cmdPackage.updateBufferCmds.push(a),this.cmdPackage.cmds.push(OM.UPDATE_BUFFER)}}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")}},{key:"copyBufferToTexture",value:function(e,t,i,n){if(this._type===Ec.PRIMARY&&!this._isInRenderPass||this._type===Ec.SECONDARY){var r=e.gpuBuffer,a=t.gpuTexture;if(r&&a){var s=this._webGLAllocator.copyBufferToTextureCmdPool.alloc(VM);s&&(s.gpuBuffer=r,s.gpuTexture=a,s.dstLayout=i,s.regions=n,this.cmdPackage.copyBufferToTextureCmds.push(s),this.cmdPackage.cmds.push(OM.COPY_BUFFER_TO_TEXTURE))}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")}},{key:"execute",value:function(e,t){for(var i=0;i<t;++i){for(var n=e[i],r=0;r<n.cmdPackage.beginRenderPassCmds.length;++r){var a=n.cmdPackage.beginRenderPassCmds.array[r];++a.refCount,this.cmdPackage.beginRenderPassCmds.push(a)}for(var s=0;s<n.cmdPackage.bindStatesCmds.length;++s){var o=n.cmdPackage.bindStatesCmds.array[s];++o.refCount,this.cmdPackage.bindStatesCmds.push(o)}for(var l=0;l<n.cmdPackage.drawCmds.length;++l){var c=n.cmdPackage.drawCmds.array[l];++c.refCount,this.cmdPackage.drawCmds.push(c)}for(var u=0;u<n.cmdPackage.updateBufferCmds.length;++u){var h=n.cmdPackage.updateBufferCmds.array[u];++h.refCount,this.cmdPackage.updateBufferCmds.push(h)}for(var f=0;f<n.cmdPackage.copyBufferToTextureCmds.length;++f){var d=n.cmdPackage.copyBufferToTextureCmds.array[f];++d.refCount,this.cmdPackage.copyBufferToTextureCmds.push(d)}this.cmdPackage.cmds.concat(n.cmdPackage.cmds),this._numDrawCalls+=n._numDrawCalls,this._numTris+=n._numTris}}},{key:"bindStates",value:function(){var e=this._webGLAllocator.bindStatesCmdPool.alloc(FM);e&&(e.gpuPipelineState=this._curGPUPipelineState,e.gpuBindingLayout=this._curGPUBindingLayout,e.gpuInputAssembler=this._curGPUInputAssembler,e.viewport=this._curViewport,e.scissor=this._curScissor,e.lineWidth=this._curLineWidth,e.depthBias=this._curDepthBias,e.blendConstants=this._curBlendConstants,e.depthBounds=this._curDepthBounds,e.stencilWriteMask=this._curStencilWriteMask,e.stencilCompareMask=this._curStencilCompareMask,this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(OM.BIND_STATES),this._isStateInvalied=!1)}},{key:"webGLDevice",get:function(){return this._device}}]),i}(),$M=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._gpuFramebuffer=null,t}return p(i,Oh),l(i,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),l(i,[{key:"initialize",value:function(e){if(this._renderPass=e.renderPass,this._colorViews=e.colorViews||[],this._depthStencilView=e.depthStencilView||null,this._isOffscreen=void 0===e.isOffscreen||e.isOffscreen,this._isOffscreen){var t=[];if(void 0!==e.colorViews){var i=e.colorViews,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;t.push(s.gpuTextureView)}}var o=null;e.depthStencilView&&(o=e.depthStencilView.gpuTextureView),this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorViews:t,gpuDepthStencilView:o,isOffscreen:this._isOffscreen,glFramebuffer:null},function(e,t){if(t.isOffscreen){var i=e.gl,n=[],r=i.createFramebuffer();if(r){t.glFramebuffer=r,e.stateCache.glFramebuffer!==t.glFramebuffer&&(i.bindFramebuffer(i.FRAMEBUFFER,t.glFramebuffer),e.stateCache.glFramebuffer=t.glFramebuffer);for(var a=0;a<t.gpuColorViews.length;++a){var s=t.gpuColorViews[a];s&&(s.gpuTexture.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,s.gpuTexture.glTarget,s.gpuTexture.glTexture,s.baseLevel):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,i.RENDERBUFFER,s.gpuTexture.glRenderbuffer),n.push(i.COLOR_ATTACHMENT0+a))}var o=t.gpuDepthStencilView;if(o){var l=Qc[o.format].hasStencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;o.gpuTexture.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,l,o.gpuTexture.glTarget,o.gpuTexture.glTexture,o.baseLevel):i.framebufferRenderbuffer(i.FRAMEBUFFER,l,i.RENDERBUFFER,o.gpuTexture.glRenderbuffer)}e.WEBGL_draw_buffers&&e.WEBGL_draw_buffers.drawBuffersWEBGL(n);var c=i.checkFramebufferStatus(i.FRAMEBUFFER);if(c!==i.FRAMEBUFFER_COMPLETE)switch(c){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}}}}(this._device,this._gpuFramebuffer)}else this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorViews:[],gpuDepthStencilView:null,isOffscreen:e.isOffscreen,glFramebuffer:null};return this._status=Sl.SUCCESS,!0}},{key:"destroy",value:function(){this._isOffscreen&&this._gpuFramebuffer&&function(e,t){t.glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),t.glFramebuffer=null)}(this._device,this._gpuFramebuffer),this._gpuFramebuffer=null,this._status=Sl.UNREADY}}]),i}(),eI=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._gpuInputAssembler=null,t}return p(i,Hf),l(i,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),l(i,[{key:"initialize",value:function(e){if(0===e.vertexBuffers.length)return console.error("GFXInputAssemblerInfo.vertexBuffers is null."),!1;if(this._attributes=e.attributes,this._vertexBuffers=e.vertexBuffers,void 0!==e.indexBuffer)this._indexBuffer=e.indexBuffer,this._indexCount=this._indexBuffer.size/this._indexBuffer.stride;else{var t=this._vertexBuffers[0];this._vertexCount=t.size/t.stride}this._indirectBuffer=e.indirectBuffer||null;for(var i=new Array(e.vertexBuffers.length),n=0;n<e.vertexBuffers.length;++n){var r=e.vertexBuffers[n];r.gpuBuffer&&(i[n]=r.gpuBuffer)}var a=null,s=0;if(e.indexBuffer&&(a=e.indexBuffer.gpuBuffer))switch(a.stride){case 1:s=5121;break;case 2:s=5123;break;case 4:s=5125;break;default:console.error("Error index buffer stride.")}var o=null;return void 0!==e.indirectBuffer&&(o=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:i,gpuIndexBuffer:a,gpuIndirectBuffer:o,glAttribs:[],glIndexType:s,glVAOs:new Map},function(e,t){var i=e.gl;t.glAttribs=new Array(t.attributes.length);for(var n=[0,0,0,0,0,0,0,0],r=0;r<t.attributes.length;++r){var a=t.attributes[r],s=void 0!==a.stream?a.stream:0,o=t.gpuVertexBuffers[s],l=wM(a.format,i),c=Qc[a.format].size;t.glAttribs[r]={name:a.name,glBuffer:o.glBuffer,glType:l,size:c,count:Qc[a.format].count,stride:o.stride,componentCount:RM(l,i),isNormalized:void 0!==a.isNormalized&&a.isNormalized,isInstanced:void 0!==a.isInstanced&&a.isInstanced,offset:n[s]},n[s]+=c}}(this._device,this._gpuInputAssembler),this._status=Sl.SUCCESS,!0}},{key:"destroy",value:function(){var e=this._device;this._gpuInputAssembler&&e.useVAO&&function(e,t){var i=t.glVAOs,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;e.OES_vertex_array_object.deleteVertexArrayOES(s[1])}t.glVAOs.clear()}(e,this._gpuInputAssembler),this._gpuInputAssembler=null,this._status=Sl.UNREADY}},{key:"extractCmdDraw",value:function(e){e.drawInfo.vertexCount=this._vertexCount,e.drawInfo.firstVertex=this._firstVertex,e.drawInfo.indexCount=this._indexCount,e.drawInfo.firstIndex=this._firstIndex,e.drawInfo.vertexOffset=this._vertexOffset,e.drawInfo.instanceCount=this._instanceCount,e.drawInfo.firstInstance=this._firstInstance}}]),i}(),tI=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._gpuPipelineLayout=null,t}return p(i,qf),l(i,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),l(i,[{key:"initialize",value:function(e){return this._layouts=e.layouts,this._pushConstantsRanges=e.pushConstantsRanges||[],this._status=Sl.SUCCESS,!0}},{key:"destroy",value:function(){this._status=Sl.UNREADY}}]),i}(),iI=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],nI=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._gpuPipelineState=null,t}return p(i,Yf),l(i,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),l(i,[{key:"initialize",value:function(e){return this._primitive=e.primitive,this._shader=e.shader,this._is=e.is,this._rs=e.rs,this._dss=e.dss,this._bs=e.bs,this._dynamicStates=e.dynamicStates||[],this._layout=e.layout,this._renderPass=e.renderPass,this._gpuPipelineState={glPrimitive:iI[e.primitive],gpuShader:e.shader.gpuShader,rs:e.rs,dss:e.dss,bs:e.bs,dynamicStates:void 0!==e.dynamicStates?e.dynamicStates:[],gpuLayout:e.layout.gpuPipelineLayout,gpuRenderPass:e.renderPass.gpuRenderPass},this._status=Sl.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuPipelineState=null,this._status=Sl.UNREADY}}]),i}(),rI=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e))).numDrawCalls=0,t.numTris=0,t._isAsync=!1,t}return p(i,Qf),l(i,[{key:"initialize",value:function(e){return this._type=e.type,this._status=Sl.SUCCESS,!0}},{key:"destroy",value:function(){this._status=Sl.UNREADY}},{key:"submit",value:function(e,t){if(!this._isAsync)for(var i=e.length,n=0;n<i;n++){var r=e[n];jM(this._device,r.cmdPackage),this.numDrawCalls+=r.numDrawCalls,this.numTris+=r.numTris}}},{key:"clear",value:function(){this.numDrawCalls=0,this.numTris=0}}]),i}(),aI=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._gpuRenderPass=null,t}return p(i,Kf),l(i,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),l(i,[{key:"initialize",value:function(e){return this._colorInfos=e.colorAttachments||[],this._depthStencilInfo=e.depthStencilAttachment||null,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._status=Sl.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuRenderPass=null,this._status=Sl.UNREADY}}]),i}(),sI=[10497,33648,33071,33071],oI=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._gpuSampler=null,t._state=new Zf,t}return p(i,Jf),l(i,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),l(i,[{key:"initialize",value:function(e){void 0!==e.name&&(this._state.name=e.name),void 0!==e.minFilter&&(this._state.minFilter=e.minFilter),void 0!==e.magFilter&&(this._state.magFilter=e.magFilter),void 0!==e.mipFilter&&(this._state.mipFilter=e.mipFilter),void 0!==e.addressU&&(this._state.addressU=e.addressU),void 0!==e.addressV&&(this._state.addressV=e.addressV),void 0!==e.addressW&&(this._state.addressW=e.addressW),void 0!==e.maxAnisotropy&&(this._state.maxAnisotropy=e.maxAnisotropy),void 0!==e.cmpFunc&&(this._state.cmpFunc=e.cmpFunc),void 0!==e.borderColor&&(this._state.borderColor=e.borderColor),void 0!==e.minLOD&&(this._state.minLOD=e.minLOD),void 0!==e.maxLOD&&(this._state.maxLOD=e.maxLOD),void 0!==e.mipLODBias&&(this._state.mipLODBias=e.mipLODBias);var t=0,i=0,n=this._state.minFilter,r=this._state.magFilter,a=this._state.mipFilter;t=n===sc.LINEAR||n===sc.ANISOTROPIC?a===sc.LINEAR||a===sc.ANISOTROPIC?9987:a===sc.POINT?9985:9729:a===sc.LINEAR||a===sc.ANISOTROPIC?9986:a===sc.POINT?9984:9728,i=r===sc.LINEAR||r===sc.ANISOTROPIC?9729:9728;var s=sI[this._state.addressU],o=sI[this._state.addressV],l=sI[this._state.addressW];return this._gpuSampler={glMinFilter:t,glMagFilter:i,glWrapS:s,glWrapT:o,glWrapR:l},this._status=Sl.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuSampler=null,this._status=Sl.UNREADY}}]),i}(),lI=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._gpuShader=null,t}return p(i,$f),l(i,[{key:"gpuShader",get:function(){return this._gpuShader}}]),l(i,[{key:"initialize",value:function(e){this._name=e.name,this._stages=e.stages,void 0!==e.blocks&&(this._blocks=e.blocks),void 0!==e.samplers&&(this._samplers=e.samplers),this._gpuShader={name:e.name?e.name:"",blocks:void 0!==e.blocks?e.blocks:[],samplers:void 0!==e.samplers?e.samplers:[],gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplers:[]};for(var t=0;t<e.stages.length;++t){var i=e.stages[t];this._gpuShader.gpuStages[t]={type:i.type,source:i.source,macros:i.macros?i.macros:[],glShader:null}}return function(e,a){function t(){if(l){if(c>=o.length)return"break";u=o[c++]}else{if((c=o.next()).done)return"break";u=c.value}var e=u,t=0,i="",n=1;switch(e.type){case xc.VERTEX:i="VertexShader",t=s.VERTEX_SHADER;break;case xc.FRAGMENT:i="FragmentShader",t=s.FRAGMENT_SHADER;break;default:return console.error("Unsupported GFXShaderType."),{v:void 0}}var r=s.createShader(t);if(r&&(e.glShader=r,s.shaderSource(e.glShader,e.source),s.compileShader(e.glShader),!s.getShaderParameter(e.glShader,s.COMPILE_STATUS)))return console.error(i+" in '"+a.name+"' compilation failed."),console.error("Shader source dump:",e.source.replace(/^|\n/g,function(){return"\n".concat(n++," ")})),console.error(s.getShaderInfoLog(e.glShader)),s.deleteShader(e.glShader),e.glShader=null,{v:void 0}}var s=e.gl,o=a.gpuStages,l=Array.isArray(o),c=0;e:for(o=l?o:o[Symbol.iterator]();;){var u,i=t();switch(i){case"break":break e;default:if("object"===de(i))return i.v}}var n=s.createProgram();if(n){a.glProgram=n;var r=a.gpuStages,h=Array.isArray(r),f=0;for(r=h?r:r[Symbol.iterator]();;){var d;if(h){if(f>=r.length)break;d=r[f++]}else{if((f=r.next()).done)break;d=f.value}var p=d;s.attachShader(a.glProgram,p.glShader)}if(s.linkProgram(a.glProgram),s.getProgramParameter(a.glProgram,s.LINK_STATUS)){console.info("Shader '"+a.name+"' compilation successed.");var _=s.getProgramParameter(a.glProgram,s.ACTIVE_ATTRIBUTES);a.glInputs=new Array(_);for(var v=0;v<_;++v){var m=s.getActiveAttrib(a.glProgram,v);if(m){var y=void 0,g=m.name.indexOf("[");y=-1!==g?m.name.substr(0,g):m.name;var b=s.getAttribLocation(a.glProgram,y),x=AM(m.type,s),S=kM(m.type,s);a.glInputs[v]={binding:b,name:y,type:x,stride:S,count:m.size,size:S*m.size,glType:m.type,glLoc:b}}}if(0<a.blocks.length){a.glBlocks=new Array(a.blocks.length);for(var w=0;w<a.blocks.length;++w){var T=a.blocks[w],E={binding:T.binding,name:T.name,size:0,glUniforms:new Array(T.members.length),glActiveUniforms:[],isUniformPackage:!0};a.glBlocks[w]=E;for(var C=0;C<T.members.length;++C){var A=T.members[C],k=CM(A.type,s),R=kM(k,s),O=R*A.count,M=E.size/4,I=new Array(O/4);I.fill(0),E.glUniforms[C]={binding:-1,name:A.name,type:A.type,stride:R,count:A.count,size:O,offset:E.size,glType:k,glLoc:-1,array:I,begin:M},E.size+=O}}}if(0<a.samplers.length){a.glSamplers=new Array(a.samplers.length);for(var L=0;L<a.samplers.length;++L){var z=a.samplers[L];a.glSamplers[L]={binding:z.binding,name:z.name,type:z.type,units:[],glType:CM(z.type,s),glLoc:-1}}}for(var B=s.getProgramParameter(a.glProgram,s.ACTIVE_UNIFORMS),P=0,D=[],F=0;F<B;++F){var N=s.getActiveUniform(a.glProgram,F);if(N){var U=s.getUniformLocation(a.glProgram,N.name);if(U){var V=void 0,G=N.name.indexOf("[");if(V=-1!==G?N.name.substr(0,G):N.name,N.type===s.SAMPLER_2D||N.type===s.SAMPLER_CUBE){var H=a.glSamplers,q=Array.isArray(H),j=0;for(H=q?H:H[Symbol.iterator]();;){var W;if(q){if(j>=H.length)break;W=H[j++]}else{if((j=H.next()).done)break;W=j.value}var X=W;if(X.name===V){for(var Y=0;Y<N.size;++Y)X.units.push(P+Y);X.glLoc=U,P+=N.size,D.push(X);break}}}else{var Q=a.glBlocks,K=Array.isArray(Q),Z=0;for(Q=K?Q:Q[Symbol.iterator]();;){var J;if(K){if(Z>=Q.length)break;J=Q[Z++]}else{if((Z=Q.next()).done)break;J=Z.value}var $=J,ee=$.glUniforms,te=Array.isArray(ee),ie=0;for(ee=te?ee:ee[Symbol.iterator]();;){var ne;if(te){if(ie>=ee.length)break;ne=ee[ie++]}else{if((ie=ee.next()).done)break;ne=ie.value}var re=ne;if(re.name===V){re.glLoc=U,$.glActiveUniforms.push(re);break}}}}}}}if(D.length){e.stateCache.glProgram!==a.glProgram&&(s.useProgram(a.glProgram),e.stateCache.glProgram=a.glProgram);for(var ae=0,se=D;ae<se.length;ae++){var oe=se[ae];s.uniform1iv(oe.glLoc,oe.units)}}}else{console.error("Failed to link shader '"+a.name+"'."),console.error(s.getProgramInfoLog(a.glProgram));var le=a.gpuStages,ce=Array.isArray(le),ue=0;for(le=ce?le:le[Symbol.iterator]();;){var he;if(ce){if(ue>=le.length)break;he=le[ue++]}else{if((ue=le.next()).done)break;he=ue.value}var fe=he;fe.glShader&&(s.deleteShader(fe.glShader),fe.glShader=null)}}}}(this._device,this._gpuShader),this._status=Sl.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuShader&&(function(e,t){var i=t.gpuStages,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;s.glShader&&(e.gl.deleteShader(s.glShader),s.glShader=null)}t.glProgram&&(e.gl.deleteProgram(t.glProgram),t.glProgram=null)}(this._device,this._gpuShader),this._gpuShader=null),this._status=Sl.UNREADY}}]),i}();function cI(e){return 0<e&&0==(e&e-1)}var uI=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._gpuTexture=null,t}return p(i,ed),l(i,[{key:"gpuTexture",get:function(){return this._gpuTexture}}]),l(i,[{key:"initialize",value:function(e){var t;switch(this._type=e.type,this._usage=e.usage,this._format=e.format,this._width=e.width,this._height=e.height,void 0!==e.depth&&(this._depth=e.depth),void 0!==e.arrayLayer&&(this._arrayLayer=e.arrayLayer),void 0!==e.mipLevel&&(this._mipLevel=e.mipLevel),void 0!==e.samples&&(this._samples=e.samples),void 0!==e.flags&&(this._flags=e.flags),this._isPowerOf2=cI(this._width)&&cI(this._height),this._size=Zc(this._format,this.width,this.height,this.depth,this.mipLevel)*this._arrayLayer,this._flags&mc.BAKUP_BUFFER&&(this._buffer=new ArrayBuffer(this._size)),e.type){case hc.TEX1D:t=e.arrayLayer?e.arrayLayer<=1?gc.TV1D:gc.TV1D_ARRAY:gc.TV1D;break;case hc.TEX2D:var i=mc.NONE;e.flags&&(i=e.flags),t=e.arrayLayer?e.arrayLayer<=1?gc.TV2D:i&mc.CUBEMAP?gc.CUBE:gc.TV2D_ARRAY:gc.TV2D;break;case hc.TEX3D:t=gc.TV3D;break;default:t=gc.TV2D}return this._gpuTexture={type:this._type,viewType:t,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._arrayLayer,mipLevel:this._mipLevel,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternelFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0},function(e,t){var i=e.gl;switch(t.glInternelFmt=TM(t.format,i),t.glFormat=EM(t.format,i),t.glType=wM(t.format,i),t.viewType){case gc.TV2D:if(t.viewType=gc.TV2D,t.glTarget=i.TEXTURE_2D,t.samples===_c.X1){var n=i.createTexture();if(n&&0<t.size){t.glTexture=n;var r=e.stateCache.glTexUnits[e.stateCache.texUnit];r.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_2D,t.glTexture),r.glTexture=t.glTexture);var a=t.width,s=t.height;if(Qc[t.format].isCompressed)if(t.glInternelFmt!==gM.COMPRESSED_RGB_ETC1_WEBGL)for(var o=0;o<t.mipLevel;++o){var l=Kc(t.format,a,s,1),c=new Uint8Array(l);i.compressedTexImage2D(i.TEXTURE_2D,o,t.glInternelFmt,a,s,0,c),a=Math.max(1,a>>1),s=Math.max(1,s>>1)}else{var u=Kc(t.format,2,2,1),h=new Uint8Array(u);i.compressedTexImage2D(i.TEXTURE_2D,0,t.glInternelFmt,2,2,0,h)}else for(var f=0;f<t.mipLevel;++f)i.texImage2D(i.TEXTURE_2D,f,t.glInternelFmt,a,s,0,t.glFormat,t.glType,null),a=Math.max(1,a>>1),s=Math.max(1,s>>1);t.isPowerOf2?(t.glWrapS=i.REPEAT,t.glWrapT=i.REPEAT):(t.glWrapS=i.CLAMP_TO_EDGE,t.glWrapT=i.CLAMP_TO_EDGE),t.glMinFilter=i.LINEAR,t.glMagFilter=i.LINEAR,i.texParameteri(t.glTarget,i.TEXTURE_WRAP_S,t.glWrapS),i.texParameteri(t.glTarget,i.TEXTURE_WRAP_T,t.glWrapT),i.texParameteri(t.glTarget,i.TEXTURE_MIN_FILTER,t.glMinFilter),i.texParameteri(t.glTarget,i.TEXTURE_MAG_FILTER,t.glMagFilter)}}break;case gc.CUBE:t.viewType=gc.CUBE,t.glTarget=i.TEXTURE_CUBE_MAP;var d=i.createTexture();if(d&&0<t.size){t.glTexture=d;var p=e.stateCache.glTexUnits[e.stateCache.texUnit];if(p.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,t.glTexture),p.glTexture=t.glTexture),Qc[t.format].isCompressed)if(t.glInternelFmt!==gM.COMPRESSED_RGB_ETC1_WEBGL)for(var _=0;_<6;++_)for(var v=t.width,m=t.height,y=0;y<t.mipLevel;++y){var g=Kc(t.format,v,m,1),b=new Uint8Array(g);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+_,y,t.glInternelFmt,v,m,0,b),v=Math.max(1,v>>1),m=Math.max(1,m>>1)}else for(var x=0;x<6;++x){var S=Kc(t.format,2,2,1),w=new Uint8Array(S);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+x,0,t.glInternelFmt,2,2,0,w)}else for(var T=0;T<6;++T)for(var E=t.width,C=t.height,A=0;A<t.mipLevel;++A)i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+T,A,t.glInternelFmt,E,C,0,t.glFormat,t.glType,null),E=Math.max(1,E>>1),C=Math.max(1,C>>1);t.isPowerOf2?(t.glWrapS=i.REPEAT,t.glWrapT=i.REPEAT):(t.glWrapS=i.CLAMP_TO_EDGE,t.glWrapT=i.CLAMP_TO_EDGE),t.glMinFilter=i.LINEAR,t.glMagFilter=i.LINEAR,i.texParameteri(t.glTarget,i.TEXTURE_WRAP_S,t.glWrapS),i.texParameteri(t.glTarget,i.TEXTURE_WRAP_T,t.glWrapT),i.texParameteri(t.glTarget,i.TEXTURE_MIN_FILTER,t.glMinFilter),i.texParameteri(t.glTarget,i.TEXTURE_MAG_FILTER,t.glMagFilter)}break;default:console.error("Unsupported GFXTextureType, create texture failed."),t.viewType=gc.TV2D,t.glTarget=i.TEXTURE_2D}}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize+=this._size,this._status=Sl.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuTexture&&(function(e,t){t.glTexture&&(e.gl.deleteTexture(t.glTexture),t.glTexture=null),t.glRenderbuffer&&(e.gl.deleteRenderbuffer(t.glRenderbuffer),t.glRenderbuffer=null)}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize-=this._size,this._gpuTexture=null),this._status=Sl.UNREADY,this._buffer=null}},{key:"resize",value:function(e,t){var i=this._size;this._width=e,this._height=t,this._size=Zc(this._format,this.width,this.height,this.depth,this.mipLevel)*this._arrayLayer,this._gpuTexture&&(this._gpuTexture.width=this._width,this._gpuTexture.height=this._height,this._gpuTexture.size=this._size,function(e,t){var i=e.gl;switch(t.glInternelFmt=TM(t.format,i),t.glFormat=EM(t.format,i),t.glType=wM(t.format,i),t.viewType){case gc.TV2D:if(t.viewType=gc.TV2D,t.glTarget=i.TEXTURE_2D,t.samples===_c.X1){var n=e.stateCache.glTexUnits[e.stateCache.texUnit];n.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_2D,t.glTexture),n.glTexture=t.glTexture);var r=t.width,a=t.height;if(Qc[t.format].isCompressed){if(t.glInternelFmt!==gM.COMPRESSED_RGB_ETC1_WEBGL)for(var s=0;s<t.mipLevel;++s){var o=Kc(t.format,r,a,1),l=new Uint8Array(o);i.compressedTexImage2D(i.TEXTURE_2D,s,t.glInternelFmt,r,a,0,l),r=Math.max(1,r>>1),a=Math.max(1,a>>1)}}else for(var c=0;c<t.mipLevel;++c)i.texImage2D(i.TEXTURE_2D,c,t.glInternelFmt,r,a,0,t.glFormat,t.glType,null),r=Math.max(1,r>>1),a=Math.max(1,a>>1)}break;case gc.CUBE:t.viewType=gc.CUBE,t.glTarget=i.TEXTURE_CUBE_MAP;var u=e.stateCache.glTexUnits[e.stateCache.texUnit];if(u.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,t.glTexture),u.glTexture=t.glTexture),Qc[t.format].isCompressed){if(t.glInternelFmt!==gM.COMPRESSED_RGB_ETC1_WEBGL)for(var h=0;h<6;++h)for(var f=t.width,d=t.height,p=0;p<t.mipLevel;++p){var _=Kc(t.format,f,d,1),v=new Uint8Array(_);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+h,p,t.glInternelFmt,f,d,0,v),f=Math.max(1,f>>1),d=Math.max(1,d>>1)}}else for(var m=0;m<6;++m)for(var y=t.width,g=t.height,b=0;b<t.mipLevel;++b)i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+m,b,t.glInternelFmt,y,g,0,t.glFormat,t.glType,null),y=Math.max(1,y>>1),g=Math.max(1,g>>1);break;default:console.error("Unsupported GFXTextureType, create texture failed."),t.viewType=gc.TV2D,t.glTarget=i.TEXTURE_2D}}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize-=i,this._device.memoryStatus.textureSize+=this._size),this._status=Sl.UNREADY}}]),i}(),hI=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._gpuTextureView=null,t}return p(i,td),l(i,[{key:"gpuTextureView",get:function(){return this._gpuTextureView}}]),l(i,[{key:"initialize",value:function(e){return this._texture=e.texture,this._type=e.type,this._format=e.format,this._format=e.format,void 0!==e.baseLevel&&(this._baseLevel=e.baseLevel),void 0!==e.levelCount&&(this._levelCount=e.levelCount),void 0!==e.baseLayer&&(this._baseLayer=e.baseLayer),void 0!==e.layerCount&&(this._layerCount=e.layerCount),this._gpuTextureView={gpuTexture:e.texture.gpuTexture,type:e.type,format:e.format,baseLevel:e.baseLevel?e.baseLevel:0,levelCount:e.levelCount?e.levelCount:1},this._status=Sl.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuTextureView=null,this._texture=null,this._status=Sl.UNREADY}}]),i}(),fI=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,bl.WINDOW)))._device=void 0,t._title="",t._left=0,t._top=0,t._width=0,t._height=0,t._nativeWidth=0,t._nativeHeight=0,t._colorFmt=Il.UNKNOWN,t._depthStencilFmt=Il.UNKNOWN,t._isOffscreen=!1,t._renderPass=null,t._colorTex=null,t._colorTexView=null,t._depthStencilTex=null,t._depthStencilTexView=null,t._framebuffer=null,t._device=e,t}return p(i,Hc),l(i,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"colorFormat",get:function(){return this._colorFmt}},{key:"detphStencilFormat",get:function(){return this._depthStencilFmt}},{key:"isOffscreen",get:function(){return this._isOffscreen}},{key:"renderPass",get:function(){return this._renderPass}},{key:"colorTexView",get:function(){return this._colorTexView}},{key:"depthStencilTexView",get:function(){return this._depthStencilTexView}},{key:"framebuffer",get:function(){return this._framebuffer}}]),i}(),dI=function(){function t(e){return y(this,t),x(this,g(t).call(this,e))}return p(t,fI),l(t,[{key:"initialize",value:function(e){void 0!==e.title&&(this._title=e.title),void 0!==e.left&&(this._left=e.left),void 0!==e.top&&(this._top=e.top),void 0!==e.isOffscreen&&(this._isOffscreen=e.isOffscreen),this._width=e.width,this._height=e.height,this._nativeWidth=this._width,this._nativeHeight=this._height,this._colorFmt=e.colorFmt,this._depthStencilFmt=e.depthStencilFmt,this._renderPass=this._device.createRenderPass({colorAttachments:[{format:this._colorFmt,loadOp:Ac.CLEAR,storeOp:Rc.STORE,sampleCount:1,beginLayout:Mc.COLOR_ATTACHMENT_OPTIMAL,endLayout:Mc.COLOR_ATTACHMENT_OPTIMAL}],depthStencilAttachment:{format:this._depthStencilFmt,depthLoadOp:Ac.CLEAR,depthStoreOp:Rc.STORE,stencilLoadOp:Ac.CLEAR,stencilStoreOp:Rc.STORE,sampleCount:1,beginLayout:Mc.DEPTH_STENCIL_ATTACHMENT_OPTIMAL,endLayout:Mc.DEPTH_STENCIL_ATTACHMENT_OPTIMAL}});var t=[];return this._isOffscreen&&(this._colorFmt!==Il.UNKNOWN&&(this._colorTex=this._device.createTexture({type:hc.TEX2D,usage:dc.COLOR_ATTACHMENT|dc.SAMPLED,format:this._colorFmt,width:this._width,height:this._height,depth:1,arrayLayer:1,mipLevel:1,flags:mc.NONE}),this._colorTexView=this._device.createTextureView({texture:this._colorTex,type:gc.TV2D,format:this._colorFmt,baseLevel:0,levelCount:1,baseLayer:0,layerCount:1}),t.push(this._colorTexView)),this._depthStencilFmt!==Il.UNKNOWN&&(this._depthStencilTex=this._device.createTexture({type:hc.TEX2D,usage:dc.DEPTH_STENCIL_ATTACHMENT,format:this._depthStencilFmt,width:this._width,height:this._height,depth:1,arrayLayer:1,mipLevel:1,flags:mc.NONE}),this._depthStencilTexView=this._device.createTextureView({texture:this._depthStencilTex,type:gc.TV2D,format:this._depthStencilFmt,baseLevel:0,levelCount:1,baseLayer:0,layerCount:1}))),this._framebuffer=this._device.createFramebuffer({renderPass:this._renderPass,colorViews:t,depthStencilView:this._depthStencilTexView,isOffscreen:this._isOffscreen}),this._status=Sl.SUCCESS,!0}},{key:"destroy",value:function(){this._depthStencilTexView&&(this._depthStencilTexView.destroy(),this._depthStencilTexView=null),this._depthStencilTex&&(this._depthStencilTex.destroy(),this._depthStencilTex=null),this._colorTexView&&(this._colorTexView.destroy(),this._colorTexView=null),this._colorTex&&(this._colorTex.destroy(),this._colorTex=null),this._framebuffer&&(this._framebuffer.destroy(),this._framebuffer=null),this._renderPass&&(this._renderPass.destroy(),this._renderPass=null),this._status=Sl.UNREADY}},{key:"resize",value:function(e,t){this._width=e,this._height=t,(e>this._nativeWidth||t>this._nativeHeight)&&(this._nativeWidth=e,this._nativeHeight=t,this._depthStencilTex&&(this._depthStencilTex.resize(e,t),this._depthStencilTexView.destroy(),this._depthStencilTexView.initialize({texture:this._depthStencilTex,type:gc.TV2D,format:this._depthStencilFmt})),this._colorTex&&(this._colorTex.resize(e,t),this._colorTexView.destroy(),this._colorTexView.initialize({texture:this._colorTex,type:gc.TV2D,format:this._colorFmt})),this._framebuffer&&this._framebuffer.isOffscreen&&(this._framebuffer.destroy(),this._framebuffer.initialize({renderPass:this._renderPass,colorViews:[this._colorTexView],depthStencilView:this._depthStencilTexView})))}}]),t}(),pI=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this))).stateCache=new XM,e.nullTex2D=null,e.nullTexCube=null,e._webGLRC=null,e._isAntialias=!0,e._isPremultipliedAlpha=!0,e._useVAO=!1,e._extensions=null,e._EXT_texture_filter_anisotropic=null,e._EXT_frag_depth=null,e._EXT_shader_texture_lod=null,e._EXT_sRGB=null,e._OES_vertex_array_object=null,e._EXT_color_buffer_half_float=null,e._WEBGL_color_buffer_float=null,e._WEBGL_compressed_texture_etc1=null,e._WEBGL_compressed_texture_etc=null,e._WEBGL_compressed_texture_pvrtc=null,e._WEBGL_compressed_texture_astc=null,e._WEBGL_compressed_texture_s3tc=null,e._WEBGL_compressed_texture_s3tc_srgb=null,e._WEBGL_debug_shaders=null,e._WEBGL_draw_buffers=null,e._WEBGL_lose_context=null,e._WEBGL_depth_texture=null,e._WEBGL_debug_renderer_info=null,e._OES_texture_half_float=null,e._OES_texture_half_float_linear=null,e._OES_texture_float=null,e._OES_texture_float_linear=null,e._OES_standard_derivatives=null,e._OES_element_index_uint=null,e._ANGLE_instanced_arrays=null,e}return p(t,ou),l(t,[{key:"gl",get:function(){return this._webGLRC}},{key:"webGLQueue",get:function(){return this._queue}},{key:"isAntialias",get:function(){return this._isAntialias}},{key:"isPremultipliedAlpha",get:function(){return this._isPremultipliedAlpha}},{key:"useVAO",get:function(){return this._useVAO}},{key:"EXT_texture_filter_anisotropic",get:function(){return this._EXT_texture_filter_anisotropic}},{key:"EXT_frag_depth",get:function(){return this._EXT_frag_depth}},{key:"EXT_shader_texture_lod",get:function(){return this._EXT_shader_texture_lod}},{key:"EXT_sRGB",get:function(){return this._EXT_sRGB}},{key:"OES_vertex_array_object",get:function(){return this._OES_vertex_array_object}},{key:"WEBGL_color_buffer_float",get:function(){return this._WEBGL_color_buffer_float}},{key:"WEBGL_compressed_texture_etc1",get:function(){return this._WEBGL_compressed_texture_etc1}},{key:"WEBGL_compressed_texture_pvrtc",get:function(){return this._WEBGL_compressed_texture_pvrtc}},{key:"WEBGL_compressed_texture_astc",get:function(){return this._WEBGL_compressed_texture_astc}},{key:"WEBGL_compressed_texture_s3tc",get:function(){return this._WEBGL_compressed_texture_s3tc}},{key:"WEBGL_compressed_texture_s3tc_srgb",get:function(){return this._WEBGL_compressed_texture_s3tc_srgb}},{key:"WEBGL_debug_shaders",get:function(){return this._WEBGL_debug_shaders}},{key:"WEBGL_draw_buffers",get:function(){return this._WEBGL_draw_buffers}},{key:"WEBGL_lose_context",get:function(){return this._WEBGL_lose_context}},{key:"WEBGL_depth_texture",get:function(){return this._WEBGL_depth_texture}},{key:"WEBGL_debug_renderer_info",get:function(){return this._WEBGL_debug_renderer_info}},{key:"OES_texture_half_float",get:function(){return this._OES_texture_half_float}},{key:"OES_texture_half_float_linear",get:function(){return this._OES_texture_half_float_linear}},{key:"OES_texture_float",get:function(){return this._OES_texture_float}},{key:"OES_standard_derivatives",get:function(){return this._OES_standard_derivatives}},{key:"OES_element_index_uint",get:function(){return this._OES_element_index_uint}},{key:"ANGLE_instanced_arrays",get:function(){return this._ANGLE_instanced_arrays}}]),l(t,[{key:"initialize",value:function(e){this._canvas=e.canvasElm,this._isAntialias=void 0===e.isAntialias||e.isAntialias,this._isPremultipliedAlpha=void 0===e.isPremultipliedAlpha||e.isPremultipliedAlpha;try{var t={alpha:!1,antialias:this._isAntialias,depth:!0,stencil:!0,premultipliedAlpha:this._isPremultipliedAlpha,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};this._webGLRC=this._canvas.getContext("webgl",t)}catch(e){return console.error(e),!1}if(!this._webGLRC)return console.error("This device does not support WebGL."),!1;this._canvas2D=document.createElement("canvas"),console.info("WebGL device initialized."),this._gfxAPI=eu.WEBGL,this._deviceName="WebGL";var i=this._webGLRC;this._WEBGL_debug_renderer_info=this.getExtension("WEBGL_debug_renderer_info"),this._WEBGL_debug_renderer_info?(this._renderer=i.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=i.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=i.getParameter(i.RENDERER),this._vendor=i.getParameter(i.VENDOR)),this._version=i.getParameter(i.VERSION),this._maxVertexAttributes=i.getParameter(i.MAX_VERTEX_ATTRIBS),this._maxVertexUniformVectors=i.getParameter(i.MAX_VERTEX_UNIFORM_VECTORS),this._maxFragmentUniformVectors=i.getParameter(i.MAX_FRAGMENT_UNIFORM_VECTORS),this._maxTextureUnits=i.getParameter(i.MAX_TEXTURE_IMAGE_UNITS),this._maxVertexTextureUnits=i.getParameter(i.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._depthBits=i.getParameter(i.DEPTH_BITS),this._stencilBits=i.getParameter(i.STENCIL_BITS),this._devicePixelRatio=e.devicePixelRatio||1,this._width=this._canvas.width,this._height=this._canvas.height,this._nativeWidth=Math.max(e.nativeWidth||this._width,0),this._nativeHeight=Math.max(e.nativeHeight||this._height,0),this._colorFmt=Il.RGBA8,24===this._depthBits?8===this._stencilBits?this._depthStencilFmt=Il.D24S8:this._depthStencilFmt=Il.D24:8===this._stencilBits?this._depthStencilFmt=Il.D16S8:this._depthStencilFmt=Il.D16,this._extensions=i.getSupportedExtensions();var n="";if(this._extensions){var r=this._extensions,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}n+=o+" "}console.debug("EXTENSIONS: "+n)}this._EXT_texture_filter_anisotropic=this.getExtension("EXT_texture_filter_anisotropic"),this._EXT_frag_depth=this.getExtension("EXT_frag_depth"),this._EXT_shader_texture_lod=this.getExtension("EXT_shader_texture_lod"),this._EXT_sRGB=this.getExtension("EXT_sRGB"),this._OES_vertex_array_object=this.getExtension("OES_vertex_array_object"),this._EXT_color_buffer_half_float=this.getExtension("EXT_color_buffer_half_float"),this._WEBGL_color_buffer_float=this.getExtension("WEBGL_color_buffer_float"),this._WEBGL_compressed_texture_etc1=this.getExtension("WEBGL_compressed_texture_etc1"),this._WEBGL_compressed_texture_etc=this.getExtension("WEBGL_compressed_texture_etc"),this._WEBGL_compressed_texture_pvrtc=this.getExtension("WEBGL_compressed_texture_pvrtc"),this._WEBGL_compressed_texture_astc=this.getExtension("WEBGL_compressed_texture_astc"),this._WEBGL_compressed_texture_s3tc=this.getExtension("WEBGL_compressed_texture_s3tc"),this._WEBGL_compressed_texture_s3tc_srgb=this.getExtension("WEBGL_compressed_texture_s3tc_srgb"),this._WEBGL_debug_shaders=this.getExtension("WEBGL_debug_shaders"),this._WEBGL_draw_buffers=this.getExtension("WEBGL_draw_buffers"),this._WEBGL_lose_context=this.getExtension("WEBGL_lose_context"),this._WEBGL_depth_texture=this.getExtension("WEBGL_depth_texture"),this._OES_texture_half_float=this.getExtension("OES_texture_half_float"),this._OES_texture_half_float_linear=this.getExtension("OES_texture_half_float_linear"),this._OES_texture_float=this.getExtension("OES_texture_float"),this._OES_texture_float_linear=this.getExtension("OES_texture_float_linear"),this._OES_standard_derivatives=this.getExtension("OES_standard_derivatives"),this._OES_element_index_uint=this.getExtension("OES_element_index_uint"),this._ANGLE_instanced_arrays=this.getExtension("ANGLE_instanced_arrays"),this._features.fill(!1),this._WEBGL_color_buffer_float&&(this._features[iu.COLOR_FLOAT]=!0),this._EXT_color_buffer_half_float&&(this._features[iu.COLOR_HALF_FLOAT]=!0),this._OES_texture_float&&(this._features[iu.TEXTURE_FLOAT]=!0),this._OES_texture_half_float&&(this._features[iu.TEXTURE_HALF_FLOAT]=!0),this._OES_texture_float_linear&&(this._features[iu.TEXTURE_FLOAT_LINEAR]=!0),this._OES_texture_half_float_linear&&(this._features[iu.TEXTURE_HALF_FLOAT_LINEAR]=!0),this._WEBGL_depth_texture&&(this._features[iu.FORMAT_D24S8]=!0);var l="";this._WEBGL_compressed_texture_etc1&&(this._features[iu.FORMAT_ETC1]=!0,l+="etc1 "),this._WEBGL_compressed_texture_etc&&(this._features[iu.FORMAT_ETC2]=!0,l+="etc2 "),this._WEBGL_compressed_texture_s3tc&&(this._features[iu.FORMAT_DXT]=!0,l+="dxt "),this._WEBGL_compressed_texture_pvrtc&&(this._features[iu.FORMAT_PVRTC]=!0,l+="pvrtc "),this._WEBGL_compressed_texture_astc&&(this._features[iu.FORMAT_ASTC]=!0,l+="astc "),this._features[iu.MSAA]=!1,this._OES_vertex_array_object&&(this._useVAO=!0),console.info("RENDERER: "+this._renderer),console.info("VENDOR: "+this._vendor),console.info("VERSION: "+this._version),console.info("DPR: "+this._devicePixelRatio),console.info("SCREEN_SIZE: "+this._width+" x "+this._height),console.info("NATIVE_SIZE: "+this._nativeWidth+" x "+this._nativeHeight),console.info("MAX_VERTEX_UNIFORM_VECTORS: "+this._maxVertexUniformVectors),console.info("DEPTH_BITS: "+this._depthBits),console.info("STENCIL_BITS: "+this._stencilBits),this._EXT_texture_filter_anisotropic&&console.info("MAX_TEXTURE_MAX_ANISOTROPY_EXT: "+this._EXT_texture_filter_anisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT),console.info("USE_VAO: "+this._useVAO),console.info("COMPRESSED_FORMAT: "+l),this.initStates(i),this._queue=this.createQueue({type:Nc.GRAPHICS}),this._mainWindow=this.createWindow({title:this._webGLRC.canvas.title,left:this._webGLRC.canvas.offsetLeft,top:this._webGLRC.canvas.offsetTop,width:this._webGLRC.drawingBufferWidth,height:this._webGLRC.drawingBufferHeight,colorFmt:this._colorFmt,depthStencilFmt:this._depthStencilFmt}),this._cmdAllocator=this.createCommandAllocator({}),this.nullTex2D=new uI(this),this.nullTex2D.initialize({type:hc.TEX2D,usage:dc.SAMPLED,format:Il.RGBA8,width:2,height:2,flags:mc.GEN_MIPMAP}),this.nullTexCube=new uI(this),this.nullTexCube.initialize({type:hc.TEX2D,usage:dc.SAMPLED,format:Il.RGBA8,width:2,height:2,arrayLayer:6,flags:mc.CUBEMAP|mc.GEN_MIPMAP});var c={buffOffset:0,buffStride:0,buffTexHeight:0,texOffset:{x:0,y:0,z:0},texExtent:{width:2,height:2,depth:1},texSubres:{baseMipLevel:0,levelCount:1,baseArrayLayer:0,layerCount:1}},u=new Uint8Array(this.nullTex2D.size);return u.fill(0),this.copyBuffersToTexture([u],this.nullTex2D,[c]),c.texSubres.layerCount=6,this.copyBuffersToTexture([u,u,u,u,u,u],this.nullTexCube,[c]),!0}},{key:"destroy",value:function(){this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._mainWindow&&(this._mainWindow.destroy(),this._mainWindow=null),this._cmdAllocator&&(this._cmdAllocator.destroy(),this._cmdAllocator=null),this._queue&&(this._queue.destroy(),this._queue=null),this._webGLRC=null}},{key:"resize",value:function(e,t){this._width===e&&this._height===t||(console.info("Resizing device: "+e+"x"+t),this._canvas.width=e,this._canvas.height=t,this._width=e,this._height=t)}},{key:"createBuffer",value:function(e){var t=new YM(this);return t.initialize(e),t}},{key:"createTexture",value:function(e){var t=new uI(this);return t.initialize(e),t}},{key:"createTextureView",value:function(e){var t=new hI(this);return t.initialize(e),t}},{key:"createSampler",value:function(e){var t=new oI(this);return t.initialize(e),t}},{key:"createBindingLayout",value:function(e){var t=new SM(this);return t.initialize(e),t}},{key:"createShader",value:function(e){var t=new lI(this);return t.initialize(e),t}},{key:"createInputAssembler",value:function(e){var t=new eI(this);return t.initialize(e),t}},{key:"createRenderPass",value:function(e){var t=new aI(this);return t.initialize(e),t}},{key:"createFramebuffer",value:function(e){var t=new $M(this);return t.initialize(e),t}},{key:"createPipelineLayout",value:function(e){var t=new tI(this);return t.initialize(e),t}},{key:"createPipelineState",value:function(e){var t=new nI(this);return t.initialize(e),t}},{key:"createCommandAllocator",value:function(e){var t=new ZM(this);return t.initialize(e),t}},{key:"createCommandBuffer",value:function(e){var t=new JM(this);return t.initialize(e),t}},{key:"createQueue",value:function(e){var t=new rI(this);return t.initialize(e),t}},{key:"createWindow",value:function(e){var t=new dI(this);return t.initialize(e),t}},{key:"present",value:function(){this._cmdAllocator.releaseCmds();var e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numTris=e.numTris,e.clear()}},{key:"copyBuffersToTexture",value:function(e,t,i){WM(this,e,t.gpuTexture,i)}},{key:"copyTexImagesToTexture",value:function(e,t,i){!function(e,t,i,n){var r=e.gl,a=e.stateCache.glTexUnits[e.stateCache.texUnit];a.glTexture!==i.glTexture&&(r.bindTexture(i.glTarget,i.glTexture),a.glTexture=i.glTexture);var s=0,o=0,l=0;switch(i.glTarget){case r.TEXTURE_2D:var c=n,u=Array.isArray(c),h=0;for(c=u?c:c[Symbol.iterator]();;){var f;if(u){if(h>=c.length)break;f=c[h++]}else{if((h=c.next()).done)break;f=h.value}var d=f;for(s=d.texSubres.baseMipLevel;s<d.texSubres.levelCount;++s)r.texSubImage2D(r.TEXTURE_2D,s,d.texOffset.x,d.texOffset.y,i.glFormat,i.glType,t[o++])}break;case r.TEXTURE_CUBE_MAP:var p=n,_=Array.isArray(p),v=0;for(p=_?p:p[Symbol.iterator]();;){var m;if(_){if(v>=p.length)break;m=p[v++]}else{if((v=p.next()).done)break;m=v.value}var y=m,g=y.texSubres.baseArrayLayer+y.texSubres.layerCount;for(l=y.texSubres.baseArrayLayer;l<g;++l){var b=y.texSubres.baseMipLevel+y.texSubres.levelCount;for(s=y.texSubres.baseMipLevel;s<b;++s)r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,s,y.texOffset.x,y.texOffset.y,i.glFormat,i.glType,t[o++])}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&mc.GEN_MIPMAP&&i.isPowerOf2&&r.generateMipmap(i.glTarget)}(this,e,t.gpuTexture,i)}},{key:"copyFramebufferToBuffer",value:function(e,t,i){var n=this._webGLRC,r=e.gpuFramebuffer,a=this.stateCache.glFramebuffer;this.stateCache.glFramebuffer!==r.glFramebuffer&&(n.bindFramebuffer(n.FRAMEBUFFER,r.glFramebuffer),this.stateCache.glFramebuffer=r.glFramebuffer);var s=new Uint8Array(t),o=i,l=Array.isArray(o),c=0;for(o=l?o:o[Symbol.iterator]();;){var u;if(l){if(c>=o.length)break;u=o[c++]}else{if((c=o.next()).done)break;u=c.value}var h=u,f=h.buffOffset+h.buffTexHeight*h.buffStride,d=h.texExtent.width,p=h.texExtent.height,_=Kc(Il.RGBA8,d,p,1),v=s.subarray(f,f+_);n.readPixels(h.texOffset.x,h.texOffset.y,d,p,n.RGBA,n.UNSIGNED_BYTE,v)}this.stateCache.glFramebuffer!==a&&(n.bindFramebuffer(n.FRAMEBUFFER,a),this.stateCache.glFramebuffer=a)}},{key:"blitFramebuffer",value:function(e,t,i,n,r){}},{key:"getExtension",value:function(e){for(var t=["","WEBKIT_","MOZ_"],i=0;i<t.length;++i){var n=this._webGLRC.getExtension(t[i]+e);if(n)return n}return null}},{key:"initStates",value:function(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,0),e.bindFramebuffer(e.FRAMEBUFFER,null),e.disable(e.SCISSOR_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.disable(e.POLYGON_OFFSET_FILL),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.depthRange(0,1),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,4294967295),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,4294967295),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,4294967295),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,4294967295),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)}}]),t}();cc.WebGLGFXDevice=pI;var _I,vI,mI,yI,gI,bI,xI,SI,wI,TI,EI,CI,AI,kI,RI,OI,MI,II,LI,zI,BI,PI,DI,FI,NI,UI,VI,GI,HI=new Fi,qI=new zn;function jI(e,t,i,n){var r=i.datas,a=t.currBufferBatch,s=a.byteOffset>>2,o=i.vertexCount,l=a.indiceOffset,c=a.vertexOffset;a.request(o,i.indiceCount)||(a=t.currBufferBatch,c=l=o=0);var u=a.vData,h=a.iData;e.getWorldMatrix(qI);for(var f=0;f<o;f++){var d=r[f];Fi.set(HI,d.x,d.y,0),Fi.transformMat4(HI,HI,qI),u[s++]=HI.x,u[s++]=HI.y,u[s++]=HI.z,u[s++]=d.u,u[s++]=d.v,rr.toArray(u,n,s),s+=4}for(var p=0,_=o/4;p<_;p++){var v=c+4*p;h[l++]=v,h[l++]=v+1,h[l++]=v+2,h[l++]=v+1,h[l++]=v+3,h[l++]=v+2}}(FI=DI=DI||{})[FI.SIMPLE=0]="SIMPLE",FI[FI.SLICED=1]="SLICED",FI[FI.FILLED=3]="FILLED",mt(DI),(UI=NI=NI||{})[UI.HORIZONTAL=0]="HORIZONTAL",UI[UI.VERTICAL=1]="VERTICAL",UI[UI.RADIAL=2]="RADIAL",mt(NI),(GI=VI=VI||{})[GI.CUSTOM=0]="CUSTOM",GI[GI.TRIMMED=1]="TRIMMED",GI[GI.RAW=2]="RAW",mt(VI);var WI,XI,YI,QI,KI,ZI,JI,$I,eL,tL,iL,nL,rL,aL,sL,oL,lL,cL,uL,hL,fL,dL,pL,_L,vL,mL,yL,gL,bL,xL,SL,wL,TL,EL,CL=P2("SpriteComponent",(_I=ho("cc.SpriteComponent"),vI=go(110),mI=yo("UI/Render/Sprite"),yI=fo({type:Hx,displayOrder:4}),gI=fo({type:Eh,displayOrder:5}),bI=fo({type:DI,displayOrder:6}),xI=fo({type:NI}),SI=fo({displayOrder:8}),wI=fo({type:VI,displayOrder:7}),_I(TI=vI(TI=mI((PI=BI=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"_spriteFrame",CI,u(t)),v(t,"_type",AI,u(t)),v(t,"_fillType",kI,u(t)),v(t,"_sizeMode",RI,u(t)),v(t,"_fillCenter",OI,u(t)),v(t,"_fillStart",MI,u(t)),v(t,"_fillRange",II,u(t)),v(t,"_isTrimmedMode",LI,u(t)),v(t,"_atlas",zI,u(t)),t}return p(a,GC),l(a,[{key:"__preload",value:function(){_(g(a.prototype),"__preload",this)&&_(g(a.prototype),"__preload",this).call(this),this._spriteFrame&&(this._spriteFrame.on("load",this._markForUpdateUvDirty,this),this._markForUpdateUvDirty())}},{key:"onEnable",value:function(){_(g(a.prototype),"onEnable",this).call(this),this._activateMaterial()}},{key:"onDestroy",value:function(){_(g(a.prototype),"onDestroy",this).call(this),this.destroyRenderData(),this._spriteFrame&&this._spriteFrame.off("load")}},{key:"_render",value:function(e){e.commitComp(this,this._spriteFrame.getGFXTextureView(),this._assembler)}},{key:"_canRender",value:function(){if(!_(g(a.prototype),"_canRender",this).call(this))return!1;var e=this._spriteFrame;return!(!e||!e.textureLoaded())}},{key:"_flushAssembler",value:function(){var e=a.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this._material,this.markForUpdateRenderData())}},{key:"_applySpriteSize",value:function(){if(this._spriteFrame){if(VI.RAW===this._sizeMode){var e=this._spriteFrame.originalSize;this.node.setContentSize(e)}else if(VI.TRIMMED===this._sizeMode){var t=this._spriteFrame.getRect();this.node.setContentSize(t.width,t.height)}this._activateMaterial()}}},{key:"_resized",value:function(){}},{key:"_activateMaterial",value:function(){var e=this._spriteFrame,t=this._material;cc.game.renderType!==cc.game.RENDER_TYPE_CANVAS?(e&&t&&(t.setProperty("mainTexture",e),this.markForUpdateRenderData()),this._renderData&&(this._renderData.material=t)):this.markForUpdateRenderData()}},{key:"_applyAtlas",value:function(e){}},{key:"_onTextureLoaded",value:function(){this.isValid&&this._applySpriteSize()}},{key:"_applySpriteFrame",value:function(e){var t=this._spriteFrame;this._renderData&&(e&&e.off("load",this._markForUpdateUvDirty),t&&t.on("load",this._markForUpdateUvDirty,this),this._renderData.uvDirty||(this._renderData.uvDirty=!e||!t||e.uvHash!==t.uvHash),this._renderDataFlag=this._renderData.uvDirty),t&&(e&&t===e||(t.loaded?this._onTextureLoaded():t.once("load",this._onTextureLoaded,this)))}},{key:"_markForUpdateUvDirty",value:function(){this._renderData&&(this._renderData.uvDirty=!0,this._renderDataFlag=!0)}},{key:"spriteAtlas",get:function(){return this._atlas},set:function(e){this._atlas!==e&&(this._atlas=e,this.spriteFrame=null)}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){if(this._spriteFrame!==e){var t=this._spriteFrame;this._spriteFrame=e,this.markForUpdateRenderData(!1),this._applySpriteFrame(t)}}},{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this._flushAssembler())}},{key:"fillType",get:function(){return this._fillType},set:function(e){this._fillType!==e&&(e===NI.RADIAL||this._fillType===NI.RADIAL?(this.destroyRenderData(),this._renderData=null):this._renderData&&this.markForUpdateRenderData(!0)),this._fillType=e,this._flushAssembler()}},{key:"fillCenter",get:function(){return this._fillCenter},set:function(e){this._fillCenter.x=e.x,this._fillCenter.y=e.y,this._type===DI.FILLED&&this._renderData&&this.markForUpdateRenderData()}},{key:"fillStart",get:function(){return this._fillStart},set:function(e){this._fillStart=pi(e,-1,1),this._type===DI.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._renderData.uvDirty=!0)}},{key:"fillRange",get:function(){return this._fillRange},set:function(e){this._fillRange=pi(e,0,1),this._type===DI.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._renderData.uvDirty=!0)}},{key:"trim",get:function(){return this._isTrimmedMode},set:function(e){this._isTrimmedMode!==e&&(this._isTrimmedMode=e,this._type===DI.SIMPLE&&this._renderData&&this.markForUpdateRenderData(!0))}},{key:"sizeMode",get:function(){return this._sizeMode},set:function(e){this._sizeMode!==e&&(this._sizeMode=e)!==VI.CUSTOM&&this._applySpriteSize()}}]),a}(),BI.FillType=NI,BI.Type=DI,BI.SizeMode=VI,m((EI=PI).prototype,"spriteAtlas",[yI],Object.getOwnPropertyDescriptor(EI.prototype,"spriteAtlas"),EI.prototype),m(EI.prototype,"spriteFrame",[gI],Object.getOwnPropertyDescriptor(EI.prototype,"spriteFrame"),EI.prototype),m(EI.prototype,"type",[bI],Object.getOwnPropertyDescriptor(EI.prototype,"type"),EI.prototype),m(EI.prototype,"fillType",[xI],Object.getOwnPropertyDescriptor(EI.prototype,"fillType"),EI.prototype),m(EI.prototype,"fillCenter",[fo],Object.getOwnPropertyDescriptor(EI.prototype,"fillCenter"),EI.prototype),m(EI.prototype,"fillStart",[fo],Object.getOwnPropertyDescriptor(EI.prototype,"fillStart"),EI.prototype),m(EI.prototype,"fillRange",[fo],Object.getOwnPropertyDescriptor(EI.prototype,"fillRange"),EI.prototype),m(EI.prototype,"trim",[SI],Object.getOwnPropertyDescriptor(EI.prototype,"trim"),EI.prototype),m(EI.prototype,"sizeMode",[wI],Object.getOwnPropertyDescriptor(EI.prototype,"sizeMode"),EI.prototype),CI=m(EI.prototype,"_spriteFrame",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),AI=m(EI.prototype,"_type",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return DI.SIMPLE}}),kI=m(EI.prototype,"_fillType",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return NI.HORIZONTAL}}),RI=m(EI.prototype,"_sizeMode",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return VI.TRIMMED}}),OI=m(EI.prototype,"_fillCenter",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Mi(0,0)}}),MI=m(EI.prototype,"_fillStart",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),II=m(EI.prototype,"_fillRange",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),LI=m(EI.prototype,"_isTrimmedMode",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),zI=m(EI.prototype,"_atlas",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),TI=EI))||TI)||TI)||TI));cc.SpriteComponent=CL,(wL=SL=SL||{})[wL.NONE=0]="NONE",wL[wL.COLOR=1]="COLOR",wL[wL.SPRITE=2]="SPRITE",wL[wL.SCALE=3]="SCALE",mt(SL),(EL=TL=TL||{}).NORMAL="normal",EL.HOVER="hover",EL.PRESSED="pressed",EL.DISABLED="disabled";var AL=P2("ButtonComponent",(WI=ho("cc.ButtonComponent"),XI=go(110),YI=yo("UI/Button"),QI=fo({displayOrder:1}),KI=fo({type:SL,displayOrder:2}),ZI=fo({min:0,max:10}),JI=fo({type:Eh}),$I=fo({type:Eh}),eL=fo({type:Eh}),tL=fo({type:Eh}),iL=fo({type:Sm,displayOrder:0}),nL=fo({type:kT,displayOrder:3}),WI(rL=XI(rL=YI((xL=bL=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"clickEvents",sL,u(t)),v(t,"_interactable",oL,u(t)),v(t,"_transition",lL,u(t)),v(t,"_normalColor",cL,u(t)),v(t,"_hoverColor",uL,u(t)),v(t,"_pressColor",hL,u(t)),v(t,"_disabledColor",fL,u(t)),v(t,"_normalSprite",dL,u(t)),v(t,"_hoverSprite",pL,u(t)),v(t,"_pressedSprite",_L,u(t)),v(t,"_disabledSprite",vL,u(t)),v(t,"_duration",mL,u(t)),v(t,"_zoomScale",yL,u(t)),v(t,"_target",gL,u(t)),t._pressed=!1,t._hovered=!1,t._fromColor=new rr,t._toColor=new rr,t._time=0,t._transitionFinished=!0,t._fromScale=new Fi,t._toScale=new Fi,t._originalScale=new Fi,t._sprite=null,t._targetScale=new Fi,t}return p(a,Bv),l(a,[{key:"__preload",value:function(){this.target||(this.target=this.node);var e=this.node.getComponent(CL);e&&(this._normalSprite=e.spriteFrame),this._applyTarget(),this._updateState()}},{key:"onEnable",value:function(){this._registerEvent()}},{key:"onDisable",value:function(){this._resetState(),this.node.off(U_.TOUCH_START,this._onTouchBegan,this),this.node.off(U_.TOUCH_MOVE,this._onTouchMove,this),this.node.off(U_.TOUCH_END,this._onTouchEnded,this),this.node.off(U_.TOUCH_CANCEL,this._onTouchCancel,this),this.node.off(U_.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.off(U_.MOUSE_LEAVE,this._onMouseMoveOut,this)}},{key:"update",value:function(e){var t=this._target?this._target:this.node;if(!this._transitionFinished&&(this._transition===SL.COLOR||this._transition===SL.SCALE)){this._time+=e;var i=1;0<this._duration&&(i=this._time/this._duration),1<=i&&(i=1,this._transitionFinished=!0);var n=t.getComponent(GC);n&&(this._transition===SL.COLOR?rr.lerp(n.color,this._fromColor,this._toColor,i):this.transition===SL.SCALE&&(t.getScale(this._targetScale),this._targetScale.x=vi(this._fromScale.x,this._toScale.x,i),this._targetScale.y=vi(this._fromScale.y,this._toScale.y,i),t.setScale(this._targetScale)))}}},{key:"_resizeNodeToTargetNode",value:function(){0}},{key:"_resetState",value:function(){this._pressed=!1,this._hovered=!1;var e=this._target;if(e){var t=e.getComponent(GC);if(t){var i=this._transition;i===SL.COLOR&&this._interactable?t.color=this._normalColor:i===SL.SCALE&&e.setScale(this._originalScale),this._transitionFinished=!0}}}},{key:"_registerEvent",value:function(){this.node.on(U_.TOUCH_START,this._onTouchBegan,this),this.node.on(U_.TOUCH_MOVE,this._onTouchMove,this),this.node.on(U_.TOUCH_END,this._onTouchEnded,this),this.node.on(U_.TOUCH_CANCEL,this._onTouchCancel,this),this.node.on(U_.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.on(U_.MOUSE_LEAVE,this._onMouseMoveOut,this)}},{key:"_getTargetSprite",value:function(e){var t=null;return e&&(t=e.getComponent(CL)),t}},{key:"_applyTarget",value:function(){this._sprite=this._getTargetSprite(this._target),this._target&&Fi.copy(this._originalScale,this._target.getScale())}},{key:"_onTouchBegan",value:function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed=!0,this._updateState(),e&&(e.propagationStopped=!0))}},{key:"_onTouchMove",value:function(e){if(this._interactable&&this.enabledInHierarchy&&this._pressed){if(!e)return!1;var t=e.touch;if(!t)return!1;var i,n=this.node.uiTransfromComp.isHit(t.getUILocation());if(this._transition===SL.SCALE&&this._target)n?(Fi.copy(this._fromScale,this._originalScale),Fi.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._transitionFinished=!1):(this._time=0,this._transitionFinished=!0,this._target&&this._target.setScale(this._originalScale));else i=n?TL.PRESSED:TL.NORMAL,this._applyTransition(i);e&&(e.propagationStopped=!0)}}},{key:"_onTouchEnded",value:function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed&&(kT.emitEvents(this.clickEvents,e),this.node.emit("click",this)),this._pressed=!1,this._updateState(),e&&(e.propagationStopped=!0))}},{key:"_onTouchCancel",value:function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed=!1,this._updateState())}},{key:"_onMouseMoveIn",value:function(e){!this._pressed&&this.interactable&&this.enabledInHierarchy&&(this._transition===SL.SPRITE&&!this._hoverSprite||this._hovered||(this._hovered=!0,this._updateState()))}},{key:"_onMouseMoveOut",value:function(e){this._hovered&&(this._hovered=!1,this._updateState())}},{key:"_updateState",value:function(){var e=this._getButtonState();this._applyTransition(e)}},{key:"_getButtonState",value:function(){var e=TL.NORMAL;return this._interactable?this._pressed?e=TL.PRESSED:this._hovered&&(e=TL.HOVER):e=TL.DISABLED,e.toString()}},{key:"_updateColorTransition",value:function(e){var t=this[e+"Color"],i=this._target;if(i){var n=i.getComponent(GC);n&&(e===TL.DISABLED?n.color=t:(this._fromColor=n.color.clone(),this._toColor=t,this._time=0,this._transitionFinished=!1))}}},{key:"_updateSpriteTransition",value:function(e){var t=this[e+"Sprite"];this._sprite&&t&&(this._sprite.spriteFrame=t)}},{key:"_updateScaleTransition",value:function(e){this._interactable&&(e===TL.PRESSED?this._zoomUp():this._zoomBack())}},{key:"_zoomUp",value:function(){Fi.copy(this._fromScale,this._originalScale),Fi.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._time=0,this._transitionFinished=!1}},{key:"_zoomBack",value:function(){this._target&&(Fi.copy(this._fromScale,this._target.getScale()),Fi.copy(this._toScale,this._originalScale),this._time=0,this._transitionFinished=!1)}},{key:"_applyTransition",value:function(e){var t=this._transition;t===SL.COLOR?this._updateColorTransition(e):t===SL.SPRITE?this._updateSpriteTransition(e):t===SL.SCALE&&this._updateScaleTransition(e)}},{key:"interactable",get:function(){return this._interactable},set:function(e){this._interactable=e,this._updateState(),this._interactable||this._resetState()}},{key:"_resizeToTarget",set:function(e){e&&this._resizeNodeToTargetNode()}},{key:"transition",get:function(){return this._transition},set:function(e){this._transition!==e&&(this._transition=e)}},{key:"normalColor",get:function(){return this._normalColor},set:function(e){this._normalColor!==e&&(this._normalColor.set(e),this._updateState())}},{key:"pressedColor",get:function(){return this._pressColor},set:function(e){this._pressColor!==e&&this._pressColor.set(e)}},{key:"hoverColor",get:function(){return this._hoverColor},set:function(e){this._hoverColor!==e&&this._hoverColor.set(e)}},{key:"disabledColor",get:function(){return this._disabledColor},set:function(e){this._disabledColor!==e&&(this._disabledColor.set(e),this._updateState())}},{key:"duration",get:function(){return this._duration},set:function(e){this._duration!==e&&(this._duration=e)}},{key:"zoomScale",get:function(){return this._zoomScale},set:function(e){this._zoomScale!==e&&(this._zoomScale=e)}},{key:"normalSprite",get:function(){return this._normalSprite},set:function(e){if(this._normalSprite!==e){this._normalSprite=e;var t=this.node.getComponent(CL);t&&(t.spriteFrame=e),this._updateState()}}},{key:"pressedSprite",get:function(){return this._pressedSprite},set:function(e){this._pressedSprite!==e&&(this._pressedSprite=e,this._updateState())}},{key:"hoverSprite",get:function(){return this._hoverSprite},set:function(e){this._hoverSprite!==e&&(this._hoverSprite=e,this._updateState())}},{key:"disabledSprite",get:function(){return this._disabledSprite},set:function(e){this._disabledSprite!==e&&(this._disabledSprite=e,this._updateState())}},{key:"target",get:function(){return this._target},set:function(e){this._target!==e&&(this._target=e,this._applyTarget())}}]),a}(),bL.Transition=SL,m((aL=xL).prototype,"interactable",[QI],Object.getOwnPropertyDescriptor(aL.prototype,"interactable"),aL.prototype),m(aL.prototype,"transition",[KI],Object.getOwnPropertyDescriptor(aL.prototype,"transition"),aL.prototype),m(aL.prototype,"normalColor",[fo],Object.getOwnPropertyDescriptor(aL.prototype,"normalColor"),aL.prototype),m(aL.prototype,"pressedColor",[fo],Object.getOwnPropertyDescriptor(aL.prototype,"pressedColor"),aL.prototype),m(aL.prototype,"hoverColor",[fo],Object.getOwnPropertyDescriptor(aL.prototype,"hoverColor"),aL.prototype),m(aL.prototype,"disabledColor",[fo],Object.getOwnPropertyDescriptor(aL.prototype,"disabledColor"),aL.prototype),m(aL.prototype,"duration",[ZI],Object.getOwnPropertyDescriptor(aL.prototype,"duration"),aL.prototype),m(aL.prototype,"zoomScale",[fo],Object.getOwnPropertyDescriptor(aL.prototype,"zoomScale"),aL.prototype),m(aL.prototype,"normalSprite",[JI],Object.getOwnPropertyDescriptor(aL.prototype,"normalSprite"),aL.prototype),m(aL.prototype,"pressedSprite",[$I],Object.getOwnPropertyDescriptor(aL.prototype,"pressedSprite"),aL.prototype),m(aL.prototype,"hoverSprite",[eL],Object.getOwnPropertyDescriptor(aL.prototype,"hoverSprite"),aL.prototype),m(aL.prototype,"disabledSprite",[tL],Object.getOwnPropertyDescriptor(aL.prototype,"disabledSprite"),aL.prototype),m(aL.prototype,"target",[iL],Object.getOwnPropertyDescriptor(aL.prototype,"target"),aL.prototype),sL=m(aL.prototype,"clickEvents",[nL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),oL=m(aL.prototype,"_interactable",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),lL=m(aL.prototype,"_transition",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return SL.NONE}}),cL=m(aL.prototype,"_normalColor",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rr(214,214,214,255)}}),uL=m(aL.prototype,"_hoverColor",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rr(211,211,211,255)}}),hL=m(aL.prototype,"_pressColor",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rr.WHITE.clone()}}),fL=m(aL.prototype,"_disabledColor",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rr(124,124,124,255)}}),dL=m(aL.prototype,"_normalSprite",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),pL=m(aL.prototype,"_hoverSprite",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_L=m(aL.prototype,"_pressedSprite",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),vL=m(aL.prototype,"_disabledSprite",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),mL=m(aL.prototype,"_duration",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),yL=m(aL.prototype,"_zoomScale",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),gL=m(aL.prototype,"_target",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),rL=aL))||rL)||rL)||rL));cc.ButtonComponent=AL;var kL,RL,OL,ML,IL,LL,zL,BL,PL,DL,FL,NL,UL,VL,GL,HL,qL,jL,WL,XL,YL,QL,KL,ZL,JL,$L,ez,tz,iz,nz,rz,az,sz,oz,lz,cz,uz,hz,fz,dz,pz,_z,vz,mz,yz,gz,bz=P2("CanvasPool",function(){function e(){y(this,e),this.pool=[]}return l(e,[{key:"get",value:function(){var e=this.pool.pop();if(!e){var t=document.createElement("canvas"),i=t.getContext("2d");e={canvas:t,context:i}}return e}},{key:"put",value:function(e){32<=this.pool.length||this.pool.push(e)}}]),e}());(dz=fz=fz||P2("HorizontalTextAlignment",{}))[dz.LEFT=0]="LEFT",dz[dz.CENTER=1]="CENTER",dz[dz.RIGHT=2]="RIGHT",mt(fz),(_z=pz=pz||P2("VerticalTextAlignment",{}))[_z.TOP=0]="TOP",_z[_z.CENTER=1]="CENTER",_z[_z.BOTTOM=2]="BOTTOM",mt(pz),(mz=vz=vz||P2("Overflow",{}))[mz.NONE=0]="NONE",mz[mz.CLAMP=1]="CLAMP",mz[mz.SHRINK=2]="SHRINK",mz[mz.RESIZE_HEIGHT=3]="RESIZE_HEIGHT",mt(vz),(gz=yz=yz||{})[gz.NONE=0]="NONE",gz[gz.BITMAP=1]="BITMAP",gz[gz.CHAR=2]="CHAR",mt(yz);var xz,Sz,wz,Tz,Ez,Cz,Az,kz=P2("LabelComponent",(kL=ho("cc.LabelComponent"),RL=go(110),OL=yo("UI/Render/Label"),ML=fo({displayOrder:4,multiline:!0}),IL=fo({type:fz,displayOrder:5}),LL=fo({type:pz,displayOrder:6}),zL=fo({readonly:!0,displayName:"Actual Font Size",visible:!1}),BL=fo({displayOrder:7}),PL=fo({displayOrder:8}),DL=fo({displayOrder:8}),FL=fo({type:vz,displayOrder:9}),NL=fo({displayOrder:10}),UL=fo({type:ew,displayOrder:11}),VL=fo({displayOrder:12}),GL=fo({type:yz,displayOrder:13}),HL=fo({displayOrder:15}),qL=fo({displayOrder:16}),jL=fo({displayOrder:17}),kL(WL=RL(WL=OL((hz=uz=function(){function i(){var e;return y(this,i),v(e=x(this,g(i).call(this)),"_useOriginalSize",YL,u(e)),v(e,"_string",QL,u(e)),v(e,"_horizontalAlign",KL,u(e)),v(e,"_verticalAlign",ZL,u(e)),v(e,"_actualFontSize",JL,u(e)),v(e,"_fontSize",$L,u(e)),v(e,"_fontFamily",ez,u(e)),v(e,"_lineHeight",tz,u(e)),v(e,"_overflow",iz,u(e)),v(e,"_enableWrapText",nz,u(e)),v(e,"_font",rz,u(e)),v(e,"_isSystemFontUsed",az,u(e)),e._spacingX=0,v(e,"_isItalic",sz,u(e)),v(e,"_isBold",oz,u(e)),v(e,"_isUnderline",lz,u(e)),v(e,"_cacheMode",cz,u(e)),e._N$file=null,e._texture=null,e._ttfSpriteFrame=null,e._userDefinedFont=null,e._assemblerData=null,e._fontAtlas=null,e._letterTexture=null,e._ttfSpriteFrame=null,e}return p(i,GC),l(i,[{key:"string",get:function(){return this._string},set:function(e){e=e.toString(),this._string!==e&&(this._string=e,this.updateRenderData())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(e){this._horizontalAlign!==e&&(this._horizontalAlign=e,this.updateRenderData())}},{key:"verticalAlign",get:function(){return this._verticalAlign},set:function(e){this._verticalAlign!==e&&(this._verticalAlign=e,this.updateRenderData())}},{key:"actualFontSize",get:function(){return this._actualFontSize},set:function(e){this._actualFontSize=e}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this.updateRenderData())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(e){this._fontFamily!==e&&(this._fontFamily=e,this.updateRenderData())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this.updateRenderData())}},{key:"overflow",get:function(){return this._overflow},set:function(e){this._overflow!==e&&(this._overflow=e,this.updateRenderData())}},{key:"enableWrapText",get:function(){return this._enableWrapText},set:function(e){this._enableWrapText!==e&&(this._enableWrapText=e,this.updateRenderData())}},{key:"font",get:function(){return this._font},set:function(e){this._font!==e&&(this._isSystemFontUsed=!e,"string"==typeof(this._font=e)&&B(4e3),this._renderData&&(this.destroyRenderData(),this._renderData=null),this._fontAtlas=null,this.updateRenderData(!0))}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(e){this._isSystemFontUsed!==e&&(this.destroyRenderData(),this._renderData=null,this._isSystemFontUsed=!!e,e&&(this.font=null,this._flushAssembler(),this.updateRenderData()))}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(e){this._cacheMode!==e&&(this._cacheMode===yz.CHAR&&(this._ttfSpriteFrame=null),this._cacheMode=e,this.updateRenderData(!0))}},{key:"spriteFrame",get:function(){return this._texture}},{key:"isBold",get:function(){return this._isBold},set:function(e){this._isBold!==e&&(this._isBold=e,this.updateRenderData())}},{key:"isItalic",get:function(){return this._isItalic},set:function(e){this._isItalic!==e&&(this._isItalic=e,this.updateRenderData())}},{key:"isUnderline",get:function(){return this._isUnderline},set:function(e){this._isUnderline!==e&&(this._isUnderline=e,this.updateRenderData())}},{key:"assemblerData",get:function(){return this._assemblerData}},{key:"fontAtlas",get:function(){return this._fontAtlas},set:function(e){this._fontAtlas=e}},{key:"spacingX",get:function(){return this._spacingX},set:function(e){this._spacingX!==e&&(this._spacingX=e,this.updateRenderData())}},{key:"_bmFontOriginalSize",get:function(){return this._font instanceof hw?this._font.fontSize:-1}}]),l(i,[{key:"onEnable",value:function(){_(g(i.prototype),"onEnable",this).call(this),this._font||this._isSystemFontUsed||(this.useSystemFont=!0),this._isSystemFontUsed&&!this._fontFamily&&(this.fontFamily="Arial"),this.updateRenderData(!0)}},{key:"onDisable",value:function(){_(g(i.prototype),"onDisable",this).call(this)}},{key:"onDestroy",value:function(){if(this._assembler&&this._assembler.resetAssemblerData&&this._assembler.resetAssemblerData(this._assemblerData),this._assemblerData=null,this._ttfSpriteFrame){var e=this._ttfSpriteFrame.texture;if(e){var t=e;t.image&&t.image.destroy(),e.destroy()}this._ttfSpriteFrame=null}this._letterTexture&&(this._letterTexture.destroy(),this._letterTexture=null),_(g(i.prototype),"onDestroy",this).call(this)}},{key:"updateRenderData",value:function(e){var t=0<arguments.length&&void 0!==e&&e;this.markForUpdateRenderData(),t&&(this._flushAssembler(),this._applyFontTexture(t))}},{key:"_render",value:function(e){e.commitComp(this,this._texture.getGFXTextureView(),this._assembler)}},{key:"_updateColor",value:function(){this._font instanceof hw?_(g(i.prototype),"_updateColor",this).call(this):this.updateRenderData(!1)}},{key:"_canRender",value:function(){if(!_(g(i.prototype),"_canRender",this).call(this)||!this._string)return!1;var e=this._font;if(e&&e instanceof hw){var t=e.spriteFrame;if(!t||!t.textureLoaded())return!1}return!0}},{key:"_flushAssembler",value:function(){var e=i.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this._material)}},{key:"_flushMaterial",value:function(){var e=this._material;e&&e.setProperty("mainTexture",this._texture),this._updateMaterial(e)}},{key:"_applyFontTexture",value:function(e){var t=this,i=this._font;if(i instanceof hw){var n=i.spriteFrame,r=this;n&&n.loaded&&(r._texture=n,r._flushMaterial(),e&&t._renderFlag&&t._assembler&&t._renderData&&t._assembler.updateRenderData(t))}else{if(this.cacheMode===yz.CHAR&&ul.browserType!==ul.BROWSER_TYPE_WECHAT_GAME_SUB)this._letterTexture=this._assembler.getAssemblerData(),this._texture=this._letterTexture;else if(!this._ttfSpriteFrame){this._ttfSpriteFrame=new Eh,this._assemblerData=this._assembler.getAssemblerData();var a=new zu(this._assemblerData.canvas)._texture;this._ttfSpriteFrame.texture=a}this.cacheMode!==yz.CHAR&&(this._texture=this._ttfSpriteFrame),this._flushMaterial()}e&&this._renderFlag&&this._assembler&&this._renderData&&this._assembler.updateRenderData(this)}}]),i}(),uz.HorizontalAlign=fz,uz.VerticalAlign=pz,uz.Overflow=vz,uz.CacheMode=yz,uz.CanvasPool=new bz,m((XL=hz).prototype,"string",[ML],Object.getOwnPropertyDescriptor(XL.prototype,"string"),XL.prototype),m(XL.prototype,"horizontalAlign",[IL],Object.getOwnPropertyDescriptor(XL.prototype,"horizontalAlign"),XL.prototype),m(XL.prototype,"verticalAlign",[LL],Object.getOwnPropertyDescriptor(XL.prototype,"verticalAlign"),XL.prototype),m(XL.prototype,"actualFontSize",[zL],Object.getOwnPropertyDescriptor(XL.prototype,"actualFontSize"),XL.prototype),m(XL.prototype,"fontSize",[BL],Object.getOwnPropertyDescriptor(XL.prototype,"fontSize"),XL.prototype),m(XL.prototype,"fontFamily",[PL],Object.getOwnPropertyDescriptor(XL.prototype,"fontFamily"),XL.prototype),m(XL.prototype,"lineHeight",[DL],Object.getOwnPropertyDescriptor(XL.prototype,"lineHeight"),XL.prototype),m(XL.prototype,"overflow",[FL],Object.getOwnPropertyDescriptor(XL.prototype,"overflow"),XL.prototype),m(XL.prototype,"enableWrapText",[NL],Object.getOwnPropertyDescriptor(XL.prototype,"enableWrapText"),XL.prototype),m(XL.prototype,"font",[UL],Object.getOwnPropertyDescriptor(XL.prototype,"font"),XL.prototype),m(XL.prototype,"useSystemFont",[VL],Object.getOwnPropertyDescriptor(XL.prototype,"useSystemFont"),XL.prototype),m(XL.prototype,"cacheMode",[GL],Object.getOwnPropertyDescriptor(XL.prototype,"cacheMode"),XL.prototype),m(XL.prototype,"isBold",[HL],Object.getOwnPropertyDescriptor(XL.prototype,"isBold"),XL.prototype),m(XL.prototype,"isItalic",[qL],Object.getOwnPropertyDescriptor(XL.prototype,"isItalic"),XL.prototype),m(XL.prototype,"isUnderline",[jL],Object.getOwnPropertyDescriptor(XL.prototype,"isUnderline"),XL.prototype),YL=m(XL.prototype,"_useOriginalSize",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),QL=m(XL.prototype,"_string",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"label"}}),KL=m(XL.prototype,"_horizontalAlign",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fz.CENTER}}),ZL=m(XL.prototype,"_verticalAlign",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return pz.CENTER}}),JL=m(XL.prototype,"_actualFontSize",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),$L=m(XL.prototype,"_fontSize",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),ez=m(XL.prototype,"_fontFamily",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),tz=m(XL.prototype,"_lineHeight",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),iz=m(XL.prototype,"_overflow",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return vz.NONE}}),nz=m(XL.prototype,"_enableWrapText",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),rz=m(XL.prototype,"_font",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),az=m(XL.prototype,"_isSystemFontUsed",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),sz=m(XL.prototype,"_isItalic",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),oz=m(XL.prototype,"_isBold",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lz=m(XL.prototype,"_isUnderline",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),cz=m(XL.prototype,"_cacheMode",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return yz.NONE}}),WL=XL))||WL)||WL)||WL));cc.LabelComponent=kz,(Sz=xz=xz||{})[Sz.DEFAULT=0]="DEFAULT",Sz[Sz.DONE=1]="DONE",Sz[Sz.SEND=2]="SEND",Sz[Sz.SEARCH=3]="SEARCH",Sz[Sz.GO=4]="GO",Sz[Sz.NEXT=5]="NEXT",vt(xz),(Tz=wz=wz||{})[Tz.ANY=0]="ANY",Tz[Tz.EMAIL_ADDR=1]="EMAIL_ADDR",Tz[Tz.NUMERIC=2]="NUMERIC",Tz[Tz.PHONE_NUMBER=3]="PHONE_NUMBER",Tz[Tz.URL=4]="URL",Tz[Tz.DECIMAL=5]="DECIMAL",Tz[Tz.SINGLE_LINE=6]="SINGLE_LINE",vt(wz),(Cz=Ez=Ez||{})[Cz.PASSWORD=0]="PASSWORD",Cz[Cz.SENSITIVE=1]="SENSITIVE",Cz[Cz.INITIAL_CAPS_WORD=2]="INITIAL_CAPS_WORD",Cz[Cz.INITIAL_CAPS_SENTENCE=3]="INITIAL_CAPS_SENTENCE",Cz[Cz.INITIAL_CAPS_ALL_CHARACTERS=4]="INITIAL_CAPS_ALL_CHARACTERS",Cz[Cz.DEFAULT=5]="DEFAULT",vt(Ez);var Rz=new zn,Oz=new zn,Mz=new Fi,Iz=null,Lz={zoomInvalid:!1};ul.OS_ANDROID!==ul.os||ul.browserType!==ul.BROWSER_TYPE_SOUGOU&&ul.browserType!==ul.BROWSER_TYPE_360||(Lz.zoomInvalid=!0);var zz,Bz,Pz,Dz,Fz,Nz,Uz,Vz,Gz,Hz,qz,jz,Wz,Xz,Yz,Qz,Kz,Zz,Jz,$z,eB,tB,iB,nB,rB,aB,sB,oB,lB,cB,uB,hB,fB,dB,pB,_B=ho(Az=function(){function e(){y(this,e),this._delegate=null,this._inputMode=-1,this._inputFlag=-1,this._returnType=xz.DEFAULT,this._maxLength=50,this._text="",this._placeholderText="",this._alwaysOnTop=!1,this._size=new jn,this._node=null,this._editing=!1,this.__eventListeners={},this.__fullscreen=!1,this.__autoResize=!1,this.__rotateScreen=!1,this.__orientationChanged=void 0,this._edTxt=null,this._textColor=rr.WHITE.clone(),this._edFontSize=14,this._isTextArea=!1}return l(e,[{key:"onEnable",value:function(){this._edTxt&&(this._alwaysOnTop?this._edTxt.style.display="":this._edTxt.style.display="none")}},{key:"onDisable",value:function(){this._edTxt&&(this._edTxt.style.display="none")}},{key:"setTabIndex",value:function(e){this._edTxt&&(this._edTxt.tabIndex=e)}},{key:"setFocus",value:function(){this._beginEditing()}},{key:"isFocused",value:function(){return this._edTxt?document.activeElement===this._edTxt:(B(4700),!1)}},{key:"stayOnTop",value:function(e){this._alwaysOnTop!==e&&this._edTxt&&(this._alwaysOnTop=e,this._edTxt.style.display=e?"":"none")}},{key:"setMaxLength",value:function(e){isNaN(e)||(e<0&&(e=65535),this._maxLength=e,this._edTxt&&(this._edTxt.maxLength=e))}},{key:"setString",value:function(e){this._text=e,this._edTxt&&(this._edTxt.value=e)}},{key:"getString",value:function(){return this._text}},{key:"setPlaceholderText",value:function(e){this._placeholderText=e}},{key:"getPlaceholderText",value:function(){return this._placeholderText}},{key:"setDelegate",value:function(e){this._delegate=e}},{key:"setInputMode",value:function(e){this._inputMode!==e&&(this._inputMode=e,this.createInput(),this._updateDomInputType(),this._updateSize(this._size.width,this._size.height))}},{key:"setInputFlag",value:function(e){if(this._inputFlag!==e){this._inputFlag=e,this._updateDomInputType();var t="none";e===Ez.INITIAL_CAPS_ALL_CHARACTERS?t="uppercase":e===Ez.INITIAL_CAPS_WORD&&(t="capitalize"),this._edTxt&&(this._edTxt.style.textTransform=t,this._edTxt.value=this._text)}}},{key:"setReturnType",value:function(e){this._returnType=e,this._updateDomInputType()}},{key:"setFontSize",value:function(e){this._edFontSize=e||this._edFontSize,this._edTxt&&(this._edTxt.style.fontSize=this._edFontSize+"px")}},{key:"setFontColor",value:function(e){this._textColor=e,this._edTxt&&(this._edTxt.style.color=e.toCSS("rgba"))}},{key:"setSize",value:function(e,t){this._size.width=e,this._size.height=t,this._updateSize(e,t)}},{key:"setNode",value:function(e){this._node=e}},{key:"update",value:function(){this._updateMatrix()}},{key:"clear",value:function(){this._node=null,this.setDelegate(null),this.removeDom()}},{key:"_onTouchBegan",value:function(e){}},{key:"_onTouchEnded",value:function(){this._beginEditing()}},{key:"_beginEditing",value:function(){ul.isMobile&&!this._editing&&this._beginEditingOnMobile();var e=this;function t(){e._edTxt&&e._edTxt.focus()}this._edTxt&&(this._edTxt.style.display="",ul.browserType===ul.BROWSER_TYPE_UC?setTimeout(t,400):ul.browserType===ul.BROWSER_TYPE_FIREFOX?setTimeout(t,0):t()),this._editing=!0}},{key:"_endEditing",value:function(){function e(){!t._alwaysOnTop&&t._edTxt&&(t._edTxt.style.display="none"),t._delegate&&t._delegate.editBoxEditingDidEnded&&t._delegate.editBoxEditingDidEnded()}var t=this;this._editing&&(ul.isMobile?setTimeout(function(){t._endEditingOnMobile(),e()},400):e()),this._editing=!1}},{key:"_updateDomInputType",value:function(){var e=this._inputMode,t=this._edTxt;if(t){if(this._isTextArea){t=t;var i="none";return this._inputFlag===Ez.INITIAL_CAPS_ALL_CHARACTERS?i="uppercase":this._inputFlag===Ez.INITIAL_CAPS_WORD&&(i="capitalize"),void(t.style.textTransform=i)}if(t=t,this._inputFlag!==Ez.PASSWORD){var n=t.type;e===wz.EMAIL_ADDR?n="email":e===wz.NUMERIC||e===wz.DECIMAL?n="number":e===wz.PHONE_NUMBER?(n="number",t.pattern="[0-9]*"):e===wz.URL?n="url":(n="text",this._returnType===xz.SEARCH&&(n="search")),t.type=n}else t.type="password"}}},{key:"_updateSize",value:function(e,t){var i=this._edTxt;i&&(i.style.width=e+"px",i.style.height=t+"px")}},{key:"_updateMatrix",value:function(){if(this._edTxt){var e=this._node,t=nx.getScaleX(),i=nx.getScaleY(),n=nx.getViewportRect(),r=nx.getDevicePixelRatio();e.getWorldMatrix(Rz);var a=e.uiTransfromComp;a&&Fi.set(Mz,-a.anchorX*a.width,-a.anchorY*a.height,Mz.z),zn.transform(Rz,Rz,Mz);var s=e.getComponent(GC);if(!s)return!1;var o=Yb.root.ui.getScreen(s.visibility);if(o){o.node.getWorldRT(Oz);var l=Oz.m12,c=Oz.m13,u=gl.center;Oz.m12=u.x-(Oz.m00*l+Oz.m04*c),Oz.m13=u.y-(Oz.m01*l+Oz.m05*c),zn.multiply(Oz,Oz,Rz),t/=r,i/=r;var h=Gp.container,f=Oz.m00*t,d=Rz.m01,p=Rz.m04,_=Oz.m05*i,v=parseInt(h&&h.style.paddingLeft||"0");v+=n.x/r;var m=parseInt(h&&h.style.paddingBottom||"0");m+=n.y/r;var y=Oz.m12*t+v,g=Oz.m13*i+m;Lz.zoomInvalid&&(this._updateSize(this._size.width*f,this._size.height*_),_=f=1);var b="matrix("+f+","+-d+","+-p+","+_+","+y+","+-g+")";this._edTxt.style.transform=b,this._edTxt.style["-webkit-transform"]=b,this._edTxt.style["transform-origin"]="0px 100% 0px",this._edTxt.style["-webkit-transform-origin"]="0px 100% 0px"}}}},{key:"_adjustEditBoxPosition",value:function(){this._node.getWorldMatrix(Rz);var t=Rz.m13,i=gl.height,e=gl.width,n=.5;i<e&&(n=.7),setTimeout(function(){if(window.scrollY<40&&t<i*n){var e=i*n-t-window.scrollY;e<35&&(e=35),320<e&&(e=320),window.scrollTo(0,e)}},400)}},{key:"createInput",value:function(){this._isTextArea=!1,this._inputMode===wz.ANY?(this._isTextArea=!0,this._createDomTextArea()):this._createDomInput()}},{key:"_beginEditingOnMobile",value:function(){var e=this;this.__orientationChanged=function(){e._adjustEditBoxPosition()},window.addEventListener("orientationchange",this.__orientationChanged),nx.isAutoFullScreenEnabled()?(this.__fullscreen=!0,nx.enableAutoFullScreen(!1),rx.exitFullScreen()):this.__fullscreen=!1,this.__autoResize=nx._resizeWithBrowserSize,nx.resizeWithBrowserSize(!1),Iz=this}},{key:"_endEditingOnMobile",value:function(){if(this.__rotateScreen){Gp.container&&(Gp.container.style["-webkit-transform"]="rotate(90deg)",Gp.container.style.transform="rotate(90deg)");var e=nx._originalDesignResolutionSize.width,t=nx._originalDesignResolutionSize.height;0<e&&nx.setDesignResolutionSize(e,t,nx.getResolutionPolicy()),this.__rotateScreen=!1}this.__orientationChanged&&window.removeEventListener("orientationchange",this.__orientationChanged),this.__fullscreen&&nx.enableAutoFullScreen(!0),this.__autoResize&&Iz===this&&nx.resizeWithBrowserSize(!0)}},{key:"_createDomInput",value:function(){this.removeDom();var e=this._edTxt=document.createElement("input");return e.type="text",e.style.fontSize=this._edFontSize+"px",e.style.color="#000000",e.style.border="0px",e.style.background="transparent",e.style.width="100%",e.style.height="100%",e.style.outline="medium",e.style.padding="0",e.style.textTransform="uppercase",e.style.display="none",e.style.position="absolute",e.style.bottom="0px",e.style.left="2px",e.style["-moz-appearance"]="textfield",e.className="cocosEditBox",e.style.fontFamily="Arial",mB(e,this),e}},{key:"_createDomTextArea",value:function(){this.removeDom();var e=this._edTxt=document.createElement("textarea");return e.style.fontSize=this._edFontSize+"px",e.style.color="#000000",e.style.border="0",e.style.background="transparent",e.style.width="100%",e.style.height="100%",e.style.outline="medium",e.style.padding="0",e.style.resize="none",e.style.textTransform="uppercase",e.style.overflowY="scroll",e.style.display="none",e.style.position="absolute",e.style.bottom="0px",e.style.left="2px",e.className="cocosEditBox",e.style.fontFamily="Arial",mB(e,this,!0),e}},{key:"_addDomToGameContainer",value:function(){Gp.container&&this._edTxt&&Gp.container.appendChild(this._edTxt)}},{key:"removeDom",value:function(){var e=this._edTxt;if(e){var t=this.__eventListeners;e.removeEventListener("compositionstart",t.compositionstart),e.removeEventListener("compositionend",t.compositionend),e.removeEventListener("input",t.input),e.removeEventListener("focus",t.focus),e.removeEventListener("keypress",t.keypress),e.removeEventListener("blur",t.blur),t.compositionstart=null,t.compositionend=null,t.input=null,t.focus=null,t.keypress=null,t.blur=null,ct(Gp.container,e)&&Gp.container&&Gp.container.removeChild(e)}this._edTxt=null}},{key:"text",get:function(){return this._text},set:function(e){this._text=e}},{key:"textColor",get:function(){return this._textColor}},{key:"fontSize",get:function(){return this._edFontSize}},{key:"returnType",set:function(e){this._returnType=e}},{key:"alwayOnTop",get:function(){return this._alwaysOnTop}},{key:"editing",get:function(){return this._editing},set:function(e){this._editing=e}},{key:"delegate",get:function(){return this._delegate}},{key:"eventListeners",get:function(){return this.__eventListeners}}]),e}())||Az;function vB(e,t){e.value.length>t._maxLength&&(e.value=e.value.slice(0,t._maxLength)),t._delegate&&t._delegate.editBoxTextChanged&&t._text!==e.value&&(t._text=e.value,t._delegate.editBoxTextChanged(t._text))}function mB(e,t,i){var n=2<arguments.length&&void 0!==i&&i,r=!1,a=t.eventListeners;a.compositionstart=function(){r=!0},e.addEventListener("compositionstart",a.compositionstart),a.compositionend=function(){r=!1,vB(this,t)},e.addEventListener("compositionend",a.compositionend),a.input=function(){r||vB(this,t)},e.addEventListener("input",a.input),a.focus=function(){this.style.fontSize=t.fontSize+"px",this.style.color=t.textColor.toCSS("rgba"),t.alwayOnTop&&(t.editing=!0),ul.isMobile&&t._beginEditingOnMobile(),t.delegate&&t.delegate.editBoxEditingDidBegan&&t.delegate.editBoxEditingDidBegan()},e.addEventListener("focus",a.focus),a.keypress=function(e){e.keyCode===yl.KEY.enter&&(e.propagationStopped=!0,t.delegate&&t.delegate.editBoxEditingReturn&&t.delegate.editBoxEditingReturn(),n||(t.text=this.value,t._endEditing(),Gp.canvas&&Gp.canvas.focus()))},e.addEventListener("keypress",a.keypress),a.blur=function(){t.text=this.value,t._endEditing()},e.addEventListener("blur",a.blur),t._addDomToGameContainer()}var yB,gB,bB,xB,SB,wB,TB,EB,CB,AB,kB,RB,OB,MB,IB,LB,zB,BB,PB,DB,FB,NB,UB,VB,GB,HB,qB=P2("EditBoxComponent",(zz=ho("cc.EditBoxComponent"),Bz=go(100),Pz=yo("UI/EditBox"),Dz=fo({type:Eh}),Fz=fo({type:xz}),Nz=fo({type:Ez}),Uz=fo({type:wz}),Vz=fo({type:rr}),Gz=fo({type:kT}),Hz=fo({type:kT}),qz=fo({type:kT}),jz=fo({type:kT}),zz(Wz=Bz(Wz=Pz(Wz=vo((pB=dB=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"editingDidBegan",Yz,u(t)),v(t,"textChanged",Qz,u(t)),v(t,"editingDidEnded",Kz,u(t)),v(t,"editingReturn",Zz,u(t)),t._impl=null,t._textLabel=null,t._placeholderLabel=null,t._background=null,v(t,"_returnType",Jz,u(t)),v(t,"_useOriginalSize",$z,u(t)),v(t,"_string",eB,u(t)),v(t,"_tabIndex",tB,u(t)),v(t,"_backgroundImage",iB,u(t)),v(t,"_inputFlag",nB,u(t)),v(t,"_inputMode",rB,u(t)),v(t,"_fontSize",aB,u(t)),v(t,"_lineHeight",sB,u(t)),v(t,"_maxLength",oB,u(t)),v(t,"_fontColor",lB,u(t)),v(t,"_placeholder",cB,u(t)),v(t,"_placeholderFontSize",uB,u(t)),v(t,"_placeholderFontColor",hB,u(t)),v(t,"_stayOnTop",fB,u(t)),t}return p(a,Bv),l(a,[{key:"onEnable",value:function(){this._impl&&this._impl.onEnable()}},{key:"onDisable",value:function(){this._impl&&this._impl.onDisable()}},{key:"onDestroy",value:function(){this._impl&&this._impl.clear()}},{key:"_init",value:function(){this._createBackgroundSprite(),this._createLabels(),this.node.on(U_.SIZE_CHANGED,this._resizeChildNodes,this);var e=this._impl=new _B;e.setDelegate(this),e.setNode(this.node),e.setInputMode(this._inputMode),e.setMaxLength(this._maxLength),e.setInputFlag(this._inputFlag),e.setReturnType(this._returnType),e.setTabIndex(this._tabIndex),e.setFontColor(this._fontColor),e.setFontSize(this._fontSize),e.setPlaceholderText(this._placeholder),this._updateStayOnTop(),this._updateString(this._string),this._syncSize()}},{key:"__preload",value:function(){this._registerEvent(),this._init()}},{key:"_registerEvent",value:function(){this.node.on(U_.TOUCH_START,this._onTouchBegan,this),this.node.on(U_.TOUCH_END,this._onTouchEnded,this)}},{key:"_updateStayOnTop",value:function(){this.stayOnTop?this._hideLabels():this._showLabels(),this._impl&&this._impl.stayOnTop(this.stayOnTop)}},{key:"_syncSize",value:function(){var e=this.node.getContentSize();this._background&&(this._background.node.setAnchorPoint(this.node.getAnchorPoint()),this._background.node.setContentSize(e)),this._updateLabelPosition(e),this._impl&&this._impl.setSize(e.width,e.height)}},{key:"_updateLabelPosition",value:function(e){var t=this.node,i=-t.anchorX*t.width,n=-t.anchorY*t.height,r=this._placeholderLabel,a=this._textLabel;a&&(a.node.setContentSize(e.width-2,e.height),a.node.setPosition(2+i,n+e.height,a.node.getPosition().z),a.verticalAlign=this._inputMode===wz.ANY?pz.TOP:pz.CENTER,a.enableWrapText=this._inputMode===wz.ANY),r&&(r.node.setContentSize(e.width-2,e.height),r.lineHeight=e.height,r.node.setPosition(2+i,n+e.height,r.node.getPosition().z),r.verticalAlign=this._inputMode===wz.ANY?pz.TOP:pz.CENTER,r.enableWrapText=this._inputMode===wz.ANY)}},{key:"_createBackgroundSprite",value:function(){this._background||(this._background=this.node.getComponent(CL),this._background||(this._background=this.node.addComponent(CL))),this._background.type=CL.Type.SLICED,this._background.spriteFrame=this._backgroundImage}},{key:"_createLabels",value:function(){if(!this._textLabel){var e=this.node.getChildByName("TEXT_LABEL"),t=(e=e||new Sm("TEXT_LABEL")).getComponent(kz);e.parent=this.node,t=t||e.addComponent(kz),e.getComponent(SE).setAnchorPoint(0,1),t.color=this._fontColor,t.overflow=kz.Overflow.CLAMP,t.fontSize=this._fontSize,t.lineHeight=this.lineHeight,this._textLabel=t}if(!this._placeholderLabel){var i=this.node.getChildByName("PLACEHOLDER_LABEL"),n=(i=i||new Sm("PLACEHOLDER_LABEL")).getComponent(kz);n=n||i.addComponent(kz);var r=i.getComponent(SE);i.parent=this.node,n.color=this._placeholderFontColor,r.setAnchorPoint(0,1),n.overflow=kz.Overflow.CLAMP,n.fontSize=this._placeholderFontSize,n.string=this._placeholder,this._placeholderLabel=n}}},{key:"_resizeChildNodes",value:function(){var e=this._textLabel&&this._textLabel.node;e&&(e.setPosition(-this.node.width/2,this.node.height/2,e.getPosition().z),e.width=this.node.width,e.height=this.node.height);var t=this._placeholderLabel&&this._placeholderLabel.node;t&&(t.setPosition(-this.node.width/2,this.node.height/2,t.getPosition().z),t.width=this.node.width,t.height=this.node.height);var i=this._background&&this._background.node;i&&(i.width=this.node.width,i.height=this.node.height)}},{key:"_showLabels",value:function(){if(this._textLabel){var e=this._textLabel.string;this._textLabel.node.active=""!==e,this._placeholderLabel&&(this._placeholderLabel.node.active=""===e)}}},{key:"_hideLabels",value:function(){this._textLabel&&(this._textLabel.node.active=!1),this._placeholderLabel&&(this._placeholderLabel.node.active=!1)}},{key:"_updateString",value:function(e){var t=this._textLabel;if(t){var i=e;i=i&&this._updateLabelStringStyle(i),t.string=i,this._impl&&(this._impl.setString(e),this._impl.editing||this.stayOnTop||this._showLabels())}}},{key:"_updateLabelStringStyle",value:function(e,t){var i=1<arguments.length&&void 0!==t&&t,n=this._inputFlag;if(i||n!==Ez.PASSWORD)n===Ez.INITIAL_CAPS_ALL_CHARACTERS?e=e.toUpperCase():n===Ez.INITIAL_CAPS_WORD?e=function(e){return e.replace(/(?:^|\s)\S/g,function(e){return e.toUpperCase()})}(e):n===Ez.INITIAL_CAPS_SENTENCE&&(e=function(e){return e.charAt(0).toUpperCase()+e.slice(1)}(e));else{for(var r="",a=e.length,s=0;s<a;++s)r+="●";e=r}return e}},{key:"editBoxEditingDidBegan",value:function(){this._hideLabels(),kT.emitEvents(this.editingDidBegan,this),this.node.emit("editing-did-began",this)}},{key:"editBoxEditingDidEnded",value:function(){this.stayOnTop||this._showLabels(),kT.emitEvents(this.editingDidEnded,this),this.node.emit("editing-did-ended",this)}},{key:"editBoxTextChanged",value:function(e){e=this._updateLabelStringStyle(e,!0),this.string=e,kT.emitEvents(this.textChanged,e,this),this.node.emit("text-changed",this)}},{key:"editBoxEditingReturn",value:function(){kT.emitEvents(this.editingReturn,this),this.node.emit("editing-return",this)}},{key:"_onTouchBegan",value:function(e){this._impl&&this._impl._onTouchBegan(e.touch),e.propagationStopped=!0}},{key:"_onTouchEnded",value:function(e){this._impl&&this._impl._onTouchEnded(),e.propagationStopped=!0}},{key:"setFocus",value:function(){this._impl&&this._impl.setFocus()}},{key:"isFocused",value:function(){var e=!1;return this._impl&&(e=this._impl.isFocused()),e}},{key:"update",value:function(){this._impl&&this._impl.update()}},{key:"string",get:function(){return this._string},set:function(e){0<=this._maxLength&&e.length>=this._maxLength&&(e=e.slice(0,this._maxLength)),this._string=e,this._impl&&this._updateString(e)}},{key:"backgroundImage",get:function(){return this._backgroundImage},set:function(e){this._backgroundImage!==e&&(this._backgroundImage=e,this._createBackgroundSprite())}},{key:"returnType",get:function(){return this._returnType},set:function(e){this._returnType=e,this._impl&&(this._impl.returnType=this._returnType)}},{key:"inputFlag",get:function(){return this._inputFlag},set:function(e){this._inputFlag=e,this._impl&&(this._impl.setInputFlag(this._inputFlag),this._updateString(this._string))}},{key:"inputMode",get:function(){return this._inputMode},set:function(e){this._inputMode=e,this._impl&&this._impl.setInputMode(this._inputMode)}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this._textLabel&&(this._textLabel.fontSize=this._fontSize),this._impl&&this._impl.setFontSize(this._fontSize))}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this._textLabel&&(this._textLabel.lineHeight=this._lineHeight))}},{key:"fontColor",get:function(){return this._fontColor},set:function(e){if(this._fontColor!==e){if(this._fontColor.set(e),this._textLabel){var t=this._textLabel.node.getComponent(GC);t&&(t.color=this._fontColor)}this._impl&&this._impl.setFontColor(this._fontColor)}}},{key:"placeholder",get:function(){return this._placeholder},set:function(e){this._placeholder!==e&&(this._placeholder=e,this._placeholderLabel&&(this._placeholderLabel.string=this._placeholder),this._impl&&this._impl.setPlaceholderText(this._placeholder))}},{key:"placeholderFontSize",get:function(){return this._placeholderFontSize},set:function(e){this._placeholderFontSize!==e&&(this._placeholderFontSize=e,this._placeholderLabel&&(this._placeholderLabel.fontSize=this._placeholderFontSize))}},{key:"placeholderFontColor",get:function(){return this._placeholderFontColor},set:function(e){if(this._placeholderFontColor!==e&&(this._placeholderFontColor=e,this._placeholderLabel)){var t=this._placeholderLabel.node.getComponent(GC);t&&(t.color=this._placeholderFontColor)}}},{key:"maxLength",get:function(){return this._maxLength},set:function(e){this._maxLength!==e&&(this._maxLength=e,this._impl&&this._impl.setMaxLength(this._maxLength))}},{key:"stayOnTop",get:function(){return this._stayOnTop},set:function(e){this._stayOnTop=e,this._impl&&this._updateStayOnTop()}},{key:"tabIndex",get:function(){return this._tabIndex},set:function(e){this._tabIndex=e,this._impl&&this._impl.setTabIndex(e)}}]),a}(),dB._EditBoxImpl=_B,dB.KeyboardReturnType=xz,dB.InputFlag=Ez,dB.InputMode=wz,m((Xz=pB).prototype,"string",[fo],Object.getOwnPropertyDescriptor(Xz.prototype,"string"),Xz.prototype),m(Xz.prototype,"backgroundImage",[Dz],Object.getOwnPropertyDescriptor(Xz.prototype,"backgroundImage"),Xz.prototype),m(Xz.prototype,"returnType",[Fz],Object.getOwnPropertyDescriptor(Xz.prototype,"returnType"),Xz.prototype),m(Xz.prototype,"inputFlag",[Nz],Object.getOwnPropertyDescriptor(Xz.prototype,"inputFlag"),Xz.prototype),m(Xz.prototype,"inputMode",[Uz],Object.getOwnPropertyDescriptor(Xz.prototype,"inputMode"),Xz.prototype),m(Xz.prototype,"fontSize",[fo],Object.getOwnPropertyDescriptor(Xz.prototype,"fontSize"),Xz.prototype),m(Xz.prototype,"lineHeight",[fo],Object.getOwnPropertyDescriptor(Xz.prototype,"lineHeight"),Xz.prototype),m(Xz.prototype,"fontColor",[Vz],Object.getOwnPropertyDescriptor(Xz.prototype,"fontColor"),Xz.prototype),m(Xz.prototype,"placeholder",[fo],Object.getOwnPropertyDescriptor(Xz.prototype,"placeholder"),Xz.prototype),m(Xz.prototype,"placeholderFontSize",[fo],Object.getOwnPropertyDescriptor(Xz.prototype,"placeholderFontSize"),Xz.prototype),m(Xz.prototype,"placeholderFontColor",[fo],Object.getOwnPropertyDescriptor(Xz.prototype,"placeholderFontColor"),Xz.prototype),m(Xz.prototype,"maxLength",[fo],Object.getOwnPropertyDescriptor(Xz.prototype,"maxLength"),Xz.prototype),m(Xz.prototype,"stayOnTop",[fo],Object.getOwnPropertyDescriptor(Xz.prototype,"stayOnTop"),Xz.prototype),m(Xz.prototype,"tabIndex",[fo],Object.getOwnPropertyDescriptor(Xz.prototype,"tabIndex"),Xz.prototype),Yz=m(Xz.prototype,"editingDidBegan",[Gz],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Qz=m(Xz.prototype,"textChanged",[Hz],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Kz=m(Xz.prototype,"editingDidEnded",[qz],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Zz=m(Xz.prototype,"editingReturn",[jz],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Jz=m(Xz.prototype,"_returnType",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xz.DEFAULT}}),$z=m(Xz.prototype,"_useOriginalSize",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),eB=m(Xz.prototype,"_string",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),tB=m(Xz.prototype,"_tabIndex",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),iB=m(Xz.prototype,"_backgroundImage",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),nB=m(Xz.prototype,"_inputFlag",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ez.DEFAULT}}),rB=m(Xz.prototype,"_inputMode",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wz.ANY}}),aB=m(Xz.prototype,"_fontSize",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),sB=m(Xz.prototype,"_lineHeight",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),oB=m(Xz.prototype,"_maxLength",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),lB=m(Xz.prototype,"_fontColor",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rr.WHITE.clone()}}),cB=m(Xz.prototype,"_placeholder",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Enter text here..."}}),uB=m(Xz.prototype,"_placeholderFontSize",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),hB=m(Xz.prototype,"_placeholderFontColor",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rr.GRAY.clone()}}),fB=m(Xz.prototype,"_stayOnTop",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Wz=Xz))||Wz)||Wz)||Wz)||Wz));cc.EditBoxComponent=qB;var jB,WB,XB,YB,QB,KB,ZB,JB,$B,eP,tP=U_;(WB=jB=jB||{})[WB.NONE=0]="NONE",WB[WB.HORIZONTAL=1]="HORIZONTAL",WB[WB.VERTICAL=2]="VERTICAL",WB[WB.GRID=3]="GRID",mt(jB),(YB=XB=XB||{})[YB.NONE=0]="NONE",YB[YB.CONTAINER=1]="CONTAINER",YB[YB.CHILDREN=2]="CHILDREN",mt(XB),(KB=QB=QB||{})[KB.HORIZONTAL=0]="HORIZONTAL",KB[KB.VERTICAL=1]="VERTICAL",mt(QB),(JB=ZB=ZB||{})[JB.BOTTOM_TO_TOP=0]="BOTTOM_TO_TOP",JB[JB.TOP_TO_BOTTOM=1]="TOP_TO_BOTTOM",mt(ZB),(eP=$B=$B||{})[eP.LEFT_TO_RIGHT=0]="LEFT_TO_RIGHT",eP[eP.RIGHT_TO_LEFT=1]="RIGHT_TO_LEFT",mt($B);var iP,nP,rP,aP,sP,oP,lP,cP,uP,hP,fP,dP,pP,_P,vP,mP,yP,gP,bP,xP,SP,wP,TP=new Fi,EP=new Fi,CP=P2("LayoutComponent",(yB=ho("cc.LayoutComponent"),gB=go(110),bB=yo("UI/Layout"),xB=fo({type:jB}),SB=fo({type:XB}),wB=fo({type:QB}),TB=fo({type:ZB}),EB=fo({type:$B}),yB(CB=gB(CB=bB(CB=vo((HB=GB=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))))._layoutDirty=!0,v(t,"_resizeMode",kB,u(t)),v(t,"_N$layoutType",RB,u(t)),v(t,"_N$padding",OB,u(t)),v(t,"_cellSize",MB,u(t)),v(t,"_startAxis",IB,u(t)),v(t,"_paddingLeft",LB,u(t)),v(t,"_paddingRight",zB,u(t)),v(t,"_paddingTop",BB,u(t)),v(t,"_paddingBottom",PB,u(t)),v(t,"_spacingX",DB,u(t)),v(t,"_spacingY",FB,u(t)),t._layoutSize=new jn(300,200),v(t,"_verticalDirection",NB,u(t)),v(t,"_horizontalDirection",UB,u(t)),v(t,"_affectedByScale",VB,u(t)),t}return p(a,Bv),l(a,[{key:"updateLayout",value:function(){this._layoutDirty&&0<this.node.children.length&&(this._doLayout(),this._layoutDirty=!1)}},{key:"onEnable",value:function(){this._addEventListeners(),this.node.getContentSize().equals(new jn)&&this.node.setContentSize(this._layoutSize),0!==this._N$padding&&this._migratePaddingData(),this._doLayoutDirty()}},{key:"onDisable",value:function(){this._removeEventListeners()}},{key:"_migratePaddingData",value:function(){this._paddingLeft=this._N$padding,this._paddingRight=this._N$padding,this._paddingTop=this._N$padding,this._paddingBottom=this._N$padding,this._N$padding=0}},{key:"_addEventListeners",value:function(){Yb.on(Xb.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.on(tP.SIZE_CHANGED,this._resized,this),this.node.on(tP.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.on(tP.CHILD_ADDED,this._childAdded,this),this.node.on(tP.CHILD_REMOVED,this._childRemoved,this),this._addChildrenEventListeners()}},{key:"_removeEventListeners",value:function(){Yb.off(Xb.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.off(tP.SIZE_CHANGED,this._resized,this),this.node.off(tP.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.off(tP.CHILD_ADDED,this._childAdded,this),this.node.off(tP.CHILD_REMOVED,this._childRemoved,this),this._removeChildrenEventListeners()}},{key:"_addChildrenEventListeners",value:function(){var e=this.node.children,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;r.on(tP.SCALE_PART,this._doScaleDirty,this),r.on(tP.SIZE_CHANGED,this._doLayoutDirty,this),r.on(tP.TRANSFORM_CHANGED,this._transformDirty,this),r.on(tP.ANCHOR_CHANGED,this._doLayoutDirty,this),r.on("active-in-hierarchy-changed",this._doLayoutDirty,this)}}},{key:"_removeChildrenEventListeners",value:function(){var e=this.node.children,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;r.off(tP.SCALE_PART,this._doScaleDirty,this),r.off(tP.SIZE_CHANGED,this._doLayoutDirty,this),r.off(tP.TRANSFORM_CHANGED,this._transformDirty,this),r.off(tP.ANCHOR_CHANGED,this._doLayoutDirty,this),r.off("active-in-hierarchy-changed",this._doLayoutDirty,this)}}},{key:"_childAdded",value:function(e){e.on(tP.SCALE_PART,this._doScaleDirty,this),e.on(tP.SIZE_CHANGED,this._doLayoutDirty,this),e.on(tP.TRANSFORM_CHANGED,this._transformDirty,this),e.on(tP.ANCHOR_CHANGED,this._doLayoutDirty,this),e.on("active-in-hierarchy-changed",this._doLayoutDirty,this),this._doLayoutDirty()}},{key:"_childRemoved",value:function(e){e.off(tP.SCALE_PART,this._doScaleDirty,this),e.off(tP.SIZE_CHANGED,this._doLayoutDirty,this),e.off(tP.TRANSFORM_CHANGED,this._transformDirty,this),e.off(tP.ANCHOR_CHANGED,this._doLayoutDirty,this),e.off("active-in-hierarchy-changed",this._doLayoutDirty,this),this._doLayoutDirty()}},{key:"_resized",value:function(){this._layoutSize=this.node.getContentSize(),this._doLayoutDirty()}},{key:"_doLayoutHorizontally",value:function(e,t,i,n){var r=this.node.getAnchorPoint(),a=this.node.children,s=1,o=this._paddingLeft,l=-r.x*e;this._horizontalDirection===$B.RIGHT_TO_LEFT&&(s=-1,l=(1-r.x)*e,o=this._paddingRight);var c=l+s*o-s*this._spacingX,u=0,h=0,f=0,d=0,p=0,_=0,v=0,m=a,y=Array.isArray(m),g=0;for(m=y?m:m[Symbol.iterator]();;){var b;if(y){if(g>=m.length)break;b=m[g++]}else{if((g=m.next()).done)break;b=g.value}b.activeInHierarchy&&v++}var x=this._cellSize.width;this._N$layoutType!==jB.GRID&&this._resizeMode===XB.CHILDREN&&(x=(e-(this._paddingLeft+this._paddingRight)-(v-1)*this._spacingX)/v);var S=a,w=Array.isArray(S),T=0;for(S=w?S:S[Symbol.iterator]();;){var E;if(w){if(T>=S.length)break;E=S[T++]}else{if((T=S.next()).done)break;E=T.value}var C=E;if(C.activeInHierarchy){C.getScale(EP);var A=this._getUsedScaleValue(EP.x),k=this._getUsedScaleValue(EP.y);this._resizeMode===XB.CHILDREN&&(C.width=x/A,this._N$layoutType===jB.GRID&&(C.height=this._cellSize.height/k));var R=C.anchorX,O=C.width*A,M=C.height*k;h<f&&(h=f),h<=M&&(f=h,h=M,_=C.getAnchorPoint().y),this._horizontalDirection===$B.RIGHT_TO_LEFT&&(R=1-C.anchorX),c=c+s*R*O+s*this._spacingX;var I=s*(1-R)*O;if(t){var L=c+I+s*(0<s?this._paddingRight:this._paddingLeft),z=!1;this._horizontalDirection===$B.LEFT_TO_RIGHT&&L>(1-r.x)*e&&(z=!0);var B=!1;this._horizontalDirection===$B.RIGHT_TO_LEFT&&L<-r.x*e&&(B=!0),(z||B)&&(h<=M?(0===f&&(f=h),u+=f,f=h):(u+=h,f=M,h=0),c=l+s*(o+R*O),d++)}var P=i(C,u,d);e>=O+this._paddingLeft+this._paddingRight&&n&&(C.getPosition(TP),C.setPosition(c,P,TP.z));var D=1,F=void 0,N=0===h?M:h;this._verticalDirection===ZB.TOP_TO_BOTTOM?(p=p||this.node.getContentSize().height,(F=P+(D=-1)*(N*_+this._paddingBottom))<p&&(p=F)):(p=p||-this.node.getContentSize().height)<(F=P+D*(N*_+this._paddingTop))&&(p=F),c+=I}}return p}},{key:"_doLayoutVertically",value:function(e,t,i,n){var r=this.node.getAnchorPoint(),a=this.node.children,s=1,o=this._paddingBottom,l=-r.y*e;this._verticalDirection===ZB.TOP_TO_BOTTOM&&(s=-1,l=(1-r.y)*e,o=this._paddingTop);var c=l+s*o-s*this._spacingY,u=0,h=0,f=0,d=0,p=0,_=0,v=0,m=a,y=Array.isArray(m),g=0;for(m=y?m:m[Symbol.iterator]();;){var b;if(y){if(g>=m.length)break;b=m[g++]}else{if((g=m.next()).done)break;b=g.value}b.activeInHierarchy&&v++}var x=this._cellSize.height;this._N$layoutType!==jB.GRID&&this._resizeMode===XB.CHILDREN&&(x=(e-(this._paddingTop+this._paddingBottom)-(v-1)*this._spacingY)/v);var S=a,w=Array.isArray(S),T=0;for(S=w?S:S[Symbol.iterator]();;){var E;if(w){if(T>=S.length)break;E=S[T++]}else{if((T=S.next()).done)break;E=T.value}var C=E;if(C){var A=C.getScale(),k=this._getUsedScaleValue(A.x),R=this._getUsedScaleValue(A.y);if(C.activeInHierarchy){this._resizeMode===XB.CHILDREN&&(C.height=x/R,this._N$layoutType===jB.GRID&&(C.width=this._cellSize.width/k));var O=C.anchorY,M=C.width*k,I=C.height*R;h<f&&(h=f),h<=M&&(f=h,h=M,_=C.getAnchorPoint().x),this._verticalDirection===ZB.TOP_TO_BOTTOM&&(O=1-C.anchorY),c=c+s*O*I+s*this._spacingY;var L=s*(1-O)*I;if(t){var z=c+L+s*(0<s?this._paddingTop:this._paddingBottom),B=!1;this._verticalDirection===ZB.BOTTOM_TO_TOP&&z>(1-r.y)*e&&(B=!0);var P=!1;this._verticalDirection===ZB.TOP_TO_BOTTOM&&z<-r.y*e&&(P=!0),(B||P)&&(h<=M?(0===f&&(f=h),u+=f,f=h):(u+=h,f=M,h=0),c=l+s*(o+O*I),d++)}var D=i(C,u,d);e>=I+(this._paddingTop+this._paddingBottom)&&n&&(C.getPosition(TP),C.setPosition(D,c,TP.z));var F=1,N=void 0,U=0===h?M:h;this._horizontalDirection===$B.RIGHT_TO_LEFT?(F=-1,p=p||this.node.getContentSize().width,(N=D+F*(U*_+this._paddingLeft))<p&&(p=N)):(p=p||-this.node.getContentSize().width)<(N=D+F*(U*_+this._paddingRight))&&(p=N),c+=L}}}return p}},{key:"_doLayoutBasic",value:function(){var e=null,t=this.node.children,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r,s=a.getComponent(SE);s&&a.activeInHierarchy&&(e?Zn.union(e,e,s.getBoundingBoxToWorld()):e=s.getBoundingBoxToWorld())}if(e){var o=this.node.parent.getComponent(SE);if(!o)return;Fi.set(TP,e.x,e.y,0);var l=new Fi;o.convertToNodeSpaceAR(TP,l),Fi.set(l,l.x-this._paddingLeft,l.y-this._paddingBottom,l.z),Fi.set(TP,e.x+e.width,e.y+e.height,0);var c=new Fi;o.convertToNodeSpaceAR(TP,c),Fi.set(c,c.x+this._paddingRight,c.y+this._paddingTop,c.z);var u=cc.size(parseFloat((c.x-l.x).toFixed(2)),parseFloat((c.y-l.y).toFixed(2)));if(this.node.getPosition(TP),0!==u.width){var h=(TP.x-l.x)/u.width;this.node.anchorX=parseFloat(h.toFixed(2))}if(0!==u.height){var f=(TP.y-l.y)/u.height;this.node.anchorY=parseFloat(f.toFixed(2))}this.node.setContentSize(u)}}},{key:"_doLayoutGridAxisHorizontal",value:function(e,t){var n=this,i=t.width,r=1,a=-e.y*t.height,s=this._paddingBottom;this._verticalDirection===ZB.TOP_TO_BOTTOM&&(r=-1,a=(1-e.y)*t.height,s=this._paddingTop);function o(e,t,i){return a+r*(t+e.anchorY*e.height*l._getUsedScaleValue(e.getScale().y)+s+i*n._spacingY)}var l=this,c=0;if(this._resizeMode===XB.CONTAINER){var u=this._doLayoutHorizontally(i,!0,o,!1);(c=a-u)<0&&(c*=-1),a=-e.y*c,this._verticalDirection===ZB.TOP_TO_BOTTOM&&(r=-1,a=(1-e.y)*c)}this._doLayoutHorizontally(i,!0,o,!0),this._resizeMode===XB.CONTAINER&&this.node.setContentSize(i,c)}},{key:"_doLayoutGridAxisVertical",value:function(e,t){var n=this,i=t.height,r=1,a=-e.x*t.width,s=this._paddingLeft;this._horizontalDirection===$B.RIGHT_TO_LEFT&&(r=-1,a=(1-e.x)*t.width,s=this._paddingRight);function o(e,t,i){return a+r*(t+e.anchorX*e.width*l._getUsedScaleValue(e.getScale().x)+s+i*n._spacingX)}var l=this,c=0;if(this._resizeMode===XB.CONTAINER){var u=this._doLayoutVertically(i,!0,o,!1);(c=a-u)<0&&(c*=-1),a=-e.x*c,this._horizontalDirection===$B.RIGHT_TO_LEFT&&(r=-1,a=(1-e.x)*c)}this._doLayoutVertically(i,!0,o,!0),this._resizeMode===XB.CONTAINER&&this.node.setContentSize(c,i)}},{key:"_doLayoutGrid",value:function(){var e=this.node.getAnchorPoint(),t=this.node.getContentSize();this.startAxis===QB.HORIZONTAL?this._doLayoutGridAxisHorizontal(e,t):this.startAxis===QB.VERTICAL&&this._doLayoutGridAxisVertical(e,t)}},{key:"_getHorizontalBaseWidth",value:function(e){var t=0,i=0;if(this._resizeMode===XB.CONTAINER){var n=e,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;o.getScale(EP),o.activeInHierarchy&&(i++,t+=o.width*this._getUsedScaleValue(EP.x))}t+=(i-1)*this._spacingX+this._paddingLeft+this._paddingRight}else t=this.node.getContentSize().width;return t}},{key:"_getVerticalBaseHeight",value:function(e){var t=0,i=0;if(this._resizeMode===XB.CONTAINER){var n=e,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;o.getScale(EP),o.activeInHierarchy&&(i++,t+=o.height*this._getUsedScaleValue(EP.y))}t+=(i-1)*this._spacingY+this._paddingBottom+this._paddingTop}else t=this.node.getContentSize().height;return t}},{key:"_doLayout",value:function(){if(this._N$layoutType===jB.HORIZONTAL){var e=this._getHorizontalBaseWidth(this.node.children);this._doLayoutHorizontally(e,!1,function(e){return e.getPosition(TP),TP.y},!0),this.node.width=e}else if(this._N$layoutType===jB.VERTICAL){var t=this._getVerticalBaseHeight(this.node.children);this._doLayoutVertically(t,!1,function(e){return e.getPosition(TP),TP.x},!0),this.node.height=t}else this._N$layoutType===jB.NONE?this._resizeMode===XB.CONTAINER&&this._doLayoutBasic():this._N$layoutType===jB.GRID&&this._doLayoutGrid()}},{key:"_getUsedScaleValue",value:function(e){return this._affectedByScale?Math.abs(e):1}},{key:"_transformDirty",value:function(e){e===U_.POSITION_PART&&this._doLayoutDirty()}},{key:"_doLayoutDirty",value:function(){this._layoutDirty=!0}},{key:"_doScaleDirty",value:function(){this._layoutDirty=this._layoutDirty||this._affectedByScale}},{key:"type",get:function(){return this._N$layoutType},set:function(e){this._N$layoutType=e,this._doLayoutDirty()}},{key:"resizeMode",get:function(){return this._resizeMode},set:function(e){this._N$layoutType===jB.NONE&&e===XB.CHILDREN||(this._resizeMode=e,this._doLayoutDirty())}},{key:"cellSize",get:function(){return this._cellSize},set:function(e){this._cellSize!==e&&(this._cellSize.set(e),this._doLayoutDirty())}},{key:"startAxis",get:function(){return this._startAxis},set:function(e){this._startAxis!==e&&(this._startAxis=e,this._doLayoutDirty())}},{key:"paddingLeft",get:function(){return this._paddingLeft},set:function(e){this._paddingLeft!==e&&(this._paddingLeft=e,this._doLayoutDirty())}},{key:"paddingRight",get:function(){return this._paddingRight},set:function(e){this._paddingRight!==e&&(this._paddingRight=e,this._doLayoutDirty())}},{key:"paddingTop",get:function(){return this._paddingTop},set:function(e){this._paddingTop!==e&&(this._paddingTop=e,this._doLayoutDirty())}},{key:"paddingBottom",get:function(){return this._paddingBottom},set:function(e){this._paddingBottom!==e&&(this._paddingBottom=e,this._doLayoutDirty())}},{key:"spacingX",get:function(){return this._spacingX},set:function(e){this._spacingX!==e&&(this._spacingX=e,this._doLayoutDirty())}},{key:"spacingY",get:function(){return this._spacingY},set:function(e){this._spacingY!==e&&(this._spacingY=e,this._doLayoutDirty())}},{key:"verticalDirection",get:function(){return this._verticalDirection},set:function(e){this._verticalDirection!==e&&(this._verticalDirection=e,this._doLayoutDirty())}},{key:"horizontalDirection",get:function(){return this._horizontalDirection},set:function(e){this._horizontalDirection!==e&&(this._horizontalDirection=e,this._doLayoutDirty())}},{key:"padding",get:function(){return this._paddingLeft},set:function(e){this._N$padding=e,this._migratePaddingData(),this._doLayoutDirty()}},{key:"affectedByScale",get:function(){return this._affectedByScale},set:function(e){this._affectedByScale=e,this._doLayoutDirty()}}]),a}(),GB.Type=jB,GB.VerticalDirection=ZB,GB.HorizontalDirection=$B,GB.ResizeMode=XB,GB.AxisDirection=QB,m((AB=HB).prototype,"type",[xB],Object.getOwnPropertyDescriptor(AB.prototype,"type"),AB.prototype),m(AB.prototype,"resizeMode",[SB],Object.getOwnPropertyDescriptor(AB.prototype,"resizeMode"),AB.prototype),m(AB.prototype,"cellSize",[fo],Object.getOwnPropertyDescriptor(AB.prototype,"cellSize"),AB.prototype),m(AB.prototype,"startAxis",[wB],Object.getOwnPropertyDescriptor(AB.prototype,"startAxis"),AB.prototype),m(AB.prototype,"paddingLeft",[fo],Object.getOwnPropertyDescriptor(AB.prototype,"paddingLeft"),AB.prototype),m(AB.prototype,"paddingRight",[fo],Object.getOwnPropertyDescriptor(AB.prototype,"paddingRight"),AB.prototype),m(AB.prototype,"paddingTop",[fo],Object.getOwnPropertyDescriptor(AB.prototype,"paddingTop"),AB.prototype),m(AB.prototype,"paddingBottom",[fo],Object.getOwnPropertyDescriptor(AB.prototype,"paddingBottom"),AB.prototype),m(AB.prototype,"spacingX",[fo],Object.getOwnPropertyDescriptor(AB.prototype,"spacingX"),AB.prototype),m(AB.prototype,"spacingY",[fo],Object.getOwnPropertyDescriptor(AB.prototype,"spacingY"),AB.prototype),m(AB.prototype,"verticalDirection",[TB],Object.getOwnPropertyDescriptor(AB.prototype,"verticalDirection"),AB.prototype),m(AB.prototype,"horizontalDirection",[EB],Object.getOwnPropertyDescriptor(AB.prototype,"horizontalDirection"),AB.prototype),m(AB.prototype,"padding",[fo],Object.getOwnPropertyDescriptor(AB.prototype,"padding"),AB.prototype),m(AB.prototype,"affectedByScale",[fo],Object.getOwnPropertyDescriptor(AB.prototype,"affectedByScale"),AB.prototype),kB=m(AB.prototype,"_resizeMode",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return XB.NONE}}),RB=m(AB.prototype,"_N$layoutType",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return jB.NONE}}),OB=m(AB.prototype,"_N$padding",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),MB=m(AB.prototype,"_cellSize",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new jn(40,40)}}),IB=m(AB.prototype,"_startAxis",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return QB.HORIZONTAL}}),LB=m(AB.prototype,"_paddingLeft",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),zB=m(AB.prototype,"_paddingRight",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),BB=m(AB.prototype,"_paddingTop",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),PB=m(AB.prototype,"_paddingBottom",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),DB=m(AB.prototype,"_spacingX",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),FB=m(AB.prototype,"_spacingY",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),NB=m(AB.prototype,"_verticalDirection",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ZB.TOP_TO_BOTTOM}}),UB=m(AB.prototype,"_horizontalDirection",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $B.LEFT_TO_RIGHT}}),VB=m(AB.prototype,"_affectedByScale",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),CB=AB))||CB)||CB)||CB)||CB));cc.LayoutComponent=CP,(nP=iP=iP||{})[nP.BUTT=0]="BUTT",nP[nP.ROUND=1]="ROUND",nP[nP.SQUARE=2]="SQUARE",mt(iP),(aP=rP=rP||{})[aP.BEVEL=0]="BEVEL",aP[aP.ROUND=1]="ROUND",aP[aP.MITER=2]="MITER",mt(rP),(oP=sP=sP||{})[oP.PT_CORNER=1]="PT_CORNER",oP[oP.PT_LEFT=2]="PT_LEFT",oP[oP.PT_BEVEL=4]="PT_BEVEL",oP[oP.PT_INNERBEVEL=8]="PT_INNERBEVEL",mt(sP);var AP,kP,RP,OP,MP,IP,LP,zP,BP,PP,DP,FP,NP,UP=P2("GraphicsComponent",(lP=ho("cc.GraphicsComponent"),cP=go(110),uP=yo("UI/Render/Graphics"),hP=fo({type:rP}),fP=fo({type:iP}),dP=fo({override:!0,visible:!1}),lP(pP=cP(pP=uP((wP=SP=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this))).impl=null,e.model=null,v(e,"_lineWidth",vP,u(e)),v(e,"_strokeColor",mP,u(e)),v(e,"_lineJoin",yP,u(e)),v(e,"_lineCap",gP,u(e)),v(e,"_fillColor",bP,u(e)),v(e,"_miterLimit",xP,u(e)),e._instanceMaterialType=bC.ADDCOLOR,e}return p(t,GC),l(t,[{key:"lineWidth",get:function(){return this._lineWidth},set:function(e){this._lineWidth=e,this.impl&&(this.impl.lineWidth=e)}},{key:"lineJoin",get:function(){return this._lineJoin},set:function(e){this._lineJoin=e,this.impl&&(this.impl.lineJoin=e)}},{key:"lineCap",get:function(){return this._lineCap},set:function(e){this._lineCap=e,this.impl&&(this.impl.lineCap=e)}},{key:"strokeColor",get:function(){return this._strokeColor},set:function(e){this.impl&&(this._strokeColor.set(e),this.impl.strokeColor=this._strokeColor)}},{key:"fillColor",get:function(){return this._fillColor},set:function(e){this.impl&&(this._fillColor.set(e),this.impl.fillColor=this._fillColor)}},{key:"miterLimit",get:function(){return this._miterLimit},set:function(e){this._miterLimit=e}},{key:"color",get:function(){return this._color}}]),l(t,[{key:"onRestore",value:function(){this.impl||this._flushAssembler()}},{key:"__preload",value:function(){_(g(t.prototype),"__preload",this)&&_(g(t.prototype),"__preload",this).call(this),this.impl=this._assembler&&this._assembler.createImpl(this)}},{key:"onLoad",value:function(){this._sceneGetter=Yb.root.ui.getRenderSceneGetter()}},{key:"onEnable",value:function(){_(g(t.prototype),"onEnable",this).call(this),this.model&&(this.model.enabled=!0),this._activateMaterial()}},{key:"onDisable",value:function(){this.model&&(this.model.enabled=!1)}},{key:"onDestroy",value:function(){_(g(t.prototype),"onDestroy",this).call(this),this._sceneGetter=null,this.model&&(this._getRenderScene().destroyModel(this.model),this.model=null),this.impl&&(this.impl.clear(),this.impl=null)}},{key:"_activateMaterial",value:function(){this._material&&this._updateMaterial(this._material)}},{key:"moveTo",value:function(e,t){this.impl&&this.impl.moveTo(e,t)}},{key:"lineTo",value:function(e,t){this.impl&&this.impl.lineTo(e,t)}},{key:"bezierCurveTo",value:function(e,t,i,n,r,a){this.impl&&this.impl.bezierCurveTo(e,t,i,n,r,a)}},{key:"quadraticCurveTo",value:function(e,t,i,n){this.impl&&this.impl.quadraticCurveTo(e,t,i,n)}},{key:"arc",value:function(e,t,i,n,r,a){this.impl&&this.impl.arc(e,t,i,n,r,a)}},{key:"ellipse",value:function(e,t,i,n){this.impl&&this.impl.ellipse(e,t,i,n)}},{key:"circle",value:function(e,t,i){this.impl&&this.impl.circle(e,t,i)}},{key:"rect",value:function(e,t,i,n){this.impl&&this.impl.rect(e,t,i,n)}},{key:"roundRect",value:function(e,t,i,n,r){this.impl&&this.impl.roundRect(e,t,i,n,r)}},{key:"fillRect",value:function(e,t,i,n){this.rect(e,t,i,n),this.fill()}},{key:"clear",value:function(e){var t=0<arguments.length&&void 0!==e&&e;this.impl&&(this.impl.clear(t),this.model&&(this.model.scene.destroyModel(this.model),this.model=null),this.markForUpdateRenderData())}},{key:"close",value:function(){this.impl&&this.impl.close()}},{key:"stroke",value:function(){this._assembler.stroke(this)}},{key:"fill",value:function(){this._assembler.fill(this)}},{key:"helpInstanceMaterial",value:function(){var e=null;this._sharedMaterial?e=cp.getInstantiatedMaterial(this._sharedMaterial,new kC,!1):((e=cp.getInstantiatedMaterial(kd.get("ui-base-material"),new kC,!1)).recompileShaders({USE_LOCAL:!0}),e.onLoaded()),this._updateMaterial(e),this.impl||(this._flushAssembler(),this.impl=this._assembler&&this._assembler.createImpl(this))}},{key:"_render",value:function(e){e.commitModel(this,this.model,this._material)}},{key:"_instanceMaterial",value:function(){this.helpInstanceMaterial()}},{key:"_flushAssembler",value:function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e)}},{key:"_canRender",value:function(){return!!_(g(t.prototype),"_canRender",this).call(this)&&!!this.model}}]),t}(),SP.LineJoin=rP,SP.LineCap=iP,m((_P=wP).prototype,"lineJoin",[hP],Object.getOwnPropertyDescriptor(_P.prototype,"lineJoin"),_P.prototype),m(_P.prototype,"lineCap",[fP],Object.getOwnPropertyDescriptor(_P.prototype,"lineCap"),_P.prototype),m(_P.prototype,"strokeColor",[fo],Object.getOwnPropertyDescriptor(_P.prototype,"strokeColor"),_P.prototype),m(_P.prototype,"fillColor",[fo],Object.getOwnPropertyDescriptor(_P.prototype,"fillColor"),_P.prototype),m(_P.prototype,"miterLimit",[fo],Object.getOwnPropertyDescriptor(_P.prototype,"miterLimit"),_P.prototype),m(_P.prototype,"color",[dP],Object.getOwnPropertyDescriptor(_P.prototype,"color"),_P.prototype),vP=m(_P.prototype,"_lineWidth",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),mP=m(_P.prototype,"_strokeColor",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rr.BLACK.clone()}}),yP=m(_P.prototype,"_lineJoin",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rP.MITER}}),gP=m(_P.prototype,"_lineCap",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return iP.BUTT}}),bP=m(_P.prototype,"_fillColor",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rr.WHITE.clone()}}),xP=m(_P.prototype,"_miterLimit",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),pP=_P))||pP)||pP)||pP));cc.GraphicsComponent=UP;var VP,GP,HP=new zn,qP=new Mi,jP=new zn,WP=[];(GP=VP=VP||{})[GP.RECT=0]="RECT",GP[GP.ELLIPSE=1]="ELLIPSE",mt(VP);var XP,YP,QP,KP,ZP,JP,$P,eD,tD,iD,nD,rD,aD,sD,oD,lD,cD,uD=P2("MaskComponent",(AP=ho("cc.MaskComponent"),kP=go(110),RP=yo("UI/Render/Mask"),OP=fo({type:VP,displayOrder:4}),MP=fo({visible:!1,override:!0}),IP=fo({visible:!1,override:!0}),LP=fo({visible:!1,override:!0}),AP(zP=kP(zP=RP((NP=FP=function(){function i(){var e;return y(this,i),v(e=x(this,g(i).call(this)),"_type",PP,u(e)),v(e,"_segments",DP,u(e)),e._graphics=null,e._clearGraphics=null,e._instanceMaterialType=bC.ADDCOLOR,e}return p(i,GC),l(i,[{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this._updateGraphics(),this._renderData&&(this.destroyRenderData(),this._renderData=null),this._activateMaterial())}},{key:"segments",get:function(){return this._segments},set:function(e){this._segments=pi(e,3,1e4),this._updateGraphics()}},{key:"graphics",get:function(){return this._graphics}},{key:"clearGraphics",get:function(){return this._clearGraphics}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(e){this._dstBlendFactor!==e&&(this._dstBlendFactor=e,this._updateBlendFunc())}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(e){this._srcBlendFactor!==e&&(this._srcBlendFactor=e,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this.markForUpdateRenderData())}}]),l(i,[{key:"onLoad",value:function(){this._createGraphics()}},{key:"onRestore",value:function(){this._createGraphics(),this._updateGraphics()}},{key:"onEnable",value:function(){_(g(i.prototype),"onEnable",this).call(this),this._flushVisibility(),this._clearGraphics&&this._clearGraphics.onEnable(),this._updateGraphics(),this._activateMaterial(),this.node.on(U_.TRANSFORM_CHANGED,this._nodeStateChange,this),nx.on("design-resolution-changed",this._updateClearGraphics,this)}},{key:"onDisable",value:function(){_(g(i.prototype),"onDisable",this).call(this),this._disableGraphics(),this.node.off(U_.TRANSFORM_CHANGED,this._nodeStateChange),nx.off("design-resolution-changed",this._updateClearGraphics)}},{key:"onDestroy",value:function(){_(g(i.prototype),"onDestroy",this).call(this),this._removeGraphics()}},{key:"isHit",value:function(e){var t=this.node,i=t.getContentSize(),n=i.width,r=i.height,a=qP;this.node.getWorldMatrix(HP),zn.invert(jP,HP),Mi.transformMat4(a,e,jP);var s=t.getAnchorPoint();a.x+=s.x*n,a.y+=s.y*r;var o=!1;if(this.type===VP.RECT)o=0<=a.x&&0<=a.y&&a.x<=n&&a.y<=r;else if(this.type===VP.ELLIPSE){var l=n/2,c=r/2,u=a.x-.5*n,h=a.y-.5*r;o=u*u/(l*l)+h*h/(c*c)<1}return o}},{key:"_resizeNodeToTargetNode",value:function(){}},{key:"_render",value:function(e){e.commitComp(this,null,this._assembler)}},{key:"_postRender",value:function(e){this._postAssembler&&e.commitComp(this,null,this._postAssembler)}},{key:"_nodeStateChange",value:function(e){e!==U_.POSITION_PART&&(_(g(i.prototype),"_nodeStateChange",this).call(this,e),this._updateGraphics())}},{key:"_resolutionChanged",value:function(){this._updateClearGraphics()}},{key:"_canRender",value:function(){return!!_(g(i.prototype),"_canRender",this).call(this)&&(null!==this._clearGraphics&&null!==this._graphics)}},{key:"_flushAssembler",value:function(){var e=i.Assembler.getAssembler(this),t=i.PostAssembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._postAssembler!==t&&(this._postAssembler=t),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.sharedMaterial,this.markForUpdateRenderData())}},{key:"_parentChanged",value:function(e){return!!_(g(i.prototype),"_parentChanged",this).call(this,e)&&(this._flushVisibility(),!0)}},{key:"_onTextureLoaded",value:function(){this._renderData&&(this._renderData.uvDirty=!0,this._renderData.vertDirty=!0),this.enabledInHierarchy&&this._activateMaterial()}},{key:"_applySpriteFrame",value:function(e){}},{key:"_createGraphics",value:function(){if(!this._clearGraphics){var e=this._clearGraphics=new UP;e.node=new Sm("clear-graphics"),e.helpInstanceMaterial(),e._activateMaterial(),e.lineWidth=0;var t=rr.WHITE.clone();t.a=0,this._clearGraphics.fillColor=t,this._updateClearGraphics()}if(!this._graphics){var i=this._graphics=new UP;i.node=this.node,i.node.getWorldMatrix(),i.helpInstanceMaterial(),i.lineWidth=0;var n=rr.WHITE.clone();n.a=0,i.fillColor=n}}},{key:"_updateClearGraphics",value:function(){if(this._clearGraphics){console.log("resolution changed");var e=gl;this._clearGraphics.node.setWorldPosition(e.width/2,e.height/2,0),this._clearGraphics.clear(),this._clearGraphics.rect(-e.width/2,-e.height/2,e.width,e.height),this._clearGraphics.fill()}}},{key:"_updateGraphics",value:function(){if(this._graphics){var e=this.node,t=this._graphics;t.clear();var i=e.getContentSize(),n=i.width,r=i.height,a=e.getAnchorPoint(),s=-n*a.x,o=-r*a.y;if(this._type===VP.RECT)t.rect(s,o,n,r);else if(this._type===VP.ELLIPSE){for(var l=function(e,t,i){WP.length=0;for(var n=2*Math.PI/i,r=0;r<i;++r)WP.push(new Fi(t.x*Math.cos(n*r)+e.x,t.y*Math.sin(n*r)+e.y,0));return WP}(new Fi(s+n/2,o+r/2,0),new Fi(n/2,r/2,0),this._segments),c=0;c<l.length;++c){var u=l[c];0===c?t.moveTo(u.x,u.y):t.lineTo(u.x,u.y)}t.close()}t.fill()}}},{key:"_disableGraphics",value:function(){this._graphics&&this._graphics.onDisable(),this._clearGraphics&&this._clearGraphics.onDisable()}},{key:"_removeGraphics",value:function(){this._graphics&&this._graphics.destroy(),this._clearGraphics&&this._clearGraphics.destroy()}},{key:"_flushVisibility",value:function(){this._clearGraphics&&this._clearGraphics._setScreen(this._screen),this._graphics&&this._graphics._setScreen(this._screen)}},{key:"_activateMaterial",value:function(){}}]),i}(),FP.Type=VP,m((BP=NP).prototype,"type",[OP],Object.getOwnPropertyDescriptor(BP.prototype,"type"),BP.prototype),m(BP.prototype,"segments",[fo],Object.getOwnPropertyDescriptor(BP.prototype,"segments"),BP.prototype),m(BP.prototype,"dstBlendFactor",[MP],Object.getOwnPropertyDescriptor(BP.prototype,"dstBlendFactor"),BP.prototype),m(BP.prototype,"srcBlendFactor",[IP],Object.getOwnPropertyDescriptor(BP.prototype,"srcBlendFactor"),BP.prototype),m(BP.prototype,"color",[LP],Object.getOwnPropertyDescriptor(BP.prototype,"color"),BP.prototype),PP=m(BP.prototype,"_type",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return VP.RECT}}),DP=m(BP.prototype,"_segments",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),zP=BP))||zP)||zP)||zP));cc.MaskComponent=uD,(cD=lD=lD||{})[cD.HORIZONTAL=0]="HORIZONTAL",cD[cD.VERTICAL=1]="VERTICAL",cD[cD.FILLED=2]="FILLED",vt(lD);var hD,fD,dD,pD,_D=P2("ProgressBarComponent",(XP=ho("cc.ProgressBarComponent"),YP=go(110),QP=yo("UI/ProgressBar"),KP=fo({type:CL}),ZP=fo({type:lD}),JP=fo({range:[0,1,.1],slide:!0}),XP($P=YP($P=QP((oD=sD=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"_barSprite",tD,u(t)),v(t,"_mode",iD,u(t)),v(t,"_totalLength",nD,u(t)),v(t,"_progress",rD,u(t)),v(t,"_reverse",aD,u(t)),t}return p(a,Bv),l(a,[{key:"_initBarSprite",value:function(){if(this._barSprite){var e=this._barSprite.node;if(!e)return;var t=this.node.getContentSize(),i=this.node.getAnchorPoint(),n=e.getContentSize();if(this._barSprite.fillType===CL.FillType.RADIAL&&(this._mode=lD.FILLED),this._mode===lD.HORIZONTAL?this.totalLength=n.width:this._mode===lD.VERTICAL?this.totalLength=n.height:this.totalLength=this._barSprite.fillRange,e.parent===this.node){var r=-t.width*i.x;e.setPosition(r,0,0)}}}},{key:"_updateBarStatus",value:function(){if(this._barSprite){var e=this._barSprite.node;if(!e)return;var t=e.getAnchorPoint(),i=e.getContentSize(),n=e.getPosition(),r=new Mi(0,.5),a=_i(this._progress),s=this._totalLength*a,o=i,l=0,c=0;switch(this._mode){case lD.HORIZONTAL:this._reverse&&(r=new Mi(1,.5)),o=new jn(s,i.height),l=this._totalLength,c=i.height;break;case lD.VERTICAL:r=this._reverse?new Mi(.5,1):new Mi(.5,0),o=new jn(i.width,s),l=i.width,c=this._totalLength}if(this._mode===lD.FILLED)this._barSprite.type!==CL.Type.FILLED?C("ProgressBar FILLED mode only works when barSprite's Type is FILLED!"):(this._reverse&&(s*=-1),this._barSprite.fillRange=s);else if(this._barSprite.type!==CL.Type.FILLED){var u=r.x-t.x,h=r.y-t.y,f=new Fi(l*u,c*h,0);e.setPosition(n.x+f.x,n.y+f.y,n.z),e.setAnchorPoint(r),e.setContentSize(o)}else C("ProgressBar non-FILLED mode only works when barSprite's Type is non-FILLED!")}}},{key:"barSprite",get:function(){return this._barSprite},set:function(e){this._barSprite!==e&&(this._barSprite=e,this._initBarSprite())}},{key:"mode",get:function(){return this._mode},set:function(e){if(this._mode!==e&&(this._mode=e,this._barSprite)){var t=this._barSprite.node;if(!t)return;var i=t.getContentSize();this._mode===lD.HORIZONTAL?this.totalLength=i.width:this._mode===lD.VERTICAL?this.totalLength=i.height:this._mode===lD.FILLED&&(this.totalLength=this._barSprite.fillRange)}}},{key:"totalLength",get:function(){return this._totalLength},set:function(e){this._mode===lD.FILLED&&(e=_i(e)),this._totalLength=e,this._updateBarStatus()}},{key:"progress",get:function(){return this._progress},set:function(e){this._progress!==e&&(this._progress=e,this._updateBarStatus())}},{key:"reverse",get:function(){return this._reverse},set:function(e){this._reverse!==e&&(this._reverse=e,this._barSprite&&(this._barSprite.fillStart=1-this._barSprite.fillStart),this._updateBarStatus())}}]),a}(),sD.Mode=lD,m((eD=oD).prototype,"barSprite",[KP],Object.getOwnPropertyDescriptor(eD.prototype,"barSprite"),eD.prototype),m(eD.prototype,"mode",[ZP],Object.getOwnPropertyDescriptor(eD.prototype,"mode"),eD.prototype),m(eD.prototype,"totalLength",[fo],Object.getOwnPropertyDescriptor(eD.prototype,"totalLength"),eD.prototype),m(eD.prototype,"progress",[JP],Object.getOwnPropertyDescriptor(eD.prototype,"progress"),eD.prototype),m(eD.prototype,"reverse",[fo],Object.getOwnPropertyDescriptor(eD.prototype,"reverse"),eD.prototype),tD=m(eD.prototype,"_barSprite",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),iD=m(eD.prototype,"_mode",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lD.HORIZONTAL}}),nD=m(eD.prototype,"_totalLength",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),rD=m(eD.prototype,"_progress",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),aD=m(eD.prototype,"_reverse",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),$P=eD))||$P)||$P)||$P));cc.ProgressBarComponent=_D;var vD,mD,yD,gD,bD,xD,SD,wD,TD,ED,CD,AD,kD,RD,OD,MD,ID,LD,zD,BD=P2("LabelOutlineComponent",ho("cc.LabelOutlineComponent")(hD=go(110)(hD=yo("UI/Render/LabelOutline")((dD=m((fD=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"_color",dD,u(t)),v(t,"_width",pD,u(t)),t}return p(a,Bv),l(a,[{key:"_updateRenderData",value:function(){var e=this.node.getComponent(kz);e&&e.updateRenderData(!0)}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateRenderData())}},{key:"width",get:function(){return this._width},set:function(e){this._width!==e&&(this._width=e,this._updateRenderData())}}]),a}()).prototype,"_color",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rr(255,255,255,255)}}),pD=m(fD.prototype,"_width",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),m(fD.prototype,"color",[fo],Object.getOwnPropertyDescriptor(fD.prototype,"color"),fD.prototype),m(fD.prototype,"width",[fo],Object.getOwnPropertyDescriptor(fD.prototype,"width"),fD.prototype),hD=fD))||hD)||hD)||hD);cc.LabelOutlineComponent=BD;var PD=new $s,DD="RICHTEXT_CHILD",FD="RICHTEXT_Image_CHILD";var ND=new Je(function(e){return!!cc.isValid(e.node)&&!e.node.getComponent(BD)},20);ND.get=function(e,t){var i=this._get(),n=(i=i||{node:new Ey(DD),comp:null,lineCount:0,styleIndex:0,clickHandler:""}).node,r=(n=n||new Ey(DD)).getComponent(kz);return r=r=r||n.addComponent(kz),n.setPosition(0,0,0),n.setAnchorPoint(.5,.5),n.setContentSize(128,128),"string"!=typeof e&&(e=""+e),t.font instanceof ew?r.font=t.font:r.fontFamily="Arial",r.string=e,r.horizontalAlign=fz.LEFT,r.verticalAlign=pz.TOP,r.fontSize=t.fontSize||40,r.overflow=0,r.enableWrapText=!0,r.lineHeight=40,r.isBold=!1,r.isItalic=!1,r.isUnderline=!1,{node:n,comp:r,lineCount:0,clickHandler:"",styleIndex:0}};var UD,VD,GD,HD,qD,jD,WD,XD,YD,QD,KD,ZD,JD,$D,eF=P2("RichTextComponent",(vD=ho("cc.RichTextComponent"),mD=go(110),yD=yo("UI/Render/RichText"),gD=fo({multiline:!0}),bD=fo({type:fz}),xD=fo({type:cw}),SD=fo({type:Hx}),vD(wD=mD(wD=yD(wD=vo((zD=LD=function(){function t(){var e;return y(this,t),v(e=x(this,g(t).call(this)),"_lineHeight",ED,u(e)),v(e,"_string",CD,u(e)),v(e,"_horizontalAlign",AD,u(e)),v(e,"_fontSize",kD,u(e)),v(e,"_maxWidth",RD,u(e)),v(e,"_font",OD,u(e)),v(e,"_imageAtlas",MD,u(e)),v(e,"_handleTouchEvent",ID,u(e)),e._textArray=[],e._labelSegments=[],e._labelSegmentsCache=[],e._linesWidth=[],e._lineCount=1,e._labelWidth=0,e._labelHeight=0,e._layoutDirty=!0,e._lineOffsetX=0,e._updateRichTextStatus=void 0,e._updateRichTextStatus=e._updateRichText,e}return p(t,SC),l(t,[{key:"string",get:function(){return this._string},set:function(e){this._string!==e&&(this._string=e,this._updateRichTextStatus())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(e){this.horizontalAlign!==e&&(this._horizontalAlign=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"font",get:function(){return this._font},set:function(e){this._font!==e&&(this._font=e,this._layoutDirty=!0,this._font&&this._onTTFLoaded(),this._updateRichTextStatus())}},{key:"maxWidth",get:function(){return this._maxWidth},set:function(e){this._maxWidth!==e&&(this._maxWidth=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"imageAtlas",get:function(){return this._imageAtlas},set:function(e){this._imageAtlas!==e&&(this._imageAtlas=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"handleTouchEvent",get:function(){return this._handleTouchEvent},set:function(e){this._handleTouchEvent!==e&&(this._handleTouchEvent=e,this.enabledInHierarchy&&(this.handleTouchEvent?this._addEventListeners():this._removeEventListeners()))}}]),l(t,[{key:"onEnable",value:function(){this.handleTouchEvent&&this._addEventListeners(),this._updateRichText(),this._activateChildren(!0)}},{key:"onDisable",value:function(){this.handleTouchEvent&&this._removeEventListeners(),this._activateChildren(!1)}},{key:"start",value:function(){this._onTTFLoaded()}},{key:"onRestore",value:function(){}},{key:"onDestroy",value:function(){var e=this._labelSegments,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;r.node.removeFromParent(),ND.put(r)}}},{key:"_addEventListeners",value:function(){this.node.on(Sm.EventType.TOUCH_END,this._onTouchEnded,this)}},{key:"_removeEventListeners",value:function(){this.node.off(Sm.EventType.TOUCH_END,this._onTouchEnded,this)}},{key:"_updateLabelSegmentTextAttributes",value:function(){var t=this;this._labelSegments.forEach(function(e){t._applyTextAttribute(e)})}},{key:"_createFontLabel",value:function(e){return ND.get(e,this)}},{key:"_onTTFLoaded",value:function(){if(this._font instanceof cw)if(this._font._nativeAsset)this._layoutDirty=!0,this._updateRichText();else{var i=this;Kw.load(this._font.nativeUrl,function(e,t){i._layoutDirty=!0,i._updateRichText()})}else this._layoutDirty=!0,this._updateRichText()}},{key:"_measureText",value:function(i,e){function t(e){var t;return 0===n._labelSegmentsCache.length?(t=n._createFontLabel(e),n._labelSegmentsCache.push(t)):(t=n._labelSegmentsCache[0]).node.getComponent(kz).string=e,t.styleIndex=i,n._applyTextAttribute(t),t.node.getContentSize().width}var n=this;return e?t(e):t}},{key:"_onTouchEnded",value:function(n){var t=this,r=this.node.getComponents(SC),a=this,e=function(){if(o){if(l>=s.length)return"break";c=s[l++]}else{if((l=s.next()).done)return"break";c=l.value}var e=c,i=e.clickHandler;i&&t._containsTouchLocation(e,n.touch.getUILocation())&&(r.forEach(function(e){var t=e[i];e.enabledInHierarchy&&t&&t.call(a,n)}),n.propagationStopped=!0)},s=this._labelSegments,o=Array.isArray(s),l=0;for(s=o?s:s[Symbol.iterator]();;){var c;if("break"===e())break}}},{key:"_containsTouchLocation",value:function(e,t){var i=e.node.getComponent(SE);return!!i&&i.getBoundingBoxToWorld().contains(t)}},{key:"_resetState",value:function(){for(var n=this,r=this.node.children,e=function(e){var t=r[e];if((t.name===DD||t.name===FD)&&(t.parent===n.node?t.parent=null:r.splice(e,1),t.name===DD)){var i=n._labelSegments.findIndex(function(e){return e.node===t});-1!==i&&ND.put(n._labelSegments[i])}},t=r.length-1;0<=t;t--)e(t);this._labelSegments.length=0,this._labelSegmentsCache.length=0,this._linesWidth.length=0,this._lineOffsetX=0,this._lineCount=1,this._labelWidth=0,this._labelHeight=0,this._layoutDirty=!0}},{key:"_activateChildren",value:function(e){for(var t=this.node.children.length-1;0<=t;t--){var i=this.node.children[t];i.name!==DD&&i.name!==FD||(i.active=e)}}},{key:"_addLabelSegment",value:function(e,t){var i;if(0===this._labelSegmentsCache.length)i=this._createFontLabel(e);else{var n=(i=this._labelSegmentsCache.pop()).node.getComponent(kz);n&&(n.string=e)}return i.styleIndex=t,i.lineCount=this._lineCount,i.node.setAnchorPoint(0,0),this._applyTextAttribute(i),this.node.addChild(i.node),this._labelSegments.push(i),i}},{key:"_updateRichTextWithMaxWidth",value:function(e,t,i){var n=t;if(0<this._lineOffsetX&&n+this._lineOffsetX>this.maxWidth)for(var r=0;this._lineOffsetX<=this.maxWidth;){var a=this._getFirstWordLen(e,r,e.length),s=e.substr(r,a),o=this._measureText(i,s);if(!(this._lineOffsetX+o<=this.maxWidth)){if(0<r){var l=e.substr(0,r);this._addLabelSegment(l,i),e=e.substr(r,e.length),n=this._measureText(i,e)}this._updateLineInfo();break}this._lineOffsetX+=o,r+=a}if(n>this.maxWidth)for(var c=Ks(e,n,this.maxWidth,this._measureText(i)),u=0;u<c.length;++u){var h=c[u],f=this._addLabelSegment(h,i).node.getContentSize();this._lineOffsetX+=f.width,1<c.length&&u<c.length-1&&this._updateLineInfo()}else this._lineOffsetX+=n,this._addLabelSegment(e,i)}},{key:"_isLastComponentCR",value:function(e){return e.length-1===e.lastIndexOf("\n")}},{key:"_updateLineInfo",value:function(){this._linesWidth.push(this._lineOffsetX),this._lineOffsetX=0,this._lineCount++}},{key:"_needsUpdateTextLayout",value:function(e){if(this._layoutDirty||!this._textArray||!e)return!0;if(this._textArray.length!==e.length)return!0;for(var t=0;t<this._textArray.length;t++){var i=this._textArray[t],n=e[t];if(i.text!==n.text)return!0;if(i.style){if(n.style){if(!!n.style.outline!=!!i.style.outline)return!0;if(i.style.size!==n.style.size||i.style.italic!==n.style.italic||i.style.isImage!==n.style.isImage)return!0;if(i.style.isImage===n.style.isImage&&i.style.src!==n.style.src)return!0}else if(i.style.size||i.style.italic||i.style.isImage||i.style.outline)return!0}else if(n.style&&(n.style.size||n.style.italic||n.style.isImage||n.style.outline))return!0}return!1}},{key:"_addRichTextImageElement",value:function(e){if(e.style){var t=e.style.src,i=this._imageAtlas&&t&&this._imageAtlas.getSpriteFrame(t);if(i){var n=new Ey(FD),r=n.addComponent(CL);n.setAnchorPoint(0,0),r.type=CL.Type.SLICED,r.sizeMode=CL.SizeMode.CUSTOM,this.node.addChild(n);var a={node:n,comp:r,lineCount:0,clickHandler:"",styleIndex:0};this._labelSegments.push(a);var s=i.getRect(),o=1,l=s.width,c=s.height,u=e.style.imageWidth,h=e.style.imageHeight;if(void 0!==h&&0<h&&h<this.lineHeight?l*=o=h/c:l*=o=this.lineHeight/c,c*=o,void 0!==u&&0<u&&(l=u),0<this.maxWidth?(this._lineOffsetX+l>this.maxWidth&&this._updateLineInfo(),this._lineOffsetX+=l):(this._lineOffsetX+=l,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX)),r.spriteFrame=i,n.setContentSize(l,c),a.lineCount=this._lineCount,e.style.event){e.style.event.click&&(a.clickHandler=e.style.event.click)}}else B(4400)}}},{key:"_updateRichText",value:function(){if(this.enabled){var e=PD.parse(this._string);if(!this._needsUpdateTextLayout(e))return this._textArray=e.slice(),void this._updateLabelSegmentTextAttributes();this._textArray=e.slice(),this._resetState();for(var t,i=!1,n=0;n<this._textArray.length;++n){var r=this._textArray[n],a=r.text;if(void 0!==a){if(""===a){if(r.style&&r.style.isNewLine){this._updateLineInfo();continue}if(r.style&&r.style.isImage&&this.imageAtlas){this._addRichTextImageElement(r);continue}}for(var s=a.split("\n"),o=0;o<s.length;++o){var l=s[o];if(""!==l)if(i=!1,0<this.maxWidth){var c=this._measureText(n,l);this._updateRichTextWithMaxWidth(l,c,n),1<s.length&&o<s.length-1&&this._updateLineInfo()}else t=this._addLabelSegment(l,n).node.getContentSize(),this._lineOffsetX+=t.width,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX),1<s.length&&o<s.length-1&&this._updateLineInfo();else{if(this._isLastComponentCR(a)&&o===s.length-1)continue;this._updateLineInfo(),i=!0}}}}i||this._linesWidth.push(this._lineOffsetX),0<this.maxWidth&&(this._labelWidth=this.maxWidth),this._labelHeight=this._lineCount*this.lineHeight,this.node.setContentSize(this._labelWidth,this._labelHeight),this._updateRichTextPosition(),this._layoutDirty=!1}}},{key:"_getFirstWordLen",value:function(e,t,i){var n=e.charAt(t);if(Xs(n)||Ys(n))return 1;for(var r=1,a=t+1;a<i&&(!Ys(n=e.charAt(a))&&!Xs(n));++a)r++;return r}},{key:"_updateRichTextPosition",value:function(){var e=0,t=1,i=this._lineCount,n=this._labelSegments,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s,l=o.lineCount;t<l&&(e=0,t=l);var c=0;switch(this.horizontalAlign){case fz.LEFT:c=-this._labelWidth/2;break;case fz.CENTER:c=-this._linesWidth[l-1]/2;break;case fz.RIGHT:c=this._labelWidth/2-this._linesWidth[l-1]}var u=o.node.getContentSize(),h=o.node.getPosition();o.node.setPosition(e+c,this.lineHeight*(i-l)-this._labelHeight/2,h.z),l===t&&(e+=u.width)}}},{key:"_convertLiteralColorValue",value:function(e){var t=e.toUpperCase();return rr[t]?rr[t]:(new rr).fromHEX(e)}},{key:"_applyTextAttribute",value:function(e){var t=e.node.getComponent(kz);if(t){var i,n=e.styleIndex;t.lineHeight=this.lineHeight,t.horizontalAlign=fz.LEFT,t.verticalAlign=pz.CENTER,this._textArray[n]&&(i=this._textArray[n].style);var r=e.node.getComponent(kz);if(r&&(i&&i.color?r.color=this._convertLiteralColorValue(i.color):r.color=this._convertLiteralColorValue("white")),t.isBold=!(!i||!i.bold),t.isItalic=!(!i||!i.italic),t.isUnderline=!(!i||!i.underline),i&&i.outline){var a=e.node.getComponent(BD);(a=a||e.node.addComponent(BD)).color=this._convertLiteralColorValue(i.outline.color),a.width=i.outline.width}if(i&&i.size?t.fontSize=i.size:t.fontSize=this._fontSize,t.updateRenderData(!0),i&&i.event){i.event.click&&(e.clickHandler=i.event.click)}}}}]),t}(),LD.HorizontalAlign=fz,LD.VerticalAlign=pz,m((TD=zD).prototype,"string",[gD],Object.getOwnPropertyDescriptor(TD.prototype,"string"),TD.prototype),m(TD.prototype,"horizontalAlign",[bD],Object.getOwnPropertyDescriptor(TD.prototype,"horizontalAlign"),TD.prototype),m(TD.prototype,"fontSize",[fo],Object.getOwnPropertyDescriptor(TD.prototype,"fontSize"),TD.prototype),m(TD.prototype,"font",[xD],Object.getOwnPropertyDescriptor(TD.prototype,"font"),TD.prototype),m(TD.prototype,"maxWidth",[fo],Object.getOwnPropertyDescriptor(TD.prototype,"maxWidth"),TD.prototype),m(TD.prototype,"lineHeight",[fo],Object.getOwnPropertyDescriptor(TD.prototype,"lineHeight"),TD.prototype),m(TD.prototype,"imageAtlas",[SD],Object.getOwnPropertyDescriptor(TD.prototype,"imageAtlas"),TD.prototype),m(TD.prototype,"handleTouchEvent",[fo],Object.getOwnPropertyDescriptor(TD.prototype,"handleTouchEvent"),TD.prototype),ED=m(TD.prototype,"_lineHeight",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),CD=m(TD.prototype,"_string",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"<color=#00ff00>Rich</c><color=#0fffff>Text</color>"}}),AD=m(TD.prototype,"_horizontalAlign",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fz.LEFT}}),kD=m(TD.prototype,"_fontSize",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),RD=m(TD.prototype,"_maxWidth",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),OD=m(TD.prototype,"_font",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),MD=m(TD.prototype,"_imageAtlas",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ID=m(TD.prototype,"_handleTouchEvent",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),wD=TD))||wD)||wD)||wD)||wD));cc.RichTextComponent=eF;var tF,iF,nF=new Fi,rF=new Fi,aF=new Fi,sF=new Mi,oF=new rr;(iF=tF=tF||{})[iF.HORIZONTAL=0]="HORIZONTAL",iF[iF.VERTICAL=1]="VERTICAL",mt(tF);var lF,cF=P2("ScrollBarComponent",(UD=ho("cc.ScrollBarComponent"),VD=go(110),GD=yo("UI/ScrollBar"),HD=fo({type:CL}),qD=fo({type:tF}),UD(jD=VD(jD=GD(($D=JD=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"_scrollView",XD,u(t)),v(t,"_handle",YD,u(t)),v(t,"_direction",QD,u(t)),v(t,"_enableAutoHide",KD,u(t)),v(t,"_autoHideTime",ZD,u(t)),t._touching=!1,t._opacity=255,t._autoHideRemainingTime=0,t}return p(a,Bv),l(a,[{key:"hide",value:function(){this._autoHideRemainingTime=0,this._setOpacity(0)}},{key:"show",value:function(){this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity)}},{key:"onScroll",value:function(e){if(this._scrollView){var t=this._scrollView.content;if(t){var i=t.getContentSize(),n=this._scrollView.node.getContentSize(),r=this.node.getContentSize();if(!this._conditionalDisableScrollBar(i,n)){this._enableAutoHide&&(this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity));var a=0,s=0,o=0,l=0,c=0;this._direction===tF.HORIZONTAL?(a=i.width,s=n.width,c=r.width,o=e.x,l=-this._convertToScrollViewSpace(t).x):this._direction===tF.VERTICAL&&(a=i.height,s=n.height,c=r.height,o=e.y,l=-this._convertToScrollViewSpace(t).y);var u=this._calculateLength(a,s,c,o),h=this._calculatePosition(a,s,c,l,o,u);this._updateLength(u),this._updateHanlderPosition(h)}}}}},{key:"setScrollView",value:function(e){this._scrollView=e}},{key:"onTouchBegan",value:function(){this._enableAutoHide&&(this._touching=!0)}},{key:"onTouchEnded",value:function(){if(this._enableAutoHide&&(this._touching=!1,!(this._autoHideTime<=0))){if(this._scrollView){var e=this._scrollView.content;if(e){var t=e.getContentSize(),i=this._scrollView.node.getContentSize();if(this._conditionalDisableScrollBar(t,i))return}}this._autoHideRemainingTime=this._autoHideTime}}},{key:"onEnable",value:function(){var e=this.node.getComponent(CL);e&&(this._opacity=e.color.a)}},{key:"start",value:function(){this._enableAutoHide&&this._setOpacity(0)}},{key:"update",value:function(e){this._processAutoHide(e)}},{key:"_convertToScrollViewSpace",value:function(e){if(!this._scrollView)return nF;var t=e.getAnchorPoint(),i=e.getContentSize(),n=new Fi(-t.x*i.width,-t.y*i.height,0);return e.uiTransfromComp.convertToWorldSpaceAR(n,n),t=this._scrollView.node.getAnchorPoint(),i=this._scrollView.node.getContentSize(),n.x+=t.x*i.width,n.y+=t.y*i.height,this._scrollView.node.uiTransfromComp.convertToNodeSpaceAR(n,n),n}},{key:"_setOpacity",value:function(e){if(this._handle){var t=this.node.getComponent(CL);t&&(oF.set(t.color),oF.a=e,t.color=oF),(t=this._handle.getComponent(CL))&&(oF.set(t.color),oF.a=e,t.color=oF)}}},{key:"_updateHanlderPosition",value:function(e){if(this._handle){var t=this._fixupHandlerPosition();this._handle.node.setPosition(e.x+t.x,e.y+t.y,t.z)}}},{key:"_fixupHandlerPosition",value:function(){var e=this.node.getContentSize(),t=this.node.getAnchorPoint(),i=this.handle.node.getContentSize(),n=this.handle.node.parent;Fi.set(rF,-e.width*t.x,-e.height*t.y,0);var r=this.node.uiTransfromComp.convertToWorldSpaceAR(rF,aF),a=new Fi;return n.uiTransfromComp.convertToNodeSpaceAR(r,a),this.direction===tF.HORIZONTAL?a=new Fi(a.x,a.y+(e.height-i.height)/2,0):this.direction===tF.VERTICAL&&(a=new Fi(a.x+(e.width-i.width)/2,a.y,0)),this.handle.node.setPosition(a),a}},{key:"_conditionalDisableScrollBar",value:function(e,t){return e.width<=t.width&&this._direction===tF.HORIZONTAL||e.height<=t.height&&this._direction===tF.VERTICAL}},{key:"_calculateLength",value:function(e,t,i,n){var r=e;return n&&(r+=20*(0<n?n:-n)),i*(t/r)}},{key:"_calculatePosition",value:function(e,t,i,n,r,a){var s=e-t;r&&(s+=Math.abs(r));var o=0;s&&(o=_i(o=n/s));var l=(i-a)*o;return this._direction===tF.VERTICAL?new Fi(0,l,0):new Fi(l,0,0)}},{key:"_updateLength",value:function(e){if(this._handle){var t=this._handle.node,i=t.getContentSize(),n=t.getAnchorPoint();n.x===sF.x&&n.y===sF.y||t.setAnchorPoint(sF),this._direction===tF.HORIZONTAL?t.setContentSize(e,i.height):t.setContentSize(i.width,e)}}},{key:"_processAutoHide",value:function(e){if(this._enableAutoHide&&!(this._autoHideRemainingTime<=0)&&!this._touching&&(this._autoHideRemainingTime-=e,this._autoHideRemainingTime<=this._autoHideTime)){this._autoHideRemainingTime=Math.max(0,this._autoHideRemainingTime);var t=this._opacity*(this._autoHideRemainingTime/this._autoHideTime);this._setOpacity(t)}}},{key:"handle",get:function(){return this._handle},set:function(e){this._handle!==e&&(this._handle=e,this.onScroll(new Fi(0,0,0)))}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this.onScroll(new Fi))}},{key:"enableAutoHide",get:function(){return this._enableAutoHide},set:function(e){this._enableAutoHide!==e&&(this._enableAutoHide=e,this._enableAutoHide&&this._setOpacity(0))}},{key:"autoHideTime",get:function(){return this._autoHideTime},set:function(e){this._autoHideTime!==e&&(this._autoHideTime=e)}}]),a}(),JD.Direction=tF,m((WD=$D).prototype,"handle",[HD],Object.getOwnPropertyDescriptor(WD.prototype,"handle"),WD.prototype),m(WD.prototype,"direction",[qD],Object.getOwnPropertyDescriptor(WD.prototype,"direction"),WD.prototype),m(WD.prototype,"enableAutoHide",[fo],Object.getOwnPropertyDescriptor(WD.prototype,"enableAutoHide"),WD.prototype),m(WD.prototype,"autoHideTime",[fo],Object.getOwnPropertyDescriptor(WD.prototype,"autoHideTime"),WD.prototype),XD=m(WD.prototype,"_scrollView",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),YD=m(WD.prototype,"_handle",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),QD=m(WD.prototype,"_direction",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return tF.HORIZONTAL}}),KD=m(WD.prototype,"_enableAutoHide",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ZD=m(WD.prototype,"_autoHideTime",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),jD=WD))||jD)||jD)||jD));cc.ScrollBarComponent=cF;var uF,hF,fF,dF,pF,_F,vF,mF,yF,gF,bF,xF,SF,wF,TF,EF,CF,AF,kF,RF,OF,MF,IF,LF=P2("ViewGroupComponent",ho("cc.ViewGroupComponent")(lF=go(110)(lF=function(){function e(){return y(this,e),x(this,g(e).apply(this,arguments))}return p(e,Bv),e}())||lF)||lF);cc.ViewGroupComponent=LF;function zF(){return(new Date).getMilliseconds()}var BF,PF,DF=U_,FF=1e-4,NF=new Fi,UF=new Fi;(PF=BF=BF||{})[PF.SCROLL_TO_TOP=0]="SCROLL_TO_TOP",PF[PF.SCROLL_TO_BOTTOM=1]="SCROLL_TO_BOTTOM",PF[PF.SCROLL_TO_LEFT=2]="SCROLL_TO_LEFT",PF[PF.SCROLL_TO_RIGHT=3]="SCROLL_TO_RIGHT",PF[PF.SCROLLING=4]="SCROLLING",PF[PF.BOUNCE_TOP=5]="BOUNCE_TOP",PF[PF.BOUNCE_BOTTOM=6]="BOUNCE_BOTTOM",PF[PF.BOUNCE_LEFT=7]="BOUNCE_LEFT",PF[PF.BOUNCE_RIGHT=8]="BOUNCE_RIGHT",PF[PF.SCROLL_ENDED=9]="SCROLL_ENDED",PF[PF.TOUCH_UP=10]="TOUCH_UP",PF[PF.AUTOSCROLL_ENDED_WITH_THRESHOLD=11]="AUTOSCROLL_ENDED_WITH_THRESHOLD",PF[PF.SCROLL_BEGAN=12]="SCROLL_BEGAN",mt(BF);var VF,GF,HF,qF,jF,WF,XF,YF,QF,KF,ZF,JF,$F,eN,tN,iN={"scroll-to-top":BF.SCROLL_TO_TOP,"scroll-to-bottom":BF.SCROLL_TO_BOTTOM,"scroll-to-left":BF.SCROLL_TO_LEFT,"scroll-to-right":BF.SCROLL_TO_RIGHT,scrolling:BF.SCROLLING,"bounce-bottom":BF.BOUNCE_BOTTOM,"bounce-left":BF.BOUNCE_LEFT,"bounce-right":BF.BOUNCE_RIGHT,"bounce-top":BF.BOUNCE_TOP,"scroll-ended":BF.SCROLL_ENDED,"touch-up":BF.TOUCH_UP,"scroll-ended-with-threshold":BF.AUTOSCROLL_ENDED_WITH_THRESHOLD,"scroll-began":BF.SCROLL_BEGAN},nN=P2("ScrollViewComponent",(uF=ho("cc.ScrollViewComponent"),hF=go(110),fF=yo("UI/ScrollView"),dF=fo({type:Sm}),pF=fo({type:cF}),_F=fo({type:cF}),vF=fo({range:[0,1,.1]}),mF=fo({range:[0,10]}),uF(yF=hF(yF=fF((IF=MF=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"horizontal",bF,u(t)),v(t,"vertical",xF,u(t)),v(t,"inertia",SF,u(t)),v(t,"brake",wF,u(t)),v(t,"elastic",TF,u(t)),v(t,"bounceDuration",EF,u(t)),v(t,"scrollEvents",CF,u(t)),v(t,"cancelInnerEvents",AF,u(t)),t._autoScrolling=!1,t._scrolling=!1,v(t,"_content",kF,u(t)),v(t,"_horizontalScrollBar",RF,u(t)),v(t,"_verticalScrollBar",OF,u(t)),t._topBoundary=0,t._bottomBoundary=0,t._leftBoundary=0,t._rightBoundary=0,t._touchMoveDisplacements=[],t._touchMoveTimeDeltas=[],t._touchMovePreviousTimestamp=0,t._touchMoved=!1,t._autoScrollAttenuate=!1,t._autoScrollStartPosition=new Fi,t._autoScrollTargetDelta=new Fi,t._autoScrollTotalTime=0,t._autoScrollAccumulatedTime=0,t._autoScrollCurrentlyOutOfBoundary=!1,t._autoScrollBraking=!1,t._autoScrollBrakingStartPosition=new Fi,t._outOfBoundaryAmount=new Fi,t._outOfBoundaryAmountDirty=!0,t._stopMouseWheel=!1,t._mouseWheelEventElapsedTime=0,t._isScrollEndedWithThresholdEventFired=!1,t._scrollEventEmitMask=0,t._isBouncing=!1,t._contentPos=new Fi,t._deltaPos=new Fi,t}return p(a,LF),l(a,[{key:"scrollToBottom",value:function(e,t){var i=this._calculateMovePercentDelta({anchor:new Mi(0,0),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i,!0)}},{key:"scrollToTop",value:function(e,t){var i=this._calculateMovePercentDelta({anchor:new Mi(0,1),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToLeft",value:function(e,t){var i=this._calculateMovePercentDelta({anchor:new Mi(0,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToRight",value:function(e,t){var i=this._calculateMovePercentDelta({anchor:new Mi(1,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToTopLeft",value:function(e,t){var i=this._calculateMovePercentDelta({anchor:new Mi(0,1),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToTopRight",value:function(e,t){var i=this._calculateMovePercentDelta({anchor:new Mi(1,1),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToBottomLeft",value:function(e,t){var i=this._calculateMovePercentDelta({anchor:new Mi(0,0),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToBottomRight",value:function(e,t){var i=this._calculateMovePercentDelta({anchor:new Mi(1,0),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToOffset",value:function(e,t,i){var n=this.getMaxScrollOffset(),r=new Mi(0,0);0===n.x?r.x=0:r.x=e.x/n.x,0===n.y?r.y=1:r.y=(n.y-e.y)/n.y,this.scrollTo(r,t,i)}},{key:"getScrollOffset",value:function(){var e=this._getContentTopBoundary()-this._topBoundary,t=this._getContentLeftBoundary()-this._leftBoundary;return new Fi(t,e,0)}},{key:"getMaxScrollOffset",value:function(){var e=this.node.getContentSize(),t=this._content.getContentSize(),i=t.width-e.width,n=t.height-e.height;return new Fi(i=0<=i?i:0,n=0<=n?n:0,0)}},{key:"scrollToPercentHorizontal",value:function(e,t,i){var n=this._calculateMovePercentDelta({anchor:new Mi(e,0),applyToHorizontal:!0,applyToVertical:!1});t?this._startAutoScroll(n,t,!1!==i):this._moveContent(n)}},{key:"scrollTo",value:function(e,t,i){var n=this._calculateMovePercentDelta({anchor:new Mi(e),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(n,t,i):this._moveContent(n)}},{key:"scrollToPercentVertical",value:function(e,t,i){var n=this._calculateMovePercentDelta({anchor:new Mi(0,e),applyToHorizontal:!1,applyToVertical:!0});t?this._startAutoScroll(n,t,i):this._moveContent(n)}},{key:"stopAutoScroll",value:function(){this._autoScrolling=!1,this._autoScrollAccumulatedTime=this._autoScrollTotalTime}},{key:"setContentPosition",value:function(e){e.equals(this.getContentPosition(),FF)||(this._content.setPosition(e),this._outOfBoundaryAmountDirty=!0)}},{key:"getContentPosition",value:function(){return this._content?(this._content.getPosition(this._contentPos),this._contentPos):NF}},{key:"isScrolling",value:function(){return this._scrolling}},{key:"isAutoScrolling",value:function(){return this._autoScrolling}},{key:"getScrollEndedEventTiming",value:function(){return FF}},{key:"start",value:function(){this._calculateBoundary(),this._content&&Yb.once(Xb.EVENT_BEFORE_DRAW,this._adjustContentOutOfBoundary,this)}},{key:"onEnable",value:function(){this._registerEvent(),this.content&&(this.content.on(DF.SIZE_CHANGED,this._calculateBoundary,this),this.content.on(DF.SCALE_PART,this._calculateBoundary,this),this.view&&(this.view.on(DF.POSITION_PART,this._calculateBoundary,this),this.view.on(DF.SCALE_PART,this._calculateBoundary,this),this.view.on(DF.SIZE_CHANGED,this._calculateBoundary,this))),this._showScrollbar()}},{key:"update",value:function(e){this._autoScrolling&&this._processAutoScrolling(e)}},{key:"onDisable",value:function(){this._unregisterEvent(),this.content&&(this.content.off(DF.SIZE_CHANGED,this._calculateBoundary,this),this.content.off(DF.SCALE_PART,this._calculateBoundary,this),this.view&&(this.view.off(DF.POSITION_PART,this._calculateBoundary,this),this.view.off(DF.SCALE_PART,this._calculateBoundary,this),this.view.off(DF.SIZE_CHANGED,this._calculateBoundary,this))),this._hideScrollbar(),this.stopAutoScroll()}},{key:"_registerEvent",value:function(){this.node.on(DF.TOUCH_START,this._onTouchBegan,this,!0),this.node.on(DF.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.on(DF.TOUCH_END,this._onTouchEnded,this,!0),this.node.on(DF.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.on(DF.MOUSE_WHEEL,this._onMouseWheel,this,!0)}},{key:"_unregisterEvent",value:function(){this.node.off(DF.TOUCH_START,this._onTouchBegan,this,!0),this.node.off(DF.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.off(DF.TOUCH_END,this._onTouchEnded,this,!0),this.node.off(DF.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.off(DF.MOUSE_WHEEL,this._onMouseWheel,this,!0)}},{key:"_onMouseWheel",value:function(e,t){if(this.enabledInHierarchy&&!this._hasNestedViewGroup(e,t)){var i=new Fi;this.vertical?i=new Fi(0,-.1*e.getScrollY(),0):this.horizontal&&(i=new Fi(-.1*e.getScrollY(),0,0)),this._mouseWheelEventElapsedTime=0,this._processDeltaMove(i),this._stopMouseWheel||(this._handlePressLogic(),this.schedule(this._checkMouseWheel,1/60,NaN,0),this._stopMouseWheel=!0),this._stopPropagationIfTargetIsMe(e)}}},{key:"_onTouchBegan",value:function(e,t){this.enabledInHierarchy&&this._content&&(this._hasNestedViewGroup(e,t)||(this._content&&this._handlePressLogic(),this._touchMoved=!1,this._stopPropagationIfTargetIsMe(e)))}},{key:"_onTouchMoved",value:function(e,t){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(e,t)&&e&&e.touch){var i=e.touch;if(this._content&&this._handleMoveLogic(i),this.cancelInnerEvents){var n=new Mi(i.getUILocation());if(n.subtract(i.getStartLocation()),7<n.length()&&!this._touchMoved&&e.target!==this.node){var r=new Kp(e.getTouches(),e.bubbles);r.type=DF.TOUCH_CANCEL,r.touch=e.touch,r.simulate=!0,e.target.dispatchEvent(r),this._touchMoved=!0}this._stopPropagationIfTargetIsMe(e)}}}},{key:"_onTouchEnded",value:function(e,t){if(this.enabledInHierarchy&&this._content&&e&&!this._hasNestedViewGroup(e,t)){this._dispatchEvent("touch-up");var i=e.touch;this._content&&this._handleReleaseLogic(i),this._touchMoved?e.propagationStopped=!0:this._stopPropagationIfTargetIsMe(e)}}},{key:"_onTouchCancelled",value:function(e,t){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(e,t)){if(e&&!e.simulate){var i=e.touch;this._content&&this._handleReleaseLogic(i)}this._stopPropagationIfTargetIsMe(e)}}},{key:"_calculateBoundary",value:function(){if(this.content){var e=this.content.getComponent(CP);e&&e.enabledInHierarchy&&e.updateLayout();var t=this.view.getContentSize(),i=t.width*this.view.anchorX,n=t.height*this.view.anchorY;this._leftBoundary=-i,this._bottomBoundary=-n,this._rightBoundary=this._leftBoundary+t.width,this._topBoundary=this._bottomBoundary+t.height,this._moveContentToTopLeft(t)}}},{key:"_hasNestedViewGroup",value:function(e,t){if(e&&e.eventPhase===$o.CAPTURING_PHASE){if(t){var i=t,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;if(this.node===s)return!(!e.target||!e.target.getComponent(LF));if(s.getComponent(LF))return!0}}return!1}}},{key:"_handleReleaseLogic",value:function(e){var t=e.getUIDelta();Fi.set(this._deltaPos,t.x,t.y,0),this._gatherTouchMove(this._deltaPos),this._processInertiaScroll(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent("scroll-ended"))}},{key:"_startInertiaScroll",value:function(e){var t=new Fi(e);t.multiplyScalar(.7),this._startAttenuatingAutoScroll(t,e)}},{key:"_calculateAttenuatedFactor",value:function(e){return this.brake<=0?1-this.brake:(1-this.brake)*(1/(1+14e-6*e+e*e*8e-9))}},{key:"_startAttenuatingAutoScroll",value:function(e,t){var i=this._calculateAutoScrollTimeByInitalSpeed(t.length()),n=new Fi(e);n.normalize();var r=this._content.getContentSize(),a=this.node.getContentSize(),s=r.width-a.width,o=r.height-a.height,l=this._calculateAttenuatedFactor(s),c=this._calculateAttenuatedFactor(o);n.x=n.x*s*(1-this.brake)*l,n.y=n.y*o*c*(1-this.brake),n.z=0;var u=e.length(),h=n.length()/u;if(n.add(e),0<this.brake&&7<h){h=Math.sqrt(h);var f=new Fi(e);f.multiplyScalar(h),n.set(f),n.add(e)}0<this.brake&&3<h&&(i*=h=3),0===this.brake&&1<h&&(i*=h),this._startAutoScroll(n,i,!0)}},{key:"_calculateAutoScrollTimeByInitalSpeed",value:function(e){return Math.sqrt(Math.sqrt(e/5))}},{key:"_startAutoScroll",value:function(e,t,i){var n=2<arguments.length&&void 0!==i&&i,r=this._flattenVectorByDirection(e);this._autoScrolling=!0,this._autoScrollTargetDelta=r,this._autoScrollAttenuate=n,Fi.copy(this._autoScrollStartPosition,this.getContentPosition()),this._autoScrollTotalTime=t,this._autoScrollAccumulatedTime=0,this._autoScrollBraking=!1,this._isScrollEndedWithThresholdEventFired=!1,this._autoScrollBrakingStartPosition=new Fi,this._getHowMuchOutOfBoundary().equals(NF,FF)||(this._autoScrollCurrentlyOutOfBoundary=!0)}},{key:"_calculateTouchMoveVelocity",value:function(){var e=0;if((e=this._touchMoveTimeDeltas.reduce(function(e,t){return e+t},e))<=0||.5<=e)return new Fi;var t=new Fi;return t=this._touchMoveDisplacements.reduce(function(e,t){return e.add(t),e},t),new Fi(t.x*(1-this.brake)/e,t.y*(1-this.brake)/e,0)}},{key:"_flattenVectorByDirection",value:function(e){var t=e;return t.x=this.horizontal?t.x:0,t.y=this.vertical?t.y:0,t}},{key:"_moveContent",value:function(e,t){var i=this._flattenVectorByDirection(e);UF.set(this.getContentPosition()),UF.add(i),this.setContentPosition(UF);var n=this._getHowMuchOutOfBoundary();this._updateScrollBar(n),this.elastic&&t&&this._startBounceBackIfNeeded()}},{key:"_getContentLeftBoundary",value:function(){return this.getContentPosition().x-this._content.getAnchorPoint().x*this._content.getContentSize().width}},{key:"_getContentRightBoundary",value:function(){var e=this._content.getContentSize();return this._getContentLeftBoundary()+e.width}},{key:"_getContentTopBoundary",value:function(){var e=this._content.getContentSize();return this._getContentBottomBoundary()+e.height}},{key:"_getContentBottomBoundary",value:function(){return this.getContentPosition().y-this._content.getAnchorPoint().y*this._content.getContentSize().height}},{key:"_getHowMuchOutOfBoundary",value:function(e){if((e=e||new Fi).equals(NF,FF)&&!this._outOfBoundaryAmountDirty)return this._outOfBoundaryAmount;var t=new Fi;return this._getContentLeftBoundary()+e.x>this._leftBoundary?t.x=this._leftBoundary-(this._getContentLeftBoundary()+e.x):this._getContentRightBoundary()+e.x<this._rightBoundary&&(t.x=this._rightBoundary-(this._getContentRightBoundary()+e.x)),this._getContentTopBoundary()+e.y<this._topBoundary?t.y=this._topBoundary-(this._getContentTopBoundary()+e.y):this._getContentBottomBoundary()+e.y>this._bottomBoundary&&(t.y=this._bottomBoundary-(this._getContentBottomBoundary()+e.y)),e.equals(NF,FF)&&(this._outOfBoundaryAmount=t,this._outOfBoundaryAmountDirty=!1),t=this._clampDelta(t)}},{key:"_updateScrollBar",value:function(e){this._horizontalScrollBar&&this._horizontalScrollBar.onScroll(e),this.verticalScrollBar&&this.verticalScrollBar.onScroll(e)}},{key:"_onScrollBarTouchBegan",value:function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchBegan(),this.verticalScrollBar&&this.verticalScrollBar.onTouchBegan()}},{key:"_onScrollBarTouchEnded",value:function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchEnded(),this.verticalScrollBar&&this.verticalScrollBar.onTouchEnded()}},{key:"_dispatchEvent",value:function(e){if("scroll-ended"===e)this._scrollEventEmitMask=0;else if("scroll-to-top"===e||"scroll-to-bottom"===e||"scroll-to-left"===e||"scroll-to-right"===e){var t=1<<iN[e];if(this._scrollEventEmitMask&t)return;this._scrollEventEmitMask|=t}kT.emitEvents(this.scrollEvents,this,iN[e]),this.node.emit(e,this)}},{key:"_adjustContentOutOfBoundary",value:function(){if(this._content&&(this._outOfBoundaryAmountDirty=!0,this._isOutOfBoundary())){var e=this._getHowMuchOutOfBoundary(new Fi),t=new Fi(this.getContentPosition());t.add(e),this._content&&(this._content.setPosition(t),this._updateScrollBar(NF))}}},{key:"_hideScrollbar",value:function(){this._horizontalScrollBar&&this._horizontalScrollBar.hide(),this.verticalScrollBar&&this.verticalScrollBar.hide()}},{key:"_showScrollbar",value:function(){this._horizontalScrollBar&&this._horizontalScrollBar.show(),this.verticalScrollBar&&this.verticalScrollBar.show()}},{key:"_stopPropagationIfTargetIsMe",value:function(e){e&&e.eventPhase===$o.AT_TARGET&&e.target===this.node&&(e.propagationStopped=!0)}},{key:"_processDeltaMove",value:function(e){this._scrollChildren(e),this._gatherTouchMove(e)}},{key:"_handleMoveLogic",value:function(e){var t=e.getUIDelta();Fi.set(this._deltaPos,t.x,t.y,0),this._processDeltaMove(this._deltaPos)}},{key:"_scrollChildren",value:function(e){var t,i=e=this._clampDelta(e);this.elastic&&(t=this._getHowMuchOutOfBoundary(),i.x*=0===t.x?1:.5,i.y*=0===t.y?1:.5),this.elastic||(t=this._getHowMuchOutOfBoundary(i),i.add(t));var n="",r=new Fi;if(this._content.getPosition(r),0<i.y)r.y-this._content.anchorY*this._content.height+i.y>this._bottomBoundary&&(n="scroll-to-bottom");else if(i.y<0){r.y-this._content.anchorY*this._content.height+this._content.height+i.y<=this._topBoundary&&(n="scroll-to-top")}else if(i.x<0){r.x-this._content.anchorX*this._content.width+this._content.width+i.x<=this._rightBoundary&&(n="scroll-to-right")}else if(0<i.x){r.x-this._content.anchorX*this._content.width+i.x>=this._leftBoundary&&(n="scroll-to-left")}this._moveContent(i,!1),0===i.x&&0===i.y||(this._scrolling||(this._scrolling=!0,this._dispatchEvent("scroll-began")),this._dispatchEvent("scrolling")),0<n.length&&this._dispatchEvent(n)}},{key:"_handlePressLogic",value:function(){this._autoScrolling&&this._dispatchEvent("scroll-ended"),this._autoScrolling=!1,this._isBouncing=!1,this._touchMovePreviousTimestamp=zF(),this._touchMoveDisplacements.length=0,this._touchMoveTimeDeltas.length=0,this._onScrollBarTouchBegan()}},{key:"_clampDelta",value:function(e){var t=this._content.getContentSize(),i=this.node.getContentSize();return t.width<i.width&&(e.x=0),t.height<i.height&&(e.y=0),e}},{key:"_gatherTouchMove",value:function(e){for(e=this._clampDelta(e);5<=this._touchMoveDisplacements.length;)this._touchMoveDisplacements.shift(),this._touchMoveTimeDeltas.shift();this._touchMoveDisplacements.push(e);var t=zF();this._touchMoveTimeDeltas.push((t-this._touchMovePreviousTimestamp)/1e3),this._touchMovePreviousTimestamp=t}},{key:"_startBounceBackIfNeeded",value:function(){if(!this.elastic)return!1;var e=this._getHowMuchOutOfBoundary();if((e=this._clampDelta(e)).equals(NF,FF))return!1;var t=Math.max(this.bounceDuration,0);return this._startAutoScroll(e,t,!0),this._isBouncing||(0<e.y&&this._dispatchEvent("bounce-top"),e.y<0&&this._dispatchEvent("bounce-bottom"),0<e.x&&this._dispatchEvent("bounce-right"),e.x<0&&this._dispatchEvent("bounce-left"),this._isBouncing=!0),!0}},{key:"_processInertiaScroll",value:function(){if(!this._startBounceBackIfNeeded()&&this.inertia){var e=this._calculateTouchMoveVelocity();!e.equals(UF,FF)&&this.brake<1&&this._startInertiaScroll(e)}this._onScrollBarTouchEnded()}},{key:"_isOutOfBoundary",value:function(){return!this._getHowMuchOutOfBoundary().equals(NF,FF)}},{key:"_isNecessaryAutoScrollBrake",value:function(){if(this._autoScrollBraking)return!0;if(this._isOutOfBoundary()){if(!this._autoScrollCurrentlyOutOfBoundary)return this._autoScrollCurrentlyOutOfBoundary=!0,this._autoScrollBraking=!0,this._autoScrollBrakingStartPosition=this.getContentPosition(),!0}else this._autoScrollCurrentlyOutOfBoundary=!1;return!1}},{key:"_processAutoScrolling",value:function(e){var t=this._isNecessaryAutoScrollBrake(),i=t?.05:1;this._autoScrollAccumulatedTime+=e*(1/i);var n=Math.min(1,this._autoScrollAccumulatedTime/this._autoScrollTotalTime);this._autoScrollAttenuate&&(n=function(e){return(e-=1)*e*e*e*e+1}(n));var r=new Fi(this._autoScrollTargetDelta);r.multiplyScalar(n);var a=new Fi(this._autoScrollStartPosition);a.add(r);var s=Math.abs(n-1)<=FF;if(Math.abs(n-1)<=this.getScrollEndedEventTiming()&&!this._isScrollEndedWithThresholdEventFired&&(this._dispatchEvent("scroll-ended-with-threshold"),this._isScrollEndedWithThresholdEventFired=!0),this.elastic){var o=new Fi(a);o.subtract(this._autoScrollBrakingStartPosition),t&&o.multiplyScalar(i),a.set(this._autoScrollBrakingStartPosition),a.add(o)}else{var l=new Fi(a);l.subtract(this.getContentPosition());var c=this._getHowMuchOutOfBoundary(l);c.equals(NF,FF)||(a.add(c),s=!0)}s&&(this._autoScrolling=!1);var u=new Fi(a);u.subtract(this.getContentPosition()),this._moveContent(this._clampDelta(u),s),this._dispatchEvent("scrolling"),this._autoScrolling||(this._isBouncing=!1,this._scrolling=!1,this._dispatchEvent("scroll-ended"))}},{key:"_checkMouseWheel",value:function(e){if(!this._getHowMuchOutOfBoundary().equals(NF,FF))return this._processInertiaScroll(),this.unschedule(this._checkMouseWheel),void(this._stopMouseWheel=!1);this._mouseWheelEventElapsedTime+=e,.1<this._mouseWheelEventElapsedTime&&(this._onScrollBarTouchEnded(),this.unschedule(this._checkMouseWheel),this._stopMouseWheel=!1)}},{key:"_calculateMovePercentDelta",value:function(e){var t=e.anchor,i=e.applyToHorizontal,n=e.applyToVertical;this._calculateBoundary(),t.clampf(new Mi(0,0),new Mi(1,1));var r=this.node.getContentSize(),a=this._content.getContentSize(),s=this._getContentBottomBoundary()-this._bottomBoundary;s=-s;var o=this._getContentLeftBoundary()-this._leftBoundary;o=-o;var l=new Fi,c=0;return i&&(c=a.width-r.width,l.x=o-c*t.x),n&&(c=a.height-r.height,l.y=s-c*t.y),l}},{key:"_moveContentToTopLeft",value:function(e){var t=this._content.getContentSize(),i=this._getContentBottomBoundary()-this._bottomBoundary;i=-i;var n=new Fi,r=0,a=this._getContentLeftBoundary()-this._leftBoundary;a=-a,t.height<e.height?(r=t.height-e.height,n.y=i-r,this.verticalScrollBar&&this.verticalScrollBar.hide()):this.verticalScrollBar&&this.verticalScrollBar.show(),t.width<e.width?(r=t.width-e.width,n.x=a,this._horizontalScrollBar&&this._horizontalScrollBar.hide()):this._horizontalScrollBar&&this._horizontalScrollBar.show(),this._moveContent(n),this._adjustContentOutOfBoundary()}},{key:"content",get:function(){return this._content},set:function(e){this._content!==e&&(this._content=e,this._calculateBoundary())}},{key:"horizontalScrollBar",get:function(){return this._horizontalScrollBar},set:function(e){this._horizontalScrollBar!==e&&(this._horizontalScrollBar=e,this._horizontalScrollBar&&(this._horizontalScrollBar.setScrollView(this),this._updateScrollBar(NF)))}},{key:"verticalScrollBar",get:function(){return this._verticalScrollBar},set:function(e){this._verticalScrollBar!==e&&(this._verticalScrollBar=e,this._verticalScrollBar&&(this._verticalScrollBar.setScrollView(this),this._updateScrollBar(NF)))}},{key:"view",get:function(){return this._content?this._content.parent:null}}]),a}(),MF.EventType=BF,m((gF=IF).prototype,"content",[dF],Object.getOwnPropertyDescriptor(gF.prototype,"content"),gF.prototype),m(gF.prototype,"horizontalScrollBar",[pF],Object.getOwnPropertyDescriptor(gF.prototype,"horizontalScrollBar"),gF.prototype),m(gF.prototype,"verticalScrollBar",[_F],Object.getOwnPropertyDescriptor(gF.prototype,"verticalScrollBar"),gF.prototype),bF=m(gF.prototype,"horizontal",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),xF=m(gF.prototype,"vertical",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),SF=m(gF.prototype,"inertia",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),wF=m(gF.prototype,"brake",[vF],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),TF=m(gF.prototype,"elastic",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),EF=m(gF.prototype,"bounceDuration",[mF],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),CF=m(gF.prototype,"scrollEvents",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),AF=m(gF.prototype,"cancelInnerEvents",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),kF=m(gF.prototype,"_content",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),RF=m(gF.prototype,"_horizontalScrollBar",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),OF=m(gF.prototype,"_verticalScrollBar",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),yF=gF))||yF)||yF)||yF));cc.ScrollViewComponent=nN;var rN,aN,sN=new Fi;(aN=rN=rN||{})[aN.Horizontal=0]="Horizontal",aN[aN.Vertical=1]="Vertical",mt(rN);var oN,lN,cN,uN,hN,fN,dN,pN,_N=P2("SliderComponent",(VF=ho("cc.SliderComponent"),GF=go(110),HF=yo("UI/Slider"),qF=fo({type:CL}),jF=fo({type:rN}),WF=fo({slide:!0,range:[0,1,.01]}),XF=fo({type:kT}),VF(YF=GF(YF=HF((tN=eN=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"slideEvents",KF,u(t)),v(t,"_handle",ZF,u(t)),v(t,"_direction",JF,u(t)),v(t,"_progress",$F,u(t)),t._offset=new Fi,t._dragging=!1,t._touchHandle=!1,t._handlelocalPos=new Fi,t._touchPos=new Fi,t}return p(a,Bv),l(a,[{key:"__preload",value:function(){this._updateHandlePosition()}},{key:"onEnable",value:function(){this._updateHandlePosition(),this.node.on(U_.TOUCH_START,this._onTouchBegan,this),this.node.on(U_.TOUCH_MOVE,this._onTouchMoved,this),this.node.on(U_.TOUCH_END,this._onTouchEnded,this),this.node.on(U_.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.on(U_.TOUCH_START,this._onHandleDragStart,this),this._handle.node.on(U_.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.on(U_.TOUCH_END,this._onTouchEnded,this))}},{key:"onDisable",value:function(){this.node.off(U_.TOUCH_START,this._onTouchBegan,this),this.node.off(U_.TOUCH_MOVE,this._onTouchMoved,this),this.node.off(U_.TOUCH_END,this._onTouchEnded,this),this.node.off(U_.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.off(U_.TOUCH_START,this._onHandleDragStart,this),this._handle.node.off(U_.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.off(U_.TOUCH_END,this._onTouchEnded,this))}},{key:"_onHandleDragStart",value:function(e){if(e&&this._handle&&this._handle.node.uiTransfromComp){this._dragging=!0,this._touchHandle=!0;var t=e.touch.getUILocation();Fi.set(this._touchPos,t.x,t.y,0),this._handle.node.uiTransfromComp.convertToNodeSpaceAR(this._touchPos,this._offset),e.propagationStopped=!0}}},{key:"_onTouchBegan",value:function(e){this._handle&&e&&(this._dragging=!0,this._touchHandle||this._handleSliderLogic(e.touch),e.propagationStopped=!0)}},{key:"_onTouchMoved",value:function(e){this._dragging&&e&&(this._handleSliderLogic(e.touch),e.propagationStopped=!0)}},{key:"_onTouchEnded",value:function(e){this._dragging=!1,this._touchHandle=!1,this._offset=new Fi,e&&(e.propagationStopped=!0)}},{key:"_onTouchCancelled",value:function(e){this._dragging=!1,e&&(e.propagationStopped=!0)}},{key:"_handleSliderLogic",value:function(e){this._updateProgress(e),this._emitSlideEvent()}},{key:"_emitSlideEvent",value:function(){kT.emitEvents(this.slideEvents,this),this.node.emit("slide",this)}},{key:"_updateProgress",value:function(e){if(this._handle&&e){var t=e.getUILocation();Fi.set(this._touchPos,t.x,t.y,0);var i=this.node.uiTransfromComp.convertToNodeSpaceAR(this._touchPos,sN);this.direction===rN.Horizontal?this.progress=_i(.5+(i.x-this._offset.x)/this.node.width):this.progress=_i(.5+(i.y-this._offset.y)/this.node.height)}}},{key:"_updateHandlePosition",value:function(){this._handle&&(this._handlelocalPos.set(this._handle.node.getPosition()),this._direction===rN.Horizontal?this._handlelocalPos.x=-this.node.width*this.node.anchorX+this.progress*this.node.width:this._handlelocalPos.y=-this.node.height*this.node.anchorY+this.progress*this.node.height,this._handle.node.setPosition(this._handlelocalPos))}},{key:"_changeLayout",value:function(){var e=this.node.getContentSize();if(this.node.setContentSize(e.height,e.width),this._handle){var t=this._handle.node.position;this._direction===rN.Horizontal?this._handle.node.setPosition(t.x,0,t.z):this._handle.node.setPosition(0,t.y,t.z),this._updateHandlePosition()}}},{key:"handle",get:function(){return this._handle},set:function(e){this._handle!==e&&(this._handle=e)}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this._changeLayout())}},{key:"progress",get:function(){return this._progress},set:function(e){this._progress!==e&&(this._progress=e,this._updateHandlePosition())}}]),a}(),eN.Direction=rN,m((QF=tN).prototype,"handle",[qF],Object.getOwnPropertyDescriptor(QF.prototype,"handle"),QF.prototype),m(QF.prototype,"direction",[jF],Object.getOwnPropertyDescriptor(QF.prototype,"direction"),QF.prototype),m(QF.prototype,"progress",[WF],Object.getOwnPropertyDescriptor(QF.prototype,"progress"),QF.prototype),KF=m(QF.prototype,"slideEvents",[XF],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ZF=m(QF.prototype,"_handle",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),JF=m(QF.prototype,"_direction",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rN.Horizontal}}),$F=m(QF.prototype,"_progress",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),YF=QF))||YF)||YF)||YF));cc.SliderComponent=_N;var vN,mN,yN,gN,bN,xN,SN,wN,TN,EN,CN,AN,kN=P2("ToggleContainerComponent",(oN=ho("cc.ToggleContainerComponent"),lN=go(110),cN=yo("UI/ToggleContainer"),uN=fo({type:kT}),oN(hN=lN(hN=cN(hN=vo((dN=m((fN=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"checkEvents",dN,u(t)),v(t,"_allowSwitchOff",pN,u(t)),t._toggleItems=[],t}return p(a,Bv),l(a,[{key:"start",value:function(){this._makeAtLeastOneToggleChecked()}},{key:"updateToggles",value:function(t){this.enabledInHierarchy&&t.isChecked&&(this.toggleItems.forEach(function(e){e!==t&&e.isChecked&&e.enabled&&(e.isChecked=!1)}),this.checkEvents&&kT.emitEvents(this.checkEvents,t))}},{key:"addToggle",value:function(e){-1===this._toggleItems.indexOf(e)&&this._toggleItems.push(e),this._allowOnlyOneToggleChecked()}},{key:"removeToggle",value:function(e){var t=this._toggleItems.indexOf(e);-1<t&&this._toggleItems.splice(t,1),this._makeAtLeastOneToggleChecked()}},{key:"_allowOnlyOneToggleChecked",value:function(){var t=!1;return this._toggleItems.forEach(function(e){t&&e.enabled&&(e.isChecked=!1),e.isChecked&&e.enabled&&(t=!0)}),t}},{key:"_makeAtLeastOneToggleChecked",value:function(){this._allowOnlyOneToggleChecked()||this._allowSwitchOff||0<this._toggleItems.length&&(this._toggleItems[0].isChecked=!0)}},{key:"allowSwitchOff",get:function(){return this._allowSwitchOff},set:function(e){this._allowSwitchOff=e}},{key:"toggleItems",get:function(){return this._toggleItems}}]),a}()).prototype,"checkEvents",[uN],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),pN=m(fN.prototype,"_allowSwitchOff",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),m(fN.prototype,"allowSwitchOff",[fo],Object.getOwnPropertyDescriptor(fN.prototype,"allowSwitchOff"),fN.prototype),hN=fN))||hN)||hN)||hN)||hN));cc.ToggleContainerComponent=kN;var RN,ON=P2("ToggleComponent",(vN=ho("cc.ToggleComponent"),mN=go(110),yN=yo("UI/Toggle"),gN=fo({type:kN}),bN=fo({type:CL}),xN=fo({type:kT}),vN(SN=mN(SN=yN(SN=vo((m((wN=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"checkEvents",TN,u(t)),v(t,"_isChecked",EN,u(t)),v(t,"_toggleGroup",CN,u(t)),v(t,"_checkMark",AN,u(t)),t}return p(a,AL),l(a,[{key:"onEnable",value:function(){_(g(a.prototype),"onEnable",this).call(this),this._registerToggleEvent(),this._toggleGroup&&this._toggleGroup.enabled&&this._toggleGroup.addToggle(this)}},{key:"onDisable",value:function(){_(g(a.prototype),"onDisable",this).call(this),this._unregisterToggleEvent(),this._toggleGroup&&this._toggleGroup.enabled&&this._toggleGroup.removeToggle(this)}},{key:"toggle",value:function(){var e=this.toggleGroup||this._toggleContainer;e&&e.enabled&&this.isChecked&&!e.allowSwitchOff||(this.isChecked=!this.isChecked,e&&e.enabled&&e.updateToggles(this),this._emitToggleEvents())}},{key:"check",value:function(){var e=this.toggleGroup||this._toggleContainer;e&&e.enabled&&this.isChecked&&!e.allowSwitchOff||(this.isChecked=!0,e&&e.enabled&&e.updateToggles(this),this._emitToggleEvents())}},{key:"uncheck",value:function(){var e=this.toggleGroup||this._toggleContainer;e&&e.enabled&&this.isChecked&&!e.allowSwitchOff||(this.isChecked=!1,this._emitToggleEvents())}},{key:"_updateCheckMark",value:function(){this._checkMark&&(this._checkMark.node.active=!!this.isChecked)}},{key:"_registerToggleEvent",value:function(){this.node.on("click",this.toggle,this)}},{key:"_unregisterToggleEvent",value:function(){this.node.off("click",this.toggle,this)}},{key:"_emitToggleEvents",value:function(){this.node.emit("toggle",this),this.checkEvents&&kT.emitEvents(this.checkEvents,this)}},{key:"isChecked",get:function(){return this._isChecked},set:function(e){this._isChecked!==e&&(this._isChecked=e,this._updateCheckMark())}},{key:"toggleGroup",get:function(){return this._toggleGroup},set:function(e){this._toggleGroup!==e&&(this._toggleGroup&&this._toggleGroup.removeToggle(this),this._toggleGroup=e,this._toggleGroup&&this._toggleGroup.enabled&&this._toggleGroup.addToggle(this))}},{key:"checkMark",get:function(){return this._checkMark},set:function(e){this._checkMark!==e&&(this._checkMark=e)}},{key:"_resizeToTarget",set:function(e){e&&this._resizeNodeToTargetNode()}},{key:"_toggleContainer",get:function(){this.node.parent;return null}}]),a}()).prototype,"isChecked",[fo],Object.getOwnPropertyDescriptor(wN.prototype,"isChecked"),wN.prototype),m(wN.prototype,"toggleGroup",[gN],Object.getOwnPropertyDescriptor(wN.prototype,"toggleGroup"),wN.prototype),m(wN.prototype,"checkMark",[bN],Object.getOwnPropertyDescriptor(wN.prototype,"checkMark"),wN.prototype),TN=m(wN.prototype,"checkEvents",[xN],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),EN=m(wN.prototype,"_isChecked",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),CN=m(wN.prototype,"_toggleGroup",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),AN=m(wN.prototype,"_checkMark",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),SN=wN))||SN)||SN)||SN)||SN));cc.ToggleComponent=ON;var MN,IN,LN,zN=P2("UIModelComponent",ho("cc.UIModelComponent")(RN=go(110)(RN=yo("UI/Model")(RN=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))))._modelComponent=null,t}return p(a,SC),l(a,[{key:"onLoad",value:function(){this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent?(this._modelComponent._sceneGetter=Yb.root.ui.getRenderSceneGetter(),this._modelComponent.recreateModel()):console.warn("Use this component on a node（".concat(this.node&&this.node.name,"） that has a model component"))}},{key:"onDestroy",value:function(){this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent&&(this._modelComponent._sceneGetter=null,this._modelComponent.recreateModel())}},{key:"updateAssembler",value:function(e){return!!this._modelComponent&&(e.commitModel.call(e,this,this._modelComponent._getModel(),this._modelComponent.material),!0)}},{key:"update",value:function(){this._fitUIRenderQueue()}},{key:"_fitUIRenderQueue",value:function(){if(this._modelComponent){for(var e=this._modelComponent.sharedMaterials.length,t=0;t<e;t++){var i=this._modelComponent.getMaterial(t);if(null!=i){for(var n=i.passes,r=i.effectAsset,a=i.technique,s=n.length,o=!1,l=0;l<s;l++){if(!n[l].blendState.targets[0].blend)o=!0,n[l].blendState.targets[0].blend=!0,n[l].overridePipelineStates(r.techniques[a].passes[l],{blendState:n[l].blendState})}o&&i._onPassesChange()}}for(var c=0;c<e;c++){var u=this._modelComponent.getMaterial(c);if(null!=u){var h=u.passes,f=Array.isArray(h),d=0;for(h=f?h:h[Symbol.iterator]();;){var p;if(f){if(d>=h.length)break;p=h[d++]}else{if((d=h.next()).done)break;p=d.value}p._priority=Xh.MAX-11}}}}}},{key:"modelComponent",get:function(){return this._modelComponent}}]),a}())||RN)||RN)||RN);cc.UIModelComponent=zN;var BN,PN,DN=new zn;(PN=BN=BN||{})[PN.LOADING=0]="LOADING",PN[PN.LOADED=1]="LOADED",PN[PN.ERROR=2]="ERROR";var FN={devicePixelRatio:!(PN[PN.JS_EVALUATED=3]="JS_EVALUATED"),enableDiv:!1};ul.os===ul.OS_IOS&&(FN.enableDiv=!0),ul.isMobile?ul.browserType===ul.BROWSER_TYPE_FIREFOX&&(FN.enableBG=!0):ul.browserType===ul.BROWSER_TYPE_IE&&(FN.closeHistory=!0);var NN,UN,VN,GN,HN,qN,jN,WN,XN,YN,QN=ho("cc.WebviewImpl")((LN=IN=function(){function n(){y(this,n),this._EventList=new Map,this._visible=!1,this._div=null,this._iframe=null,this._forceUpdate=!0,this._m00=0,this._m01=0,this._m04=0,this._m05=0,this._m12=0,this._m13=0,this._w=0,this._h=0,this._eventListeners={load:function(){},error:function(){}}}return l(n,[{key:"createDomElementIfNeeded",value:function(e,t){this._div?this._updateSize(e,t):this._createNativeControl(e,t)}},{key:"removeDom",value:function(){var e=this._div;e&&(ct(cc.game.container,e)&&cc.game.container.removeChild(e),this._div=null);var t=this._iframe;if(t){var i=this._eventListeners;t.removeEventListener("load",i.load),t.removeEventListener("error",i.error),i.load=null,i.error=null,this._iframe=null}}},{key:"loadURL",value:function(e){var t=this._iframe;if(t){t.src=e;var i=this;t.addEventListener("load",function e(){i._updateVisibility(),t.removeEventListener("load",e)}),this._dispatchEvent(n.EventType.LOADING)}}},{key:"stopLoading",value:function(){L(7800)}},{key:"reload",value:function(){var e=this._iframe;if(e){var t=e.contentWindow;t&&t.location&&t.location.reload()}}},{key:"canGoBack",value:function(){return L(7801),!0}},{key:"canGoForward",value:function(){return L(7802),!0}},{key:"goBack",value:function(){try{if(n.Polyfill.closeHistory)return L(7803);var e=this._iframe;if(e){var t=e.contentWindow;t&&t.location&&t.history.back.call(t)}}catch(e){E(e)}}},{key:"goForward",value:function(){try{if(n.Polyfill.closeHistory)return L(7804);var e=this._iframe;if(e){var t=e.contentWindow;t&&t.location&&t.history.forward.call(t)}}catch(e){E(e)}}},{key:"evaluateJS",value:function(e){var t=this._iframe;if(t)t.contentWindow}},{key:"setScalesPageToFit",value:function(){L(7805)}},{key:"setEventListener",value:function(e,t){this._EventList[e]=t}},{key:"removeEventListener",value:function(e){this._EventList[e]=null}},{key:"_dispatchEvent",value:function(e){var t=this._EventList[e];t&&this._iframe&&t.call(this,this,this._iframe.src)}},{key:"destroy",value:function(){this.removeDom()}},{key:"setVisible",value:function(e){this._visible!==e&&(this._visible=!!e,this._updateVisibility())}},{key:"updateMatrix",value:function(e){if(this._div&&this._visible){e.getWorldMatrix(DN);var t=e.getContentSize();if(this._forceUpdate||this._m00!==DN.m00||this._m01!==DN.m01||this._m04!==DN.m04||this._m05!==DN.m05||this._m12!==DN.m12||this._m13!==DN.m13||this._w!==t.width||this._h!==t.height){this._m00=DN.m00,this._m01=DN.m01,this._m04=DN.m04,this._m05=DN.m05,this._m12=DN.m12,this._m13=DN.m13,this._w=t.width,this._h=t.height;var i=nx.getScaleX(),n=nx.getScaleY(),r=nx.getDevicePixelRatio();i/=r,n/=r;var a=cc.game.container,s=DN.m00*i,o=DN.m01,l=DN.m04,c=DN.m05*n,u=a&&a.style.paddingLeft?parseInt(a.style.paddingLeft):0,h=a&&a.style.paddingBottom?parseInt(a.style.paddingBottom):0;this._updateSize(this._w,this._h);var f=this._div.clientWidth*i,d=this._div.clientHeight*n,p=e.getAnchorPoint(),_=f*DN.m00*p.x,v=d*DN.m05*p.y,m="matrix("+s+","+-o+","+-l+","+c+","+(DN.m12*i-_+u)+","+-(DN.m13*n-v+h)+")";this._div.style.transform=m,this._div.style["-webkit-transform"]=m,this._div.style["transform-origin"]="0px 100% 0px",this._div.style["-webkit-transform-origin"]="0px 100% 0px";var y=e.getComponent(GC);y&&this._setOpacity(y.color.a)}}}},{key:"setOnJSCallback",value:function(e){}},{key:"setJavascriptInterfaceScheme",value:function(e){}},{key:"loadData",value:function(e,t,i,n){}},{key:"loadHTMLString",value:function(e,t){}},{key:"_updateVisibility",value:function(){if(this._div){var e=this._div;this._visible?e.style.visibility="visible":e.style.visibility="hidden",this._forceUpdate=!0}}},{key:"_updateSize",value:function(e,t){var i=this._div;i&&(i.style.width=e+"px",i.style.height=t+"px")}},{key:"_initEvent",value:function(){var e=this._iframe;if(e){var t=this._eventListeners,i=this;t.load=function(){i._dispatchEvent(n.EventType.LOADED)},t.error=function(){i._dispatchEvent(n.EventType.ERROR)},e.addEventListener("load",t.load),e.addEventListener("error",t.error)}}},{key:"_initStyle",value:function(){if(this._div){var e=this._div;e.style.position="absolute",e.style.bottom="0px",e.style.left="0px"}}},{key:"_setOpacity",value:function(e){var t=this._iframe;t&&t.style&&(t.style.opacity=(e/255).toString())}},{key:"_createDom",value:function(e,t){n.Polyfill.enableDiv?(this._div=document.createElement("div"),this._div.style["-webkit-overflow"]="auto",this._div.style["-webkit-overflow-scrolling"]="touch",this._iframe=document.createElement("iframe"),this._div.appendChild(this._iframe),this._iframe.style.width="100%",this._iframe.style.height="100%"):this._div=this._iframe=document.createElement("iframe"),n.Polyfill.enableBG&&(this._div.style.background="#FFF"),this._div.style.background="#FFF",this._div.style.height=t+"px",this._div.style.width=e+"px",this._div.style.overflow="scroll",this._iframe.style.border="none",cc.game.container.appendChild(this._div),this._updateVisibility()}},{key:"_createNativeControl",value:function(e,t){this._createDom(e,t),this._initStyle(),this._initEvent()}}]),n}(),IN.Polyfill=FN,IN.EventType=BN,MN=LN))||MN,KN=BN;function ZN(){}var JN,$N,eU,tU,iU,nU,rU,aU,sU,oU,lU,cU,uU,hU,fU,dU,pU,_U,vU,mU,yU,gU,bU,xU,SU,wU,TU,EU,CU,AU=P2("WebviewComponent",(NN=ho("cc.WebviewComponent"),UN=yo("UI/WebView"),VN=go(100),GN=fo({type:kT}),NN(HN=UN(HN=VN((YN=XN=function(){function t(){var e;return y(this,t),v(e=x(this,g(t).call(this)),"webviewEvents",jN,u(e)),v(e,"_url",WN,u(e)),e._impl=null,e._impl=new QN,e}return p(t,SC),l(t,[{key:"url",get:function(){return this._url},set:function(e){this._url=e;var t=this._impl;t&&t.loadURL(e)}}]),l(t,[{key:"onRestore",value:function(){this._impl||(this._impl=new QN)}},{key:"onEnable",value:function(){if(this._impl){var e=this._impl;e.createDomElementIfNeeded(this.node.width,this.node.height),e.loadURL(this._url),e.setVisible(!0),e.setEventListener(KN.LOADED,this._onWebViewLoaded.bind(this)),e.setEventListener(KN.LOADING,this._onWebViewLoading.bind(this)),e.setEventListener(KN.ERROR,this._onWebViewLoadError.bind(this))}}},{key:"onDisable",value:function(){if(this._impl){var e=this._impl;e.setVisible(!1),e.setEventListener(KN.LOADED,ZN),e.setEventListener(KN.LOADING,ZN),e.setEventListener(KN.ERROR,ZN)}}},{key:"onDestroy",value:function(){this._impl&&(this._impl.destroy(),this._impl=null)}},{key:"update",value:function(e){this._impl&&this._impl.updateMatrix(this.node)}},{key:"setJavascriptInterfaceScheme",value:function(e){this._impl&&this._impl.setJavascriptInterfaceScheme(e)}},{key:"setOnJSCallback",value:function(e){this._impl&&this._impl.setOnJSCallback(e)}},{key:"evaluateJS",value:function(e){this._impl&&this._impl.evaluateJS(e)}},{key:"_onWebViewLoaded",value:function(){kT.emitEvents(this.webviewEvents,this,KN.LOADED),this.node.emit("loaded",this)}},{key:"_onWebViewLoading",value:function(){return kT.emitEvents(this.webviewEvents,this,KN.LOADING),this.node.emit("loading",this),!0}},{key:"_onWebViewLoadError",value:function(){kT.emitEvents(this.webviewEvents,this,KN.ERROR),this.node.emit("error",this)}}]),t}(),XN.EventType=KN,m((qN=YN).prototype,"url",[fo],Object.getOwnPropertyDescriptor(qN.prototype,"url"),qN.prototype),jN=m(qN.prototype,"webviewEvents",[GN],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),WN=m(qN.prototype,"_url",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),HN=qN))||HN)||HN)||HN));cc.WebviewComponent=AU;var kU,RU,OU,MU,IU=new Fi;function LU(e){return e instanceof wy?gl:e.getContentSize()}function zU(e,t,i,n){for(var r=e.parent?e.parent.getScale():IU,a=r.x,s=r.y,o=0,l=0,c=e.parent;;){if(!c)return i.x=i.y=0,void(n.x=n.y=1);var u=c.getPosition();if(o+=u.x,l+=u.y,(c=c.parent)===t)break;var h=(r=c?c.getScale():IU).x,f=r.y;o*=h,l*=f,a*=h,s*=f}n.x=0!==a?1/a:1,n.y=0!==s?1/s:1,i.x=-o,i.y=-l}(RU=kU=kU||{})[RU.ONCE=0]="ONCE",RU[RU.ALWAYS=1]="ALWAYS",mt(kU),(MU=OU=OU||{})[MU.TOP=1]="TOP",MU[MU.MID=2]="MID",MU[MU.BOT=4]="BOT",MU[MU.LEFT=8]="LEFT",MU[MU.CENTER=16]="CENTER",MU[MU.RIGHT=32]="RIGHT",MU[MU.HORIZONTAL=56]="HORIZONTAL",MU[MU.VERTICAL=7]="VERTICAL";var BU,PU=OU.TOP|OU.BOT,DU=OU.LEFT|OU.RIGHT,FU=P2("WidgetComponent",(JN=ho("cc.WidgetComponent"),$N=go(110),eU=yo("UI/Widget"),tU=mo(SE),iU=fo({type:Sm}),nU=fo({visible:!1}),rU=fo({visible:!1}),aU=fo({type:kU}),JN(sU=$N(sU=eU(sU=tU(sU=vo((CU=EU=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))))._lastPos=new Fi,t._lastSize=new jn,t._dirty=!0,v(t,"_alignFlags",lU,u(t)),v(t,"_target",cU,u(t)),v(t,"_left",uU,u(t)),v(t,"_right",hU,u(t)),v(t,"_top",fU,u(t)),v(t,"_bottom",dU,u(t)),v(t,"_horizontalCenter",pU,u(t)),v(t,"_verticalCenter",_U,u(t)),v(t,"_isAbsLeft",vU,u(t)),v(t,"_isAbsRight",mU,u(t)),v(t,"_isAbsTop",yU,u(t)),v(t,"_isAbsBottom",gU,u(t)),v(t,"_isAbsHorizontalCenter",bU,u(t)),v(t,"_isAbsVerticalCenter",xU,u(t)),v(t,"_originalWidth",SU,u(t)),v(t,"_originalHeight",wU,u(t)),v(t,"_alignMode",TU,u(t)),t}return p(a,Bv),l(a,[{key:"updateAlignment",value:function(){cc._widgetManager.updateAlignment(this.node)}},{key:"_validateTargetInDEV",value:function(){}},{key:"setDirty",value:function(){this._recursiveDirty()}},{key:"onEnable",value:function(){this.node.getPosition(this._lastPos),this.node.getContentSize(this._lastSize),cc._widgetManager.add(this),this._registerEvent(),this._registerTargetEvents()}},{key:"onDisable",value:function(){cc._widgetManager.remove(this),this._unregisterEvent(),this._unregisterTargetEvents()}},{key:"onDestroy",value:function(){this._removeParentEvent()}},{key:"_adjustWidgetToAllowMovingInEditor",value:function(e){if(e===U_.POSITION_PART&&!cc._widgetManager.isAligning){var t=this,i=t.node.getPosition(),n=this._lastPos,r=new Fi(i);r.subtract(n);var a=t.node.parent,s=new Fi(1,1,1);if(t.target&&(a=t.target,zU(t.node,a,new Fi,s)),a){var o=LU(a),l=new Fi;0!==o.width&&0!==o.height&&Fi.set(l,r.x/o.width,r.y/o.height,l.z),t.isAlignTop&&(t.top-=(t.isAbsoluteTop?r.y:l.y)*s.y),t.isAlignBottom&&(t.bottom+=(t.isAbsoluteBottom?r.y:l.y)*s.y),t.isAlignLeft&&(t.left+=(t.isAbsoluteLeft?r.x:l.x)*s.x),t.isAlignRight&&(t.right-=(t.isAbsoluteRight?r.x:l.x)*s.x),t.isAlignHorizontalCenter&&(t.horizontalCenter+=(t.isAbsoluteHorizontalCenter?r.x:l.x)*s.x),t.isAlignVerticalCenter&&(t.verticalCenter+=(t.isAbsoluteVerticalCenter?r.y:l.y)*s.y)}}}},{key:"_adjustWidgetToAllowResizingInEditor",value:function(){if(!cc._widgetManager.isAligning){this.setDirty();var e=this,t=e.node.getContentSize(),i=this._lastSize,n=new Fi(t.width-i.width,t.height-i.height,0),r=e.node.parent,a=new Fi(1,1,1);if(e.target&&(r=e.target,zU(e.node,r,new Fi,a)),r){var s=LU(r),o=new Fi;0!==s.width&&0!==s.height&&Fi.set(o,n.x/s.width,n.y/s.height,o.z);var l=e.node.getAnchorPoint();e.isAlignTop&&(e.top-=(e.isAbsoluteTop?n.y:o.y)*(1-l.y)*a.y),e.isAlignBottom&&(e.bottom-=(e.isAbsoluteBottom?n.y:o.y)*l.y*a.y),e.isAlignLeft&&(e.left-=(e.isAbsoluteLeft?n.x:o.x)*l.x*a.x),e.isAlignRight&&(e.right-=(e.isAbsoluteRight?n.x:o.x)*(1-l.x)*a.x)}}}},{key:"_adjustWidgetToAnchorChanged",value:function(){this.setDirty()}},{key:"_adjustTargetToParentChanged",value:function(e){e&&this._unregisterOldParentEvents(e),this.node.getParent()&&this._registerTargetEvents()}},{key:"_registerEvent",value:function(){this.node.on(U_.TRANSFORM_CHANGED,this._adjustWidgetToAllowMovingInEditor,this),this.node.on(U_.SIZE_CHANGED,this._adjustWidgetToAllowResizingInEditor,this),this.node.on(U_.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this),this.node.on(U_.PARENT_CHANGED,this._adjustTargetToParentChanged,this)}},{key:"_unregisterEvent",value:function(){this.node.off(U_.TRANSFORM_CHANGED,this._adjustWidgetToAllowMovingInEditor,this),this.node.off(U_.SIZE_CHANGED,this._adjustWidgetToAllowResizingInEditor,this),this.node.off(U_.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this)}},{key:"_removeParentEvent",value:function(){this.node.off(U_.PARENT_CHANGED,this._adjustTargetToParentChanged,this)}},{key:"_autoChangedValue",value:function(e,t){if(0<(this._alignFlags&e)&&this.node.parent&&this.node.parent.uiTransfromComp){var i=this.node.parent.getContentSize();this.isAlignLeft&&e===OU.LEFT?this._left=t?this._left*i.width:this._left/i.width:this.isAlignRight&&e===OU.RIGHT?this._right=t?this._right*i.width:this._right/i.width:this.isAlignHorizontalCenter&&e===OU.CENTER?this._horizontalCenter=t?this._horizontalCenter*i.width:this._horizontalCenter/i.width:this.isAlignTop&&e===OU.TOP?this._top=t?this._top*i.height:this._top/i.height:this.isAlignBottom&&e===OU.BOT?this._bottom=t?this._bottom*i.height:this._bottom/i.height:this.isAbsoluteVerticalCenter&&e===OU.MID&&(this._verticalCenter=t?this._verticalCenter*i.height:this._verticalCenter/i.height),this._recursiveDirty()}}},{key:"_registerTargetEvents",value:function(){var e=this._target||this.node.parent;e&&(e.getComponent(SE)?(e.on(U_.TRANSFORM_CHANGED,this._targetChangedOperation,this),e.on(U_.SIZE_CHANGED,this._targetChangedOperation,this)):cc.warnID(6501,this.node.name))}},{key:"_unregisterTargetEvents",value:function(){var e=this._target||this.node.parent;e&&(e.off(U_.TRANSFORM_CHANGED,this._targetChangedOperation,this),e.off(U_.SIZE_CHANGED,this._targetChangedOperation,this))}},{key:"_unregisterOldParentEvents",value:function(e){var t=this._target||e;t&&(t.off(U_.TRANSFORM_CHANGED,this._targetChangedOperation,this),t.off(U_.SIZE_CHANGED,this._targetChangedOperation,this))}},{key:"_targetChangedOperation",value:function(){this._recursiveDirty()}},{key:"_setAlign",value:function(e,t){if(t!==0<(this._alignFlags&e)){var i=0<(e&DU);t?(this._alignFlags|=e,i?(this.isAlignHorizontalCenter=!1,this.isStretchWidth&&(this._originalWidth=this.node.width)):(this.isAlignVerticalCenter=!1,this.isStretchHeight&&(this._originalHeight=this.node.height))):(i?this.isStretchWidth&&(this.node.width=this._originalWidth):this.isStretchHeight&&(this.node.height=this._originalHeight),this._alignFlags&=~e)}}},{key:"_recursiveDirty",value:function(){this._dirty||(this._dirty=!0)}},{key:"target",get:function(){return this._target},set:function(e){this._target!==e&&(this._unregisterTargetEvents(),this._target=e,this._registerTargetEvents(),this._validateTargetInDEV(),this._recursiveDirty())}},{key:"isAlignTop",get:function(){return 0<(this._alignFlags&OU.TOP)},set:function(e){this._setAlign(OU.TOP,e),this._recursiveDirty()}},{key:"isAlignBottom",get:function(){return 0<(this._alignFlags&OU.BOT)},set:function(e){this._setAlign(OU.BOT,e),this._recursiveDirty()}},{key:"isAlignLeft",get:function(){return 0<(this._alignFlags&OU.LEFT)},set:function(e){this._setAlign(OU.LEFT,e),this._recursiveDirty()}},{key:"isAlignRight",get:function(){return 0<(this._alignFlags&OU.RIGHT)},set:function(e){this._setAlign(OU.RIGHT,e),this._recursiveDirty()}},{key:"isAlignVerticalCenter",get:function(){return 0<(this._alignFlags&OU.MID)},set:function(e){e?(this.isAlignTop=!1,this.isAlignBottom=!1,this._alignFlags|=OU.MID):this._alignFlags&=~OU.MID,this._recursiveDirty()}},{key:"isAlignHorizontalCenter",get:function(){return 0<(this._alignFlags&OU.CENTER)},set:function(e){e?(this.isAlignLeft=!1,this.isAlignRight=!1,this._alignFlags|=OU.CENTER):this._alignFlags&=~OU.CENTER,this._recursiveDirty()}},{key:"isStretchWidth",get:function(){return(this._alignFlags&DU)==DU}},{key:"isStretchHeight",get:function(){return(this._alignFlags&PU)==PU}},{key:"top",get:function(){return this._top},set:function(e){this._top=e,this._recursiveDirty()}},{key:"bottom",get:function(){return this._bottom},set:function(e){this._bottom=e,this._recursiveDirty()}},{key:"left",get:function(){return this._left},set:function(e){this._left=e,this._recursiveDirty()}},{key:"right",get:function(){return this._right},set:function(e){this._right=e,this._recursiveDirty()}},{key:"horizontalCenter",get:function(){return this._horizontalCenter},set:function(e){this._horizontalCenter=e,this._recursiveDirty()}},{key:"verticalCenter",get:function(){return this._verticalCenter},set:function(e){this._verticalCenter=e,this._recursiveDirty()}},{key:"isAbsoluteTop",get:function(){return this._isAbsTop},set:function(e){this._isAbsTop!==e&&(this._isAbsTop=e,this._autoChangedValue(OU.TOP,this._isAbsTop))}},{key:"isAbsoluteBottom",get:function(){return this._isAbsBottom},set:function(e){this._isAbsBottom!==e&&(this._isAbsBottom=e,this._autoChangedValue(OU.BOT,this._isAbsBottom))}},{key:"isAbsoluteLeft",get:function(){return this._isAbsLeft},set:function(e){this._isAbsLeft!==e&&(this._isAbsLeft=e,this._autoChangedValue(OU.LEFT,this._isAbsLeft))}},{key:"isAbsoluteRight",get:function(){return this._isAbsRight},set:function(e){this._isAbsRight!==e&&(this._isAbsRight=e,this._autoChangedValue(OU.RIGHT,this._isAbsRight))}},{key:"alignMode",get:function(){return this._alignMode},set:function(e){this._alignMode=e,this._recursiveDirty()}},{key:"isAbsoluteHorizontalCenter",get:function(){return this._isAbsHorizontalCenter},set:function(e){this._isAbsHorizontalCenter!==e&&(this._isAbsHorizontalCenter=e,this._autoChangedValue(OU.CENTER,this._isAbsHorizontalCenter))}},{key:"isAbsoluteVerticalCenter",get:function(){return this._isAbsVerticalCenter},set:function(e){this._isAbsVerticalCenter!==e&&(this._isAbsVerticalCenter=e,this._autoChangedValue(OU.MID,this._isAbsVerticalCenter))}},{key:"alignFlags",get:function(){return this._alignFlags},set:function(e){this._alignFlags!==e&&(this._alignFlags=e,this._recursiveDirty())}}]),a}(),EU.AlignMode=kU,m((oU=CU).prototype,"target",[iU],Object.getOwnPropertyDescriptor(oU.prototype,"target"),oU.prototype),m(oU.prototype,"isAlignTop",[fo],Object.getOwnPropertyDescriptor(oU.prototype,"isAlignTop"),oU.prototype),m(oU.prototype,"isAlignBottom",[fo],Object.getOwnPropertyDescriptor(oU.prototype,"isAlignBottom"),oU.prototype),m(oU.prototype,"isAlignLeft",[fo],Object.getOwnPropertyDescriptor(oU.prototype,"isAlignLeft"),oU.prototype),m(oU.prototype,"isAlignRight",[fo],Object.getOwnPropertyDescriptor(oU.prototype,"isAlignRight"),oU.prototype),m(oU.prototype,"isAlignVerticalCenter",[fo],Object.getOwnPropertyDescriptor(oU.prototype,"isAlignVerticalCenter"),oU.prototype),m(oU.prototype,"isAlignHorizontalCenter",[fo],Object.getOwnPropertyDescriptor(oU.prototype,"isAlignHorizontalCenter"),oU.prototype),m(oU.prototype,"isStretchWidth",[nU],Object.getOwnPropertyDescriptor(oU.prototype,"isStretchWidth"),oU.prototype),m(oU.prototype,"isStretchHeight",[rU],Object.getOwnPropertyDescriptor(oU.prototype,"isStretchHeight"),oU.prototype),m(oU.prototype,"top",[fo],Object.getOwnPropertyDescriptor(oU.prototype,"top"),oU.prototype),m(oU.prototype,"bottom",[fo],Object.getOwnPropertyDescriptor(oU.prototype,"bottom"),oU.prototype),m(oU.prototype,"left",[fo],Object.getOwnPropertyDescriptor(oU.prototype,"left"),oU.prototype),m(oU.prototype,"right",[fo],Object.getOwnPropertyDescriptor(oU.prototype,"right"),oU.prototype),m(oU.prototype,"horizontalCenter",[fo],Object.getOwnPropertyDescriptor(oU.prototype,"horizontalCenter"),oU.prototype),m(oU.prototype,"verticalCenter",[fo],Object.getOwnPropertyDescriptor(oU.prototype,"verticalCenter"),oU.prototype),m(oU.prototype,"isAbsoluteTop",[fo],Object.getOwnPropertyDescriptor(oU.prototype,"isAbsoluteTop"),oU.prototype),m(oU.prototype,"isAbsoluteBottom",[fo],Object.getOwnPropertyDescriptor(oU.prototype,"isAbsoluteBottom"),oU.prototype),m(oU.prototype,"isAbsoluteLeft",[fo],Object.getOwnPropertyDescriptor(oU.prototype,"isAbsoluteLeft"),oU.prototype),m(oU.prototype,"isAbsoluteRight",[fo],Object.getOwnPropertyDescriptor(oU.prototype,"isAbsoluteRight"),oU.prototype),m(oU.prototype,"alignMode",[aU],Object.getOwnPropertyDescriptor(oU.prototype,"alignMode"),oU.prototype),m(oU.prototype,"isAbsoluteHorizontalCenter",[fo],Object.getOwnPropertyDescriptor(oU.prototype,"isAbsoluteHorizontalCenter"),oU.prototype),m(oU.prototype,"isAbsoluteVerticalCenter",[fo],Object.getOwnPropertyDescriptor(oU.prototype,"isAbsoluteVerticalCenter"),oU.prototype),m(oU.prototype,"alignFlags",[fo],Object.getOwnPropertyDescriptor(oU.prototype,"alignFlags"),oU.prototype),lU=m(oU.prototype,"_alignFlags",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),cU=m(oU.prototype,"_target",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),uU=m(oU.prototype,"_left",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),hU=m(oU.prototype,"_right",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),fU=m(oU.prototype,"_top",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),dU=m(oU.prototype,"_bottom",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),pU=m(oU.prototype,"_horizontalCenter",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_U=m(oU.prototype,"_verticalCenter",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),vU=m(oU.prototype,"_isAbsLeft",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),mU=m(oU.prototype,"_isAbsRight",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),yU=m(oU.prototype,"_isAbsTop",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),gU=m(oU.prototype,"_isAbsBottom",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),bU=m(oU.prototype,"_isAbsHorizontalCenter",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),xU=m(oU.prototype,"_isAbsVerticalCenter",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),SU=m(oU.prototype,"_originalWidth",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),wU=m(oU.prototype,"_originalHeight",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),TU=m(oU.prototype,"_alignMode",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return kU.ALWAYS}}),sU=oU))||sU)||sU)||sU)||sU)||sU));cc.WidgetComponent=FU;var NU,UU,VU,GU,HU,qU,jU,WU,XU,YU,QU,KU,ZU,JU,$U=P2("UIReorderComponent",ho("cc.UIReorderComponent")(BU=yo("UI/Reorder")(BU=go(110)(BU=bo(BU=vo(BU=function(){function e(){return y(this,e),x(this,g(e).apply(this,arguments))}return p(e,SC),e}())||BU)||BU)||BU)||BU)||BU);cc.UIReorderComponent=$U;var eV,tV,iV=new rr;(tV=eV=eV||{})[tV.HORIZONTAL=0]="HORIZONTAL",tV[tV.VERTICAL=1]="VERTICAL",mt(eV);var nV,rV,aV,sV,oV,lV,cV,uV,hV,fV,dV,pV,_V,vV,mV,yV,gV,bV,xV,SV,wV,TV,EV,CV,AV,kV,RV,OV,MV,IV,LV,zV=P2("PageViewIndicatorComponent",(NU=ho("cc.PageViewIndicatorComponent"),UU=go(110),VU=yo("UI/PageViewIndicator"),GU=fo({type:Eh}),HU=fo({type:eV}),qU=fo({type:jn}),NU(jU=UU(jU=VU((JU=ZU=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"spacing",XU,u(t)),v(t,"_spriteFrame",YU,u(t)),v(t,"_direction",QU,u(t)),v(t,"_cellSize",KU,u(t)),t._layout=null,t._pageView=null,t._indicators=[],t}return p(a,Bv),l(a,[{key:"onLoad",value:function(){this._updateLayout()}},{key:"setPageView",value:function(e){this._pageView=e,this._refresh()}},{key:"_updateLayout",value:function(){this._layout=this.getComponent(CP),this._layout||(this._layout=this.addComponent(CP));var e=this._layout;this.direction===eV.HORIZONTAL?(e.type=CP.Type.HORIZONTAL,e.spacingX=this.spacing):this.direction===eV.VERTICAL&&(e.type=CP.Type.VERTICAL,e.spacingY=this.spacing),e.resizeMode=CP.ResizeMode.CONTAINER}},{key:"_createIndicator",value:function(){var e=new Sm;return e.addComponent(CL).spriteFrame=this.spriteFrame,e.parent=this.node,e.width=this.cellSize.width,e.height=this.cellSize.height,e}},{key:"_changedState",value:function(){var e=this._indicators;if(0!==e.length&&this._pageView){var t=this._pageView.curPageIdx;if(!(t>=e.length)){for(var i=0;i<e.length;++i){var n=e[i];if(n._uiComp){var r=n._uiComp;iV.set(r.color),iV.a=127.5,r.color=iV}}if(e[t]._uiComp){var a=e[t]._uiComp;iV.set(a.color),iV.a=255,a.color=iV}}}}},{key:"_refresh",value:function(){if(this._pageView){var e=this._indicators,t=this._pageView.getPages();if(t.length!==e.length){var i=0;if(t.length>e.length)for(i=0;i<t.length;++i)e[i]||(e[i]=this._createIndicator());else for(i=e.length-t.length;0<i;--i){var n=e[i-1];this.node.removeChild(n),e.splice(i-1,1)}this._layout&&this._layout.enabledInHierarchy&&this._layout.updateLayout(),this._changedState()}}}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){this._spriteFrame!==e&&(this._spriteFrame=e)}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e)}},{key:"cellSize",get:function(){return this._cellSize},set:function(e){this._cellSize!==e&&(this._cellSize=e)}}]),a}(),ZU.Direction=eV,m((WU=JU).prototype,"spriteFrame",[GU],Object.getOwnPropertyDescriptor(WU.prototype,"spriteFrame"),WU.prototype),m(WU.prototype,"direction",[HU],Object.getOwnPropertyDescriptor(WU.prototype,"direction"),WU.prototype),m(WU.prototype,"cellSize",[qU],Object.getOwnPropertyDescriptor(WU.prototype,"cellSize"),WU.prototype),XU=m(WU.prototype,"spacing",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),YU=m(WU.prototype,"_spriteFrame",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),QU=m(WU.prototype,"_direction",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return eV.HORIZONTAL}}),KU=m(WU.prototype,"_cellSize",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new jn(20,20)}}),jU=WU))||jU)||jU)||jU));cc.PageViewIndicatorComponent=zV;var BV,PV,DV,FV,NV,UV,VV=new Mi;(PV=BV=BV||{})[PV.Unified=0]="Unified",PV[PV.Free=1]="Free",mt(BV),(FV=DV=DV||{})[FV.Horizontal=0]="Horizontal",FV[FV.Vertical=1]="Vertical",mt(DV),(UV=NV=NV||{})[UV.PAGE_TURNING=0]="PAGE_TURNING",mt(NV);var GV=P2("PageViewComponent",(nV=ho("cc.PageViewComponent"),rV=go(110),aV=yo("UI/PageView"),sV=fo({type:BV}),oV=fo({type:DV}),lV=fo({slide:!0,range:[0,1,.01]}),cV=fo({slide:!0,range:[0,1,.01]}),uV=fo({type:zV}),hV=fo({type:cF,visible:!1,override:!0}),fV=fo({type:cF,visible:!1,override:!0}),dV=fo({visible:!1,override:!0}),pV=fo({visible:!1,override:!0}),_V=fo({visible:!1,override:!0}),vV=fo({visible:!1,override:!0}),mV=fo({type:kT}),nV(yV=rV(yV=aV((LV=IV=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"autoPageTurningThreshold",bV,u(t)),v(t,"horizontal",xV,u(t)),v(t,"vertical",SV,u(t)),v(t,"cancelInnerEvents",wV,u(t)),v(t,"scrollEvents",TV,u(t)),v(t,"pageTurningSpeed",EV,u(t)),v(t,"pageEvents",CV,u(t)),v(t,"_sizeMode",AV,u(t)),v(t,"_direction",kV,u(t)),v(t,"_scrollThreshold",RV,u(t)),v(t,"_pageTurningEventTiming",OV,u(t)),v(t,"_indicator",MV,u(t)),t._curPageIdx=0,t._lastPageIdx=0,t._pages=[],t._initContentPos=new Fi,t._scrollCenterOffsetX=[],t._scrollCenterOffsetY=[],t._touchBeganPosition=new Fi,t._touchEndPosition=new Fi,t}return p(a,nN),l(a,[{key:"__preload",value:function(){this.node.on(U_.SIZE_CHANGED,this._updateAllPagesSize,this)}},{key:"onEnable",value:function(){_(g(a.prototype),"onEnable",this).call(this),this.node.on("scroll-ended-with-threshold",this._dispatchPageTurningEvent,this)}},{key:"onDisable",value:function(){_(g(a.prototype),"onDisable",this).call(this),this.node.off("scroll-ended-with-threshold",this._dispatchPageTurningEvent,this)}},{key:"onLoad",value:function(){this._initPages(),this.indicator&&this.indicator.setPageView(this)}},{key:"onDestroy",value:function(){this.node.off(U_.SIZE_CHANGED,this._updateAllPagesSize,this)}},{key:"getCurrentPageIndex",value:function(){return this._curPageIdx}},{key:"setCurrentPageIndex",value:function(e){this.scrollToPage(e,1)}},{key:"getPages",value:function(){return this._pages}},{key:"addPage",value:function(e){e&&-1===this._pages.indexOf(e)&&this.content&&(this.content.addChild(e),this._pages.push(e),this._updatePageView())}},{key:"insertPage",value:function(e,t){t<0||!e||-1!==this._pages.indexOf(e)||!this.content||(this._pages.length<=t?this.addPage(e):(this._pages.splice(t,0,e),this.content.insertChild(e,t),this._updatePageView()))}},{key:"removePage",value:function(e){if(e&&this.content){var t=this._pages.indexOf(e);-1!==t?this.removePageAtIndex(t):B(4300,e.name)}}},{key:"removePageAtIndex",value:function(e){var t=this._pages;if(!(e<0||e>=t.length)){var i=t[e];i&&this.content&&(this.content.removeChild(i),t.splice(e,1),this._updatePageView())}}},{key:"removeAllPages",value:function(){if(this.content){for(var e=this._pages,t=0,i=e.length;t<i;t++)this.content.removeChild(e[t]);this._pages.length=0,this._updatePageView()}}},{key:"scrollToPage",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:0;e<0||e>=this._pages.length||(i=void 0!==i?i:.3,this._curPageIdx=e,this.scrollToOffset(this._moveOffsetValue(e),i,!0),this.indicator&&this.indicator._changedState())}},{key:"getScrollEndedEventTiming",value:function(){return this.pageTurningEventTiming}},{key:"_updatePageView",value:function(){var e=this.content.getComponent(CP);e&&e.enabled&&e.updateLayout();var t=this._pages.length;this._curPageIdx>=t&&(this._curPageIdx=0===t?0:t-1,this._lastPageIdx=this._curPageIdx);for(var i=this._initContentPos,n=0;n<t;++n){var r=this._pages[n].position;this.direction===DV.Horizontal?this._scrollCenterOffsetX[n]=Math.abs(i.x+r.x):this._scrollCenterOffsetY[n]=Math.abs(i.y+r.y)}this.indicator&&this.indicator._refresh()}},{key:"_updateAllPagesSize",value:function(){if(this.content&&this.view&&this._sizeMode===BV.Unified)for(var e=this._pages,t=this.view.getContentSize(),i=0,n=e.length;i<n;i++)e[i].setContentSize(t)}},{key:"_handleReleaseLogic",value:function(){this._autoScrollToPage(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent("scroll-ended"))}},{key:"_onTouchBegan",value:function(e,t){e.touch.getUILocation(VV),Fi.set(this._touchBeganPosition,VV.x,VV.y,0),_(g(a.prototype),"_onTouchBegan",this).call(this,e,t)}},{key:"_onTouchMoved",value:function(e,t){_(g(a.prototype),"_onTouchMoved",this).call(this,e,t)}},{key:"_onTouchEnded",value:function(e,t){e.touch.getUILocation(VV),Fi.set(this._touchEndPosition,VV.x,VV.y,0),_(g(a.prototype),"_onTouchEnded",this).call(this,e,t)}},{key:"_onTouchCancelled",value:function(e,t){e.touch.getUILocation(VV),Fi.set(this._touchEndPosition,VV.x,VV.y,0),_(g(a.prototype),"_onTouchCancelled",this).call(this,e,t)}},{key:"_onMouseWheel",value:function(){}},{key:"_syncScrollDirection",value:function(){this.horizontal=this.direction===DV.Horizontal,this.vertical=this.direction===DV.Vertical}},{key:"_syncSizeMode",value:function(){var e=this.view;if(this.content&&e){var t=this.content.getComponent(CP);if(t){if(this._sizeMode===BV.Free&&0<this._pages.length){var i=this._pages[this._pages.length-1];this.direction===DV.Horizontal?(t.paddingLeft=(e.width-this._pages[0].width)/2,t.paddingRight=(e.width-i.width)/2):this.direction===DV.Vertical&&(t.paddingTop=(e.height-this._pages[0].height)/2,t.paddingBottom=(e.height-i.height)/2)}t.updateLayout()}}}},{key:"_initPages",value:function(){if(this.content){this._initContentPos=this.content.position;for(var e=this.content.children,t=0;t<e.length;++t){var i=e[t];0<=this._pages.indexOf(i)||this._pages.push(i)}this._syncScrollDirection(),this._syncSizeMode(),this._updatePageView()}}},{key:"_dispatchPageTurningEvent",value:function(){this._lastPageIdx!==this._curPageIdx&&(this._lastPageIdx=this._curPageIdx,kT.emitEvents(this.pageEvents,this,NV.PAGE_TURNING),this.node.emit("page-turning",this))}},{key:"_isQuicklyScrollable",value:function(e){if(this.direction===DV.Horizontal){if(Math.abs(e.x)>this.autoPageTurningThreshold)return!0}else if(this.direction===DV.Vertical&&Math.abs(e.y)>this.autoPageTurningThreshold)return!0;return!1}},{key:"_moveOffsetValue",value:function(e){var t=new Fi;if(this._sizeMode===BV.Free)this.direction===DV.Horizontal?t.x=this._scrollCenterOffsetX[e]:this.direction===DV.Vertical&&(t.y=this._scrollCenterOffsetY[e]);else{var i=this.view;if(!i)return t;this.direction===DV.Horizontal?t.x=e*i.width:this.direction===DV.Vertical&&(t.y=e*i.height)}return t}},{key:"_getDragDirection",value:function(e){return this._direction===DV.Horizontal?0===e.x?0:0<e.x?1:-1:0===e.y?0:e.y<0?1:-1}},{key:"_isScrollable",value:function(e,t,i){if(this._sizeMode===BV.Free){var n=0,r=0;if(this.direction===DV.Horizontal)return n=this._scrollCenterOffsetX[t],r=this._scrollCenterOffsetX[i],Math.abs(e.x)>=Math.abs(n-r)*this.scrollThreshold;if(this.direction===DV.Vertical)return n=this._scrollCenterOffsetY[t],r=this._scrollCenterOffsetY[i],Math.abs(e.y)>=Math.abs(n-r)*this.scrollThreshold}else{var a=this.view;if(!a)return;if(this.direction===DV.Horizontal)return Math.abs(e.x)>=a.width*this.scrollThreshold;if(this.direction===DV.Vertical)return Math.abs(e.y)>=a.height*this.scrollThreshold}}},{key:"_autoScrollToPage",value:function(){var e=this._startBounceBackIfNeeded(),t=new Fi;if(Fi.subtract(t,this._touchBeganPosition,this._touchEndPosition),e){var i=this._getDragDirection(t);if(0===i)return;this._curPageIdx=0<i?this._pages.length-1:0,this.indicator&&this.indicator._changedState()}else{var n=this._curPageIdx,r=n+this._getDragDirection(t),a=this.pageTurningSpeed*Math.abs(n-r);if(r<this._pages.length){if(this._isScrollable(t,n,r))return void this.scrollToPage(r,a);var s=this._calculateTouchMoveVelocity();if(this._isQuicklyScrollable(s))return void this.scrollToPage(r,a)}this.scrollToPage(n,a)}}},{key:"sizeMode",get:function(){return this._sizeMode},set:function(e){this._sizeMode!==e&&(this._sizeMode=e,this._syncSizeMode())}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this._syncScrollDirection())}},{key:"scrollThreshold",get:function(){return this._scrollThreshold},set:function(e){this._scrollThreshold!==e&&(this._scrollThreshold=e)}},{key:"pageTurningEventTiming",get:function(){return this._pageTurningEventTiming},set:function(e){this._pageTurningEventTiming!==e&&(this._pageTurningEventTiming=e)}},{key:"indicator",get:function(){return this._indicator},set:function(e){this._indicator!==e&&(this._indicator=e,this.indicator&&this.indicator.setPageView(this))}},{key:"curPageIdx",get:function(){return this._curPageIdx}},{key:"verticalScrollBar",get:function(){return this._verticalScrollBar}},{key:"horizontalScrollBar",get:function(){return this._horizontalScrollBar}}]),a}(),IV.SizeMode=BV,IV.Direction=DV,IV.EventType=NV,m((gV=LV).prototype,"sizeMode",[sV],Object.getOwnPropertyDescriptor(gV.prototype,"sizeMode"),gV.prototype),m(gV.prototype,"direction",[oV],Object.getOwnPropertyDescriptor(gV.prototype,"direction"),gV.prototype),m(gV.prototype,"scrollThreshold",[lV],Object.getOwnPropertyDescriptor(gV.prototype,"scrollThreshold"),gV.prototype),m(gV.prototype,"pageTurningEventTiming",[cV],Object.getOwnPropertyDescriptor(gV.prototype,"pageTurningEventTiming"),gV.prototype),m(gV.prototype,"indicator",[uV],Object.getOwnPropertyDescriptor(gV.prototype,"indicator"),gV.prototype),bV=m(gV.prototype,"autoPageTurningThreshold",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),m(gV.prototype,"verticalScrollBar",[hV],Object.getOwnPropertyDescriptor(gV.prototype,"verticalScrollBar"),gV.prototype),m(gV.prototype,"horizontalScrollBar",[fV],Object.getOwnPropertyDescriptor(gV.prototype,"horizontalScrollBar"),gV.prototype),xV=m(gV.prototype,"horizontal",[dV],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),SV=m(gV.prototype,"vertical",[pV],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),wV=m(gV.prototype,"cancelInnerEvents",[_V],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),TV=m(gV.prototype,"scrollEvents",[vV],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),EV=m(gV.prototype,"pageTurningSpeed",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),CV=m(gV.prototype,"pageEvents",[mV],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),AV=m(gV.prototype,"_sizeMode",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return BV.Unified}}),kV=m(gV.prototype,"_direction",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return DV.Horizontal}}),RV=m(gV.prototype,"_scrollThreshold",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),OV=m(gV.prototype,"_pageTurningEventTiming",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),MV=m(gV.prototype,"_indicator",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),yV=gV))||yV)||yV)||yV));cc.PageViewComponent=GV;var HV=new Fi,qV=new Mi,jV=new Fi,WV=new Fi(1,1,1);function XV(e,t){var i,n=t.target,r=jV,a=WV;if(n?zU(e,i=n,r,a):i=e.parent,i.getComponent(SE)){var s=LU(i),o=i instanceof wy,l=o?qV:i.getAnchorPoint(),c=o;e.getPosition(HV);var u=HV.x,h=HV.y,f=e.getAnchorPoint(),d=e.getScale();if(t.alignFlags&OU.HORIZONTAL){var p=0,_=0,v=s.width;_=c?(p=gl.left.x,gl.right.x):(p=-l.x*v)+v,p+=t.isAbsoluteLeft?t.left:t.left*v,_-=t.isAbsoluteRight?t.right:t.right*v,n&&(p+=r.x,p*=a.x,_+=r.x,_*=a.x);var m=0,y=f.x,g=d.x;if(g<0&&(y=1-y,g=-g),t.isStretchWidth)m=_-p,0!==g&&(e.width=m/g),u=p+y*m;else if(m=e.width*g,t.isAlignHorizontalCenter){var b=t.isAbsoluteHorizontalCenter?t.horizontalCenter:t.horizontalCenter*v,x=(.5-l.x)*s.width;n&&(b*=a.x,x+=r.x,x*=a.x),u=x+(y-.5)*m+b}else u=t.isAlignLeft?p+y*m:_+(y-1)*m;t._lastSize.width=m}if(t.alignFlags&OU.VERTICAL){var S=0,w=0,T=s.height;S=c?(w=gl.bottom.y,gl.top.y):(w=-l.y*T)+T,w+=t.isAbsoluteBottom?t.bottom:t.bottom*T,S-=t.isAbsoluteTop?t.top:t.top*T,n&&(w+=r.y,w*=a.y,S+=r.y,S*=a.y);var E=0,C=f.y,A=d.y;if(A<0&&(C=1-C,A=-A),t.isStretchHeight)E=S-w,0!==A&&(e.height=E/A),h=w+C*E;else if(E=e.height*A,t.isAlignVerticalCenter){var k=t.isAbsoluteVerticalCenter?t.verticalCenter:t.verticalCenter*T,R=(.5-l.y)*s.height;n&&(k*=a.y,R+=r.y,R*=a.y),h=R+(C-.5)*E+k}else h=t.isAlignBottom?w+C*E:S+(C-1)*E;t._lastSize.height=E}e.setPosition(u,h,HV.z),Fi.set(t._lastPos,u,h,HV.z)}}function YV(){var e=Yb.getScene();if(e){if(ZV.isAligning=!0,ZV._nodesOrderDirty)QV.length=0,function e(t){var i=t.getComponent(FU);i&&(XV(t,i),i.alignMode!==kU.ALWAYS?i.enabled=!1:QV.push(i));var n=t.children,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;o.active&&e(o)}}(e),ZV._nodesOrderDirty=!1;else{var t=null,i=ZV._activeWidgetsIterator;for(i.i=0;i.i<QV.length;++i.i)(t=QV[i.i])._dirty&&(XV(t.node,t),t._dirty=!1)}ZV.isAligning=!1}}var QV=[];var KV=[],ZV=P2("widgetManager",cc._widgetManager={isAligning:!1,_nodesOrderDirty:!1,_activeWidgetsIterator:new $e.MutableForwardIterator(QV),animationState:null,init:function(e){e.on(Xb.EVENT_AFTER_UPDATE,YV),ul.isMobile?window.addEventListener("resize",this.onResized.bind(this)):$b.instance.on("design-resolution-changed",this.onResized,this)},add:function(e){this._nodesOrderDirty=!0;var t=e.node.getComponent(GC);if(t){var i=Yb.root.ui.getScreen(t.visibility);i&&-1===KV.indexOf(i)&&(KV.push(i),i.node.on("design-resolution-changed",this.onResized,this))}},remove:function(e){this._activeWidgetsIterator.remove(e)},onResized:function(){var e=Yb.getScene();e&&this.refreshWidgetOnResized(e)},refreshWidgetOnResized:function(e){if(Sm.isNode(e)){var t=e.getComponent(FU);if(t&&t.alignFlags===kU.ALWAYS)return}var i=e.children,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;this.refreshWidgetOnResized(s)}},updateOffsetsToStayPut:function(e,t){function i(e,t){return 1e-10<Math.abs(e-t)?t:e}var n=e.node,r=n.parent;if(r){var a=new Fi,s=new Fi(1,1,1);if(e.target&&zU(n,r=e.target,a,s),!t)return;if(!r.getComponent(SE))return void cc.warnID(6501,e.node.name);var o=r.getAnchorPoint(),l=LU(r),c=n.getAnchorPoint(),u=n.getPosition(),h=OU,f=n.getScale(),d=0;if(t&h.LEFT){var p=-o.x*l.width;p+=a.x,p*=s.x,d=u.x-c.x*n.width*f.x-p,e.isAbsoluteLeft||(d/=l.width),d/=s.x,e.left=i(e.left,d)}if(t&h.RIGHT){var _=(1-o.x)*l.width;_+=a.x,d=(_*=s.x)-(u.x+(1-c.x)*n.width*f.x),e.isAbsoluteRight||(d/=l.width),d/=s.x,e.right=i(e.right,d)}if(t&h.TOP){var v=(1-o.y)*l.height;v+=a.y,d=(v*=s.y)-(u.y+(1-c.y)*n.height*f.y),e.isAbsoluteTop||(d/=l.height),d/=s.y,e.top=i(e.top,d)}if(t&h.BOT){var m=-o.y*l.height;m+=a.y,m*=s.y,d=u.y-c.y*n.height*f.y-m,e.isAbsoluteBottom||(d/=l.height),d/=s.y,e.bottom=i(e.bottom,d)}}},updateAlignment:function e(t){var i=t.parent;i&&Sm.isNode(i)&&e(i);var n=t.getComponent(FU);n&&i&&XV(t,n)},AlignMode:kU,AlignFlags:OU});Yb.on(Xb.EVENT_INIT,function(){ZV.init(Yb)});var JV=function e(t,i,n){y(this,e),this.i=void 0,this.x=void 0,this.y=void 0,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1,this.i=t,this.x=i,this.y=n};function $V(e,t,i,n,r){var a=0,s=null;if(r===0<function(e,t,i,n){for(var r=0,a=t,s=i-n;a<i;a+=n)r+=(e[s]-e[a])*(e[a+1]+e[s+1]),s=a;return r}(e,t,i,n))for(a=t;a<i;a+=n)s=vG(a,e[a],e[a+1],s);else for(a=i-n;t<=a;a-=n)s=vG(a,e[a],e[a+1],s);return s&&fG(s,s.next)&&(mG(s),s=s.next),s}function eG(e,t){var i=1<arguments.length&&void 0!==t?t:null;if(!e)return e;i=i||e;var n=e,r=!1;do{if(r=!1,n.steiner||!fG(n,n.next)&&0!==hG(n.prev,n,n.next))n=n.next;else{if(mG(n),(n=i=n.prev)===n.next)return null;r=!0}}while(r||n!==i);return i}function tG(e,t,i,n,r,a,s){var o=6<arguments.length&&void 0!==s?s:0;if(e){!o&&a&&function(e,t,i,n){var r=e;for(;null===r.z&&(r.z=lG(r.x,r.y,t,i,n)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next,r!==e;);r.prevZ.nextZ=null,r.prevZ=null,function(e){var t=0,i=null,n=null,r=null,a=null,s=0,o=0,l=0,c=1;do{for(i=e,a=e=null,s=0;i;){for(s++,n=i,t=o=0;t<c&&(o++,n=n.nextZ);t++);for(l=c;0<o||0<l&&n;)0===o?(n=(r=n).nextZ,l--):0!==l&&n?i.z<=n.z?(i=(r=i).nextZ,o--):(n=(r=n).nextZ,l--):(i=(r=i).nextZ,o--),a?a.nextZ=r:e=r,r.prevZ=a,a=r;i=n}a.nextZ=null,c*=2}while(1<s)}(r)}(e,n,r,a);for(var l=e,c=null,u=null;e.prev!==e.next;)if(c=e.prev,u=e.next,a?nG(e,n,r,a):iG(e))t.push(c.i/i),t.push(e.i/i),t.push(u.i/i),mG(e),e=u.next,l=u.next;else if((e=u)===l){o?1===o?tG(e=rG(e,t,i),t,i,n,r,a,2):2===o&&aG(e,t,i,n,r,a):tG(eG(e),t,i,n,r,a,1);break}}}function iG(e){var t=e.prev,i=e,n=e.next;if(0<=hG(t,i,n))return!1;for(var r=e.next.next;r!==e.prev;){if(uG(t.x,t.y,i.x,i.y,n.x,n.y,r.x,r.y)&&0<=hG(r.prev,r,r.next))return!1;r=r.next}return!0}function nG(e,t,i,n){var r=e.prev,a=e,s=e.next;if(0<=hG(r,a,s))return!1;for(var o=r.x<a.x?r.x<s.x?r.x:s.x:a.x<s.x?a.x:s.x,l=r.y<a.y?r.y<s.y?r.y:s.y:a.y<s.y?a.y:s.y,c=r.x>a.x?r.x>s.x?r.x:s.x:a.x>s.x?a.x:s.x,u=r.y>a.y?r.y>s.y?r.y:s.y:a.y>s.y?a.y:s.y,h=lG(o,l,t,i,n),f=lG(c,u,t,i,n),d=e.nextZ;d&&d.z<=f;){if(d!==e.prev&&d!==e.next&&uG(r.x,r.y,a.x,a.y,s.x,s.y,d.x,d.y)&&0<=hG(d.prev,d,d.next))return!1;d=d.nextZ}for(d=e.prevZ;d&&d.z>=h;){if(d!==e.prev&&d!==e.next&&uG(r.x,r.y,a.x,a.y,s.x,s.y,d.x,d.y)&&0<=hG(d.prev,d,d.next))return!1;d=d.prevZ}return!0}function rG(e,t,i){var n=e;do{var r=n.prev,a=n.next.next;!fG(r,a)&&dG(r,n,n.next,a)&&pG(r,a)&&pG(a,r)&&(t.push(r.i/i),t.push(n.i/i),t.push(a.i/i),mG(n),mG(n.next),n=e=a),n=n.next}while(n!==e);return n}function aG(e,t,i,n,r,a){var s,o,l=e;do{for(var c=l.next.next;c!==l.prev;){if(l.i!==c.i&&(o=c,(s=l).next.i!==o.i&&s.prev.i!==o.i&&!function(e,t){var i=e;do{if(i.i!==e.i&&i.next.i!==e.i&&i.i!==t.i&&i.next.i!==t.i&&dG(i,i.next,e,t))return!0;i=i.next}while(i!==e);return!1}(s,o)&&pG(s,o)&&pG(o,s)&&function(e,t){var i=e,n=!1,r=(e.x+t.x)/2,a=(e.y+t.y)/2;for(;i.y>a!=i.next.y>a&&r<(i.next.x-i.x)*(a-i.y)/(i.next.y-i.y)+i.x&&(n=!n),i=i.next,i!==e;);return n}(s,o))){var u=_G(l,c);return l=eG(l,l.next),u=eG(u,u.next),tG(l,t,i,n,r,a),void tG(u,t,i,n,r,a)}c=c.next}l=l.next}while(l!==e)}function sG(e,t){return e.x-t.x}function oG(e,t){if(t=function(e,t){var i=t,n=e.x,r=e.y,a=-1/0,s=null;do{if(r<=i.y&&r>=i.next.y){var o=i.x+(r-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(o<=n&&a<o){if((a=o)===n){if(r===i.y)return i;if(r===i.next.y)return i.next}s=i.x<i.next.x?i:i.next}}i=i.next}while(i!==t);if(!s)return null;if(n===a)return s.prev;var l,c=s,u=s.x,h=s.y,f=1/0;i=s.next;for(;i!==c;)n>=i.x&&i.x>=u&&uG(r<h?n:a,r,u,h,r<h?a:n,r,i.x,i.y)&&((l=Math.abs(r-i.y)/(n-i.x))<f||l===f&&i.x>s.x)&&pG(i,e)&&(s=i,f=l),i=i.next;return s}(e,t)){var i=_G(t,e);eG(i,i.next)}}function lG(e,t,i,n,r){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)/r)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-n)/r)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function cG(e){for(var t=e,i=e;t.x<i.x&&(i=t),(t=t.next)!==e;);return i}function uG(e,t,i,n,r,a,s,o){return 0<=(r-s)*(t-o)-(e-s)*(a-o)&&0<=(e-s)*(n-o)-(i-s)*(t-o)&&0<=(i-s)*(a-o)-(r-s)*(n-o)}function hG(e,t,i){return(t.y-e.y)*(i.x-t.x)-(t.x-e.x)*(i.y-t.y)}function fG(e,t){return e.x===t.x&&e.y===t.y}function dG(e,t,i,n){return!!(fG(e,t)&&fG(i,n)||fG(e,n)&&fG(i,t))||0<hG(e,t,i)!=0<hG(e,t,n)&&0<hG(i,n,e)!=0<hG(i,n,t)}function pG(e,t){return hG(e.prev,e,e.next)<0?0<=hG(e,t,e.next)&&0<=hG(e,e.prev,t):hG(e,t,e.prev)<0||hG(e,e.next,t)<0}function _G(e,t){var i=new JV(e.i,e.x,e.y),n=new JV(t.i,t.x,t.y),r=e.next,a=t.prev;return(e.next=t).prev=e,(i.next=r).prev=i,(n.next=i).prev=n,(a.next=n).prev=a,n}function vG(e,t,i,n){var r=new JV(e,t,i);return n?(r.next=n.next,(r.prev=n).next.prev=r,n.next=r):(r.prev=r).next=r,r}function mG(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function yG(e,t,i){i=i||3;var n=t?t.length:0,r=n?t[0]*i:e.length,a=$V(e,0,r,i,!0),s=[];if(!a)return s;var o=0,l=0,c=0,u=0,h=0,f=0,d=0;if(n&&(a=function(e,t,i,n){var r,a=[],s=0,o=null;for(s=0,r=t.length;s<r;s++)(o=$V(e,t[s]*n,s<r-1?t[s+1]*n:e.length,n,!1))&&(o===o.next&&(o.steiner=!0),a.push(cG(o)));if(a.sort(sG),!i)return i;for(s=0;s<a.length;s++)oG(a[s],i),i=eG(i,i.next);return i}(e,t,a,i)),e.length>80*i){o=c=e[0],l=u=e[1];for(var p=i;p<r;p+=i)(h=e[p])<o&&(o=h),(f=e[p+1])<l&&(l=f),c<h&&(c=h),u<f&&(u=f);d=Math.max(c-o,u-l)}return tG(a,s,i,o,l,d),s}var gG=Math.PI,bG=Math.min,xG=Math.max,SG=Math.cos,wG=Math.sin,TG=Math.abs,EG=Math.sign,CG=.5522847493;function AG(e,t,i,n,r){e.moveTo(t-n,i),e.bezierCurveTo(t-n,i+r*CG,t-n*CG,i+r,t,i+r),e.bezierCurveTo(t+n*CG,i+r,t+n,i+r*CG,t+n,i),e.bezierCurveTo(t+n,i-r*CG,t+n*CG,i-r,t,i-r),e.bezierCurveTo(t-n*CG,i-r,t-n,i-r*CG,t-n,i),e.close()}for(var kG=function(){function n(e,t){var i;return y(this,n),(i=x(this,g(n).call(this,e,t))).dx=0,i.dy=0,i.dmx=0,i.dmy=0,i.flags=0,i.len=0,i.reset(),i}return p(n,Mi),l(n,[{key:"reset",value:function(){this.dx=0,this.dy=0,this.dmx=0,this.dmy=0,this.flags=0,this.len=0}}]),n}(),RG=function(){function e(){y(this,e),this.closed=!1,this.nbevel=0,this.complex=!0,this.points=[],this.reset()}return l(e,[{key:"reset",value:function(){this.closed=!1,this.nbevel=0,this.complex=!0,this.points?this.points.length=0:this.points=[]}}]),e}(),OG=function(){function e(){y(this,e),this.dataOffset=0,this.updatePathOffset=!1,this.pathLength=0,this.pathOffset=0,this.paths=[],this.tessTol=.25,this.distTol=.01,this.fillColor=rr.WHITE.clone(),this.lineCap=iP.BUTT,this.strokeColor=rr.BLACK.clone(),this.lineJoin=rP.MITER,this.lineWidth=0,this.pointsOffset=0,this._commandx=0,this._commandy=0,this._points=[],this._renderDatasPool=new Rs(function(){return new TC},16),this._renderDatas=[],this._curPath=null}return l(e,[{key:"moveTo",value:function(e,t){this.updatePathOffset&&(this.pathOffset=this.pathLength,this.updatePathOffset=!1),this._addPath(),this.addPoint(e,t,sP.PT_CORNER),this._commandx=e,this._commandy=t}},{key:"lineTo",value:function(e,t){this.addPoint(e,t,sP.PT_CORNER),this._commandx=e,this._commandy=t}},{key:"bezierCurveTo",value:function(e,t,i,n,r,a){var s=this._curPath,o=s.points[s.points.length-1];o&&(o.x!==e||o.y!==t||i!==r||n!==a?(function e(t,i,n,r,a,s,o,l,c,u,h){var f,d,p,_,v,m,y,g,b,x,S,w,T,E,C,A;10<u||(v=.5*(s+l),m=.5*(o+c),y=.5*((f=.5*(i+r))+(p=.5*(r+s))),g=.5*((d=.5*(n+a))+(_=.5*(a+o))),((C=TG((r-l)*(E=c-n)-(a-c)*(T=l-i)))+(A=TG((s-l)*E-(o-c)*T)))*(C+A)<t.tessTol*(T*T+E*E)?t.addPoint(l,c,0===h?h|sP.PT_BEVEL:h):(e(t,i,n,f,d,y,g,S=.5*(y+(b=.5*(p+v))),w=.5*(g+(x=.5*(_+m))),u+1,0),e(t,S,w,b,x,v,m,l,c,u+1,h)))}(this,o.x,o.y,e,t,i,n,r,a,0,sP.PT_CORNER),this._commandx=r,this._commandy=a):this.lineTo(r,a))}},{key:"quadraticCurveTo",value:function(e,t,i,n){var r=this._commandx,a=this._commandy;this.bezierCurveTo(r+2/3*(e-r),a+2/3*(t-a),i+2/3*(e-i),n+2/3*(t-n),i,n)}},{key:"arc",value:function(e,t,i,n,r,a){!function(e,t,i,n,r,a,s){var o,l,c=0,u=0,h=0,f=0,d=0,p=0,_=0,v=0,m=0,y=0,g=0,b=0,x=0,S=0;if(u=a-r,s=s||!1)if(TG(u)>=2*gG)u=2*gG;else for(;u<0;)u+=2*gG;else if(TG(u)>=2*gG)u=2*-gG;else for(;0<u;)u-=2*gG;for(l=0|xG(1,bG(TG(u)/(.5*gG)+.5,5)),h=TG(4/3*(1-SG(o=u/l/2))/wG(o)),s||(h=-h),S=0;S<=l;S++)p=t+(f=SG(c=r+u*(S/l)))*n,_=i+(d=wG(c))*n,v=-d*n*h,m=f*n*h,0===S?e.moveTo(p,_):e.bezierCurveTo(y+b,g+x,p-v,_-m,p,_),y=p,g=_,b=v,x=m}(this,e,t,i,n,r,a)}},{key:"ellipse",value:function(e,t,i,n){AG(this,e,t,i,n),this._curPath.complex=!1}},{key:"circle",value:function(e,t,i){AG(this,e,t,i,i),this._curPath.complex=!1}},{key:"rect",value:function(e,t,i,n){this.moveTo(e,t),this.lineTo(e+i,t),this.lineTo(e+i,t+n),this.lineTo(e,t+n),this.close(),this._curPath.complex=!1}},{key:"roundRect",value:function(e,t,i,n,r){!function(e,t,i,n,r,a){if(a<.1)e.rect(t,i,n,r);else{var s=bG(a,.5*TG(n))*EG(n),o=bG(a,.5*TG(r))*EG(r);e.moveTo(t,i+o),e.lineTo(t,i+r-o),e.bezierCurveTo(t,i+r-o*(1-CG),t+s*(1-CG),i+r,t+s,i+r),e.lineTo(t+n-s,i+r),e.bezierCurveTo(t+n-s*(1-CG),i+r,t+n,i+r-o*(1-CG),t+n,i+r-o),e.lineTo(t+n,i+o),e.bezierCurveTo(t+n,i+o*(1-CG),t+n-s*(1-CG),i,t+n-s,i),e.lineTo(t+s,i),e.bezierCurveTo(t+s*(1-CG),i,t,i+o*(1-CG),t,i+o),e.close()}}(this,e,t,i,n,r),this._curPath.complex=!1}},{key:"clear",value:function(e){var t=0<arguments.length&&void 0!==e&&e;this.pathLength=0,this.pathOffset=0,this.pointsOffset=0,this.dataOffset=0,this._curPath=null,this.paths.length=0,this._points.length=0;for(var i=this._renderDatas,n=0,r=i.length;n<r;n++){var a=i[n];a&&a.reset()}this._renderDatas.length=0,t&&this._renderDatasPool.reset()}},{key:"close",value:function(){this._curPath.closed=!0}},{key:"requestRenderData",value:function(){var e=this._renderDatasPool.add();return this._renderDatas.push(e),e}},{key:"getRenderDatas",value:function(){return 0===this._renderDatas.length&&this.requestRenderData(),this._renderDatas}},{key:"addPoint",value:function(e,t,i){var n=this._curPath;if(n){var r=this._points,a=n.points,s=r[this.pointsOffset++];s?(s.x=e,s.y=t):(s=new kG(e,t),r.push(s)),s.flags=i,a.push(s)}}},{key:"_addPath",value:function(){var e=this.pathLength,t=this.paths[e];return t?t.reset():(t=new RG,this.paths.push(t)),this.pathLength++,this._curPath=t}}]),e}(),MG=Math.PI,IG=Math.min,LG=Math.max,zG=Math.ceil,BG=Math.acos,PG=Math.cos,DG=Math.sin,FG=Math.atan2,NG=Pb,UG=[],VG=[],GG=[],HG=[],qG=null,jG=null,WG=new rr,XG=[],YG=0;YG<4;YG++)XG.push(new Fi);function QG(e,t,i){return e<t?t:i<e?i:e}var KG=P2("graphics",{useModel:!0,createImpl:function(e){return new OG},updateRenderData:function(e){for(var t=e.impl?e.impl.getRenderDatas():[],i=0,n=t.length;i<n;i++)t[i].material=e.material},fillBuffers:function(e,t){},renderIA:function(e,t){},getRenderData:function(e,t){if(!jG)return null;var i=jG.getRenderDatas(),n=i[jG.dataOffset];if(!n)return null;var r=n,a=r?r.vertexCount+t:0;return(65535<a||131070<3*a)&&(++jG.dataOffset,jG.dataOffset<i.length?n=i[jG.dataOffset]:(n=jG.requestRenderData(),i[jG.dataOffset]=n),n.material=e.material,r=n),r&&r.vertexCount<a&&r.request(t,3*t),n},stroke:function(e){rr.copy(WG,e.strokeColor),e.impl&&(this._flattenPaths(e.impl),this._expandStroke(e),e.impl.updatePathOffset=!0,this.end(e))},fill:function(e){rr.copy(WG,e.fillColor),this._expandFill(e),e.impl&&(e.impl.updatePathOffset=!0),this.end(e)},end:function(e){var t=Yb.root.ui.renderScene;e.model&&(e.model.destroy(),t.destroyModel(e.model),e.model=null);var i=e.impl,n=Gl.TRIANGLE_LIST,r=i&&i.getRenderDatas();if(r){var a=0;UG.length=0,VG.length=0,GG.length=0,HG.length=0;var s=r,o=Array.isArray(s),l=0;for(s=o?s:s[Symbol.iterator]();;){var c;if(o){if(l>=s.length)break;c=s[l++]}else{if((l=s.next()).done)break;c=l.value}var u=c,h=u.byteCount>>2,f=u.vData;for(a=0;a<h;)UG.push(f[a++]),UG.push(f[a++]),UG.push(f[a++]),VG.push(f[a++]),VG.push(f[a++]),GG.push(f[a++]),GG.push(f[a++]),GG.push(f[a++]),GG.push(f[a++]);h=u.indiceCount;var d=u.iData;for(a=0;a<h;)HG.push(d[a++])}var p=Ef({primitiveMode:n,positions:UG,uvs:VG,colors:GG,attributes:NG,indices:HG},void 0,{calculateBounds:!1});e.model=t.createModel(vf,e.node),e.model.initSubModel(0,p.getSubMesh(0),e.material),e.model.enabled=!0,e.markForUpdateRenderData()}},_expandStroke:function(e){var t=.5*e.lineWidth,i=e.lineCap,n=e.lineJoin,r=e.miterLimit;if(jG=e.impl){var a=function(e,t,i){var n=2*BG(e/(e+i));return LG(2,zG(t/n))}(t,MG,jG.tessTol);this._calculateJoins(jG,t,n,r);for(var s=jG.paths,o=0,l=jG.pathOffset,c=jG.pathLength;l<c;l++){var u=s[l],h=u.points.length;n===rP.ROUND?o+=2*(h+u.nbevel*(a+2)+1):o+=2*(h+5*u.nbevel+1),u.closed||(i===iP.ROUND?o+=2*(2*a+2):o+=12)}var f=qG=this.getRenderData(e,o);if(f){for(var d=f.vData,p=f.iData,_=jG.pathOffset,v=jG.pathLength;_<v;_++){var m=s[_],y=m.points,g=y.length,b=f.vertexStart,x=void 0,S=void 0,w=0,T=0,E=m.closed;if(T=E?(x=y[g-1],S=y[0],w=0,g):(x=y[0],S=y[1],g-(w=1)),!E){var C=new kG(S.x,S.y);C.subtract(x),C.normalize();var A=C.x,k=C.y;i===iP.BUTT?this._buttCap(x,A,k,t,0):i===iP.SQUARE?this._buttCap(x,A,k,t,t):i===iP.ROUND&&this._roundCapStart(x,A,k,t,a)}for(var R=w;R<T;++R)n===rP.ROUND?this._roundJoin(x,S,t,t,a):0!=(S.flags&(sP.PT_BEVEL|sP.PT_INNERBEVEL))?this._bevelJoin(x,S,t,t):(this._vset(S.x+S.dmx*t,S.y+S.dmy*t),this._vset(S.x-S.dmx*t,S.y-S.dmy*t)),x=S,S=y[R+1];if(E){var O=9*b,M=d.slice(O,O+9);d.set(M,9*f.vertexStart),O+=9,f.vertexStart++,M=d.slice(O,O+9),d.set(M,9*f.vertexStart),f.vertexStart++}else{var I=new kG(S.x,S.y);I.subtract(x),I.normalize();var L=I.x,z=I.y;i===iP.BUTT?this._buttCap(S,L,z,t,0):i===iP.SQUARE?this._buttCap(S,L,z,t,t):i===iP.ROUND&&this._roundCapEnd(S,L,z,t,a)}for(var B=f.indiceStart,P=b+2,D=f.vertexStart;P<D;P++)p[B++]=P-2,p[B++]=P-1,p[B++]=P;if((f.indiceStart=B)!==f.indiceCount){var F=new Array(f.indiceCount-B);f.iData.set(F,B)}}jG=qG=null}}},_expandFill:function(e){if(jG=e.impl){for(var t=jG.paths,i=0,n=jG.pathOffset,r=jG.pathLength;n<r;n++){i+=t[n].points.length}var a=qG=this.getRenderData(e,i);if(a){for(var s=a,o=s.vData,l=s.iData,c=jG.pathOffset,u=jG.pathLength;c<u;c++){var h=t[c],f=h.points,d=f.length;if(0!==d){for(var p=a.vertexStart,_=0;_<d;++_)this._vset(f[_].x,f[_].y);var v=a.indiceStart;if(h.complex){for(var m=[],y=p,g=a.vertexStart;y<g;y++){var b=9*y;m.push(o[b++]),m.push(o[b++]),m.push(o[b++])}var x=yG(m,null,3);if(!x||0===x.length)continue;for(var S=0,w=x.length;S<w;S++)l[v++]=x[S]+p}else for(var T=p,E=p+2,C=s.vertexStart;E<C;E++)l[v++]=T,l[v++]=E-1,l[v++]=E;if((s.indiceStart=v)!==s.indiceCount){var A=new Array(s.indiceCount-v);s.iData.set(A,v)}}}jG=qG=null}}},_calculateJoins:function(e,t,i,n){var r=0;0<t&&(r=1/t);for(var a=e.paths,s=e.pathOffset,o=e.pathLength;s<o;s++)for(var l=a[s],c=l.points,u=c.length,h=c[u-1],f=c[0],d=l.nbevel=0;d<u;d++){var p,_,v=h.dy,m=-h.dx,y=f.dy,g=-f.dx;if(f.dmx=.5*(v+y),f.dmy=.5*(m+g),1e-6<(p=f.dmx*f.dmx+f.dmy*f.dmy)){var b=1/p;600<b&&(b=600),f.dmx*=b,f.dmy*=b}0<f.dx*h.dy-h.dx*f.dy&&(f.flags|=sP.PT_LEFT),p*(_=LG(11,IG(h.len,f.len)*r))*_<1&&(f.flags|=sP.PT_INNERBEVEL),f.flags&sP.PT_CORNER&&(p*n*n<1||i===rP.BEVEL||i===rP.ROUND)&&(f.flags|=sP.PT_BEVEL),0!=(f.flags&(sP.PT_BEVEL|sP.PT_INNERBEVEL))&&l.nbevel++,h=f,f=c[d+1]}},_flattenPaths:function(e){for(var t=e.paths,i=e.pathOffset,n=e.pathLength;i<n;i++){var r=t[i],a=r.points,s=a[a.length-1],o=a[0];s.equals(o)&&(r.closed=!0,a.pop(),s=a[a.length-1]);for(var l=0,c=a.length;l<c;l++){var u=new kG(o.x,o.y);u.subtract(s),s.len=u.length(),(u.x||u.y)&&u.normalize(),s.dx=u.x,s.dy=u.y,s=o,o=a[l+1]}}},_chooseBevel:function(e,t,i,n){var r=i.x,a=i.y,s=0,o=0,l=0,c=0;return 0!==e?(s=r+t.dy*n,o=a-t.dx*n,l=r+i.dy*n,c=a-i.dx*n):(s=l=r+i.dmx*n,o=c=a+i.dmy*n),[s,o,l,c]},_buttCap:function(e,t,i,n,r){var a=e.x-t*r,s=e.y-i*r,o=i,l=-t;this._vset(a+o*n,s+l*n),this._vset(a-o*n,s-l*n)},_roundCapStart:function(e,t,i,n,r){for(var a=e.x,s=e.y,o=i,l=-t,c=0;c<r;c++){var u=c/(r-1)*MG,h=PG(u)*n,f=DG(u)*n;this._vset(a-o*h-t*f,s-l*h-i*f),this._vset(a,s)}this._vset(a+o*n,s+l*n),this._vset(a-o*n,s-l*n)},_roundCapEnd:function(e,t,i,n,r){var a=e.x,s=e.y,o=i,l=-t;this._vset(a+o*n,s+l*n),this._vset(a-o*n,s-l*n);for(var c=0;c<r;c++){var u=c/(r-1)*MG,h=PG(u)*n,f=DG(u)*n;this._vset(a,s),this._vset(a-o*h+t*f,s-l*h+i*f)}},_roundJoin:function(e,t,i,n,r){var a=e.dy,s=-e.dx,o=t.dy,l=-t.dx,c=t.x,u=t.y;if(0!=(t.flags&sP.PT_LEFT)){var h=this._chooseBevel(t.flags&sP.PT_INNERBEVEL,e,t,i),f=h[0],d=h[1],p=h[2],_=h[3],v=FG(-s,-a),m=FG(-l,-o);v<m&&(m-=2*MG),this._vset(f,d),this._vset(c-a*n,t.y-s*n);for(var y=QG(zG((v-m)/MG)*r,2,r),g=0;g<y;g++){var b=v+g/(y-1)*(m-v),x=c+PG(b)*n,S=u+DG(b)*n;this._vset(c,u),this._vset(x,S)}this._vset(p,_),this._vset(c-o*n,u-l*n)}else{var w=this._chooseBevel(t.flags&sP.PT_INNERBEVEL,e,t,-n),T=w[0],E=w[1],C=w[2],A=w[3],k=FG(s,a),R=FG(l,o);R<k&&(R+=2*MG),this._vset(c+a*n,u+s*n,0),this._vset(T,E,0);for(var O=QG(zG((R-k)/MG)*r,2,r),M=0;M<O;M++){var I=k+M/(O-1)*(R-k),L=c+PG(I)*i,z=u+DG(I)*i;this._vset(L,z,0),this._vset(c,u,0)}this._vset(c+o*n,u+l*n),this._vset(C,A)}},_bevelJoin:function(e,t,i,n){var r=0,a=0,s=0,o=0,l=0,c=0,u=0,h=0,f=e.dy,d=-e.dx,p=t.dy,_=-t.dx;if(t.flags&sP.PT_LEFT){var v=this._chooseBevel(t.flags&sP.PT_INNERBEVEL,e,t,i);l=v[0],c=v[1],u=v[2],h=v[3],this._vset(l,c,0),this._vset(t.x-f*n,t.y-d*n,0),this._vset(u,h,0),this._vset(t.x-p*n,t.y-_*n,0)}else{var m=this._chooseBevel(t.flags&sP.PT_INNERBEVEL,e,t,-n);r=m[0],a=m[1],s=m[2],o=m[3],this._vset(t.x+f*i,t.y+d*i,0),this._vset(r,a),this._vset(t.x+p*i,t.y+_*i,0),this._vset(s,o)}},_vset:function(e,t){if(qG){var i=qG,n=9*i.vertexStart,r=i.vData;r[n++]=e,r[n++]=t,r[n++]=0,r[n++]=1,r[n++]=1,rr.toArray(r,WG,n),i.vertexStart++}}}),ZG=P2("graphicsAssembler",{getAssembler:function(e){return KG}});UP.Assembler=ZG;function JG(){y(this,JG),this.u=0,this.v=0,this.width=0,this.height=0,this.offsetX=0,this.offsetY=0,this.textureID=0,this.validDefinition=!1,this.xAdvance=0}var $G=function(){function e(){y(this,e),this._letterDefinitions={}}return l(e,[{key:"addLetterDefinitions",value:function(e,t){this._letterDefinitions[e]=t}},{key:"cloneLetterDefinition",value:function(){for(var e={},t=0,i=Object.keys(this._letterDefinitions);t<i.length;t++){var n=i[t],r=new JG;Ne(r,this._letterDefinitions[n]),e[n]=r}return e}},{key:"assignLetterDefinitions",value:function(e){for(var t=0,i=Object.keys(this._letterDefinitions);t<i.length;t++){var n=i[t],r=e[n];Ne(this._letterDefinitions[n],r)}}},{key:"scaleFontLetterDefinition",value:function(e){for(var t=0,i=Object.keys(this._letterDefinitions);t<i.length;t++){var n=i[t],r=this._letterDefinitions[n];r.width*=e,r.height*=e,r.offsetX*=e,r.offsetY*=e,r.xAdvance*=e}}},{key:"getLetterDefinitionForChar",value:function(e){return this._letterDefinitions.hasOwnProperty(e.charCodeAt(0))?this._letterDefinitions[e.charCodeAt(0)]:null}},{key:"letterDefinitions",get:function(){return this._letterDefinitions}}]),e}();cc.FontAtlas=$G;function eH(){y(this,eH),this.char="",this.valid=!0,this.positionX=0,this.positionY=0,this.lineIndex=0}var tH=new Zn,iH=null,nH=[],rH=[],aH=[],sH=[],oH=new jn,lH=null,cH=null,uH=0,hH=0,fH=0,dH=0,pH=0,_H=1,vH=null,mH="",yH=0,gH=0,bH=new jn,xH=0,SH=0,wH=0,TH=0,EH=0,CH=!1,AH=0,kH=0,RH=0,OH={updateRenderData:function(e){e.renderData&&e.renderData.vertDirty&&iH!==e&&(iH=e,this._updateProperties(),this._updateContent(),iH.actualFontSize=yH,iH.node.setContentSize(bH),iH.renderData.vertDirty=iH.renderData.uvDirty=!1,iH=null,this._resetProperties())},_updateFontScale:function(){_H=yH/gH},_updateProperties:function(){if(iH){var e=iH.font;if(e){if(vH=e.spriteFrame,cH=e.fntConfig,!(lH=iH.fontAtlas)){lH=new $G;for(var t=cH.fontDefDictionary,i=0,n=Object.keys(t);i<n.length;i++){var r=n[i],a=new JG,s=t[r].rect;a.offsetX=t[r].xOffset,a.offsetY=t[r].yOffset,a.width=s.width,a.height=s.height,a.u=s.x,a.v=s.y,a.textureID=0,a.validDefinition=!0,a.xAdvance=t[r].xAdvance,lH.addLetterDefinitions(r,a)}iH.fontAtlas=lH}mH=iH.string.toString(),yH=iH.fontSize,gH=cH.fontSize;var o=iH.node.getContentSize();bH.width=o.width,bH.height=o.height,xH=iH.horizontalAlign,SH=iH.verticalAlign,wH=iH.spacingX,EH=iH.overflow,TH=iH.lineHeight,CH=EH!==vz.NONE&&(EH===vz.RESIZE_HEIGHT||iH.enableWrapText),this._setupBMFontOverflowMetrics()}}},_resetProperties:function(){vH=cH=lH=null},_updateContent:function(){this._updateFontScale(),this._computeHorizontalKerningForText(),this._alignText()},_computeHorizontalKerningForText:function(){for(var e=mH,t=e.length,i=cH.kerningDict,n=nH,r=-1,a=0;a<t;++a){var s=e.charCodeAt(a),o=i[r<<16|65535&s]||0;n[a]=a<t-1?o:0,r=s}},_multilineTextWrap:function(e){var t=mH.length,i=0,n=0,r=0,a=0,s=0,o=0,l=0,c=null,u=new Mi;this._updateFontScale();for(var h=lH.letterDefinitions,f=0;f<t;){var d=mH.charAt(f);if("\n"!==d){for(var p=e(mH,f,t),_=o,v=l,m=s,y=n,g=!1,b=0;b<p;++b){var x=f+b;if("\r"!==(d=mH.charAt(x)))if(c=lH&&lH.getLetterDefinitionForChar(d)){var S=y+c.offsetX*_H;if(CH&&0<RH&&0<n&&S+c.width*_H>RH&&!Ys(d)){aH.push(s),i++,r-=TH*_H+(n=s=0),g=!0;break}u.x=S,u.y=r-c.offsetY*_H,this._recordLetterInfo(h,u,d,x,i),x+1<nH.length&&x<t-1&&(y+=nH[x+1]),y+=c.xAdvance*_H+wH,m=u.x+c.width*_H,_<u.y&&(_=u.y),v>u.y-c.height*_H&&(v=u.y-c.height*_H)}else this._recordPlaceholderInfo(x,d),console.log("Can't find letter definition in texture atlas "+cH.atlasName+" for letter:"+d);else this._recordPlaceholderInfo(x,d)}g||(n=y,o<_&&(o=_),v<l&&(l=v),a<(s=m)&&(a=s),f+=p)}else aH.push(s),i++,r-=TH*_H+(n=s=0),this._recordPlaceholderInfo(f,d),f++}return aH.push(s),hH=(uH=i+1)*TH*_H,1<uH&&(hH+=0*(uH-1)),bH.width=AH,bH.height=kH,AH<=0&&(bH.width=parseFloat(a.toFixed(2))),kH<=0&&(bH.height=parseFloat(hH.toFixed(2))),dH=bH.height,(pH=0)<o&&(dH=bH.height+o),l<-hH&&(pH=hH+l),!0},_getFirstCharLen:function(){return 1},_getFirstWordLen:function(e,t,i){var n=e.charAt(t);if(Xs(n)||"\n"===n||Ys(n))return 1;var r=1,a=lH&&lH.getLetterDefinitionForChar(n);if(!a)return r;for(var s=a._xAdvance*_H+wH,o=t+1;o<i&&(n=e.charAt(o),a=lH&&lH.getLetterDefinitionForChar(n));++o){if(s+a._offsetX*_H+a._width*_H>RH&&!Ys(n)&&0<RH)return r;if(s+=a._xAdvance*_H+wH,"\n"===n||Ys(n)||Xs(n))break;r++}return r},_multilineTextWrapByWord:function(){return this._multilineTextWrap(this._getFirstWordLen)},_multilineTextWrapByChar:function(){return this._multilineTextWrap(this._getFirstCharLen)},_recordPlaceholderInfo:function(e,t){if(e>=rH.length){var i=new eH;rH.push(i)}rH[e].char=t,rH[e].valid=!1},_recordLetterInfo:function(e,t,i,n,r){if(n>=rH.length){var a=new eH;rH.push(a)}var s=i.charCodeAt(0);rH[n].lineIndex=r,rH[n].char=i,rH[n].valid=e[s].validDefinition,rH[n].positionX=t.x,rH[n].positionY=t.y},_alignText:function(){hH=0,aH.length=0,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),EH===vz.SHRINK&&0<yH&&this._isVerticalClamp()&&this._shrinkLabelToContentSize(this._isVerticalClamp),this._updateQuads()||EH===vz.SHRINK&&this._shrinkLabelToContentSize(this._isHorizontalClamp)},_scaleFontSizeDown:function(e){var t=!0;e||(t=!(e=.1)),yH=e,t&&this._updateContent()},_shrinkLabelToContentSize:function(e){for(var t=yH,i=TH,n=lH,r=0,a=n?n.cloneLetterDefinition():{},s=!0;e();){var o=t-++r;if(s=!1,o<=0)break;var l=o/t;n&&(n.assignLetterDefinitions(a),n.scaleFontLetterDefinition(l)),TH=i*l,this._multilineTextWrapByWord(),this._computeAlignmentOffset()}TH=i,n&&n.assignLetterDefinitions(a),s||0<=t-r&&this._scaleFontSizeDown(t-r)},_isVerticalClamp:function(){return hH>bH.height},_isHorizontalClamp:function(){if(lH){for(var e=lH.letterDefinitions,t=!1,i=0,n=mH.length;i<n;++i){var r=rH[i];if(r.valid){var a=e[r.char],s=r.positionX+a.width/2*_H,o=r.lineIndex;if(0<AH)if(CH){if(aH[o]>bH.width&&(s>bH.width||s<0)){t=!0;break}}else if(s>bH.width){t=!0;break}}}return t}},_isHorizontalClamped:function(e,t){var i=aH[t],n=e>bH.width||e<0;return CH?i>bH.width&&n:n},_updateQuads:function(){if(!iH)return!1;var e=lH?lH.letterDefinitions:{},t=vH,i=iH.node,n=iH.renderData;n.dataLength=n.vertexCount=n.indiceCount=0;for(var r=i.getAnchorPoint(),a=bH,s=r.x*a.width,o=r.y*a.height,l=!0,c=0,u=mH.length;c<u;++c){var h=rH[c];if(h.valid){var f=e[h.char.charCodeAt(0)];if(f){tH.height=f.height,tH.width=f.width,tH.x=f.u,tH.y=f.v;var d=h.positionY+fH;if(0<kH){if(dH<d){var p=d-dH;tH.y+=p,tH.height-=p,d-=p}d-f.height*_H<pH&&(tH.height=d<pH?0:d-pH)}var _=h.lineIndex,v=h.positionX+f.width/2*_H+sH[_];if(0<AH&&this._isHorizontalClamped(v,_))if(EH===vz.CLAMP)tH.width=0;else if(EH===vz.SHRINK){if(bH.width>f.width){l=!1;break}tH.width=0}if(vH&&0<tH.height&&0<tH.width){var m=vH.isRotated(),y=vH.getOriginalSize(),g=vH.getRect(),b=vH.getOffset(),x=b.x+(y.width-g.width)/2,S=b.y-(y.height-g.height)/2;if(m){var w=tH.x;tH.x=g.x+g.height-tH.y-tH.height-S,tH.y=w+g.y-x,tH.y<0&&(tH.height=tH.height+S)}else tH.x+=g.x-x,tH.y+=g.y+S;var T=h.positionX+sH[h.lineIndex];this.appendQuad(iH,t,tH,m,T-s,d-o,_H)}}else console.warn("Can't find letter in this bitmap-font")}}return l},appendQuad:function(e,t,i,n,r,a,s){},_computeAlignmentOffset:function(){switch(sH.length=0,xH){case fz.LEFT:for(var e=0;e<uH;++e)sH.push(0);break;case fz.CENTER:for(var t=0,i=aH.length;t<i;t++)sH.push((bH.width-aH[t])/2);break;case fz.RIGHT:for(var n=0,r=aH.length;n<r;n++)sH.push(bH.width-aH[n])}switch(SH){case pz.TOP:fH=bH.height;break;case pz.CENTER:fH=(bH.height+hH)/2;break;case pz.BOTTOM:fH=hH}},_setupBMFontOverflowMetrics:function(){var e=bH.width,t=bH.height;EH===vz.RESIZE_HEIGHT&&(t=0),EH===vz.NONE&&(t=e=0),AH=e,kH=t,oH.width=e,oH.height=t,RH=e}},MH=P2("bmfont",{createData:function(e){return e.requestRenderData()},fillBuffers:function(e,t){jI(e.node,t,e.renderData,e.color)},appendQuad:function(e,t,i,n,r,a,s){var o=e.renderData;if(o){var l=o.dataLength;o.dataLength+=4,o.vertexCount=o.dataLength,o.indiceCount=o.dataLength/2*3;var c=o.datas,u=t.width,h=t.height,f=i.width,d=i.height,p=0,_=0,v=0,m=0;n?(p=i.x/u,m=(i.x+d)/u,_=(i.y+f)/h,v=i.y/h,c[l].u=p,c[l].v=v,c[l+1].u=p,c[l+1].v=_,c[l+2].u=m,c[l+2].v=v,c[l+3].u=m,c[l+3].v=_):(p=i.x/u,m=(i.x+f)/u,_=(i.y+d)/h,v=i.y/h,c[l].u=p,c[l].v=_,c[l+1].u=m,c[l+1].v=_,c[l+2].u=p,c[l+2].v=v,c[l+3].u=m,c[l+3].v=v),c[l].x=r,c[l].y=a-d*s,c[l+1].x=r+f*s,c[l+1].y=a-d*s,c[l+2].x=r,c[l+2].y=a,c[l+3].x=r+f*s,c[l+3].y=a}}});Fe(MH,OH);function IH(){y(this,IH),this.char="",this.valid=!0,this.x=0,this.y=0,this.line=0,this.hash=""}function LH(){y(this,LH),this.u=0,this.v=0,this.w=0,this.h=0,this.texture=null,this.offsetX=0,this.offsetY=0,this.valid=!1,this.xAdvance=0}var zH=kz.Overflow,BH=rr.WHITE.clone(),PH=kz.HorizontalAlign,DH=kz.VerticalAlign,FH=function(){function i(e,t){y(this,i),this.spriteframe=null,this.labelInfo=void 0,this.char=void 0,this.data=null,this.canvas=null,this.context=null,this.width=0,this.height=0,this.hash=void 0,this._lastImage=null,this.char=e,this.labelInfo=t,this.hash=e.charCodeAt(0)+t.hash}return l(i,[{key:"updateRenderData",value:function(){this._updateProperties(),this._updateTexture()}},{key:"destroy",value:function(){this.spriteframe&&(this.spriteframe.texture.destroy(),this.spriteframe.destroy(),this.spriteframe=null)}},{key:"_updateProperties",value:function(){if(this.spriteframe=new Eh,this.data=kz.CanvasPool.get(),this.canvas=this.data.canvas,this.context=this.data.context,this.context){this.context.font=this.labelInfo.fontDesc;var e=Qs(this.context,this.char);this.width=parseFloat(e.toFixed(2)),this.height=this.labelInfo.fontSize}this.canvas.width!==this.width&&(this.canvas.width=this.width),this.canvas.height!==this.height&&(this.canvas.height=this.height),this._lastImage&&(this._lastImage._texture.destroy(),this._lastImage.destroy());var t=new zu(this.canvas),i=(this._lastImage=t)._texture;this.spriteframe.texture=i}},{key:"_updateTexture",value:function(){if(this.context&&this.canvas){var e=this.context,t=this.labelInfo,i=this.canvas.width,n=this.canvas.height;e.textAlign="center",e.textBaseline="middle",e.clearRect(0,0,i,n),e.fillStyle="rgba(255, 255, 255, 0.005)",e.fillRect(0,0,i,n),e.font=t.fontDesc;var r=i/2,a=n/2,s=t.color;if(e.lineJoin="round",e.fillStyle="rgba(".concat(s.r,", ").concat(s.g,", ").concat(s.b,", ",1,")"),t.isOutlined){var o=t.out||BH;e.strokeStyle="rgba(".concat(o.r,", ").concat(o.g,", ").concat(o.b,", ").concat(o.a/255,")"),e.lineWidth=2*t.margin,e.strokeText(this.char,r,a)}e.fillText(this.char,r,a),this.spriteframe.texture.updateImage()}}}]),i}(),NH=function(){function e(){return y(this,e),x(this,g(e).apply(this,arguments))}return p(e,vh),l(e,[{key:"initWithSize",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:mu.RGBA8888;this.destroy(),this.reset({width:e,height:t,format:n}),this.loaded=!0,this.emit("load")}},{key:"drawTextureAt",value:function(e,t,i){var n=this.getGFXTexture();if(e._image&&n){var r=this._getGFXDevice();if(r){var a={buffOffset:0,buffStride:0,buffTexHeight:0,texOffset:{x:t,y:i,z:0},texExtent:{width:e._image.width,height:e._image.height,depth:1},texSubres:{baseMipLevel:0,levelCount:1,baseArrayLayer:0,layerCount:1}};r.copyTexImagesToTexture([e._image.data],n,[a])}else console.warn("Unable to get device")}}}]),e}(),UH=function(){function i(e,t){y(this,i),this.texture=void 0,this._x=2,this._y=2,this._nexty=2,this._width=0,this._height=0,this._letterDefinitions=new Map,this._imageAssets=[],this._dirty=!1,this.texture=new NH,this.texture.initWithSize(e,t),this._width=e,this._height=t,Yb.on(Xb.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)}return l(i,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),l(i,[{key:"insertLetterTexture",value:function(e){var t=e.spriteframe,i=Yb.root.device;if(!(t&&this.texture&&i&&t._image))return null;var n=t.width,r=t.height;if(this._x+n+2>this._width&&(this._x=2,this._y=this._nexty),this._y+r>this._nexty&&(this._nexty=this._y+r+2),this._nexty>this._height)return null;this.texture.drawTextureAt(t,this._x,this._y),this._dirty=!0;var a=new LH;return a.u=this._x,a.v=this._y,a.texture=this.texture,a.valid=!0,a.w=e.width,a.h=e.height,a.xAdvance=e.width,this._x+=n+2,this._letterDefinitions.set(e.hash,a),a}},{key:"update",value:function(){this._dirty&&(this._dirty=!1)}},{key:"reset",value:function(){this._x=2,this._y=2,this._nexty=2,this._letterDefinitions.clear()}},{key:"destroy",value:function(){this.reset(),this.texture&&this.texture.destroy()}},{key:"beforeSceneLoad",value:function(){this.destroy();var e=new NH;e.initWithSize(this._width,this._height),this.texture=e}},{key:"getLetter",value:function(e){return this._letterDefinitions.get(e)}},{key:"addLetterDefinitions",value:function(e,t){this._letterDefinitions[e]=t}},{key:"cloneLetterDefinition",value:function(){for(var e={},t=0,i=Object.keys(this._letterDefinitions);t<i.length;t++){var n=i[t],r=new LH;Ne(r,this._letterDefinitions[n]),e[n]=r}return e}},{key:"assignLetterDefinitions",value:function(e){var i=this;e.forEach(function(e,t){Ne(i._letterDefinitions[t],e)})}},{key:"scaleFontLetterDefinition",value:function(e){for(var t=0,i=Object.keys(this._letterDefinitions);t<i.length;t++){var n=i[t],r=this._letterDefinitions[n];r.w*=e,r.h*=e,r.offsetX*=e,r.offsetY*=e,r.xAdvance*=e}}},{key:"getLetterDefinitionForChar",value:function(e,t){var i=e.charCodeAt(0)+t.hash,n=this._letterDefinitions.get(i);if(!n){var r=new FH(e,t);r.updateRenderData(),n=this.insertLetterTexture(r),r.destroy()}return n}}]),i}(),VH=new Zn,GH=null,HH=[],qH=[],jH=[],WH=[],XH=new jn,YH=null,QH=0,KH=0,ZH=0,JH=0,$H=0,eq=1,tq="",iq=0,nq=0,rq=new jn,aq=0,sq=0,oq=0,lq=0,cq=0,uq=!1,hq=0,fq=0,dq=0,pq="",_q=!1,vq={fontSize:0,lineHeight:0,hash:"",fontFamily:"",fontDesc:"Arial",hAlign:0,vAlign:0,color:BH,isOutlined:!1,out:BH,margin:0},mq={getAssemblerData:function(){return(YH=YH||new UH(1024,1024)).texture},updateRenderData:function(e){e.renderData&&e.renderData.vertDirty&&GH!==e&&(GH=e,this._updateFontFamily(e),vq.fontFamily=pq,this._updateProperties(),vq.fontDesc=this._getFontDesc(),this._updateContent(),GH.actualFontSize=iq,GH.node.setContentSize(rq),GH.renderData.vertDirty=GH.renderData.uvDirty=!1,GH=null,this._resetProperties())},_updateFontScale:function(){eq=iq/nq},_updateProperties:function(){if(GH){tq=GH.string.toString(),iq=GH.fontSize,nq=iq;var e=GH.node.getContentSize();rq.width=e.width,rq.height=e.height,aq=GH.horizontalAlign,sq=GH.verticalAlign,oq=GH.spacingX,cq=GH.overflow,lq=GH.lineHeight,_q=GH.isBold,uq=cq!==zH.NONE&&(cq===zH.RESIZE_HEIGHT||GH.enableWrapText);var t=GH.getComponent(BD);t&&t.enabled?(vq.isOutlined=!0,vq.margin=t.width,vq.out=t.color,vq.out.a=t.color.a*GH.color.a/255):(vq.isOutlined=!1,vq.margin=0),vq.lineHeight=lq,vq.fontSize=iq,vq.fontFamily=pq,vq.color=GH.color,vq.hash=this._computeHash(vq),this._setupBMFontOverflowMetrics()}},_updateFontFamily:function(i){i.useSystemFont?pq=i.fontFamily:i.font?i.font._nativeAsset?pq=i.font._nativeAsset:(pq=Kw.getRes(i.font.nativeUrl)||"")||Kw.load(i.font.nativeUrl,function(e,t){pq=t||"Arial",i.font&&(i.font._nativeAsset=t),i.updateRenderData(!0)}):pq="Arial"},_computeHash:function(e){var t=e.color.toHEX("#rrggbb"),i="";return e.isOutlined&&(i=e.out.toHEX("#rrggbb")),""+e.fontSize+e.fontFamily+t+i},_getFontDesc:function(){var e=iq.toString()+"px ";return e+=pq,_q&&(e="bold "+e),e},_resetProperties:function(){},_updateContent:function(){this._updateFontScale(),this._alignText()},_computeHorizontalKerningForText:function(){},_multilineTextWrap:function(e){var t=tq.length,i=0,n=0,r=0,a=0,s=0,o=0,l=0,c=null,u=new Mi(0,0);this._updateFontScale();for(var h=0;h<t;){var f=tq.charAt(h);if("\n"!==f){for(var d=e(tq,h,t),p=o,_=l,v=s,m=n,y=!1,g=0;g<d;++g){var b=h+g;if("\r"!==(f=tq.charAt(b)))if(c=YH&&YH.getLetterDefinitionForChar(f,vq)){var x=m+c.offsetX*eq;if(uq&&0<dq&&0<n&&x+c.w*eq>dq&&!Ys(f)){jH.push(s),i++,r-=lq*eq+(n=s=0),y=!0;break}u.x=x,u.y=r-c.offsetY*eq,this._recordLetterInfo(u,f,b,i),b+1<HH.length&&b<t-1&&(m+=HH[b+1]),m+=c.xAdvance*eq+oq,v=u.x+c.w*eq,p<u.y&&(p=u.y),_>u.y-c.h*eq&&(_=u.y-c.h*eq)}else this._recordPlaceholderInfo(b,f);else this._recordPlaceholderInfo(b,f)}y||(n=m,o<p&&(o=p),_<l&&(l=_),a<(s=v)&&(a=s),h+=d)}else jH.push(s),i++,r-=lq*eq+(n=s=0),this._recordPlaceholderInfo(h,f),h++}return jH.push(s),KH=(QH=i+1)*lq*eq,1<QH&&(KH+=0*(QH-1)),rq.width=hq,rq.height=fq,hq<=0&&(rq.width=parseFloat(a.toFixed(2))),fq<=0&&(rq.height=parseFloat(KH.toFixed(2))),JH=rq.height,($H=0)<o&&(JH=rq.height+o),l<-KH&&($H=KH+l),!0},_getFirstCharLen:function(){return 1},_getFirstWordLen:function(e,t,i){var n=e.charAt(t);if(Xs(n)||"\n"===n||Ys(n))return 1;if(YH){var r=1,a=YH.getLetterDefinitionForChar(n,vq);if(!a)return r;for(var s=a.xAdvance*eq+oq,o=t+1;o<i&&(n=e.charAt(o),a=YH.getLetterDefinitionForChar(n,vq));++o){if(s+a.offsetX*eq+a.w*eq>dq&&!Ys(n)&&0<dq)return r;if(s+=a.xAdvance*eq+oq,"\n"===n||Ys(n)||Xs(n))break;r++}return r}},_multilineTextWrapByWord:function(){return this._multilineTextWrap(this._getFirstWordLen)},_multilineTextWrapByChar:function(){return this._multilineTextWrap(this._getFirstCharLen)},_recordPlaceholderInfo:function(e,t){if(e>=qH.length){var i=new IH;qH.push(i)}qH[e].char=t,qH[e].hash=t.charCodeAt(0)+vq.hash,qH[e].valid=!1},_recordLetterInfo:function(e,t,i,n){if(i>=qH.length){var r=new IH;qH.push(r)}var a=t.charCodeAt(0)+vq.hash;qH[i].line=n,qH[i].char=t,qH[i].hash=a;var s=YH&&YH.getLetter(a);qH[i].valid=!!s&&!!s.valid,qH[i].x=e.x,qH[i].y=e.y},_alignText:function(){KH=0,jH.length=0,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),this._updateQuads()},_scaleFontSizeDown:function(e){var t=!0;e||(t=!(e=.1)),iq=e,t&&this._updateContent()},_isVerticalClamp:function(){return KH>rq.height},_isHorizontalClamp:function(){for(var e=!1,t=0,i=tq.length;t<i;++t){var n=qH[t];if(n.valid){var r=YH.getLetter(n.hash);if(!r)continue;var a=n.x+r.w*eq,s=n.line;if(0<hq)if(uq){if(jH[s]>rq.width&&(a>rq.width||a<0)){e=!0;break}}else if(a>rq.width){e=!0;break}}}return e},_isHorizontalClamped:function(e,t){var i=jH[t],n=e>rq.width||e<0;return uq?i>rq.width&&n:n},_updateQuads:function(){if(GH&&YH){var e=YH.texture,t=GH.node,i=GH.renderData;i.dataLength=i.vertexCount=i.indiceCount=0;for(var n=rq,r=t.getAnchorPoint(),a=r.x*n.width,s=r.y*n.height,o=!0,l=0,c=tq.length;l<c;++l){var u=qH[l];if(u.valid){var h=YH.getLetter(u.hash);if(h){VH.height=h.h,VH.width=h.w,VH.x=h.u,VH.y=h.v;var f=u.y+ZH;if(0<fq){if(JH<f){var d=f-JH;VH.y+=d,VH.height-=d,f-=d}f-h.h*eq<$H&&(VH.height=f<$H?0:f-$H)}var p=u.line,_=u.x+h.w/2*eq+WH[p];if(0<hq&&this._isHorizontalClamped(_,p))if(cq===zH.CLAMP)VH.width=0;else if(cq===zH.SHRINK){if(rq.width>h.w){o=!1;break}VH.width=0}if(0<VH.height&&0<VH.width){var v=u.x+WH[u.line];this.appendQuad(i,e,VH,!1,v-a,f-s,eq)}}}}return o}},appendQuad:function(e,t,i,n,r,a,s){},_computeAlignmentOffset:function(){switch(WH.length=0,aq){case PH.LEFT:for(var e=0;e<QH;++e)WH.push(0);break;case PH.CENTER:for(var t=0,i=jH.length;t<i;t++)WH.push((rq.width-jH[t])/2);break;case PH.RIGHT:for(var n=0,r=jH.length;n<r;n++)WH.push(rq.width-jH[n])}switch(sq){case DH.TOP:ZH=rq.height;break;case DH.CENTER:ZH=(rq.height+KH)/2-(lq-iq)/2;break;case DH.BOTTOM:ZH=(rq.height+KH)/2-(lq-iq)}},_setupBMFontOverflowMetrics:function(){var e=rq.width,t=rq.height;cq===zH.RESIZE_HEIGHT&&(t=0),cq===zH.NONE&&(t=e=0),hq=e,fq=t,XH.width=e,XH.height=t,dq=e}},yq=new rr(255,255,255,255),gq=P2("letter",{createData:function(e){return e.requestRenderData()},fillBuffers:function(e,t){if(e.renderData){var i=e.node;yq.a=e.color.a,jI(i,t,e.renderData,yq)}},appendQuad:MH.appendQuad});Fe(gq,mq);var bq=kz.Overflow,xq=rr.WHITE.clone(),Sq=Ge(BD,Bv),wq=null,Tq=null,Eq=null,Cq="",Aq="",kq=0,Rq=0,Oq=[],Mq=new jn,Iq=0,Lq=0,zq=0,Bq=new rr,Pq="",Dq=bq.NONE,Fq=!1,Nq=!1,Uq=new rr,Vq=0,Gq=0,Hq=!1,qq=!1,jq=!1,Wq=new bz,Xq={getAssemblerData:function(){var e=document.createElement("canvas"),t={canvas:e,context:e.getContext("2d")};return t.canvas.width=t.canvas.height=1,t},resetAssemblerData:function(e){cc.game.renderType===cc.game.RENDER_TYPE_CANVAS&&e&&Wq.put(e)},updateRenderData:function(e){e.renderData&&e.renderData.vertDirty&&(this._updateFontFamly(e),this._updateProperties(e),this._calculateLabelFont(),this._calculateSplitedStrings(),this._updateLabelDimensions(),this._calculateTextBaseline(),this._updateTexture(),e.actualFontSize=kq,e.node.setContentSize(Mq),this.updateVerts(e),e.markForUpdateRenderData(!1),Eq=Tq=wq=null)},updateVerts:function(e){},_updateFontFamly:function(i){i.useSystemFont?Pq=i.fontFamily:i.font?i.font._nativeAsset?Pq=i.font._nativeAsset:Kw.load(i.font.nativeUrl,function(e,t){Pq=t||"Arial",i.updateRenderData(!0)}):Pq="Arial"},_updateProperties:function(e){var t=e.assemblerData;if(t){wq=t.context,Tq=t.canvas,Eq=e.spriteFrame,Aq=e.string.toString(),kq=e.fontSize,Rq=kq,Dq=e.overflow,Mq.width=e.node.width,Mq.height=e.node.height,Iq=e.lineHeight,Lq=e.horizontalAlign,zq=e.verticalAlign,Bq=e.color,Hq=e.isBold,qq=e.isItalic,jq=e.isUnderline,Fq=Dq!==bq.NONE&&(Dq===bq.RESIZE_HEIGHT||e.enableWrapText);var i=Sq&&e.getComponent(BD);i&&i.enabled?(Nq=!0,Gq=Vq=i.width,(Uq=i.color.clone()).a=Uq.a*e.color.a/255):(Nq=!1,Gq=0)}},_calculateFillTextStartPosition:function(){var e,t,i=this._getLineHeight(),n=Oq.length;return e=Lq===fz.RIGHT?Mq.width-Gq:Lq===fz.CENTER?Mq.width/2:0+Gq,t=zq===pz.TOP?0:zq===pz.CENTER?Mq.height/2-i*(n-1)/2:Mq.height-i*(n-1),new Mi(e,t)},_updateTexture:function(){if(wq&&Tq){wq.clearRect(0,0,Tq.width,Tq.height),wq.font=Cq;var e,t=this._calculateFillTextStartPosition(),i=this._getLineHeight();wq.lineJoin="round",wq.fillStyle="rgba(".concat(Bq.r,", ").concat(Bq.g,", ").concat(Bq.b,", ").concat(Bq.a/255,")");for(var n=0;n<Oq.length;++n){if(Nq){var r=Uq||xq;wq.strokeStyle="rgba(".concat(r.r,", ").concat(r.g,", ").concat(r.b,", ").concat(r.a/255,")"),wq.lineWidth=2*Vq,wq.strokeText(Oq[n],t.x,t.y+n*i)}wq.fillText(Oq[n],t.x,t.y+n*i),jq&&(e=this._calculateUnderlineStartPosition(),wq.save(),wq.beginPath(),wq.lineWidth=kq/8,wq.strokeStyle="rgba(".concat(Bq.r,", ").concat(Bq.g,", ").concat(Bq.b,", ").concat(Bq.a/255,")"),wq.moveTo(e.x,e.y+n*i-1),wq.lineTo(e.x+Tq.width,e.y+n*i-1),wq.stroke(),wq.restore())}if(Eq){var a;a=Eq instanceof Eh?Eq.texture:Eq;var s=0===Tq.width||0===Tq.height;a.reset({width:Tq.width,height:Tq.height,mipmapLevel:s?0:1}),s||a.uploadData(Tq)}}},_calculateUnderlineStartPosition:function(){var e,t,i=this._getLineHeight(),n=Oq.length;return e=0+Gq,t=zq===pz.TOP?kq:zq===pz.CENTER?Mq.height/2-i*(n-1)/2+kq/2:Mq.height-i*(n-1),new Mi(e,t)},_updateLabelDimensions:function(){if(wq){var e=Aq.split("\n");if(Dq===bq.RESIZE_HEIGHT)Mq.height=Oq.length*this._getLineHeight();else if(Dq===bq.NONE){var t=0,i=0,n=Oq=e,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=Qs(wq,s);t=o<t?t:o}i=Oq.length*this._getLineHeight(),Mq.width=parseFloat(t.toFixed(2))+2*Gq,Mq.height=parseFloat(i.toFixed(2)),qq&&(Mq.width+=Rq*Math.tan(.20943951))}Tq&&(Tq.width=Mq.width,Tq.height=Mq.height)}},_calculateTextBaseline:function(){var e,t;e=Lq===fz.RIGHT?"right":Lq===fz.CENTER?"center":"left",t=zq===pz.TOP?"top":zq===pz.CENTER?"middle":"bottom",wq&&(wq.textAlign=e,wq.textBaseline=t)},_calculateSplitedStrings:function(){if(wq){var e=Aq.split("\n");if(Fq){Oq=[];var t=Mq.width-2*Gq,i=e,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=Ks(a,Qs(wq,a),t,this._measureText(wq));Oq=Oq.concat(s)}}else Oq=e}},_getFontDesc:function(){var e=kq.toString()+"px ";return e+=Pq,Hq&&(e="bold "+e),qq&&(e="italic "+e),e},_getLineHeight:function(){var e=Iq;return 0|(e=0===e?kq:e*kq/Rq)},_calculateParagraphLength:function(e,t){var i=[],n=e,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=Qs(t,s);i.push(o)}return i},_measureText:function(t){return function(e){return Qs(t,e)}},_calculateLabelFont:function(){if(wq&&(Cq=this._getFontDesc(),wq.font=Cq,Dq===bq.SHRINK)){var e=Aq.split("\n"),t=this._calculateParagraphLength(e,wq);Oq=e;var i=0,n=0,r=0;if(Fq){var a=Mq.width-2*Gq,s=Mq.height-2*Gq;if(a<0||s<0)return Cq=this._getFontDesc(),void(wq.font=Cq);n=1+s,r=1+a;for(var o=kq+1,l=[],c=!0,u=0|o;s<n||a<r;){if(c?o=u/2|0:u=o=u-1,o<=0){L(4003);break}for(kq=o,Cq=this._getFontDesc(),wq.font=Cq,Oq=[],i=n=0;i<e.length;++i){var h=0,f=Qs(wq,e[i]);for(l=Ks(e[i],f,a,this._measureText(wq));h<l.length;){r=Qs(wq,l[h]),n+=this._getLineHeight(),++h}Oq=Oq.concat(l)}c&&(s<n?u=0|o:(c=!1,n=1+s))}}else{for(n=e.length*this._getLineHeight(),i=0;i<e.length;++i)r<t[i]&&(r=t[i]);var d=(Mq.width-2*Gq)/r,p=Mq.height/n;kq=Rq*Math.min(1,d,p)|0,Cq=this._getFontDesc(),wq.font=Cq}}}},Yq=rr.WHITE.clone(),Qq=P2("ttf",{createData:function(e){var t=e.requestRenderData();t.dataLength=4,t.vertexCount=4,t.indiceCount=6;var i=t.vData=new Float32Array(36);i[3]=i[21]=i[22]=i[31]=0,i[4]=i[12]=i[13]=i[30]=1;for(var n=5,r=0;r<4;r++)rr.toArray(i,Yq,n),n+=9;return t},fillBuffers:function(e,t){var i=e.renderData,n=i.datas,r=e.node,a=t.currBufferBatch,s=a.byteOffset>>2,o=a.indiceOffset,l=a.vertexOffset;a.request()||(a=t.currBufferBatch,l=o=0);var c=a.vData,u=a.iData,h=i.vData,f=n[0],d=n[3];r.updateWorldTransform();var p=r._pos,_=r._rot,v=r._scale,m=f.x*v.x,y=d.x*v.x,g=f.y*v.y,b=d.y*v.y,x=_.x,S=_.y,w=_.z,T=_.w,E=x*S,C=w*T,A=x*x-S*S,k=T*T-w*w,R=k+A,O=2*(E-C),M=k-A,I=2*(E+C),L=p.x,z=p.y;h[0]=R*m+O*g+L,h[1]=M*g+I*m+z,h[9]=R*y+O*g+L,h[10]=M*g+I*y+z,h[18]=R*m+O*b+L,h[19]=M*b+I*m+z,h[27]=R*y+O*b+L,h[28]=M*b+I*y+z,c.set(h,s),u[o++]=l,u[o++]=l+1,u[o++]=l+2,u[o++]=l+2,u[o++]=l+1,u[o++]=l+3},updateVerts:function(e){var t=e.renderData;if(t){var i=e.node,n=i.width,r=i.height,a=i.anchorX*n,s=i.anchorY*r,o=t.datas;o[0].x=-a,o[0].y=-s,o[3].x=n-a,o[3].y=r-s}}});Fe(Qq,Xq);var Kq=P2("labelAssembler",{getAssembler:function(e){var t=Qq;return e.font instanceof hw?t=MH:e.cacheMode===kz.CacheMode.CHAR&&(ul.browserType===ul.BROWSER_TYPE_WECHAT_GAME_SUB?C("sorry, subdomain does not support CHAR mode currently!"):t=gq),t}});kz.Assembler=Kq;var Zq=Ib.sharedManager,Jq=P2("mask",{createData:function(e){var t=e.requestRenderData();return t.dataLength=4,t.vertexCount=4,t.indiceCount=6,t},updateRenderData:function(e){var t=e.renderData;t&&t.vertDirty&&this.updateVerts&&this.updateVerts(e)},updateVerts:function(e){var t=e.renderData;if(t){var i,n,r,a,s=e.node,o=t.datas,l=s.width,c=s.height,u=s.anchorX*l,h=s.anchorY*c;i=-u,n=-h,r=l-u,a=c-h,o[0].x=i,o[0].y=n,o[3].x=r,o[3].y=a,t.vertDirty=!1}},fillBuffers:function(e,t){Zq.pushMask(e),Zq.clear(),e.clearGraphics.updateAssembler(t),Zq.enterLevel(),e.graphics.updateAssembler(t),Zq.enableMask()}}),$q=P2("maskEnd",{fillBuffers:function(e,t){Zq.exitMask()}}),ej={getAssembler:function(){return Jq}},tj={getAssembler:function(){return $q}};uD.Assembler=ej,uD.PostAssembler=tj;var ij=CL.FillType,nj=new zn,rj=P2("barFilled",{useModel:!1,updateRenderData:function(e){var t=e.spriteFrame,i=e.renderData;if(i&&t){var n=i.uvDirty,r=i.vertDirty;if(!n&&!r)return;var a=e.fillStart,s=e.fillRange;s<0&&(a+=s,s=-s),s=(s=1<(s=a+s)?1:s)<0?0:s;var o=(a=(a=1<a?1:a)<0?0:a)+(s=(s-=a)<0?0:s);o=1<o?1:o,n&&this.updateUVs(e,a,o),r&&(this.updateVerts&&this.updateVerts(e,a,o),this.updateWorldVerts(e))}},updateUVs:function(e,t,i){var n=e.spriteFrame,r=e.renderData,a=r.datas,s=n.width,o=n.height,l=n.getRect(),c=0,u=0,h=0,f=0,d=0,p=0,_=0,v=0,m=0,y=0;switch(n.isRotated()?(c=l.x/s,u=(l.y+l.width)/o,h=d=c,_=m=(l.x+l.height)/s,p=y=u,f=v=l.y/o):(c=l.x/s,u=(l.y+l.height)/o,h=_=c,d=m=(l.x+l.width)/s,f=p=u,v=y=l.y/o),e.fillType){case ij.HORIZONTAL:a[0].u=h+(d-h)*t,a[0].v=f+(p-f)*t,a[1].u=h+(d-h)*i,a[1].v=f+(p-f)*i,a[2].u=_+(m-_)*t,a[2].v=v+(y-v)*t,a[3].u=_+(m-_)*i,a[3].v=v+(y-v)*i;break;case ij.VERTICAL:a[0].u=h+(_-h)*t,a[0].v=f+(v-f)*t,a[1].u=d+(m-d)*t,a[1].v=p+(y-p)*t,a[2].u=h+(_-h)*i,a[2].v=f+(v-f)*i,a[3].u=d+(m-d)*i,a[3].v=p+(y-p)*i;break;default:D(2626)}r.uvDirty=!1},updateVerts:function(e,t,i){var n=e.renderData,r=n.datas,a=e.node,s=a.width,o=a.height,l=a.anchorX*s,c=a.anchorY*o,u=-l,h=-c,f=s-l,d=o-c,p=0;switch(e.fillType){case ij.HORIZONTAL:p=u+(f-u)*i,u=u+(f-u)*t,f=p;break;case ij.VERTICAL:p=h+(d-h)*i,h=h+(d-h)*t,d=p;break;default:D(2626)}r[4].x=u,r[4].y=h,r[5].x=f,r[5].y=h,r[6].x=u,r[6].y=d,r[7].x=f,r[7].y=d,n.vertDirty=!1},createData:function(e){var t=e.requestRenderData();t.dataLength=8,t.vertexCount=4,t.indiceCount=6;var i=t.datas,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}a.z=0}return t},updateWorldVerts:function(e){var t=e.node,i=e.renderData.datas;t.getWorldMatrix(nj);for(var n=0;n<4;n++){var r=i[n+4],a=i[n];Fi.transformMat4(a,r,nj)}},fillBuffers:function(e,t){e.node.hasChangedFlags&&this.updateWorldVerts(e);e.node;!function(e,t,i,n){var r=i.datas,a=t.currBufferBatch,s=a.byteOffset>>2,o=i.vertexCount,l=a.indiceOffset,c=a.vertexOffset;a.request(o,i.indiceCount)||(a=t.currBufferBatch,c=l=o=0);for(var u=a.vData,h=0;h<o;h++){var f=r[h];u[s++]=f.x,u[s++]=f.y,u[s++]=f.z,u[s++]=f.u,u[s++]=f.v,rr.toArray(u,n,s),s+=4}var d=a.iData;d[l++]=c,d[l++]=c+1,d[l++]=c+2,d[l++]=c+1,d[l++]=c+3,d[l++]=c+2}(0,t,e.renderData,e.color)}}),aj=2*Math.PI,sj=[new Mi,new Mi,new Mi,new Mi],oj=new Array(4),lj=new Array(8),cj=[new Mi,new Mi,new Mi,new Mi],uj=[new Mi,new Mi,new Mi,new Mi],hj=new Mi,fj=[new Mi,new Mi,new Mi,new Mi];function dj(e,t,i,n,r,a,s){var o=Math.sin(a);o=1e-6<Math.abs(o)?o:0;var l=Math.cos(a),c=0,u=0;if(0!==(l=1e-6<Math.abs(l)?l:0)){if(c=o/l,0<(e-r.x)*l){var h=r.y+c*(e-r.x);s[0].x=e,s[0].y=h}if(0<(t-r.x)*l){var f=r.y+c*(t-r.x);s[2].x=t,s[2].y=f}}if(0!==o){if(u=l/o,0<(n-r.y)*o){var d=r.x+u*(n-r.y);s[3].x=d,s[3].y=n}if(0<(i-r.y)*o){var p=r.x+u*(i-r.y);s[1].x=p,s[1].y=i}}}function pj(e,t){var i=t.x-e.x,n=t.y-e.y;if(0==i&&0==n)return 0;if(0==i)return 0<n?.5*Math.PI:1.5*Math.PI;var r=Math.atan(n/i);return i<0&&(r+=Math.PI),r}function _j(e,t,i,n,r){var a=oj,s=a[0],o=a[1],l=a[2],c=a[3];e[t].x=i.x,e[t].y=i.y,e[t+1].x=n.x,e[t+1].y=n.y,e[t+2].x=r.x,e[t+2].y=r.y;vj((i.x-s)/(l-s),(i.y-o)/(c-o),e,t),vj((n.x-s)/(l-s),(n.y-o)/(c-o),e,t+1),vj((r.x-s)/(l-s),(r.y-o)/(c-o),e,t+2)}function vj(e,t,i,n){var r=lj,a=r[0]+(r[2]-r[0])*e,s=r[4]+(r[6]-r[4])*e,o=r[1]+(r[3]-r[1])*e,l=r[5]+(r[7]-r[5])*e,c=i[n];c.u=a+(s-a)*t,c.v=o+(l-o)*t}for(var mj=P2("radialFilled",{useModel:!1,createData:function(e){return e.requestRenderData()},updateRenderData:function(e){var t=e.spriteFrame,i=e.renderData;if(i&&t&&(i.vertDirty||i.uvDirty)){var n=i.datas,r=e.fillStart,a=e.fillRange;for(a<0&&(r+=a,a=-a);1<=r;)r-=1;for(;r<0;)r+=1;var s=(r*=aj)+(a*=aj);!function(e){var t=e.node,i=t.width,n=t.height,r=t.anchorX*i,a=t.anchorY*n,s=-r,o=-a,l=i-r,c=n-a,u=oj;u[0]=s,u[1]=o,u[2]=l,u[3]=c;var h=e.fillCenter,f=hj.x=Math.min(Math.max(0,h.x),1)*(l-s)+s,d=hj.y=Math.min(Math.max(0,h.y),1)*(c-o)+o;sj[0].x=sj[3].x=s,sj[1].x=sj[2].x=l,sj[0].y=sj[1].y=o,sj[2].y=sj[3].y=c;for(var p=0,_=fj;p<_.length;p++){var v=_[p];Mi.set(v,0,0)}f!==u[0]&&Mi.set(fj[0],3,0),f!==u[2]&&Mi.set(fj[2],1,2),d!==u[1]&&Mi.set(fj[1],0,1),d!==u[3]&&Mi.set(fj[3],2,3)}(e),function(e){var t=e.width,i=e.height,n=e.getRect(),r=0,a=0,s=0,o=0,l=lj;e.isRotated()?(r=n.x/t,a=(n.x+n.height)/t,s=n.y/i,o=(n.y+n.width)/i,l[0]=l[2]=r,l[4]=l[6]=a,l[3]=l[7]=o,l[1]=l[5]=s):(r=n.x/t,a=(n.x+n.width)/t,s=n.y/i,o=(n.y+n.height)/i,l[0]=l[4]=r,l[2]=l[6]=a,l[1]=l[3]=o,l[5]=l[7]=s)}(t),dj(oj[0],oj[2],oj[1],oj[3],hj,r,cj),dj(oj[0],oj[2],oj[1],oj[3],hj,r+a,uj);for(var o=0,l=0;l<4;++l){var c=fj[l];if(c)if(aj<=a)i.dataLength=o+3,_j(n,o,hj,sj[c.x],sj[c.y]),o+=3;else{var u=pj(hj,sj[c.x]),h=pj(hj,sj[c.y]);h<u&&(h+=aj),u-=aj,h-=aj;for(var f=0;f<3;++f)s<=u||(r<=u?(i.dataLength=o+3,_j(n,o,hj,sj[c.x],s<=h?uj[l]:sj[c.y]),o+=3):h<=r||(h<=s?(i.dataLength=o+3,_j(n,o,hj,cj[l],sj[c.y])):(i.dataLength=o+3,_j(n,o,hj,cj[l],uj[l])),o+=3)),u+=aj,h+=aj}}i.indiceCount=i.vertexCount=o,i.vertDirty=i.uvDirty=!1}},fillBuffers:function(e,t){!function(e,t,i,n){var r=i.datas,a=t.currBufferBatch,s=a.byteOffset>>2,o=i.vertexCount,l=a.indiceOffset,c=a.vertexOffset;a.request(o,i.indiceCount)||(a=t.currBufferBatch,c=l=o=0);var u=a.vData;e.getWorldMatrix(qI);for(var h=0;h<o;h++){var f=r[h];Fi.set(HI,f.x,f.y,0),Fi.transformMat4(HI,HI,qI),u[s++]=HI.x,u[s++]=HI.y,u[s++]=HI.z,u[s++]=f.u,u[s++]=f.v,rr.toArray(u,n,s),s+=4}for(var d=a.iData,p=0;p<i.dataLength;p++)d[l+p]=c+p}(e.node,t,e.renderData,e.color)}}),yj=[],gj=0;gj<4;gj++)yj.push(new Fi);var bj,xj,Sj,wj,Tj,Ej,Cj,Aj,kj,Rj,Oj=P2("simple",{createData:function(e){var t=e.requestRenderData();return t.dataLength=4,t.vertexCount=4,t.indiceCount=6,t.vData=new Float32Array(36),t},updateRenderData:function(e){var t=e.spriteFrame,i=e.renderData;i&&t&&(i.vertDirty&&this.updateVerts(e),i.uvDirty&&this.updateUvs(e))},fillBuffers:function(e,t){if(null!==e){var i=e.renderData.datas,n=e.node,r=t.currBufferBatch,a=r.byteOffset>>2,s=r.indiceOffset,o=r.vertexOffset;r.request()||(r=t.currBufferBatch,o=s=a=0);var l=r.vData,c=r.iData,u=e.renderData.vData,h=i[0],f=i[3],d=n.worldMatrix,p=d.m00,_=d.m01,v=d.m04,m=d.m05,y=d.m12,g=d.m13,b=h.x,x=f.x,S=h.y,w=f.y,T=p*b,E=p*x,C=_*b,A=_*x,k=v*S,R=v*w,O=m*S,M=m*w;u[0]=T+k+y,u[1]=C+O+g,u[9]=E+k+y,u[10]=A+O+g,u[18]=T+R+y,u[19]=C+M+g,u[27]=E+R+y,u[28]=A+M+g,l.set(u,a),c[s++]=o,c[s++]=o+1,c[s++]=o+2,c[s++]=o+2,c[s++]=o+1,c[s++]=o+3}},updateVerts:function(e){var t=e.renderData;if(t){var i=e.node,n=t.datas,r=i.width,a=i.height,s=i.anchorX*r,o=i.anchorY*a,l=0,c=0,u=0,h=0;if(e.trim)l=-s,c=-o,u=r-s,h=a-o;else{var f=e.spriteFrame,d=f.getOriginalSize(),p=f.getRect(),_=d.width,v=d.height,m=p.width,y=p.height,g=f.getOffset(),b=r/_,x=a/v,S=g.x+(_-m)/2,w=g.x-(_-m)/2;l=S*b-s,c=(g.y+(v-y)/2)*x-o,u=r+w*b-s,h=a+(g.y-(v-y)/2)*x-o}n[0].x=l,n[0].y=c,n[0].z=0,n[3].x=u,n[3].y=h,n[3].z=0,t.vertDirty=!1}},updateUvs:function(e){var t=e.renderData,i=t.vData,n=e.spriteFrame.uv;i[3]=n[0],i[4]=n[1],i[12]=n[2],i[13]=n[3],i[21]=n[4],i[22]=n[5],i[30]=n[6],i[31]=n[7],t.uvDirty=!1},updateColor:function(e){for(var t=e.renderData.vData,i=5,n=e.color,r=n.r/255,a=n.g/255,s=n.b/255,o=n.a/255,l=0;l<4;l++)t[i]=r,t[i+1]=a,t[i+2]=s,t[i+3]=o,i+=9}}),Mj=new Fi,Ij=new zn,Lj=P2("sliced",{useModel:!1,createData:function(e){var t=e.requestRenderData();return t.dataLength=20,t.vertexCount=16,t.indiceCount=54,t},updateRenderData:function(e){var t=e.spriteFrame,i=e.renderData;i&&t&&i.vertDirty&&(this.updateVerts(e),this.updateWorldVerts(e))},updateVerts:function(e){var t=e.renderData,i=t.datas,n=e.node,r=n.width,a=n.height,s=n.anchorX*r,o=n.anchorY*a,l=e.spriteFrame,c=l.insetLeft,u=l.insetRight,h=l.insetTop,f=l.insetBottom,d=r-c-u,p=a-h-f,_=r/(c+u),v=a/(h+f);_=isNaN(_)||1<_?1:_,v=isNaN(v)||1<v?1:v,d=d<0?0:d,p=p<0?0:p,i[0].x=-s,i[0].y=-o,i[1].x=c*_-s,i[1].y=f*v-o,i[2].x=i[1].x+d,i[2].y=i[1].y+p,i[3].x=r-s,i[3].y=a-o,t.vertDirty=!1},fillBuffers:function(e,t){e.node.hasChangedFlags&&this.updateWorldVerts(e);var i=t.currBufferBatch,n=e.renderData,r=n.datas,a=i.byteOffset>>2,s=n.vertexCount,o=i.indiceOffset,l=i.vertexOffset,c=e.spriteFrame.uvSliced;i.request(s,n.indiceCount)||(i=t.currBufferBatch,l=o=a=0);for(var u=i.vData,h=i.iData,f=4;f<20;++f){var d=r[f],p=c[f-4];u[a++]=d.x,u[a++]=d.y,u[a++]=d.z,u[a++]=p.u,u[a++]=p.v,rr.toArray(u,e.color,a),a+=4}for(var _=0;_<3;++_)for(var v=0;v<3;++v){var m=l+4*_+v;h[o++]=m,h[o++]=m+1,h[o++]=m+4,h[o++]=m+1,h[o++]=m+5,h[o++]=m+4}},updateWorldVerts:function(e){var t=e.node,i=e.renderData.datas;t.getWorldMatrix(Ij);for(var n=0;n<4;++n)for(var r=i[n],a=0;a<4;++a){var s=i[a],o=i[4+4*n+a];Fi.set(Mj,s.x,r.y,0),Fi.transformMat4(o,Mj,Ij)}}}),zj=CL.Type,Bj=CL.FillType,Pj=P2("spriteAssembler",{getAssembler:function(e){var t=Oj,i=e;switch(i.type){case zj.SLICED:t=Lj;break;case zj.FILLED:t=i.fillType===Bj.RADIAL?mj:rj}return t}});CL.Assembler=Pj,cc.UI={MeshBuffer:Mb,UIVertexFormat:Db,barFilled:rj,radialFilled:mj,simple:Oj,sliced:Lj,ttf:Qq,bmfont:MH,letter:gq,mask:Jq,maskEnd:$q,graphics:KG,spriteAssembler:Pj,graphicsAssembler:ZG,labelAssembler:Kq};var Dj,Fj,Nj,Uj,Vj,Gj,Hj,qj,jj,Wj,Xj,Yj,Qj,Kj,Zj,Jj,$j,eW,tW,iW,nW,rW,aW,sW,oW,lW,cW,uW,hW,fW,dW,pW,_W,vW,mW,yW,gW,bW,xW,SW,wW,TW,EW,CW,AW,kW,RW,OW,MW,IW,LW,zW,BW,PW,DW,FW,NW,UW,VW,GW,HW,qW,jW,WW,XW,YW,QW,KW,ZW,JW,$W,eX,tX,iX,nX,rX,aX,sX,oX,lX,cX,uX,hX,fX,dX,pX,_X,vX,mX,yX,gX,bX=P2("BillboardComponent",(bj=ho("cc.BillboardComponent"),xj=yo("Components/Billboard"),Sj=fo({type:vh}),wj=fo({type:vh}),bj(Tj=xj(Tj=vo((Cj=m((Ej=function(){function t(){var e;return y(this,t),v(e=x(this,g(t).call(this)),"_texture",Cj,u(e)),v(e,"_height",Aj,u(e)),v(e,"_width",kj,u(e)),v(e,"_rotation",Rj,u(e)),e._model=null,e._mesh=null,e._material=null,e._uniform=new Wi(1,1,0,0),e}return p(t,Bv),l(t,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture=e,this._material&&this._material.setProperty("mainTexture",e)}},{key:"height",get:function(){return this._height},set:function(e){this._height=e,this._material&&(this._uniform.y=e,this._material.setProperty("cc_size_rotation",this._uniform))}},{key:"width",get:function(){return this._width},set:function(e){this._width=e,this._material&&(this._uniform.x=e,this._material.setProperty("cc_size_rotation",this._uniform))}},{key:"rotation",get:function(){return Math.round(100*yi(this._rotation))/100},set:function(e){this._rotation=mi(e),this._material&&(this._uniform.z=this._rotation,this._material.setProperty("cc_size_rotation",this._uniform))}}]),l(t,[{key:"onEnable",value:function(){this._model||this.createModel(),this._model.enabled=!0,this.width=this._width,this.height=this._height,this.rotation=this.rotation,this.texture=this.texture}},{key:"onDisable",value:function(){this._model&&(this._model.enabled=!1)}},{key:"createModel",value:function(){this._mesh=Ef({primitiveMode:Gl.TRIANGLE_LIST,positions:[0,0,0,0,0,0,0,0,0,0,0,0],uvs:[0,0,1,0,0,1,1,1],colors:[rr.WHITE.r,rr.WHITE.g,rr.WHITE.b,rr.WHITE.a,rr.WHITE.r,rr.WHITE.g,rr.WHITE.b,rr.WHITE.a,rr.WHITE.r,rr.WHITE.g,rr.WHITE.b,rr.WHITE.a,rr.WHITE.r,rr.WHITE.g,rr.WHITE.b,rr.WHITE.a],attributes:[{name:kl.ATTR_POSITION,format:Il.RGB32F},{name:kl.ATTR_TEX_COORD,format:Il.RG32F},{name:kl.ATTR_COLOR,format:Il.RGBA8UI,isNormalized:!0}],indices:[0,1,2,1,2,3]},void 0,{calculateBounds:!1}),this._model=this._getRenderScene().createModel(vf,this.node),null==this._material&&(this._material=new cp,this._material.copy(kd.get("default-billboard-material"))),this._model.initSubModel(0,this._mesh.getSubMesh(0),this._material)}}]),t}()).prototype,"_texture",[Sj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),m(Ej.prototype,"texture",[wj],Object.getOwnPropertyDescriptor(Ej.prototype,"texture"),Ej.prototype),Aj=m(Ej.prototype,"_height",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),m(Ej.prototype,"height",[fo],Object.getOwnPropertyDescriptor(Ej.prototype,"height"),Ej.prototype),kj=m(Ej.prototype,"_width",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),m(Ej.prototype,"width",[fo],Object.getOwnPropertyDescriptor(Ej.prototype,"width"),Ej.prototype),Rj=m(Ej.prototype,"_rotation",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),m(Ej.prototype,"rotation",[fo],Object.getOwnPropertyDescriptor(Ej.prototype,"rotation"),Ej.prototype),Tj=Ej))||Tj)||Tj)||Tj)),xX=[{name:kl.ATTR_POSITION,format:Il.RGB32F},{name:kl.ATTR_TEX_COORD,format:Il.RGBA32F},{name:kl.ATTR_TEX_COORD1,format:Il.RGB32F},{name:kl.ATTR_COLOR,format:Il.RGBA8,isNormalized:!0}],SX=new Fi,wX=new Fi,TX=function(){function n(e,t){var i;return y(this,n),(i=x(this,g(n).call(this,e,t)))._capacity=void 0,i._vertSize=0,i._vBuffer=null,i._vertAttrsFloatCount=0,i._vdataF32=null,i._vdataUint32=null,i._iaInfo=void 0,i._iaInfoBuffer=void 0,i._subMeshData=null,i._vertCount=0,i._indexCount=0,i._capacity=100,i._iaInfo={drawInfos:[{vertexCount:0,firstVertex:0,indexCount:0,firstIndex:0,vertexOffset:0,instanceCount:0,firstInstance:0}]},i._iaInfoBuffer=i._device.createBuffer({usage:zl.INDIRECT,memUsage:Pl.HOST|Pl.DEVICE,size:56,stride:1}),i}return p(n,vf),l(n,[{key:"setCapacity",value:function(e){this._capacity=e,this.createBuffer()}},{key:"createBuffer",value:function(){for(var e=this._vertSize=0,t=xX;e<t.length;e++){var i=t[e];i.offset=this._vertSize,this._vertSize+=Qc[i.format].size}this._vertAttrsFloatCount=this._vertSize/4,this._vBuffer=this._createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer)}},{key:"_createSubMeshData",value:function(){this._subMeshData&&this.destroySubMeshData(),this._vertCount=2,this._indexCount=6;var e=this._device.createBuffer({usage:zl.VERTEX|zl.TRANSFER_DST,memUsage:Pl.HOST|Pl.DEVICE,size:this._vertSize*this._capacity*this._vertCount,stride:this._vertSize}),t=new ArrayBuffer(this._vertSize*this._capacity*this._vertCount);e.update(t);for(var i=new Uint16Array((this._capacity-1)*this._indexCount),n=0,r=0;r<this._capacity-1;++r){var a=2*r;i[n++]=a,i[n++]=1+a,i[n++]=2+a,i[n++]=3+a,i[n++]=2+a,i[n++]=1+a}var s=this._device.createBuffer({usage:zl.INDEX|zl.TRANSFER_DST,memUsage:Pl.HOST|Pl.DEVICE,size:(this._capacity-1)*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,stride:Uint16Array.BYTES_PER_ELEMENT});return s.update(i),this._iaInfo.drawInfos[0].vertexCount=this._capacity*this._vertCount,this._iaInfo.drawInfos[0].indexCount=(this._capacity-1)*this._indexCount,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData={vertexBuffers:[e],indexBuffer:s,indirectBuffer:this._iaInfoBuffer,attributes:xX,primitiveMode:Gl.TRIANGLE_LIST,flatBuffers:[]},this.setSubModelMesh(0,this._subMeshData),t}},{key:"addLineVertexData",value:function(e,t,i){if(1<e.length){var n=0;Fi.subtract(SX,e[1],e[0]),this._vdataF32[n++]=e[0].x,this._vdataF32[n++]=e[0].y,this._vdataF32[n++]=e[0].z,this._vdataF32[n++]=0,this._vdataF32[n++]=t.evaluate(0,1),this._vdataF32[n++]=0,this._vdataF32[n++]=0,this._vdataF32[n++]=SX.x,this._vdataF32[n++]=SX.y,this._vdataF32[n++]=SX.z,this._vdataUint32[n++]=i.evaluate(0,1)._val,this._vdataF32[n++]=e[0].x,this._vdataF32[n++]=e[0].y,this._vdataF32[n++]=e[0].z,this._vdataF32[n++]=1,this._vdataF32[n++]=t.evaluate(0,1),this._vdataF32[n++]=0,this._vdataF32[n++]=1,this._vdataF32[n++]=SX.x,this._vdataF32[n++]=SX.y,this._vdataF32[n++]=SX.z,this._vdataUint32[n++]=i.evaluate(0,1)._val;for(var r=1;r<e.length-1;r++){Fi.subtract(SX,e[r-1],e[r]),Fi.subtract(wX,e[r+1],e[r]),Fi.subtract(wX,wX,SX);var a=r/e.length;this._vdataF32[n++]=e[r].x,this._vdataF32[n++]=e[r].y,this._vdataF32[n++]=e[r].z,this._vdataF32[n++]=0,this._vdataF32[n++]=t.evaluate(a,1),this._vdataF32[n++]=a,this._vdataF32[n++]=0,this._vdataF32[n++]=wX.x,this._vdataF32[n++]=wX.y,this._vdataF32[n++]=wX.z,this._vdataUint32[n++]=i.evaluate(a,1)._val,this._vdataF32[n++]=e[r].x,this._vdataF32[n++]=e[r].y,this._vdataF32[n++]=e[r].z,this._vdataF32[n++]=1,this._vdataF32[n++]=t.evaluate(a,1),this._vdataF32[n++]=a,this._vdataF32[n++]=1,this._vdataF32[n++]=wX.x,this._vdataF32[n++]=wX.y,this._vdataF32[n++]=wX.z,this._vdataUint32[n++]=i.evaluate(a,1)._val}Fi.subtract(SX,e[e.length-1],e[e.length-2]),this._vdataF32[n++]=e[e.length-1].x,this._vdataF32[n++]=e[e.length-1].y,this._vdataF32[n++]=e[e.length-1].z,this._vdataF32[n++]=0,this._vdataF32[n++]=t.evaluate(1,1),this._vdataF32[n++]=1,this._vdataF32[n++]=0,this._vdataF32[n++]=SX.x,this._vdataF32[n++]=SX.y,this._vdataF32[n++]=SX.z,this._vdataUint32[n++]=i.evaluate(1,1)._val,this._vdataF32[n++]=e[e.length-1].x,this._vdataF32[n++]=e[e.length-1].y,this._vdataF32[n++]=e[e.length-1].z,this._vdataF32[n++]=1,this._vdataF32[n++]=t.evaluate(1,1),this._vdataF32[n++]=1,this._vdataF32[n++]=1,this._vdataF32[n++]=SX.x,this._vdataF32[n++]=SX.y,this._vdataF32[n++]=SX.z,this._vdataUint32[n++]=i.evaluate(1,1)._val}this.updateIA(Math.max(0,e.length-1))}},{key:"updateIA",value:function(e){this.getSubModel(0).inputAssembler.vertexBuffers[0].update(this._vdataF32),this.getSubModel(0).inputAssembler.indexCount=this._indexCount*e,this.getSubModel(0).inputAssembler.extractDrawInfo(this._iaInfo.drawInfos[0]),this._iaInfoBuffer.update(this._iaInfo)}},{key:"destroySubMeshData",value:function(){var e=this._subMeshData.vertexBuffers,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._subMeshData.indexBuffer.destroy()}}]),n}(),EX=vt({Constant:0,Curve:1,TwoCurves:2,TwoConstants:3}),CX=(Dj=ho("cc.CurveRange"),Fj=fo({type:EX}),Nj=fo({type:Us}),Uj=fo({type:Us}),Vj=fo({type:Us}),Dj(($j=Jj=function(){function e(){y(this,e),v(this,"mode",qj,this),v(this,"curve",jj,this),v(this,"curveMin",Wj,this),v(this,"curveMax",Xj,this),v(this,"constant",Yj,this),v(this,"constantMin",Qj,this),v(this,"constantMax",Kj,this),v(this,"multiplier",Zj,this)}return l(e,[{key:"evaluate",value:function(e,t){switch(this.mode){case EX.Constant:return this.constant;case EX.Curve:return this.curve.evaluate(e)*this.multiplier;case EX.TwoCurves:return vi(this.curveMin.evaluate(e),this.curveMax.evaluate(e),t)*this.multiplier;case EX.TwoConstants:return vi(this.constantMin,this.constantMax,t)}}},{key:"getMax",value:function(){switch(this.mode){case EX.Constant:return this.constant;case EX.Curve:return this.multiplier;case EX.TwoConstants:return this.constantMax;case EX.TwoCurves:return this.multiplier}return 0}}]),e}(),Jj.Mode=EX,qj=m((Hj=$j).prototype,"mode",[Fj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return EX.Constant}}),jj=m(Hj.prototype,"curve",[Nj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Us}}),Wj=m(Hj.prototype,"curveMin",[Uj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Us}}),Xj=m(Hj.prototype,"curveMax",[Vj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Us}}),Yj=m(Hj.prototype,"constant",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Qj=m(Hj.prototype,"constantMin",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Kj=m(Hj.prototype,"constantMax",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Zj=m(Hj.prototype,"multiplier",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Gj=Hj))||Gj),AX=vt({Blend:0,Fixed:1}),kX=(ho("cc.ColorKey")((iW=m((tW=function e(){y(this,e),v(this,"color",iW,this),v(this,"time",nW,this)}).prototype,"color",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rr.WHITE.clone()}}),nW=m(tW.prototype,"time",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),eW=tW)),ho("cc.AlphaKey")((sW=m((aW=function e(){y(this,e),v(this,"alpha",sW,this),v(this,"time",oW,this)}).prototype,"alpha",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),oW=m(aW.prototype,"time",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),rW=aW)),ho("cc.Gradient")((pW=dW=function(){function e(){y(this,e),v(this,"colorKeys",uW,this),v(this,"alphaKeys",hW,this),v(this,"mode",fW,this),this._color=void 0,this._color=rr.WHITE.clone()}return l(e,[{key:"setKeys",value:function(e,t){this.colorKeys=e,this.alphaKeys=t}},{key:"sortKeys",value:function(){1<this.colorKeys.length&&this.colorKeys.sort(function(e,t){return e.time-t.time}),1<this.alphaKeys.length&&this.alphaKeys.sort(function(e,t){return e.time-t.time})}},{key:"evaluate",value:function(e){return this.getRGB(e),this._color._set_a_unsafe(this.getAlpha(e)),this._color}},{key:"randomColor",value:function(){var e=this.colorKeys[Math.trunc(Math.random()*this.colorKeys.length)],t=this.alphaKeys[Math.trunc(Math.random()*this.alphaKeys.length)];return this._color.set(e.color),this._color._set_a_unsafe(t.alpha),this._color}},{key:"getRGB",value:function(e){if(!(1<this.colorKeys.length))return 1===this.colorKeys.length?this._color.set(this.colorKeys[0].color):this._color.set(rr.WHITE),this._color;e=Ci(e,1);for(var t=1;t<this.colorKeys.length;++t){var i=this.colorKeys[t-1].time,n=this.colorKeys[t].time;if(i<=e&&e<n){if(this.mode===AX.Fixed)return this.colorKeys[t].color;var r=(e-i)/(n-i);return rr.lerp(this._color,this.colorKeys[t-1].color,this.colorKeys[t].color,r),this._color}}var a=this.colorKeys.length-1;e<this.colorKeys[0].time?rr.lerp(this._color,rr.BLACK,this.colorKeys[0].color,e/this.colorKeys[0].time):e>this.colorKeys[a].time&&rr.lerp(this._color,this.colorKeys[a].color,rr.BLACK,(e-this.colorKeys[a].time)/(1-this.colorKeys[a].time))}},{key:"getAlpha",value:function(e){if(!(1<this.alphaKeys.length))return 1===this.alphaKeys.length?this.alphaKeys[0].alpha:255;e=Ci(e,1);for(var t=1;t<this.alphaKeys.length;++t){var i=this.alphaKeys[t-1].time,n=this.alphaKeys[t].time;if(i<=e&&e<n){if(this.mode===AX.Fixed)return this.alphaKeys[t].alpha;var r=(e-i)/(n-i);return vi(this.alphaKeys[t-1].alpha,this.alphaKeys[t].alpha,r)}}var a=this.alphaKeys.length-1;return e<this.alphaKeys[0].time?vi(255,this.alphaKeys[0].alpha,e/this.alphaKeys[0].time):e>this.alphaKeys[a].time?vi(this.alphaKeys[a].alpha,255,(e-this.alphaKeys[a].time)/(1-this.alphaKeys[a].time)):void 0}}]),e}(),dW.Mode=AX,uW=m((cW=pW).prototype,"colorKeys",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Array}}),hW=m(cW.prototype,"alphaKeys",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Array}}),fW=m(cW.prototype,"mode",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return AX.Blend}}),lW=cW))||lW),RX=vt({Color:0,Gradient:1,TwoColors:2,TwoGradients:3,RandomColor:4}),OX=(_W=ho("cc.GradientRange"),vW=fo({type:RX}),mW=fo({type:kX}),yW=fo({type:kX}),gW=fo({type:kX}),bW=fo({type:RX}),_W((MW=OW=function(){function e(){y(this,e),v(this,"color",wW,this),v(this,"colorMin",TW,this),v(this,"colorMax",EW,this),v(this,"gradient",CW,this),v(this,"gradientMin",AW,this),v(this,"gradientMax",kW,this),v(this,"_mode",RW,this),this._color=rr.WHITE.clone()}return l(e,[{key:"evaluate",value:function(e,t){switch(this.mode){case RX.Color:return this.color;case RX.TwoColors:return rr.lerp(this._color,this.colorMin,this.colorMax,t),this._color;case RX.RandomColor:return this.gradient.randomColor();case RX.Gradient:return this.gradient.evaluate(e);case RX.TwoGradients:return rr.lerp(this._color,this.gradientMin.evaluate(e),this.gradientMax.evaluate(e),t),this._color;default:return this.color}}},{key:"mode",get:function(){return this._mode},set:function(e){this._mode=e}}]),e}(),OW.Mode=RX,m((SW=MW).prototype,"mode",[vW],Object.getOwnPropertyDescriptor(SW.prototype,"mode"),SW.prototype),wW=m(SW.prototype,"color",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rr.WHITE.clone()}}),TW=m(SW.prototype,"colorMin",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rr.WHITE.clone()}}),EW=m(SW.prototype,"colorMax",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rr.WHITE.clone()}}),CW=m(SW.prototype,"gradient",[mW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new kX}}),AW=m(SW.prototype,"gradientMin",[yW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new kX}}),kW=m(SW.prototype,"gradientMax",[gW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new kX}}),RW=m(SW.prototype,"_mode",[bW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return RX.Color}}),xW=SW))||xW),MX="CC_USE_WORLD_SPACE",IX={CC_USE_WORLD_SPACE:!1},LX=P2("LineComponent",(IW=ho("cc.LineComponent"),LW=yo("Components/Line"),zW=fo({type:vh}),BW=fo({type:vh,displayOrder:0}),PW=fo({displayOrder:1}),DW=fo({type:[Fi]}),FW=fo({type:[Fi],displayOrder:2}),NW=fo({type:CX}),UW=fo({type:CX,displayOrder:3}),VW=fo({type:Mi,displayOrder:4}),GW=fo({type:Mi,displayOrder:5}),HW=fo({type:OX}),qW=fo({type:OX,displayOrder:6}),IW(jW=LW(jW=vo((XW=m((WW=function(){function t(){var e;return y(this,t),v(e=x(this,g(t).call(this)),"_texture",XW,u(e)),e._material=null,v(e,"_worldSpace",YW,u(e)),v(e,"_positions",QW,u(e)),v(e,"_width",KW,u(e)),v(e,"_tile",ZW,u(e)),v(e,"_offset",JW,u(e)),v(e,"_color",$W,u(e)),e._model=null,e._tile_offset=new Wi,e}return p(t,Bv),l(t,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture=e,this._material&&this._material.setProperty("mainTexture",e)}},{key:"worldSpace",get:function(){return this._worldSpace},set:function(e){this._worldSpace=e,this._material&&(IX[MX]=this.worldSpace,this._material.recompileShaders(IX),this._model&&this._model.setSubModelMaterial(0,this._material))}},{key:"positions",get:function(){return this._positions},set:function(e){this._positions=e,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}},{key:"width",get:function(){return this._width},set:function(e){this._width=e,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}},{key:"tile",get:function(){return this._tile},set:function(e){this._tile.set(e),this._material&&(this._tile_offset.x=this._tile.x,this._tile_offset.y=this._tile.y,this._material.setProperty("mainTiling_Offset",this._tile_offset))}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset.set(e),this._material&&(this._tile_offset.z=this._offset.x,this._tile_offset.w=this._offset.y,this._material.setProperty("mainTiling_Offset",this._tile_offset))}},{key:"color",get:function(){return this._color},set:function(e){this._color=e,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}}]),l(t,[{key:"onEnable",value:function(){this._model||(this._model=this._getRenderScene().createModel(TX,this.node),this._model.setCapacity(100),null==this._material&&(this._material=new cp,this._material.copy(kd.get("default-trail-material")),IX[MX]=this.worldSpace,this._material.recompileShaders(IX)),this._model.setSubModelMaterial(0,this._material)),this._model.enabled=!0,this.texture=this.texture,this.tile=this._tile,this.offset=this._offset,this._model.addLineVertexData(this._positions,this._width,this._color)}},{key:"onDisable",value:function(){this._model&&(this._model.enabled=!1)}}]),t}()).prototype,"_texture",[zW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),m(WW.prototype,"texture",[BW],Object.getOwnPropertyDescriptor(WW.prototype,"texture"),WW.prototype),YW=m(WW.prototype,"_worldSpace",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),m(WW.prototype,"worldSpace",[PW],Object.getOwnPropertyDescriptor(WW.prototype,"worldSpace"),WW.prototype),QW=m(WW.prototype,"_positions",[DW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),m(WW.prototype,"positions",[FW],Object.getOwnPropertyDescriptor(WW.prototype,"positions"),WW.prototype),KW=m(WW.prototype,"_width",[NW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CX}}),m(WW.prototype,"width",[UW],Object.getOwnPropertyDescriptor(WW.prototype,"width"),WW.prototype),ZW=m(WW.prototype,"_tile",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Mi(1,1)}}),m(WW.prototype,"tile",[VW],Object.getOwnPropertyDescriptor(WW.prototype,"tile"),WW.prototype),JW=m(WW.prototype,"_offset",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Mi(0,0)}}),m(WW.prototype,"offset",[GW],Object.getOwnPropertyDescriptor(WW.prototype,"offset"),WW.prototype),$W=m(WW.prototype,"_color",[HW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new OX}}),m(WW.prototype,"color",[qW],Object.getOwnPropertyDescriptor(WW.prototype,"color"),WW.prototype),jW=WW))||jW)||jW)||jW)),zX=(eX=ho("cc.ColorOvertimeModule"),tX=fo({displayOrder:0}),iX=fo({type:OX,displayOrder:1}),eX((aX=m((rX=function(){function e(){y(this,e),v(this,"enable",aX,this),v(this,"color",sX,this)}return l(e,[{key:"animate",value:function(e){this.enable&&(e.color.set(e.startColor),e.color.multiply(this.color.evaluate(1-e.remainingLifetime/e.startLifetime,Si(e.randomSeed+91041))))}}]),e}()).prototype,"enable",[tX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),sX=m(rX.prototype,"color",[iX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new OX}}),nX=rX))||nX),BX=vt({World:0,Local:1,Custom:2}),PX=vt({Billboard:0,StrecthedBillboard:1,HorizontalBillboard:2,VerticalBillboard:3,Mesh:4}),DX=vt({Box:0,Circle:1,Cone:2,Sphere:3,Hemisphere:4}),FX=vt({Base:0,Edge:1,Shell:2,Volume:3}),NX=vt({Random:0,Loop:1,PingPong:2}),UX=vt({Particles:0,Ribbon:1}),VX=vt({Stretch:0,Repeat:1}),GX=new Fi(0,0,-1);function HX(e,t,i,n){return t!==e?(e===BX.World||zn.invert(i,i),zn.getRotation(n,i),!0):(hn.set(n,0,0,0,1),!1)}function qX(e,t){Mi.set(e,Math.cos(t),Math.sin(t))}function jX(e){var t=bi(-1,1),i=bi(0,2*Math.PI),n=Math.sqrt(1-t*t),r=n*Math.cos(i),a=n*Math.sin(i);Fi.set(e,r,a,t)}function WX(e,t,i){jX(e),Fi.multiplyScalar(e,e,t+(i-t)*gi())}function XX(e,t,i,n){qX(e,n),e.z=0,Fi.multiplyScalar(e,e,t+(i-t)*gi())}function YX(e){for(var t=0;t<e.length;t++){var i=t+xi(0,e.length-t),n=e[i];e[i]=e[t],e[t]=n}}function QX(){var e=bi(-1,1);return 0===e&&e++,se(e)}var KX,ZX,JX,$X,eY,tY,iY,nY,rY,aY,sY,oY,lY,cY,uY,hY,fY,dY,pY,_Y,vY,mY,yY,gY,bY,xY,SY,wY,TY,EY,CY,AY,kY=212165,RY=new Fi,OY=(oX=ho("cc.ForceOvertimeModule"),lX=fo({displayOrder:0}),cX=fo({type:CX,range:[-1,1],displayOrder:2}),uX=fo({type:CX,range:[-1,1],displayOrder:3}),hX=fo({type:CX,range:[-1,1],displayOrder:4}),fX=fo({type:BX,displayOrder:1}),oX((_X=m((pX=function(){function e(){y(this,e),v(this,"enable",_X,this),v(this,"x",vX,this),v(this,"y",mX,this),v(this,"z",yX,this),v(this,"space",gX,this),this.randomized=!1,this.rotation=void 0,this.needTransform=void 0,this.rotation=new hn,this.needTransform=!1}return l(e,[{key:"update",value:function(e,t){this.needTransform=HX(e,this.space,t,this.rotation)}},{key:"animate",value:function(e,t){var i=1-e.remainingLifetime/e.startLifetime,n=Fi.set(RY,this.x.evaluate(i,Si(e.randomSeed+kY)),this.y.evaluate(i,Si(e.randomSeed+kY)),this.z.evaluate(i,Si(e.randomSeed+kY)));this.needTransform&&Fi.transformQuat(n,n,this.rotation),Fi.scaleAndAdd(e.velocity,e.velocity,n,t)}}]),e}()).prototype,"enable",[lX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),vX=m(pX.prototype,"x",[cX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CX}}),mX=m(pX.prototype,"y",[uX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CX}}),yX=m(pX.prototype,"z",[hX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CX}}),gX=m(pX.prototype,"space",[fX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return BX.Local}}),dX=pX))||dX),MY=23541,IY=new Fi,LY=(KX=ho("cc.LimitVelocityOvertimeModule"),ZX=fo({displayOrder:0}),JX=fo({type:CX,range:[-1,1],displayOrder:4}),$X=fo({type:CX,range:[-1,1],displayOrder:5}),eY=fo({type:CX,range:[-1,1],displayOrder:6}),tY=fo({type:CX,range:[-1,1],displayOrder:3}),iY=fo({displayOrder:7}),nY=fo({displayOrder:2}),rY=fo({type:BX,displayOrder:1}),KX((oY=m((sY=function(){function e(){y(this,e),v(this,"enable",oY,this),v(this,"limitX",lY,this),v(this,"limitY",cY,this),v(this,"limitZ",uY,this),v(this,"limit",hY,this),v(this,"dampen",fY,this),v(this,"separateAxes",dY,this),v(this,"space",pY,this),this.drag=null,this.multiplyDragByParticleSize=!1,this.multiplyDragByParticleVelocity=!1}return l(e,[{key:"animate",value:function(e){var t=1-e.remainingLifetime/e.startLifetime,i=IY;this.separateAxes?Fi.set(i,zY(e.ultimateVelocity.x,this.limitX.evaluate(t,Si(e.randomSeed+MY)),this.dampen),zY(e.ultimateVelocity.y,this.limitY.evaluate(t,Si(e.randomSeed+MY)),this.dampen),zY(e.ultimateVelocity.z,this.limitZ.evaluate(t,Si(e.randomSeed+MY)),this.dampen)):(Fi.normalize(i,e.ultimateVelocity),Fi.multiplyScalar(i,i,zY(e.ultimateVelocity.length(),this.limit.evaluate(t,Si(e.randomSeed+MY)),this.dampen))),Fi.copy(e.ultimateVelocity,i)}}]),e}()).prototype,"enable",[ZX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lY=m(sY.prototype,"limitX",[JX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CX}}),cY=m(sY.prototype,"limitY",[$X],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CX}}),uY=m(sY.prototype,"limitZ",[eY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CX}}),hY=m(sY.prototype,"limit",[tY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CX}}),fY=m(sY.prototype,"dampen",[iY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 3}}),dY=m(sY.prototype,"separateAxes",[nY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),pY=m(sY.prototype,"space",[rY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return BX.Local}}),aY=sY))||aY);function zY(e,t,i){var n=Math.sign(e),r=Math.abs(e);return t<r&&(r=vi(r,t,i)),r*n}var BY,PY,DY,FY,NY,UY,VY,GY,HY,qY,jY,WY,XY,YY,QY,KY,ZY,JY,$Y,eQ,tQ,iQ,nQ,rQ,aQ,sQ,oQ,lQ,cQ,uQ,hQ,fQ,dQ,pQ,_Q,vQ,mQ,yQ,gQ,bQ,xQ,SQ,wQ,TQ,EQ,CQ,AQ,kQ,RQ,OQ,MQ,IQ,LQ,zQ,BQ,PQ,DQ,FQ,NQ,UQ,VQ,GQ,HQ,qQ,jQ,WQ,XQ,YQ,QQ,KQ,ZQ,JQ,$Q,eK,tK,iK,nK,rK,aK,sK,oK,lK,cK,uK,hK,fK,dK,pK,_K,vK,mK,yK,gK,bK,xK,SK,wK,TK,EK,CK,AK,kK,RK,OK,MK,IK,LK,zK,BK=(_Y=ho("cc.RotationOvertimeModule"),vY=fo({displayOrder:0}),mY=fo({displayOrder:1}),yY=fo({type:CX,range:[-1,1],radian:!0,displayOrder:2}),gY=fo({type:CX,range:[-1,1],radian:!0,displayOrder:3}),bY=fo({type:CX,range:[-1,1],radian:!0,displayOrder:4}),_Y((wY=m((SY=function(){function e(){y(this,e),v(this,"enable",wY,this),v(this,"_separateAxes",TY,this),v(this,"x",EY,this),v(this,"y",CY,this),v(this,"z",AY,this)}return l(e,[{key:"separateAxes",get:function(){return this._separateAxes},set:function(e){this._separateAxes=e}}]),l(e,[{key:"animate",value:function(e,t){var i=1-e.remainingLifetime/e.startLifetime;if(this._separateAxes){var n=Si(e.randomSeed+125292);e.rotation.x+=this.x.evaluate(i,n)*t,e.rotation.y+=this.y.evaluate(i,n)*t,e.rotation.z+=this.z.evaluate(i,n)*t}else e.rotation.z+=this.z.evaluate(i,Si(e.randomSeed+125292))*t}}]),e}()).prototype,"enable",[vY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),TY=m(SY.prototype,"_separateAxes",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),m(SY.prototype,"separateAxes",[mY],Object.getOwnPropertyDescriptor(SY.prototype,"separateAxes"),SY.prototype),EY=m(SY.prototype,"x",[yY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CX}}),CY=m(SY.prototype,"y",[gY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CX}}),AY=m(SY.prototype,"z",[bY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CX}}),xY=SY))||xY),PK=(BY=ho("cc.SizeOvertimeModule"),PY=fo({displayOrder:0}),DY=fo({displayOrder:1}),FY=fo({type:CX,displayOrder:2}),NY=fo({type:CX,displayOrder:3}),UY=fo({type:CX,displayOrder:4}),VY=fo({type:CX,displayOrder:5}),BY((qY=m((HY=function(){function e(){y(this,e),v(this,"enable",qY,this),v(this,"separateAxes",jY,this),v(this,"size",WY,this),v(this,"x",XY,this),v(this,"y",YY,this),v(this,"z",QY,this)}return l(e,[{key:"animate",value:function(e){if(this.separateAxes){var t=1-e.remainingLifetime/e.startLifetime,i=Si(e.randomSeed+39825);e.size.x=e.startSize.x*this.x.evaluate(t,i),e.size.y=e.startSize.y*this.y.evaluate(t,i),e.size.z=e.startSize.z*this.z.evaluate(t,i)}else Fi.multiplyScalar(e.size,e.startSize,this.size.evaluate(1-e.remainingLifetime/e.startLifetime,Si(e.randomSeed+39825)))}}]),e}()).prototype,"enable",[PY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),jY=m(HY.prototype,"separateAxes",[DY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),WY=m(HY.prototype,"size",[FY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CX}}),XY=m(HY.prototype,"x",[NY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CX}}),YY=m(HY.prototype,"y",[UY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CX}}),QY=m(HY.prototype,"z",[VY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CX}}),GY=HY))||GY),DK=90794,FK=vt({Grid:0}),NK=vt({WholeSheet:0,SingleRow:1}),UK=(KY=ho("cc.TextureAnimationModule"),ZY=fo({displayOrder:0}),JY=fo({type:FK}),$Y=fo({type:FK,displayOrder:1}),eQ=fo({displayOrder:2}),tQ=fo({displayOrder:3}),iQ=fo({type:NK,displayOrder:4}),nQ=fo({type:CX,displayOrder:7}),rQ=fo({type:CX,displayOrder:8}),aQ=fo({displayOrder:9}),sQ=fo({displayOrder:5}),oQ=fo({displayOrder:6}),KY((uQ=m((cQ=function(){function e(){y(this,e),v(this,"_enable",uQ,this),v(this,"_mode",hQ,this),v(this,"numTilesX",fQ,this),v(this,"numTilesY",dQ,this),v(this,"animation",pQ,this),v(this,"frameOverTime",_Q,this),v(this,"startFrame",vQ,this),v(this,"cycleCount",mQ,this),v(this,"_flipU",yQ,this),v(this,"_flipV",gQ,this),v(this,"_uvChannelMask",bQ,this),v(this,"randomRow",xQ,this),v(this,"rowIndex",SQ,this),this.ps=null}return l(e,[{key:"onInit",value:function(e){this.ps=e}},{key:"init",value:function(e){e.startRow=Math.floor(Math.random()*this.numTilesY)}},{key:"animate",value:function(e){var t=1-e.remainingLifetime/e.startLifetime,i=this.startFrame.evaluate(t,Si(e.randomSeed+DK))/(this.numTilesX*this.numTilesY);if(this.animation===NK.WholeSheet)e.frameIndex=Ci(this.cycleCount*(this.frameOverTime.evaluate(t,Si(e.randomSeed+DK))+i),1);else if(this.animation===NK.SingleRow){var n=1/this.numTilesY;if(this.randomRow){var r=Ci(this.cycleCount*(this.frameOverTime.evaluate(t,Si(e.randomSeed+DK))+i),1),a=e.startRow*n,s=a+n;e.frameIndex=vi(a,s,r)}else{var o=this.rowIndex*n,l=o+n;e.frameIndex=vi(o,l,Ci(this.cycleCount*(this.frameOverTime.evaluate(t,Si(e.randomSeed+DK))+i),1))}}}},{key:"enable",get:function(){return this._enable},set:function(e){this._enable=e,this.ps&&this.ps.renderer._updateMaterialParams()}},{key:"mode",get:function(){return this._mode},set:function(e){e===FK.Grid||console.error("particle texture animation's sprites is not supported!")}},{key:"flipU",get:function(){return this._flipU},set:function(e){console.error("particle texture animation's flipU is not supported!")}},{key:"flipV",get:function(){return this._flipV},set:function(e){console.error("particle texture animation's flipV is not supported!")}},{key:"uvChannelMask",get:function(){return this._uvChannelMask},set:function(e){console.error("particle texture animation's uvChannelMask is not supported!")}}]),e}()).prototype,"_enable",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),m(cQ.prototype,"enable",[ZY],Object.getOwnPropertyDescriptor(cQ.prototype,"enable"),cQ.prototype),hQ=m(cQ.prototype,"_mode",[JY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return FK.Grid}}),m(cQ.prototype,"mode",[$Y],Object.getOwnPropertyDescriptor(cQ.prototype,"mode"),cQ.prototype),fQ=m(cQ.prototype,"numTilesX",[eQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),dQ=m(cQ.prototype,"numTilesY",[tQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),pQ=m(cQ.prototype,"animation",[iQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return NK.WholeSheet}}),_Q=m(cQ.prototype,"frameOverTime",[nQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CX}}),vQ=m(cQ.prototype,"startFrame",[rQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CX}}),mQ=m(cQ.prototype,"cycleCount",[aQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),yQ=m(cQ.prototype,"_flipU",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),gQ=m(cQ.prototype,"_flipV",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),bQ=m(cQ.prototype,"_uvChannelMask",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),xQ=m(cQ.prototype,"randomRow",[sQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),SQ=m(cQ.prototype,"rowIndex",[oQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),lQ=cQ))||lQ),VK=197866,GK=new Fi,HK=(wQ=ho("cc.VelocityOvertimeModule"),TQ=fo({displayOrder:0}),EQ=fo({type:CX,range:[-1,1],displayOrder:2}),CQ=fo({type:CX,range:[-1,1],displayOrder:3}),AQ=fo({type:CX,range:[-1,1],displayOrder:4}),kQ=fo({type:CX,range:[-1,1],displayOrder:5}),RQ=fo({type:BX,displayOrder:1}),wQ((IQ=m((MQ=function(){function e(){y(this,e),v(this,"enable",IQ,this),v(this,"x",LQ,this),v(this,"y",zQ,this),v(this,"z",BQ,this),v(this,"speedModifier",PQ,this),v(this,"space",DQ,this),this.rotation=void 0,this.needTransform=void 0,this.rotation=new hn,this.speedModifier.constant=1,this.needTransform=!1}return l(e,[{key:"update",value:function(e,t){this.needTransform=HX(e,this.space,t,this.rotation)}},{key:"animate",value:function(e){var t=1-e.remainingLifetime/e.startLifetime,i=Fi.set(GK,this.x.evaluate(t,Si(e.randomSeed+VK)),this.y.evaluate(t,Si(e.randomSeed+VK)),this.z.evaluate(t,Si(e.randomSeed+VK)));this.needTransform&&Fi.transformQuat(i,i,this.rotation),Fi.add(e.animatedVelocity,e.animatedVelocity,i),Fi.add(e.ultimateVelocity,e.velocity,e.animatedVelocity),Fi.multiplyScalar(e.ultimateVelocity,e.ultimateVelocity,this.speedModifier.evaluate(1-e.remainingLifetime/e.startLifetime,Si(e.randomSeed+VK)))}}]),e}()).prototype,"enable",[TQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),LQ=m(MQ.prototype,"x",[EQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CX}}),zQ=m(MQ.prototype,"y",[CQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CX}}),BQ=m(MQ.prototype,"z",[AQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CX}}),PQ=m(MQ.prototype,"speedModifier",[kQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CX}}),DQ=m(MQ.prototype,"space",[RQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return BX.Local}}),OQ=MQ))||OQ),qK=(FQ=ho("cc.Burst"),NQ=fo({type:CX}),FQ((GQ=m((VQ=function(){function e(){y(this,e),v(this,"_time",GQ,this),v(this,"minCount",HQ,this),v(this,"maxCount",qQ,this),v(this,"_repeatCount",jQ,this),v(this,"repeatInterval",WQ,this),v(this,"count",XQ,this),this._remainingCount=void 0,this._curTime=void 0,this._remainingCount=1,this._curTime=0}return l(e,[{key:"time",get:function(){return this._time},set:function(e){this._time=e,this._curTime=e}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(e){this._repeatCount=e,this._remainingCount=e}}]),l(e,[{key:"update",value:function(e,t){if(0===this._remainingCount&&(this._remainingCount=this._repeatCount,this._curTime=this._time),0<this._remainingCount){var i=Ci(e._time-e.startDelay.evaluate(0,1),e.duration)-t;i=0<i?i:0;var n=Ci(e.time-e.startDelay.evaluate(0,1),e.duration);this._curTime>=i&&this._curTime<n&&(e.emit(this.count.evaluate(this._curTime/e.duration,1),t-(n-this._curTime)),this._curTime+=this.repeatInterval,--this._remainingCount)}}},{key:"getMaxCount",value:function(e){return this.count.getMax()*Math.min(Math.ceil(e.duration/this.repeatInterval),this.repeatCount)}}]),e}()).prototype,"_time",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),m(VQ.prototype,"time",[fo],Object.getOwnPropertyDescriptor(VQ.prototype,"time"),VQ.prototype),HQ=m(VQ.prototype,"minCount",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 30}}),qQ=m(VQ.prototype,"maxCount",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 30}}),jQ=m(VQ.prototype,"_repeatCount",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),m(VQ.prototype,"repeatCount",[fo],Object.getOwnPropertyDescriptor(VQ.prototype,"repeatCount"),VQ.prototype),WQ=m(VQ.prototype,"repeatInterval",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),XQ=m(VQ.prototype,"count",[NQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CX}}),UQ=VQ))||UQ),jK=new Fi(0,0,0),WK=new Array,XK=new Fi(.5,.5,.5),YK=(YQ=ho("cc.ShapeModule"),QQ=fo({displayOrder:13}),KQ=fo({displayOrder:14}),ZQ=fo({displayOrder:15}),JQ=fo({displayOrder:6}),$Q=fo({displayOrder:5}),eK=fo({displayOrder:0}),tK=fo({type:DX,displayOrder:1}),iK=fo({type:FX,displayOrder:2}),nK=fo({displayOrder:16}),rK=fo({displayOrder:17}),aK=fo({displayOrder:18}),sK=fo({displayOrder:19}),oK=fo({displayOrder:3}),lK=fo({displayOrder:4}),cK=fo({type:NX,displayOrder:7}),uK=fo({displayOrder:9}),hK=fo({type:CX,displayOrder:10}),fK=fo({displayOrder:11}),dK=fo({displayOrder:12}),YQ((m((_K=function(){function e(){y(this,e),v(this,"enable",vK,this),v(this,"shapeType",mK,this),v(this,"emitFrom",yK,this),v(this,"alignToDirection",gK,this),v(this,"randomDirectionAmount",bK,this),v(this,"sphericalDirectionAmount",xK,this),v(this,"randomPositionAmount",SK,this),v(this,"radius",wK,this),v(this,"radiusThickness",TK,this),v(this,"arcMode",EK,this),v(this,"arcSpread",CK,this),v(this,"arcSpeed",AK,this),v(this,"length",kK,this),v(this,"boxThickness",RK,this),v(this,"_position",OK,this),v(this,"_rotation",MK,this),v(this,"_scale",IK,this),v(this,"_arc",LK,this),v(this,"_angle",zK,this),this.mat=void 0,this.quat=void 0,this.particleSystem=void 0,this.lastTime=void 0,this.totalAngle=void 0,this.mat=new zn,this.quat=new hn,this.particleSystem=null,this.lastTime=0,this.totalAngle=0}return l(e,[{key:"position",get:function(){return this._position},set:function(e){this._position=e,this.constructMat()}},{key:"rotation",get:function(){return this._rotation},set:function(e){this._rotation=e,this.constructMat()}},{key:"scale",get:function(){return this._scale},set:function(e){this._scale=e,this.constructMat()}},{key:"arc",get:function(){return yi(this._arc)},set:function(e){this._arc=mi(e)}},{key:"angle",get:function(){return Math.round(100*yi(this._angle))/100},set:function(e){this._angle=mi(e)}}]),l(e,[{key:"onInit",value:function(e){this.particleSystem=e,this.constructMat(),this.lastTime=this.particleSystem._time}},{key:"emit",value:function(e){switch(this.shapeType){case DX.Box:!function(e,t,i,n){switch(e){case FX.Volume:!function(e,t){Fi.set(e,bi(-t.x,t.x),bi(-t.y,t.y),bi(-t.z,t.z))}(i,XK);break;case FX.Shell:WK.splice(0,WK.length),WK.push(bi(-.5,.5)),WK.push(bi(-.5,.5)),WK.push(.5*QX()),YX(WK),QK(WK,t),Fi.set(i,WK[0],WK[1],WK[2]);break;case FX.Edge:WK.splice(0,WK.length),WK.push(bi(-.5,.5)),WK.push(.5*QX()),WK.push(.5*QX()),YX(WK),QK(WK,t),Fi.set(i,WK[0],WK[1],WK[2]);break;default:console.warn(e+" is not supported for box emitter.")}Fi.copy(n,GX)}(this.emitFrom,this.boxThickness,e.position,e.velocity);break;case DX.Circle:!function(e,t,i,n,r){XX(n,e*(1-t),e,i),Fi.normalize(r,n)}(this.radius,this.radiusThickness,this.generateArcAngle(),e.position,e.velocity);break;case DX.Cone:!function(e,t,i,n,r,a,s,o){switch(e){case FX.Base:XX(s,t*(1-i),t,n),Mi.multiplyScalar(o,s,Math.sin(r)),o.z=-Math.cos(r)*t,Fi.normalize(o,o),s.z=0;break;case FX.Shell:qX(s,n),Mi.multiplyScalar(o,s,Math.sin(r)),o.z=-Math.cos(r),Fi.normalize(o,o),Mi.multiplyScalar(s,s,t),s.z=0;break;case FX.Volume:XX(s,t*(1-i),t,n),Mi.multiplyScalar(o,s,Math.sin(r)),o.z=-Math.cos(r)*t,Fi.normalize(o,o),s.z=0,Fi.add(s,s,Fi.multiplyScalar(jK,o,a*gi()/-o.z));break;default:console.warn(e+" is not supported for cone emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,this.generateArcAngle(),this._angle,this.length,e.position,e.velocity);break;case DX.Sphere:!function(e,t,i,n,r){switch(e){case FX.Volume:WX(n,t*(1-i),t),Fi.copy(r,n),Fi.normalize(r,r);break;case FX.Shell:jX(n),Fi.multiplyScalar(n,n,t),Fi.copy(r,n);break;default:console.warn(e+" is not supported for sphere emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,e.position,e.velocity);break;case DX.Hemisphere:!function(e,t,i,n,r){switch(e){case FX.Volume:WX(n,t*(1-i),t),0<n.z&&(n.z*=-1),Fi.copy(r,n),Fi.normalize(r,r);break;case FX.Shell:jX(n),Fi.multiplyScalar(n,n,t),0<n.z&&(n.z*=-1),Fi.copy(r,n);break;default:console.warn(e+" is not supported for hemisphere emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,e.position,e.velocity);break;default:console.warn(this.shapeType+" shapeType is not supported by ShapeModule.")}if(0<this.randomPositionAmount&&(e.position.x+=bi(-this.randomPositionAmount,this.randomPositionAmount),e.position.y+=bi(-this.randomPositionAmount,this.randomPositionAmount),e.position.z+=bi(-this.randomPositionAmount,this.randomPositionAmount)),Fi.transformQuat(e.velocity,e.velocity,this.quat),Fi.transformMat4(e.position,e.position,this.mat),0<this.sphericalDirectionAmount){var t=Fi.normalize(jK,e.position);Fi.lerp(e.velocity,e.velocity,t,this.sphericalDirectionAmount)}this.lastTime=this.particleSystem._time}},{key:"constructMat",value:function(){hn.fromEuler(this.quat,this._rotation.x,this._rotation.y,this._rotation.z),zn.fromRTS(this.mat,this.quat,this._position,this._scale)}},{key:"generateArcAngle",value:function(){if(this.arcMode===NX.Random)return bi(0,this._arc);var e=this.totalAngle+2*Math.PI*this.arcSpeed.evaluate(this.particleSystem._time,1)*(this.particleSystem._time-this.lastTime);switch(this.totalAngle=e,0!==this.arcSpread&&(e=Math.floor(e/(this._arc*this.arcSpread))*this._arc*this.arcSpread),this.arcMode){case NX.Loop:return Ci(e,this._arc);case NX.PingPong:return Ai(e,this._arc)}}}]),e}()).prototype,"position",[QQ],Object.getOwnPropertyDescriptor(_K.prototype,"position"),_K.prototype),m(_K.prototype,"rotation",[KQ],Object.getOwnPropertyDescriptor(_K.prototype,"rotation"),_K.prototype),m(_K.prototype,"scale",[ZQ],Object.getOwnPropertyDescriptor(_K.prototype,"scale"),_K.prototype),m(_K.prototype,"arc",[JQ],Object.getOwnPropertyDescriptor(_K.prototype,"arc"),_K.prototype),m(_K.prototype,"angle",[$Q],Object.getOwnPropertyDescriptor(_K.prototype,"angle"),_K.prototype),vK=m(_K.prototype,"enable",[eK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),mK=m(_K.prototype,"shapeType",[tK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return DX.Cone}}),yK=m(_K.prototype,"emitFrom",[iK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return FX.Volume}}),gK=m(_K.prototype,"alignToDirection",[nK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),bK=m(_K.prototype,"randomDirectionAmount",[rK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),xK=m(_K.prototype,"sphericalDirectionAmount",[aK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),SK=m(_K.prototype,"randomPositionAmount",[sK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),wK=m(_K.prototype,"radius",[oK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),TK=m(_K.prototype,"radiusThickness",[lK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),EK=m(_K.prototype,"arcMode",[cK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return NX.Random}}),CK=m(_K.prototype,"arcSpread",[uK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),AK=m(_K.prototype,"arcSpeed",[hK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CX}}),kK=m(_K.prototype,"length",[fK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),RK=m(_K.prototype,"boxThickness",[dK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi(0,0,0)}}),OK=m(_K.prototype,"_position",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi(0,0,0)}}),MK=m(_K.prototype,"_rotation",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi(0,0,0)}}),IK=m(_K.prototype,"_scale",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi(1,1,1)}}),LK=m(_K.prototype,"_arc",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mi(360)}}),zK=m(_K.prototype,"_angle",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mi(25)}}),pK=_K))||pK);function QK(e,t){0<t.x&&(e[0]+=.5*bi(-t.x,t.x),e[0]=pi(e[0],-.5,.5)),0<t.y&&(e[1]+=.5*bi(-t.y,t.y),e[1]=pi(e[1],-.5,.5)),0<t.z&&(e[2]+=.5*bi(-t.z,t.z),e[2]=pi(e[2],-.5,.5))}function KK(e){y(this,KK),this.particleSystem=void 0,this.position=void 0,this.velocity=void 0,this.animatedVelocity=void 0,this.ultimateVelocity=void 0,this.angularVelocity=void 0,this.axisOfRotation=void 0,this.rotation=void 0,this.startSize=void 0,this.size=void 0,this.startColor=void 0,this.color=void 0,this.randomSeed=void 0,this.remainingLifetime=void 0,this.startLifetime=void 0,this.emitAccumulator0=void 0,this.emitAccumulator1=void 0,this.frameIndex=void 0,this.startRow=void 0,this.particleSystem=e,this.position=new Fi(0,0,0),this.velocity=new Fi(0,0,0),this.animatedVelocity=new Fi(0,0,0),this.ultimateVelocity=new Fi(0,0,0),this.angularVelocity=new Fi(0,0,0),this.axisOfRotation=new Fi(0,0,0),this.rotation=new Fi(0,0,0),this.startSize=new Fi(0,0,0),this.size=new Fi(0,0,0),this.startColor=rr.WHITE.clone(),this.color=rr.WHITE.clone(),this.randomSeed=0,this.remainingLifetime=0,this.startLifetime=0,this.emitAccumulator0=0,this.emitAccumulator1=0,this.frameIndex=0,this.startRow=0}var ZK,JK,$K,eZ,tZ,iZ,nZ,rZ,aZ,sZ,oZ,lZ,cZ,uZ,hZ,fZ,dZ,pZ,_Z,vZ,mZ,yZ,gZ,bZ,xZ,SZ,wZ,TZ,EZ,CZ,AZ,kZ,RZ,OZ,MZ,IZ,LZ,zZ,BZ,PZ,DZ,FZ,NZ,UZ,VZ,GZ,HZ,qZ,jZ,WZ=function(){function n(e,t){var i;return y(this,n),(i=x(this,g(n).call(this,e,t)))._capacity=void 0,i._vertAttrs=void 0,i._vertSize=void 0,i._vBuffer=void 0,i._vertAttrsFloatCount=void 0,i._vdataF32=void 0,i._vdataUint32=void 0,i._iaInfo=void 0,i._iaInfoBuffer=void 0,i._subMeshData=void 0,i._mesh=void 0,i._vertCount=0,i._indexCount=0,i._type="particle-batch",i._capacity=0,i._vertAttrs=null,i._vertSize=0,i._vBuffer=null,i._vertAttrsFloatCount=0,i._vdataF32=null,i._vdataUint32=null,i._iaInfo={drawInfos:[{vertexCount:0,firstVertex:0,indexCount:0,firstIndex:0,vertexOffset:0,instanceCount:0,firstInstance:0}]},i._iaInfoBuffer=i._device.createBuffer({usage:zl.INDIRECT,memUsage:Pl.HOST|Pl.DEVICE,size:56,stride:1}),i._subMeshData=null,i._mesh=null,i}return p(n,vf),l(n,[{key:"setCapacity",value:function(e){var t=this._capacity!==e;this._capacity=e,this._inited&&t&&this._recreateBuffer()}},{key:"setVertexAttributes",value:function(e,t){if(this._mesh!==e||this._vertAttrs!==t){this._mesh=e,this._vertAttrs=t,this._vertSize=0;var i=this._vertAttrs,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;s.offset=this._vertSize,this._vertSize+=Qc[s.format].size}this._vertAttrsFloatCount=this._vertSize/4,this._vBuffer=this._createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer),this._inited=!0}}},{key:"_createSubMeshData",value:function(){this._subMeshData&&this.destroySubMeshData(),this._vertCount=4,this._indexCount=6,this._mesh&&(this._vertCount=this._mesh.struct.vertexBundles[this._mesh.struct.primitives[0].vertexBundelIndices[0]].view.count,this._indexCount=this._mesh.struct.primitives[0].indexView.count);var e=this._device.createBuffer({usage:zl.VERTEX|zl.TRANSFER_DST,memUsage:Pl.HOST|Pl.DEVICE,size:this._vertSize*this._capacity*this._vertCount,stride:this._vertSize}),t=new ArrayBuffer(this._vertSize*this._capacity*this._vertCount);if(this._mesh){var i=this._vertAttrs.findIndex(function(e){return e.name===kl.ATTR_TEX_COORD3}),n=this._vertAttrs[i++].offset;if(this._mesh.copyAttribute(0,kl.ATTR_POSITION,t,this._vertSize,n),n=this._vertAttrs[i++].offset,this._mesh.copyAttribute(0,kl.ATTR_NORMAL,t,this._vertSize,n),n=this._vertAttrs[this._vertAttrs.findIndex(function(e){return e.name===kl.ATTR_TEX_COORD})].offset,this._mesh.copyAttribute(0,kl.ATTR_TEX_COORD,t,this._vertSize,n),n=this._vertAttrs[i++].offset,!this._mesh.copyAttribute(0,kl.ATTR_COLOR,t,this._vertSize,n))for(var r=new Uint32Array(t),a=0;a<this._vertCount;++a)r[a*this._vertAttrsFloatCount+n/4]=rr.WHITE._val;for(var s=new Float32Array(t),o=1;o<this._capacity;o++)s.copyWithin(o*this._vertSize*this._vertCount/4,0,this._vertSize*this._vertCount/4)}e.update(t);var l=new Uint16Array(this._capacity*this._indexCount);if(this._mesh){this._mesh.copyIndices(0,l);for(var c=1;c<this._capacity;c++)for(var u=0;u<this._indexCount;u++)l[c*this._indexCount+u]=l[u]+c*this._vertCount}else for(var h=0,f=0;f<this._capacity;++f){var d=4*f;l[h++]=d,l[h++]=1+d,l[h++]=2+d,l[h++]=3+d,l[h++]=2+d,l[h++]=1+d}var p=this._device.createBuffer({usage:zl.INDEX|zl.TRANSFER_DST,memUsage:Pl.HOST|Pl.DEVICE,size:this._capacity*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,stride:Uint16Array.BYTES_PER_ELEMENT});return p.update(l),this._iaInfo.drawInfos[0].vertexCount=this._capacity*this._vertCount,this._iaInfo.drawInfos[0].indexCount=this._capacity*this._indexCount,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData={vertexBuffers:[e],indexBuffer:p,indirectBuffer:this._iaInfoBuffer,attributes:this._vertAttrs,primitiveMode:Gl.TRIANGLE_LIST,flatBuffers:[]},this.setSubModelMesh(0,this._subMeshData),t}},{key:"setSubModelMaterial",value:function(e,t){this.initLocalBindings(t),_(g(n.prototype),"setSubModelMaterial",this).call(this,e,t)}},{key:"addParticleVertexData",value:function(e,t){if(this._mesh)for(var i=0;i<this._vertCount;i++){var n=(e*this._vertCount+i)*this._vertAttrsFloatCount;this._vdataF32[n++]=t[0].x,this._vdataF32[n++]=t[0].y,this._vdataF32[n++]=t[0].z,n+=2,this._vdataF32[n++]=t[1].z,this._vdataF32[n++]=t[2].x,this._vdataF32[n++]=t[2].y,this._vdataF32[n++]=t[2].z,this._vdataF32[n++]=t[3].x,this._vdataF32[n++]=t[3].y,this._vdataF32[n++]=t[3].z,this._vdataUint32[n++]=t[4]}else{var r=e*this._vertAttrsFloatCount;this._vdataF32[r++]=t[0].x,this._vdataF32[r++]=t[0].y,this._vdataF32[r++]=t[0].z,this._vdataF32[r++]=t[1].x,this._vdataF32[r++]=t[1].y,this._vdataF32[r++]=t[1].z,this._vdataF32[r++]=t[2].x,this._vdataF32[r++]=t[2].y,this._vdataF32[r++]=t[2].z,this._vdataF32[r++]=t[3].x,this._vdataF32[r++]=t[3].y,this._vdataF32[r++]=t[3].z,this._vdataUint32[r++]=t[4],t[5]&&(this._vdataF32[r++]=t[5].x,this._vdataF32[r++]=t[5].y,this._vdataF32[r++]=t[5].z)}}},{key:"updateIA",value:function(e){this.getSubModel(0).inputAssembler.vertexBuffers[0].update(this._vdataF32),this.getSubModel(0).inputAssembler.indexCount=this._indexCount*e,this.getSubModel(0).inputAssembler.extractDrawInfo(this._iaInfo.drawInfos[0]),this._iaInfoBuffer.update(this._iaInfo)}},{key:"clear",value:function(){this.getSubModel(0).inputAssembler.indexCount=0}},{key:"destroy",value:function(){_(g(n.prototype),"destroy",this).call(this),this._vBuffer=null,this._vdataF32=null,this._subMeshData&&this.destroySubMeshData(),this._iaInfoBuffer.destroy(),this._subMeshData=null}},{key:"_recreateBuffer",value:function(){this._vBuffer=this._createSubMeshData(),this.getSubModel(0).updateCommandBuffer(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer)}},{key:"destroySubMeshData",value:function(){var e=this._subMeshData.vertexBuffers,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._subMeshData.indexBuffer.destroy()}}]),n}(),XZ=new Fi,YZ=(new Mi,new zn),QZ=[0,0,1,0,0,1,1,1],KZ="CC_USE_WORLD_SPACE",ZZ="CC_USE_BILLBOARD",JZ="CC_USE_STRETCHED_BILLBOARD",$Z="CC_USE_HORIZONTAL_BILLBOARD",eJ="CC_USE_VERTICAL_BILLBOARD",tJ="CC_USE_MESH",iJ=[{name:kl.ATTR_POSITION,format:Il.RGB32F},{name:kl.ATTR_TEX_COORD,format:Il.RGB32F},{name:kl.ATTR_TEX_COORD1,format:Il.RGB32F},{name:kl.ATTR_TEX_COORD2,format:Il.RGB32F},{name:kl.ATTR_COLOR,format:Il.RGBA8,isNormalized:!0}],nJ=[{name:kl.ATTR_POSITION,format:Il.RGB32F},{name:kl.ATTR_TEX_COORD,format:Il.RGB32F},{name:kl.ATTR_TEX_COORD1,format:Il.RGB32F},{name:kl.ATTR_TEX_COORD2,format:Il.RGB32F},{name:kl.ATTR_COLOR,format:Il.RGBA8,isNormalized:!0},{name:kl.ATTR_COLOR1,format:Il.RGB32F}],rJ=[{name:kl.ATTR_POSITION,format:Il.RGB32F},{name:kl.ATTR_TEX_COORD,format:Il.RGB32F},{name:kl.ATTR_TEX_COORD1,format:Il.RGB32F},{name:kl.ATTR_TEX_COORD2,format:Il.RGB32F},{name:kl.ATTR_COLOR,format:Il.RGBA8,isNormalized:!0},{name:kl.ATTR_TEX_COORD3,format:Il.RGB32F},{name:kl.ATTR_NORMAL,format:Il.RGB32F},{name:kl.ATTR_COLOR1,format:Il.RGBA8,isNormalized:!0}],aJ=(ZK=ho("cc.ParticleSystemRenderer"),JK=fo({type:PX,displayOrder:0}),$K=fo({displayOrder:1}),eZ=fo({displayOrder:2}),tZ=fo({type:PX,displayOrder:3}),iZ=fo({displayOrder:4}),nZ=fo({displayOrder:5}),rZ=fo({displayOrder:6}),aZ=fo({type:cc.ParticleSystemComponent,visible:!1}),sZ=fo({type:Fh,displayOrder:7}),oZ=fo({type:cp,displayOrder:8}),lZ=fo({type:cp,displayOrder:9}),ZK((m((uZ=function(){function e(){y(this,e),v(this,"_renderMode",hZ,this),v(this,"_velocityScale",fZ,this),v(this,"_lengthScale",dZ,this),v(this,"_mesh",pZ,this),v(this,"_particleSystem",_Z,this),this._defines=void 0,this._trailDefines=void 0,this._model=void 0,this.frameTile_velLenScale=void 0,this._node_scale=void 0,this.attrs=void 0,this._vertAttrs=[],this._particles=null,this._defaultMat=null,this._defaultTrailMat=null,this._model=null,this.frameTile_velLenScale=new Wi(1,1,0,0),this._node_scale=new Wi,this.attrs=new Array(5),this._defines={CC_USE_WORLD_SPACE:!0,CC_USE_BILLBOARD:!0,CC_USE_STRETCHED_BILLBOARD:!1,CC_USE_HORIZONTAL_BILLBOARD:!1,CC_USE_VERTICAL_BILLBOARD:!1},this._trailDefines={CC_USE_WORLD_SPACE:!0}}return l(e,[{key:"renderMode",get:function(){return this._renderMode},set:function(e){this._renderMode!==e&&(this._renderMode=e,this._setVertexAttrib(),this._updateModel(),this._updateMaterialParams())}},{key:"velocityScale",get:function(){return this._velocityScale},set:function(e){this._velocityScale=e,this._updateMaterialParams()}},{key:"lengthScale",get:function(){return this._lengthScale},set:function(e){this._lengthScale=e,this._updateMaterialParams()}},{key:"mesh",get:function(){return this._mesh},set:function(e){this._mesh=e,this._model&&this._model.setVertexAttributes(this._renderMode===PX.Mesh?this._mesh:null,this._vertAttrs)}},{key:"particleMaterial",get:function(){return this._particleSystem?this._particleSystem.getMaterial(0):null},set:function(e){this._particleSystem.setMaterial(e,0)}},{key:"trailMaterial",get:function(){return this._particleSystem?this._particleSystem.getMaterial(1):null},set:function(e){this._particleSystem.setMaterial(e,1)}}]),l(e,[{key:"onInit",value:function(e){var t=this;this._particleSystem=e,this._particles=new Rs(function(){return new KK(t)},16),this._setVertexAttrib(),this.onEnable(),this._updateModel(),this._updateMaterialParams(),this._updateTrailMaterial()}},{key:"onEnable",value:function(){this._particleSystem&&(null==this._model&&(this._model=this._particleSystem._getRenderScene().createModel(WZ,this._particleSystem.node),this._model.visFlags=this._particleSystem.visibility),this._model.inited||(this._model.setCapacity(this._particleSystem.capacity),this._model.node=this._particleSystem.node),this._model.enabled=this._particleSystem.enabledInHierarchy)}},{key:"onDisable",value:function(){this._model&&(this._model.enabled=this._particleSystem.enabledInHierarchy)}},{key:"onDestroy",value:function(){this._particleSystem._getRenderScene().destroyModel(this._model),this._model=null}},{key:"clear",value:function(){this._particles.reset(),this._updateRenderData()}},{key:"_getFreeParticle",value:function(){return this._particles.length>=this._particleSystem.capacity?null:this._particles.add()}},{key:"_setNewParticle",value:function(e){}},{key:"_updateParticles",value:function(e){switch(this._particleSystem.node.getWorldMatrix(YZ),this._particleSystem.scaleSpace){case BX.Local:this._particleSystem.node.getScale(this._node_scale);break;case BX.World:this._particleSystem.node.getWorldScale(this._node_scale)}(this._particleSystem.sharedMaterial?this.particleMaterial:this._defaultMat).setProperty("scale",this._node_scale),this._particleSystem.velocityOvertimeModule.enable&&this._particleSystem.velocityOvertimeModule.update(this._particleSystem._simulationSpace,YZ),this._particleSystem.forceOvertimeModule.enable&&this._particleSystem.forceOvertimeModule.update(this._particleSystem._simulationSpace,YZ),this._particleSystem.trailModule.enable&&this._particleSystem.trailModule.update();for(var t=0;t<this._particles.length;++t){var i=this._particles.data[t];i.remainingLifetime-=e,Fi.set(i.animatedVelocity,0,0,0),i.remainingLifetime<0?(this._particleSystem.trailModule.enable&&this._particleSystem.trailModule.removeParticle(i),this._particles.removeAt(t),--t):(i.velocity.y-=9.8*this._particleSystem.gravityModifier.evaluate(1-i.remainingLifetime/i.startLifetime,i.randomSeed)*e,this._particleSystem.sizeOvertimeModule.enable&&this._particleSystem.sizeOvertimeModule.animate(i),this._particleSystem.colorOverLifetimeModule.enable&&this._particleSystem.colorOverLifetimeModule.animate(i),this._particleSystem.forceOvertimeModule.enable&&this._particleSystem.forceOvertimeModule.animate(i,e),this._particleSystem.velocityOvertimeModule.enable?this._particleSystem.velocityOvertimeModule.animate(i):Fi.copy(i.ultimateVelocity,i.velocity),this._particleSystem.limitVelocityOvertimeModule.enable&&this._particleSystem.limitVelocityOvertimeModule.animate(i),this._particleSystem.rotationOvertimeModule.enable&&this._particleSystem.rotationOvertimeModule.animate(i,e),this._particleSystem.textureAnimationModule.enable&&this._particleSystem.textureAnimationModule.animate(i),Fi.scaleAndAdd(i.position,i.position,i.ultimateVelocity,e),this._particleSystem.trailModule.enable&&this._particleSystem.trailModule.animate(i,e))}return this._particles.length}},{key:"_updateRenderData",value:function(){for(var e=0,t=this._renderMode===PX.StrecthedBillboard,i=0;i<this._particles.length;++i){var n=this._particles.data[i],r=0;this._particleSystem.textureAnimationModule.enable&&(r=n.frameIndex),e=4*i;var a=0;if(this._renderMode!==PX.Mesh)for(var s=0;s<4;++s)a=0,this.attrs[a++]=n.position,XZ.x=QZ[2*s],XZ.y=QZ[2*s+1],XZ.z=r,this.attrs[a++]=XZ,this.attrs[a++]=n.size,this.attrs[a++]=n.rotation,this.attrs[a++]=n.color._val,this.attrs[a++]=t?n.ultimateVelocity:null,this._model.addParticleVertexData(e++,this.attrs);else a=0,this.attrs[a++]=n.position,XZ.z=r,this.attrs[a++]=XZ,this.attrs[a++]=n.size,this.attrs[a++]=n.rotation,this.attrs[a++]=n.color._val,this._model.addParticleVertexData(i,this.attrs)}this._model.updateIA(this._particles.length)}},{key:"updateShaderUniform",value:function(){}},{key:"getParticleCount",value:function(){return this._particles.length}},{key:"_onMaterialModified",value:function(e,t){0===e?(this._updateModel(),this._updateMaterialParams()):this._updateTrailMaterial()}},{key:"_onRebuildPSO",value:function(e,t){this._model&&0===e&&this._model.setSubModelMaterial(0,t),this._particleSystem.trailModule._trailModel&&1===e&&this._particleSystem.trailModule._trailModel.setSubModelMaterial(0,t)}},{key:"_setVertexAttrib",value:function(){switch(this._renderMode){case PX.StrecthedBillboard:this._vertAttrs=nJ.slice();break;case PX.Mesh:this._vertAttrs=rJ.slice();break;default:this._vertAttrs=iJ.slice()}}},{key:"_updateMaterialParams",value:function(){if(this._particleSystem){null!=this._particleSystem.sharedMaterial&&-1===this._particleSystem.sharedMaterial._effectAsset._name.indexOf("particle")&&this._particleSystem.setMaterial(null,0,!1),null==this._particleSystem.sharedMaterial&&null==this._defaultMat&&(this._defaultMat=cp.getInstantiatedMaterial(kd.get("default-particle-material"),this._particleSystem,!0));var e=this._particleSystem.sharedMaterial?this.particleMaterial:this._defaultMat;this._particleSystem._simulationSpace===BX.World?this._defines[KZ]=!0:this._defines[KZ]=!1,this._renderMode===PX.Billboard?(this._defines[ZZ]=!0,this._defines[JZ]=!1,this._defines[$Z]=!1,this._defines[eJ]=!1,this._defines[tJ]=!1):this._renderMode===PX.StrecthedBillboard?(this._defines[ZZ]=!1,this._defines[JZ]=!0,this._defines[$Z]=!1,this._defines[eJ]=!1,this._defines[tJ]=!1,this.frameTile_velLenScale.z=this._velocityScale,this.frameTile_velLenScale.w=this._lengthScale):this._renderMode===PX.HorizontalBillboard?(this._defines[ZZ]=!1,this._defines[JZ]=!1,this._defines[$Z]=!0,this._defines[eJ]=!1,this._defines[tJ]=!1):this._renderMode===PX.VerticalBillboard?(this._defines[ZZ]=!1,this._defines[JZ]=!1,this._defines[$Z]=!1,this._defines[eJ]=!0,this._defines[tJ]=!1):this._renderMode===PX.Mesh?(this._defines[ZZ]=!1,this._defines[JZ]=!1,this._defines[$Z]=!1,this._defines[eJ]=!1,this._defines[tJ]=!0):console.warn("particle system renderMode ".concat(this._renderMode," not support.")),this._particleSystem.textureAnimationModule.enable&&Mi.set(this.frameTile_velLenScale,this._particleSystem.textureAnimationModule.numTilesX,this._particleSystem.textureAnimationModule.numTilesY),e.setProperty("frameTile_velLenScale",this.frameTile_velLenScale),e.recompileShaders(this._defines),this._model&&this._model.setSubModelMaterial(0,this._particleSystem.sharedMaterial||this._defaultMat)}}},{key:"_updateTrailMaterial",value:function(){if(this._particleSystem.trailModule.enable){this._particleSystem._simulationSpace===BX.World||this._particleSystem.trailModule.space===BX.World?this._trailDefines[KZ]=!0:this._trailDefines[KZ]=!1;var e=this.trailMaterial;null===e&&null===this._defaultTrailMat&&(this._defaultTrailMat=cp.getInstantiatedMaterial(kd.get("default-trail-material"),this._particleSystem,!0)),null===e&&(e=this._defaultTrailMat),e.recompileShaders(this._trailDefines),this._particleSystem.trailModule._updateMaterial()}}},{key:"_updateModel",value:function(){this._model&&this._model.setVertexAttributes(this._renderMode===PX.Mesh?this._mesh:null,this._vertAttrs)}}]),e}()).prototype,"renderMode",[JK],Object.getOwnPropertyDescriptor(uZ.prototype,"renderMode"),uZ.prototype),m(uZ.prototype,"velocityScale",[$K],Object.getOwnPropertyDescriptor(uZ.prototype,"velocityScale"),uZ.prototype),m(uZ.prototype,"lengthScale",[eZ],Object.getOwnPropertyDescriptor(uZ.prototype,"lengthScale"),uZ.prototype),hZ=m(uZ.prototype,"_renderMode",[tZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return PX.Billboard}}),fZ=m(uZ.prototype,"_velocityScale",[iZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),dZ=m(uZ.prototype,"_lengthScale",[nZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),pZ=m(uZ.prototype,"_mesh",[rZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_Z=m(uZ.prototype,"_particleSystem",[aZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),m(uZ.prototype,"mesh",[sZ],Object.getOwnPropertyDescriptor(uZ.prototype,"mesh"),uZ.prototype),m(uZ.prototype,"particleMaterial",[oZ],Object.getOwnPropertyDescriptor(uZ.prototype,"particleMaterial"),uZ.prototype),m(uZ.prototype,"trailMaterial",[lZ],Object.getOwnPropertyDescriptor(uZ.prototype,"trailMaterial"),uZ.prototype),cZ=uZ))||cZ);Object.assign(aJ,{uv:QZ});var sJ,oJ,lJ,cJ,uJ,hJ,fJ,dJ,pJ,_J,vJ,mJ,yJ,gJ,bJ,xJ,SJ,wJ,TJ,EJ,CJ,AJ,kJ,RJ,OJ,MJ,IJ,LJ,zJ,BJ,PJ,DJ,FJ,NJ,UJ,VJ,GJ,HJ,qJ,jJ,WJ,XJ,YJ,QJ,KJ,ZJ,JJ,$J,e$,t$,i$,n$,r$,a$,s$,o$,l$,c$,u$,h$,f$,d$,p$,_$,v$,m$,y$={position:new Fi,velocity:new Fi},g$=new hn,b$=new zn,x$=new Fi,S$=new Fi,w$=new rr,T$=function(){function t(e){for(y(this,t),this.start=void 0,this.end=void 0,this.trailElements=void 0,this.start=-1,this.end=-1,this.trailElements=[];e--;)this.trailElements.push({position:new Fi,lifetime:0,width:0,velocity:new Fi,color:new rr})}return l(t,[{key:"getElement",value:function(e){return-1===this.start?null:(e<0&&(e=(e+this.trailElements.length)%this.trailElements.length),e>=this.trailElements.length&&(e%=this.trailElements.length),this.trailElements[e])}},{key:"addElement",value:function(){if(0===this.trailElements.length)return null;if(-1===this.start)return this.start=0,this.end=1,this.trailElements[0];this.start===this.end&&(this.trailElements.splice(this.end,0,{position:new Fi,lifetime:0,width:0,velocity:new Fi,color:new rr}),this.start++,this.start%=this.trailElements.length);var e=this.end++;return this.end%=this.trailElements.length,this.trailElements[e]}},{key:"iterateElement",value:function(e,t,i,n){for(var r=this.start>=this.end?this.end+this.trailElements.length:this.end,a=this.start;a<r;a++)t(e,this.trailElements[a%this.trailElements.length],i,n)&&(this.start++,this.start%=this.trailElements.length);this.start===r&&(this.start=-1,this.end=-1)}},{key:"count",value:function(){return this.start<this.end?this.end-this.start:this.trailElements.length+this.end-this.start}},{key:"clear",value:function(){this.start=-1,this.end=-1}}]),t}(),E$=(vZ=ho("cc.TrailModule"),mZ=fo({displayOrder:0}),yZ=fo({type:UX,displayOrder:1}),gZ=fo({type:CX,displayOrder:3}),bZ=fo({displayOrder:5}),xZ=fo({type:BX,displayOrder:6}),SZ=fo({displayOrder:7}),wZ=fo({type:VX,displayOrder:8}),TZ=fo({displayOrder:9}),EZ=fo({type:CX,displayOrder:10}),CZ=fo({displayOrder:11}),AZ=fo({type:OX,displayOrder:12}),kZ=fo({type:OX,displayOrder:13}),RZ=fo({type:BX}),OZ=fo({type:cc.ParticleSystemComponent,visible:!1}),vZ((m((IZ=function(){function a(){y(this,a),v(this,"_enable",LZ,this),v(this,"mode",zZ,this),v(this,"lifeTime",BZ,this),v(this,"_minParticleDistance",PZ,this),v(this,"existWithParticles",DZ,this),v(this,"textureMode",FZ,this),v(this,"widthFromParticle",NZ,this),v(this,"widthRatio",UZ,this),v(this,"colorFromParticle",VZ,this),v(this,"colorOverTrail",GZ,this),v(this,"colorOvertime",HZ,this),v(this,"_space",qZ,this),v(this,"_particleSystem",jZ,this),this._minSquaredDistance=0,this._vertSize=void 0,this._trailNum=0,this._trailLifetime=0,this.vbOffset=0,this.ibOffset=0,this._trailSegments=null,this._particleTrail=void 0,this._trailModel=null,this._iaInfo=void 0,this._iaInfoBuffer=null,this._subMeshData=null,this._vertAttrs=void 0,this._vbF32=null,this._vbUint32=null,this._iBuffer=null,this._needTransform=!1,this._defaultMat=null,this._iaInfo={drawInfos:[{vertexCount:0,firstVertex:0,indexCount:0,firstIndex:0,vertexOffset:0,instanceCount:0,firstInstance:0}]},this._vertAttrs=[{name:kl.ATTR_POSITION,format:Il.RGB32F},{name:kl.ATTR_TEX_COORD,format:Il.RGBA32F},{name:kl.ATTR_TEX_COORD1,format:Il.RGB32F},{name:kl.ATTR_COLOR,format:Il.RGBA8,isNormalized:!0}],this._vertSize=0;var e=this._vertAttrs,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;this._vertSize+=Qc[r.format].size}this._particleTrail=new Map}return l(a,[{key:"enable",get:function(){return this._enable},set:function(e){e&&!this._trailModel&&this._createModel(),e&&!this._enable&&(this._enable=e,this._particleSystem.renderer._updateTrailMaterial()),this._enable=e,this._trailModel&&(this._trailModel.enabled=e)}},{key:"minParticleDistance",get:function(){return this._minParticleDistance},set:function(e){this._minParticleDistance=e,this._minSquaredDistance=e*e}},{key:"space",get:function(){return this._space},set:function(e){this._space=e,this._particleSystem&&this._particleSystem.renderer._updateTrailMaterial()}}]),l(a,[{key:"onInit",value:function(e){this._particleSystem=e,this.minParticleDistance=this._minParticleDistance;var t=0,i=this._particleSystem.bursts,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}t+=a.getMaxCount(this._particleSystem)}this._trailNum=Math.ceil(this._particleSystem.startLifetime.getMax()*this.lifeTime.getMax()*60*(this._particleSystem.rateOverTime.getMax()*this._particleSystem.duration+t)),this._trailSegments=new ks(function(){return new T$(10)},Math.ceil(this._particleSystem.rateOverTime.getMax()*this._particleSystem.duration)),this._enable&&(this.enable=this._enable,this._updateMaterial())}},{key:"onEnable",value:function(){this._enable&&this._trailModel&&(this._trailModel.enabled=!0)}},{key:"onDisable",value:function(){this._enable&&this._trailModel&&(this._trailModel.enabled=!1)}},{key:"destroy",value:function(){this._trailModel&&(this._particleSystem._getRenderScene().destroyModel(this._trailModel),this._trailModel=null),this._trailSegments&&(this._trailSegments.clear(function(e){e.trailElements.length=0}),this._trailSegments=null)}},{key:"clear",value:function(){if(this.enable){for(var e=this._particleTrail.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this._particleTrail.clear(),this.updateRenderData()}}},{key:"_updateMaterial",value:function(){if(this._particleSystem&&this._trailModel){var e=this._particleSystem.renderer.trailMaterial;e?this._trailModel.setSubModelMaterial(0,e):this._trailModel.setSubModelMaterial(0,this._particleSystem.renderer._defaultTrailMat)}}},{key:"update",value:function(){this._trailLifetime=this.lifeTime.evaluate(this._particleSystem._time,1),this.space===BX.World&&this._particleSystem._simulationSpace===BX.Local?(this._needTransform=!0,this._particleSystem.node.getWorldMatrix(b$),this._particleSystem.node.getWorldRotation(g$)):this._needTransform=!1}},{key:"animate",value:function(e,t){if(this._trailSegments){var i=this._particleTrail.get(e);i||(i=this._trailSegments.alloc(),this._particleTrail.set(e,i));var n=i.getElement(i.end-1);if(this._needTransform?Fi.transformMat4(x$,e.position,b$):Fi.copy(x$,e.position),!(n&&(i.iterateElement(this,this._updateTrailElement,e,t),Fi.squaredDistance(n.position,x$)<this._minSquaredDistance))&&(n=i.addElement())){Fi.copy(n.position,x$),n.lifetime=0,this.widthFromParticle?n.width=e.size.x*this.widthRatio.evaluate(0,1):n.width=this.widthRatio.evaluate(0,1);var r=i.count();if(2===r){var a=i.getElement(i.end-2);Fi.subtract(a.velocity,n.position,a.position)}else if(2<r){var s=i.getElement(i.end-2),o=i.getElement(i.end-3);Fi.subtract(x$,o.position,s.position),Fi.subtract(S$,n.position,s.position),Fi.subtract(s.velocity,S$,x$),Fi.equals(Fi.ZERO,s.velocity)&&Fi.copy(s.velocity,x$)}this.colorFromParticle?n.color.set(e.color):n.color.set(this.colorOvertime.evaluate(0,1))}}}},{key:"removeParticle",value:function(e){var t=this._particleTrail.get(e);t&&this._trailSegments&&(t.clear(),this._trailSegments.free(t),this._particleTrail.delete(e))}},{key:"updateRenderData",value:function(){this.vbOffset=0,this.ibOffset=0;var e=this._particleTrail.keys(),t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n,a=this._particleTrail.get(r);if(-1!==a.start){var s=4*this.vbOffset/this._vertSize,o=a.start>=a.end?a.end+a.trailElements.length:a.end,l=o-a.start,c=1/l,u=a.trailElements[a.start];this._fillVertexBuffer(u,this.colorOverTrail.evaluate(1,1),s,1,0,4);for(var h=a.start+1;h<o;h++){var f=a.trailElements[h%a.trailElements.length],d=h-a.start;this._fillVertexBuffer(f,this.colorOverTrail.evaluate(1-d/l,1),s,1-d*c,d,5)}if(this._needTransform?Fi.transformMat4(y$.position,r.position,b$):Fi.copy(y$.position,r.position),1==l){var p=a.getElement(a.end-1);Fi.subtract(p.velocity,y$.position,p.position),this._vbF32[this.vbOffset-this._vertSize/4-4]=p.velocity.x,this._vbF32[this.vbOffset-this._vertSize/4-3]=p.velocity.y,this._vbF32[this.vbOffset-this._vertSize/4-2]=p.velocity.z,this._vbF32[this.vbOffset-4]=p.velocity.x,this._vbF32[this.vbOffset-3]=p.velocity.y,this._vbF32[this.vbOffset-2]=p.velocity.z,Fi.subtract(y$.velocity,y$.position,p.position)}else if(2<l){var _=a.getElement(a.end-1),v=a.getElement(a.end-2);Fi.subtract(x$,v.position,_.position),Fi.subtract(S$,y$.position,_.position),Fi.subtract(_.velocity,S$,x$),this._vbF32[this.vbOffset-this._vertSize/4-4]=_.velocity.x,this._vbF32[this.vbOffset-this._vertSize/4-3]=_.velocity.y,this._vbF32[this.vbOffset-this._vertSize/4-2]=_.velocity.z,this._vbF32[this.vbOffset-4]=_.velocity.x,this._vbF32[this.vbOffset-3]=_.velocity.y,this._vbF32[this.vbOffset-2]=_.velocity.z,Fi.subtract(y$.velocity,y$.position,_.position)}y$.width=r.size.x,y$.color=r.color,Fi.equals(y$.velocity,Fi.ZERO)?this.ibOffset-=3:this._fillVertexBuffer(y$,this.colorOverTrail.evaluate(0,1),s,0,l,1)}}this.updateIA(this.ibOffset)}},{key:"updateIA",value:function(e){if(this._trailModel&&0<this._trailModel.subModelNum){var t=this._trailModel.getSubModel(0);t.inputAssembler.vertexBuffers[0].update(this._vbF32),t.inputAssembler.indexBuffer.update(this._iBuffer),t.inputAssembler.indexCount=e,t.inputAssembler.extractDrawInfo(this._iaInfo.drawInfos[0]),this._iaInfoBuffer.update(this._iaInfo)}}},{key:"_createModel",value:function(){if(!this._trailModel){var e=Yb.root.device,t=e.createBuffer({usage:zl.VERTEX|zl.TRANSFER_DST,memUsage:Pl.HOST|Pl.DEVICE,size:this._vertSize*(this._trailNum+1)*2,stride:this._vertSize}),i=new ArrayBuffer(this._vertSize*(this._trailNum+1)*2);this._vbF32=new Float32Array(i),this._vbUint32=new Uint32Array(i),t.update(i);var n=e.createBuffer({usage:zl.INDEX|zl.TRANSFER_DST,memUsage:Pl.HOST|Pl.DEVICE,size:6*this._trailNum*Uint16Array.BYTES_PER_ELEMENT,stride:Uint16Array.BYTES_PER_ELEMENT});this._iBuffer=new Uint16Array(6*this._trailNum),n.update(this._iBuffer),this._iaInfoBuffer=e.createBuffer({usage:zl.INDIRECT,memUsage:Pl.HOST|Pl.DEVICE,size:56,stride:1}),this._iaInfo.drawInfos[0].vertexCount=2*(this._trailNum+1),this._iaInfo.drawInfos[0].indexCount=6*this._trailNum,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData={vertexBuffers:[t],indexBuffer:n,indirectBuffer:this._iaInfoBuffer,attributes:this._vertAttrs,primitiveMode:Gl.TRIANGLE_LIST,flatBuffers:[]},this._trailModel=this._particleSystem._getRenderScene().createModel(vf,this._particleSystem.node),this._trailModel.visFlags=this._particleSystem.visibility,this._trailModel.setSubModelMesh(0,this._subMeshData),this._trailModel.enabled=!0}}},{key:"_updateTrailElement",value:function(e,t,i,n){return t.lifetime+=n,e.colorFromParticle?(t.color.set(i.color),t.color.multiply(e.colorOvertime.evaluate(1-i.remainingLifetime/i.startLifetime,1))):t.color.set(e.colorOvertime.evaluate(1-i.remainingLifetime/i.startLifetime,1)),e.widthFromParticle?t.width=i.size.x*e.widthRatio.evaluate(t.lifetime/e._trailLifetime,1):t.width=e.widthRatio.evaluate(t.lifetime/e._trailLifetime,1),t.lifetime>e._trailLifetime}},{key:"_fillVertexBuffer",value:function(e,t,i,n,r,a){this._vbF32[this.vbOffset++]=e.position.x,this._vbF32[this.vbOffset++]=e.position.y,this._vbF32[this.vbOffset++]=e.position.z,this._vbF32[this.vbOffset++]=0,this._vbF32[this.vbOffset++]=e.width,this._vbF32[this.vbOffset++]=n,this._vbF32[this.vbOffset++]=0,this._vbF32[this.vbOffset++]=e.velocity.x,this._vbF32[this.vbOffset++]=e.velocity.y,this._vbF32[this.vbOffset++]=e.velocity.z,w$.set(e.color),w$.multiply(t),this._vbUint32[this.vbOffset++]=w$._val,this._vbF32[this.vbOffset++]=e.position.x,this._vbF32[this.vbOffset++]=e.position.y,this._vbF32[this.vbOffset++]=e.position.z,this._vbF32[this.vbOffset++]=1,this._vbF32[this.vbOffset++]=e.width,this._vbF32[this.vbOffset++]=n,this._vbF32[this.vbOffset++]=1,this._vbF32[this.vbOffset++]=e.velocity.x,this._vbF32[this.vbOffset++]=e.velocity.y,this._vbF32[this.vbOffset++]=e.velocity.z,this._vbUint32[this.vbOffset++]=w$._val,1&a&&(this._iBuffer[this.ibOffset++]=i+2*r,this._iBuffer[this.ibOffset++]=i+2*r-1,this._iBuffer[this.ibOffset++]=i+2*r+1),4&a&&(this._iBuffer[this.ibOffset++]=i+2*r,this._iBuffer[this.ibOffset++]=i+2*r+1,this._iBuffer[this.ibOffset++]=i+2*r+2)}}]),a}()).prototype,"enable",[mZ],Object.getOwnPropertyDescriptor(IZ.prototype,"enable"),IZ.prototype),LZ=m(IZ.prototype,"_enable",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),zZ=m(IZ.prototype,"mode",[yZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return UX.Particles}}),BZ=m(IZ.prototype,"lifeTime",[gZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CX}}),PZ=m(IZ.prototype,"_minParticleDistance",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),m(IZ.prototype,"minParticleDistance",[bZ],Object.getOwnPropertyDescriptor(IZ.prototype,"minParticleDistance"),IZ.prototype),m(IZ.prototype,"space",[xZ],Object.getOwnPropertyDescriptor(IZ.prototype,"space"),IZ.prototype),DZ=m(IZ.prototype,"existWithParticles",[SZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),FZ=m(IZ.prototype,"textureMode",[wZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return VX.Stretch}}),NZ=m(IZ.prototype,"widthFromParticle",[TZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),UZ=m(IZ.prototype,"widthRatio",[EZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CX}}),VZ=m(IZ.prototype,"colorFromParticle",[CZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),GZ=m(IZ.prototype,"colorOverTrail",[AZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new OX}}),HZ=m(IZ.prototype,"colorOvertime",[kZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new OX}}),qZ=m(IZ.prototype,"_space",[RZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return BX.World}}),jZ=m(IZ.prototype,"_particleSystem",[OZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),MZ=IZ))||MZ),C$=new zn,A$=P2("ParticleSystemComponent",(sJ=ho("cc.ParticleSystemComponent"),oJ=yo("Components/ParticleSystem"),lJ=go(99),cJ=fo({displayOrder:1}),uJ=fo({type:OX,displayOrder:8}),hJ=fo({type:BX,displayOrder:9}),fJ=fo({type:CX,displayOrder:10}),dJ=fo({type:CX,range:[-1,1],displayOrder:11}),pJ=fo({type:CX,range:[-1,1],radian:!0,displayOrder:12}),_J=fo({type:CX,displayOrder:6}),vJ=fo({type:CX,displayOrder:7}),mJ=fo({displayOrder:0}),yJ=fo({displayOrder:2}),gJ=fo({displayOrder:3}),bJ=fo({type:BX,displayOrder:4}),xJ=fo({displayOrder:5}),SJ=fo({displayOrder:2}),wJ=fo({type:CX,range:[-1,1],displayOrder:13}),TJ=fo({type:CX,displayOrder:14}),EJ=fo({type:CX,displayOrder:15}),CJ=fo({type:[qK],displayOrder:16}),AJ=fo({type:cp,displayName:"Materials",visible:!1,override:!0}),kJ=fo({type:zX,displayOrder:23}),RJ=fo({type:YK,displayOrder:17}),OJ=fo({type:PK,displayOrder:21}),MJ=fo({type:HK,displayOrder:18}),IJ=fo({type:OY,displayOrder:19}),LJ=fo({type:LY,displayOrder:20}),zJ=fo({type:BK,displayOrder:22}),BJ=fo({type:UK,displayOrder:24}),PJ=fo({type:E$,displayOrder:25}),DJ=fo({type:aJ,displayOrder:26}),sJ(FJ=oJ(FJ=lJ(FJ=vo((m((NJ=function(){function t(){var e;return y(this,t),v(e=x(this,g(t).call(this)),"startColor",UJ,u(e)),v(e,"scaleSpace",VJ,u(e)),v(e,"startSize",GJ,u(e)),v(e,"startSpeed",HJ,u(e)),v(e,"startRotation",qJ,u(e)),v(e,"startDelay",jJ,u(e)),v(e,"startLifetime",WJ,u(e)),v(e,"duration",XJ,u(e)),v(e,"loop",YJ,u(e)),v(e,"simulationSpeed",QJ,u(e)),v(e,"playOnAwake",KJ,u(e)),v(e,"gravityModifier",ZJ,u(e)),v(e,"rateOverTime",JJ,u(e)),v(e,"rateOverDistance",$J,u(e)),v(e,"bursts",e$,u(e)),v(e,"colorOverLifetimeModule",t$,u(e)),v(e,"shapeModule",i$,u(e)),v(e,"sizeOvertimeModule",n$,u(e)),v(e,"velocityOvertimeModule",r$,u(e)),v(e,"forceOvertimeModule",a$,u(e)),v(e,"limitVelocityOvertimeModule",s$,u(e)),v(e,"rotationOvertimeModule",o$,u(e)),v(e,"textureAnimationModule",l$,u(e)),v(e,"trailModule",c$,u(e)),v(e,"renderer",u$,u(e)),e._isPlaying=void 0,e._isPaused=void 0,e._isStopped=void 0,e._isEmitting=void 0,e._time=void 0,e._emitRateTimeCounter=void 0,e._emitRateDistanceCounter=void 0,e._oldWPos=void 0,e._curWPos=void 0,e._customData1=void 0,e._customData2=void 0,e._subEmitters=void 0,v(e,"_prewarm",h$,u(e)),v(e,"_capacity",f$,u(e)),v(e,"_simulationSpace",d$,u(e)),e.rateOverTime.constant=10,e.startLifetime.constant=5,e.startSize.constant=1,e.startSpeed.constant=5,e._isPlaying=!1,e._isPaused=!1,e._isStopped=!0,e._isEmitting=!1,e._time=0,e._emitRateTimeCounter=0,e._emitRateDistanceCounter=0,e._oldWPos=new Fi,e._curWPos=new Fi,e._customData1=new Mi,e._customData2=new Mi,e._subEmitters=[],e}return p(t,kC),l(t,[{key:"capacity",get:function(){return this._capacity},set:function(e){this._capacity=e,this.renderer&&this.renderer._model&&this.renderer._model.setCapacity(this._capacity)}},{key:"prewarm",get:function(){return this._prewarm},set:function(e){!0===e&&this.loop,this._prewarm=e}},{key:"simulationSpace",get:function(){return this._simulationSpace},set:function(e){e!==this._simulationSpace&&(this._simulationSpace=e,this.renderer._updateMaterialParams(),this.renderer._updateTrailMaterial())}},{key:"sharedMaterials",get:function(){return _(g(t.prototype),"sharedMaterials",this)},set:function(e){r(g(t.prototype),"sharedMaterials",e,this,!0)}}]),l(t,[{key:"onLoad",value:function(){this.renderer.onInit(this),this.shapeModule.onInit(this),this.trailModule.onInit(this),this.textureAnimationModule.onInit(this),this._resetPosition()}},{key:"_onMaterialModified",value:function(e,t){this.renderer._onMaterialModified(e,t)}},{key:"_onRebuildPSO",value:function(e,t){this.renderer._onRebuildPSO(e,t)}},{key:"_getModel",value:function(){return this.renderer._model}},{key:"recreateModel",value:function(){if(this.isValid){var e=this.renderer;e&&e._model&&(e._model.destroy(),e._model=null,e.onEnable(),e._updateModel(),e._updateMaterialParams(),e._updateTrailMaterial())}}},{key:"play",value:function(){this._isPaused&&(this._isPaused=!1),this._isStopped&&(this._isStopped=!1),this._isPlaying=!0,this._isEmitting=!0,this._resetPosition(),this._prewarm&&this._prewarmSystem()}},{key:"pause",value:function(){this._isStopped?console.warn("pause(): particle system is already stopped."):(this._isPlaying&&(this._isPlaying=!1),this._isPaused=!0)}},{key:"stop",value:function(){(this._isPlaying||this._isPaused)&&this.clear(),this._isPlaying&&(this._isPlaying=!1),this._isPaused&&(this._isPaused=!1),this._time=0,this._emitRateTimeCounter=0,this._emitRateDistanceCounter=0,this._isStopped=!0}},{key:"clear",value:function(){this.enabledInHierarchy&&(this.renderer.clear(),this.trailModule.clear())}},{key:"getParticleCount",value:function(){return this.renderer.getParticleCount()}},{key:"setCustomData1",value:function(e,t){Mi.set(this._customData1,e,t)}},{key:"setCustomData2",value:function(e,t){Mi.set(this._customData2,e,t)}},{key:"onDestroy",value:function(){this.renderer.onDestroy(),this.trailModule.destroy()}},{key:"onEnable",value:function(){this.playOnAwake&&this.play(),this.renderer.onEnable(),this.trailModule.onEnable()}},{key:"onDisable",value:function(){this.renderer.onDisable(),this.trailModule.onDisable()}},{key:"update",value:function(e){var t=e*this.simulationSpeed;this._isPlaying&&(this._time+=t,this._emit(t),0!==this.renderer._updateParticles(t)||this._isEmitting||this.stop(),this.renderer._updateRenderData(),this.trailModule.enable&&this.trailModule.updateRenderData())}},{key:"_onVisiblityChange",value:function(e){this.renderer._model&&(this.renderer._model.visFlags=e)}},{key:"emit",value:function(e,t){for(var i=0;i<e;++i){var n=this.renderer._getFreeParticle();if(null===n)return;var r=Si(xi(0,ae));switch(this.shapeModule.enable?this.shapeModule.emit(n):(Fi.set(n.position,0,0,0),Fi.copy(n.velocity,GX)),this.textureAnimationModule.enable&&this.textureAnimationModule.init(n),Fi.multiplyScalar(n.velocity,n.velocity,this.startSpeed.evaluate(this._time/this.duration,r)),this._simulationSpace){case BX.Local:break;case BX.World:this.node.getWorldMatrix(C$),Fi.transformMat4(n.position,n.position,C$);var a=new hn;this.node.getWorldRotation(a),Fi.transformQuat(n.velocity,n.velocity,a);break;case BX.Custom:}Fi.copy(n.ultimateVelocity,n.velocity),Fi.set(n.rotation,0,0,this.startRotation.evaluate(this._time/this.duration,r)),Fi.set(n.startSize,this.startSize.evaluate(this._time/this.duration,r),1,1),n.startSize.y=n.startSize.x,Fi.copy(n.size,n.startSize),n.startColor.set(this.startColor.evaluate(this._time/this.duration,r)),n.color.set(n.startColor),n.startLifetime=this.startLifetime.evaluate(this._time/this.duration,r)+t,n.remainingLifetime=n.startLifetime,n.randomSeed=xi(0,233280),this.renderer._setNewParticle(n)}}},{key:"_prewarmSystem",value:function(){this.startDelay.mode=EX.Constant,this.startDelay.constant=0;for(var e=this.duration/1,t=0;t<e;++t)this._time+=1,this._emit(1),this.renderer._updateParticles(1)}},{key:"_emit",value:function(e){var t=this.startDelay.evaluate(0,1);if(this._time>t){if(this._time>this.duration+t&&!this.loop)return void(this._isEmitting=!1);if(this._emitRateTimeCounter+=this.rateOverTime.evaluate(this._time/this.duration,1)*e,1<this._emitRateTimeCounter&&this._isEmitting){var i=Math.floor(this._emitRateTimeCounter);this._emitRateTimeCounter-=i,this.emit(i,e)}this.node.getWorldPosition(this._curWPos);var n=Fi.distance(this._curWPos,this._oldWPos);if(Fi.copy(this._oldWPos,this._curWPos),this._emitRateDistanceCounter+=n*this.rateOverDistance.evaluate(this._time/this.duration,1),1<this._emitRateDistanceCounter&&this._isEmitting){var r=Math.floor(this._emitRateDistanceCounter);this._emitRateDistanceCounter-=r,this.emit(r,e)}var a=this.bursts,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}l.update(this,e)}}}},{key:"_resetPosition",value:function(){this.node.getWorldPosition(this._oldWPos),Fi.copy(this._curWPos,this._oldWPos)}},{key:"addSubEmitter",value:function(e){this._subEmitters.push(e)}},{key:"removeSubEmitter",value:function(e){this._subEmitters.splice(this._subEmitters.indexOf(e),1)}},{key:"addBurst",value:function(e){this.bursts.push(e)}},{key:"removeBurst",value:function(e){this.bursts.splice(this.bursts.indexOf(e),1)}},{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"isStopped",get:function(){return this._isStopped}},{key:"isEmitting",get:function(){return this._isEmitting}},{key:"time",get:function(){return this._time}}]),t}()).prototype,"capacity",[cJ],Object.getOwnPropertyDescriptor(NJ.prototype,"capacity"),NJ.prototype),UJ=m(NJ.prototype,"startColor",[uJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new OX}}),VJ=m(NJ.prototype,"scaleSpace",[hJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return BX.Local}}),GJ=m(NJ.prototype,"startSize",[fJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CX}}),HJ=m(NJ.prototype,"startSpeed",[dJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CX}}),qJ=m(NJ.prototype,"startRotation",[pJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CX}}),jJ=m(NJ.prototype,"startDelay",[_J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CX}}),WJ=m(NJ.prototype,"startLifetime",[vJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CX}}),XJ=m(NJ.prototype,"duration",[mJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),YJ=m(NJ.prototype,"loop",[yJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),m(NJ.prototype,"prewarm",[gJ],Object.getOwnPropertyDescriptor(NJ.prototype,"prewarm"),NJ.prototype),m(NJ.prototype,"simulationSpace",[bJ],Object.getOwnPropertyDescriptor(NJ.prototype,"simulationSpace"),NJ.prototype),QJ=m(NJ.prototype,"simulationSpeed",[xJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),KJ=m(NJ.prototype,"playOnAwake",[SJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ZJ=m(NJ.prototype,"gravityModifier",[wJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CX}}),JJ=m(NJ.prototype,"rateOverTime",[TJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CX}}),$J=m(NJ.prototype,"rateOverDistance",[EJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CX}}),e$=m(NJ.prototype,"bursts",[CJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Array}}),m(NJ.prototype,"sharedMaterials",[AJ],Object.getOwnPropertyDescriptor(NJ.prototype,"sharedMaterials"),NJ.prototype),t$=m(NJ.prototype,"colorOverLifetimeModule",[kJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zX}}),i$=m(NJ.prototype,"shapeModule",[RJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new YK}}),n$=m(NJ.prototype,"sizeOvertimeModule",[OJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new PK}}),r$=m(NJ.prototype,"velocityOvertimeModule",[MJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new HK}}),a$=m(NJ.prototype,"forceOvertimeModule",[IJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new OY}}),s$=m(NJ.prototype,"limitVelocityOvertimeModule",[LJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new LY}}),o$=m(NJ.prototype,"rotationOvertimeModule",[zJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new BK}}),l$=m(NJ.prototype,"textureAnimationModule",[BJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new UK}}),c$=m(NJ.prototype,"trailModule",[PJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new E$}}),u$=m(NJ.prototype,"renderer",[DJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new aJ}}),h$=m(NJ.prototype,"_prewarm",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),f$=m(NJ.prototype,"_capacity",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),d$=m(NJ.prototype,"_simulationSpace",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return BX.Local}}),FJ=NJ))||FJ)||FJ)||FJ)||FJ)),k$=P2("ParticleUtils",function(){function e(){y(this,e)}return l(e,null,[{key:"instantiate",value:function(e){return this.registeredSceneEvent||(Yb.on(Xb.EVENT_BEFORE_SCENE_LAUNCH,this.onSceneUnload,this),this.registeredSceneEvent=!0),this.particleSystemPool.has(e._uuid)||this.particleSystemPool.set(e._uuid,new ks(function(){return Qo(e)},1)),this.particleSystemPool.get(e._uuid).alloc()}},{key:"destroy",value:function(e){this.particleSystemPool.has(e._prefab.asset._uuid)&&(this.stop(e),this.particleSystemPool.get(e._prefab.asset._uuid).free(e))}},{key:"onSceneUnload",value:function(){this.particleSystemPool.forEach(function(e){e.clear(function(e){e.destroy()})}),this.particleSystemPool.clear()}},{key:"play",value:function(e){var t=e.getComponentsInChildren(A$),i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.play()}}},{key:"stop",value:function(e){var t=e.getComponentsInChildren(A$),i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.stop()}}}]),e}());function R$(){throw new Error("Dynamic requires are not currently supported by rollup-plugin-commonjs")}function O$(e,t){return e(t={exports:{}},t.exports),t.exports}k$.particleSystemPool=new Map,k$.registeredSceneEvent=!1,cc.ParticleSystemComponent=A$,cc.BillboardComponent=bX,cc.LineComponent=LX,cc.ParticleUtils=k$;var M$,I$,L$,z$,B$=O$(function(e,t){e.exports=function r(a,s,o){function l(i,e){if(!s[i]){if(!a[i]){var t=R$;if(!e&&t)return t(i,!0);if(c)return c(i,!0);throw new Error("Cannot find module '"+i+"'")}var n=s[i]={exports:{}};a[i][0].call(n.exports,function(e){var t=a[i][1][e];return l(t||e)},n,n.exports,r,a,s,o)}return s[i].exports}for(var c=R$,e=0;e<o.length;e++)l(o[e]);return l}({1:[function(e,t,i){t.exports={name:"cannon",version:"1.0.1",description:"A lightweight 3D physics engine written in JavaScript.",homepage:"https://github.com/cocos-creator/cannon.js",author:"JayceLai",keywords:["cannon.js","cannon","physics","engine","3d"],scripts:{build:"grunt && npm run preprocess && grunt addLicense && grunt addDate",preprocess:"node node_modules/uglify-js/bin/uglifyjs build/cannon.js -o build/cannon.min.js -d doProfiling=false,DEBUG=false -c -m"},main:"./build/cannon.min.js",engines:{node:"*"},repository:{type:"git",url:"https://github.com/cocos-creator/cannon.js.git"},bugs:{url:"https://github.com/cocos-creator/cannon.js/issues"},licenses:[{type:"MIT"}],devDependencies:{jshint:"latest","uglify-js":"latest",nodeunit:"^0.9.0",grunt:"~0.4.0","grunt-contrib-jshint":"~0.1.1","grunt-contrib-nodeunit":"^0.4.1","grunt-contrib-concat":"~0.1.3","grunt-contrib-uglify":"^0.5.1","grunt-browserify":"^2.1.4","grunt-contrib-yuidoc":"^0.5.2",browserify:"*"},dependencies:{}}},{}],2:[function(e,t,i){t.exports={version:e("../package.json").version,AABB:e("./collision/AABB"),ArrayCollisionMatrix:e("./collision/ArrayCollisionMatrix"),Body:e("./objects/Body"),Box:e("./shapes/Box"),Broadphase:e("./collision/Broadphase"),Constraint:e("./constraints/Constraint"),ContactEquation:e("./equations/ContactEquation"),Narrowphase:e("./world/Narrowphase"),ConeTwistConstraint:e("./constraints/ConeTwistConstraint"),ContactMaterial:e("./material/ContactMaterial"),ConvexPolyhedron:e("./shapes/ConvexPolyhedron"),Cylinder:e("./shapes/Cylinder"),DistanceConstraint:e("./constraints/DistanceConstraint"),Equation:e("./equations/Equation"),EventTarget:e("./utils/EventTarget"),FrictionEquation:e("./equations/FrictionEquation"),GSSolver:e("./solver/GSSolver"),GridBroadphase:e("./collision/GridBroadphase"),Heightfield:e("./shapes/Heightfield"),HingeConstraint:e("./constraints/HingeConstraint"),LockConstraint:e("./constraints/LockConstraint"),Mat3:e("./math/Mat3"),Material:e("./material/Material"),NaiveBroadphase:e("./collision/NaiveBroadphase"),ObjectCollisionMatrix:e("./collision/ObjectCollisionMatrix"),Pool:e("./utils/Pool"),Particle:e("./shapes/Particle"),Plane:e("./shapes/Plane"),PointToPointConstraint:e("./constraints/PointToPointConstraint"),Quaternion:e("./math/Quaternion"),Ray:e("./collision/Ray"),RaycastVehicle:e("./objects/RaycastVehicle"),RaycastResult:e("./collision/RaycastResult"),RigidVehicle:e("./objects/RigidVehicle"),RotationalEquation:e("./equations/RotationalEquation"),RotationalMotorEquation:e("./equations/RotationalMotorEquation"),SAPBroadphase:e("./collision/SAPBroadphase"),SPHSystem:e("./objects/SPHSystem"),Shape:e("./shapes/Shape"),Solver:e("./solver/Solver"),Sphere:e("./shapes/Sphere"),SplitSolver:e("./solver/SplitSolver"),Spring:e("./objects/Spring"),Transform:e("./math/Transform"),Trimesh:e("./shapes/Trimesh"),Vec3:e("./math/Vec3"),Vec3Pool:e("./utils/Vec3Pool"),World:e("./world/World")}},{"../package.json":1,"./collision/AABB":3,"./collision/ArrayCollisionMatrix":4,"./collision/Broadphase":5,"./collision/GridBroadphase":6,"./collision/NaiveBroadphase":7,"./collision/ObjectCollisionMatrix":8,"./collision/Ray":10,"./collision/RaycastResult":11,"./collision/SAPBroadphase":12,"./constraints/ConeTwistConstraint":13,"./constraints/Constraint":14,"./constraints/DistanceConstraint":15,"./constraints/HingeConstraint":16,"./constraints/LockConstraint":17,"./constraints/PointToPointConstraint":18,"./equations/ContactEquation":20,"./equations/Equation":21,"./equations/FrictionEquation":22,"./equations/RotationalEquation":23,"./equations/RotationalMotorEquation":24,"./material/ContactMaterial":25,"./material/Material":26,"./math/Mat3":28,"./math/Quaternion":29,"./math/Transform":30,"./math/Vec3":31,"./objects/Body":32,"./objects/RaycastVehicle":33,"./objects/RigidVehicle":34,"./objects/SPHSystem":35,"./objects/Spring":36,"./shapes/Box":38,"./shapes/ConvexPolyhedron":39,"./shapes/Cylinder":40,"./shapes/Heightfield":41,"./shapes/Particle":42,"./shapes/Plane":43,"./shapes/Shape":44,"./shapes/Sphere":45,"./shapes/Trimesh":46,"./solver/GSSolver":47,"./solver/Solver":48,"./solver/SplitSolver":49,"./utils/EventTarget":50,"./utils/Pool":52,"./utils/Vec3Pool":55,"./world/Narrowphase":56,"./world/World":57}],3:[function(e,t,i){var n=e("../math/Vec3");function r(e){e=e||{},this.lowerBound=new n,e.lowerBound&&this.lowerBound.copy(e.lowerBound),this.upperBound=new n,e.upperBound&&this.upperBound.copy(e.upperBound)}e("../utils/Utils"),t.exports=r;var c=new n;r.prototype.setFromPoints=function(e,t,i,n){var r=this.lowerBound,a=this.upperBound,s=i;r.copy(e[0]),s&&s.vmult(r,r),a.copy(r);for(var o=1;o<e.length;o++){var l=e[o];s&&(s.vmult(l,c),l=c),l.x>a.x&&(a.x=l.x),l.x<r.x&&(r.x=l.x),l.y>a.y&&(a.y=l.y),l.y<r.y&&(r.y=l.y),l.z>a.z&&(a.z=l.z),l.z<r.z&&(r.z=l.z)}return t&&(t.vadd(r,r),t.vadd(a,a)),n&&(r.x-=n,r.y-=n,r.z-=n,a.x+=n,a.y+=n,a.z+=n),this},r.prototype.copy=function(e){return this.lowerBound.copy(e.lowerBound),this.upperBound.copy(e.upperBound),this},r.prototype.clone=function(){return(new r).copy(this)},r.prototype.extend=function(e){this.lowerBound.x=Math.min(this.lowerBound.x,e.lowerBound.x),this.upperBound.x=Math.max(this.upperBound.x,e.upperBound.x),this.lowerBound.y=Math.min(this.lowerBound.y,e.lowerBound.y),this.upperBound.y=Math.max(this.upperBound.y,e.upperBound.y),this.lowerBound.z=Math.min(this.lowerBound.z,e.lowerBound.z),this.upperBound.z=Math.max(this.upperBound.z,e.upperBound.z)},r.prototype.overlaps=function(e){var t=this.lowerBound,i=this.upperBound,n=e.lowerBound,r=e.upperBound,a=n.x<=i.x&&i.x<=r.x||t.x<=r.x&&r.x<=i.x,s=n.y<=i.y&&i.y<=r.y||t.y<=r.y&&r.y<=i.y,o=n.z<=i.z&&i.z<=r.z||t.z<=r.z&&r.z<=i.z;return a&&s&&o},r.prototype.volume=function(){var e=this.lowerBound,t=this.upperBound;return(t.x-e.x)*(t.y-e.y)*(t.z-e.z)},r.prototype.contains=function(e){var t=this.lowerBound,i=this.upperBound,n=e.lowerBound,r=e.upperBound;return t.x<=n.x&&i.x>=r.x&&t.y<=n.y&&i.y>=r.y&&t.z<=n.z&&i.z>=r.z},r.prototype.getCorners=function(e,t,i,n,r,a,s,o){var l=this.lowerBound,c=this.upperBound;e.copy(l),t.set(c.x,l.y,l.z),i.set(c.x,c.y,l.z),n.set(l.x,c.y,c.z),r.set(c.x,l.y,l.z),a.set(l.x,c.y,l.z),s.set(l.x,l.y,c.z),o.copy(c)};var d=[new n,new n,new n,new n,new n,new n,new n,new n];r.prototype.toLocalFrame=function(e,t){var i=d,n=i[0],r=i[1],a=i[2],s=i[3],o=i[4],l=i[5],c=i[6],u=i[7];this.getCorners(n,r,a,s,o,l,c,u);for(var h=0;8!==h;h++){var f=i[h];e.pointToLocal(f,f)}return t.setFromPoints(i)},r.prototype.toWorldFrame=function(e,t){var i=d,n=i[0],r=i[1],a=i[2],s=i[3],o=i[4],l=i[5],c=i[6],u=i[7];this.getCorners(n,r,a,s,o,l,c,u);for(var h=0;8!==h;h++){var f=i[h];e.pointToWorld(f,f)}return t.setFromPoints(i)},r.prototype.overlapsRay=function(e){var t=1/e._direction.x,i=1/e._direction.y,n=1/e._direction.z,r=(this.lowerBound.x-e.from.x)*t,a=(this.upperBound.x-e.from.x)*t,s=(this.lowerBound.y-e.from.y)*i,o=(this.upperBound.y-e.from.y)*i,l=(this.lowerBound.z-e.from.z)*n,c=(this.upperBound.z-e.from.z)*n,u=Math.max(Math.max(Math.min(r,a),Math.min(s,o)),Math.min(l,c)),h=Math.min(Math.min(Math.max(r,a),Math.max(s,o)),Math.max(l,c));return!(h<0||h<u)}},{"../math/Vec3":31,"../utils/Utils":54}],4:[function(e,t,i){function n(){this.matrix=[]}(t.exports=n).prototype.get=function(e,t){if((e=e.index)<(t=t.index)){var i=t;t=e,e=i}return this.matrix[(e*(e+1)>>1)+t-1]},n.prototype.set=function(e,t,i){if((e=e.index)<(t=t.index)){var n=t;t=e,e=n}this.matrix[(e*(e+1)>>1)+t-1]=i?1:0},n.prototype.reset=function(){for(var e=0,t=this.matrix.length;e!==t;e++)this.matrix[e]=0},n.prototype.setNumObjects=function(e){this.matrix.length=e*(e-1)>>1}},{}],5:[function(e,t,i){var n=e("../objects/Body"),r=e("../math/Vec3"),a=e("../math/Quaternion");function s(){this.world=null,this.useBoundingBoxes=!1,this.dirty=!0}e("../shapes/Shape"),e("../shapes/Plane"),(t.exports=s).prototype.collisionPairs=function(e,t,i){throw new Error("collisionPairs not implemented for this BroadPhase class!")},s.prototype.needBroadphaseCollision=function(e,t){return 0!=(e.collisionFilterGroup&t.collisionFilterMask)&&0!=(t.collisionFilterGroup&e.collisionFilterMask)&&(0==(e.type&n.STATIC)&&e.sleepState!==n.SLEEPING||0==(t.type&n.STATIC)&&t.sleepState!==n.SLEEPING)},s.prototype.intersectionTest=function(e,t,i,n){this.useBoundingBoxes?this.doBoundingBoxBroadphase(e,t,i,n):this.doBoundingSphereBroadphase(e,t,i,n)};var o=new r;new r,new a,new r,s.prototype.doBoundingSphereBroadphase=function(e,t,i,n){var r=o;t.position.vsub(e.position,r);var a=Math.pow(e.boundingRadius+t.boundingRadius,2);r.norm2()<a&&(i.push(e),n.push(t))},s.prototype.doBoundingBoxBroadphase=function(e,t,i,n){e.aabbNeedsUpdate&&e.computeAABB(),t.aabbNeedsUpdate&&t.computeAABB(),e.aabb.overlaps(t.aabb)&&(i.push(e),n.push(t))};var h={keys:[]},f=[],d=[];s.prototype.makePairsUnique=function(e,t){for(var i=h,n=f,r=d,a=e.length,s=0;s!==a;s++)n[s]=e[s],r[s]=t[s];for(e.length=0,s=t.length=0;s!==a;s++){var o=n[s].id,l=r[s].id;i[c=o<l?o+","+l:l+","+o]=s,i.keys.push(c)}for(s=0;s!==i.keys.length;s++){var c=i.keys.pop(),u=i[c];e.push(n[u]),t.push(r[u]),delete i[c]}},s.prototype.setWorld=function(e){};var l=new r;s.boundingSphereCheck=function(e,t){var i=l;return e.position.vsub(t.position,i),Math.pow(e.shape.boundingSphereRadius+t.shape.boundingSphereRadius,2)>i.norm2()},s.prototype.aabbQuery=function(e,t,i){return console.warn(".aabbQuery is not implemented in this Broadphase subclass."),[]}},{"../math/Quaternion":29,"../math/Vec3":31,"../objects/Body":32,"../shapes/Plane":43,"../shapes/Shape":44}],6:[function(e,t,i){t.exports=n;var o=e("./Broadphase"),l=e("../math/Vec3"),ie=e("../shapes/Shape");function n(e,t,i,n,r){o.apply(this),this.nx=i||10,this.ny=n||10,this.nz=r||10,this.aabbMin=e||new l(100,100,100),this.aabbMax=t||new l(-100,-100,-100);var a=this.nx*this.ny*this.nz;if(a<=0)throw"GridBroadphase: Each dimension's n must be >0";this.bins=[],this.binLengths=[],this.bins.length=a,this.binLengths.length=a;for(var s=0;s<a;s++)this.bins[s]=[],this.binLengths[s]=0}(n.prototype=new o).constructor=n;var ne=new l;new l,n.prototype.collisionPairs=function(e,t,i){for(var n=e.numObjects(),r=e.bodies,a=this.aabbMax,s=this.aabbMin,m=this.nx,y=this.ny,g=this.nz,b=y*g,x=g,S=1,o=a.x,l=a.y,c=a.z,w=s.x,T=s.y,E=s.z,C=m/(o-w),A=y/(l-T),k=g/(c-E),u=(o-w)/m,h=(l-T)/y,f=(c-E)/g,d=.5*Math.sqrt(u*u+h*h+f*f),p=ie.types,_=p.SPHERE,v=p.PLANE,R=(p.BOX,p.COMPOUND,p.CONVEXPOLYHEDRON,this.bins),O=this.binLengths,M=this.bins.length,I=0;I!==M;I++)O[I]=0;var L=Math.ceil;function z(e,t,i,n,r,a,s){var o=(e-w)*C|0,l=(t-T)*A|0,c=(i-E)*k|0,u=L((n-w)*C),h=L((r-T)*A),f=L((a-E)*k);o<0?o=0:m<=o&&(o=m-1),l<0?l=0:y<=l&&(l=y-1),c<0?c=0:g<=c&&(c=g-1),u<0?u=0:m<=u&&(u=m-1),h<0?h=0:y<=h&&(h=y-1),f<0?f=0:g<=f&&(f=g-1),l*=x,c*=S,u*=b,h*=x,f*=S;for(var d=o*=b;d<=u;d+=b)for(var p=l;p<=h;p+=x)for(var _=c;_<=f;_+=S){var v=d+p+_;R[v][O[v]++]=s}}for(s=Math.min,a=Math.max,I=0;I!==n;I++){var B=(ee=r[I]).shape;switch(B.type){case _:var P=ee.position.x,D=ee.position.y,F=ee.position.z,N=B.radius;z(P-N,D-N,F-N,P+N,D+N,F+N,ee);break;case v:B.worldNormalNeedsUpdate&&B.computeWorldNormal(ee.quaternion);var U=B.worldNormal,V=w+.5*u-ee.position.x,G=T+.5*h-ee.position.y,H=E+.5*f-ee.position.z,q=ne;q.set(V,G,H);for(var j=0,W=0;j!==m;j++,W+=b,q.y=G,q.x+=u)for(var X=0,Y=0;X!==y;X++,Y+=x,q.z=H,q.y+=h)for(var Q=0,K=0;Q!==g;Q++,K+=S,q.z+=f)if(q.dot(U)<d){var Z=W+Y+K;R[Z][O[Z]++]=ee}break;default:ee.aabbNeedsUpdate&&ee.computeAABB(),z(ee.aabb.lowerBound.x,ee.aabb.lowerBound.y,ee.aabb.lowerBound.z,ee.aabb.upperBound.x,ee.aabb.upperBound.y,ee.aabb.upperBound.z,ee)}}for(I=0;I!==M;I++){var J=O[I];if(1<J){var $=R[I];for(j=0;j!==J;j++){var ee=$[j];for(X=0;X!==j;X++){var te=$[X];this.needBroadphaseCollision(ee,te)&&this.intersectionTest(ee,te,t,i)}}}}this.makePairsUnique(t,i)}},{"../math/Vec3":31,"../shapes/Shape":44,"./Broadphase":5}],7:[function(e,t,i){t.exports=a;var n=e("./Broadphase"),r=e("./AABB");function a(){n.apply(this)}((a.prototype=new n).constructor=a).prototype.collisionPairs=function(e,t,i){var n,r,a,s,o=e.bodies,l=o.length;for(n=0;n!==l;n++)for(r=0;r!==n;r++)a=o[n],s=o[r],this.needBroadphaseCollision(a,s)&&this.intersectionTest(a,s,t,i)},new r,a.prototype.aabbQuery=function(e,t,i){i=i||[];for(var n=0;n<e.bodies.length;n++){var r=e.bodies[n];r.aabbNeedsUpdate&&r.computeAABB(),r.aabb.overlaps(t)&&i.push(r)}return i}},{"./AABB":3,"./Broadphase":5}],8:[function(e,t,i){function n(){this.matrix={}}(t.exports=n).prototype.get=function(e,t){if((e=e.id)<(t=t.id)){var i=t;t=e,e=i}return e+"-"+t in this.matrix},n.prototype.set=function(e,t,i){if((e=e.id)<(t=t.id)){var n=t;t=e,e=n}i?this.matrix[e+"-"+t]=!0:delete this.matrix[e+"-"+t]},n.prototype.reset=function(){this.matrix={}},n.prototype.setNumObjects=function(e){}},{}],9:[function(e,t,i){function n(){this.current=[],this.previous=[]}function u(e,t){e.push((4294901760&t)>>16,65535&t)}(t.exports=n).prototype.getKey=function(e,t){if(t<e){var i=t;t=e,e=i}return e<<16|t},n.prototype.set=function(e,t){for(var i=this.getKey(e,t),n=this.current,r=0;i>n[r];)r++;if(i!==n[r]){for(t=n.length-1;r<=t;t--)n[t+1]=n[t];n[r]=i}},n.prototype.tick=function(){var e=this.current;this.current=this.previous,this.previous=e,this.current.length=0},n.prototype.reset=function(){this.previous.length=0,this.current.length=0},n.prototype.getDiff=function(e,t){for(var i=this.current,n=this.previous,r=i.length,a=n.length,s=0,o=0;o<r;o++){for(var l=i[o];l>n[s];)s++;l===n[s]||u(e,l)}for(o=s=0;o<a;o++){for(var c=n[o];c>i[s];)s++;i[s]===c||u(t,c)}},n.prototype.copy=function(e){this.current.length=0,this.previous.length=0,this.current=e.current.slice(),this.previous=e.previous.slice()}},{}],10:[function(e,t,i){t.exports=c;var v=e("../math/Vec3"),n=e("../math/Quaternion"),C=e("../math/Transform"),r=(e("../shapes/ConvexPolyhedron"),e("../shapes/Box"),e("../collision/RaycastResult")),a=e("../shapes/Shape"),p=e("../collision/AABB");function c(e,t){this.from=e?e.clone():new v,this.to=t?t.clone():new v,this._direction=new v,this.precision=1e-4,this.checkCollisionResponse=!0,this.skipBackfaces=!1,this.collisionFilterMask=-1,this.collisionFilterGroup=-1,this.mode=c.ANY,this.result=new r,this.hasHit=!1,this.callback=function(e){}}(c.prototype.constructor=c).CLOSEST=1,c.ANY=2,c.ALL=4;var s=new p,o=[];c.prototype.intersectWorld=function(e,t){return this.mode=t.mode||c.ANY,this.result=t.result||new r,this.skipBackfaces=!!t.skipBackfaces,this.collisionFilterMask=void 0!==t.collisionFilterMask?t.collisionFilterMask:-1,this.collisionFilterGroup=void 0!==t.collisionFilterGroup?t.collisionFilterGroup:-1,t.from&&this.from.copy(t.from),t.to&&this.to.copy(t.to),this.callback=t.callback||function(){},this.hasHit=!1,this.result.reset(),this._updateDirection(),this.getAABB(s),o.length=0,e.broadphase.aabbQuery(e,s,o),this.intersectBodies(o),this.hasHit};var h=new v,f=new v;function k(e,t,i,n){n.vsub(t,d),i.vsub(t,h),e.vsub(t,f);var r,a,s=d.dot(d),o=d.dot(h),l=d.dot(f),c=h.dot(h),u=h.dot(f);return 0<=(r=c*l-o*u)&&0<=(a=s*u-o*l)&&r+a<s*c-o*o}c.pointInTriangle=k;var l=new v,u=new n;c.prototype.intersectBody=function(e,t){t&&(this.result=t,this._updateDirection());var i=this.checkCollisionResponse;if((!i||e.collisionResponse)&&0!=(this.collisionFilterGroup&e.collisionFilterMask)&&0!=(e.collisionFilterGroup&this.collisionFilterMask))for(var n=l,r=u,a=0,s=e.shapes.length;a<s;a++){var o=e.shapes[a];if((!i||o.collisionResponse)&&(e.quaternion.mult(e.shapeOrientations[a],r),e.quaternion.vmult(e.shapeOffsets[a],n),n.vadd(e.position,n),this.intersectShape(o,r,n,e),this.result._shouldStop))break}},c.prototype.intersectBodies=function(e,t){t&&(this.result=t,this._updateDirection());for(var i=0,n=e.length;!this.result._shouldStop&&i<n;i++)this.intersectBody(e[i])},c.prototype._updateDirection=function(){this.to.vsub(this.from,this._direction),this._direction.normalize()},c.prototype.intersectShape=function(e,t,i,n){if(!(function(e,t,i){i.vsub(e,d);var n=d.dot(t);return t.mult(n,S),S.vadd(e,S),i.distanceTo(S)}(this.from,this._direction,i)>e.boundingSphereRadius)){var r=this[e.type];r&&r.call(this,e,t,i,n,e)}},new v,new v;var R=new v,O=new v,M=new v,I=new v;new v,new r,c.prototype.intersectBox=function(e,t,i,n,r){return this.intersectConvex(e.convexPolyhedronRepresentation,t,i,n,r)},c.prototype[a.types.BOX]=c.prototype.intersectBox,c.prototype.intersectPlane=function(e,t,i,n,r){var a=this.from,s=this.to,o=this._direction,l=new v(0,0,1);t.vmult(l,l);var c=new v;a.vsub(i,c);var u=c.dot(l);if(s.vsub(i,c),!(0<u*c.dot(l)||a.distanceTo(s)<u)){var h=l.dot(o);if(!(Math.abs(h)<this.precision)){var f=new v,d=new v,p=new v;a.vsub(i,f);var _=-l.dot(f)/h;o.scale(_,d),a.vadd(d,p),this.reportIntersection(l,p,r,n,-1)}}},c.prototype[a.types.PLANE]=c.prototype.intersectPlane,c.prototype.getAABB=function(e){var t=this.to,i=this.from;e.lowerBound.x=Math.min(t.x,i.x),e.lowerBound.y=Math.min(t.y,i.y),e.lowerBound.z=Math.min(t.z,i.z),e.upperBound.x=Math.max(t.x,i.x),e.upperBound.y=Math.max(t.y,i.y),e.upperBound.z=Math.max(t.z,i.z)};var _={faceList:[0]},m=new v,y=new c,g=[];c.prototype.intersectHeightfield=function(e,t,i,n,r){e.data,e.elementSize;var a=y;a.from.copy(this.from),a.to.copy(this.to),C.pointToLocalFrame(i,t,a.from,a.from),C.pointToLocalFrame(i,t,a.to,a.to),a._updateDirection();var s,o,l,c,u=g;s=o=0,l=c=e.data.length-1;var h=new p;a.getAABB(h),e.getIndexOfPosition(h.lowerBound.x,h.lowerBound.y,u,!0),s=Math.max(s,u[0]),o=Math.max(o,u[1]),e.getIndexOfPosition(h.upperBound.x,h.upperBound.y,u,!0),l=Math.min(l,u[0]+1),c=Math.min(c,u[1]+1);for(var f=s;f<l;f++)for(var d=o;d<c;d++){if(this.result._shouldStop)return;if(e.getAabbAtIndex(f,d,h),h.overlapsRay(a)){if(e.getConvexTrianglePillar(f,d,!1),C.pointToWorldFrame(i,t,e.pillarOffset,m),this.intersectConvex(e.pillarConvex,t,m,n,r,_),this.result._shouldStop)return;e.getConvexTrianglePillar(f,d,!0),C.pointToWorldFrame(i,t,e.pillarOffset,m),this.intersectConvex(e.pillarConvex,t,m,n,r,_)}}},c.prototype[a.types.HEIGHTFIELD]=c.prototype.intersectHeightfield;var b=new v,x=new v;c.prototype.intersectSphere=function(e,t,i,n,r){var a=this.from,s=this.to,o=e.radius,l=Math.pow(s.x-a.x,2)+Math.pow(s.y-a.y,2)+Math.pow(s.z-a.z,2),c=2*((s.x-a.x)*(a.x-i.x)+(s.y-a.y)*(a.y-i.y)+(s.z-a.z)*(a.z-i.z)),u=Math.pow(a.x-i.x,2)+Math.pow(a.y-i.y,2)+Math.pow(a.z-i.z,2)-Math.pow(o,2),h=Math.pow(c,2)-4*l*u,f=b,d=x;if(!(h<0))if(0==h)a.lerp(s,h,f),f.vsub(i,d),d.normalize(),this.reportIntersection(d,f,r,n,-1);else{var p=(-c-Math.sqrt(h))/(2*l),_=(-c+Math.sqrt(h))/(2*l);if(0<=p&&p<=1&&(a.lerp(s,p,f),f.vsub(i,d),d.normalize(),this.reportIntersection(d,f,r,n,-1)),this.result._shouldStop)return;0<=_&&_<=1&&(a.lerp(s,_,f),f.vsub(i,d),d.normalize(),this.reportIntersection(d,f,r,n,-1))}},c.prototype[a.types.SPHERE]=c.prototype.intersectSphere;var L=new v,z=(new v,new v,new v);c.prototype.intersectConvex=function(e,t,i,n,r,a){for(var s=L,o=z,l=a&&a.faceList||null,c=e.faces,u=e.vertices,h=e.faceNormals,f=this._direction,d=this.from,p=this.to,_=d.distanceTo(p),v=l?l.length:c.length,m=this.result,y=0;!m._shouldStop&&y<v;y++){var g=l?l[y]:y,b=c[g],x=h[g],S=t,w=i;o.copy(u[b[0]]),S.vmult(o,o),o.vadd(w,o),o.vsub(d,o),S.vmult(x,s);var T=f.dot(s);if(!(Math.abs(T)<this.precision)){var E=s.dot(o)/T;if(!(E<0)){f.mult(E,R),R.vadd(d,R),O.copy(u[b[0]]),S.vmult(O,O),w.vadd(O,O);for(var C=1;!m._shouldStop&&C<b.length-1;C++){M.copy(u[b[C]]),I.copy(u[b[C+1]]),S.vmult(M,M),S.vmult(I,I),w.vadd(M,M),w.vadd(I,I);var A=R.distanceTo(d);!k(R,O,M,I)&&!k(R,M,O,I)||_<A||this.reportIntersection(s,R,r,n,g)}}}}},c.prototype[a.types.CONVEXPOLYHEDRON]=c.prototype.intersectConvex;var A=new v,B=new v,P=new v,D=new v,F=new v,N=new v,U=(new p,[]),V=new C;c.prototype.intersectTrimesh=function(e,t,i,n,r,a){var s=A,o=U,l=V,c=z,u=B,h=P,f=D,d=N,p=F,_=(a&&a.faceList,e.indices),v=(e.vertices,e.faceNormals,this.from),m=this.to,y=this._direction;l.position.copy(i),l.quaternion.copy(t),C.vectorToLocalFrame(i,t,y,u),C.pointToLocalFrame(i,t,v,h),C.pointToLocalFrame(i,t,m,f),f.x*=e.scale.x,f.y*=e.scale.y,f.z*=e.scale.z,h.x*=e.scale.x,h.y*=e.scale.y,h.z*=e.scale.z,f.vsub(h,u),u.normalize();var g=h.distanceSquared(f);e.tree.rayQuery(this,l,o);for(var b=0,x=o.length;!this.result._shouldStop&&b!==x;b++){var S=o[b];e.getNormal(S,s),e.getVertex(_[3*S],O),O.vsub(h,c);var w=u.dot(s),T=s.dot(c)/w;if(!(T<0)){u.scale(T,R),R.vadd(h,R),e.getVertex(_[3*S+1],M),e.getVertex(_[3*S+2],I);var E=R.distanceSquared(h);!k(R,M,O,I)&&!k(R,O,M,I)||g<E||(C.vectorToWorldFrame(t,s,p),C.pointToWorldFrame(i,t,R,d),this.reportIntersection(p,d,r,n,S))}}o.length=0},c.prototype[a.types.TRIMESH]=c.prototype.intersectTrimesh,c.prototype.reportIntersection=function(e,t,i,n,r){var a=this.from,s=this.to,o=a.distanceTo(t),l=this.result;if(!(this.skipBackfaces&&0<e.dot(this._direction)))switch(l.hitFaceIndex=void 0!==r?r:-1,this.mode){case c.ALL:this.hasHit=!0,l.set(a,s,e,t,i,n,o),l.hasHit=!0,this.callback(l);break;case c.CLOSEST:(o<l.distance||!l.hasHit)&&(this.hasHit=!0,l.hasHit=!0,l.set(a,s,e,t,i,n,o));break;case c.ANY:this.hasHit=!0,l.hasHit=!0,l.set(a,s,e,t,i,n,o),l._shouldStop=!0}};var d=new v,S=new v},{"../collision/AABB":3,"../collision/RaycastResult":11,"../math/Quaternion":29,"../math/Transform":30,"../math/Vec3":31,"../shapes/Box":38,"../shapes/ConvexPolyhedron":39,"../shapes/Shape":44}],11:[function(e,t,i){var n=e("../math/Vec3");function r(){this.rayFromWorld=new n,this.rayToWorld=new n,this.hitNormalWorld=new n,this.hitPointWorld=new n,this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1}(t.exports=r).prototype.reset=function(){this.rayFromWorld.setZero(),this.rayToWorld.setZero(),this.hitNormalWorld.setZero(),this.hitPointWorld.setZero(),this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1},r.prototype.abort=function(){this._shouldStop=!0},r.prototype.set=function(e,t,i,n,r,a,s){this.rayFromWorld.copy(e),this.rayToWorld.copy(t),this.hitNormalWorld.copy(i),this.hitPointWorld.copy(n),this.shape=r,this.body=a,this.distance=s}},{"../math/Vec3":31}],12:[function(e,t,i){e("../shapes/Shape");var n=e("../collision/Broadphase");function u(e){n.apply(this),this.axisList=[],this.world=null,this.axisIndex=0;var i=this.axisList;this._addBodyHandler=function(e){i.push(e.body)},this._removeBodyHandler=function(e){var t=i.indexOf(e.body);-1!==t&&i.splice(t,1)},e&&this.setWorld(e)}((t.exports=u).prototype=new n).setWorld=function(e){for(var t=this.axisList.length=0;t<e.bodies.length;t++)this.axisList.push(e.bodies[t]);e.removeEventListener("addBody",this._addBodyHandler),e.removeEventListener("removeBody",this._removeBodyHandler),e.addEventListener("addBody",this._addBodyHandler),e.addEventListener("removeBody",this._removeBodyHandler),this.world=e,this.dirty=!0},u.insertionSortX=function(e){for(var t=1,i=e.length;t<i;t++){for(var n=e[t],r=t-1;0<=r&&!(e[r].aabb.lowerBound.x<=n.aabb.lowerBound.x);r--)e[r+1]=e[r];e[r+1]=n}return e},u.insertionSortY=function(e){for(var t=1,i=e.length;t<i;t++){for(var n=e[t],r=t-1;0<=r&&!(e[r].aabb.lowerBound.y<=n.aabb.lowerBound.y);r--)e[r+1]=e[r];e[r+1]=n}return e},u.insertionSortZ=function(e){for(var t=1,i=e.length;t<i;t++){for(var n=e[t],r=t-1;0<=r&&!(e[r].aabb.lowerBound.z<=n.aabb.lowerBound.z);r--)e[r+1]=e[r];e[r+1]=n}return e},u.prototype.collisionPairs=function(e,t,i){var n,r,a=this.axisList,s=a.length,o=this.axisIndex;for(this.dirty&&(this.sortList(),this.dirty=!1),n=0;n!==s;n++){var l=a[n];for(r=n+1;r<s;r++){var c=a[r];if(this.needBroadphaseCollision(l,c)){if(!u.checkBounds(l,c,o))break;this.intersectionTest(l,c,t,i)}}}},u.prototype.sortList=function(){for(var e=this.axisList,t=this.axisIndex,i=e.length,n=0;n!==i;n++){var r=e[n];r.aabbNeedsUpdate&&r.computeAABB()}0===t?u.insertionSortX(e):1===t?u.insertionSortY(e):2===t&&u.insertionSortZ(e)},u.checkBounds=function(e,t,i){var n,r;0===i?(n=e.position.x,r=t.position.x):1===i?(n=e.position.y,r=t.position.y):2===i&&(n=e.position.z,r=t.position.z);var a=e.boundingRadius,s=t.boundingRadius;return r-s<n+a},u.prototype.autoDetectAxis=function(){for(var e=0,t=0,i=0,n=0,r=0,a=0,s=this.axisList,o=s.length,l=1/o,c=0;c!==o;c++){var u=s[c],h=u.position.x;e+=h,t+=h*h;var f=u.position.y;i+=f,n+=f*f;var d=u.position.z;r+=d,a+=d*d}var p=t-e*e*l,_=n-i*i*l,v=a-r*r*l;this.axisIndex=_<p?v<p?0:2:v<_?1:2},u.prototype.aabbQuery=function(e,t,i){i=i||[],this.dirty&&(this.sortList(),this.dirty=!1);var n=this.axisIndex,r="x";1===n&&(r="y"),2===n&&(r="z");for(var a=this.axisList,s=(t.lowerBound[r],t.upperBound[r],0);s<a.length;s++){var o=a[s];o.aabbNeedsUpdate&&o.computeAABB(),o.aabb.overlaps(t)&&i.push(o)}return i}},{"../collision/Broadphase":5,"../shapes/Shape":44}],13:[function(e,t,i){t.exports=n,e("./Constraint");var l=e("./PointToPointConstraint"),c=e("../equations/ConeEquation"),u=e("../equations/RotationalEquation"),h=(e("../equations/ContactEquation"),e("../math/Vec3"));function n(e,t,i){var n=void 0!==(i=i||{}).maxForce?i.maxForce:1e6,r=i.pivotA?i.pivotA.clone():new h,a=i.pivotB?i.pivotB.clone():new h;this.axisA=i.axisA?i.axisA.clone():new h,this.axisB=i.axisB?i.axisB.clone():new h,l.call(this,e,r,t,a,n),this.collideConnected=!!i.collideConnected,this.angle=void 0!==i.angle?i.angle:0;var s=this.coneEquation=new c(e,t,i),o=this.twistEquation=new u(e,t,i);this.twistAngle=void 0!==i.twistAngle?i.twistAngle:0,s.maxForce=0,s.minForce=-n,o.maxForce=0,o.minForce=-n,this.equations.push(s,o)}n.prototype=new l,n.constructor=n,new h,new h,n.prototype.update=function(){var e=this.bodyA,t=this.bodyB,i=this.coneEquation,n=this.twistEquation;l.prototype.update.call(this),e.vectorToWorldFrame(this.axisA,i.axisA),t.vectorToWorldFrame(this.axisB,i.axisB),this.axisA.tangents(n.axisA,n.axisA),e.vectorToWorldFrame(n.axisA,n.axisA),this.axisB.tangents(n.axisB,n.axisB),t.vectorToWorldFrame(n.axisB,n.axisB),i.angle=this.angle,n.maxAngle=this.twistAngle}},{"../equations/ConeEquation":19,"../equations/ContactEquation":20,"../equations/RotationalEquation":23,"../math/Vec3":31,"./Constraint":14,"./PointToPointConstraint":18}],14:[function(e,t,i){t.exports=r;var n=e("../utils/Utils");function r(e,t,i){i=n.defaults(i,{collideConnected:!0,wakeUpBodies:!0}),this.equations=[],this.bodyA=e,this.bodyB=t,this.id=r.idCounter++,this.collideConnected=i.collideConnected,i.wakeUpBodies&&(e&&e.wakeUp(),t&&t.wakeUp())}r.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")},r.prototype.enable=function(){for(var e=this.equations,t=0;t<e.length;t++)e[t].enabled=!0},r.prototype.disable=function(){for(var e=this.equations,t=0;t<e.length;t++)e[t].enabled=!1},r.idCounter=0},{"../utils/Utils":54}],15:[function(e,t,i){t.exports=n;var a=e("./Constraint"),s=e("../equations/ContactEquation");function n(e,t,i,n){a.call(this,e,t),void 0===i&&(i=e.position.distanceTo(t.position)),void 0===n&&(n=1e6),this.distance=i;var r=this.distanceEquation=new s(e,t);this.equations.push(r),r.minForce=-n,r.maxForce=n}(n.prototype=new a).update=function(){var e=this.bodyA,t=this.bodyB,i=this.distanceEquation,n=.5*this.distance,r=i.ni;t.position.vsub(e.position,r),r.normalize(),r.mult(n,i.ri),r.mult(-n,i.rj)}},{"../equations/ContactEquation":20,"./Constraint":14}],16:[function(e,t,i){t.exports=n,e("./Constraint");var c=e("./PointToPointConstraint"),u=e("../equations/RotationalEquation"),h=e("../equations/RotationalMotorEquation"),f=(e("../equations/ContactEquation"),e("../math/Vec3"));function n(e,t,i){var n=void 0!==(i=i||{}).maxForce?i.maxForce:1e6,r=i.pivotA?i.pivotA.clone():new f,a=i.pivotB?i.pivotB.clone():new f;c.call(this,e,r,t,a,n),(this.axisA=i.axisA?i.axisA.clone():new f(1,0,0)).normalize(),(this.axisB=i.axisB?i.axisB.clone():new f(1,0,0)).normalize();var s=this.rotationalEquation1=new u(e,t,i),o=this.rotationalEquation2=new u(e,t,i),l=this.motorEquation=new h(e,t,n);l.enabled=!1,this.equations.push(s,o,l)}n.prototype=new c,(n.constructor=n).prototype.enableMotor=function(){this.motorEquation.enabled=!0},n.prototype.disableMotor=function(){this.motorEquation.enabled=!1},n.prototype.setMotorSpeed=function(e){this.motorEquation.targetVelocity=e},n.prototype.setMotorMaxForce=function(e){this.motorEquation.maxForce=e,this.motorEquation.minForce=-e};var d=new f,p=new f;n.prototype.update=function(){var e=this.bodyA,t=this.bodyB,i=this.motorEquation,n=this.rotationalEquation1,r=this.rotationalEquation2,a=d,s=p,o=this.axisA,l=this.axisB;c.prototype.update.call(this),e.quaternion.vmult(o,a),t.quaternion.vmult(l,s),a.tangents(n.axisA,r.axisA),n.axisB.copy(s),r.axisB.copy(s),this.motorEquation.enabled&&(e.quaternion.vmult(this.axisA,i.axisA),t.quaternion.vmult(this.axisB,i.axisB))}},{"../equations/ContactEquation":20,"../equations/RotationalEquation":23,"../equations/RotationalMotorEquation":24,"../math/Vec3":31,"./Constraint":14,"./PointToPointConstraint":18}],17:[function(e,t,i){t.exports=n,e("./Constraint");var u=e("./PointToPointConstraint"),h=e("../equations/RotationalEquation"),f=(e("../equations/RotationalMotorEquation"),e("../equations/ContactEquation"),e("../math/Vec3"));function n(e,t,i){var n=void 0!==(i=i||{}).maxForce?i.maxForce:1e6,r=new f,a=new f,s=new f;e.position.vadd(t.position,s),s.scale(.5,s),t.pointToLocalFrame(s,a),e.pointToLocalFrame(s,r),u.call(this,e,r,t,a,n),this.xA=e.vectorToLocalFrame(f.UNIT_X),this.xB=t.vectorToLocalFrame(f.UNIT_X),this.yA=e.vectorToLocalFrame(f.UNIT_Y),this.yB=t.vectorToLocalFrame(f.UNIT_Y),this.zA=e.vectorToLocalFrame(f.UNIT_Z),this.zB=t.vectorToLocalFrame(f.UNIT_Z);var o=this.rotationalEquation1=new h(e,t,i),l=this.rotationalEquation2=new h(e,t,i),c=this.rotationalEquation3=new h(e,t,i);this.equations.push(o,l,c)}n.prototype=new u,n.constructor=n,new f,new f,n.prototype.update=function(){var e=this.bodyA,t=this.bodyB,i=(this.motorEquation,this.rotationalEquation1),n=this.rotationalEquation2,r=this.rotationalEquation3;u.prototype.update.call(this),e.vectorToWorldFrame(this.xA,i.axisA),t.vectorToWorldFrame(this.yB,i.axisB),e.vectorToWorldFrame(this.yA,n.axisA),t.vectorToWorldFrame(this.zB,n.axisB),e.vectorToWorldFrame(this.zA,r.axisA),t.vectorToWorldFrame(this.xB,r.axisB)}},{"../equations/ContactEquation":20,"../equations/RotationalEquation":23,"../equations/RotationalMotorEquation":24,"../math/Vec3":31,"./Constraint":14,"./PointToPointConstraint":18}],18:[function(e,t,i){t.exports=n;var l=e("./Constraint"),c=e("../equations/ContactEquation"),u=e("../math/Vec3");function n(e,t,i,n,r){l.call(this,e,i),r=void 0!==r?r:1e6,this.pivotA=t?t.clone():new u,this.pivotB=n?n.clone():new u;var a=this.equationX=new c(e,i),s=this.equationY=new c(e,i),o=this.equationZ=new c(e,i);this.equations.push(a,s,o),a.minForce=s.minForce=o.minForce=-r,a.maxForce=s.maxForce=o.maxForce=r,a.ni.set(1,0,0),s.ni.set(0,1,0),o.ni.set(0,0,1)}(n.prototype=new l).update=function(){var e=this.bodyA,t=this.bodyB,i=this.equationX,n=this.equationY,r=this.equationZ;e.quaternion.vmult(this.pivotA,i.ri),t.quaternion.vmult(this.pivotB,i.rj),n.ri.copy(i.ri),n.rj.copy(i.rj),r.ri.copy(i.ri),r.rj.copy(i.rj)}},{"../equations/ContactEquation":20,"../math/Vec3":31,"./Constraint":14}],19:[function(e,t,i){t.exports=n;var r=e("../math/Vec3"),a=(e("../math/Mat3"),e("./Equation"));function n(e,t,i){var n=void 0!==(i=i||{}).maxForce?i.maxForce:1e6;a.call(this,e,t,-n,n),this.axisA=i.axisA?i.axisA.clone():new r(1,0,0),this.axisB=i.axisB?i.axisB.clone():new r(0,1,0),this.angle=void 0!==i.angle?i.angle:0}(n.prototype=new a).constructor=n;var c=new r,u=new r;n.prototype.computeB=function(e){var t=this.a,i=this.b,n=this.axisA,r=this.axisB,a=c,s=u,o=this.jacobianElementA,l=this.jacobianElementB;return n.cross(r,a),r.cross(n,s),o.rotational.copy(s),l.rotational.copy(a),-(Math.cos(this.angle)-n.dot(r))*t-this.computeGW()*i-e*this.computeGiMf()}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],20:[function(e,t,i){t.exports=a;var n=e("./Equation"),r=e("../math/Vec3");function a(e,t,i){i=void 0!==i?i:1e6,n.call(this,e,t,0,i),this.si=null,this.sj=null,this.restitution=0,this.ri=new r,this.rj=new r,this.ni=new r}e("../math/Mat3"),(a.prototype=new n).constructor=a;var g=new r,b=new r,x=new r;a.prototype.computeB=function(e){var t=this.a,i=this.b,n=this.bi,r=this.bj,a=this.ri,s=this.rj,o=g,l=b,c=n.velocity,u=n.angularVelocity,h=(n.force,n.torque,r.velocity),f=r.angularVelocity,d=(r.force,r.torque,x),p=this.jacobianElementA,_=this.jacobianElementB,v=this.ni;a.cross(v,o),s.cross(v,l),v.negate(p.spatial),o.negate(p.rotational),_.spatial.copy(v),_.rotational.copy(l),d.copy(r.position),d.vadd(s,d),d.vsub(n.position,d),d.vsub(a,d);var m=v.dot(d),y=this.restitution+1;return-m*t-(y*h.dot(v)-y*c.dot(v)+f.dot(l)-u.dot(o))*i-e*this.computeGiMf()};var s=new r,o=new r,l=new r,c=new r,u=new r;a.prototype.getImpactVelocityAlongNormal=function(){var e=s,t=o,i=l,n=c,r=u;return this.bi.position.vadd(this.ri,i),this.bj.position.vadd(this.rj,n),this.bi.getVelocityAtWorldPoint(i,e),this.bj.getVelocityAtWorldPoint(n,t),e.vsub(t,r),this.ni.dot(r)}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],21:[function(e,t,i){t.exports=a;var r=e("../math/JacobianElement"),n=e("../math/Vec3");function a(e,t,i,n){this.id=a.id++,this.minForce=void 0===i?-1e6:i,this.maxForce=void 0===n?1e6:n,this.bi=e,this.bj=t,this.a=0,this.b=0,this.eps=0,this.jacobianElementA=new r,this.jacobianElementB=new r,this.enabled=!0,this.multiplier=0,this.setSpookParams(1e7,4,1/60)}(a.prototype.constructor=a).id=0,a.prototype.setSpookParams=function(e,t,i){var n=t,r=e,a=i;this.a=4/(a*(1+4*n)),this.b=4*n/(1+4*n),this.eps=4/(a*a*r*(1+4*n))},a.prototype.computeB=function(e,t,i){var n=this.computeGW();return-this.computeGq()*e-n*t-this.computeGiMf()*i},a.prototype.computeGq=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,n=this.bj,r=i.position,a=n.position;return e.spatial.dot(r)+t.spatial.dot(a)},new n,a.prototype.computeGW=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,n=this.bj,r=i.velocity,a=n.velocity,s=i.angularVelocity,o=n.angularVelocity;return e.multiplyVectors(r,s)+t.multiplyVectors(a,o)},a.prototype.computeGWlambda=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,n=this.bj,r=i.vlambda,a=n.vlambda,s=i.wlambda,o=n.wlambda;return e.multiplyVectors(r,s)+t.multiplyVectors(a,o)};var u=new n,h=new n,f=new n,d=new n;a.prototype.computeGiMf=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,n=this.bj,r=i.force,a=i.torque,s=n.force,o=n.torque,l=i.invMassSolve,c=n.invMassSolve;return r.scale(l,u),s.scale(c,h),i.invInertiaWorldSolve.vmult(a,f),n.invInertiaWorldSolve.vmult(o,d),e.multiplyVectors(u,f)+t.multiplyVectors(h,d)};var c=new n;a.prototype.computeGiMGt=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,n=this.bj,r=i.invMassSolve,a=n.invMassSolve,s=i.invInertiaWorldSolve,o=n.invInertiaWorldSolve,l=r+a;return s.vmult(e.rotational,c),l+=c.dot(e.rotational),o.vmult(t.rotational,c),l+=c.dot(t.rotational)};var s=new n;new n,new n,new n,new n,new n,a.prototype.addToWlambda=function(e){var t=this.jacobianElementA,i=this.jacobianElementB,n=this.bi,r=this.bj,a=s;n.vlambda.addScaledVector(n.invMassSolve*e,t.spatial,n.vlambda),r.vlambda.addScaledVector(r.invMassSolve*e,i.spatial,r.vlambda),n.invInertiaWorldSolve.vmult(t.rotational,a),n.wlambda.addScaledVector(e,a,n.wlambda),r.invInertiaWorldSolve.vmult(i.rotational,a),r.wlambda.addScaledVector(e,a,r.wlambda)},a.prototype.computeC=function(){return this.computeGiMGt()+this.eps}},{"../math/JacobianElement":27,"../math/Vec3":31}],22:[function(e,t,i){t.exports=a;var n=e("./Equation"),r=e("../math/Vec3");function a(e,t,i){n.call(this,e,t,-i,i),this.ri=new r,this.rj=new r,this.t=new r}e("../math/Mat3"),(a.prototype=new n).constructor=a;var c=new r,u=new r;a.prototype.computeB=function(e){this.a;var t=this.b,i=(this.bi,this.bj,this.ri),n=this.rj,r=c,a=u,s=this.t;i.cross(s,r),n.cross(s,a);var o=this.jacobianElementA,l=this.jacobianElementB;return s.negate(o.spatial),r.negate(o.rotational),l.spatial.copy(s),l.rotational.copy(a),-this.computeGW()*t-e*this.computeGiMf()}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],23:[function(e,t,i){t.exports=n;var r=e("../math/Vec3"),a=(e("../math/Mat3"),e("./Equation"));function n(e,t,i){var n=void 0!==(i=i||{}).maxForce?i.maxForce:1e6;a.call(this,e,t,-n,n),this.axisA=i.axisA?i.axisA.clone():new r(1,0,0),this.axisB=i.axisB?i.axisB.clone():new r(0,1,0),this.maxAngle=Math.PI/2}(n.prototype=new a).constructor=n;var c=new r,u=new r;n.prototype.computeB=function(e){var t=this.a,i=this.b,n=this.axisA,r=this.axisB,a=c,s=u,o=this.jacobianElementA,l=this.jacobianElementB;return n.cross(r,a),r.cross(n,s),o.rotational.copy(s),l.rotational.copy(a),-(Math.cos(this.maxAngle)-n.dot(r))*t-this.computeGW()*i-e*this.computeGiMf()}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],24:[function(e,t,i){t.exports=a;var n=e("../math/Vec3"),r=(e("../math/Mat3"),e("./Equation"));function a(e,t,i){i=void 0!==i?i:1e6,r.call(this,e,t,-i,i),this.axisA=new n,this.axisB=new n,this.targetVelocity=0}((a.prototype=new r).constructor=a).prototype.computeB=function(e){this.a;var t=this.b,i=(this.bi,this.bj,this.axisA),n=this.axisB,r=this.jacobianElementA,a=this.jacobianElementB;return r.rotational.copy(i),n.negate(a.rotational),-(this.computeGW()-this.targetVelocity)*t-e*this.computeGiMf()}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],25:[function(e,t,i){var r=e("../utils/Utils");(t.exports=function e(t,i,n){n=r.defaults(n,{friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3}),this.id=e.idCounter++,this.materials=[t,i],this.friction=n.friction,this.restitution=n.restitution,this.contactEquationStiffness=n.contactEquationStiffness,this.contactEquationRelaxation=n.contactEquationRelaxation,this.frictionEquationStiffness=n.frictionEquationStiffness,this.frictionEquationRelaxation=n.frictionEquationRelaxation}).idCounter=0},{"../utils/Utils":54}],26:[function(e,t,i){(t.exports=function e(t){var i="";"string"==typeof(t=t||{})?(i=t,t={}):"object"==typeof t&&(i=""),this.name=i,this.id=e.idCounter++,this.friction=void 0!==t.friction?t.friction:-1,this.restitution=void 0!==t.restitution?t.restitution:-1}).idCounter=0},{}],27:[function(e,t,i){t.exports=r;var n=e("./Vec3");function r(){this.spatial=new n,this.rotational=new n}r.prototype.multiplyElement=function(e){return e.spatial.dot(this.spatial)+e.rotational.dot(this.rotational)},r.prototype.multiplyVectors=function(e,t){return e.dot(this.spatial)+t.dot(this.rotational)}},{"./Vec3":31}],28:[function(e,t,i){t.exports=c;var u=e("./Vec3");function c(e){this.elements=e||[0,0,0,0,0,0,0,0,0]}c.prototype.identity=function(){var e=this.elements;e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1},c.prototype.setZero=function(){var e=this.elements;e[0]=0,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=0,e[6]=0,e[7]=0,e[8]=0},c.prototype.setTrace=function(e){var t=this.elements;t[0]=e.x,t[4]=e.y,t[8]=e.z},c.prototype.getTrace=function(e){e=e||new u;var t=this.elements;e.x=t[0],e.y=t[4],e.z=t[8]},c.prototype.vmult=function(e,t){t=t||new u;var i=this.elements,n=e.x,r=e.y,a=e.z;return t.x=i[0]*n+i[1]*r+i[2]*a,t.y=i[3]*n+i[4]*r+i[5]*a,t.z=i[6]*n+i[7]*r+i[8]*a,t},c.prototype.smult=function(e){for(var t=0;t<this.elements.length;t++)this.elements[t]*=e},c.prototype.mmult=function(e,t){for(var i=t||new c,n=0;n<3;n++)for(var r=0;r<3;r++){for(var a=0,s=0;s<3;s++)a+=e.elements[n+3*s]*this.elements[s+3*r];i.elements[n+3*r]=a}return i},c.prototype.scale=function(e,t){t=t||new c;for(var i=this.elements,n=t.elements,r=0;3!==r;r++)n[3*r+0]=e.x*i[3*r+0],n[3*r+1]=e.y*i[3*r+1],n[3*r+2]=e.z*i[3*r+2];return t},c.prototype.solve=function(e,t){t=t||new u;for(var i,n=[],r=0;r<12;r++)n.push(0);for(r=0;r<3;r++)for(i=0;i<3;i++)n[r+4*i]=this.elements[r+3*i];n[3]=e.x,n[7]=e.y,n[11]=e.z;var a,s,o=3,l=o;do{if(0===n[(r=l-o)+4*r])for(i=r+1;i<l;i++)if(0!==n[r+4*i]){for(a=4;n[(s=4-a)+4*r]+=n[s+4*i],--a;);break}if(0!==n[r+4*r])for(i=r+1;i<l;i++){var c=n[r+4*i]/n[r+4*r];for(a=4;n[(s=4-a)+4*i]=s<=r?0:n[s+4*i]-n[s+4*r]*c,--a;);}}while(--o);if(t.z=n[11]/n[10],t.y=(n[7]-n[6]*t.z)/n[5],t.x=(n[3]-n[2]*t.z-n[1]*t.y)/n[0],isNaN(t.x)||isNaN(t.y)||isNaN(t.z)||t.x===1/0||t.y===1/0||t.z===1/0)throw"Could not solve equation! Got x=["+t.toString()+"], b=["+e.toString()+"], A=["+this.toString()+"]";return t},c.prototype.e=function(e,t,i){if(void 0===i)return this.elements[t+3*e];this.elements[t+3*e]=i},c.prototype.copy=function(e){for(var t=0;t<e.elements.length;t++)this.elements[t]=e.elements[t];return this},c.prototype.toString=function(){for(var e="",t=0;t<9;t++)e+=this.elements[t]+",";return e},c.prototype.reverse=function(e){e=e||new c;for(var t,i=[],n=0;n<18;n++)i.push(0);for(n=0;n<3;n++)for(t=0;t<3;t++)i[n+6*t]=this.elements[n+3*t];i[3]=1,i[9]=0,i[15]=0,i[4]=0,i[10]=1,i[16]=0,i[5]=0,i[11]=0,i[17]=1;var r,a,s=3,o=s;do{if(0===i[(n=o-s)+6*n])for(t=n+1;t<o;t++)if(0!==i[n+6*t]){for(r=6;i[(a=6-r)+6*n]+=i[a+6*t],--r;);break}if(0!==i[n+6*n])for(t=n+1;t<o;t++){var l=i[n+6*t]/i[n+6*n];for(r=6;i[(a=6-r)+6*t]=a<=n?0:i[a+6*t]-i[a+6*n]*l,--r;);}}while(--s);n=2;do{t=n-1;do{for(l=i[n+6*t]/i[n+6*n],r=6;i[(a=6-r)+6*t]=i[a+6*t]-i[a+6*n]*l,--r;);}while(t--)}while(--n);n=2;do{for(l=1/i[n+6*n],r=6;i[(a=6-r)+6*n]=i[a+6*n]*l,--r;);}while(n--);n=2;do{t=2;do{if(a=i[3+t+6*n],isNaN(a)||a===1/0)throw"Could not reverse! A=["+this.toString()+"]";e.e(n,t,a)}while(t--)}while(n--);return e},c.prototype.setRotationFromQuaternion=function(e){var t=e.x,i=e.y,n=e.z,r=e.w,a=t+t,s=i+i,o=n+n,l=t*a,c=t*s,u=t*o,h=i*s,f=i*o,d=n*o,p=r*a,_=r*s,v=r*o,m=this.elements;return m[0]=1-(h+d),m[1]=c-v,m[2]=u+_,m[3]=c+v,m[4]=1-(l+d),m[5]=f-p,m[6]=u-_,m[7]=f+p,m[8]=1-(l+h),this},c.prototype.transpose=function(e){for(var t=(e=e||new c).elements,i=this.elements,n=0;3!==n;n++)for(var r=0;3!==r;r++)t[3*n+r]=i[3*r+n];return e}},{"./Vec3":31}],29:[function(e,t,i){t.exports=v;var d=e("./Vec3");function v(e,t,i,n){this.x=void 0!==e?e:0,this.y=void 0!==t?t:0,this.z=void 0!==i?i:0,this.w=void 0!==n?n:1}v.prototype.set=function(e,t,i,n){return this.x=e,this.y=t,this.z=i,this.w=n,this},v.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},v.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]},v.prototype.setFromAxisAngle=function(e,t){var i=Math.sin(.5*t);return this.x=e.x*i,this.y=e.y*i,this.z=e.z*i,this.w=Math.cos(.5*t),this},v.prototype.toAxisAngle=function(e){e=e||new d,this.normalize();var t=2*Math.acos(this.w),i=Math.sqrt(1-this.w*this.w);return i<.001?(e.x=this.x,e.y=this.y,e.z=this.z):(e.x=this.x/i,e.y=this.y/i,e.z=this.z/i),[e,t]};var a=new d,s=new d;v.prototype.setFromVectors=function(e,t){if(e.isAntiparallelTo(t)){var i=a,n=s;e.tangents(i,n),this.setFromAxisAngle(i,Math.PI)}else{var r=e.cross(t);this.x=r.x,this.y=r.y,this.z=r.z,this.w=Math.sqrt(Math.pow(e.norm(),2)*Math.pow(t.norm(),2))+e.dot(t),this.normalize()}return this},new d,new d,new d,v.prototype.mult=function(e,t){t=t||new v;var i=this.x,n=this.y,r=this.z,a=this.w,s=e.x,o=e.y,l=e.z,c=e.w;return t.x=i*c+a*s+n*l-r*o,t.y=n*c+a*o+r*s-i*l,t.z=r*c+a*l+i*o-n*s,t.w=a*c-i*s-n*o-r*l,t},v.prototype.inverse=function(e){var t=this.x,i=this.y,n=this.z,r=this.w;e=e||new v,this.conjugate(e);var a=1/(t*t+i*i+n*n+r*r);return e.x*=a,e.y*=a,e.z*=a,e.w*=a,e},v.prototype.conjugate=function(e){return(e=e||new v).x=-this.x,e.y=-this.y,e.z=-this.z,e.w=this.w,e},v.prototype.normalize=function(){var e=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);return 0===e?(this.x=0,this.y=0,this.z=0,this.w=0):(e=1/e,this.x*=e,this.y*=e,this.z*=e,this.w*=e),this},v.prototype.normalizeFast=function(){var e=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;return 0==e?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=e,this.y*=e,this.z*=e,this.w*=e),this},v.prototype.vmult=function(e,t){t=t||new d;var i=e.x,n=e.y,r=e.z,a=this.x,s=this.y,o=this.z,l=this.w,c=l*i+s*r-o*n,u=l*n+o*i-a*r,h=l*r+a*n-s*i,f=-a*i-s*n-o*r;return t.x=c*l+f*-a+u*-o-h*-s,t.y=u*l+f*-s+h*-a-c*-o,t.z=h*l+f*-o+c*-s-u*-a,t},v.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},v.prototype.toEuler=function(e,t){var i,n,r;t=t||"YZX";var a=this.x,s=this.y,o=this.z,l=this.w;switch(t){case"YZX":var c=a*s+o*l;if(.499<c&&(i=2*Math.atan2(a,l),n=Math.PI/2,r=0),c<-.499&&(i=-2*Math.atan2(a,l),n=-Math.PI/2,r=0),isNaN(i)){var u=a*a,h=s*s,f=o*o;i=Math.atan2(2*s*l-2*a*o,1-2*h-2*f),n=Math.asin(2*c),r=Math.atan2(2*a*l-2*s*o,1-2*u-2*f)}break;default:throw new Error("Euler order "+t+" not supported yet.")}e.y=i,e.z=n,e.x=r},v.prototype.setFromEuler=function(e,t,i,n){n=n||"XYZ";var r=Math.cos(e/2),a=Math.cos(t/2),s=Math.cos(i/2),o=Math.sin(e/2),l=Math.sin(t/2),c=Math.sin(i/2);return"XYZ"===n?(this.x=o*a*s+r*l*c,this.y=r*l*s-o*a*c,this.z=r*a*c+o*l*s,this.w=r*a*s-o*l*c):"YXZ"===n?(this.x=o*a*s+r*l*c,this.y=r*l*s-o*a*c,this.z=r*a*c-o*l*s,this.w=r*a*s+o*l*c):"ZXY"===n?(this.x=o*a*s-r*l*c,this.y=r*l*s+o*a*c,this.z=r*a*c+o*l*s,this.w=r*a*s-o*l*c):"ZYX"===n?(this.x=o*a*s-r*l*c,this.y=r*l*s+o*a*c,this.z=r*a*c-o*l*s,this.w=r*a*s+o*l*c):"YZX"===n?(this.x=o*a*s+r*l*c,this.y=r*l*s+o*a*c,this.z=r*a*c-o*l*s,this.w=r*a*s-o*l*c):"XZY"===n&&(this.x=o*a*s-r*l*c,this.y=r*l*s-o*a*c,this.z=r*a*c+o*l*s,this.w=r*a*s+o*l*c),this},v.prototype.clone=function(){return new v(this.x,this.y,this.z,this.w)},v.prototype.slerp=function(e,t,i){i=i||new v;var n,r,a,s,o,l=this.x,c=this.y,u=this.z,h=this.w,f=e.x,d=e.y,p=e.z,_=e.w;return(r=l*f+c*d+u*p+h*_)<0&&(r=-r,f=-f,d=-d,p=-p,_=-_),o=1e-6<1-r?(n=Math.acos(r),a=Math.sin(n),s=Math.sin((1-t)*n)/a,Math.sin(t*n)/a):(s=1-t,t),i.x=s*l+o*f,i.y=s*c+o*d,i.z=s*u+o*p,i.w=s*h+o*_,i},v.prototype.integrate=function(e,t,i,n){n=n||new v;var r=e.x*i.x,a=e.y*i.y,s=e.z*i.z,o=this.x,l=this.y,c=this.z,u=this.w,h=.5*t;return n.x+=h*(r*u+a*c-s*l),n.y+=h*(a*u+s*o-r*c),n.z+=h*(s*u+r*l-a*o),n.w+=h*(-r*o-a*l-s*c),n}},{"./Vec3":31}],30:[function(e,t,i){var r=e("./Vec3"),n=e("./Quaternion");function a(e){e=e||{},this.position=new r,e.position&&this.position.copy(e.position),this.quaternion=new n,e.quaternion&&this.quaternion.copy(e.quaternion)}t.exports=a;var s=new n;a.pointToLocalFrame=function(e,t,i,n){return n=n||new r,i.vsub(e,n),t.conjugate(s),s.vmult(n,n),n},a.prototype.pointToLocal=function(e,t){return a.pointToLocalFrame(this.position,this.quaternion,e,t)},a.pointToWorldFrame=function(e,t,i,n){return n=n||new r,t.vmult(i,n),n.vadd(e,n),n},a.prototype.pointToWorld=function(e,t){return a.pointToWorldFrame(this.position,this.quaternion,e,t)},a.prototype.vectorToWorldFrame=function(e,t){return t=t||new r,this.quaternion.vmult(e,t),t},a.vectorToWorldFrame=function(e,t,i){return e.vmult(t,i),i},a.vectorToLocalFrame=function(e,t,i,n){return n=n||new r,t.w*=-1,t.vmult(i,n),t.w*=-1,n}},{"./Quaternion":29,"./Vec3":31}],31:[function(e,t,i){t.exports=l;var n=e("./Mat3");function l(e,t,i){this.x=e||0,this.y=t||0,this.z=i||0}l.ZERO=new l(0,0,0),l.UNIT_X=new l(1,0,0),l.UNIT_Y=new l(0,1,0),l.UNIT_Z=new l(0,0,1),l.prototype.cross=function(e,t){var i=e.x,n=e.y,r=e.z,a=this.x,s=this.y,o=this.z;return(t=t||new l).x=s*r-o*n,t.y=o*i-a*r,t.z=a*n-s*i,t},l.prototype.set=function(e,t,i){return this.x=e,this.y=t,this.z=i,this},l.prototype.setZero=function(){this.x=this.y=this.z=0},l.prototype.vadd=function(e,t){if(!t)return new l(this.x+e.x,this.y+e.y,this.z+e.z);t.x=e.x+this.x,t.y=e.y+this.y,t.z=e.z+this.z},l.prototype.vsub=function(e,t){if(!t)return new l(this.x-e.x,this.y-e.y,this.z-e.z);t.x=this.x-e.x,t.y=this.y-e.y,t.z=this.z-e.z},l.prototype.crossmat=function(){return new n([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},l.prototype.normalize=function(){var e=this.x,t=this.y,i=this.z,n=Math.sqrt(e*e+t*t+i*i);if(0<n){var r=1/n;this.x*=r,this.y*=r,this.z*=r}else this.x=0,this.y=0,this.z=0;return n},l.prototype.unit=function(e){e=e||new l;var t=this.x,i=this.y,n=this.z,r=Math.sqrt(t*t+i*i+n*n);return 0<r?(r=1/r,e.x=t*r,e.y=i*r,e.z=n*r):(e.x=1,e.y=0,e.z=0),e},l.prototype.length=l.prototype.norm=function(){var e=this.x,t=this.y,i=this.z;return Math.sqrt(e*e+t*t+i*i)},l.prototype.lengthSquared=l.prototype.norm2=function(){return this.dot(this)},l.prototype.distanceTo=function(e){var t=this.x,i=this.y,n=this.z,r=e.x,a=e.y,s=e.z;return Math.sqrt((r-t)*(r-t)+(a-i)*(a-i)+(s-n)*(s-n))},l.prototype.distanceSquared=function(e){var t=this.x,i=this.y,n=this.z,r=e.x,a=e.y,s=e.z;return(r-t)*(r-t)+(a-i)*(a-i)+(s-n)*(s-n)},l.prototype.mult=function(e,t){t=t||new l;var i=this.x,n=this.y,r=this.z;return t.x=e*i,t.y=e*n,t.z=e*r,t},l.prototype.vmul=function(e,t){return(t=t||new l).x=e.x*this.x,t.y=e.y*this.y,t.z=e.z*this.z,t},l.prototype.scale=l.prototype.mult,l.prototype.addScaledVector=function(e,t,i){return(i=i||new l).x=this.x+e*t.x,i.y=this.y+e*t.y,i.z=this.z+e*t.z,i},l.prototype.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},l.prototype.isZero=function(){return 0===this.x&&0===this.y&&0===this.z},l.prototype.negate=function(e){return(e=e||new l).x=-this.x,e.y=-this.y,e.z=-this.z,e};var s=new l,o=new l;l.prototype.tangents=function(e,t){var i=this.norm();if(0<i){var n=s,r=1/i;n.set(this.x*r,this.y*r,this.z*r);var a=o;Math.abs(n.x)<.9?a.set(1,0,0):a.set(0,1,0),n.cross(a,e),n.cross(e,t)}else e.set(1,0,0),t.set(0,1,0)},l.prototype.toString=function(){return this.x+","+this.y+","+this.z},l.prototype.toArray=function(){return[this.x,this.y,this.z]},l.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},l.prototype.lerp=function(e,t,i){var n=this.x,r=this.y,a=this.z;i.x=n+(e.x-n)*t,i.y=r+(e.y-r)*t,i.z=a+(e.z-a)*t},l.prototype.almostEquals=function(e,t){return void 0===t&&(t=1e-6),!(Math.abs(this.x-e.x)>t||Math.abs(this.y-e.y)>t||Math.abs(this.z-e.z)>t)},l.prototype.almostZero=function(e){return void 0===e&&(e=1e-6),!(Math.abs(this.x)>e||Math.abs(this.y)>e||Math.abs(this.z)>e)};var r=new l;l.prototype.isAntiparallelTo=function(e,t){return this.negate(r),r.almostEquals(e,t)},l.prototype.clone=function(){return new l(this.x,this.y,this.z)}},{"./Mat3":28}],32:[function(e,t,i){t.exports=y;var n=e("../utils/EventTarget"),a=(e("../shapes/Shape"),e("../math/Vec3")),r=e("../math/Mat3"),s=e("../math/Quaternion"),o=(e("../material/Material"),e("../collision/AABB")),l=e("../shapes/Box"),c=e("../world/World");function y(e){e=e||{},n.apply(this),this.id=y.idCounter++,this.world=null,this.preStep=null,this.postStep=null,this.vlambda=new a,this.collisionFilterGroup="number"==typeof e.collisionFilterGroup?e.collisionFilterGroup:1,this.collisionFilterMask="number"==typeof e.collisionFilterMask?e.collisionFilterMask:-1,this.collisionResponse=!0,this.position=new a,this.previousPosition=new a,this.interpolatedPosition=new a,this.initPosition=new a,e.position&&(this.position.copy(e.position),this.previousPosition.copy(e.position),this.interpolatedPosition.copy(e.position),this.initPosition.copy(e.position)),this.velocity=new a,e.velocity&&this.velocity.copy(e.velocity),this.initVelocity=new a,this.force=new a;var t="number"==typeof e.mass?e.mass:0;this.mass=t,this.invMass=0<t?1/t:0,this.material=e.material||null,this.linearDamping="number"==typeof e.linearDamping?e.linearDamping:.01,this.type=t<=0?y.STATIC:y.DYNAMIC,typeof e.type==typeof y.STATIC&&(this.type=e.type),this.allowSleep=void 0===e.allowSleep||e.allowSleep,this.sleepState=0,this.sleepSpeedLimit=void 0!==e.sleepSpeedLimit?e.sleepSpeedLimit:.1,this.sleepTimeLimit=void 0!==e.sleepTimeLimit?e.sleepTimeLimit:1,this.timeLastSleepy=0,this._wakeUpAfterNarrowphase=!1,this.torque=new a,this.quaternion=new s,this.initQuaternion=new s,this.previousQuaternion=new s,this.interpolatedQuaternion=new s,e.quaternion&&(this.quaternion.copy(e.quaternion),this.initQuaternion.copy(e.quaternion),this.previousQuaternion.copy(e.quaternion),this.interpolatedQuaternion.copy(e.quaternion)),this.angularVelocity=new a,e.angularVelocity&&this.angularVelocity.copy(e.angularVelocity),this.initAngularVelocity=new a,this.shapes=[],this.shapeOffsets=[],this.shapeOrientations=[],this.inertia=new a,this.invInertia=new a,this.invInertiaWorld=new r,this.invMassSolve=0,this.invInertiaSolve=new a,this.invInertiaWorldSolve=new r,this.fixedRotation=void 0!==e.fixedRotation&&e.fixedRotation,this.useGravity=!0,this.angularDamping=void 0!==e.angularDamping?e.angularDamping:.01,this.linearFactor=new a(1,1,1),e.linearFactor&&this.linearFactor.copy(e.linearFactor),this.angularFactor=new a(1,1,1),e.angularFactor&&this.angularFactor.copy(e.angularFactor),this.aabb=new o,this.aabbNeedsUpdate=!0,this.boundingRadius=0,this.wlambda=new a,e.shape&&this.addShape(e.shape),this.updateMassProperties()}((y.prototype=new n).constructor=y).COLLIDE_EVENT_NAME="collide",y.DYNAMIC=1,y.STATIC=2,y.KINEMATIC=4,y.AWAKE=0,y.SLEEPY=1,y.SLEEPING=2,y.idCounter=0,y.wakeupEvent={type:"wakeup"},y.prototype.wakeUp=function(){var e=this.sleepState;this.sleepState=0,this._wakeUpAfterNarrowphase=!1,e===y.SLEEPING&&this.dispatchEvent(y.wakeupEvent)},y.prototype.sleep=function(){this.sleepState=y.SLEEPING,this.velocity.set(0,0,0),this.angularVelocity.set(0,0,0),this._wakeUpAfterNarrowphase=!1},y.sleepyEvent={type:"sleepy"},y.sleepEvent={type:"sleep"},y.prototype.sleepTick=function(e){if(this.allowSleep){var t=this.sleepState,i=this.velocity.norm2()+this.angularVelocity.norm2(),n=Math.pow(this.sleepSpeedLimit,2);t===y.AWAKE&&i<n?(this.sleepState=y.SLEEPY,this.timeLastSleepy=e,this.dispatchEvent(y.sleepyEvent)):t===y.SLEEPY&&n<i?this.wakeUp():t===y.SLEEPY&&e-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleep(),this.dispatchEvent(y.sleepEvent))}},y.prototype.updateSolveMassProperties=function(){this.sleepState===y.SLEEPING||this.type===y.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve.setZero(),this.invInertiaWorldSolve.setZero()):(this.invMassSolve=this.invMass,this.invInertiaSolve.copy(this.invInertia),this.invInertiaWorldSolve.copy(this.invInertiaWorld))},y.prototype.pointToLocalFrame=function(e,t){return t=t||new a,e.vsub(this.position,t),this.quaternion.conjugate().vmult(t,t),t},y.prototype.vectorToLocalFrame=function(e,t){return t=t||new a,this.quaternion.conjugate().vmult(e,t),t},y.prototype.pointToWorldFrame=function(e,t){return t=t||new a,this.quaternion.vmult(e,t),t.vadd(this.position,t),t},y.prototype.vectorToWorldFrame=function(e,t){return t=t||new a,this.quaternion.vmult(e,t),t};var h=new a,f=new s;y.prototype.addShape=function(e,t,i){if(-1===this.shapes.indexOf(e)){var n=new a,r=new s;return t&&n.copy(t),i&&r.copy(i),c.idToShapeMap[e.id]=e,this.shapes.push(e),this.shapeOffsets.push(n),this.shapeOrientations.push(r),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0,e.body=this}},y.prototype.removeShape=function(e){var t=this.shapes.indexOf(e);-1!==t&&(this.shapes.splice(t,1),this.shapeOffsets.splice(t,1),this.shapeOrientations.splice(t,1),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0)},y.prototype.updateBoundingRadius=function(){for(var e=this.shapes,t=this.shapeOffsets,i=e.length,n=0,r=0;r!==i;r++){var a=e[r];a.updateBoundingSphereRadius();var s=t[r].norm(),o=a.boundingSphereRadius;n<s+o&&(n=s+o)}this.boundingRadius=n};var d=new o;y.prototype.computeAABB=function(){for(var e=this.shapes,t=this.shapeOffsets,i=this.shapeOrientations,n=e.length,r=h,a=f,s=this.quaternion,o=this.aabb,l=d,c=0;c!==n;c++){var u=e[c];s.vmult(t[c],r),r.vadd(this.position,r),i[c].mult(s,a),u.calculateWorldAABB(r,a,l.lowerBound,l.upperBound),0===c?o.copy(l):o.extend(l)}this.aabbNeedsUpdate=!1};var u=new r,p=new r;new r,y.prototype.updateInertiaWorld=function(e){var t=this.invInertia;if(t.x!==t.y||t.y!==t.z||e){var i=u,n=p;i.setRotationFromQuaternion(this.quaternion),i.transpose(n),i.scale(t,i),i.mmult(n,this.invInertiaWorld)}};var _=new a;y.prototype.applyForce=function(e,t){if(this.type===y.DYNAMIC){var i=_;t.cross(e,i),this.force.vadd(e,this.force),this.torque.vadd(i,this.torque)}};var v=new a,m=new a;y.prototype.applyLocalForce=function(e,t){if(this.type===y.DYNAMIC){var i=v,n=m;this.vectorToWorldFrame(e,i),this.vectorToWorldFrame(t,n),this.applyForce(i,n)}};var g=new a,b=new a;y.prototype.applyImpulse=function(e,t){if(this.type===y.DYNAMIC){var i=t,n=g;n.copy(e),n.mult(this.invMass,n),this.velocity.vadd(n,this.velocity);var r=b;i.cross(e,r),this.invInertiaWorld.vmult(r,r),this.angularVelocity.vadd(r,this.angularVelocity)}};var x=new a,S=new a;y.prototype.applyLocalImpulse=function(e,t){if(this.type===y.DYNAMIC){var i=x,n=S;this.vectorToWorldFrame(e,i),this.vectorToWorldFrame(t,n),this.applyImpulse(i,n)}};var w=new a;y.prototype.updateMassProperties=function(){var e=w;this.invMass=0<this.mass?1/this.mass:0;var t=this.inertia,i=this.fixedRotation;this.computeAABB(),e.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2),l.calculateInertia(e,this.mass,t),this.invInertia.set(0<t.x&&!i?1/t.x:0,0<t.y&&!i?1/t.y:0,0<t.z&&!i?1/t.z:0),this.updateInertiaWorld(!0)},y.prototype.getVelocityAtWorldPoint=function(e,t){var i=new a;return e.vsub(this.position,i),this.angularVelocity.cross(i,t),this.velocity.vadd(t,t),t},y.prototype.integrate=function(e,t,i){if(this.previousPosition.copy(this.position),this.previousQuaternion.copy(this.quaternion),(this.type===y.DYNAMIC||this.type===y.KINEMATIC)&&this.sleepState!==y.SLEEPING){var n=this.velocity,r=this.angularVelocity,a=this.position,s=this.force,o=this.torque,l=this.quaternion,c=this.invMass,u=this.invInertiaWorld,h=this.linearFactor,f=c*e;n.x+=s.x*f*h.x,n.y+=s.y*f*h.y,n.z+=s.z*f*h.z;var d=u.elements,p=this.angularFactor,_=o.x*p.x,v=o.y*p.y,m=o.z*p.z;r.x+=e*(d[0]*_+d[1]*v+d[2]*m),r.y+=e*(d[3]*_+d[4]*v+d[5]*m),r.z+=e*(d[6]*_+d[7]*v+d[8]*m),a.x+=n.x*e,a.y+=n.y*e,a.z+=n.z*e,l.integrate(this.angularVelocity,e,this.angularFactor,l),t&&(i?l.normalizeFast():l.normalize()),this.aabbNeedsUpdate=!0,this.updateInertiaWorld()}},y.prototype.isSleeping=function(){return this.sleepState===y.SLEEPING},y.prototype.isSleepy=function(){return this.sleepState===y.SLEEPY},y.prototype.isAwake=function(){return this.sleepState===y.AWAKE}},{"../collision/AABB":3,"../material/Material":26,"../math/Mat3":28,"../math/Quaternion":29,"../math/Vec3":31,"../shapes/Box":38,"../shapes/Shape":44,"../utils/EventTarget":50,"../world/World":57}],33:[function(e,t,i){e("./Body");var E=e("../math/Vec3"),u=e("../math/Quaternion"),n=(e("../collision/RaycastResult"),e("../collision/Ray")),r=e("../objects/WheelInfo");function a(e){this.chassisBody=e.chassisBody,this.wheelInfos=[],this.sliding=!1,this.world=null,this.indexRightAxis=void 0!==e.indexRightAxis?e.indexRightAxis:1,this.indexForwardAxis=void 0!==e.indexForwardAxis?e.indexForwardAxis:0,this.indexUpAxis=void 0!==e.indexUpAxis?e.indexUpAxis:2}t.exports=a,new E,new E,new E;var h=new E,f=new E,d=new E;new n,a.prototype.addWheel=function(e){var t=new r(e=e||{}),i=this.wheelInfos.length;return this.wheelInfos.push(t),i},a.prototype.setSteeringValue=function(e,t){this.wheelInfos[t].steering=e},new E,a.prototype.applyEngineForce=function(e,t){this.wheelInfos[t].engineForce=e},a.prototype.setBrake=function(e,t){this.wheelInfos[t].brake=e},a.prototype.addToWorld=function(e){this.constraints,e.addBody(this.chassisBody);var t=this;this.preStepCallback=function(){t.updateVehicle(e.dt)},e.addEventListener("preStep",this.preStepCallback),this.world=e},a.prototype.getVehicleAxisWorld=function(e,t){t.set(0===e?1:0,1===e?1:0,2===e?1:0),this.chassisBody.vectorToWorldFrame(t,t)},a.prototype.updateVehicle=function(e){for(var t=this.wheelInfos,i=t.length,n=this.chassisBody,r=0;r<i;r++)this.updateWheelTransform(r);this.currentVehicleSpeedKmHour=3.6*n.velocity.norm();var a=new E;for(this.getVehicleAxisWorld(this.indexForwardAxis,a),a.dot(n.velocity)<0&&(this.currentVehicleSpeedKmHour*=-1),r=0;r<i;r++)this.castRay(t[r]);this.updateSuspension(e);var s=new E,o=new E;for(r=0;r<i;r++){var l=(f=t[r]).suspensionForce;l>f.maxSuspensionForce&&(l=f.maxSuspensionForce),f.raycastResult.hitNormalWorld.scale(l*e,s),f.raycastResult.hitPointWorld.vsub(n.position,o),n.applyImpulse(s,o)}this.updateFriction(e);var c=new E,u=new E,h=new E;for(r=0;r<i;r++){var f=t[r];n.getVelocityAtWorldPoint(f.chassisConnectionPointWorld,h);var d=1;switch(this.indexUpAxis){case 1:d=-1}if(f.isInContact){this.getVehicleAxisWorld(this.indexForwardAxis,u);var p=u.dot(f.raycastResult.hitNormalWorld);f.raycastResult.hitNormalWorld.scale(p,c),u.vsub(c,u);var _=u.dot(h);f.deltaRotation=d*_*e/f.radius}!f.sliding&&f.isInContact||0===f.engineForce||!f.useCustomSlidingRotationalSpeed||(f.deltaRotation=(0<f.engineForce?1:-1)*f.customSlidingRotationalSpeed*e),Math.abs(f.brake)>Math.abs(f.engineForce)&&(f.deltaRotation=0),f.rotation+=f.deltaRotation,f.deltaRotation*=.99}},a.prototype.updateSuspension=function(e){for(var t=this.chassisBody.mass,i=this.wheelInfos,n=i.length,r=0;r<n;r++){var a=i[r];if(a.isInContact){var s,o=a.suspensionRestLength-a.suspensionLength;s=a.suspensionStiffness*o*a.clippedInvContactDotSuspension;var l=a.suspensionRelativeVelocity;s-=(l<0?a.dampingCompression:a.dampingRelaxation)*l,a.suspensionForce=s*t,a.suspensionForce<0&&(a.suspensionForce=0)}else a.suspensionForce=0}},a.prototype.removeFromWorld=function(e){this.constraints,e.remove(this.chassisBody),e.removeEventListener("preStep",this.preStepCallback),this.world=null};var m=new E,y=new E;a.prototype.castRay=function(e){var t=m,i=y;this.updateWheelTransformWorld(e);var n=this.chassisBody,r=-1,a=e.suspensionRestLength+e.radius;e.directionWorld.scale(a,t);var s=e.chassisConnectionPointWorld;s.vadd(t,i);var o=e.raycastResult;o.reset();var l=n.collisionResponse;n.collisionResponse=!1,this.world.rayTest(s,i,o),n.collisionResponse=l;var c=o.body;if(e.raycastResult.groundObject=0,c){r=o.distance,e.raycastResult.hitNormalWorld=o.hitNormalWorld,e.isInContact=!0;var u=o.distance;e.suspensionLength=u-e.radius;var h=e.suspensionRestLength-e.maxSuspensionTravel,f=e.suspensionRestLength+e.maxSuspensionTravel;e.suspensionLength<h&&(e.suspensionLength=h),e.suspensionLength>f&&(e.suspensionLength=f,e.raycastResult.reset());var d=e.raycastResult.hitNormalWorld.dot(e.directionWorld),p=new E;n.getVelocityAtWorldPoint(e.raycastResult.hitPointWorld,p);var _=e.raycastResult.hitNormalWorld.dot(p);if(-.1<=d)e.suspensionRelativeVelocity=0,e.clippedInvContactDotSuspension=10;else{var v=-1/d;e.suspensionRelativeVelocity=_*v,e.clippedInvContactDotSuspension=v}}else e.suspensionLength=e.suspensionRestLength+0*e.maxSuspensionTravel,e.suspensionRelativeVelocity=0,e.directionWorld.scale(-1,e.raycastResult.hitNormalWorld),e.clippedInvContactDotSuspension=1;return r},a.prototype.updateWheelTransformWorld=function(e){e.isInContact=!1;var t=this.chassisBody;t.pointToWorldFrame(e.chassisConnectionPointLocal,e.chassisConnectionPointWorld),t.vectorToWorldFrame(e.directionLocal,e.directionWorld),t.vectorToWorldFrame(e.axleLocal,e.axleWorld)},a.prototype.updateWheelTransform=function(e){var t=h,i=f,n=d,r=this.wheelInfos[e];this.updateWheelTransformWorld(r),r.directionLocal.scale(-1,t),i.copy(r.axleLocal),t.cross(i,n),n.normalize(),i.normalize();var a=r.steering,s=new u;s.setFromAxisAngle(t,a);var o=new u;o.setFromAxisAngle(i,r.rotation);var l=r.worldTransform.quaternion;this.chassisBody.quaternion.mult(s,l),l.mult(o,l),l.normalize();var c=r.worldTransform.position;c.copy(r.directionWorld),c.scale(r.suspensionLength,c),c.vadd(r.chassisConnectionPointWorld,c)};var C=[new E(1,0,0),new E(0,1,0),new E(0,0,1)];a.prototype.getWheelTransformWorld=function(e){return this.wheelInfos[e].worldTransform};var A=new E,k=[],R=[];a.prototype.updateFriction=function(e){for(var t=A,i=this.wheelInfos,n=i.length,r=this.chassisBody,a=R,s=k,o=0;o<n;o++)h=(b=i[o]).raycastResult.body,b.sideImpulse=0,b.forwardImpulse=0,a[o]||(a[o]=new E),s[o]||(s[o]=new E);for(o=0;o<n;o++)if(h=(b=i[o]).raycastResult.body){var l=s[o];this.getWheelTransformWorld(o).vectorToWorldFrame(C[this.indexRightAxis],l);var c=b.raycastResult.hitNormalWorld,u=l.dot(c);c.scale(u,t),l.vsub(t,l),l.normalize(),c.cross(l,a[o]),a[o].normalize(),b.sideImpulse=M(r,b.raycastResult.hitPointWorld,h,b.raycastResult.hitPointWorld,l),b.sideImpulse*=1}for(this.sliding=!1,o=0;o<n;o++){var h=(b=i[o]).raycastResult.body,f=0;if(b.slipInfo=1,h){var d=b.brake?b.brake:0;f=O(r,h,b.raycastResult.hitPointWorld,a[o],d);var p=d/(f+=b.engineForce*e);b.slipInfo*=p}if(b.forwardImpulse=0,b.skidInfo=1,h){b.skidInfo=1;var _=b.suspensionForce*e*b.frictionSlip,v=_*_;b.forwardImpulse=f;var m=.5*b.forwardImpulse,y=1*b.sideImpulse,g=m*m+y*y;b.sliding=!1,v<g&&(this.sliding=!0,b.sliding=!0,p=_/Math.sqrt(g),b.skidInfo*=p)}}if(this.sliding)for(o=0;o<n;o++)0!==(b=i[o]).sideImpulse&&b.skidInfo<1&&(b.forwardImpulse*=b.skidInfo,b.sideImpulse*=b.skidInfo);for(o=0;o<n;o++){var b=i[o],x=new E;if(b.raycastResult.hitPointWorld.vsub(r.position,x),0!==b.forwardImpulse){var S=new E;a[o].scale(b.forwardImpulse,S),r.applyImpulse(S,x)}if(0!==b.sideImpulse){h=b.raycastResult.body;var w=new E;b.raycastResult.hitPointWorld.vsub(h.position,w);var T=new E;s[o].scale(b.sideImpulse,T),r.vectorToLocalFrame(x,x),x["xyz"[this.indexUpAxis]]*=b.rollInfluence,r.vectorToWorldFrame(x,x),r.applyImpulse(T,x),T.scale(-1,T),h.applyImpulse(T,w)}}};var p=new E,_=new E,v=new E;function O(e,t,i,n,r){var a=0,s=i,o=p,l=_,c=v;return e.getVelocityAtWorldPoint(s,o),t.getVelocityAtWorldPoint(s,l),o.vsub(l,c),r<(a=-n.dot(c)*(1/(b(e,i,n)+b(t,i,n))))&&(a=r),a<-r&&(a=-r),a}var o=new E,l=new E,c=new E,g=new E;function b(e,t,i){var n=o,r=l,a=c,s=g;return t.vsub(e.position,n),n.cross(i,r),e.invInertiaWorld.vmult(r,s),s.cross(n,a),e.invMass+i.dot(a)}var x=new E,S=new E,w=new E;function M(e,t,i,n,r){if(1.1<r.norm2())return 0;var a=x,s=S,o=w;return e.getVelocityAtWorldPoint(t,a),i.getVelocityAtWorldPoint(n,s),a.vsub(s,o),-.2*r.dot(o)*(1/(e.invMass+i.invMass))}},{"../collision/Ray":10,"../collision/RaycastResult":11,"../math/Quaternion":29,"../math/Vec3":31,"../objects/WheelInfo":37,"./Body":32}],34:[function(e,t,i){var s=e("./Body"),o=e("../shapes/Sphere"),n=e("../shapes/Box"),l=e("../math/Vec3"),c=e("../constraints/HingeConstraint");function r(e){if(this.wheelBodies=[],this.coordinateSystem=void 0===e.coordinateSystem?new l(1,2,3):e.coordinateSystem.clone(),this.chassisBody=e.chassisBody,!this.chassisBody){var t=new n(new l(5,2,.5));this.chassisBody=new s(1,t)}this.constraints=[],this.wheelAxes=[],this.wheelForces=[]}(t.exports=r).prototype.addWheel=function(e){var t=(e=e||{}).body;t=t||new s(1,new o(1.2)),this.wheelBodies.push(t),this.wheelForces.push(0),new l;var i=void 0!==e.position?e.position.clone():new l,n=new l;this.chassisBody.pointToWorldFrame(i,n),t.position.set(n.x,n.y,n.z);var r=void 0!==e.axis?e.axis.clone():new l(0,1,0);this.wheelAxes.push(r);var a=new c(this.chassisBody,t,{pivotA:i,axisA:r,pivotB:l.ZERO,axisB:r,collideConnected:!1});return this.constraints.push(a),this.wheelBodies.length-1},r.prototype.setSteeringValue=function(e,t){var i=this.wheelAxes[t],n=Math.cos(e),r=Math.sin(e),a=i.x,s=i.y;this.constraints[t].axisA.set(n*a-r*s,r*a+n*s,0)},r.prototype.setMotorSpeed=function(e,t){var i=this.constraints[t];i.enableMotor(),i.motorTargetVelocity=e},r.prototype.disableMotor=function(e){this.constraints[e].disableMotor()};var a=new l;r.prototype.setWheelForce=function(e,t){this.wheelForces[t]=e},r.prototype.applyWheelForce=function(e,t){var i=this.wheelAxes[t],n=this.wheelBodies[t],r=n.torque;i.scale(e,a),n.vectorToWorldFrame(a,a),r.vadd(a,r)},r.prototype.addToWorld=function(e){for(var t=this.constraints,i=this.wheelBodies.concat([this.chassisBody]),n=0;n<i.length;n++)e.addBody(i[n]);for(n=0;n<t.length;n++)e.addConstraint(t[n]);e.addEventListener("preStep",this._update.bind(this))},r.prototype._update=function(){for(var e=this.wheelForces,t=0;t<e.length;t++)this.applyWheelForce(e[t],t)},r.prototype.removeFromWorld=function(e){for(var t=this.constraints,i=this.wheelBodies.concat([this.chassisBody]),n=0;n<i.length;n++)e.remove(i[n]);for(n=0;n<t.length;n++)e.removeConstraint(t[n])};var u=new l;r.prototype.getWheelSpeed=function(e){var t=this.wheelAxes[e],i=this.wheelBodies[e].angularVelocity;return this.chassisBody.vectorToWorldFrame(t,u),i.dot(u)}},{"../constraints/HingeConstraint":16,"../math/Vec3":31,"../shapes/Box":38,"../shapes/Sphere":45,"./Body":32}],35:[function(e,t,i){t.exports=r,e("../shapes/Shape");var n=e("../math/Vec3");function r(){this.particles=[],this.density=1,this.smoothingRadius=1,this.speedOfSound=1,this.viscosity=.01,this.eps=1e-6,this.pressures=[],this.densities=[],this.neighbors=[]}e("../math/Quaternion"),e("../shapes/Particle"),e("../objects/Body"),e("../material/Material"),r.prototype.add=function(e){this.particles.push(e),this.neighbors.length<this.particles.length&&this.neighbors.push([])},r.prototype.remove=function(e){var t=this.particles.indexOf(e);-1!==t&&(this.particles.splice(t,1),this.neighbors.length>this.particles.length&&this.neighbors.pop())};var l=new n;r.prototype.getNeighbors=function(e,t){for(var i=this.particles.length,n=e.id,r=this.smoothingRadius*this.smoothingRadius,a=l,s=0;s!==i;s++){var o=this.particles[s];o.position.vsub(e.position,a),n!==o.id&&a.norm2()<r&&t.push(o)}};var S=new n,w=new n,T=new n,E=new n,C=new n,A=new n;r.prototype.update=function(){for(var e=this.particles.length,t=S,i=this.speedOfSound,n=this.eps,r=0;r!==e;r++){var a=this.particles[r];(y=this.neighbors[r]).length=0,this.getNeighbors(a,y),y.push(this.particles[r]);for(var s=y.length,o=0,l=0;l!==s;l++){a.position.vsub(y[l].position,t);var c=t.norm(),u=this.w(c);o+=y[l].mass*u}this.densities[r]=o,this.pressures[r]=i*i*(this.densities[r]-this.density)}var h=w,f=T,d=E,p=C,_=A;for(r=0;r!==e;r++){var v,m,y,g=this.particles[r];for(h.set(0,0,0),f.set(0,0,0),s=(y=this.neighbors[r]).length,l=0;l!==s;l++){var b=y[l];g.position.vsub(b.position,p);var x=p.norm();v=-b.mass*(this.pressures[r]/(this.densities[r]*this.densities[r]+n)+this.pressures[l]/(this.densities[l]*this.densities[l]+n)),this.gradw(p,d),d.mult(v,d),h.vadd(d,h),b.velocity.vsub(g.velocity,_),_.mult(1/(1e-4+this.densities[r]*this.densities[l])*this.viscosity*b.mass,_),m=this.nablaw(x),_.mult(m,_),f.vadd(_,f)}f.mult(g.mass,f),h.mult(g.mass,h),g.force.vadd(f,g.force),g.force.vadd(h,g.force)}},r.prototype.w=function(e){var t=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(t,9))*Math.pow(t*t-e*e,3)},r.prototype.gradw=function(e,t){var i=e.norm(),n=this.smoothingRadius;e.mult(945/(32*Math.PI*Math.pow(n,9))*Math.pow(n*n-i*i,2),t)},r.prototype.nablaw=function(e){var t=this.smoothingRadius;return 945/(32*Math.PI*Math.pow(t,9))*(t*t-e*e)*(7*e*e-3*t*t)}},{"../material/Material":26,"../math/Quaternion":29,"../math/Vec3":31,"../objects/Body":32,"../shapes/Particle":42,"../shapes/Shape":44}],36:[function(e,t,i){var n=e("../math/Vec3");function r(e,t,i){i=i||{},this.restLength="number"==typeof i.restLength?i.restLength:1,this.stiffness=i.stiffness||100,this.damping=i.damping||1,this.bodyA=e,this.bodyB=t,this.localAnchorA=new n,this.localAnchorB=new n,i.localAnchorA&&this.localAnchorA.copy(i.localAnchorA),i.localAnchorB&&this.localAnchorB.copy(i.localAnchorB),i.worldAnchorA&&this.setWorldAnchorA(i.worldAnchorA),i.worldAnchorB&&this.setWorldAnchorB(i.worldAnchorB)}(t.exports=r).prototype.setWorldAnchorA=function(e){this.bodyA.pointToLocalFrame(e,this.localAnchorA)},r.prototype.setWorldAnchorB=function(e){this.bodyB.pointToLocalFrame(e,this.localAnchorB)},r.prototype.getWorldAnchorA=function(e){this.bodyA.pointToWorldFrame(this.localAnchorA,e)},r.prototype.getWorldAnchorB=function(e){this.bodyB.pointToWorldFrame(this.localAnchorB,e)};var m=new n,y=new n,g=new n,b=new n,x=new n,S=new n,w=new n,T=new n,E=new n,C=new n,A=new n;r.prototype.applyForce=function(){var e=this.stiffness,t=this.damping,i=this.restLength,n=this.bodyA,r=this.bodyB,a=m,s=y,o=g,l=b,c=A,u=x,h=S,f=w,d=T,p=E,_=C;this.getWorldAnchorA(u),this.getWorldAnchorB(h),u.vsub(n.position,f),h.vsub(r.position,d),h.vsub(u,a);var v=a.norm();s.copy(a),s.normalize(),r.velocity.vsub(n.velocity,o),r.angularVelocity.cross(d,c),o.vadd(c,o),n.angularVelocity.cross(f,c),o.vsub(c,o),s.mult(-e*(v-i)-t*o.dot(s),l),n.force.vsub(l,n.force),r.force.vadd(l,r.force),f.cross(l,p),d.cross(l,_),n.torque.vsub(p,n.torque),r.torque.vadd(_,r.torque)}},{"../math/Vec3":31}],37:[function(e,t,i){var n=e("../math/Vec3"),r=e("../math/Transform"),a=e("../collision/RaycastResult"),s=e("../utils/Utils");function o(e){e=s.defaults(e,{chassisConnectionPointLocal:new n,chassisConnectionPointWorld:new n,directionLocal:new n,directionWorld:new n,axleLocal:new n,axleWorld:new n,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:!0,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:!1,customSlidingRotationalSpeed:-.1}),this.maxSuspensionTravel=e.maxSuspensionTravel,this.customSlidingRotationalSpeed=e.customSlidingRotationalSpeed,this.useCustomSlidingRotationalSpeed=e.useCustomSlidingRotationalSpeed,this.sliding=!1,this.chassisConnectionPointLocal=e.chassisConnectionPointLocal.clone(),this.chassisConnectionPointWorld=e.chassisConnectionPointWorld.clone(),this.directionLocal=e.directionLocal.clone(),this.directionWorld=e.directionWorld.clone(),this.axleLocal=e.axleLocal.clone(),this.axleWorld=e.axleWorld.clone(),this.suspensionRestLength=e.suspensionRestLength,this.suspensionMaxLength=e.suspensionMaxLength,this.radius=e.radius,this.suspensionStiffness=e.suspensionStiffness,this.dampingCompression=e.dampingCompression,this.dampingRelaxation=e.dampingRelaxation,this.frictionSlip=e.frictionSlip,this.steering=0,this.rotation=0,this.deltaRotation=0,this.rollInfluence=e.rollInfluence,this.maxSuspensionForce=e.maxSuspensionForce,this.engineForce=0,this.brake=0,this.isFrontWheel=e.isFrontWheel,this.clippedInvContactDotSuspension=1,this.suspensionRelativeVelocity=0,this.suspensionForce=0,this.skidInfo=0,this.suspensionLength=0,this.sideImpulse=0,this.forwardImpulse=0,this.raycastResult=new a,this.worldTransform=new r,this.isInContact=!1}t.exports=o;var l=new n,c=new n;l=new n,o.prototype.updateWheel=function(e){var t=this.raycastResult;if(this.isInContact){var i=t.hitNormalWorld.dot(t.directionWorld);t.hitPointWorld.vsub(e.position,c),e.getVelocityAtWorldPoint(c,l);var n=t.hitNormalWorld.dot(l);if(-.1<=i)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=10;else{var r=-1/i;this.suspensionRelativeVelocity=n*r,this.clippedInvContactDotSuspension=r}}else t.suspensionLength=this.suspensionRestLength,this.suspensionRelativeVelocity=0,t.directionWorld.scale(-1,t.hitNormalWorld),this.clippedInvContactDotSuspension=1}},{"../collision/RaycastResult":11,"../math/Transform":30,"../math/Vec3":31,"../utils/Utils":54}],38:[function(e,t,i){t.exports=r;var n=e("./Shape"),s=e("../math/Vec3"),o=e("./ConvexPolyhedron");function r(e){n.call(this,{type:n.types.BOX}),this.halfExtents=e,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation(),this.updateBoundingSphereRadius()}((r.prototype=new n).constructor=r).prototype.updateConvexPolyhedronRepresentation=function(){var e=this.halfExtents.x,t=this.halfExtents.y,i=this.halfExtents.z,n=s,r=[new n(-e,-t,-i),new n(e,-t,-i),new n(e,t,-i),new n(-e,t,-i),new n(-e,-t,i),new n(e,-t,i),new n(e,t,i),new n(-e,t,i)],a=(new n(0,0,1),new n(0,1,0),new n(1,0,0),new o(r,[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]]));(this.convexPolyhedronRepresentation=a).material=this.material},r.prototype.calculateLocalInertia=function(e,t){return t=t||new s,r.calculateInertia(this.halfExtents,e,t),t},r.calculateInertia=function(e,t,i){var n=e;n.isZero()?(i.x=2/12*t,i.y=2/12*t,i.z=2/12*t):(i.x=1/12*t*(2*n.y*2*n.y+2*n.z*2*n.z),i.y=1/12*t*(2*n.x*2*n.x+2*n.z*2*n.z),i.z=1/12*t*(2*n.y*2*n.y+2*n.x*2*n.x))},r.prototype.getSideNormals=function(e,t){var i=e,n=this.halfExtents;if(i[0].set(n.x,0,0),i[1].set(0,n.y,0),i[2].set(0,0,n.z),i[3].set(-n.x,0,0),i[4].set(0,-n.y,0),i[5].set(0,0,-n.z),void 0!==t)for(var r=0;r!==i.length;r++)t.vmult(i[r],i[r]);return i},r.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},r.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm()};var l=new s;new s,r.prototype.forEachWorldCorner=function(e,t,i){for(var n=this.halfExtents,r=[[n.x,n.y,n.z],[-n.x,n.y,n.z],[-n.x,-n.y,n.z],[-n.x,-n.y,-n.z],[n.x,-n.y,-n.z],[n.x,n.y,-n.z],[-n.x,n.y,-n.z],[n.x,-n.y,n.z]],a=0;a<r.length;a++)l.set(r[a][0],r[a][1],r[a][2]),t.vmult(l,l),e.vadd(l,l),i(l.x,l.y,l.z)};var u=[new s,new s,new s,new s,new s,new s,new s,new s];r.prototype.calculateWorldAABB=function(e,t,i,n){var r=this.halfExtents;u[0].set(r.x,r.y,r.z),u[1].set(-r.x,r.y,r.z),u[2].set(-r.x,-r.y,r.z),u[3].set(-r.x,-r.y,-r.z),u[4].set(r.x,-r.y,-r.z),u[5].set(r.x,r.y,-r.z),u[6].set(-r.x,r.y,-r.z),u[7].set(r.x,-r.y,r.z);var a=u[0];t.vmult(a,a),e.vadd(a,a),n.copy(a),i.copy(a);for(var s=1;s<8;s++){a=u[s],t.vmult(a,a),e.vadd(a,a);var o=a.x,l=a.y,c=a.z;o>n.x&&(n.x=o),l>n.y&&(n.y=l),c>n.z&&(n.z=c),o<i.x&&(i.x=o),l<i.y&&(i.y=l),c<i.z&&(i.z=c)}}},{"../math/Vec3":31,"./ConvexPolyhedron":39,"./Shape":44}],39:[function(e,t,i){t.exports=f;var n=e("./Shape"),b=e("../math/Vec3"),_=(e("../math/Quaternion"),e("../math/Transform"));function f(e,t,i){n.call(this,{type:n.types.CONVEXPOLYHEDRON}),this.vertices=e||[],this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.faces=t||[],this.faceNormals=[],this.computeNormals(),this.worldFaceNormalsNeedsUpdate=!0,this.worldFaceNormals=[],this.uniqueEdges=[],this.uniqueAxes=i?i.slice():null,this.computeEdges(),this.updateBoundingSphereRadius()}(f.prototype=new n).constructor=f;var h=new b;f.prototype.computeEdges=function(){var e=this.faces,t=this.vertices,i=(t.length,this.uniqueEdges);i.length=0;for(var n=h,r=0;r!==e.length;r++)for(var a=e[r],s=a.length,o=0;o!==s;o++){var l=(o+1)%s;t[a[o]].vsub(t[a[l]],n),n.normalize();for(var c=!1,u=0;u!==i.length;u++)if(i[u].almostEquals(n)||i[u].almostEquals(n)){c=!0;break}c||i.push(n.clone())}},f.prototype.computeNormals=function(){this.faceNormals.length=this.faces.length;for(var e=0;e<this.faces.length;e++){for(var t=0;t<this.faces[e].length;t++)if(!this.vertices[this.faces[e][t]])throw new Error("Vertex "+this.faces[e][t]+" not found!");var i=this.faceNormals[e]||new b;this.getFaceNormal(e,i),i.negate(i),this.faceNormals[e]=i;var n=this.vertices[this.faces[e][0]];if(i.dot(n)<0)for(console.error(".faceNormals["+e+"] = Vec3("+i.toString()+") looks like it points into the shape? The vertices follow. Make sure they are ordered CCW around the normal, using the right hand rule."),t=0;t<this.faces[e].length;t++)console.warn(".vertices["+this.faces[e][t]+"] = Vec3("+this.vertices[this.faces[e][t]].toString()+")")}};var r=new b,a=new b;f.computeNormal=function(e,t,i,n){t.vsub(e,a),i.vsub(t,r),r.cross(a,n),n.isZero()||n.normalize()},f.prototype.getFaceNormal=function(e,t){var i=this.faces[e],n=this.vertices[i[0]],r=this.vertices[i[1]],a=this.vertices[i[2]];return f.computeNormal(n,r,a,t)};var x=new b;f.prototype.clipAgainstHull=function(e,t,i,n,r,a,s,o,l){for(var c=x,u=-1,h=-Number.MAX_VALUE,f=0;f<i.faces.length;f++){c.copy(i.faceNormals[f]),r.vmult(c,c);var d=c.dot(a);h<d&&(h=d,u=f)}for(var p=[],_=i.faces[u],v=_.length,m=0;m<v;m++){var y=i.vertices[_[m]],g=new b;g.copy(y),r.vmult(g,g),n.vadd(g,g),p.push(g)}0<=u&&this.clipFaceAgainstHull(a,e,t,p,s,o,l)};var T=new b,E=new b,C=new b,A=new b,k=new b,R=new b;f.prototype.findSeparatingAxis=function(e,t,i,n,r,a,s,o){var l=T,c=E,u=C,h=A,f=k,d=R,p=Number.MAX_VALUE,_=this;if(_.uniqueAxes)for(m=0;m!==_.uniqueAxes.length;m++){if(i.vmult(_.uniqueAxes[m],l),!1===(b=_.testSepAxis(l,e,t,i,n,r)))return!1;b<p&&(p=b,a.copy(l))}else for(var v=s?s.length:_.faces.length,m=0;m<v;m++){var y=s?s[m]:m;if(l.copy(_.faceNormals[y]),i.vmult(l,l),!1===(b=_.testSepAxis(l,e,t,i,n,r)))return!1;b<p&&(p=b,a.copy(l))}if(e.uniqueAxes)for(m=0;m!==e.uniqueAxes.length;m++){if(r.vmult(e.uniqueAxes[m],c),!1===(b=_.testSepAxis(c,e,t,i,n,r)))return!1;b<p&&(p=b,a.copy(c))}else for(var g=o?o.length:e.faces.length,m=0;m<g;m++){var b;if(y=o?o[m]:m,c.copy(e.faceNormals[y]),r.vmult(c,c),!1===(b=_.testSepAxis(c,e,t,i,n,r)))return!1;b<p&&(p=b,a.copy(c))}for(var x=0;x!==_.uniqueEdges.length;x++){i.vmult(_.uniqueEdges[x],h);for(var S=0;S!==e.uniqueEdges.length;S++)if(r.vmult(e.uniqueEdges[S],f),h.cross(f,d),!d.almostZero()){d.normalize();var w=_.testSepAxis(d,e,t,i,n,r);if(!1===w)return!1;w<p&&(p=w,a.copy(d))}}return n.vsub(t,u),0<u.dot(a)&&a.negate(a),!0};var d=[],p=[];f.prototype.testSepAxis=function(e,t,i,n,r,a){f.project(this,e,i,n,d),f.project(t,e,r,a,p);var s=d[0],o=d[1],l=p[0],c=p[1];if(s<c||l<o)return!1;var u=s-c,h=l-o;return u<h?u:h};var s=new b,o=new b;f.prototype.calculateLocalInertia=function(e,t){this.computeLocalAABB(s,o);var i=o.x-s.x,n=o.y-s.y,r=o.z-s.z;t.x=1/12*e*(2*n*2*n+2*r*2*r),t.y=1/12*e*(2*i*2*i+2*r*2*r),t.z=1/12*e*(2*n*2*n+2*i*2*i)},f.prototype.getPlaneConstantOfFace=function(e){var t=this.faces[e],i=this.faceNormals[e],n=this.vertices[t[0]];return-i.dot(n)};var z=new b,B=new b,P=new b,D=new b,F=new b,N=new b,U=new b,V=new b;f.prototype.clipFaceAgainstHull=function(e,t,i,n,r,a,s){for(var o=z,l=B,c=P,u=D,h=F,f=N,d=U,p=V,_=n,v=[],m=-1,y=Number.MAX_VALUE,g=0;g<this.faces.length;g++){o.copy(this.faceNormals[g]),i.vmult(o,o);var b=o.dot(e);b<y&&(y=b,m=g)}if(!(m<0)){var x=this.faces[m];x.connectedFaces=[];for(var S=0;S<this.faces.length;S++)for(var w=0;w<this.faces[S].length;w++)-1!==x.indexOf(this.faces[S][w])&&S!==m&&-1===x.connectedFaces.indexOf(S)&&x.connectedFaces.push(S);_.length;for(var T=x.length,E=0;E<T;E++){var C=this.vertices[x[E]],A=this.vertices[x[(E+1)%T]];C.vsub(A,l),c.copy(l),i.vmult(c,c),t.vadd(c,c),u.copy(this.faceNormals[m]),i.vmult(u,u),t.vadd(u,u),c.cross(u,h),h.negate(h),f.copy(C),i.vmult(f,f),t.vadd(f,f),f.dot(h);var k=x.connectedFaces[E];d.copy(this.faceNormals[k]);var R=this.getPlaneConstantOfFace(k);p.copy(d),i.vmult(p,p);var O=R-p.dot(t);for(this.clipFaceAgainstPlane(_,v,p,O);_.length;)_.shift();for(;v.length;)_.push(v.shift())}for(d.copy(this.faceNormals[m]),R=this.getPlaneConstantOfFace(m),p.copy(d),i.vmult(p,p),O=R-p.dot(t),S=0;S<_.length;S++){var M=p.dot(_[S])+O;if(M<=r&&(M=r),M<=a){var I=_[S];if(M<=0){var L={point:I,normal:p,depth:M};s.push(L)}}}}},f.prototype.clipFaceAgainstPlane=function(e,t,i,n){var r,a,s=e.length;if(s<2)return t;var o=e[e.length-1],l=e[0];r=i.dot(o)+n;for(var c=0;c<s;c++){if(l=e[c],a=i.dot(l)+n,r<0)if(a<0)(u=new b).copy(l),t.push(u);else{var u=new b;o.lerp(l,r/(r-a),u),t.push(u)}else a<0&&(u=new b,o.lerp(l,r/(r-a),u),t.push(u),t.push(l));o=l,r=a}return t},f.prototype.computeWorldVertices=function(e,t){for(var i=this.vertices.length;this.worldVertices.length<i;)this.worldVertices.push(new b);for(var n=this.vertices,r=this.worldVertices,a=0;a!==i;a++)t.vmult(n[a],r[a]),e.vadd(r[a],r[a]);this.worldVerticesNeedsUpdate=!1},new b,f.prototype.computeLocalAABB=function(e,t){var i=this.vertices.length,n=this.vertices;e.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),t.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var r=0;r<i;r++){var a=n[r];a.x<e.x?e.x=a.x:a.x>t.x&&(t.x=a.x),a.y<e.y?e.y=a.y:a.y>t.y&&(t.y=a.y),a.z<e.z?e.z=a.z:a.z>t.z&&(t.z=a.z)}},f.prototype.computeWorldFaceNormals=function(e){for(var t=this.faceNormals.length;this.worldFaceNormals.length<t;)this.worldFaceNormals.push(new b);for(var i=this.faceNormals,n=this.worldFaceNormals,r=0;r!==t;r++)e.vmult(i[r],n[r]);this.worldFaceNormalsNeedsUpdate=!1},f.prototype.updateBoundingSphereRadius=function(){for(var e=0,t=this.vertices,i=0,n=t.length;i!==n;i++){var r=t[i].norm2();e<r&&(e=r)}this.boundingSphereRadius=Math.sqrt(e)};var v=new b;f.prototype.calculateWorldAABB=function(e,t,i,n){for(var r,a,s,o,l,c,u=this.vertices.length,h=this.vertices,f=0;f<u;f++){v.copy(h[f]),t.vmult(v,v),e.vadd(v,v);var d=v;d.x<r||void 0===r?r=d.x:(d.x>o||void 0===o)&&(o=d.x),d.y<a||void 0===a?a=d.y:(d.y>l||void 0===l)&&(l=d.y),d.z<s||void 0===s?s=d.z:(d.z>c||void 0===c)&&(c=d.z)}i.set(r,a,s),n.set(o,l,c)},f.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},f.prototype.getAveragePointLocal=function(e){e=e||new b;for(var t=this.vertices.length,i=this.vertices,n=0;n<t;n++)e.vadd(i[n],e);return e.mult(1/t,e),e},f.prototype.transformAllPoints=function(e,t){var i=this.vertices.length,n=this.vertices;if(t){for(var r=0;r<i;r++){var a=n[r];t.vmult(a,a)}for(r=0;r<this.faceNormals.length;r++)a=this.faceNormals[r],t.vmult(a,a)}if(e)for(r=0;r<i;r++)(a=n[r]).vadd(e,a)};var m=new b,y=new b,g=new b;f.prototype.pointIsInside=function(e){var t=this.vertices.length,i=this.vertices,n=this.faces,r=this.faceNormals,a=this.faces.length,s=m;this.getAveragePointLocal(s);for(var o=0;o<a;o++){this.faces[o].length,t=r[o];var l=i[n[o][0]],c=y;e.vsub(l,c);var u=t.dot(c),h=g;s.vsub(l,h);var f=t.dot(h);if(u<0&&0<f||0<u&&f<0)return!1}return-1},new b;var S=new b,w=new b;f.project=function(e,t,i,n,r){var a=e.vertices.length,s=S,o=0,l=0,c=w,u=e.vertices;c.setZero(),_.vectorToLocalFrame(i,n,t,s),_.pointToLocalFrame(i,n,c,c);var h=c.dot(s);l=o=u[0].dot(s);for(var f=1;f<a;f++){var d=u[f].dot(s);o<d&&(o=d),d<l&&(l=d)}if((o-=h)<(l-=h)){var p=l;l=o,o=p}r[0]=o,r[1]=l}},{"../math/Quaternion":29,"../math/Transform":30,"../math/Vec3":31,"./Shape":44}],40:[function(e,t,i){t.exports=n,e("./Shape");var v=e("../math/Vec3"),m=(e("../math/Quaternion"),e("./ConvexPolyhedron"));function n(e,t,i,n){var r=n,a=[],s=[],o=[],l=[],c=[],u=Math.cos,h=Math.sin;a.push(new v(t*u(0),t*h(0),.5*-i)),l.push(0),a.push(new v(e*u(0),e*h(0),.5*i)),c.push(1);for(var f=0;f<r;f++){var d=2*Math.PI/r*(f+1),p=2*Math.PI/r*(f+.5);f<r-1?(a.push(new v(t*u(d),t*h(d),.5*-i)),l.push(2*f+2),a.push(new v(e*u(d),e*h(d),.5*i)),c.push(2*f+3),o.push([2*f+2,2*f+3,2*f+1,2*f])):o.push([0,1,2*f+1,2*f]),(r%2==1||f<r/2)&&s.push(new v(u(p),h(p),0))}o.push(c),s.push(new v(0,0,1));var _=[];for(f=0;f<l.length;f++)_.push(l[l.length-f-1]);o.push(_),m.call(this,a,o,s)}n.prototype=new m},{"../math/Quaternion":29,"../math/Vec3":31,"./ConvexPolyhedron":39,"./Shape":44}],41:[function(e,t,i){var n=e("./Shape"),h=e("./ConvexPolyhedron"),f=e("../math/Vec3"),r=e("../utils/Utils");function a(e,t){t=r.defaults(t,{maxValue:null,minValue:null,elementSize:1}),this.data=e,this.maxValue=t.maxValue,this.minValue=t.minValue,this.elementSize=t.elementSize,null===t.minValue&&this.updateMinValue(),null===t.maxValue&&this.updateMaxValue(),this.cacheEnabled=!0,n.call(this,{type:n.types.HEIGHTFIELD}),this.pillarConvex=new h,this.pillarOffset=new f,this.updateBoundingSphereRadius(),this._cachedPillars={}}((t.exports=a).prototype=new n).update=function(){this._cachedPillars={}},a.prototype.updateMinValue=function(){for(var e=this.data,t=e[0][0],i=0;i!==e.length;i++)for(var n=0;n!==e[i].length;n++){var r=e[i][n];r<t&&(t=r)}this.minValue=t},a.prototype.updateMaxValue=function(){for(var e=this.data,t=e[0][0],i=0;i!==e.length;i++)for(var n=0;n!==e[i].length;n++){var r=e[i][n];t<r&&(t=r)}this.maxValue=t},a.prototype.setHeightValueAtIndex=function(e,t,i){this.data[e][t]=i,this.clearCachedConvexTrianglePillar(e,t,!1),0<e&&(this.clearCachedConvexTrianglePillar(e-1,t,!0),this.clearCachedConvexTrianglePillar(e-1,t,!1)),0<t&&(this.clearCachedConvexTrianglePillar(e,t-1,!0),this.clearCachedConvexTrianglePillar(e,t-1,!1)),0<t&&0<e&&this.clearCachedConvexTrianglePillar(e-1,t-1,!0)},a.prototype.getRectMinMax=function(e,t,i,n,r){r=r||[];for(var a=this.data,s=this.minValue,o=e;o<=i;o++)for(var l=t;l<=n;l++){var c=a[o][l];s<c&&(s=c)}r[0]=this.minValue,r[1]=s},a.prototype.getIndexOfPosition=function(e,t,i,n){var r=this.elementSize,a=this.data,s=Math.floor(e/r),o=Math.floor(t/r);return i[0]=s,i[1]=o,n&&(s<0&&(s=0),o<0&&(o=0),s>=a.length-1&&(s=a.length-1),o>=a[0].length-1&&(o=a[0].length-1)),!(s<0||o<0||s>=a.length-1||o>=a[0].length-1)};var d=[],p=new f,_=new f,v=new f,m=new f;a.prototype.getTriangleAt=function(e,t,i,n,r,a){var s=d;this.getIndexOfPosition(e,t,s,i);var o=s[0],l=s[1],c=this.data;i&&(o=Math.min(c.length-2,Math.max(0,o)),l=Math.min(c[0].length-2,Math.max(0,l)));var u=this.elementSize,h=Math.pow(e/u-o,2)+Math.pow(t/u-l,2),f=Math.pow(e/u-(o+1),2)+Math.pow(t/u-(l+1),2)<h;return this.getTriangle(o,l,f,n,r,a),f};var c=new f,u=new f,y=new f,g=new f,b=new f;a.prototype.getNormalAt=function(e,t,i,n){var r=c,a=u,s=y,o=g,l=b;this.getTriangleAt(e,t,i,r,a,s),a.vsub(r,o),s.vsub(r,l),o.cross(l,n),n.normalize()},a.prototype.getAabbAtIndex=function(e,t,i){var n=this.data,r=this.elementSize;i.lowerBound.set(e*r,t*r,n[e][t]),i.upperBound.set((e+1)*r,(t+1)*r,n[e+1][t+1])},a.prototype.getHeightAt=function(e,t,i){var n=this.data,r=_,a=v,s=m,o=d;this.getIndexOfPosition(e,t,o,i);var l=o[0],c=o[1];i&&(l=Math.min(n.length-2,Math.max(0,l)),c=Math.min(n[0].length-2,Math.max(0,c)));var u=this.getTriangleAt(e,t,i,r,a,s);!function(e,t,i,n,r,a,s,o,l){l.x=((a-o)*(e-s)+(s-r)*(t-o))/((a-o)*(i-s)+(s-r)*(n-o)),l.y=((o-n)*(e-s)+(i-s)*(t-o))/((a-o)*(i-s)+(s-r)*(n-o)),l.z=1-l.x-l.y}(e,t,r.x,r.y,a.x,a.y,s.x,s.y,p);var h=p;return u?n[l+1][c+1]*h.x+n[l][c+1]*h.y+n[l+1][c]*h.z:n[l][c]*h.x+n[l+1][c]*h.y+n[l][c+1]*h.z},a.prototype.getCacheConvexTrianglePillarKey=function(e,t,i){return e+"_"+t+"_"+(i?1:0)},a.prototype.getCachedConvexTrianglePillar=function(e,t,i){return this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,i)]},a.prototype.setCachedConvexTrianglePillar=function(e,t,i,n,r){this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,i)]={convex:n,offset:r}},a.prototype.clearCachedConvexTrianglePillar=function(e,t,i){delete this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,i)]},a.prototype.getTriangle=function(e,t,i,n,r,a){var s=this.data,o=this.elementSize;i?(n.set((e+1)*o,(t+1)*o,s[e+1][t+1]),r.set(e*o,(t+1)*o,s[e][t+1]),a.set((e+1)*o,t*o,s[e+1][t])):(n.set(e*o,t*o,s[e][t]),r.set((e+1)*o,t*o,s[e+1][t]),a.set(e*o,(t+1)*o,s[e][t+1]))},a.prototype.getConvexTrianglePillar=function(e,t,i){var n=this.pillarConvex,r=this.pillarOffset;if(this.cacheEnabled){if(a=this.getCachedConvexTrianglePillar(e,t,i))return this.pillarConvex=a.convex,void(this.pillarOffset=a.offset);n=new h,r=new f,this.pillarConvex=n,this.pillarOffset=r}var a=this.data,s=this.elementSize,o=n.faces;n.vertices.length=6;for(var l=0;l<6;l++)n.vertices[l]||(n.vertices[l]=new f);for(o.length=5,l=0;l<5;l++)o[l]||(o[l]=[]);var c=n.vertices,u=(Math.min(a[e][t],a[e+1][t],a[e][t+1],a[e+1][t+1])-this.minValue)/2+this.minValue;i?(r.set((e+.75)*s,(t+.75)*s,u),c[0].set(.25*s,.25*s,a[e+1][t+1]-u),c[1].set(-.75*s,.25*s,a[e][t+1]-u),c[2].set(.25*s,-.75*s,a[e+1][t]-u),c[3].set(.25*s,.25*s,-u-1),c[4].set(-.75*s,.25*s,-u-1),c[5].set(.25*s,-.75*s,-u-1),o[0][0]=0,o[0][1]=1,o[0][2]=2,o[1][0]=5,o[1][1]=4,o[1][2]=3,o[2][0]=2,o[2][1]=5,o[2][2]=3,o[2][3]=0,o[3][0]=3,o[3][1]=4,o[3][2]=1,o[3][3]=0,o[4][0]=1,o[4][1]=4,o[4][2]=5,o[4][3]=2):(r.set((e+.25)*s,(t+.25)*s,u),c[0].set(-.25*s,-.25*s,a[e][t]-u),c[1].set(.75*s,-.25*s,a[e+1][t]-u),c[2].set(-.25*s,.75*s,a[e][t+1]-u),c[3].set(-.25*s,-.25*s,-u-1),c[4].set(.75*s,-.25*s,-u-1),c[5].set(-.25*s,.75*s,-u-1),o[0][0]=0,o[0][1]=1,o[0][2]=2,o[1][0]=5,o[1][1]=4,o[1][2]=3,o[2][0]=0,o[2][1]=2,o[2][2]=5,o[2][3]=3,o[3][0]=1,o[3][1]=0,o[3][2]=3,o[3][3]=4,o[4][0]=4,o[4][1]=5,o[4][2]=2,o[4][3]=1),n.computeNormals(),n.computeEdges(),n.updateBoundingSphereRadius(),this.setCachedConvexTrianglePillar(e,t,i,n,r)},a.prototype.calculateLocalInertia=function(e,t){return(t=t||new f).set(0,0,0),t},a.prototype.volume=function(){return Number.MAX_VALUE},a.prototype.calculateWorldAABB=function(e,t,i,n){i.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),n.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},a.prototype.updateBoundingSphereRadius=function(){var e=this.data,t=this.elementSize;this.boundingSphereRadius=new f(e.length*t,e[0].length*t,Math.max(Math.abs(this.maxValue),Math.abs(this.minValue))).norm()},a.prototype.setHeightsFromImage=function(e,t){var i=document.createElement("canvas");i.width=e.width,i.height=e.height;var n=i.getContext("2d");n.drawImage(e,0,0);var r=n.getImageData(0,0,e.width,e.height),a=this.data;a.length=0,this.elementSize=Math.abs(t.x)/r.width;for(var s=0;s<r.height;s++){for(var o=[],l=0;l<r.width;l++){var c=(r.data[4*(s*r.height+l)]+r.data[4*(s*r.height+l)+1]+r.data[4*(s*r.height+l)+2])/4/255*t.z;t.x<0?o.push(c):o.unshift(c)}t.y<0?a.unshift(o):a.push(o)}this.updateMaxValue(),this.updateMinValue(),this.update()}},{"../math/Vec3":31,"../utils/Utils":54,"./ConvexPolyhedron":39,"./Shape":44}],42:[function(e,t,i){t.exports=a;var n=e("./Shape"),r=e("../math/Vec3");function a(){n.call(this,{type:n.types.PARTICLE})}((a.prototype=new n).constructor=a).prototype.calculateLocalInertia=function(e,t){return(t=t||new r).set(0,0,0),t},a.prototype.volume=function(){return 0},a.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=0},a.prototype.calculateWorldAABB=function(e,t,i,n){i.copy(e),n.copy(e)}},{"../math/Vec3":31,"./Shape":44}],43:[function(e,t,i){t.exports=a;var n=e("./Shape"),r=e("../math/Vec3");function a(){n.call(this,{type:n.types.PLANE}),this.worldNormal=new r,this.worldNormalNeedsUpdate=!0,this.boundingSphereRadius=Number.MAX_VALUE}((a.prototype=new n).constructor=a).prototype.computeWorldNormal=function(e){var t=this.worldNormal;t.set(0,0,1),e.vmult(t,t),this.worldNormalNeedsUpdate=!1},a.prototype.calculateLocalInertia=function(e,t){return t=t||new r},a.prototype.volume=function(){return Number.MAX_VALUE};var s=new r;a.prototype.calculateWorldAABB=function(e,t,i,n){s.set(0,0,1),t.vmult(s,s);var r=Number.MAX_VALUE;i.set(-r,-r,-r),n.set(r,r,r),1===s.x&&(n.x=e.x),1===s.y&&(n.y=e.y),1===s.z&&(n.z=e.z),-1===s.x&&(i.x=e.x),-1===s.y&&(i.y=e.y),-1===s.z&&(i.z=e.z)},a.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=Number.MAX_VALUE}},{"../math/Vec3":31,"./Shape":44}],44:[function(e,t,i){t.exports=r;var n=e("../utils/EventTarget"),r=e("./Shape");function r(e){e=e||{},n.apply(this),this.id=r.idCounter++,this.type=e.type||0,this.boundingSphereRadius=0,this.collisionResponse=!e.collisionResponse||e.collisionResponse,this.collisionFilterGroup=void 0!==e.collisionFilterGroup?e.collisionFilterGroup:1,this.collisionFilterMask=void 0!==e.collisionFilterMask?e.collisionFilterMask:-1,this.material=e.material?e.material:null,this.body=null}e("../math/Vec3"),e("../math/Quaternion"),e("../material/Material"),r.prototype=new n,(r.prototype.constructor=r).prototype.updateBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type},r.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type},r.prototype.calculateLocalInertia=function(e,t){throw"calculateLocalInertia() not implemented for shape type "+this.type},r.idCounter=0,r.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256}},{"../material/Material":26,"../math/Quaternion":29,"../math/Vec3":31,"../utils/EventTarget":50,"./Shape":44}],45:[function(e,t,i){t.exports=a;var n=e("./Shape"),r=e("../math/Vec3");function a(e){if(n.call(this,{type:n.types.SPHERE}),this.radius=void 0!==e?e:1,this.radius<0)throw new Error("The sphere radius cannot be negative.");this.updateBoundingSphereRadius()}((a.prototype=new n).constructor=a).prototype.calculateLocalInertia=function(e,t){t=t||new r;var i=2*e*this.radius*this.radius/5;return t.x=i,t.y=i,t.z=i,t},a.prototype.volume=function(){return 4*Math.PI*this.radius/3},a.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.radius},a.prototype.calculateWorldAABB=function(e,t,i,n){for(var r=this.radius,a=["x","y","z"],s=0;s<a.length;s++){var o=a[s];i[o]=e[o]-r,n[o]=e[o]+r}}},{"../math/Vec3":31,"./Shape":44}],46:[function(e,t,i){t.exports=y;var n=e("./Shape"),c=e("../math/Vec3"),r=(e("../math/Quaternion"),e("../math/Transform")),u=e("../collision/AABB"),a=e("../utils/Octree");function y(e,t){n.call(this,{type:n.types.TRIMESH}),this.vertices=new Float32Array(e),this.indices=new Int16Array(t),this.normals=new Float32Array(t.length),this.aabb=new u,this.edges=null,this.scale=new c(1,1,1),this.tree=new a,this.updateEdges(),this.updateNormals(),this.updateAABB(),this.updateBoundingSphereRadius(),this.updateTree()}(y.prototype=new n).constructor=y;var o=new c;y.prototype.updateTree=function(){var e=this.tree;e.reset(),e.aabb.copy(this.aabb);var t=this.scale;e.aabb.lowerBound.x*=1/t.x,e.aabb.lowerBound.y*=1/t.y,e.aabb.lowerBound.z*=1/t.z,e.aabb.upperBound.x*=1/t.x,e.aabb.upperBound.y*=1/t.y,e.aabb.upperBound.z*=1/t.z;for(var i=new u,n=new c,r=new c,a=new c,s=[n,r,a],o=0;o<this.indices.length/3;o++){var l=3*o;this._getUnscaledVertex(this.indices[l],n),this._getUnscaledVertex(this.indices[1+l],r),this._getUnscaledVertex(this.indices[2+l],a),i.setFromPoints(s),e.insert(i,o)}e.removeEmptyNodes()};var l=new u;y.prototype.getTrianglesInAABB=function(e,t){l.copy(e);var i=this.scale,n=i.x,r=i.y,a=i.z,s=l.lowerBound,o=l.upperBound;return s.x/=n,s.y/=r,s.z/=a,o.x/=n,o.y/=r,o.z/=a,this.tree.aabbQuery(l,t)},y.prototype.setScale=function(e){var t=this.scale.x===this.scale.y===this.scale.z,i=e.x===e.y===e.z;t&&i||this.updateNormals(),this.scale.copy(e),this.updateAABB(),this.updateBoundingSphereRadius()},y.prototype.updateNormals=function(){for(var e=o,t=this.normals,i=0;i<this.indices.length/3;i++){var n=3*i,r=this.indices[n],a=this.indices[1+n],s=this.indices[2+n];this.getVertex(r,p),this.getVertex(a,_),this.getVertex(s,v),y.computeNormal(_,p,v,e),t[n]=e.x,t[1+n]=e.y,t[2+n]=e.z}},y.prototype.updateEdges=function(){function e(e,t){i[r<a?r+"_"+a:a+"_"+r]=!0}for(var i={},t=0;t<this.indices.length/3;t++){var n=3*t,r=this.indices[n],a=this.indices[1+n];this.indices[2+n],e(),e(),e()}var s=Object.keys(i);for(this.edges=new Int16Array(2*s.length),t=0;t<s.length;t++){var o=s[t].split("_");this.edges[2*t]=parseInt(o[0],10),this.edges[2*t+1]=parseInt(o[1],10)}},y.prototype.getEdgeVertex=function(e,t,i){var n=this.edges[2*e+(t?1:0)];this.getVertex(n,i)};var s=new c,h=new c;y.prototype.getEdgeVector=function(e,t){var i=s,n=h;this.getEdgeVertex(e,0,i),this.getEdgeVertex(e,1,n),n.vsub(i,t)};var f=new c,d=new c;y.computeNormal=function(e,t,i,n){t.vsub(e,d),i.vsub(t,f),f.cross(d,n),n.isZero()||n.normalize()};var p=new c,_=new c,v=new c;y.prototype.getVertex=function(e,t){var i=this.scale;return this._getUnscaledVertex(e,t),t.x*=i.x,t.y*=i.y,t.z*=i.z,t},y.prototype._getUnscaledVertex=function(e,t){var i=3*e,n=this.vertices;return t.set(n[i],n[1+i],n[2+i])},y.prototype.getWorldVertex=function(e,t,i,n){return this.getVertex(e,n),r.pointToWorldFrame(t,i,n,n),n},y.prototype.getTriangleVertices=function(e,t,i,n){var r=3*e;this.getVertex(this.indices[r],t),this.getVertex(this.indices[1+r],i),this.getVertex(this.indices[2+r],n)},y.prototype.getNormal=function(e,t){var i=3*e;return t.set(this.normals[i],this.normals[1+i],this.normals[2+i])};var m=new u;y.prototype.calculateLocalInertia=function(e,t){this.computeLocalAABB(m);var i=m.upperBound.x-m.lowerBound.x,n=m.upperBound.y-m.lowerBound.y,r=m.upperBound.z-m.lowerBound.z;return t.set(1/12*e*(2*n*2*n+2*r*2*r),1/12*e*(2*i*2*i+2*r*2*r),1/12*e*(2*n*2*n+2*i*2*i))};var g=new c;y.prototype.computeLocalAABB=function(e){var t=e.lowerBound,i=e.upperBound,n=this.vertices.length,r=(this.vertices,g);this.getVertex(0,r),t.copy(r),i.copy(r);for(var a=0;a!==n;a++)this.getVertex(a,r),r.x<t.x?t.x=r.x:r.x>i.x&&(i.x=r.x),r.y<t.y?t.y=r.y:r.y>i.y&&(i.y=r.y),r.z<t.z?t.z=r.z:r.z>i.z&&(i.z=r.z)},y.prototype.updateAABB=function(){this.computeLocalAABB(this.aabb)},y.prototype.updateBoundingSphereRadius=function(){for(var e=0,t=this.vertices,i=new c,n=0,r=t.length/3;n!==r;n++){this.getVertex(n,i);var a=i.norm2();e<a&&(e=a)}this.boundingSphereRadius=Math.sqrt(e)},new c;var b=new r,x=new u;y.prototype.calculateWorldAABB=function(e,t,i,n){var r=b,a=x;r.position=e,r.quaternion=t,this.aabb.toWorldFrame(r,a),i.copy(a.lowerBound),n.copy(a.upperBound)},y.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},y.createTorus=function(e,t,i,n,r){e=e||1,t=t||.5,i=i||8,n=n||6,r=r||2*Math.PI;for(var a=[],s=[],o=0;o<=i;o++)for(var l=0;l<=n;l++){var c=l/n*r,u=o/i*Math.PI*2,h=(e+t*Math.cos(u))*Math.cos(c),f=(e+t*Math.cos(u))*Math.sin(c),d=t*Math.sin(u);a.push(h,f,d)}for(o=1;o<=i;o++)for(l=1;l<=n;l++){var p=(n+1)*o+l-1,_=(n+1)*(o-1)+l-1,v=(n+1)*(o-1)+l,m=(n+1)*o+l;s.push(p,_,m),s.push(_,v,m)}return new y(a,s)}},{"../collision/AABB":3,"../math/Quaternion":29,"../math/Transform":30,"../math/Vec3":31,"../utils/Octree":51,"./Shape":44}],47:[function(e,t,i){t.exports=r,e("../math/Vec3"),e("../math/Quaternion");var n=e("./Solver");function r(){n.call(this),this.iterations=10,this.tolerance=1e-7}r.prototype=new n;var k=[],R=[],O=[];r.prototype.solve=function(e,t){var i,n,r,a,s,o=0,l=this.iterations,c=this.tolerance*this.tolerance,u=this.equations,h=u.length,f=t.bodies,d=f.length,p=e;if(0!==h)for(var _=0;_!==d;_++)f[_].updateSolveMassProperties();var v=R,m=O,y=k;for(v.length=h,m.length=h,y.length=h,_=0;_!==h;_++){var g=u[_];y[_]=0,m[_]=g.computeB(p),v[_]=1/g.computeC()}if(0!==h){for(_=0;_!==d;_++){var b=(w=f[_]).vlambda,x=w.wlambda;b.set(0,0,0),x.set(0,0,0)}for(o=0;o!==l;o++){for(var S=a=0;S!==h;S++)g=u[S],i=m[S],n=v[S],(s=y[S])+(r=n*(i-g.computeGWlambda()-g.eps*s))<g.minForce?r=g.minForce-s:s+r>g.maxForce&&(r=g.maxForce-s),y[S]+=r,a+=0<r?r:-r,g.addToWlambda(r);if(a*a<c)break}for(_=0;_!==d;_++){var w,T=(w=f[_]).velocity,E=w.angularVelocity;w.vlambda.vmul(w.linearFactor,w.vlambda),T.vadd(w.vlambda,T),w.wlambda.vmul(w.angularFactor,w.wlambda),E.vadd(w.wlambda,E)}for(var C=u.length,A=1/p;C--;)u[C].multiplier=y[C]*A}return o}},{"../math/Quaternion":29,"../math/Vec3":31,"./Solver":48}],48:[function(e,t,i){function n(){this.equations=[]}(t.exports=n).prototype.solve=function(e,t){return 0},n.prototype.addEquation=function(e){e.enabled&&this.equations.push(e)},n.prototype.removeEquation=function(e){var t=this.equations,i=t.indexOf(e);-1!==i&&t.splice(i,1)},n.prototype.removeAllEquations=function(){this.equations.length=0}},{}],49:[function(e,t,i){t.exports=a,e("../math/Vec3"),e("../math/Quaternion");var n=e("./Solver"),r=e("../objects/Body");function a(e){for(n.call(this),this.iterations=10,this.tolerance=1e-7,this.subsolver=e,this.nodes=[],this.nodePool=[];this.nodePool.length<128;)this.nodePool.push(this.createNode())}a.prototype=new n;var x=[],S=[],w={bodies:[]},s=r.STATIC;function T(e){for(var t=e.length,i=0;i!==t;i++){var n=e[i];if(!(n.visited||n.body.type&s))return n}return!1}var o=[];function E(e,t,i,n){for(o.push(e),e.visited=!0,t(e,i,n);o.length;)for(var r,a=o.pop();r=T(a.children);)r.visited=!0,t(r,i,n),o.push(r)}function C(e,t,i){t.push(e.body);for(var n=e.eqs.length,r=0;r!==n;r++){var a=e.eqs[r];-1===i.indexOf(a)&&i.push(a)}}function A(e,t){return t.id-e.id}a.prototype.createNode=function(){return{body:null,children:[],eqs:[],visited:!1}},a.prototype.solve=function(e,t){for(var i=x,n=this.nodePool,r=t.bodies,a=this.equations,s=a.length,o=r.length,l=this.subsolver;n.length<o;)n.push(this.createNode());i.length=o;for(var c=0;c<o;c++)i[c]=n[c];for(c=0;c!==o;c++){var u=i[c];u.body=r[c],u.children.length=0,u.eqs.length=0,u.visited=!1}for(var h=0;h!==s;h++){var f=a[h],d=(c=r.indexOf(f.bi),r.indexOf(f.bj)),p=i[c],_=i[d];p.children.push(_),p.eqs.push(f),_.children.push(p),_.eqs.push(f)}var v,m=0,y=S;l.tolerance=this.tolerance,l.iterations=this.iterations;for(var g=w;v=T(i);){y.length=0,g.bodies.length=0,E(v,C,g.bodies,y);var b=y.length;for(y=y.sort(A),c=0;c!==b;c++)l.addEquation(y[c]);l.solve(e,g),l.removeAllEquations(),m++}return m}},{"../math/Quaternion":29,"../math/Vec3":31,"../objects/Body":32,"./Solver":48}],50:[function(e,t,i){function n(){}(t.exports=n).prototype={constructor:n,addEventListener:function(e,t){void 0===this._listeners&&(this._listeners={});var i=this._listeners;return void 0===i[e]&&(i[e]=[]),-1===i[e].indexOf(t)&&i[e].push(t),this},hasEventListener:function(e,t){if(void 0===this._listeners)return!1;var i=this._listeners;return void 0!==i[e]&&-1!==i[e].indexOf(t)},hasAnyEventListener:function(e){return void 0!==this._listeners&&void 0!==this._listeners[e]},removeEventListener:function(e,t){if(void 0===this._listeners)return this;var i=this._listeners;if(void 0===i[e])return this;var n=i[e].indexOf(t);return-1!==n&&i[e].splice(n,1),this},dispatchEvent:function(e){if(void 0===this._listeners)return this;var t=this._listeners[e.type];if(void 0!==t){e.target=this;for(var i=0,n=t.length;i<n;i++)t[i].call(this,e)}return this}}},{}],51:[function(e,t,i){var l=e("../collision/AABB"),c=e("../math/Vec3");function u(e){e=e||{},this.root=e.root||null,this.aabb=e.aabb?e.aabb.clone():new l,this.data=[],this.children=[]}(t.exports=function(e,t){(t=t||{}).root=null,t.aabb=e,u.call(this,t),this.maxDepth=void 0!==t.maxDepth?t.maxDepth:8}).prototype=new u,u.prototype.reset=function(e,t){this.children.length=this.data.length=0},u.prototype.insert=function(e,t,i){var n=this.data;if(i=i||0,!this.aabb.contains(e))return!1;var r=this.children;if(i<(this.maxDepth||this.root.maxDepth)){var a=!1;r.length||(this.subdivide(),a=!0);for(var s=0;8!==s;s++)if(r[s].insert(e,t,i+1))return!0;a&&(r.length=0)}return n.push(t),!0};var h=new c;u.prototype.subdivide=function(){var e=this.aabb,t=e.lowerBound,i=e.upperBound,n=this.children;n.push(new u({aabb:new l({lowerBound:new c(0,0,0)})}),new u({aabb:new l({lowerBound:new c(1,0,0)})}),new u({aabb:new l({lowerBound:new c(1,1,0)})}),new u({aabb:new l({lowerBound:new c(1,1,1)})}),new u({aabb:new l({lowerBound:new c(0,1,1)})}),new u({aabb:new l({lowerBound:new c(0,0,1)})}),new u({aabb:new l({lowerBound:new c(1,0,1)})}),new u({aabb:new l({lowerBound:new c(0,1,0)})})),i.vsub(t,h),h.scale(.5,h);for(var r=this.root||this,a=0;8!==a;a++){var s=n[a];s.root=r;var o=s.aabb.lowerBound;o.x*=h.x,o.y*=h.y,o.z*=h.z,o.vadd(t,o),o.vadd(h,s.aabb.upperBound)}},u.prototype.aabbQuery=function(e,t){this.data,this.children;for(var i=[this];i.length;){var n=i.pop();n.aabb.overlaps(e)&&Array.prototype.push.apply(t,n.data),Array.prototype.push.apply(i,n.children)}return t};var n=new l;u.prototype.rayQuery=function(e,t,i){return e.getAABB(n),n.toLocalFrame(t,n),this.aabbQuery(n,i),i},u.prototype.removeEmptyNodes=function(){for(var e=[this];e.length;){for(var t=e.pop(),i=t.children.length-1;0<=i;i--)t.children[i].data.length||t.children.splice(i,1);Array.prototype.push.apply(e,t.children)}}},{"../collision/AABB":3,"../math/Vec3":31}],52:[function(e,t,i){function n(){this.objects=[],this.type=Object}(t.exports=n).prototype.release=function(){for(var e=arguments.length,t=0;t!==e;t++)this.objects.push(arguments[t]);return this},n.prototype.get=function(){return 0===this.objects.length?this.constructObject():this.objects.pop()},n.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this Pool subclass yet!")},n.prototype.resize=function(e){for(var t=this.objects;t.length>e;)t.pop();for(;t.length<e;)t.push(this.constructObject());return this}},{}],53:[function(e,t,i){function n(){this.data={keys:[]}}(t.exports=n).prototype.get=function(e,t){if(t<e){var i=t;t=e,e=i}return this.data[e+"-"+t]},n.prototype.set=function(e,t,i){if(t<e){var n=t;t=e,e=n}var r=e+"-"+t;return this.get(e,t)||this.data.keys.push(r),this.data[r]=i,this.data[r]},n.prototype.reset=function(){for(var e=this.data,t=e.keys;0<t.length;)delete e[t.pop()]},n.prototype.getLength=function(){return this.data.keys.length},n.prototype.getKeyByIndex=function(e){return this.data.keys[e]},n.prototype.getDataByKey=function(e){return this.data[e]}},{}],54:[function(e,t,i){(t.exports=function(){}).defaults=function(e,t){for(var i in e=e||{},t)i in e||(e[i]=t[i]);return e}},{}],55:[function(e,t,i){t.exports=a;var n=e("../math/Vec3"),r=e("./Pool");function a(){r.call(this),this.type=n}(a.prototype=new r).constructObject=function(){return new n}},{"../math/Vec3":31,"./Pool":52}],56:[function(e,t,i){t.exports=o;var n=e("../collision/AABB"),w=e("../objects/Body"),r=e("../shapes/Shape"),B=e("../collision/Ray"),y=e("../math/Vec3"),P=e("../math/Transform"),a=(e("../shapes/ConvexPolyhedron"),e("../math/Quaternion")),s=(e("../solver/Solver"),e("../utils/Vec3Pool")),u=e("../equations/ContactEquation"),v=e("../equations/FrictionEquation");function o(e){this.contactPointPool=[],this.frictionEquationPool=[],this.result=[],this.frictionResult=[],this.v3pool=new s,this.world=e,this.currentContactMaterial=null,this.enableFrictionReduction=!1}o.prototype.createContactEquation=function(e,t,i,n,r,a){var s;this.contactPointPool.length?((s=this.contactPointPool.pop()).bi=e,s.bj=t):s=new u(e,t);var o=this.currentContactMaterial;s.restitution=o.restitution,s.setSpookParams(o.contactEquationStiffness,o.contactEquationRelaxation,this.world.dt);var l=i.material||e.material,c=n.material||t.material;return l&&c&&0<=l.restitution&&0<=c.restitution&&(s.restitution=l.restitution*c.restitution),s.si=r||i,s.sj=a||n,s},o.prototype.createFrictionEquationsFromContact=function(e,t){var i=e.bi,n=e.bj,r=e.si,a=e.sj,s=this.world,o=this.currentContactMaterial,l=o.friction,c=r.material||i.material,u=a.material||n.material;if(c&&u&&0<=c.friction&&0<=u.friction&&(l=c.friction*u.friction),0<l){var h=l*s.gravity.length(),f=i.invMass+n.invMass;0<f&&(f=1/f);var d=this.frictionEquationPool,p=d.length?d.pop():new v(i,n,h*f),_=d.length?d.pop():new v(i,n,h*f);return p.bi=_.bi=i,p.bj=_.bj=n,p.minForce=_.minForce=-h*f,p.maxForce=_.maxForce=h*f,p.ri.copy(e.ri),p.rj.copy(e.rj),_.ri.copy(e.ri),_.rj.copy(e.rj),e.ni.tangents(p.t,_.t),p.setSpookParams(o.frictionEquationStiffness,o.frictionEquationRelaxation,s.dt),_.setSpookParams(o.frictionEquationStiffness,o.frictionEquationRelaxation,s.dt),p.enabled=_.enabled=e.enabled,t.push(p,_),!0}return!1};var l=new y,c=new y,h=new y;o.prototype.createFrictionFromAverage=function(e){var t=this.result[this.result.length-1];if(this.createFrictionEquationsFromContact(t,this.frictionResult)&&1!==e){var i=this.frictionResult[this.frictionResult.length-2],n=this.frictionResult[this.frictionResult.length-1];l.setZero(),c.setZero(),h.setZero();for(var r=t.bi,a=(t.bj,0);a!==e;a++)(t=this.result[this.result.length-1-a]).bodyA!==r?(l.vadd(t.ni,l),c.vadd(t.ri,c),h.vadd(t.rj,h)):(l.vsub(t.ni,l),c.vadd(t.rj,c),h.vadd(t.ri,h));var s=1/e;c.scale(s,i.ri),h.scale(s,i.rj),n.ri.copy(i.ri),n.rj.copy(i.rj),l.normalize(),l.tangents(i.t,n.t)}};var T=new y,E=new y,C=new a,A=new a;o.prototype.getContacts=function(e,t,i,n,r,a,s){this.frictionEquationPool=s,this.result=n,this.frictionResult=a;for(var o=C,l=A,c=T,u=E,h=0,f=e.length;h!==f;h++){var d=e[h],p=t[h],_=null;d.material&&p.material&&(_=i.getContactMaterial(d.material,p.material)||null);for(var v=0==d.collisionResponse||0==p.collisionResponse||d.type&w.KINEMATIC&&p.type&w.STATIC||d.type&w.STATIC&&p.type&w.KINEMATIC||d.type&w.KINEMATIC&&p.type&w.KINEMATIC,m=0;m<d.shapes.length;m++){d.quaternion.mult(d.shapeOrientations[m],o),d.quaternion.vmult(d.shapeOffsets[m],c),c.vadd(d.position,c);for(var y=d.shapes[m],g=0;g<p.shapes.length;g++){p.quaternion.mult(p.shapeOrientations[g],l),p.quaternion.vmult(p.shapeOffsets[g],u),u.vadd(p.position,u);var b=p.shapes[g];if(y.collisionFilterMask&b.collisionFilterGroup&&b.collisionFilterMask&y.collisionFilterGroup&&!(c.distanceTo(u)>y.boundingSphereRadius+b.boundingSphereRadius)){v|=0==y.collisionResponse||0==b.collisionResponse;var x=null;y.material&&b.material&&(x=i.getContactMaterial(y.material,b.material)||null),this.currentContactMaterial=x||_||i.defaultContactMaterial;var S=this[y.type|b.type];S&&(y.type<b.type?S.call(this,y,b,c,u,o,l,d,p,y,b,v):S.call(this,b,y,u,c,l,o,p,d,y,b,v))&&v&&(i.shapeOverlapKeeper.set(y.id,b.id),i.shapeOverlapKeeperExit.set(y.id,b.id))}}}}},o.prototype[r.types.BOX|r.types.BOX]=o.prototype.boxBox=function(e,t,i,n,r,a,s,o,l,c,u){return e.convexPolyhedronRepresentation.material=e.material,t.convexPolyhedronRepresentation.material=t.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexConvex(e.convexPolyhedronRepresentation,t.convexPolyhedronRepresentation,i,n,r,a,s,o,e,t,u)},o.prototype[r.types.BOX|r.types.CONVEXPOLYHEDRON]=o.prototype.boxConvex=function(e,t,i,n,r,a,s,o,l,c,u){return e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexConvex(e.convexPolyhedronRepresentation,t,i,n,r,a,s,o,e,t,u)},o.prototype[r.types.BOX|r.types.PARTICLE]=o.prototype.boxParticle=function(e,t,i,n,r,a,s,o,l,c,u){return e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexParticle(e.convexPolyhedronRepresentation,t,i,n,r,a,s,o,e,t,u)},o.prototype[r.types.SPHERE]=o.prototype.sphereSphere=function(e,t,i,n,r,a,s,o,l,c,u){if(u)return i.distanceSquared(n)<Math.pow(e.radius+t.radius,2);var h=this.createContactEquation(s,o,e,t,l,c);n.vsub(i,h.ni),h.ni.normalize(),h.ri.copy(h.ni),h.rj.copy(h.ni),h.ri.mult(e.radius,h.ri),h.rj.mult(-t.radius,h.rj),h.ri.vadd(i,h.ri),h.ri.vsub(s.position,h.ri),h.rj.vadd(n,h.rj),h.rj.vsub(o.position,h.rj),this.result.push(h),this.createFrictionEquationsFromContact(h,this.frictionResult)};var g=new y,b=new y,x=new y;o.prototype[r.types.PLANE|r.types.TRIMESH]=o.prototype.planeTrimesh=function(e,t,i,n,r,a,s,o,l,c,u){var h=new y,f=g;f.set(0,0,1),r.vmult(f,f);for(var d=0;d<t.vertices.length/3;d++){t.getVertex(d,h);var p=new y;p.copy(h),P.pointToWorldFrame(n,a,p,h);var _=b;if(h.vsub(i,_),f.dot(_)<=0){if(u)return!0;var v=this.createContactEquation(s,o,e,t,l,c);v.ni.copy(f);var m=x;f.scale(_.dot(f),m),h.vsub(m,m),v.ri.copy(m),v.ri.vsub(s.position,v.ri),v.rj.copy(h),v.rj.vsub(o.position,v.rj),this.result.push(v),this.createFrictionEquationsFromContact(v,this.frictionResult)}}};var D=new y,F=new y,N=(new y,new y),U=new y,V=new y,G=new y,H=new y,q=new y,j=new y,W=new y,X=new y,Y=new y,Q=new y,K=new n,Z=[];o.prototype[r.types.SPHERE|r.types.TRIMESH]=o.prototype.sphereTrimesh=function(e,t,i,n,r,a,s,o,l,c,u){var h=V,f=G,d=H,p=q,_=j,v=W,m=K,y=U,g=F,b=Z;P.pointToLocalFrame(n,a,i,_);var x=e.radius;m.lowerBound.set(_.x-x,_.y-x,_.z-x),m.upperBound.set(_.x+x,_.y+x,_.z+x),t.getTrianglesInAABB(m,b);for(var S=N,w=e.radius*e.radius,T=0;T<b.length;T++)for(var E=0;E<3;E++)if(t.getVertex(t.indices[3*b[T]+E],S),S.vsub(_,g),g.norm2()<=w){if(y.copy(S),P.pointToWorldFrame(n,a,y,S),S.vsub(i,g),u)return!0;(k=this.createContactEquation(s,o,e,t,l,c)).ni.copy(g),k.ni.normalize(),k.ri.copy(k.ni),k.ri.scale(e.radius,k.ri),k.ri.vadd(i,k.ri),k.ri.vsub(s.position,k.ri),k.rj.copy(S),k.rj.vsub(o.position,k.rj),this.result.push(k),this.createFrictionEquationsFromContact(k,this.frictionResult)}for(T=0;T<b.length;T++)for(E=0;E<3;E++){t.getVertex(t.indices[3*b[T]+E],h),t.getVertex(t.indices[3*b[T]+(E+1)%3],f),f.vsub(h,d),_.vsub(f,v);var C=v.dot(d);_.vsub(h,v);var A=v.dot(d);if(0<A&&C<0&&(_.vsub(h,v),p.copy(d),p.normalize(),A=v.dot(p),p.scale(A,v),v.vadd(h,v),(z=v.distanceTo(_))<e.radius)){if(u)return!0;var k=this.createContactEquation(s,o,e,t,l,c);v.vsub(_,k.ni),k.ni.normalize(),k.ni.scale(e.radius,k.ri),P.pointToWorldFrame(n,a,v,v),v.vsub(o.position,k.rj),P.vectorToWorldFrame(a,k.ni,k.ni),P.vectorToWorldFrame(a,k.ri,k.ri),this.result.push(k),this.createFrictionEquationsFromContact(k,this.frictionResult)}}for(var R=X,O=Y,M=Q,I=D,L=(T=0,b.length);T!==L;T++){t.getTriangleVertices(b[T],R,O,M),t.getNormal(b[T],I),_.vsub(R,v);var z=v.dot(I);if(I.scale(z,v),_.vsub(v,v),z=v.distanceTo(_),B.pointInTriangle(v,R,O,M)&&z<e.radius){if(u)return!0;k=this.createContactEquation(s,o,e,t,l,c),v.vsub(_,k.ni),k.ni.normalize(),k.ni.scale(e.radius,k.ri),P.pointToWorldFrame(n,a,v,v),v.vsub(o.position,k.rj),P.vectorToWorldFrame(a,k.ni,k.ni),P.vectorToWorldFrame(a,k.ri,k.ri),this.result.push(k),this.createFrictionEquationsFromContact(k,this.frictionResult)}}b.length=0};var p=new y,_=new y,m=new y,S=new y,k=new y;o.prototype[r.types.SPHERE|r.types.PLANE]=o.prototype.spherePlane=function(e,t,i,n,r,a,s,o,l,c,u){if(m.set(0,0,1),a.vmult(m,m),m.negate(m),m.normalize(),m.mult(e.radius,S),i.vsub(n,p),m.mult(m.dot(p),_),p.vsub(_,k),-p.dot(m)<=e.radius){if(u)return!0;var h=this.createContactEquation(s,o,e,t,l,c);h.ni.copy(m),h.ri.copy(S),h.rj.copy(k);var f=h.ri,d=h.rj;f.vadd(i,f),f.vsub(s.position,f),d.vadd(n,d),d.vsub(o.position,d),this.result.push(h),this.createFrictionEquationsFromContact(h,this.frictionResult)}};var f=new y,d=new y,R=new y;function J(e,t,i){for(var n=null,r=e.length,a=0;a!==r;a++){var s=e[a],o=f;e[(a+1)%r].vsub(s,o);var l=d;o.cross(t,l);var c=R;i.vsub(s,c);var u=l.dot(c);if(!(null===n||0<u&&!0===n||u<=0&&!1===n))return!1;null===n&&(n=0<u)}return!0}var $=new y,ee=new y,te=new y,ie=new y,ne=[new y,new y,new y,new y,new y,new y],re=new y,ae=new y,se=new y,oe=new y;o.prototype[r.types.SPHERE|r.types.BOX]=o.prototype.sphereBox=function(e,t,i,n,r,a,s,o,l,c,u){var h=this.v3pool,f=ne;i.vsub(n,$),t.getSideNormals(f,a);for(var d=e.radius,p=!1,_=ae,v=se,m=oe,y=null,g=0,b=0,x=0,S=null,w=0,T=f.length;w!==T&&!1===p;w++){var E=ee;E.copy(f[w]);var C=E.norm();E.normalize();var A=$.dot(E);if(A<C+d&&0<A){var k=te,R=ie;k.copy(f[(w+1)%3]),R.copy(f[(w+2)%3]);var O=k.norm(),M=R.norm();k.normalize(),R.normalize();var I=$.dot(k),L=$.dot(R);if(I<O&&-O<I&&L<M&&-M<L){var z=Math.abs(A-C-d);if((null===S||z<S)&&(S=z,b=I,x=L,y=C,_.copy(E),v.copy(k),m.copy(R),g++,u))return!0}}}if(g){p=!0;var B=this.createContactEquation(s,o,e,t,l,c);_.mult(-d,B.ri),B.ni.copy(_),B.ni.negate(B.ni),_.mult(y,_),v.mult(b,v),_.vadd(v,_),m.mult(x,m),_.vadd(m,B.rj),B.ri.vadd(i,B.ri),B.ri.vsub(s.position,B.ri),B.rj.vadd(n,B.rj),B.rj.vsub(o.position,B.rj),this.result.push(B),this.createFrictionEquationsFromContact(B,this.frictionResult)}for(var P=h.get(),D=re,F=0;2!==F&&!p;F++)for(var N=0;2!==N&&!p;N++)for(var U=0;2!==U&&!p;U++)if(P.set(0,0,0),F?P.vadd(f[0],P):P.vsub(f[0],P),N?P.vadd(f[1],P):P.vsub(f[1],P),U?P.vadd(f[2],P):P.vsub(f[2],P),n.vadd(P,D),D.vsub(i,D),D.norm2()<d*d){if(u)return!0;p=!0,(B=this.createContactEquation(s,o,e,t,l,c)).ri.copy(D),B.ri.normalize(),B.ni.copy(B.ri),B.ri.mult(d,B.ri),B.rj.copy(P),B.ri.vadd(i,B.ri),B.ri.vsub(s.position,B.ri),B.rj.vadd(n,B.rj),B.rj.vsub(o.position,B.rj),this.result.push(B),this.createFrictionEquationsFromContact(B,this.frictionResult)}h.release(P),P=null;var V=h.get(),G=h.get(),H=(B=h.get(),h.get()),q=(z=h.get(),f.length);for(F=0;F!==q&&!p;F++)for(N=0;N!==q&&!p;N++)if(F%3!=N%3){f[N].cross(f[F],V),V.normalize(),f[F].vadd(f[N],G),B.copy(i),B.vsub(G,B),B.vsub(n,B);var j=B.dot(V);for(V.mult(j,H),U=0;U===F%3||U===N%3;)U++;z.copy(i),z.vsub(H,z),z.vsub(G,z),z.vsub(n,z);var W=Math.abs(j),X=z.norm();if(W<f[U].norm()&&X<d){if(u)return!0;p=!0;var Y=this.createContactEquation(s,o,e,t,l,c);G.vadd(H,Y.rj),Y.rj.copy(Y.rj),z.negate(Y.ni),Y.ni.normalize(),Y.ri.copy(Y.rj),Y.ri.vadd(n,Y.ri),Y.ri.vsub(i,Y.ri),Y.ri.normalize(),Y.ri.mult(d,Y.ri),Y.ri.vadd(i,Y.ri),Y.ri.vsub(s.position,Y.ri),Y.rj.vadd(n,Y.rj),Y.rj.vsub(o.position,Y.rj),this.result.push(Y),this.createFrictionEquationsFromContact(Y,this.frictionResult)}}h.release(V,G,B,H,z)};var le=new y,ce=new y,ue=new y,he=new y,fe=new y,de=new y,pe=new y,_e=new y,ve=new y,me=new y;o.prototype[r.types.SPHERE|r.types.CONVEXPOLYHEDRON]=o.prototype.sphereConvex=function(e,t,i,n,r,a,s,o,l,c,u){var h=this.v3pool;i.vsub(n,le);for(var f=t.faceNormals,d=t.faces,p=t.vertices,_=e.radius,v=0;v!==p.length;v++){var m=p[v],y=fe;a.vmult(m,y),n.vadd(y,y);var g=he;if(y.vsub(i,g),g.norm2()<_*_)return!!u||(b=!0,(z=this.createContactEquation(s,o,e,t,l,c)).ri.copy(g),z.ri.normalize(),z.ni.copy(z.ri),z.ri.mult(_,z.ri),y.vsub(n,z.rj),z.ri.vadd(i,z.ri),z.ri.vsub(s.position,z.ri),z.rj.vadd(n,z.rj),z.rj.vsub(o.position,z.rj),this.result.push(z),void this.createFrictionEquationsFromContact(z,this.frictionResult))}for(var b=!1,x=(v=0,d.length);v!==x&&!1===b;v++){var S=f[v],w=d[v],T=de;a.vmult(S,T);var E=pe;a.vmult(p[w[0]],E),E.vadd(n,E);var C=_e;T.mult(-_,C),i.vadd(C,C);var A=ve;C.vsub(E,A);var k=A.dot(T),R=me;if(i.vsub(E,R),k<0&&0<R.dot(T)){for(var O=[],M=0,I=w.length;M!==I;M++){var L=h.get();a.vmult(p[w[M]],L),n.vadd(L,L),O.push(L)}if(J(O,T,i)){if(u)return!0;b=!0;var z=this.createContactEquation(s,o,e,t,l,c);T.mult(-_,z.ri),T.negate(z.ni);var B=h.get();T.mult(-k,B);var P=h.get();T.mult(-_,P),i.vsub(n,z.rj),z.rj.vadd(P,z.rj),z.rj.vadd(B,z.rj),z.rj.vadd(n,z.rj),z.rj.vsub(o.position,z.rj),z.ri.vadd(i,z.ri),z.ri.vsub(s.position,z.ri),h.release(B),h.release(P),this.result.push(z),this.createFrictionEquationsFromContact(z,this.frictionResult),M=0;for(var D=O.length;M!==D;M++)h.release(O[M]);return}for(M=0;M!==w.length;M++){var F=h.get(),N=h.get();a.vmult(p[w[(M+1)%w.length]],F),a.vmult(p[w[(M+2)%w.length]],N),n.vadd(F,F),n.vadd(N,N);var U=ce;N.vsub(F,U);var V=ue;U.unit(V);var G=h.get(),H=h.get();i.vsub(F,H);var q=H.dot(V);V.mult(q,G),G.vadd(F,G);var j=h.get();if(G.vsub(i,j),0<q&&q*q<U.norm2()&&j.norm2()<_*_){if(u)return!0;for(z=this.createContactEquation(s,o,e,t,l,c),G.vsub(n,z.rj),G.vsub(i,z.ni),z.ni.normalize(),z.ni.mult(_,z.ri),z.rj.vadd(n,z.rj),z.rj.vsub(o.position,z.rj),z.ri.vadd(i,z.ri),z.ri.vsub(s.position,z.ri),this.result.push(z),this.createFrictionEquationsFromContact(z,this.frictionResult),M=0,D=O.length;M!==D;M++)h.release(O[M]);return h.release(F),h.release(N),h.release(G),h.release(j),void h.release(H)}h.release(F),h.release(N),h.release(G),h.release(j),h.release(H)}for(M=0,D=O.length;M!==D;M++)h.release(O[M])}}},new y,new y,o.prototype[r.types.PLANE|r.types.BOX]=o.prototype.planeBox=function(e,t,i,n,r,a,s,o,l,c,u){return t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,t.convexPolyhedronRepresentation.id=t.id,this.planeConvex(e,t.convexPolyhedronRepresentation,i,n,r,a,s,o,e,t,u)};var O=new y,M=new y,I=new y,L=new y;o.prototype[r.types.PLANE|r.types.CONVEXPOLYHEDRON]=o.prototype.planeConvex=function(e,t,i,n,r,a,s,o,l,c,u){var h=O,f=M;f.set(0,0,1),r.vmult(f,f);for(var d=0,p=I,_=0;_!==t.vertices.length;_++)if(h.copy(t.vertices[_]),a.vmult(h,h),n.vadd(h,h),h.vsub(i,p),f.dot(p)<=0){if(u)return!0;var v=this.createContactEquation(s,o,e,t,l,c),m=L;f.mult(f.dot(p),m),h.vsub(m,m),m.vsub(i,v.ri),v.ni.copy(f),h.vsub(n,v.rj),v.ri.vadd(i,v.ri),v.ri.vsub(s.position,v.ri),v.rj.vadd(n,v.rj),v.rj.vsub(o.position,v.rj),this.result.push(v),d++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(v,this.frictionResult)}this.enableFrictionReduction&&d&&this.createFrictionFromAverage(d)};var z=new y,ye=new y;o.prototype[r.types.CONVEXPOLYHEDRON]=o.prototype.convexConvex=function(e,t,i,n,r,a,s,o,l,c,u,h,f){var d=z;if(!(i.distanceTo(n)>e.boundingSphereRadius+t.boundingSphereRadius)&&e.findSeparatingAxis(t,i,r,n,a,d,h,f)){var p=[],_=ye;e.clipAgainstHull(i,r,t,n,a,d,-100,100,p);for(var v=0,m=0;m!==p.length;m++){if(u)return!0;var y=this.createContactEquation(s,o,e,t,l,c),g=y.ri,b=y.rj;d.negate(y.ni),p[m].normal.negate(_),_.mult(p[m].depth,_),p[m].point.vadd(_,g),b.copy(p[m].point),g.vsub(i,g),b.vsub(n,b),g.vadd(i,g),g.vsub(s.position,g),b.vadd(n,b),b.vsub(o.position,b),this.result.push(y),v++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(y,this.frictionResult)}this.enableFrictionReduction&&v&&this.createFrictionFromAverage(v)}};var ge=new y,be=new y,xe=new y;o.prototype[r.types.PLANE|r.types.PARTICLE]=o.prototype.planeParticle=function(e,t,i,n,r,a,s,o,l,c,u){var h=ge;h.set(0,0,1),s.quaternion.vmult(h,h);var f=be;if(n.vsub(s.position,f),h.dot(f)<=0){if(u)return!0;var d=this.createContactEquation(o,s,t,e,l,c);d.ni.copy(h),d.ni.negate(d.ni),d.ri.set(0,0,0);var p=xe;h.mult(h.dot(n),p),n.vsub(p,p),d.rj.copy(p),this.result.push(d),this.createFrictionEquationsFromContact(d,this.frictionResult)}};var Se=new y;o.prototype[r.types.PARTICLE|r.types.SPHERE]=o.prototype.sphereParticle=function(e,t,i,n,r,a,s,o,l,c,u){var h=Se;if(h.set(0,0,1),n.vsub(i,h),h.norm2()<=e.radius*e.radius){if(u)return!0;var f=this.createContactEquation(o,s,t,e,l,c);h.normalize(),f.rj.copy(h),f.rj.mult(e.radius,f.rj),f.ni.copy(h),f.ni.negate(f.ni),f.ri.set(0,0,0),this.result.push(f),this.createFrictionEquationsFromContact(f,this.frictionResult)}};var we=new a,Te=new y,Ee=(new y,new y),Ce=new y,Ae=new y;o.prototype[r.types.PARTICLE|r.types.CONVEXPOLYHEDRON]=o.prototype.convexParticle=function(e,t,i,n,r,a,s,o,l,c,u){var h=-1,f=Ee,d=Ae,p=null,_=Te;if(_.copy(n),_.vsub(i,_),r.conjugate(we),we.vmult(_,_),e.pointIsInside(_)){e.worldVerticesNeedsUpdate&&e.computeWorldVertices(i,r),e.worldFaceNormalsNeedsUpdate&&e.computeWorldFaceNormals(r);for(var v=0,m=e.faces.length;v!==m;v++){var y=[e.worldVertices[e.faces[v][0]]],g=e.worldFaceNormals[v];n.vsub(y[0],Ce);var b=-g.dot(Ce);if(null===p||Math.abs(b)<Math.abs(p)){if(u)return!0;p=b,h=v,f.copy(g)}}if(-1!==h){var x=this.createContactEquation(o,s,t,e,l,c);f.mult(p,d),d.vadd(n,d),d.vsub(i,d),x.rj.copy(d),f.negate(x.ni),x.ri.set(0,0,0);var S=x.ri,w=x.rj;S.vadd(n,S),S.vsub(o.position,S),w.vadd(i,w),w.vsub(s.position,w),this.result.push(x),this.createFrictionEquationsFromContact(x,this.frictionResult)}else console.warn("Point found inside convex, but did not find penetrating face!")}},o.prototype[r.types.BOX|r.types.HEIGHTFIELD]=o.prototype.boxHeightfield=function(e,t,i,n,r,a,s,o,l,c,u){return e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexHeightfield(e.convexPolyhedronRepresentation,t,i,n,r,a,s,o,e,t,u)};var ke=new y,Re=new y,Oe=[0];o.prototype[r.types.CONVEXPOLYHEDRON|r.types.HEIGHTFIELD]=o.prototype.convexHeightfield=function(e,t,i,n,r,a,s,o,l,c,u){var h=t.data,f=t.elementSize,d=e.boundingSphereRadius,p=Re,_=Oe,v=ke;P.pointToLocalFrame(n,a,i,v);var m=Math.floor((v.x-d)/f)-1,y=Math.ceil((v.x+d)/f)+1,g=Math.floor((v.y-d)/f)-1,b=Math.ceil((v.y+d)/f)+1;if(!(y<0||b<0||m>h.length||g>h[0].length)){m<0&&(m=0),y<0&&(y=0),g<0&&(g=0),b<0&&(b=0),m>=h.length&&(m=h.length-1),y>=h.length&&(y=h.length-1),b>=h[0].length&&(b=h[0].length-1),g>=h[0].length&&(g=h[0].length-1);var x=[];t.getRectMinMax(m,g,y,b,x);var S=x[0],w=x[1];if(!(v.z-d>w||v.z+d<S))for(var T=m;T<y;T++)for(var E=g;E<b;E++){var C=!1;if(t.getConvexTrianglePillar(T,E,!1),P.pointToWorldFrame(n,a,t.pillarOffset,p),i.distanceTo(p)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&(C=this.convexConvex(e,t.pillarConvex,i,p,r,a,s,o,null,null,u,_,null)),u&&C)return!0;if(t.getConvexTrianglePillar(T,E,!0),P.pointToWorldFrame(n,a,t.pillarOffset,p),i.distanceTo(p)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&(C=this.convexConvex(e,t.pillarConvex,i,p,r,a,s,o,null,null,u,_,null)),u&&C)return!0}}};var Me=new y,Ie=new y;o.prototype[r.types.SPHERE|r.types.HEIGHTFIELD]=o.prototype.sphereHeightfield=function(e,t,i,n,r,a,s,o,l,c,u){var h=t.data,f=e.radius,d=t.elementSize,p=Ie,_=Me;P.pointToLocalFrame(n,a,i,_);var v=Math.floor((_.x-f)/d)-1,m=Math.ceil((_.x+f)/d)+1,y=Math.floor((_.y-f)/d)-1,g=Math.ceil((_.y+f)/d)+1;if(!(m<0||g<0||v>h.length||g>h[0].length)){v<0&&(v=0),m<0&&(m=0),y<0&&(y=0),g<0&&(g=0),v>=h.length&&(v=h.length-1),m>=h.length&&(m=h.length-1),g>=h[0].length&&(g=h[0].length-1),y>=h[0].length&&(y=h[0].length-1);var b=[];t.getRectMinMax(v,y,m,g,b);var x=b[0],S=b[1];if(!(_.z-f>S||_.z+f<x))for(var w=this.result,T=v;T<m;T++)for(var E=y;E<g;E++){var C=w.length,A=!1;if(t.getConvexTrianglePillar(T,E,!1),P.pointToWorldFrame(n,a,t.pillarOffset,p),i.distanceTo(p)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&(A=this.sphereConvex(e,t.pillarConvex,i,p,r,a,s,o,e,t,u)),u&&A)return!0;if(t.getConvexTrianglePillar(T,E,!0),P.pointToWorldFrame(n,a,t.pillarOffset,p),i.distanceTo(p)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&(A=this.sphereConvex(e,t.pillarConvex,i,p,r,a,s,o,e,t,u)),u&&A)return!0;if(2<w.length-C)return}}}},{"../collision/AABB":3,"../collision/Ray":10,"../equations/ContactEquation":20,"../equations/FrictionEquation":22,"../math/Quaternion":29,"../math/Transform":30,"../math/Vec3":31,"../objects/Body":32,"../shapes/ConvexPolyhedron":39,"../shapes/Shape":44,"../solver/Solver":48,"../utils/Vec3Pool":55}],57:[function(y,g,e){(function(e){g.exports=d,y("../shapes/Shape");var t=y("../math/Vec3"),i=(y("../math/Quaternion"),y("../solver/GSSolver")),n=(y("../equations/ContactEquation"),y("../equations/FrictionEquation"),y("./Narrowphase")),r=y("../utils/EventTarget"),a=(y("../collision/ArrayCollisionMatrix"),y("../collision/ObjectCollisionMatrix")),s=y("../collision/OverlapKeeper"),o=y("../material/Material"),l=y("../material/ContactMaterial"),L=y("../objects/Body"),c=y("../utils/TupleDictionary"),u=y("../collision/RaycastResult"),h=(y("../collision/AABB"),y("../collision/Ray")),f=y("../collision/NaiveBroadphase");function d(e){e=e||{},r.apply(this),this.dt=-1,this.allowSleep=!!e.allowSleep,this.contacts=[],this.frictionEquations=[],this.contactsDic=new c,this.oldContactsDic=new c,this.quatNormalizeSkip=void 0!==e.quatNormalizeSkip?e.quatNormalizeSkip:0,this.quatNormalizeFast=void 0!==e.quatNormalizeFast&&e.quatNormalizeFast,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.nextId=0,this.gravity=new t,e.gravity&&this.gravity.copy(e.gravity),this.broadphase=void 0!==e.broadphase?e.broadphase:new f,this.bodies=[],this.solver=void 0!==e.solver?e.solver:new i,this.constraints=[],this.narrowphase=new n(this),this.collisionMatrix=new a,this.triggerMatrix=new a,this.shapeOverlapKeeper=new s,this.shapeOverlapKeeperExit=new s,this.materials=[],this.contactmaterials=[],this.contactMaterialTable=new c,this.defaultMaterial=new o("default"),this.defaultContactMaterial=new l(this.defaultMaterial,this.defaultMaterial,{friction:.3,restitution:0}),this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0},this.accumulator=0,this.subsystems=[],this.addBodyEvent={type:"addBody",body:null},this.removeBodyEvent={type:"removeBody",body:null},this.broadphase.setWorld(this)}e?(e.doProfiling=!1,e.DEBUG=!0):window&&(window.doProfiling=!1,window.DEBUG=!0),d.idToBodyMap={},d.idToShapeMap={},d.prototype=new r;var p=new h;d.prototype.getContactMaterial=function(e,t){return this.contactMaterialTable.get(e.id,t.id)},d.prototype.numObjects=function(){return this.bodies.length},d.prototype.collisionMatrixTick=function(){},d.prototype.add=d.prototype.addBody=function(e){-1===this.bodies.indexOf(e)&&(e.index=this.bodies.length,this.bodies.push(e),e.world=this,e.initPosition.copy(e.position),e.initVelocity.copy(e.velocity),e.timeLastSleepy=this.time,e instanceof L&&(e.initAngularVelocity.copy(e.angularVelocity),e.initQuaternion.copy(e.quaternion)),this.collisionMatrix.setNumObjects(this.bodies.length),this.addBodyEvent.body=e,d.idToBodyMap[e.id]=e,this.dispatchEvent(this.addBodyEvent))},d.prototype.addConstraint=function(e){this.constraints.push(e)},d.prototype.removeConstraint=function(e){var t=this.constraints.indexOf(e);-1!==t&&this.constraints.splice(t,1)},d.prototype.rayTest=function(e,t,i){i instanceof u?this.raycastClosest(e,t,{skipBackfaces:!0},i):this.raycastAll(e,t,{skipBackfaces:!0},i)},d.prototype.raycastAll=function(e,t,i,n){return i.mode=h.ALL,i.from=e,i.to=t,i.callback=n,p.intersectWorld(this,i)},d.prototype.raycastAny=function(e,t,i,n){return i.mode=h.ANY,i.from=e,i.to=t,i.result=n,p.intersectWorld(this,i)},d.prototype.raycastClosest=function(e,t,i,n){return i.mode=h.CLOSEST,i.from=e,i.to=t,i.result=n,p.intersectWorld(this,i)},d.prototype.removeBody=d.prototype.remove=function(e){e.world=null;var t=this.bodies.length-1,i=this.bodies,n=i.indexOf(e);if(-1!==n){i.splice(n,1);for(var r=0;r!==i.length;r++)i[r].index=r;this.collisionMatrix.setNumObjects(t),this.removeBodyEvent.body=e,delete d.idToBodyMap[e.id],this.dispatchEvent(this.removeBodyEvent)}},d.prototype.getBodyById=function(e){return d.idToBodyMap[e]},d.prototype.getShapeById=function(e){return d.idToShapeMap[e]},d.prototype.addMaterial=function(e){this.materials.push(e)},d.prototype.addContactMaterial=function(e){this.contactmaterials.push(e),this.contactMaterialTable.set(e.materials[0].id,e.materials[1].id,e)},d.prototype.step=function(e,t,i){if(i=i||10,t=t||0,x=this.contacts.slice(),0===t)this.internalStep(e),this.time+=e;else{this.accumulator+=t;for(var n=0;this.accumulator>=e&&n<i;)this.internalStep(e),this.accumulator-=e,n++;for(var r=this.accumulator%e/e,a=0;a!==this.bodies.length;a++){var s=this.bodies[a];s.previousPosition.lerp(s.position,r,s.interpolatedPosition),s.previousQuaternion.slerp(s.quaternion,r,s.interpolatedQuaternion),s.previousQuaternion.normalize()}this.time+=t}for(var o,l,c=this.contacts,u=this.contacts.length;u--;){var h=(g=c[u]).si,f=g.sj,d=this.contactsDic.get(h.id,f.id);null==d&&(d=this.contactsDic.set(h.id,f.id,[])),d.push(g)}for(this.emitTriggeredEvents(),u=this.contactsDic.getLength();u--;)if(o=this.contactsDic.getKeyByIndex(u),null!=(l=this.contactsDic.getDataByKey(o))){var p=l[0].bi,_=l[0].bj;if(h=l[0].si,f=l[0].sj,p.allowSleep&&p.type===L.DYNAMIC&&p.sleepState===L.SLEEPING&&_.sleepState===L.AWAKE&&_.type!==L.STATIC){var v=_.velocity.norm2()+_.angularVelocity.norm2();2*Math.pow(_.sleepSpeedLimit,2)<=v&&p.wakeUp()}if(_.allowSleep&&_.type===L.DYNAMIC&&_.sleepState===L.SLEEPING&&p.sleepState===L.AWAKE&&p.type!==L.STATIC){var m=p.velocity.norm2()+p.angularVelocity.norm2();2*Math.pow(p.sleepSpeedLimit,2)<=m&&_.wakeUp()}this.collisionMatrix.get(p,_)?b.event="onCollisionStay":(this.collisionMatrix.set(p,_,!0),b.event="onCollisionEnter"),b.contacts=l,b.body=f.body,b.selfShape=h,b.otherShape=f,h.body.dispatchEvent(b),b.body=h.body,b.selfShape=f,b.otherShape=h,f.body.dispatchEvent(b)}var y=x;for(u=y.length;u--;){var g;h=(g=y[u]).si,f=g.sj,null==this.oldContactsDic.get(h.id,f.id)&&this.oldContactsDic.set(h.id,f.id,g)}for(u=this.oldContactsDic.getLength();u--;)o=this.oldContactsDic.getKeyByIndex(u),null==this.contactsDic.getDataByKey(o)&&(p=(l=this.oldContactsDic.getDataByKey(o)).bi,_=l.bj,h=l.si,f=l.sj,this.collisionMatrix.get(p,_)&&(p.isSleeping()&&_.isSleeping()||(this.collisionMatrix.set(p,_,!1),b.event="onCollisionExit",b.body=f.body,b.selfShape=h,b.otherShape=f,b.contacts.length=0,b.contacts.push(l),h.body.dispatchEvent(b),b.body=h.body,b.selfShape=f,b.otherShape=h,f.body.dispatchEvent(b))));this.contactsDic.reset(),this.oldContactsDic.reset(),this.shapeOverlapKeeper.reset()};var b={type:"collide",event:"",body:null,selfShape:null,otherShape:null,contacts:null},x=[],z=[],B=[],P=[];d.prototype.internalStep=function(e){this.dt=e;var t=this.contacts,i=B,n=P,r=this.numObjects(),a=this.bodies,s=this.solver,o=this.gravity,l=(this.profile,L.DYNAMIC),c=this.constraints,u=z,h=o.x,f=o.y,d=o.z,p=0;for(p=0;p!==r;p++)if((C=a[p]).useGravity&&C.type===l){var _=C.force,v=C.mass;_.x+=v*h,_.y+=v*f,_.z+=v*d}p=0;for(var m=this.subsystems.length;p!==m;p++)this.subsystems[p].update();i.length=0,n.length=0,this.broadphase.collisionPairs(this,i,n);var y=c.length;for(p=0;p!==y;p++)if(!(S=c[p]).collideConnected)for(var g=i.length-1;0<=g;g-=1)(S.bodyA===i[g]&&S.bodyB===n[g]||S.bodyB===i[g]&&S.bodyA===n[g])&&(i.splice(g,1),n.splice(g,1));this.shapeOverlapKeeperExit.tick(),t.length=0;var b=this.frictionEquations.length;for(p=0;p!==b;p++)u.push(this.frictionEquations[p]);for(this.frictionEquations.length=0,this.narrowphase.getContacts(i,n,this,t,null,this.frictionEquations,u),p=0;p<this.frictionEquations.length;p++)s.addEquation(this.frictionEquations[p]);var x=t.length;for(p=0;p!==x;p++)s.addEquation(t[p]);for(y=c.length,p=0;p!==y;p++){var S;(S=c[p]).update(),g=0;for(var w=S.equations.length;g!==w;g++){var T=S.equations[g];s.addEquation(T)}}s.solve(e,this),s.removeAllEquations();var E=Math.pow;for(r=this.numObjects(),p=0;p!==r;p++){var C;if((C=a[p]).type&l){var A=E(1-C.linearDamping,e),k=C.velocity;k.mult(A,k);var R=C.angularVelocity;if(R){var O=E(1-C.angularDamping,e);R.mult(O,R)}}}var M=this.stepnumber%(this.quatNormalizeSkip+1)==0,I=this.quatNormalizeFast;for(p=0;p!==r;p++)a[p].integrate(e,M,I);if(this.clearForces(),this.broadphase.dirty=!0,this.time+=e,this.stepnumber+=1,this.allowSleep)for(p=0;p!==r;p++)a[p].sleepTick(this.time)};var _=[],v=[],m={type:"triggered",event:"",selfBody:null,otherBody:null,selfShape:null,otherShape:null};d.prototype.emitTriggeredEvents=function(){_.length=v.length=0,this.shapeOverlapKeeperExit.getDiff(_,v);for(var e=0,t=v.length;e<t;e+=2){m.event="onTriggerExit";var i=this.getShapeById(v[e]),n=this.getShapeById(v[e+1]);this.triggerMatrix.set(i,n,!1),m.selfShape=i,m.otherShape=n,m.selfBody=i.body,m.otherBody=n.body,i.dispatchEvent(m),m.selfShape=n,m.otherShape=i,m.selfBody=n.body,m.otherBody=i.body,n.dispatchEvent(m)}for(_.length=v.length=0,this.shapeOverlapKeeper.getDiff(_,v),e=0,t=_.length;e<t;e+=2){var r=_[e],a=_[e+1];i=this.getShapeById(r),n=this.getShapeById(a),this.triggerMatrix.get(i,n)?m.event="onTriggerStay":(this.triggerMatrix.set(i,n,!0),m.event="onTriggerEnter"),m.selfShape=i,m.otherShape=n,m.selfBody=i.body,m.otherBody=n.body,i.dispatchEvent(m),m.selfShape=n,m.otherShape=i,m.selfBody=n.body,m.otherBody=i.body,n.dispatchEvent(m)}},d.prototype.clearForces=function(){for(var e=this.bodies,t=e.length,i=0;i!==t;i++){var n=e[i];n.force.set(0,0,0),n.torque.set(0,0,0)}}}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../collision/AABB":3,"../collision/ArrayCollisionMatrix":4,"../collision/NaiveBroadphase":7,"../collision/ObjectCollisionMatrix":8,"../collision/OverlapKeeper":9,"../collision/Ray":10,"../collision/RaycastResult":11,"../equations/ContactEquation":20,"../equations/FrictionEquation":22,"../material/ContactMaterial":25,"../material/Material":26,"../math/Quaternion":29,"../math/Vec3":31,"../objects/Body":32,"../shapes/Shape":44,"../solver/GSSolver":47,"../utils/EventTarget":50,"../utils/TupleDictionary":53,"./Narrowphase":56}]},{},[2])(2)});B$.CANNON,B$.Shape;function P$(e){return Fi.strictEquals(e,new Fi)?"<origin>":"(x: ".concat(e.x,", y: ").concat(e.y,", z: ").concat(e.z,")")}function D$(e,t){e.__cc_wrapper__=t}function F$(e){return e.__cc_wrapper__}(I$=M$=M$||{})[I$.DYNAMIC=1]="DYNAMIC",I$[I$.STATIC=2]="STATIC",I$[I$.KINEMATIC=4]="KINEMATIC",(z$=L$=L$||{})[z$.SCENE=0]="SCENE",z$[z$.PHYSIC=1]="PHYSIC";var N$=function(){function t(e){y(this,t),this._body=void 0,this._onCollidedListener=void 0,this._collisionCallbacks=[],this._shapes=[],this._userData=void 0,this._world=null,this._name=void 0,e=e||{},this._name=e.name||"",this._body=new B$.Body({type:M$.DYNAMIC}),D$(this._body,this),this._body.sleepSpeedLimit=.1,this._body.sleepTimeLimit=1,this._onCollidedListener=this._onCollided.bind(this)}return l(t,[{key:"impl",get:function(){return this._body}}]),l(t,[{key:"getAllowSleep",value:function(){return this._body.allowSleep}},{key:"setAllowSleep",value:function(e){this._body.isSleeping()&&this._body.wakeUp(),this._body.allowSleep=e}},{key:"getGroup",value:function(){return this._body.collisionFilterGroup}},{key:"setGroup",value:function(e){this._body.collisionFilterGroup=e}},{key:"addGroup",value:function(e){this._body.collisionFilterGroup|=e}},{key:"removeGroup",value:function(e){this._body.collisionFilterGroup&=~e}},{key:"getMask",value:function(){return this._body.collisionFilterMask}},{key:"setMask",value:function(e){this._body.collisionFilterMask=e}},{key:"addMask",value:function(e){this._body.collisionFilterMask|=e}},{key:"removeMask",value:function(e){this._body.collisionFilterMask&=~e}},{key:"wakeUp",value:function(){return this._body.wakeUp()}},{key:"sleep",value:function(){return this._body.sleep()}},{key:"name",value:function(){return this._name}},{key:"getType",value:function(){return this._body.type}},{key:"setType",value:function(e){this._body.type=e}},{key:"isAwake",value:function(){return this._body.isAwake()}},{key:"isSleepy",value:function(){return this._body.isSleepy()}},{key:"isSleeping",value:function(){return this._body.isSleeping()}},{key:"addShape",value:function(e,t){this._shapes.push(e),null!=t?this._body.addShape(e.impl,Fi.copy(G$,t)):this._body.addShape(e.impl),e.setBody(this._body,this._shapes.length-1)}},{key:"removeShape",value:function(e){var t=this._shapes.indexOf(e);0<=t&&(this._shapes.splice(t,1),this._body.removeShape(e.impl),e.setBody(null,-1))}},{key:"getMass",value:function(){return this._body.mass}},{key:"setMass",value:function(e){this._body.isSleeping()&&this._body.wakeUp(),this._body.mass=e,this._body.updateMassProperties()}},{key:"getIsKinematic",value:function(){return this._body.type===B$.Body.KINEMATIC}},{key:"setIsKinematic",value:function(e){this._body.type=e?B$.Body.KINEMATIC:B$.Body.DYNAMIC}},{key:"getLinearDamping",value:function(){return this._body.linearDamping}},{key:"setLinearDamping",value:function(e){this._body.linearDamping=e}},{key:"getAngularDamping",value:function(){return this._body.angularDamping}},{key:"setAngularDamping",value:function(e){this._body.angularDamping=e}},{key:"getUseGravity",value:function(){return this._body.useGravity}},{key:"setUseGravity",value:function(e){this._body.isSleeping()&&this._body.wakeUp(),this._body.useGravity=e}},{key:"getCollisionResponse",value:function(){return this._body.collisionResponse}},{key:"setCollisionResponse",value:function(e){this._body.isSleeping()&&this._body.wakeUp(),this._body.collisionResponse=!e}},{key:"getLinearVelocity",value:function(e){return Fi.copy(e,this._body.velocity),e}},{key:"setLinearVelocity",value:function(e){this._body.isSleeping()&&this._body.wakeUp(),Fi.copy(this._body.velocity,e)}},{key:"getAngularVelocity",value:function(e){return Fi.copy(e,this._body.angularVelocity),e}},{key:"setAngularVelocity",value:function(e){this._body.isSleeping()&&this._body.wakeUp(),Fi.copy(this._body.angularVelocity,e)}},{key:"getLinearFactor",value:function(e){return Fi.copy(e,this._body.linearFactor),e}},{key:"setLinearFactor",value:function(e){this._body.isSleeping()&&this._body.wakeUp(),Fi.copy(this._body.linearFactor,e)}},{key:"getAngularFactor",value:function(e){return Fi.copy(e,this._body.angularFactor),e}},{key:"setAngularFactor",value:function(e){this._body.isSleeping()&&this._body.wakeUp(),Fi.copy(this._body.angularFactor,e)}},{key:"getFreezeRotation",value:function(){return this._body.fixedRotation}},{key:"setFreezeRotation",value:function(e){this._body.isSleeping()&&this._body.wakeUp(),this._body.fixedRotation=e,this._body.updateMassProperties()}},{key:"applyForce",value:function(e,t){null==t&&(t=Fi.ZERO),this._body.isSleeping()&&this._body.wakeUp(),this._body.applyForce(Fi.copy(G$,e),Fi.copy(H$,t))}},{key:"applyImpulse",value:function(e,t){null==t&&(t=Fi.ZERO),this._body.isSleeping()&&this._body.wakeUp(),this._body.applyImpulse(Fi.copy(G$,e),Fi.copy(H$,t))}},{key:"applyLocalForce",value:function(e,t){null==t&&(t=Fi.ZERO),this._body.isSleeping()&&this._body.wakeUp(),this._body.applyLocalForce(Fi.copy(G$,e),Fi.copy(H$,t))}},{key:"applyLocalImpulse",value:function(e,t){null==t&&(t=Fi.ZERO),this._body.isSleeping()&&this._body.wakeUp(),this._body.applyLocalImpulse(Fi.copy(G$,e),Fi.copy(H$,t))}},{key:"applyTorque",value:function(e){this._body.isSleeping()&&this._body.wakeUp(),this._body.torque.x+=e.x,this._body.torque.y+=e.y,this._body.torque.z+=e.z}},{key:"applyLocalTorque",value:function(e){this._body.isSleeping()&&this._body.wakeUp(),Fi.copy(G$,e),this._body.vectorToWorldFrame(G$,G$),this._body.torque.x+=G$.x,this._body.torque.y+=G$.y,this._body.torque.z+=G$.z}},{key:"setWorld",value:function(e){this._world&&(this._body.removeEventListener("collide",this._onCollidedListener),this._body.world.remove(this._body),this._world=null);var t=e;t&&(t.impl.addBody(this._body),this._body.addEventListener("collide",this._onCollidedListener),null==this._body.material&&(this._body.material=t.impl.defaultMaterial)),this._world=t}},{key:"getPosition",value:function(e){Fi.copy(e,this._body.position)}},{key:"setPosition",value:function(e){Fi.copy(this._body.position,e)}},{key:"getRotation",value:function(e){hn.copy(e,this._body.quaternion)}},{key:"setRotation",value:function(e){hn.copy(this._body.quaternion,e)}},{key:"translateAndRotate",value:function(e,t){zn.getTranslation(this._body.position,e),hn.copy(this._body.quaternion,t)}},{key:"scaleAllShapes",value:function(e){var t=this._shapes,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.setScale(e)}}},{key:"addCollisionCallback",value:function(e){this._collisionCallbacks.push(e)}},{key:"removeCollisionCllback",value:function(e){var t=this._collisionCallbacks.indexOf(e);0<=t&&this._collisionCallbacks.splice(t,1)}},{key:"getUserData",value:function(){return this._userData}},{key:"setUserData",value:function(e){this._userData=e}},{key:"_stringfyThis",value:function(){return"".concat(this._name.length?this._name:"<No-name>")}},{key:"_devStrinfy",value:function(){var e=this._body.shapes.map(function(e){return F$(e)._devStrinfy()}).join("; ");return"Name: [[".concat(this._name.length?this._name:"<No-name>","]], position: ").concat(P$(this._body.position),", shapes: [").concat(e,"]")}},{key:"_onCollided",value:function(e){U$.type=e.event,U$.selfCollider=F$(e.selfShape).getUserData(),U$.otherCollider=F$(e.otherShape).getUserData();var t=0;for(t=U$.contacts.length;t--;)V$.push(U$.contacts.pop());for(t=0;t<e.contacts.length;t++){var i=e.contacts[t];if(0<V$.length){var n=V$.pop();Fi.copy(n.contactA,i.ri),Fi.copy(n.contactB,i.rj),Fi.copy(n.normal,i.ni),U$.contacts.push(n)}else{var r={contactA:Fi.copy(new Fi,i.ri),contactB:Fi.copy(new Fi,i.rj),normal:Fi.copy(new Fi,i.ni)};U$.contacts.push(r)}}for(t=0;t<this._collisionCallbacks.length;t++){(0,this._collisionCallbacks[t])(U$)}}}]),t}(),U$={type:"onCollisionEnter",selfCollider:null,otherCollider:null,contacts:[]},V$=[],G$=new B$.Vec3,H$=new B$.Vec3,q$=function(){function e(){y(this,e),this._hitPoint=new Fi,this._distance=0,this._collidier=null,this._node=null}return l(e,[{key:"_assign",value:function(e,t,i,n){Fi.copy(this._hitPoint,e),this._distance=t,this._node=n.getUserData(),this._collidier=i.getUserData()}},{key:"hitPoint",get:function(){return this._hitPoint}},{key:"distance",get:function(){return this._distance}},{key:"collider",get:function(){return this._collidier}},{key:"node",get:function(){return this._node}}]),e}();function j$(e){return function(e,t){for(var i={},n=0,r=Object.keys(e);n<r.length;n++){var a=r[n],s=a;if(t){var o=t[a];o&&(s=o)}i[s]=e[a]}return i}(e,{queryTriggerInteraction:"checkCollisionResponse"})}function W$(e,t){e._assign(t.hitPointWorld,t.distance,F$(t.shape),F$(t.body))}function X$(e){e.updateMassProperties(),e.updateBoundingRadius(),e.aabbNeedsUpdate=!0}var Y$=function(){function t(){y(this,t),this._scale=new Fi(1,1,1),this._shape=null,this._body=null,this._index=-1,this._center=new Fi(0,0,0),this._userData=void 0,this._onTriggerListener=void 0,this._triggeredCB=[],this._onTriggerListener=this.onTrigger.bind(this)}return l(t,[{key:"impl",get:function(){return this._shape}},{key:"material",set:function(e){null==e?this._shape.material=null:(null==t.idToMaterial[e._uuid]&&(t.idToMaterial[e._uuid]=new B$.Material(e._uuid)),this._shape.material=t.idToMaterial[e._uuid],this._shape.material.friction=e.friction,this._shape.material.restitution=e.restitution)}}]),l(t,[{key:"addTriggerCallback",value:function(e){this._triggeredCB.push(e)}},{key:"removeTriggerCallback",value:function(e){var t=this._triggeredCB.indexOf(e);0<=t&&this._triggeredCB.splice(t,1)}},{key:"getUserData",value:function(){return this._userData}},{key:"setUserData",value:function(e){this._userData=e}},{key:"setBody",value:function(e,t){null==e?this._shape.removeEventListener("triggered",this._onTriggerListener):this._shape.addEventListener("triggered",this._onTriggerListener),this._body=e,this._index=t}},{key:"setCenter",value:function(e){Fi.copy(this._center,e),this._recalcCenter()}},{key:"setScale",value:function(e){Fi.copy(this._scale,e),this._recalcCenter()}},{key:"setRotation",value:function(e){}},{key:"getCollisionResponse",value:function(){return this.impl.collisionResponse}},{key:"setCollisionResponse",value:function(e){this.impl.collisionResponse=e}},{key:"_devStrinfy",value:function(){return this._body?"centerOffset: ".concat(P$(this._body.shapeOffsets[this._index])):"<NotAttached>"}},{key:"onTrigger",value:function(e){t0.type=e.event,t0.selfCollider=F$(e.selfShape).getUserData(),t0.otherCollider=F$(e.otherShape).getUserData();var t=this._triggeredCB,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r(t0)}}},{key:"_recalcCenter",value:function(){if(this._body){var e=this._body.shapeOffsets[this._index];Fi.copy(e,this._center),Fi.multiply(e,e,this._scale),X$(this._body)}}}]),t}();Y$.idToMaterial={};var Q$,K$,Z$,J$,$$,e0,t0={type:"",selfCollider:null,otherCollider:null},i0=function(){function e(){y(this,e),this._world=void 0,this._customBeforeStepListener=[],this._customAfterStepListener=[],this._raycastResult=new B$.RaycastResult,this._world=new B$.World,D$(this._world,this),this._world.broadphase=new B$.NaiveBroadphase}return l(e,[{key:"impl",get:function(){return this._world}}]),l(e,[{key:"getAllowSleep",value:function(){return this._world.allowSleep}},{key:"setAllowSleep",value:function(e){this._world.allowSleep=e}},{key:"setGravity",value:function(e){Fi.copy(this._world.gravity,e)}},{key:"getGravity",value:function(e){Fi.copy(e,this._world.gravity)}},{key:"destroy",value:function(){}},{key:"step",value:function(e,t,i){this._callCustomBeforeSteps(),this._world.step(e,t,i),this._callCustomAfterSteps()}},{key:"addBeforeStep",value:function(e){this._customBeforeStepListener.push(e)}},{key:"removeBeforeStep",value:function(e){var t=this._customBeforeStepListener.indexOf(e);t<0||this._customBeforeStepListener.splice(t,1)}},{key:"addAfterStep",value:function(e){this._customAfterStepListener.push(e)}},{key:"removeAfterStep",value:function(e){var t=this._customAfterStepListener.indexOf(e);t<0||this._customAfterStepListener.splice(t,1)}},{key:"raycastClosest",value:function(e,t,i,n){var r=this._world.raycastClosest(e,t,j$(i),this._raycastResult);return r&&W$(n,this._raycastResult),r}},{key:"raycastAny",value:function(e,t,i,n){var r=this._world.raycastAny(e,t,j$(i),this._raycastResult);return r&&W$(n,this._raycastResult),r}},{key:"raycastAll",value:function(e,t,i,n){return this._world.raycastAll(e,t,j$(i),function(e){var t=new q$;W$(t,e),n(t)})}},{key:"addConstraint",value:function(e){this._world.addConstraint(e.impl)}},{key:"removeConstraint",value:function(e){this._world.removeConstraint(e.impl)}},{key:"_callCustomBeforeSteps",value:function(){this._customBeforeStepListener.forEach(function(e){return e()})}},{key:"_callCustomAfterSteps",value:function(){this._customAfterStepListener.forEach(function(e){return e()})}},{key:"defaultMaterial",set:function(e){this._world.defaultMaterial.friction=e.friction,this._world.defaultMaterial.restitution=e.restitution,null!=Y$.idToMaterial[e._uuid]&&(Y$.idToMaterial[e._uuid]=this._world.defaultMaterial)}}]),e}();p$=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this)))._box=void 0,t._halfExtent=new B$.Vec3,Fi.multiplyScalar(t._halfExtent,e,.5),t._box=new B$.Box(t._halfExtent.clone()),D$(t._box,u(t)),t._shape=t._box,t._shape.addEventListener("trigger",t.onTrigger),t}return p(i,Y$),l(i,[{key:"setScale",value:function(e){_(g(i.prototype),"setScale",this).call(this,e),this._recalcExtents()}},{key:"setSize",value:function(e){Fi.multiplyScalar(this._halfExtent,e,.5),this._recalcExtents()}},{key:"_stringfyThis",value:function(){return"".concat(this._body?F$(this._body)._stringfyThis():"<No-body>","(Box)")}},{key:"_devStrinfy",value:function(){return"Box(".concat(_(g(i.prototype),"_devStrinfy",this).call(this),", halfExtents: ").concat(P$(this._box.halfExtents),")")}},{key:"_recalcExtents",value:function(){Fi.multiply(this._box.halfExtents,this._halfExtent,this._scale),this._box.updateConvexPolyhedronRepresentation(),null!=this._body&&X$(this._body)}}]),i}(),_$=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this)))._sphere=void 0,t._radius=0,t._radius=e,t._sphere=new B$.Sphere(t._radius),D$(t._sphere,u(t)),t._shape=t._sphere,t}return p(i,Y$),l(i,[{key:"setScale",value:function(e){_(g(i.prototype),"setScale",this).call(this,e),this._recalcRadius()}},{key:"setRadius",value:function(e){this._radius=e,this._recalcRadius()}},{key:"_devStrinfy",value:function(){return"Sphere(".concat(_(g(i.prototype),"_devStrinfy",this).call(this),", radius: ").concat(this._sphere.radius,")")}},{key:"_recalcRadius",value:function(){this._sphere.radius=this._radius*function(e){return Math.max(e.x,Math.max(e.y,e.z))}(this._scale),null!=this._body&&X$(this._body)}}]),i}(),v$=N$,m$=i0;var n0=P2("PhysicMaterial",ho("cc.PhysicMaterial")((e0=$$=function(){function t(){var e;return y(this,t),v(e=x(this,g(t).call(this)),"_friction",Z$,u(e)),v(e,"_restitution",J$,u(e)),t.allMaterials.push(u(e)),""==e._uuid&&(e._uuid="pm_"+t._idCounter++),e}return p(t,Mu),l(t,[{key:"friction",get:function(){return this._friction},set:function(e){fi(this._friction,e)||(this._friction=e,this.emit("physics_material_update"))}},{key:"restitution",get:function(){return this._restitution},set:function(e){fi(this._restitution,e)||(this._restitution=e,this.emit("physics_material_update"))}}]),l(t,[{key:"clone",value:function(){var e=new t;return e._friction=this._friction,e._restitution=this._restitution,e}},{key:"destroy",value:function(){if(_(g(t.prototype),"destroy",this).call(this)){var e=t.allMaterials.indexOf(this);return 0<=e&&t.allMaterials.splice(e,1),!0}return!1}}]),t}(),$$.allMaterials=[],$$._idCounter=0,Z$=m((K$=e0).prototype,"_friction",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),J$=m(K$.prototype,"_restitution",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Q$=K$))||Q$);cc.createRaycastResult=function(){return new q$};var r0=P2("PhysicsSystem",function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this)))._world=void 0,e._enable=!0,e._deltaTime=1/60,e._maxSubStep=2,e._allowSleep=!0,e._gravity=new Fi(0,-10,0),e._material=null,e._world=new m$,e.gravity=e._gravity,e.allowSleep=e._allowSleep,e._material=new n0,e._material.friction=.6,e._material.restitution=-1,e._material.on("physics_material_update",e._updateMaterial,u(e)),e._world.defaultMaterial=e._material,e}return p(t,Hp),l(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable=e}},{key:"allowSleep",get:function(){return this._allowSleep},set:function(e){this._allowSleep=e,this._world.setAllowSleep(this._allowSleep)}},{key:"maxSubStep",get:function(){return this._maxSubStep},set:function(e){this._maxSubStep=e}},{key:"deltaTime",get:function(){return this._deltaTime},set:function(e){this._deltaTime=e}},{key:"gravity",get:function(){return this._world.getGravity(this._gravity),this._gravity},set:function(e){this._gravity.x=e.x,this._gravity.y=e.y,this._gravity.z=e.z,this._world.setGravity(e)}},{key:"defaultMaterial",get:function(){return this._material}}]),l(t,[{key:"postUpdate",value:function(e){this._enable&&(Yb.emit(Xb.EVENT_BEFORE_PHYSICS),this._world.step(this._deltaTime,e,this._maxSubStep),Yb.emit(Xb.EVENT_AFTER_PHYSICS))}},{key:"_updateMaterial",value:function(){this._world.defaultMaterial=this._material}}]),t}());r0.instance=void 0,r0.ID=void 0,cc.PhysicsSystem=r0,Yb.on(Xb.EVENT_INIT,function(){var e=new r0;r0.instance=e,Yb.registerSystem(r0.ID,e,0)});var a0,s0,o0,l0,c0,u0,h0,f0,d0,p0,_0=function(){function o(){var e;return y(this,o),(e=x(this,g(o).call(this)))._sharedBody=void 0,e._isPreLoaded=!1,e}return p(o,Bv),l(o,[{key:"_body",get:function(){return this._sharedBody.body}},{key:"sharedBody",get:function(){return this._sharedBody}},{key:"_assertPreload",get:function(){return this._isPreLoaded||A("Physic Error: Please make sure that the node has been added to the scene"),this._isPreLoaded}}]),l(o,[{key:"setGroup",value:function(e){if(this._assertPreload)return this._body.setGroup(e)}},{key:"getGroup",value:function(){return this._assertPreload?this._body.getGroup():0}},{key:"addGroup",value:function(e){if(this._assertPreload)return this._body.addGroup(e)}},{key:"removeGroup",value:function(e){if(this._assertPreload)return this._body.removeGroup(e)}},{key:"getMask",value:function(){return this._assertPreload?this._body.getMask():0}},{key:"setMask",value:function(e){if(this._assertPreload)return this._body.setMask(e)}},{key:"addMask",value:function(e){if(this._assertPreload)return this._body.addMask(e)}},{key:"removeMask",value:function(e){if(this._assertPreload)return this._body.removeMask(e)}},{key:"__preload",value:function(){if(null==this._sharedBody){var e=null,t=this.node.getComponents(o),i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;if(a._sharedBody){e=a._sharedBody;break}}if(!e){var s=this.getComponent(cc.RigidBodyComponent);e=new v0(this.node,s,r0.instance._world)}e.ref(),this._sharedBody=e}this._isPreLoaded=!0}},{key:"onEnable",value:function(){this.sharedBody.enable()}},{key:"onDisable",value:function(){this.sharedBody.disable()}},{key:"onDestroy",value:function(){this._sharedBody.deref(),this._sharedBody=null}},{key:"_findRigidbody",value:function(e){var t=e.getComponent(cc.RigidBodyComponent);return t||(e.parent?e.parent===e.scene?null:this._findRigidbody(e.parent):null)}}]),o}(),v0=function(){function n(e,t,i){y(this,n),this._body=void 0,this._refCount=0,this._actived=!1,this._world=void 0,this._rigidBody=void 0,this._node=void 0,this._worldScale=new Fi(1,1,1),this._beforeStepCallback=void 0,this._afterStepCallback=void 0,this._isShapeOnly=!0,this._body=function(e){return new v$(e)}({name:e.name}),this._node=e,this._rigidBody=t,this._world=i,this._body.setUserData(this._rigidBody),this._beforeStepCallback=this._beforeStep.bind(this),this._afterStepCallback=this._afterStep.bind(this),this._rigidBody?this._isShapeOnly=!1:(this._isShapeOnly=!0,this._body.setUseGravity(!1))}return l(n,[{key:"isShapeOnly",get:function(){return this._isShapeOnly}},{key:"body",get:function(){return this._body}},{key:"transfromSource",set:function(e){e===L$.SCENE?this._isShapeOnly=!0:this._isShapeOnly=!1}},{key:"rigidBody",get:function(){return this._rigidBody}}]),l(n,[{key:"ref",value:function(){++this._refCount}},{key:"deref",value:function(){--this._refCount,this._refCount||this.destroy()}},{key:"enable",value:function(){this._activeBody()}},{key:"disable",value:function(){this._deactiveBody()}},{key:"destroy",value:function(){this._deactiveBody(),this._body.setUserData(null),this._body=null,this._beforeStepCallback=null,this._afterStepCallback=null,this._world=null,this._node=null,this._rigidBody&&(this._rigidBody=null)}},{key:"syncPhysWithScene",value:function(){this._syncPhysWithScene(this._node)}},{key:"_syncPhysWithScene",value:function(e){e.getWorldMatrix(n._tempMat4),e.getWorldRotation(n._tempQuat),this._body.translateAndRotate(n._tempMat4,n._tempQuat)}},{key:"_syncSceneWithPhys",value:function(){this._node&&(this._body.getPosition(n._tempVec3),this._node.setWorldPosition(n._tempVec3),this._body.getFreezeRotation()||(this._body.getRotation(n._tempQuat),this._node.setWorldRotation(n._tempQuat)))}},{key:"_activeBody",value:function(){this._syncPhysWithScene(this._node),this._actived||(this._actived=!0,this._body.setWorld(this._world),this._world.addBeforeStep(this._beforeStepCallback),this._world.addAfterStep(this._afterStepCallback),this._body.wakeUp())}},{key:"_deactiveBody",value:function(){this._actived&&(this._actived=!1,this._world.removeBeforeStep(this._beforeStepCallback),this._world.removeAfterStep(this._afterStepCallback),this._body.sleep(),this._body.setWorld(null))}},{key:"_beforeStep",value:function(){this._node.hasChangedFlags&&(this._node.hasChangedFlags&$v.SCALE&&this._body.scaleAllShapes(this._node.worldScale),this._syncPhysWithScene(this._node),this._body.isSleeping()&&this._body.wakeUp())}},{key:"_afterStep",value:function(){this._isShapeOnly||this._body.getType()!==M$.DYNAMIC?this._node.hasChangedFlags&&(this._syncPhysWithScene(this._node),this._body.isSleeping()&&this._body.wakeUp()):this._syncSceneWithPhys()}}]),n}();v0._tempMat4=new zn,v0._tempQuat=new hn,v0._tempVec3=new Fi;var m0=P2("ColliderComponent",(a0=ho("cc.ColliderComponent"),s0=fo({type:n0,displayName:"Material",displayOrder:-1}),o0=fo({displayOrder:0}),l0=fo({type:Fi,displayOrder:1,tooltip:"The center of the collider, in local space"}),c0=fo({type:n0}),a0((m((h0=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this)))._callbackTable=ke(!0),e._shapeBase=void 0,e._isSharedMaterial=!0,e._trrigerCallback=void 0,e._collisionCallBack=void 0,v(e,"_material",f0,u(e)),v(e,"_isTrigger",d0,u(e)),v(e,"_center",p0,u(e)),e._trrigerCallback=e._onTrigger.bind(u(e)),e._collisionCallBack=e._onCollision.bind(u(e)),e}return p(t,_0),l(t,[{key:"sharedMaterial",get:function(){return this._material},set:function(e){this.material=e}},{key:"material",get:function(){return this._isSharedMaterial&&null!=this._material&&(this._material.off("physics_material_update",this._updateMaterial,this),this._material=this._material.clone(),this._material.on("physics_material_update",this._updateMaterial,this),this._isSharedMaterial=!1),this._material},set:function(e){null!=e&&null!=this._material?this._material._uuid!=e._uuid&&(this._material.off("physics_material_update",this._updateMaterial,this),e.on("physics_material_update",this._updateMaterial,this),this._isSharedMaterial=!1,this._material=e):null!=e&&null==this._material?(e.on("physics_material_update",this._updateMaterial,this),this._material=e):null==e&&null!=this._material&&(this._material.off("physics_material_update",this._updateMaterial,this),this._material=e),this._updateMaterial()}},{key:"isTrigger",get:function(){return this._isTrigger},set:function(e){if(this._isTrigger=e,this.sharedBody){var t=this._isTrigger?M$.DYNAMIC:M$.STATIC;this.sharedBody.body.setType(t),this._shapeBase.setCollisionResponse(!this._isTrigger)}}},{key:"center",get:function(){return this._center},set:function(e){Fi.copy(this._center,e);var t=this.sharedBody.rigidBody;null!=t?(Fi.subtract(c1,this.node.worldPosition,t.node.worldPosition),Fi.add(c1,c1,this._center),this._shapeBase.setCenter(c1)):this._shapeBase.setCenter(this._center)}},{key:"attachedRigidbody",get:function(){return this.sharedBody.rigidBody}}]),l(t,[{key:"on",value:function(e,t,i,n){}},{key:"off",value:function(e,t,i,n){}},{key:"once",value:function(e,t,i,n){}},{key:"targetOff",value:function(e){}},{key:"dispatchEvent",value:function(e){}},{key:"hasEventListener",value:function(e,t,i){return!1}},{key:"removeAll",value:function(e){}},{key:"emit",value:function(e){}},{key:"onLoad",value:function(){this.isTrigger=this._isTrigger,this.sharedMaterial=null==this._material?r0.instance.defaultMaterial:this._material,this.center=this._center}},{key:"onEnable",value:function(){_(g(t.prototype),"onEnable",this).call(this);var e=this.sharedBody.rigidBody;null!=e?(Fi.subtract(c1,this.node.worldPosition,e.node.worldPosition),Fi.add(c1,c1,this._center),this.sharedBody.body.addShape(this._shapeBase,c1)):this.sharedBody.body.addShape(this._shapeBase,this._center),this.center=this._center,this._shapeBase.addTriggerCallback(this._trrigerCallback),this.sharedBody.body.addCollisionCallback(this._collisionCallBack),this.sharedBody.syncPhysWithScene()}},{key:"onDisable",value:function(){this._shapeBase.removeTriggerCallback(this._trrigerCallback),this.sharedBody.body.removeCollisionCllback(this._collisionCallBack),this.sharedBody.body.removeShape(this._shapeBase),this.sharedBody.isShapeOnly&&_(g(t.prototype),"onDisable",this).call(this)}},{key:"onDestroy",value:function(){this.sharedBody.body.removeShape(this._shapeBase),null!=this._material&&this._material._uuid!=r0.instance.defaultMaterial._uuid&&(this._material.destroy(),this._material=null),_(g(t.prototype),"onDestroy",this).call(this)}},{key:"_updateMaterial",value:function(){this._shapeBase.material=this._material}},{key:"_onTrigger",value:function(e){this.emit(e.type,e)}},{key:"_onCollision",value:function(e){this.emit(e.type,e)}}]),t}()).prototype,"sharedMaterial",[s0],Object.getOwnPropertyDescriptor(h0.prototype,"sharedMaterial"),h0.prototype),m(h0.prototype,"isTrigger",[o0],Object.getOwnPropertyDescriptor(h0.prototype,"isTrigger"),h0.prototype),m(h0.prototype,"center",[l0],Object.getOwnPropertyDescriptor(h0.prototype,"center"),h0.prototype),f0=m(h0.prototype,"_material",[c0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),d0=m(h0.prototype,"_isTrigger",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),p0=m(h0.prototype,"_center",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new cc.Vec3(0,0,0)}}),u0=h0))||u0));lu(m0,[sl,ll]);var y0,g0,b0,x0,S0,w0,T0,E0,C0,A0,k0,R0,O0,M0,I0,L0,z0,B0,P0,D0,F0,N0,U0,V0,G0,H0,q0,j0,W0,X0,Y0,Q0,K0,Z0,J0,$0,e1,t1,i1,n1,r1,a1,s1,o1,l1,c1=new Fi,u1=P2("BoxColliderComponent",(y0=ho("cc.BoxColliderComponent"),g0=go(98),b0=yo("Components/BoxCollider"),x0=fo({type:Fi}),y0(S0=g0(S0=b0(S0=vo((T0=m((w0=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this)))._shape=void 0,v(e,"_size",T0,u(e)),e._shape=function(e){return new p$(e)}(e._size),e._shape.setUserData(u(e)),e._shapeBase=e._shape,e}return p(t,m0),l(t,[{key:"onLoad",value:function(){_(g(t.prototype),"onLoad",this).call(this),this.size=this._size,this._shape.setScale(this.node.worldScale)}},{key:"size",get:function(){return this._size},set:function(e){Fi.copy(this._size,e),this._shape.setSize(this._size)}}]),t}()).prototype,"_size",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi(0,0,0)}}),m(w0.prototype,"size",[x0],Object.getOwnPropertyDescriptor(w0.prototype,"size"),w0.prototype),S0=w0))||S0)||S0)||S0)||S0)),h1=P2("SphereColliderComponent",ho("cc.SphereColliderComponent")(E0=go(98)(E0=yo("Components/SphereCollider")(E0=vo((A0=m((C0=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this)))._shape=void 0,v(e,"_radius",A0,u(e)),e._shape=function(e){return new _$(e)}(e._radius),e._shape.setUserData(u(e)),e._shapeBase=e._shape,e}return p(t,m0),l(t,[{key:"onLoad",value:function(){_(g(t.prototype),"onLoad",this).call(this),this.radius=this._radius,this._shape.setScale(this.node.worldScale)}},{key:"radius",get:function(){return this._radius},set:function(e){this._radius=e,this._shape.setRadius(this._radius)}}]),t}()).prototype,"_radius",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),m(C0.prototype,"radius",[fo],Object.getOwnPropertyDescriptor(C0.prototype,"radius"),C0.prototype),E0=C0))||E0)||E0)||E0)||E0),f1=10,d1=0,p1=0,_1=P2("RigidBodyComponent",(k0=ho("cc.RigidBodyComponent"),R0=go(99),O0=yo("Components/RigidBody"),M0=fo({displayOrder:0}),I0=fo({displayOrder:1}),L0=fo({displayOrder:2}),z0=fo({displayOrder:3}),B0=fo({displayOrder:4}),P0=fo({displayOrder:5}),D0=fo({displayOrder:6}),F0=fo({displayOrder:7}),k0(N0=R0(N0=O0(N0=vo(N0=bo((m((U0=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this)))._allowSleep=!0,v(e,"_mass",V0,u(e)),v(e,"_linearDamping",G0,u(e)),v(e,"_angularDamping",H0,u(e)),v(e,"_fixedRotation",q0,u(e)),v(e,"_isKinematic",j0,u(e)),v(e,"_useGravity",W0,u(e)),v(e,"_linearFactor",X0,u(e)),v(e,"_angularFactor",Y0,u(e)),e}return p(t,_0),l(t,[{key:"allowSleep",get:function(){return this._allowSleep},set:function(e){this._allowSleep=e,this.sharedBody.body.setAllowSleep(e)}},{key:"mass",get:function(){return this._mass},set:function(e){this._mass=e,this._body.setMass(e)}},{key:"linearDamping",get:function(){return this._linearDamping},set:function(e){this._linearDamping=e,this._body.setLinearDamping(e)}},{key:"angularDamping",get:function(){return this._angularDamping},set:function(e){this._angularDamping=e,this._body.setAngularDamping(e)}},{key:"isKinematic",get:function(){return this._isKinematic},set:function(e){this._isKinematic=e,this._body.setIsKinematic(e)}},{key:"useGravity",get:function(){return this._useGravity},set:function(e){this._useGravity=e,this._body.setUseGravity(e)}},{key:"fixedRotation",get:function(){return this._fixedRotation},set:function(e){this._fixedRotation=e,this._body.setFreezeRotation(e)}},{key:"linearFactor",get:function(){return this._body.getLinearFactor(this._linearFactor)},set:function(e){Fi.copy(this._linearFactor,e),this._body.setLinearFactor(this._linearFactor)}},{key:"angularFactor",get:function(){return this._body.getAngularFactor(this._angularFactor)},set:function(e){Fi.copy(this._angularFactor,e),this._body.setAngularFactor(this._angularFactor)}},{key:"isAwake",get:function(){return!!this._assertPreload&&this._body.isAwake()}},{key:"isSleepy",get:function(){return!!this._assertPreload&&this._body.isSleepy()}},{key:"isSleeping",get:function(){return!!this._assertPreload&&this._body.isSleeping()}}]),l(t,[{key:"applyForce",value:function(e,t){this._assertPreload&&this._body.applyForce(e,t)}},{key:"applyLocalForce",value:function(e,t){this._assertPreload&&this._body.applyLocalForce(e,t)}},{key:"applyImpulse",value:function(e,t){this._assertPreload&&this._body.applyImpulse(e,t)}},{key:"applyLocalImpulse",value:function(e,t){this._assertPreload&&this._body.applyLocalImpulse(e,t)}},{key:"applyTorque",value:function(e){this._assertPreload&&this._body.applyTorque(e)}},{key:"applyLocalTorque",value:function(e){this._assertPreload&&this._body.applyLocalTorque(e)}},{key:"wakeUp",value:function(){this._assertPreload&&this._body.wakeUp()}},{key:"sleep",value:function(){this._assertPreload&&this._body.sleep()}},{key:"getLinearVelocity",value:function(e){this._assertPreload&&this._body.getLinearVelocity(e)}},{key:"setLinearVelocity",value:function(e){this._assertPreload&&this._body.setLinearVelocity(e)}},{key:"getAngularVelocity",value:function(e){this._assertPreload&&this._body.getAngularVelocity(e)}},{key:"setAngularVelocity",value:function(e){this._assertPreload&&this._body.setAngularVelocity(e)}},{key:"onLoad",value:function(){this.sharedBody&&(this.allowSleep=this._allowSleep,this.mass=this._mass,this.linearDamping=this._linearDamping,this.angularDamping=this._angularDamping,this.useGravity=this._useGravity,this.isKinematic=this._isKinematic,this.fixedRotation=this._fixedRotation,this.linearFactor=this._linearFactor,this.angularFactor=this._angularFactor)}}]),t}()).prototype,"mass",[M0],Object.getOwnPropertyDescriptor(U0.prototype,"mass"),U0.prototype),m(U0.prototype,"linearDamping",[I0],Object.getOwnPropertyDescriptor(U0.prototype,"linearDamping"),U0.prototype),m(U0.prototype,"angularDamping",[L0],Object.getOwnPropertyDescriptor(U0.prototype,"angularDamping"),U0.prototype),m(U0.prototype,"isKinematic",[z0],Object.getOwnPropertyDescriptor(U0.prototype,"isKinematic"),U0.prototype),m(U0.prototype,"useGravity",[B0],Object.getOwnPropertyDescriptor(U0.prototype,"useGravity"),U0.prototype),m(U0.prototype,"fixedRotation",[P0],Object.getOwnPropertyDescriptor(U0.prototype,"fixedRotation"),U0.prototype),m(U0.prototype,"linearFactor",[D0],Object.getOwnPropertyDescriptor(U0.prototype,"linearFactor"),U0.prototype),m(U0.prototype,"angularFactor",[F0],Object.getOwnPropertyDescriptor(U0.prototype,"angularFactor"),U0.prototype),V0=m(U0.prototype,"_mass",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return f1}}),G0=m(U0.prototype,"_linearDamping",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return d1}}),H0=m(U0.prototype,"_angularDamping",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return p1}}),q0=m(U0.prototype,"_fixedRotation",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),j0=m(U0.prototype,"_isKinematic",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),W0=m(U0.prototype,"_useGravity",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),X0=m(U0.prototype,"_linearFactor",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi(1,1,1)}}),Y0=m(U0.prototype,"_angularFactor",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi(1,1,1)}}),N0=U0))||N0)||N0)||N0)||N0)||N0)),v1=P2("ConstantForce",(Q0=ho("cc.ConstantForce"),K0=go(98),Z0=mo(_1),J0=yo("Components/ConstantForce"),$0=fo({displayOrder:0}),e1=fo({displayOrder:1}),t1=fo({displayOrder:2}),i1=fo({displayOrder:3}),Q0(n1=K0(n1=Z0(n1=J0(n1=bo(n1=vo((a1=m((r1=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))))._rigidbody=null,v(t,"_force",a1,u(t)),v(t,"_localForce",s1,u(t)),v(t,"_torque",o1,u(t)),v(t,"_localTorque",l1,u(t)),t._mask=0,t}return p(a,Bv),l(a,[{key:"onLoad",value:function(){this._rigidbody=this.node.getComponent(_1),this._maskUpdate(this._force,1),this._maskUpdate(this._localForce,2),this._maskUpdate(this._torque,4),this._maskUpdate(this._localTorque,8)}},{key:"lateUpdate",value:function(e){null!=this._rigidbody&&0!=this._mask&&(1&this._mask&&this._rigidbody.applyForce(this._force),2&this._mask&&this._rigidbody.applyLocalForce(this.localForce),4&this._mask&&this._rigidbody.applyTorque(this._torque),8&this._mask&&this._rigidbody.applyLocalTorque(this._localTorque))}},{key:"_maskUpdate",value:function(e,t){e.strictEquals(Fi.ZERO)?this._mask&=~t:this._mask|=t}},{key:"force",get:function(){return this._force},set:function(e){Fi.copy(this._force,e),this._maskUpdate(this._force,1)}},{key:"localForce",get:function(){return this._localForce},set:function(e){Fi.copy(this._localForce,e),this._maskUpdate(this.localForce,2)}},{key:"torque",get:function(){return this._torque},set:function(e){Fi.copy(this._torque,e),this._maskUpdate(this._torque,4)}},{key:"localTorque",get:function(){return this._localTorque},set:function(e){Fi.copy(this._localTorque,e),this._maskUpdate(this._localTorque,8)}}]),a}()).prototype,"_force",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi}}),s1=m(r1.prototype,"_localForce",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi}}),o1=m(r1.prototype,"_torque",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi}}),l1=m(r1.prototype,"_localTorque",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi}}),m(r1.prototype,"force",[$0],Object.getOwnPropertyDescriptor(r1.prototype,"force"),r1.prototype),m(r1.prototype,"localForce",[e1],Object.getOwnPropertyDescriptor(r1.prototype,"localForce"),r1.prototype),m(r1.prototype,"torque",[t1],Object.getOwnPropertyDescriptor(r1.prototype,"torque"),r1.prototype),m(r1.prototype,"localTorque",[i1],Object.getOwnPropertyDescriptor(r1.prototype,"localTorque"),r1.prototype),n1=r1))||n1)||n1)||n1)||n1)||n1)||n1));cc.ConstantForce=v1,sr(r0,"PhysicsSystem",[{name:"ins",newName:"instance"}]),cc.ColliderComponent=m0,cc.BoxColliderComponent=u1,cc.SphereColliderComponent=h1,cc.RigidBodyComponent=_1,cc.PhysicMaterial=n0;var m1,y1,g1,b1,x1,S1,w1,T1,E1={INITIALIZING:0,PLAYING:1,STOPPED:2},C1=function(){function i(e){var t=this;y(this,i),this._state=E1.STOPPED,this._duration=0,this._eventTarget=void 0,this._onHide=void 0,this._onShow=void 0,this._interrupted=!1,this._blocking=!1,this._duration=e.duration,this._eventTarget=e.eventTarget,this._onHide=function(){t._blocking=!0,t._state===E1.PLAYING&&(t.pause(),t._interrupted=!0)},this._onShow=function(){t._blocking=!1,t._interrupted&&(t.play(),t._interrupted=!1)},cc.game.on(cc.Game.EVENT_HIDE,this._onHide),cc.game.on(cc.Game.EVENT_SHOW,this._onShow)}return l(i,[{key:"getState",value:function(){return this._state}},{key:"getDuration",value:function(){return this._duration}},{key:"destroy",value:function(){cc.game.off(cc.Game.EVENT_HIDE,this._onHide),cc.game.off(cc.Game.EVENT_SHOW,this._onShow)}}]),i}(),A1=(ul.__audioSupport,function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._startTime=0,t._offset=0,t._volume=1,t._loop=!1,t._oneShoting=!1,t._audio=void 0,t._audio=e.clip,t._audio.onPlay(function(){t._state!==E1.PLAYING&&(t._state=E1.PLAYING,t._startTime=performance.now(),t._eventTarget.emit("started"))}),t._audio.onPause(function(){t._state!==E1.STOPPED&&(t._state=E1.STOPPED,t._offset+=performance.now()-t._startTime)}),t._audio.onStop(function(){t._state!==E1.STOPPED&&(t._state=E1.STOPPED,t._offset=0,t._oneShoting&&(t._audio.volume=t._volume,t._audio.loop=t._loop,t._oneShoting=!1))}),t._audio.onEnded(function(){t._state!==E1.STOPPED&&(t._state=E1.STOPPED,t._offset=0,t._eventTarget.emit("ended"),t._oneShoting&&(t._audio.volume=t._volume,t._audio.loop=t._loop,t._oneShoting=!1))}),t._audio.onError(function(e){return console.error(e.errMsg)}),wx.onAudioInterruptionBegin(t._onHide),wx.onAudioInterruptionEnd(t._onShow),t}return p(i,C1),l(i,[{key:"play",value:function(){this._audio&&this._state!==E1.PLAYING&&(this._blocking?this._interrupted=!0:this._audio.play())}},{key:"pause",value:function(){this._audio&&this._state===E1.PLAYING&&this._audio.pause()}},{key:"stop",value:function(){this._audio&&this._audio.stop()}},{key:"playOneShot",value:function(e){var t=0<arguments.length&&void 0!==e?e:1;this._audio&&(this._offset=0,this._audio.seek(0),this._audio.volume=t,this._oneShoting||(this._audio.loop=!1,this._oneShoting=!0,this._audio.play()))}},{key:"getCurrentTime",value:function(){if(this._state!==E1.PLAYING)return this._offset/1e3;var e=(performance.now()-this._startTime+this._offset)/1e3;return e>this._duration&&(e-=this._duration,this._startTime+=1e3*this._duration),e}},{key:"setCurrentTime",value:function(e){this._audio&&(this._offset=1e3*pi(e,0,this._duration),this._startTime=performance.now(),this._audio.seek(e))}},{key:"getVolume",value:function(){return this._volume}},{key:"setVolume",value:function(e,t){this._volume=e,this._audio&&(this._audio.volume=e)}},{key:"getLoop",value:function(){return this._loop}},{key:"setLoop",value:function(e){this._loop=e,this._audio&&(this._audio.loop=e)}},{key:"destroy",value:function(){this._audio&&this._audio.destroy(),wx.offAudioInterruptionBegin(this._onHide),wx.offAudioInterruptionEnd(this._onShow),_(g(i.prototype),"destroy",this).call(this)}}]),i}()),k1=vt({WEB_AUDIO:0,DOM_AUDIO:1,WX_GAME_AUDIO:2,UNKNOWN_AUDIO:3}),R1=P2("AudioClip",(m1=ho("cc.AudioClip"),y1=fo({type:k1}),m1((T1=w1=function(){function t(){var e;return y(this,t),v(e=x(this,g(t).call(this)),"_duration",x1,u(e)),v(e,"_loadMode",S1,u(e)),e._audio=null,e._player=null,e.loaded=!1,e}return p(t,Mu),l(t,[{key:"destroy",value:function(){return this._player&&this._player.destroy(),_(g(t.prototype),"destroy",this).call(this)}},{key:"play",value:function(){this._player&&this._player.play()}},{key:"pause",value:function(){this._player&&this._player.pause()}},{key:"stop",value:function(){this._player&&this._player.stop()}},{key:"playOneShot",value:function(e){this._player&&this._player.playOneShot(e)}},{key:"setCurrentTime",value:function(e){this._player&&this._player.setCurrentTime(e)}},{key:"getCurrentTime",value:function(){return this._player?this._player.getCurrentTime():0}},{key:"getDuration",value:function(){return this._player?this._player.getDuration():this._duration}},{key:"setVolume",value:function(e,t){this._player&&this._player.setVolume(e,t||!1)}},{key:"getVolume",value:function(){return this._player?this._player.getVolume():1}},{key:"setLoop",value:function(e){this._player&&this._player.setLoop(e)}},{key:"getLoop",value:function(){return!!this._player&&this._player.getLoop()}},{key:"_nativeAsset",set:function(e){var t;(this._audio=e)?(t=A1,this._loadMode=k1.WX_GAME_AUDIO,this._player=new t({clip:e,duration:this._duration,eventTarget:this}),this.loaded=!0,this.emit("load")):(this._player=null,this._loadMode=k1.UNKNOWN_AUDIO,this._duration=0,this.loaded=!1)},get:function(){return this._audio}},{key:"loadMode",get:function(){return this._loadMode}},{key:"state",get:function(){return this._player?this._player.getState():E1.INITIALIZING}}]),t}(),w1.PlayingState=E1,w1.AudioType=k1,w1.preventDeferredLoadDependents=!0,x1=m((b1=T1).prototype,"_duration",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),S1=m(b1.prototype,"_loadMode",[y1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return k1.UNKNOWN_AUDIO}}),g1=b1))||g1));cc.AudioClip=R1;var O1,M1,I1,L1,z1,B1,P1,D1,F1,N1,U1=ul.__audioSupport,V1=U1.format;function G1(e,t){var i=wx.createInnerAudioContext();i.src=e.url,i.onCanplay(function(){return t(null,i)})}function H1(e,t){if(0===V1.length)return new Error(G(4927));G1(e,t)}Kw.downloader.addHandlers({mp3:H1,ogg:H1,wav:H1,m4a:H1});var q1=P2("AudioSourceComponent",(O1=ho("cc.AudioSourceComponent"),M1=yo("Components/AudioSource"),I1=fo(R1),L1=fo({type:R1}),O1(z1=M1((P1=m((B1=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"_clip",P1,u(t)),v(t,"_loop",D1,u(t)),v(t,"_playOnAwake",F1,u(t)),v(t,"_volume",N1,u(t)),t._cachedCurrentTime=0,t}return p(a,Bv),l(a,[{key:"onLoad",value:function(){this._syncStates(),this._playOnAwake&&this.play()}},{key:"play",value:function(){this._clip&&(this.playing?this.currentTime=0:this._clip.play())}},{key:"pause",value:function(){this._clip&&this._clip.pause()}},{key:"stop",value:function(){this._clip&&this._clip.stop()}},{key:"playOneShot",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:1;e.playOneShot(this._volume*i)}},{key:"_syncStates",value:function(){this._clip&&(this._clip.setCurrentTime(this._cachedCurrentTime),this._clip.setLoop(this._loop),this._clip.setVolume(this._volume,!0),this._volume=this._clip.getVolume())}},{key:"clip",set:function(e){this._clip=e,this._syncStates()},get:function(){return this._clip}},{key:"loop",set:function(e){this._loop=e,this._clip&&this._clip.setLoop(e)},get:function(){return this._loop}},{key:"playOnAwake",set:function(e){this._playOnAwake=e},get:function(){return this._playOnAwake}},{key:"volume",set:function(e){isNaN(e)?console.warn("illegal audio volume!"):(e=pi(e,0,1),this._clip?(this._clip.setVolume(e),this._volume=this._clip.getVolume()):this._volume=e)},get:function(){return this._volume}},{key:"currentTime",set:function(e){isNaN(e)?console.warn("illegal audio time!"):(e=pi(e,0,this.duration),this._cachedCurrentTime=e,this._clip&&this._clip.setCurrentTime(this._cachedCurrentTime))},get:function(){return this._clip?this._clip.getCurrentTime():this._cachedCurrentTime}},{key:"duration",get:function(){return this._clip?this._clip.getDuration():0}},{key:"state",get:function(){return this._clip?this._clip.state:R1.PlayingState.INITIALIZING}},{key:"playing",get:function(){return this.state===R1.PlayingState.PLAYING}}]),a}()).prototype,"_clip",[I1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),D1=m(B1.prototype,"_loop",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),F1=m(B1.prototype,"_playOnAwake",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),N1=m(B1.prototype,"_volume",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),m(B1.prototype,"clip",[L1],Object.getOwnPropertyDescriptor(B1.prototype,"clip"),B1.prototype),m(B1.prototype,"loop",[fo],Object.getOwnPropertyDescriptor(B1.prototype,"loop"),B1.prototype),m(B1.prototype,"playOnAwake",[fo],Object.getOwnPropertyDescriptor(B1.prototype,"playOnAwake"),B1.prototype),m(B1.prototype,"volume",[fo],Object.getOwnPropertyDescriptor(B1.prototype,"volume"),B1.prototype),z1=B1))||z1)||z1));cc.AudioSourceComponent=q1;function j1(e,t,i,n){if(y(this,j1),this.id=void 0,this.tween=void 0,this._opts=void 0,this._props=void 0,this.id=j1._idCounter++,this.tween=new W1.Tween(e),this._props=i,this._opts=n,this.tween.to(i,t),null!=n){if(null!=n.delay&&this.tween.delay(n.delay),null!=n.repeat&&this.tween.repeat(n.repeat),null!=n.repeatDelay&&this.tween.repeatDelay(n.repeatDelay),null!=n.yoyo&&this.tween.yoyo(n.yoyo),null!=n.easing)if("string"==typeof n.easing){var r=n.easing.split("-");if(2<=r.length){var a=r[0],s=r[1];"Linear"===a?"None"===s&&this.tween.easing(W1.Easing[a][s]):"In"!==s&&"Out"!==s&&"InOut"!==s||this.tween.easing(W1.Easing[a][s])}}else this.tween.easing(n.easing);if(null!=n.interpolation)if("string"==typeof n.interpolation){var o=n.interpolation.split("-");if(1<=o.length){var l=o[0];this.tween.interpolation(W1.Interpolation[l])}}else this.tween.interpolation(n.interpolation);null!=n.onStart&&this.tween.onStart(n.onStart),null!=n.onStop&&this.tween.onStop(n.onStop),null!=n.onUpdate&&this.tween.onUpdate(n.onUpdate),null!=n.onComplete&&this.tween.onComplete(n.onComplete)}}var W1=O$(function(e,t){function i(){this._tweens={},this._tweensAddedDuringUpdate={}}i.prototype={getAll:function(){return Object.keys(this._tweens).map(function(e){return this._tweens[e]}.bind(this))},removeAll:function(){this._tweens={}},add:function(e){this._tweens[e.getId()]=e,this._tweensAddedDuringUpdate[e.getId()]=e},remove:function(e){delete this._tweens[e.getId()],delete this._tweensAddedDuringUpdate[e.getId()]},update:function(e,t){var i=Object.keys(this._tweens);if(0===i.length)return!1;for(e=void 0!==e?e:l.now();0<i.length;){this._tweensAddedDuringUpdate={};for(var n=0;n<i.length;n++){var r=this._tweens[i[n]];r&&!1===r.update(e)&&(r._isPlaying=!1,t||delete this._tweens[i[n]])}i=Object.keys(this._tweensAddedDuringUpdate)}return!0}};var n,l=new i;l.Group=i,l._nextId=0,l.nextId=function(){return l._nextId++},"undefined"==typeof self&&"undefined"!=typeof process&&process.hrtime?l.now=function(){var e=process.hrtime();return 1e3*e[0]+e[1]/1e6}:"undefined"!=typeof self&&void 0!==self.performance&&void 0!==self.performance.now?l.now=self.performance.now.bind(self.performance):void 0!==Date.now?l.now=Date.now:l.now=function(){return(new Date).getTime()},l.Tween=function(e,t){this._object=e,this._valuesStart={},this._valuesEnd={},this._valuesStartRepeat={},this._duration=1e3,this._repeat=0,this._repeatDelayTime=void 0,this._yoyo=!1,this._isPlaying=!1,this._reversed=!1,this._delayTime=0,this._startTime=null,this._easingFunction=l.Easing.Linear.None,this._interpolationFunction=l.Interpolation.Linear,this._chainedTweens=[],this._onStartCallback=null,this._onStartCallbackFired=!1,this._onUpdateCallback=null,this._onRepeatCallback=null,this._onCompleteCallback=null,this._onStopCallback=null,this._group=t||l,this._id=l.nextId(),this._onCompleteCallbackForCocos=null},l.Tween.prototype={getId:function(){return this._id},isPlaying:function(){return this._isPlaying},to:function(e,t){return this._valuesEnd=JSON.parse(JSON.stringify(e)),void 0!==t&&(this._duration=t),this},duration:function(e){return this._duration=e,this},start:function(e){return this._group.add(this),this._isPlaying=!0,this._onStartCallbackFired=!1,this._startTime=void 0!==e?"string"==typeof e?l.now()+parseFloat(e):e:l.now(),this._startTime+=this._delayTime,l._recursiveObjetCopy(this._valuesEnd,this._valuesStart,this._valuesStartRepeat,this._object),this},stop:function(){return this._isPlaying&&(this._group.remove(this),this._isPlaying=!1,null!==this._onStopCallback&&this._onStopCallback(this._object),this.stopChainedTweens()),this},end:function(){return this.update(1/0),this},stopChainedTweens:function(){for(var e=0,t=this._chainedTweens.length;e<t;e++)this._chainedTweens[e].stop()},group:function(e){return this._group=e,this},delay:function(e){return this._delayTime=e,this},repeat:function(e){return this._repeat=e,this},repeatDelay:function(e){return this._repeatDelayTime=e,this},yoyo:function(e){return this._yoyo=e,this},easing:function(e){return this._easingFunction=e,this},interpolation:function(e){return this._interpolationFunction=e,this},chain:function(){return this._chainedTweens=arguments,this},onStart:function(e){return this._onStartCallback=e,this},onUpdate:function(e){return this._onUpdateCallback=e,this},onRepeat:function(e){return this._onRepeatCallback=e,this},onComplete:function(e){return this._onCompleteCallback=e,this},onStop:function(e){return this._onStopCallback=e,this},update:function(e){var t,i,n;if(e<this._startTime)return!0;if(!1===this._onStartCallbackFired&&(null!==this._onStartCallback&&this._onStartCallback(this._object),this._onStartCallbackFired=!0),i=(e-this._startTime)/this._duration,i=0===this._duration||1<i?1:i,n=this._easingFunction(i),l._recursiveObjetUpdate(this._valuesEnd,this._valuesStart,n,this._object,this),null!==this._onUpdateCallback&&this._onUpdateCallback(this._object,i),1!==i)return!0;if(0<this._repeat){for(t in isFinite(this._repeat)&&this._repeat--,this._valuesStartRepeat){if("string"==typeof this._valuesEnd[t]&&(this._valuesStartRepeat[t]=this._valuesStartRepeat[t]+parseFloat(this._valuesEnd[t])),this._yoyo){var r=this._valuesStartRepeat[t];this._valuesStartRepeat[t]=this._valuesEnd[t],this._valuesEnd[t]=r}this._valuesStart[t]=this._valuesStartRepeat[t]}return this._yoyo&&(this._reversed=!this._reversed),void 0!==this._repeatDelayTime?this._startTime=e+this._repeatDelayTime:this._startTime=e+this._delayTime,null!==this._onRepeatCallback&&this._onRepeatCallback(this._object),!0}if(null!==this._onCompleteCallback&&this._onCompleteCallback(this._object),null!==this._onCompleteCallbackForCocos)this._onCompleteCallbackForCocos(this);else for(var a=0,s=this._chainedTweens.length;a<s;a++)this._chainedTweens[a].start(this._startTime+this._duration);return!1},cc_onCompleteCallback:function(e){this._onCompleteCallbackForCocos=e}},l._recursiveObjetUpdate=function(e,t,i,n,r){var a,s;for(var o in e)a=e[o],s=t[o],a instanceof Array?n[o]=r._interpolationFunction(a,i):("string"==typeof a&&(a="+"===a.charAt(0)||"-"===a.charAt(0)?s+parseFloat(a):parseFloat(a)),"number"==typeof a?n[o]=s+(a-s)*i:"object"==typeof a&&l._recursiveObjetUpdate(a,s,i,n[o],r))},l._recursiveObjetCopy=function(e,t,i,n){for(var r in e){if(e[r]instanceof Array){if(0===e[r].length)continue;e[r]=[n[r]].concat(e[r])}void 0!==n[r]&&("object"==typeof n[r]?(t[r]={},i[r]={},l._recursiveObjetCopy(e[r],t[r],i[r],n[r])):(t[r]=n[r],"string"==typeof t[r]&&(t[r]*=1),i[r]=t[r]||0))}},l.Easing={Linear:{None:function(e){return e}},Quadratic:{In:function(e){return e*e},Out:function(e){return e*(2-e)},InOut:function(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)}},Cubic:{In:function(e){return e*e*e},Out:function(e){return--e*e*e+1},InOut:function(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)}},Quartic:{In:function(e){return e*e*e*e},Out:function(e){return 1- --e*e*e*e},InOut:function(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)}},Quintic:{In:function(e){return e*e*e*e*e},Out:function(e){return--e*e*e*e*e+1},InOut:function(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)}},Sinusoidal:{In:function(e){return 1-Math.cos(e*Math.PI/2)},Out:function(e){return Math.sin(e*Math.PI/2)},InOut:function(e){return.5*(1-Math.cos(Math.PI*e))}},Exponential:{In:function(e){return 0===e?0:Math.pow(1024,e-1)},Out:function(e){return 1===e?1:1-Math.pow(2,-10*e)},InOut:function(e){return 0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(2-Math.pow(2,-10*(e-1)))}},Circular:{In:function(e){return 1-Math.sqrt(1-e*e)},Out:function(e){return Math.sqrt(1- --e*e)},InOut:function(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)}},Elastic:{In:function(e){return 0===e?0:1===e?1:-Math.pow(2,10*(e-1))*Math.sin(5*(e-1.1)*Math.PI)},Out:function(e){return 0===e?0:1===e?1:Math.pow(2,-10*e)*Math.sin(5*(e-.1)*Math.PI)+1},InOut:function(e){return 0===e?0:1===e?1:(e*=2)<1?-.5*Math.pow(2,10*(e-1))*Math.sin(5*(e-1.1)*Math.PI):.5*Math.pow(2,-10*(e-1))*Math.sin(5*(e-1.1)*Math.PI)+1}},Back:{In:function(e){return e*e*(2.70158*e-1.70158)},Out:function(e){return--e*e*(2.70158*e+1.70158)+1},InOut:function(e){var t=2.5949095;return(e*=2)<1?e*e*((1+t)*e-t)*.5:.5*((e-=2)*e*((1+t)*e+t)+2)}},Bounce:{In:function(e){return 1-l.Easing.Bounce.Out(1-e)},Out:function(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375},InOut:function(e){return e<.5?.5*l.Easing.Bounce.In(2*e):.5*l.Easing.Bounce.Out(2*e-1)+.5}}},l.Interpolation={Linear:function(e,t){var i=e.length-1,n=i*t,r=Math.floor(n),a=l.Interpolation.Utils.Linear;return t<0?a(e[0],e[1],n):1<t?a(e[i],e[i-1],i-n):a(e[r],e[i<r+1?i:r+1],n-r)},Bezier:function(e,t){for(var i=0,n=e.length-1,r=Math.pow,a=l.Interpolation.Utils.Bernstein,s=0;s<=n;s++)i+=r(1-t,n-s)*r(t,s)*e[s]*a(n,s);return i},CatmullRom:function(e,t){var i=e.length-1,n=i*t,r=Math.floor(n),a=l.Interpolation.Utils.CatmullRom;return e[0]===e[i]?(t<0&&(r=Math.floor(n=i*(1+t))),a(e[(r-1+i)%i],e[r],e[(r+1)%i],e[(r+2)%i],n-r)):t<0?e[0]-(a(e[0],e[0],e[1],e[1],-n)-e[0]):1<t?e[i]-(a(e[i],e[i],e[i-1],e[i-1],n-i)-e[i]):a(e[r?r-1:0],e[r],e[i<r+1?i:r+1],e[i<r+2?i:r+2],n-r)},Utils:{Linear:function(e,t,i){return(t-e)*i+e},Bernstein:function(e,t){var i=l.Interpolation.Utils.Factorial;return i(e)/i(t)/i(e-t)},Factorial:(n=[1],function(e){var t=1;if(n[e])return n[e];for(var i=e;1<i;i--)t*=i;return n[e]=t}),CatmullRom:function(e,t,i,n,r){var a=.5*(i-e),s=.5*(n-t),o=r*r;return r*o*(2*t-2*i+a+s)+(-3*t+3*i-2*a-s)*o+a*r+t}}},e.exports=l});W1.TWEEN;function X1(e,t){e.__cc_wrapper__=t}j1._idCounter=0,cc.TweenAction=j1,window.TWEEN=W1;var Y1=function(){function e(){y(this,e),this.quene=[]}return l(e,[{key:"updateChain",value:function(){for(var e=this.length,t=0,i=1;t<e;){var n=this.quene[t];if(i<e){if(0<n.length){var r=this.quene[i];if(0===n.repeatTimes){if(0<r.length)n.lastAction.tween.chain(r.lastAction.tween)}else this.wrapAndEvent(n)}}else if(0<n.length&&0!==n.repeatTimes){var a=n.lastAction;X1(a.tween,n),a.tween.cc_onCompleteCallback(this._onComplete.bind(this))}++t,++i}}},{key:"start",value:function(){this.updateChain(),0<this.length&&this.firstUnion.start()}},{key:"stop",value:function(){for(var e=0;e<this.length;e++){if(this.quene[e].stop())break}}},{key:"union",value:function(e){this.quene.push(e)}},{key:"isExistUnion",value:function(e){return-1!==this.quene.indexOf(e)}},{key:"wrapAndEvent",value:function(e){var t=e.lastAction;X1(t.tween,e),t.tween.cc_onCompleteCallback(this._onComplete.bind(this))}},{key:"_onComplete",value:function(e){var t=function(e){return e.__cc_wrapper__}(e);if(0<t.repeatTimes&&0<t.lastCount){t.runTimes++;var i=this.quene.indexOf(t);if(0<=i){for(var n=0;n<i;n++)this.quene[n].runTimes=0;this.firstUnion.start()}}else if(-1===t.repeatTimes){var r=this.quene.indexOf(t);if(0<=r){for(var a=0;a<r;a++)this.quene[a].runTimes=0;this.firstUnion.start()}}else{t.onCompeleteCallback&&t.onCompeleteCallback(e._object);var s=this.quene.indexOf(t);if(s!==this.length-1)this.quene[s+1].start()}}},{key:"length",get:function(){return this.quene.length}},{key:"firstUnion",get:function(){return this.quene[0]}},{key:"lastUnion",get:function(){return this.quene[this.quene.length-1]}}]),e}();cc.TweenCommand=Y1;var Q1=function(){function t(e){y(this,t),this.id=void 0,this._actions=[],this._target=void 0,this._runTimes=0,this._repeatTimes=0,this._onCompeleteCallback=void 0,this._delay=0,this.id=t._idCounter++,this._target=e}return l(t,[{key:"actions",get:function(){return this._actions}},{key:"length",get:function(){return this._actions.length}},{key:"firstAction",get:function(){return this._actions[0]}},{key:"lastAction",get:function(){return this._actions[this._actions.length-1]}},{key:"target",get:function(){return this._target}},{key:"runTimes",get:function(){return this._runTimes},set:function(e){this._runTimes=e}},{key:"repeatTimes",get:function(){return this._repeatTimes},set:function(e){this._repeatTimes=e}},{key:"lastCount",get:function(){return this._repeatTimes-this._runTimes}},{key:"onCompeleteCallback",set:function(e){this._onCompeleteCallback=e},get:function(){return this._onCompeleteCallback}},{key:"delay",get:function(){return this._delay},set:function(e){this._delay=e}}]),l(t,[{key:"start",value:function(){if(0<this.length)if(0<this.delay){var e=this.actions[0].tween;setTimeout(e.start.bind(e),this.delay)}else this.actions[0].tween.start()}},{key:"stop",value:function(){for(var e=0;e<this._actions.length;e++){var t=this._actions[e].tween;if(t.isPlaying())return t.stop(),!0}return!1}}]),t}();Q1._idCounter=0,cc.TweenUnion=Q1;var K1=P2("Tween",function(){function r(e){y(this,r),this._command=new Y1,this._default=void 0,this._uionDirty=!1,this._default=new Q1(e)}return l(r,null,[{key:"_recursiveForBy",value:function(e){var t;for(var i in e)if("number"==typeof(t=e[i])){var n=0<t?"+":"-";e[i]=n+t}else"object"===de(t)&&r._recursiveForBy(t)}}]),l(r,[{key:"to",value:function(e,t,i){this._uionDirty&&(this._default=new Q1(this._default.target),this._uionDirty=!1);var n=new j1(this._default.target,1e3*e,t,i);return 0<this._default.length&&this._default.actions[this._default.length-1].tween.chain(n.tween),this._default.actions.push(n),this}},{key:"by",value:function(e,t,i){this._uionDirty&&(this._default=new Q1(this._default.target),this._uionDirty=!1),r._recursiveForBy(t);var n=new j1(this._default.target,1e3*e,t,i);return 0<this._default.length&&this._default.actions[this._default.length-1].tween.chain(n.tween),this._default.actions.push(n),this}},{key:"union",value:function(){return this._command.isExistUnion(this._default)||(this._command.union(this._default),this._uionDirty=!0),this}},{key:"start",value:function(){return 0<this._default.length&&(this._command.isExistUnion(this._default)||this._command.union(this._default)),this._command.start(),this}},{key:"stop",value:function(){return this._command.stop(),this}},{key:"repeat",value:function(e){return this._uionDirty?this._default.repeatTimes=e:0<this._default.length&&this._default.lastAction.tween.repeat(e),this}},{key:"repeatForever",value:function(){return this._uionDirty?this._default.repeatTimes=-1:0<this._default.length&&this._default.lastAction.tween.repeat(1/0),this}},{key:"delay",value:function(e){return this._uionDirty?this._default.delay=1e3*e:0<this._default.length&&this._default.lastAction.tween.delay(1e3*e),this}},{key:"call",value:function(e){return this._uionDirty?this._default.onCompeleteCallback=e:0<this._default.length&&this._default.lastAction.tween.onComplete(e),this}}]),r}());function Z1(e){return new K1(e)}cc.Tween=K1,cc.tweenUtil=Z1;var J1=function(){function e(){return y(this,e),x(this,g(e).apply(this,arguments))}return p(e,Hp),l(e,[{key:"postUpdate",value:function(e){window.TWEEN&&window.TWEEN.update(performance.now())}}]),e}();function $1(e){return C("tween' is deprecated, please use 'tweenUtil' instead "),Z1(e)}J1.ID="tween",Yb.on(Xb.EVENT_INIT,function(){var e=new J1;Yb.registerSystem(J1.ID,e,100)}),cc.tween=$1;P2("HeightField",function(){function n(e,t){y(this,n),this.data=new Uint16Array,this.w=0,this.h=0,this.w=e,this.h=t,this.data=new Uint16Array(e*t);for(var i=0;i<e*t;++i)this.data[i]=0}return l(n,[{key:"set",value:function(e,t,i){this.data[t*this.w+e]=i}},{key:"get",value:function(e,t){return this.data[t*this.w+e]}},{key:"getClamp",value:function(e,t){return e=pi(e,0,this.w-1),t=pi(t,0,this.h-1),this.get(e,t)}},{key:"getAt",value:function(e,t){var i=e/this.w,n=t/this.h,r=Math.floor(i),a=Math.floor(n),s=r+1,o=a+1,l=i-r,c=n-a;r=pi(r,0,this.w-1),a=pi(a,0,this.h-1),s=pi(s,0,this.w-1),o=pi(o,0,this.h-1);var u=this.get(r,a),h=this.get(s,a),f=this.get(r,o),d=this.get(s,o),p=.5*(h+f);return l+c<=1?d=p-u+p:u=p-d+p,(u*(1-l)+h*l)*(1-c)+(f*(1-l)+d*l)*c}}]),n}()),P2("TERRAIN_MAX_LEVELS",4),P2("TERRAIN_MAX_BLEND_LAYERS",4);var e2,t2,i2,n2,r2,a2,s2,o2,l2,c2,u2,h2,f2,d2,p2,_2,v2,m2,y2,g2,b2,x2,S2,w2,T2,E2,C2,A2=P2("TERRAIN_MAX_LAYER_COUNT",256),k2=P2("TERRAIN_BLOCK_TILE_COMPLEXITY",32),R2=P2("TERRAIN_BLOCK_VERTEX_COMPLEXITY",33),O2=P2("TERRAIN_BLOCK_VERTEX_SIZE",8),M2=(P2("TERRAIN_NORTH_INDEX",0),P2("TERRAIN_SOUTH_INDEX",1),P2("TERRAIN_WEST_INDEX",2),P2("TERRAIN_EAST_INDEX",3),P2("TerrainInfo",ho("cc.TerrainInfo")((i2=m((t2=function(){function e(){y(this,e),v(this,"tileSize",i2,this),v(this,"blockCount",n2,this),v(this,"weightMapSize",r2,this),v(this,"lightMapSize",a2,this),this._tileCount=[0,0],this._vertexCount=[0,0],this._size=new jn(0,0)}return l(e,[{key:"initialize",value:function(){this._tileCount[0]=this.blockCount[0]*k2,this._tileCount[1]=this.blockCount[1]*k2,this._vertexCount[0]=this._tileCount[0]+1,this._vertexCount[1]=this._tileCount[1]+1,this._size.width=this._tileCount[0]*this.tileSize,this._size.height=this._tileCount[1]*this.tileSize}},{key:"tileCount",get:function(){return this._tileCount}},{key:"vertexCount",get:function(){return this._vertexCount}},{key:"size",get:function(){return this._size}}]),e}()).prototype,"tileSize",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),n2=m(t2.prototype,"blockCount",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[1,1]}}),r2=m(t2.prototype,"weightMapSize",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 128}}),a2=m(t2.prototype,"lightMapSize",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 128}}),e2=t2))||e2)),I2=P2("TerrainLayer",ho("cc.TerrainLayer")((l2=m((o2=function e(){y(this,e),v(this,"detailMap",l2,this),v(this,"tileSize",c2,this)}).prototype,"detailMap",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),c2=m(o2.prototype,"tileSize",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),s2=o2))||s2),L2=(P2("TerrainVertex",function e(){y(this,e),this.position=new Fi(0,0,0),this.normal=new Fi(0,1,0),this.uv=new Mi(0,0)}),P2("TerrainRenderable",function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))))._model=null,t._meshData=null,t._brushMaterial=null,t._currentMaterial=null,t._currentMaterialLayers=0,t}return p(a,kC),l(a,[{key:"destroy",value:function(){this._invalidMaterial(),null!=this._model&&(this._getRenderScene().destroyModel(this._model),this._model=null),_(g(a.prototype),"destroy",this).call(this)}},{key:"_invalidMaterial",value:function(){null!=this._currentMaterial&&(this._clearMaterials(),(this._currentMaterial=null)!=this._model&&(this._model.enabled=!1))}},{key:"_updateMaterial",value:function(e,t){if(null!=this._meshData&&null!=this._model){var i=e.getMaxLayer();if(null==this._currentMaterial||i!==this._currentMaterialLayers){if(this._currentMaterial=new cp,this._currentMaterial.initialize({effectAsset:lp.get("builtin-terrain"),defines:e._getMaterialDefines(i)}),null!==this._brushMaterial)this._currentMaterial.passes.push(this._brushMaterial.passes[0]);t&&this._model.initSubModel(0,this._meshData,this._currentMaterial),this.setMaterial(this._currentMaterial,0),this._currentMaterialLayers=i,this._model.enabled=!0}}}},{key:"_onMaterialModified",value:function(e,t){null!=this._model&&this._onRebuildPSO(e,t||this._getBuiltinMaterial())}},{key:"_onRebuildPSO",value:function(e,t){this._model&&this._model.setSubModelMaterial(e,t)}},{key:"_clearMaterials",value:function(){null!=this._model&&this._onMaterialModified(0,null)}},{key:"_getBuiltinMaterial",value:function(){return kd.get("missing-material")}}]),a}())),z2=P2("TerrainBlockInfo",ho("cc.TerrainBlockInfo")((f2=m((h2=function e(){y(this,e),v(this,"layers",f2,this)}).prototype,"layers",[fo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[-1,-1,-1,-1]}}),u2=h2))||u2),B2=P2("TerrainBlock",function(){function n(e,t,i){y(this,n),this._terrain=void 0,this._info=void 0,this._node=void 0,this._renderable=void 0,this._index=[1,1],this._weightMap=null,this._terrain=e,this._info=e.getBlockInfo(t,i),this._index[0]=t,this._index[1]=i,this._node=new Ey(""),this._node.setParent(this._terrain.node),this._node._objFlags|=cc.Object.Flags.DontSave,this._renderable=this._node.addComponent(L2)}return l(n,[{key:"build",value:function(){for(var e=Yb.root.device,t=new Float32Array(O2*R2*R2),i=0,n=0;n<R2;++n)for(var r=0;r<R2;++r){var a=this._index[0]*k2+r,s=this._index[1]*k2+n,o=this._terrain.getPosition(a,s),l=this._terrain.getNormal(a,s),c=new Mi(r/k2,n/k2);t[i++]=o.x,t[i++]=o.y,t[i++]=o.z,t[i++]=l.x,t[i++]=l.y,t[i++]=l.z,t[i++]=c.x,t[i++]=c.y}var u=e.createBuffer({usage:zl.VERTEX|zl.TRANSFER_DST,memUsage:Pl.HOST|Pl.DEVICE,size:O2*Float32Array.BYTES_PER_ELEMENT*R2*R2,stride:O2*Float32Array.BYTES_PER_ELEMENT});u.update(t);var h=[{name:kl.ATTR_POSITION,format:Il.RGB32F},{name:kl.ATTR_NORMAL,format:Il.RGB32F},{name:kl.ATTR_TEX_COORD,format:Il.RG32F}];this._renderable._meshData={attributes:h,vertexBuffers:[u],indexBuffer:this._terrain.getSharedIndexBuffer(),primitiveMode:Gl.TRIANGLE_LIST},this._renderable._model=this._renderable._getRenderScene().createModel(vf,this._node),this._updateWeightMap(),this._updateMaterial(!0)}},{key:"rebuild",value:function(){this._updateHeight(),this._updateWeightMap(),this._renderable._invalidMaterial(),this._updateMaterial(!1)}},{key:"destroy",value:function(){null!=this._renderable&&this._renderable.destroy(),null!=this._node&&this._node.destroy(),null!=this._weightMap&&this._weightMap.destroy()}},{key:"update",value:function(){this._updateMaterial(!1);var e=this._renderable._currentMaterial;if(null!=e){var t=this.getMaxLayer(),i=new Wi(1,1,1,1);if(0===t)if(-1!==this.layers[0]){var n=this._terrain.getLayer(this.layers[0]);null!=n&&(i.x=1/n.tileSize),e.setProperty("detailMap0",null!=n?n.detailMap:null)}else e.setProperty("detailMap0",kd.get("default-texture"));else if(1===t){var r=this._terrain.getLayer(this.layers[0]),a=this._terrain.getLayer(this.layers[1]);null!=r&&(i.x=1/r.tileSize),null!=a&&(i.y=1/a.tileSize),e.setProperty("weightMap",this._weightMap),e.setProperty("detailMap0",null!=r?r.detailMap:null),e.setProperty("detailMap1",null!=a?a.detailMap:null)}else if(2===t){var s=this._terrain.getLayer(this.layers[0]),o=this._terrain.getLayer(this.layers[1]),l=this._terrain.getLayer(this.layers[2]);null!=s&&(i.x=1/s.tileSize),null!=o&&(i.y=1/o.tileSize),null!=l&&(i.z=1/l.tileSize),e.setProperty("weightMap",this._weightMap),e.setProperty("detailMap0",null!=s?s.detailMap:null),e.setProperty("detailMap1",null!=o?o.detailMap:null),e.setProperty("detailMap2",null!=l?l.detailMap:null)}else if(3===t){var c=this._terrain.getLayer(this.layers[0]),u=this._terrain.getLayer(this.layers[1]),h=this._terrain.getLayer(this.layers[2]),f=this._terrain.getLayer(this.layers[3]);null!=c&&(i.x=1/c.tileSize),null!=u&&(i.y=1/u.tileSize),null!=h&&(i.z=1/h.tileSize),null!=f&&(i.z=1/f.tileSize),e.setProperty("weightMap",this._weightMap),e.setProperty("detailMap0",null!=c?c.detailMap:null),e.setProperty("detailMap1",null!=u?u.detailMap:null),e.setProperty("detailMap2",null!=h?h.detailMap:null),e.setProperty("detailMap3",null!=f?f.detailMap:null)}e.setProperty("UVScale",i)}}},{key:"setBrushMaterial",value:function(e){this._renderable._brushMaterial!==e&&(this._renderable._brushMaterial=e,this._renderable._invalidMaterial())}},{key:"getTerrain",value:function(){return this._terrain}},{key:"getIndex",value:function(){return this._index}},{key:"getRect",value:function(){var e=new Zn;return e.x=this._index[0]*k2,e.y=this._index[1]*k2,e.width=k2,e.height=k2,e}},{key:"setLayer",value:function(e,t){this.layers[e]!==t&&(this.layers[e]=t,this._renderable._invalidMaterial(),this._updateMaterial(!1))}},{key:"getLayer",value:function(e){return this.layers[e]}},{key:"getMaxLayer",value:function(){return 0<=this.layers[3]?3:0<=this.layers[2]?2:0<=this.layers[1]?1:0}},{key:"_getMaterialDefines",value:function(e){return 0===e?{LAYERS:1}:1===e?{LAYERS:2}:2===e?{LAYERS:3}:3===e?{LAYERS:4}:{LAYERS:0}}},{key:"_invalidMaterial",value:function(){this._renderable._invalidMaterial()}},{key:"_updateMaterial",value:function(e){this._renderable._updateMaterial(this,e)}},{key:"_updateHeight",value:function(){if(null!=this._renderable._meshData){for(var e=new Float32Array(O2*R2*R2),t=0,i=0;i<R2;++i)for(var n=0;n<R2;++n){var r=this._index[0]*k2+n,a=this._index[1]*k2+i,s=this._terrain.getPosition(r,a),o=this._terrain.getNormal(r,a),l=new Mi(n/R2,i/R2);e[t++]=s.x,e[t++]=s.y,e[t++]=s.z,e[t++]=o.x,e[t++]=o.y,e[t++]=o.z,e[t++]=l.x,e[t++]=l.y}this._renderable._meshData.vertexBuffers[0].update(e)}}},{key:"_updateWeightMap",value:function(){if(0!==this.getMaxLayer()){null==this._weightMap&&(this._weightMap=new vh,this._weightMap.create(this._terrain.info.weightMapSize,this._terrain.info.weightMapSize,mu.RGBA8888),this._weightMap.setFilters(xu.LINEAR,xu.LINEAR),this._weightMap.setWrapMode(gu.CLAMP_TO_EDGE,gu.CLAMP_TO_EDGE));for(var e=new Uint8Array(this._terrain.info.weightMapSize*this._terrain.info.weightMapSize*4),t=0,i=0;i<this._terrain.info.weightMapSize;++i)for(var n=0;n<this._terrain.info.weightMapSize;++n){var r=this._index[0]*this._terrain.info.weightMapSize+n,a=this._index[1]*this._terrain.info.weightMapSize+i,s=this._terrain.getWeight(r,a);e[4*t+0]=Math.floor(255*s.x),e[4*t+1]=Math.floor(255*s.y),e[4*t+2]=Math.floor(255*s.z),e[4*t+3]=Math.floor(255*s.w),t+=1}this._weightMap.uploadData(e.buffer)}else null!=this._weightMap&&(this._weightMap.destroy(),this._weightMap=null)}},{key:"layers",get:function(){return this._info.layers}}]),n}());P2("Terrain",(d2=ho("cc.Terrain"),p2=yo("Components/Terrain"),_2=fo({type:M2,visible:!0}),v2=fo({type:I2,visible:!0}),m2=fo({visible:!1}),y2=fo({visible:!1}),g2=fo({visible:!1}),d2(b2=p2(b2=vo((S2=m((x2=function(){function i(){var e;y(this,i),v(e=x(this,g(i).call(this)),"_info",S2,u(e)),v(e,"_layers",w2,u(e)),v(e,"_heights",T2,u(e)),v(e,"_weights",E2,u(e)),v(e,"_blockInfos",C2,u(e)),e._normals=[],e._blocks=[],e._sharedIndexBuffer=null;for(var t=0;t<A2;++t)e._layers.push(null);return e}return p(i,Bv),l(i,[{key:"build",value:function(e){return this._info.tileSize=e.tileSize,this._info.blockCount[0]=e.blockCount[0],this._info.blockCount[1]=e.blockCount[1],this._info.weightMapSize=e.weightMapSize,this._info.lightMapSize=e.lightMapSize,this._info.initialize(),this._buildImp()}},{key:"rebuild",value:function(e){e.initialize();for(var t=[],i=0;i<e.blockCount[0]*e.blockCount[1];++i)t.push(new z2);for(var n=Math.min(this.info.blockCount[0],e.blockCount[0]),r=Math.min(this.info.blockCount[1],e.blockCount[1]),a=0;a<r;++a)for(var s=0;s<n;++s){var o=a*e.vertexCount[0]+s,l=a*this.info.vertexCount[0]+s;t[o]=this._blockInfos[l]}this._blockInfos=t;var c=this._blocks,u=Array.isArray(c),h=0;for(c=u?c:c[Symbol.iterator]();;){var f;if(u){if(h>=c.length)break;f=c[h++]}else{if((h=c.next()).done)break;f=h.value}f.destroy()}this._blocks=[],this._rebuildHeights(e),this._rebuildWeights(e),this._info.tileSize=e.tileSize,this._info.blockCount[0]=e.blockCount[0],this._info.blockCount[1]=e.blockCount[1],this._info.weightMapSize=e.weightMapSize,this._info.lightMapSize=e.lightMapSize,this._info.initialize(),this._buildNormals();for(var d=0;d<this._info.blockCount[1];++d)for(var p=0;p<this._info.blockCount[0];++p)this._blocks.push(new B2(this,p,d));var _=this._blocks,v=Array.isArray(_),m=0;for(_=v?_:_[Symbol.iterator]();;){var y;if(v){if(m>=_.length)break;y=_[m++]}else{if((m=_.next()).done)break;y=m.value}y.build()}}},{key:"importHeightField",value:function(e,t){for(var i=0,n=0;n<this._info.vertexCount[1];++n)for(var r=0;r<this._info.vertexCount[0];++r){var a=r/this._info.tileCount[0],s=n/this._info.tileCount[1],o=e.getAt(a*e.w,s*e.h)*t;this._heights[i++]=o}this._buildNormals();var l=this._blocks,c=Array.isArray(l),u=0;for(l=c?l:l[Symbol.iterator]();;){var h;if(c){if(u>=l.length)break;h=l[u++]}else{if((u=l.next()).done)break;h=u.value}h._updateHeight()}}},{key:"exportHeightField",value:function(e,t){for(var i=0,n=0;n<e.h;++n)for(var r=0;r<e.w;++r){var a=r/(e.w-1),s=n/(e.h-1),o=a*this._info.size.width,l=s*this._info.size.height,c=this.getHeightAt(o,l);null!=c&&(e.data[i++]=c*t)}}},{key:"onLoad",value:function(){for(var e=Yb.root.device,t=new Uint16Array(k2*k2*6),i=0,n=0;n<k2;++n)for(var r=0;r<k2;++r){var a=n*R2+r,s=n*R2+r+1,o=(n+1)*R2+r,l=(n+1)*R2+r+1;t[i++]=a,t[i++]=o,t[i++]=s,t[i++]=s,t[i++]=o,t[i++]=l}this._sharedIndexBuffer=e.createBuffer({usage:zl.INDEX|zl.TRANSFER_DST,memUsage:Pl.HOST|Pl.DEVICE,size:Uint16Array.BYTES_PER_ELEMENT*k2*k2*6,stride:Uint16Array.BYTES_PER_ELEMENT}),this._sharedIndexBuffer.update(t)}},{key:"onEnable",value:function(){0===this._blocks.length&&this._buildImp()}},{key:"onDisable",value:function(){var e=this._blocks,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._blocks=[]}},{key:"onDestroy",value:function(){for(var e=0;e<this._layers.length;++e)this._layers[e]=null;null!=this._sharedIndexBuffer&&this._sharedIndexBuffer.destroy()}},{key:"onRestore",value:function(){this.onDisable(),this.onLoad(),this._buildImp()}},{key:"update",value:function(e){var t=this._blocks,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.update()}}},{key:"addLayer",value:function(e){for(var t=0;t<this._layers.length;++t)if(null==this._layers[t])return this._layers[t]=e,t;return-1}},{key:"setLayer",value:function(e,t){this._layers[e]=t}},{key:"removeLayer",value:function(e){this._layers[e]=null}},{key:"getLayer",value:function(e){return this._layers[e]}},{key:"getPosition",value:function(e,t){var i=e*this._info.tileSize,n=t*this._info.tileSize,r=this.getHeight(e,t);return new Fi(i,r,n)}},{key:"setHeight",value:function(e,t,i){this._heights[t*this._info.vertexCount[0]+e]=i}},{key:"getHeight",value:function(e,t){return this._heights[t*this._info.vertexCount[0]+e]}},{key:"getHeightClamp",value:function(e,t){return e=pi(e,0,this._info.vertexCount[0]-1),t=pi(t,0,this._info.vertexCount[1]-1),this.getHeight(e,t)}},{key:"getHeightAt",value:function(e,t){var i=e/this._info.vertexCount[0],n=t/this._info.vertexCount[1],r=Math.floor(i),a=Math.floor(n),s=r+1,o=a+1,l=i-r,c=n-a;if(r<0||r>this._info.vertexCount[0]-1||a<0||a>this._info.vertexCount[1]-1)return null;r=pi(r,0,this._info.vertexCount[0]-1),a=pi(a,0,this._info.vertexCount[1]-1),s=pi(s,0,this._info.vertexCount[0]-1),o=pi(o,0,this._info.vertexCount[1]-1);var u=this.getHeight(r,a),h=this.getHeight(s,a),f=this.getHeight(r,o),d=this.getHeight(s,o),p=.5*(h+f);return l+c<=1?d=p-u+p:u=p-d+p,(u*(1-l)+h*l)*(1-c)+(f*(1-l)+d*l)*c}},{key:"_setNormal",value:function(e,t,i){var n=t*this._info.vertexCount[0]+e;this._normals[3*n+0]=i.x,this._normals[3*n+1]=i.y,this._normals[3*n+2]=i.z}},{key:"getNormal",value:function(e,t){var i=t*this._info.vertexCount[0]+e,n=new Fi;return n.x=this._normals[3*i+0],n.y=this._normals[3*i+1],n.z=this._normals[3*i+2],n}},{key:"getNormalAt",value:function(e,t){var i=e/this._info.vertexCount[0],n=t/this._info.vertexCount[1],r=Math.floor(i),a=Math.floor(n),s=r+1,o=a+1,l=i-r,c=n-a;if(r<0||r>this._info.vertexCount[0]-1||a<0||a>this._info.vertexCount[1]-1)return null;r=pi(r,0,this._info.vertexCount[0]-1),a=pi(a,0,this._info.vertexCount[1]-1),s=pi(s,0,this._info.vertexCount[0]-1),o=pi(o,0,this._info.vertexCount[1]-1);var u=this.getNormal(r,a),h=this.getNormal(s,a),f=this.getNormal(r,o),d=this.getNormal(s,o),p=new Fi;Fi.add(p,h,f).multiplyScalar(.5),l+c<=1?(d.set(p),d.subtract(u),d.add(p)):(u.set(p),u.subtract(d),u.add(p));var _=new Fi,v=new Fi,m=new Fi;return Fi.lerp(_,u,h,l),Fi.lerp(v,f,d,l),Fi.lerp(m,_,v,c),m}},{key:"setWeight",value:function(e,t,i){var n=t*this.info.weightMapSize*this.info.blockCount[0]+e;this._weights[4*n+0]=255*i.x,this._weights[4*n+1]=255*i.y,this._weights[4*n+2]=255*i.z,this._weights[4*n+3]=255*i.w}},{key:"getWeight",value:function(e,t){var i=t*this.info.weightMapSize*this.info.blockCount[0]+e,n=new Wi;return n.x=this._weights[4*i+0]/255,n.y=this._weights[4*i+1]/255,n.z=this._weights[4*i+2]/255,n.w=this._weights[4*i+3]/255,n}},{key:"getWeightAt",value:function(e,t){var i=e/this._info.vertexCount[0],n=t/this._info.vertexCount[1],r=Math.floor(i),a=Math.floor(n),s=r+1,o=a+1,l=i-r,c=n-a;if(r<0||r>this._info.vertexCount[0]-1||a<0||a>this._info.vertexCount[1]-1)return null;r=pi(r,0,this._info.vertexCount[0]-1),a=pi(a,0,this._info.vertexCount[1]-1),s=pi(s,0,this._info.vertexCount[0]-1),o=pi(o,0,this._info.vertexCount[1]-1);var u=this.getWeight(r,a),h=this.getWeight(s,a),f=this.getWeight(r,o),d=this.getWeight(s,o),p=new Wi;Wi.add(p,h,f).multiplyScalar(.5),l+c<=1?(d=new Wi,Wi.subtract(d,p,u).add(p)):(u=new Wi,Wi.subtract(u,p,d).add(p));var _=new Wi,v=new Wi,m=new Wi;return Wi.lerp(_,u,h,l),Wi.lerp(v,f,d,l),Wi.lerp(m,_,v,c),m}},{key:"getBlockInfo",value:function(e,t){return this._blockInfos[t*this._info.blockCount[0]+e]}},{key:"getBlock",value:function(e,t){return this._blocks[t*this._info.blockCount[0]+e]}},{key:"getBlocks",value:function(){return this._blocks}},{key:"getSharedIndexBuffer",value:function(){return this._sharedIndexBuffer}},{key:"rayCheck",value:function(e,t,i){var n=0,r=e,a=null,s=new Fi;if(s.set(t),s.multiplyScalar(i),t.equals(new Fi(0,1,0))){var o=this.getHeightAt(r.x,r.z);null!=o&&r.y<=o&&(a=new Fi(r.x,o,r.z))}else if(t.equals(new Fi(0,-1,0))){var l=this.getHeightAt(r.x,r.z);null!=l&&r.y>=l&&(a=new Fi(r.x,l,r.z))}else for(;n++<2e3;){var c=this.getHeightAt(r.x,r.z);if(null!=c&&r.y<=c){a=new Fi(r.x,c,r.z);break}r.add(s)}return a}},{key:"_calcuNormal",value:function(e,t){var i,n,r=1,a=this.getPosition(e,t);i=e<this._info.vertexCount[0]-1?this.getPosition(e+1,t):(r*=-1,this.getPosition(e-1,t)),n=t<this._info.vertexCount[1]-1?this.getPosition(e,t+1):(r*=-1,this.getPosition(e,t-1)),i.subtract(a),n.subtract(a);var s=new Fi;return s.set(n),s.cross(i),s.multiplyScalar(r),s.normalize(),s}},{key:"_buildNormals",value:function(){for(var e=0,t=0;t<this._info.vertexCount[1];++t)for(var i=0;i<this._info.vertexCount[0];++i){var n=this._calcuNormal(i,t);this._normals[3*e+0]=n.x,this._normals[3*e+1]=n.y,this._normals[3*e+2]=n.z,e+=1}}},{key:"_buildImp",value:function(){if(0<this._blocks.length)return!0;if(this._info.initialize(),0===this._info.blockCount[0]||0===this._info.blockCount[1])return!1;var e=this._info.vertexCount[0]*this._info.vertexCount[1];if(this._heights.length!==e){this._heights=new Array(e),this._normals=new Array(3*e);for(var t=0;t<e;++t)this._heights[t]=0,this._normals[3*t+0]=0,this._normals[3*t+1]=1,this._normals[3*t+2]=0}else this._normals=new Array(3*e),this._buildNormals();var i=this.info.weightMapSize*this.info.blockCount[0],n=this.info.weightMapSize*this.info.blockCount[1];if(this._weights.length!==i*n*4){this._weights=new Uint8Array(i*n*4);for(var r=0;r<i*n;++r)this._weights[4*r+0]=255,this._weights[4*r+1]=0,this._weights[4*r+2]=0,this._weights[4*r+3]=0}if(this._blockInfos.length!==this.info.blockCount[0]*this.info.blockCount[1]){this._blockInfos=[];for(var a=0;a<this.info.blockCount[1];++a)for(var s=0;s<this.info.blockCount[0];++s)this._blockInfos.push(new z2)}for(var o=0;o<this.info.blockCount[1];++o)for(var l=0;l<this.info.blockCount[0];++l)this._blocks.push(new B2(this,l,o));var c=this._blocks,u=Array.isArray(c),h=0;for(c=u?c:c[Symbol.iterator]();;){var f;if(u){if(h>=c.length)break;f=c[h++]}else{if((h=c.next()).done)break;f=h.value}f.build()}}},{key:"_rebuildHeights",value:function(e){if(this.info.vertexCount[0]===e.vertexCount[0]&&this.info.vertexCount[1]===e.vertexCount[1])return!1;for(var t=new Array(e.vertexCount[0]*e.vertexCount[1]),i=0;i<t.length;++i)t[i]=0;for(var n=Math.min(this.info.vertexCount[0],e.vertexCount[0]),r=Math.min(this.info.vertexCount[1],e.vertexCount[1]),a=0;a<r;++a)for(var s=0;s<n;++s){var o=a*e.vertexCount[0]+s,l=a*this.info.vertexCount[0]+s;t[o]=this._heights[l]}return this._heights=t,!0}},{key:"_rebuildWeights",value:function(e){var g=this,t=this.info.weightMapSize,a=this.info.weightMapSize*this.info.blockCount[0],i=this.info.weightMapSize*this.info.blockCount[1],n=e.weightMapSize*e.blockCount[0],r=e.weightMapSize*e.blockCount[1];if(n==a&&r==i)return!1;for(var s=new Uint8Array(n*r*4),o=0;o<n*r;++o)s[4*o+0]=255,s[4*o+1]=0,s[4*o+2]=0,s[4*o+3]=0;for(var l=Math.min(e.blockCount[0],this.info.blockCount[0]),c=Math.min(e.blockCount[1],this.info.blockCount[1]),b=function(e,t,i){var n=t*a+e,r=new Wi;return r.x=i[4*n+0]/255,r.y=i[4*n+1]/255,r.z=i[4*n+2]/255,r.w=i[4*n+3]/255,r},u=function(e,t,i,n,r){var a=Math.floor(e),s=Math.floor(t),o=a+1,l=s+1,c=e-a,u=t-s,h=b(a+i,s+n,g._weights),f=b(o+i,s+n,g._weights),d=b(a+i,l+n,g._weights),p=b(o+i,l+n,g._weights),_=new Wi;Wi.add(_,f,d).multiplyScalar(.5),c+u<=1?(p.set(_),p.subtract(h),p.add(_)):(h.set(_),h.subtract(p),h.add(_));var v=new Wi,m=new Wi,y=new Wi;return Wi.lerp(v,h,f,c),Wi.lerp(m,d,p,c),Wi.lerp(y,v,m,u),y},h=0;h<c;++h)for(var f=0;f<l;++f)for(var d=f*t,p=h*t,_=0;_<this.info.weightMapSize;++_)for(var v=0;v<this.info.weightMapSize;++v){var m=void 0;if(e.weightMapSize==t)m=b(v+d,_+p,this._weights);else m=u(v/(this.info.weightMapSize-1)*(t-1),_/(this.info.weightMapSize-1)*(t-1),d,p,this._weights);var y=f*this.info.weightMapSize+v,x=(h*this.info.weightMapSize+_)*n+y;s[4*x+0]=255*m.x,s[4*x+1]=255*m.y,s[4*x+2]=255*m.z,s[4*x+3]=255*m.w}return this._weights=s,!0}},{key:"info",get:function(){return this._info}}]),i}()).prototype,"_info",[_2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new M2}}),w2=m(x2.prototype,"_layers",[v2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),T2=m(x2.prototype,"_heights",[m2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),E2=m(x2.prototype,"_weights",[y2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Uint8Array}}),C2=m(x2.prototype,"_blockInfos",[g2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),b2=x2))||b2)||b2)||b2))}}});
